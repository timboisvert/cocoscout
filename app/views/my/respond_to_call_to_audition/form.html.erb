<% content_for :title, "CocoScout - Apply for an Audition" %>

<% content_for :head do %>
  <meta name="description" content="Apply to audition for <%= @production.name %>">
  <link rel="canonical" href="<%= respond_to_call_to_audition_url(@call_to_audition.token) %>">
<% end %>

<div class="max-w-4xl mx-auto p-6 mb-10">
  <h1 class="font-bold text-4xl"><%= @production.name %></h1>

  <% if @call_to_audition.audition_type == "in_person" %>
    <h1 class="font-bold text-2xl pt-5">Sign up for an in-person audition</h1>
  <% elsif @call_to_audition.audition_type == "video_upload" %>
    <h1 class="font-bold text-2xl pt-5">Submit a video audition</h1>
  <% end %>

  <% if @call_to_audition.header_text.present? %>
    <div class="pt-5">
      <%= @call_to_audition.header_text %>
    </div>
  <% end %>

  <%= form_with(model: @audition_request, url: my_submit_respond_to_call_to_audition_form_path(@call_to_audition.token), method: :post, class: "contents", data: { turbo: false }) do |form| %>

    <%
      # Show person form if there's an error, or if profile is incomplete
      show_person_form = @update_person_error ||
                        !Current.user.person.headshot.attached? ||
                        !Current.user.person.resume.attached? ||
                        Current.user.person.name == Current.user.email_address.split("@").first
    %>

    <div class="bg-white border border-gray-200 rounded-lg shadow-sm my-6">

      <div class="p-5 flex items-top gap-4">

        <% headshot_url = safe_headshot_url(Current.user.person) %>
        <% if headshot_url %>
          <div class="flex-shrink-0">

            <%= image_tag headshot_url, class: "relative inline-block rounded-lg" %>
          </div>
        <% end %>

        <div>
          <div class="text-sm text-gray-700">
            Applying as:
          </div>

          <div class="font-bold text-lg text-gray-900">
            <%= Current.user.person.name %>
          </div>

          <div class="text-sm text-gray-600">
            <%= Current.user.email_address %>
          </div>

          <% unless show_person_form %>
            <div class="mt-2">
              <a id="update-profile-link" class="text-sm text-pink-500 cursor-pointer underline" onclick="document.getElementById('person-form-div').classList.remove('hidden'); this.classList.add('hidden');">Update your profile</a>
            </div>
          <% end %>

        </div>

      </div>

      <div class="px-5 <%= 'hidden' unless show_person_form %>" id="person-form-div">
        <%= form.fields_for @person do |person_form| %>
          <%= render "shared/person_form", person_form: person_form %>
        <% end %>
      </div>

    </div>

    <% if @call_to_audition.audition_type == "video_upload" %>
      <div class="bg-white border border-gray-200 rounded-lg shadow-sm my-6">
        <div class="p-5 flex items-top gap-4">
          <div class="w-full">

              <% if @call_to_audition.video_field_text.present? %>
                <div class="text-sm text-gray-500 mb-4">
                  <%= @call_to_audition.video_field_text %>
                </div>
              <% end %>

              <% if @audition_request.errors[:video_url].none? %>
                  <%= form.label :video_url, "Video URL" %>
                  <span class="text-sm text-gray-500"> (eg. YouTube, Google Drive, etc.)</span>
              <% else %>
                  <%= form.label :video_url, "Video URL is required", class: "text-pink-600"  %>
              <% end %>

              <%= form.text_field :video_url, class: ["block shadow-sm rounded-lg border px-3 py-2 mt-2 w-full", {"border-gray-400": @audition_request.errors[:video_url].none?, "border-pink-500": @audition_request.errors[:video_url].any?}] %>
          </div>
        </div>
      </div>
    <% end %>

    <% if @call_to_audition.include_availability_section && @shows.present? %>
      <div class="bg-white border border-gray-200 rounded-lg shadow-sm p-5 mb-6">
        <h2 class="text-xl font-bold mb-2">Your Availability</h2>
        <p class="text-sm text-gray-500 mb-4">Please indicate your availability for the following events:</p>

        <div class="space-y-3">
          <% @shows.each do |show| %>
            <div class="border border-gray-200 rounded-lg p-4">
              <div class="flex justify-between items-start mb-2">
                <div>
                  <div class="font-medium text-gray-900">
                    <%= show.event_type.titleize %>
                    <% if show.secondary_name.present? %>
                      - <%= show.secondary_name %>
                    <% end %>
                  </div>
                  <div class="text-sm text-gray-500">
                    <%= show.date_and_time.strftime("%B %d, %Y at %I:%M %p") %>
                  </div>
                  <div class="text-sm text-gray-500"><%= show.location.name %></div>
                </div>
              </div>

              <div class="mt-3 space-y-2">
                <% existing_status = @availability&.dig("#{show.id}") %>
                <div>
                  <%= radio_button_tag "availability[#{show.id}]", "available", existing_status == "available", class: "accent-pink-500 mr-1" %>
                  <%= label_tag "availability_#{show.id}_available", "Available", class: "text-sm" %>
                </div>
                <div>
                  <%= radio_button_tag "availability[#{show.id}]", "maybe", existing_status == "unset", class: "accent-pink-500 mr-1" %>
                  <%= label_tag "availability_#{show.id}_maybe", "Maybe / Not sure", class: "text-sm" %>
                </div>
                <div>
                  <%= radio_button_tag "availability[#{show.id}]", "unavailable", existing_status == "unavailable", class: "accent-pink-500 mr-1" %>
                  <%= label_tag "availability_#{show.id}_unavailable", "Unavailable", class: "text-sm" %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <% if @questions.any? %>
      <div class="bg-white border border-gray-200 rounded-lg shadow-sm p-5 mb-6 space-y-5">
        <% @questions.each do |question| %>
          <div class="">
            <label>
              <%= question.text %>
              <% if question.required %>
                <span class="text-gray-500 text-sm">(required)</span>
              <% end %>
            </label>

            <% if question.question_type == "text" %>

              <% if @missing_required_questions&.include?(question) %>
                <div class="text-sm text-pink-500">Please provide an answer to this question</div>
              <% end %>

              <%= text_field_tag "question[#{question.id}]", @answers["#{question.id}"], class: "block shadow-sm rounded-lg border px-3 py-2 mt-2 w-full", required: question.required %>

            <% elsif question.question_type == "textarea" %>

              <% if @missing_required_questions&.include?(question) %>
                <div class="text-sm text-pink-500">Please provide an answer to this question</div>
              <% end %>

              <%= text_area_tag "question[#{question.id}]", @answers["#{question.id}"], class: "block shadow-sm rounded-lg border px-3 py-2 mt-2 w-full", required: question.required %>

            <% elsif question.question_type == "yesno" %>

              <% if @missing_required_questions&.include?(question) %>
                <div class="text-sm text-pink-500">Please select Yes or No</div>
              <% end %>

              <div class="px-2 py-1">
                <%= radio_button_tag "question[#{question.id}]", "yes", checked: (@answers["#{question.id}"] == "yes" || @answers["#{question.id}"].blank?), class: "accent-pink-500 mr-1", required: question.required %>
                <%= label_tag "question[#{question.id}][yes]", "Yes" %>
              </div>
              <div class="px-2 py-1">
                <%= radio_button_tag "question[#{question.id}]", "no", checked: (@answers["#{question.id}"] == "no"), class: "accent-pink-500 mr-1", required: question.required %>
                <%= label_tag "question[#{question.id}][no]", "No" %>
              </div>

            <% elsif question.question_type == "multiple-multiple" %>

              <% if @missing_required_questions&.include?(question) %>
                <div class="text-sm text-pink-500">Please select at least one option</div>
              <% else %>
                <div class="text-sm text-gray-500">Select all that apply</div>
              <% end %>

              <% question.question_options.each do |option| %>
                <div class="px-2 py-1">
                  <%= check_box_tag "question[#{question.id}][#{option.text}]", option.text, @answers["#{question.id}"]&.include?(option.text),class: "accent-pink-500 mr-1" %>
                  <%= label_tag "question[#{question.id}][#{option.text}]", option.text %>
                </div>
              <% end %>

            <% elsif question.question_type == "multiple-single" %>

              <% if @missing_required_questions&.include?(question) %>
                <div class="text-sm text-pink-500">Please select one option</div>
              <% else %>
                <div class="text-sm text-gray-500">Select one option</div>
              <% end %>

              <% question.question_options.each do |option| %>
                <div class="px-2 py-1">
                  <%= radio_button_tag "question[#{question.id}]", option.text, @answers["#{question.id}"] == option.text, class: "accent-pink-500 mr-1" %>
                  <%= label_tag "question[#{question.id}][#{option.text}]", option.text %>
                </div>
              <% end %>

          <% end %>

          </div>
        <% end %>
      </div>
    <% end %>

    <div class="">

      <%
        if @call_to_audition.audition_type == "in_person"
          if @call_to_audition.audition_requests.exists?(person: Current.user.person)
            submit_text = "Update Sign-up"
          else
            submit_text = "Sign up"
          end
        elsif @call_to_audition.audition_type == "video_upload"
          if @call_to_audition.audition_requests.exists?(person: Current.user.person)
            submit_text = "Update video audition"
          else
            submit_text = "Submit video audition"
          end
        end
      %>
      <%= form.submit submit_text, class: "sm:w-auto rounded-lg px-3.5 py-2.5 text-white bg-pink-500 hover:bg-pink-600 inline-block font-medium cursor-pointer" %>
    </div>
  <% end %>

  <div class="w-16 pt-5 md:pt-0 fixed bottom-0 right-0 md:flex md:items-end md:justify-end">
    <%= link_to my_dashboard_path do %>
      <img src="<%= asset_path('cocoscout.png') %>" alt="CocoScout" class="object-contain select-none pointer-events-none mr-5" />
    <% end %>
  </div>

</div>