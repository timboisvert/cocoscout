<% content_for :title, @contract.contractor_name %>

<div class="w-full mb-10">
  <%= render partial: "shared/notice", locals: { notice: notice, alert: alert } %>

  <%# Status badge helper %>
  <%
    status_badge = case @contract.status
    when "active"
      { bg: "bg-green-100", text: "text-green-800", icon: "check-circle", label: "Active" }
    when "completed"
      { bg: "bg-blue-100", text: "text-blue-800", icon: "check", label: "Completed" }
    when "cancelled"
      { bg: "bg-red-100", text: "text-red-800", icon: "x-circle", label: "Cancelled" }
    else
      { bg: "bg-gray-100", text: "text-gray-700", icon: "file-text", label: "Contract" }
    end
  %>

  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [
      ["Money", manage_money_index_path],
      ["Contracts", manage_contracts_path]
    ],
    text: @contract.contractor_name,
    links: @contract.status_active? ? [
      { icon: "check", text: "Mark Complete", path: complete_manage_contract_path(@contract), method: :post }
    ] : []
  } %>

  <%# Status and date info %>
  <div class="mb-6 flex items-center gap-3">
    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium <%= status_badge[:bg] %> <%= status_badge[:text] %>">
      <%= icon(status_badge[:icon], class: "w-3 h-3 mr-1") %>
      <%= status_badge[:label] %>
    </span>
    <% if @contract.date_range %>
      <span class="text-sm text-gray-500"><%= @contract.date_range %></span>
    <% end %>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <%# Main content %>
    <div class="lg:col-span-2 space-y-6">
      <%# Contractor Info %>
      <div class="bg-white border border-gray-200 rounded-lg p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Contractor Information</h2>
        <dl class="grid grid-cols-2 gap-4">
          <div>
            <dt class="text-sm font-medium text-gray-500">Name</dt>
            <dd class="mt-1 text-sm text-gray-900"><%= @contract.contractor_name %></dd>
          </div>
          <% if @contract.contractor_email.present? %>
            <div>
              <dt class="text-sm font-medium text-gray-500">Email</dt>
              <dd class="mt-1 text-sm text-gray-900">
                <%= mail_to @contract.contractor_email, class: "text-pink-600 hover:text-pink-700" %>
              </dd>
            </div>
          <% end %>
          <% if @contract.contractor_phone.present? %>
            <div>
              <dt class="text-sm font-medium text-gray-500">Phone</dt>
              <dd class="mt-1 text-sm text-gray-900"><%= @contract.contractor_phone %></dd>
            </div>
          <% end %>
          <% if @contract.contractor_address.present? %>
            <div class="col-span-2">
              <dt class="text-sm font-medium text-gray-500">Address</dt>
              <dd class="mt-1 text-sm text-gray-900 whitespace-pre-line"><%= @contract.contractor_address %></dd>
            </div>
          <% end %>
        </dl>
      </div>

      <%# Bookings %>
      <div class="bg-white border border-gray-200 rounded-lg p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold text-gray-900">Space Bookings</h2>
          <% if @contract.status_active? %>
            <%= render "shared/button", text: "Add Booking", variant: "tertiary", size: "small", icon: "plus", type: :button %>
          <% end %>
        </div>

        <% if @rentals.any? %>
          <div class="space-y-3">
            <% @rentals.each do |rental| %>
              <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <div>
                  <div class="font-medium text-gray-900">
                    <%= rental.location_space.name %>
                    <span class="text-gray-500 font-normal">at <%= rental.location.name %></span>
                  </div>
                  <div class="text-sm text-gray-500 mt-1">
                    <%= rental.date_display %> â€¢ <%= rental.time_range_display %>
                    (<%= rental.duration_hours %> hours)
                  </div>
                </div>
                <% if rental.confirmed? %>
                  <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">
                    Confirmed
                  </span>
                <% else %>
                  <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800">
                    Pending
                  </span>
                <% end %>
              </div>
            <% end %>
          </div>
        <% else %>
          <p class="text-gray-500 text-sm">No bookings yet.</p>
        <% end %>
      </div>

      <%# Payments %>
      <div class="bg-white border border-gray-200 rounded-lg p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold text-gray-900">Payments</h2>
        </div>

        <% if @payments.any? %>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead>
                <tr>
                  <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Description</th>
                  <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Due Date</th>
                  <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">Amount</th>
                  <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Status</th>
                  <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-100">
                <% @payments.each do |payment| %>
                  <tr class="<%= 'bg-red-50' if payment.overdue? %>">
                    <td class="px-3 py-3 text-sm text-gray-900">
                      <%= payment.description.presence || "Payment" %>
                      <% if payment.direction_incoming? %>
                        <span class="text-xs text-green-600">(incoming)</span>
                      <% else %>
                        <span class="text-xs text-red-600">(outgoing)</span>
                      <% end %>
                    </td>
                    <td class="px-3 py-3 text-sm text-gray-500"><%= payment.due_date.strftime("%b %d, %Y") %></td>
                    <td class="px-3 py-3 text-sm text-right font-medium <%= payment.direction_incoming? ? 'text-green-600' : 'text-red-600' %>">
                      <%= payment.formatted_amount %>
                    </td>
                    <td class="px-3 py-3 text-center">
                      <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium <%= payment.status_badge_class %>">
                        <%= payment.overdue? ? "Overdue" : payment.status.humanize %>
                      </span>
                    </td>
                    <td class="px-3 py-3 text-right">
                      <% if payment.status_pending? %>
                        <%= button_to mark_paid_manage_contract_contract_payment_path(@contract, payment),
                          method: :post,
                          class: "text-xs text-pink-600 hover:text-pink-700" do %>
                          Mark Paid
                        <% end %>
                      <% end %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <p class="text-gray-500 text-sm">No payments scheduled.</p>
        <% end %>
      </div>

      <%# Associated Productions %>
      <% if @productions.any? %>
        <div class="bg-white border border-gray-200 rounded-lg p-6">
          <h2 class="text-lg font-semibold text-gray-900 mb-4">Associated Productions</h2>
          <div class="space-y-3">
            <% @productions.each do |production| %>
              <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <div>
                  <div class="font-medium text-gray-900"><%= production.name %></div>
                  <div class="text-sm text-gray-500">
                    <%= pluralize(production.shows.count, "show") %>
                  </div>
                </div>
                <%= link_to manage_production_shows_path(production), class: "text-sm text-pink-600 hover:text-pink-700" do %>
                  View
                  <%= icon("arrow-right", class: "w-4 h-4 inline-block") %>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>

    <%# Sidebar %>
    <div class="space-y-6">
      <%# Financial Summary %>
      <div class="bg-white border border-gray-200 rounded-lg p-6">
        <h3 class="text-sm font-semibold text-gray-900 mb-4">Financial Summary</h3>
        <dl class="space-y-3">
          <div class="flex justify-between">
            <dt class="text-sm text-gray-500">Total Incoming</dt>
            <dd class="text-sm font-medium text-green-600"><%= number_to_currency(@contract.total_incoming) %></dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-sm text-gray-500">Total Outgoing</dt>
            <dd class="text-sm font-medium text-red-600"><%= number_to_currency(@contract.total_outgoing) %></dd>
          </div>
          <div class="flex justify-between border-t border-gray-200 pt-3">
            <dt class="text-sm font-medium text-gray-900">Net Amount</dt>
            <dd class="text-sm font-bold <%= @contract.net_amount >= 0 ? 'text-green-600' : 'text-red-600' %>">
              <%= number_to_currency(@contract.net_amount) %>
            </dd>
          </div>
        </dl>
      </div>

      <%# Documents %>
      <div class="bg-white border border-gray-200 rounded-lg p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-sm font-semibold text-gray-900">Documents</h3>
        </div>

        <% if @documents.any? %>
          <div class="space-y-2">
            <% @documents.each do |doc| %>
              <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                <div class="flex items-center gap-2">
                  <%= icon("file", class: "w-4 h-4 text-gray-400") %>
                  <span class="text-sm text-gray-900"><%= doc.name %></span>
                </div>
                <% if doc.file.attached? %>
                  <%= link_to rails_blob_path(doc.file, disposition: "attachment"), class: "text-pink-600 hover:text-pink-700" do %>
                    <%= icon("document", class: "w-4 h-4") %>
                  <% end %>
                <% end %>
              </div>
            <% end %>
          </div>
        <% else %>
          <p class="text-sm text-gray-500">No documents uploaded.</p>
        <% end %>

        <%= form_with model: [@contract, ContractDocument.new], url: manage_contract_contract_documents_path(@contract), class: "mt-4" do |f| %>
          <div class="space-y-2">
            <%= f.text_field :name, placeholder: "Document name", class: "w-full text-sm border-gray-300 rounded-lg" %>
            <%= f.file_field :file, class: "w-full text-sm" %>
            <%= f.submit "Upload", class: "w-full px-3 py-2 bg-gray-100 text-gray-700 text-sm rounded-lg hover:bg-gray-200 transition-colors cursor-pointer" %>
          </div>
        <% end %>
      </div>

      <%# Notes %>
      <% if @contract.notes.present? || @contract.terms.present? %>
        <div class="bg-white border border-gray-200 rounded-lg p-6">
          <h3 class="text-sm font-semibold text-gray-900 mb-4">Notes & Terms</h3>
          <% if @contract.notes.present? %>
            <div class="mb-4">
              <h4 class="text-xs font-medium text-gray-500 uppercase mb-1">Notes</h4>
              <p class="text-sm text-gray-700 whitespace-pre-line"><%= @contract.notes %></p>
            </div>
          <% end %>
          <% if @contract.terms.present? %>
            <div>
              <h4 class="text-xs font-medium text-gray-500 uppercase mb-1">Terms</h4>
              <p class="text-sm text-gray-700 whitespace-pre-line"><%= @contract.terms %></p>
            </div>
          <% end %>
        </div>
      <% end %>

      <%# Actions %>
      <% if @contract.status_active? %>
        <div class="bg-white border border-gray-200 rounded-lg p-6">
          <h3 class="text-sm font-semibold text-gray-900 mb-4">Actions</h3>
          <div class="space-y-2">
            <%= button_to cancel_manage_contract_path(@contract, delete_events: false),
              method: :post,
              data: { confirm: "Cancel this contract? Associated shows will be marked as cancelled." },
              class: "w-full px-3 py-2 text-sm text-red-600 bg-red-50 rounded-lg hover:bg-red-100 transition-colors text-left" do %>
              <%= icon("x-circle", class: "w-4 h-4 inline-block mr-2") %>
              Cancel Contract (Keep Events)
            <% end %>
            <%= button_to cancel_manage_contract_path(@contract, delete_events: true),
              method: :post,
              data: { confirm: "Cancel this contract and DELETE all associated events? This cannot be undone." },
              class: "w-full px-3 py-2 text-sm text-red-700 bg-red-100 rounded-lg hover:bg-red-200 transition-colors text-left" do %>
              <%= icon("trash", class: "w-4 h-4 inline-block mr-2") %>
              Cancel Contract (Delete Events)
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>
