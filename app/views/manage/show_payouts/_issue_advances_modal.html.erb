<%#
  Issue Advances Modal

  Required locals:
    - show: The show to issue advances for
    - cast_members: Array of Person objects in the show's cast
    - existing_advances: Hash of person_id => Array of PersonAdvance objects for that person

  The modal allows:
    1. Setting a default advance amount for everyone
    2. Viewing/modifying individual amounts per person
    3. Seeing existing advances for each person (can issue more)
    4. Excluding specific people (with reason dropdown)
    5. Saving all advances at once
%>

<div data-payment-actions-target="issueAdvancesModal"
     class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4"
     data-action="click->payment-actions#closeOnBackdrop">
  <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[80vh] flex flex-col" data-action="click->payment-actions#stopPropagation">

    <%# Header %>
    <div class="px-6 py-4 border-b border-gray-200 flex-shrink-0">
      <h3 class="text-lg font-semibold text-gray-900">Issue Advances</h3>
      <p class="text-sm text-gray-600 mt-1">
        Pay cast members early. This will be subtracted from their payout after the show.
      </p>
    </div>

    <% if cast_members.empty? %>
      <%# No cast members %>
      <div class="flex-1 overflow-y-auto px-6 py-6">
        <div class="p-6 text-center text-gray-500 bg-gray-50 rounded-lg border border-dashed border-gray-300">
          <p>No cast members assigned to this show yet.</p>
          <p class="text-sm mt-1">Assign cast members first, then come back to issue advances.</p>
        </div>
      </div>
      <div class="px-6 py-3 border-t border-gray-200 flex-shrink-0 bg-gray-50">
        <div class="flex items-center justify-end">
          <%= render "shared/button", text: "Close", variant: "secondary", size: "medium", type: :button, data: { action: "click->payment-actions#hideIssueAdvancesModal" } %>
        </div>
      </div>
    <% else %>
      <%= form_with url: manage_issue_advances_money_show_payout_path(show), method: :post, local: true,
                    data: { controller: "advance-form", "advance-form-show-id-value": show.id },
                    class: "flex flex-col flex-1 min-h-0" do |f| %>
        <div class="flex-1 overflow-y-auto px-6 py-4 min-h-0">
          <%# Default Amount %>
          <div class="mb-5 p-3 bg-gray-50 rounded-lg border border-gray-200 flex items-center gap-4">
            <label class="text-sm font-medium text-gray-700 whitespace-nowrap">Default Amount</label>
            <div class="relative w-28">
              <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">$</span>
              <input type="number"
                     name="default_amount"
                     step="1"
                     min="0"
                     value="25"
                     data-advance-form-target="defaultAmount"
                     data-action="input->advance-form#updateAllAmounts"
                     class="w-full rounded-lg border border-gray-300 pl-7 pr-3 py-1.5 text-sm focus:border-pink-500 focus:ring-pink-500">
            </div>
            <span class="text-xs text-gray-500">Applied to all (unless edited individually)</span>
          </div>

          <%# All cast members get a form row %>
          <div class="space-y-2">
            <% cast_members.each_with_index do |person, index| %>
              <% headshot_variant = person.safe_headshot_variant(:thumb) %>
              <% person_advances = existing_advances[person.id] || [] %>
              <% total_advanced = person_advances.sum(&:original_amount) %>

              <div class="p-3 border border-gray-200 bg-white rounded-lg"
                   data-advance-form-target="personRow"
                   data-person-id="<%= person.id %>">
                <div class="flex items-center gap-3">
                  <%# Avatar %>
                  <% if headshot_variant %>
                    <%= image_tag headshot_variant, alt: person.name, class: "w-10 h-10 rounded-lg object-cover flex-shrink-0" %>
                  <% else %>
                    <div class="w-10 h-10 rounded-lg bg-pink-100 flex items-center justify-center text-pink-600 text-sm font-medium flex-shrink-0">
                      <%= person.initials %>
                    </div>
                  <% end %>

                  <%# Person name + existing advance info %>
                  <div class="flex-shrink-0 w-40">
                    <div class="font-medium text-gray-900 truncate"><%= person.name %></div>
                    <% if person_advances.any? %>
                      <div class="text-xs text-pink-600">
                        Already advanced: <%= number_to_currency(total_advanced) %>
                        <span class="text-gray-400">(<%= person_advances.count %> advance<%= person_advances.count == 1 ? '' : 's' %>)</span>
                      </div>
                    <% elsif person.formatted_venmo_identifier.present? %>
                      <div class="text-xs text-gray-500 truncate"><%= person.formatted_venmo_identifier %></div>
                    <% end %>
                  </div>

                  <%# Amount input row %>
                  <div class="flex-1 flex items-center gap-3" data-advance-form-target="amountRow">
                    <input type="hidden" name="advances[<%= index %>][person_id]" value="<%= person.id %>">

                    <%# Amount input %>
                    <div class="relative w-24 flex-shrink-0">
                      <span class="absolute left-2 top-1/2 -translate-y-1/2 text-gray-500 text-sm">$</span>
                      <input type="number"
                             name="advances[<%= index %>][amount]"
                             step="1"
                             min="0"
                             value="25"
                             data-advance-form-target="personAmount"
                             data-action="input->advance-form#markAsEdited"
                             class="w-full rounded border border-gray-300 pl-6 pr-2 py-1.5 text-sm focus:border-pink-500 focus:ring-pink-500">
                    </div>

                    <%# Notes input %>
                    <input type="text"
                           name="advances[<%= index %>][notes]"
                           placeholder="<%= person_advances.any? ? 'Notes for additional advance' : 'Notes (optional)' %>"
                           class="flex-1 rounded border border-gray-300 px-2 py-1.5 text-sm focus:border-pink-500 focus:ring-pink-500">
                  </div>

                  <%# Exclude reason row (hidden by default) %>
                  <div class="hidden flex-1 flex items-center gap-2" data-advance-form-target="excludeReason">
                    <input type="hidden" name="advances[<%= index %>][person_id]" value="<%= person.id %>">
                    <select name="advances[<%= index %>][exclude_reason]"
                            data-action="change->advance-form#onReasonChange"
                            class="flex-1 rounded border border-gray-300 px-2 py-1.5 text-sm focus:border-pink-500 focus:ring-pink-500">
                      <option value="">Select reason...</option>
                      <% ShowAdvanceWaiver::REASONS.each do |reason| %>
                        <option value="<%= reason %>"><%= ShowAdvanceWaiver.reason_label(reason) %></option>
                      <% end %>
                    </select>
                  </div>

                  <%# Skip checkbox %>
                  <label class="flex items-center gap-1.5 text-sm text-gray-600 cursor-pointer flex-shrink-0">
                    <input type="checkbox"
                           name="advances[<%= index %>][excluded]"
                           value="1"
                           data-action="change->advance-form#toggleExcluded"
                           data-advance-form-target="excludeCheckbox"
                           class="rounded border-gray-300 text-pink-600 focus:ring-pink-500 accent-pink-600">
                    <span class="text-xs">Skip</span>
                  </label>
                </div>
              </div>
            <% end %>
          </div>
        </div>

        <%# Footer %>
        <div class="px-6 py-3 border-t border-gray-200 flex-shrink-0 bg-gray-50">
          <div class="flex items-center justify-end gap-3">
            <%= render "shared/button", text: "Cancel", variant: "ghost", size: "medium", type: :button, data: { action: "click->payment-actions#hideIssueAdvancesModal" } %>
            <%= render "shared/button", text: "Issue Advances", variant: "primary", size: "medium", type: :submit, icon: "banknotes" %>
          </div>
        </div>
      <% end %>
    <% end %>
  </div>
</div>
