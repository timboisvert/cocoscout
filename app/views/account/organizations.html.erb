<% content_for :title, "Organizations" %>

<div class="w-full" data-controller="organization-leave">
  <div id="notice-container">
    <%= render partial: "shared/notice", locals: { notice: notice, alert: alert } %>
  </div>

  <!-- Organizations Section -->
  <div class="bg-white border border-gray-200 rounded-lg overflow-hidden mb-6">
    <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
      <h3 class="text-md font-semibold text-gray-900 coustard-regular">My Organizations</h3>
    </div>
    <div class="p-6">
      <% if @organizations.any? %>
        <div class="space-y-4">
          <% @organizations.each do |org| %>
            <% connections = @organization_connections[org.id] %>
            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:border-gray-300 transition">
              <div class="flex items-center gap-4">
                <% if org.logo.attached? %>
                  <%= image_tag org.logo.variant(resize_to_fill: [64, 64]), class: "w-16 h-16 rounded-lg object-cover" %>
                <% else %>
                  <div class="w-16 h-16 rounded-lg bg-gradient-to-br from-pink-400 to-purple-500 flex items-center justify-center text-white font-bold text-lg">
                    <%= org.name.split.map(&:first).first(2).join.upcase %>
                  </div>
                <% end %>
                <div>
                  <div class="font-medium text-gray-900"><%= org.name %></div>
                  <div class="text-sm text-gray-500 mt-0.5">
                    <%= pluralize(connections[:production_count], "production") %>
                  </div>
                  <div class="flex flex-wrap gap-2 mt-2">
                    <% if connections[:as_team] %>
                      <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                        Team Member
                      </span>
                    <% end %>
                    <% if connections[:as_talent] %>
                      <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">
                        Talent Pool
                      </span>
                    <% end %>
                  </div>
                  <% if connections[:people].any? || connections[:groups].any? %>
                    <div class="flex items-center gap-2 mt-2">
                      <% connections[:people].first(3).each do |person| %>
                        <% headshot = person.profile_headshots.order(created_at: :desc).first %>
                        <% if headshot&.image&.attached? %>
                          <%= image_tag headshot.image.variant(resize_to_fill: [24, 24]), class: "w-6 h-6 rounded object-cover border border-white shadow-sm", title: person.name %>
                        <% else %>
                          <div class="w-6 h-6 rounded-full bg-pink-100 text-pink-600 flex items-center justify-center text-xs font-medium border border-white shadow-sm" title="<%= person.name %>">
                            <%= person.initials %>
                          </div>
                        <% end %>
                      <% end %>
                      <% connections[:groups].first(2).each do |group| %>
                        <% if group.headshot&.attached? %>
                          <%= image_tag group.headshot.variant(resize_to_fill: [24, 24]), class: "w-6 h-6 rounded-full object-cover border border-white shadow-sm", title: group.name %>
                        <% else %>
                          <div class="w-6 h-6 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center text-xs font-medium border border-white shadow-sm" title="<%= group.name %>">
                            <%= group.name.split.map(&:first).first(2).join.upcase %>
                          </div>
                        <% end %>
                      <% end %>
                      <% extra = (connections[:people].size + connections[:groups].size) - 5 %>
                      <% if extra > 0 %>
                        <span class="text-xs text-gray-500">+<%= extra %> more</span>
                      <% end %>
                    </div>
                  <% end %>
                </div>
              </div>
              <% unless connections[:as_team] %>
                <div class="flex items-center gap-2">
                  <%= render "shared/button",
                    text: "Leave",
                    variant: "danger",
                    size: "small",
                    data: {
                      action: "click->organization-leave#openConfirm",
                      "org-id": org.id,
                      "org-name": org.name
                    }
                  %>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="text-center py-12">
          <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gray-100 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-gray-400">
              <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 21h19.5m-18-18v18m10.5-18v18m6-13.5V21M6.75 6.75h.75m-.75 3h.75m-.75 3h.75m3-6h.75m-.75 3h.75m-.75 3h.75M6.75 21v-3.375c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21M3 3h12m-.75 4.5H21m-3.75 3.75h.008v.008h-.008v-.008Zm0 3h.008v.008h-.008v-.008Zm0 3h.008v.008h-.008v-.008Z" />
            </svg>
          </div>
          <h4 class="text-lg font-medium text-gray-900 mb-2">No organizations yet</h4>
          <p class="text-gray-500 max-w-sm mx-auto">
            When you sign up for auditions or join talent pools, you'll see those organizations here.
          </p>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Info Section -->
  <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
    <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
      <h3 class="text-md font-semibold text-gray-900 coustard-regular">About Organizations</h3>
    </div>
    <div class="p-6">
      <p class="text-sm text-gray-600">
        Organizations are theater companies, production houses, or groups that use CocoScout to manage their productions.
        You become connected to an organization when you sign up for their auditions or join their talent pool.
      </p>
      <p class="text-sm text-gray-600 mt-3">
        <strong class="text-gray-700">Leaving an organization</strong> will remove you from all of their talent pools,
        cancel any upcoming show assignments, and withdraw any pending audition requests with that organization.
        This action cannot be undone.
      </p>
    </div>
  </div>

  <!-- Leave Confirmation Modal -->
  <div data-organization-leave-target="modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
      <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" data-action="click->organization-leave#closeConfirm"></div>
      <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
        <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
          <div class="sm:flex sm:items-start">
            <div class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
              <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
              </svg>
            </div>
            <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left">
              <h3 class="text-base font-semibold leading-6 text-gray-900">Leave organization?</h3>
              <div class="mt-2">
                <p class="text-sm text-gray-500">
                  Are you sure you want to leave <strong data-organization-leave-target="orgName" class="text-gray-700"></strong>?
                </p>
                <p class="text-sm text-gray-500 mt-2">
                  This will remove you from all of their talent pools, cancel upcoming assignments, and withdraw any pending audition requests.
                  <strong class="text-red-600">This action cannot be undone.</strong>
                </p>
              </div>
            </div>
          </div>
        </div>
        <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
          <%= form_with url: "#", method: :delete, data: { organization_leave_target: "form" }, class: "sm:ml-3" do %>
            <%= render "shared/button", text: "Leave Organization", variant: "danger", type: "submit" %>
          <% end %>
          <%= render "shared/button", text: "Cancel", variant: "outline", data: { action: "click->organization-leave#closeConfirm" } %>
        </div>
      </div>
    </div>
  </div>
</div>
