<% content_for :title, @provider.name %>

<%= render partial: "shared/top_menu", locals: {
  breadcrumbs: [
    ["Ticketing", manage_ticketing_index_path],
    ["Providers", manage_ticketing_providers_path]
  ],
  text: @provider.name,
  links: []
} %>

<%
  # Connection status for each aspect
  api_connected = @provider.configured? && @provider.credentials_valid?
  api_error = @provider.configured? && !@provider.credentials_valid?
  api_missing = !@provider.configured?

  # Webhooks: check support, enabled, and activity
  webhooks_supported = @provider.supports_webhooks?
  if webhooks_supported
    if !@provider.webhook_enabled?
      webhook_status = :not_enabled
    elsif @provider.webhook_last_received_at.blank?
      webhook_status = :awaiting
    elsif @provider.webhook_last_received_at > 7.days.ago
      webhook_status = :active
    else
      webhook_status = :stale
    end
  else
    webhook_status = :not_supported
  end

  permissions_full = @provider.can?(:api_fetch_sales)
  permissions_limited = @provider.configured? && !@provider.can?(:api_fetch_sales)
  permissions_unknown = !@provider.configured?

  # Calculate next expected check and if it's overdue
  check_interval = 15.minutes
  buffer = 5.minutes  # Allow some buffer for job queue

  if @provider.credentials_checked_at
    next_check_at = @provider.credentials_checked_at + check_interval
    overdue_at = next_check_at + buffer
    is_overdue = Time.current > overdue_at
  else
    next_check_at = nil
    is_overdue = false
  end
%>

<div class="w-full">
  <%= render partial: "shared/notice", locals: { notice: notice, alert: alert } %>

  <%# Header %>
  <div class="mb-6">
    <h1 class="text-3xl coustard-regular text-gray-900"><%= @provider.name %></h1>
    <p class="text-sm text-gray-500 mt-2">
      <%= @provider.provider_type.titleize.gsub("_", " ") %>
      <% if @provider.credentials_checked_at %>
        · Checked <%= time_ago_in_words(@provider.credentials_checked_at) %> ago
        <% if next_check_at && next_check_at > Time.current %>
          · Next check in <span data-controller="countdown" data-countdown-until-value="<%= next_check_at.iso8601 %>"><span data-countdown-target="clock"></span></span>
        <% end %>
      <% else %>
        · Never checked
      <% end %>
    </p>
  </div>

  <% if is_overdue %>
    <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-4 flex items-center gap-3">
      <svg class="w-5 h-5 text-amber-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
      </svg>
      <div>
        <p class="text-sm font-medium text-amber-800">Automated health checks may not be running</p>
        <p class="text-xs text-amber-700 mt-0.5">Last check was <%= time_ago_in_words(@provider.credentials_checked_at) %> ago. Check that your background job workers are running.</p>
      </div>
    </div>
  <% end %>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Main Content -->
    <div class="lg:col-span-2">
      <%# Connection Status Cards %>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <%# API Credentials Card %>
        <div class="bg-white rounded-lg border border-gray-200 p-5">
          <div class="flex items-center gap-3 mb-3">
            <% if api_connected %>
              <span class="w-3 h-3 rounded-full bg-green-500 animate-pulse"></span>
            <% elsif api_error %>
              <span class="w-3 h-3 rounded-full bg-red-500"></span>
            <% else %>
              <span class="w-3 h-3 rounded-full bg-gray-300"></span>
            <% end %>
            <div class="text-sm font-medium text-gray-900">API Credentials</div>
          </div>
          <% if api_connected %>
            <p class="text-sm text-green-600 font-medium">Connected</p>
            <p class="text-xs text-gray-500 mt-1">API key verified and working</p>
          <% elsif api_error %>
            <p class="text-sm text-red-600 font-medium">Error</p>
            <p class="text-xs text-gray-500 mt-1"><%= @provider.credentials_error.presence || "API key failed verification" %></p>
          <% else %>
            <p class="text-sm text-gray-500 font-medium">Not configured</p>
            <p class="text-xs text-gray-500 mt-1">Enter your API key to connect</p>
          <% end %>
        </div>

        <%# Webhooks Card %>
        <div class="bg-white rounded-lg border border-gray-200 p-5">
          <div class="flex items-center gap-3 mb-3">
            <% if webhook_status == :active %>
              <span class="w-3 h-3 rounded-full bg-green-500 animate-pulse"></span>
            <% elsif webhook_status == :awaiting %>
              <span class="w-3 h-3 rounded-full bg-amber-500"></span>
            <% elsif webhook_status == :stale %>
              <span class="w-3 h-3 rounded-full bg-red-500"></span>
            <% else %>
              <span class="w-3 h-3 rounded-full bg-gray-300"></span>
            <% end %>
            <div class="text-sm font-medium text-gray-900">Webhooks</div>
          </div>
          <% case webhook_status %>
          <% when :not_supported %>
            <p class="text-sm text-gray-500 font-medium">Not supported</p>
            <p class="text-xs text-gray-500 mt-1"><%= @provider.provider_type.titleize.gsub("_", " ") %> doesn't support webhooks</p>
          <% when :not_enabled %>
            <p class="text-sm text-gray-500 font-medium">Not enabled</p>
            <p class="text-xs text-gray-500 mt-1">Enable in settings for real-time updates</p>
          <% when :awaiting %>
            <p class="text-sm text-amber-600 font-medium">Awaiting first event</p>
            <p class="text-xs text-gray-500 mt-1">Waiting for first webhook from <%= @provider.provider_type.titleize.gsub("_", " ") %></p>
          <% when :active %>
            <p class="text-sm text-green-600 font-medium">Active</p>
            <p class="text-xs text-gray-500 mt-1">Last received <%= time_ago_in_words(@provider.webhook_last_received_at) %> ago</p>
          <% when :stale %>
            <p class="text-sm text-red-600 font-medium">Stale</p>
            <p class="text-xs text-gray-500 mt-1">No webhooks received in <%= time_ago_in_words(@provider.webhook_last_received_at) %></p>
          <% end %>
        </div>

        <%# Permissions Card %>
        <div class="bg-white rounded-lg border border-gray-200 p-5">
          <div class="flex items-center gap-3 mb-3">
            <% if permissions_full %>
              <span class="w-3 h-3 rounded-full bg-green-500 animate-pulse"></span>
            <% elsif permissions_limited %>
              <span class="w-3 h-3 rounded-full bg-amber-500"></span>
            <% else %>
              <span class="w-3 h-3 rounded-full bg-gray-300"></span>
            <% end %>
            <div class="text-sm font-medium text-gray-900">Permissions</div>
          </div>
          <% if permissions_full %>
            <p class="text-sm text-green-600 font-medium">Full access</p>
            <p class="text-xs text-gray-500 mt-1">Can read events and sales data</p>
          <% elsif permissions_limited %>
            <p class="text-sm text-amber-600 font-medium">Limited</p>
            <p class="text-xs text-gray-500 mt-1">Some permissions may be missing</p>
          <% else %>
            <p class="text-sm text-gray-500 font-medium">Unknown</p>
            <p class="text-xs text-gray-500 mt-1">Connect to check permissions</p>
          <% end %>
        </div>
      </div>

      <%# Provider Events Section %>
      <div class="mt-6 bg-white rounded-lg border border-gray-200">
        <div class="p-5 border-b border-gray-200">
          <h2 class="text-lg font-semibold text-gray-900">Provider Events</h2>
          <p class="text-sm text-gray-500 mt-1">
            Events on <%= @provider.name %> mapped to your productions
            <% if @unmapped_count > 0 %>
              · <span class="text-amber-600 font-medium"><%= @unmapped_count %> not in CocoScout</span>
            <% end %>
            <% if @needs_attention_count > 0 %>
              · <span class="text-amber-600 font-medium"><%= @needs_attention_count %> need review</span>
            <% end %>
          </p>
        </div>

        <% if @provider_events.any? %>
          <div class="divide-y divide-gray-200">
            <% @provider_events.each do |event| %>
              <div class="p-4 flex items-center gap-4 hover:bg-gray-50">
                <%# Event info %>
                <div class="flex-1 min-w-0">
                  <div class="font-medium text-gray-900 truncate"><%= event.name %></div>
                  <div class="text-sm text-gray-500">
                    <%= event.occurrence_count %> occurrence<%= event.occurrence_count == 1 ? "" : "s" %>
                    <% if event.date_range %>
                      <% start_date, end_date = event.date_range %>
                      · <%= start_date.strftime("%b %-d") %><%= start_date != end_date ? " - #{end_date.strftime("%b %-d, %Y")}" : ", #{start_date.strftime("%Y")}" %>
                    <% end %>
                  </div>
                </div>

                <%# Match status %>
                <% if event.match_status_confirmed? && event.production %>
                  <div class="flex items-center gap-2">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                      Linked
                    </span>
                    <span class="text-sm text-gray-600"><%= event.production.name %></span>
                  </div>
                <% elsif event.match_status_suggested? && event.production %>
                  <div class="flex flex-col items-end gap-1">
                    <div class="flex items-center gap-2">
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-800">
                        Suggested
                      </span>
                      <span class="text-sm text-gray-600"><%= event.production.name %></span>
                    </div>
                    <div class="flex items-center gap-1">
                      <%= form_with url: manage_confirm_match_ticketing_provider_path(@provider, event_id: event.id), method: :post, local: true, class: "inline" do %>
                        <%= render "shared/button", text: "Accept", variant: "primary", size: "small", type: :submit %>
                      <% end %>
                      <%= form_with url: manage_reject_match_ticketing_provider_path(@provider, event_id: event.id), method: :post, local: true, class: "inline" do %>
                        <%= render "shared/button", text: "Reject", variant: "ghost", size: "small", type: :submit %>
                      <% end %>
                    </div>
                  </div>
                <% elsif event.match_status_ignored? %>
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600">
                    Ignored
                  </span>
                <% else %>
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-500">
                    Not in CocoScout
                  </span>
                <% end %>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="p-8 text-center">
            <div class="w-12 h-12 mx-auto rounded-full bg-gray-100 flex items-center justify-center mb-3">
              <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
              </svg>
            </div>
            <p class="text-gray-500 mb-4">No events synced yet</p>
            <p class="text-sm text-gray-400">Click "Sync Events" to fetch events from <%= @provider.name %></p>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="space-y-6">
      <!-- Actions -->
      <div class="bg-white rounded-lg border border-gray-200 p-5">
        <h3 class="font-semibold text-gray-900 mb-4">Actions</h3>
        <div class="space-y-3">
          <%= link_to manage_edit_ticketing_provider_path(@provider), class: "flex items-center gap-3 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors" do %>
            <div class="w-10 h-10 rounded-lg bg-gray-100 flex items-center justify-center flex-shrink-0">
              <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
            </div>
            <div class="flex-1">
              <div class="font-medium text-gray-900">Manage Provider</div>
              <div class="text-xs text-gray-500">Edit settings and credentials</div>
            </div>
            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
          <% end %>

          <%= button_to manage_test_ticketing_provider_path(@provider), method: :post, class: "flex items-center gap-3 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors w-full text-left" do %>
            <div class="w-10 h-10 rounded-lg bg-pink-100 flex items-center justify-center flex-shrink-0">
              <svg class="w-5 h-5 text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
            </div>
            <div class="flex-1">
              <div class="font-medium text-gray-900">Check Connection</div>
              <div class="text-xs text-gray-500">Test API credentials now</div>
            </div>
          <% end %>

          <%= button_to manage_sync_events_ticketing_provider_path(@provider), method: :post, class: "flex items-center gap-3 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors w-full text-left" do %>
            <div class="w-10 h-10 rounded-lg bg-pink-100 flex items-center justify-center flex-shrink-0">
              <svg class="w-5 h-5 text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
              </svg>
            </div>
            <div class="flex-1">
              <div class="font-medium text-gray-900">Sync Events</div>
              <div class="text-xs text-gray-500">Fetch latest from <%= @provider.provider_type.titleize.gsub("_", " ") %></div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>