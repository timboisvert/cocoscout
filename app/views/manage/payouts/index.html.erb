<% content_for :title, "Money - #{@production.name}" %>

<div class="w-full mb-10">
  <%= render partial: "shared/notice", locals: { notice: notice, alert: alert } %>
  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [],
    text: "Money",
    links: []
  } %>

  <!-- Summary Cards -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
    <div class="bg-white rounded-lg border border-gray-200 p-5">
      <div class="text-sm text-gray-500 mb-1">Pending Payouts</div>
      <div class="text-2xl font-semibold text-gray-900"><%= @pending_count %></div>
      <div class="text-xs text-gray-500 mt-1">drafts awaiting approval</div>
    </div>
    <div class="bg-white rounded-lg border border-gray-200 p-5">
      <div class="text-sm text-gray-500 mb-1">Approved</div>
      <div class="text-2xl font-semibold text-green-600"><%= number_to_currency(@total_approved) %></div>
      <div class="text-xs text-gray-500 mt-1">ready to pay out</div>
    </div>
    <div class="bg-white rounded-lg border border-gray-200 p-5">
      <div class="text-sm text-gray-500 mb-1">Paid Out</div>
      <div class="text-2xl font-semibold text-pink-600"><%= number_to_currency(@total_paid) %></div>
      <div class="text-xs text-gray-500 mt-1">total distributed</div>
    </div>
  </div>

  <!-- Recent Shows (Primary) -->
  <div class="mb-8">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-semibold text-gray-900">Recent Shows</h2>
      <%= link_to manage_production_money_show_payouts_path(@production) do %>
        <%= render "shared/button", text: "View All Shows", variant: "secondary", size: "small" %>
      <% end %>
    </div>

    <% if @shows.any? %>
      <div class="space-y-2">
        <% @shows.each do |show| %>
          <%
            financials = show.show_financials
            payout = show.show_payout
            has_data = financials&.has_data?
            status = payout&.status || "no_data"
          %>
          <%= link_to manage_production_money_show_payout_path(@production, show), class: "block bg-white rounded-lg border border-gray-200 px-4 py-3 hover:border-gray-400 transition-all" do %>
            <div class="flex items-center gap-4">
              <%# Date Box %>
              <div class="flex-shrink-0 w-14 text-center">
                <div class="text-xs font-semibold text-pink-600 uppercase"><%= show.date_and_time.strftime("%b") %></div>
                <div class="text-2xl font-bold text-gray-900"><%= show.date_and_time.strftime("%-d") %></div>
                <div class="text-xs text-gray-500"><%= show.date_and_time.strftime("%a") %></div>
              </div>

              <%# Show Details %>
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 flex-wrap">
                  <span class="font-medium text-gray-900">
                    <%= show.secondary_name.presence || show.event_type.titleize %>
                  </span>
                  <% case status %>
                  <% when "no_data" %>
                    <span class="inline-flex items-center rounded-md px-2 py-0.5 text-xs font-medium bg-gray-100 text-gray-600">Needs Data</span>
                  <% when "draft" %>
                    <span class="inline-flex items-center rounded-md px-2 py-0.5 text-xs font-medium bg-yellow-100 text-yellow-700">Draft</span>
                  <% when "approved" %>
                    <span class="inline-flex items-center rounded-md px-2 py-0.5 text-xs font-medium bg-green-100 text-green-700">Approved</span>
                  <% when "paid" %>
                    <span class="inline-flex items-center rounded-md px-2 py-0.5 text-xs font-medium bg-pink-100 text-pink-700">Paid</span>
                  <% end %>
                </div>
                <div class="text-sm text-gray-600">
                  <%= show.date_and_time.strftime("%l:%M %p").strip %>
                  <% if has_data %>
                    · <%= financials.ticket_count %> tickets · <%= number_to_currency(financials.ticket_revenue) %> revenue
                    <% if payout&.total_payout %>
                      · <%= number_to_currency(payout.total_payout) %> payout
                    <% end %>
                  <% end %>
                </div>
              </div>

              <svg class="w-5 h-5 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
              </svg>
            </div>
          <% end %>
        <% end %>
      </div>
    <% else %>
      <div class="bg-gray-50 rounded-lg border border-dashed border-gray-300 p-8 text-center">
        <p class="text-gray-600">No past shows yet. Shows will appear here after they occur.</p>
      </div>
    <% end %>
  </div>

  <!-- Payout Schemes (Secondary) -->
  <div class="border-t border-gray-200 pt-6">
    <div class="flex items-center justify-between mb-4">
      <div>
        <h2 class="text-lg font-semibold text-gray-900">Payout Schemes</h2>
        <p class="text-sm text-gray-500">Define how performers get paid for each show</p>
      </div>
      <% if @payout_schemes.any? %>
        <%= link_to manage_production_money_payout_schemes_path(@production) do %>
          <%= render "shared/button", text: "Manage Schemes", variant: "secondary", size: "small" %>
        <% end %>
      <% end %>
    </div>

    <% if @payout_schemes.any? %>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <% @payout_schemes.each do |scheme| %>
          <%= link_to manage_production_money_payout_scheme_path(@production, scheme), class: "block bg-white rounded-lg border border-gray-200 p-4 hover:bg-gray-50 transition-colors" do %>
            <div class="flex items-center justify-between mb-1">
              <span class="font-medium text-gray-900"><%= scheme.name %></span>
              <% if scheme.is_default? %>
                <span class="inline-flex items-center rounded-md px-2 py-0.5 text-xs font-medium bg-pink-100 text-pink-700">Default</span>
              <% end %>
            </div>
            <p class="text-sm text-gray-500"><%= scheme.rules_summary %></p>
          <% end %>
        <% end %>
      </div>
    <% else %>
      <div class="bg-gray-50 rounded-lg border border-dashed border-gray-300 p-6 text-center">
        <svg class="w-10 h-10 text-gray-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <p class="text-gray-600 mb-3">No payout schemes yet. Create one to start calculating performer payouts.</p>
        <%= link_to manage_production_presets_money_payout_schemes_path(@production) do %>
          <%= render "shared/button", text: "Create Your First Scheme", variant: "primary", size: "small" %>
        <% end %>
      </div>
    <% end %>
  </div>
</div>
