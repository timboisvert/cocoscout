<% content_for :title, "Preview: #{@template.name} - Superadmin" %>

<div class="w-full px-5 pt-5">
  <%= render partial: "shared/notice", locals: { notice: notice } %>

  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [
        ["Superadmin", superadmin_path],
        ["Email Templates", email_templates_path]
    ],
    text: "Preview: #{@template.name}",
    links: [
      { text: "Edit Template", path: email_template_edit_path(@template), color: "pink" }
    ]
  } %>

  <div class="mt-4" data-controller="email-template-preview tabs"
       data-email-template-preview-subject-template-value="<%= ERB::Util.html_escape(@template.subject) %>"
       data-email-template-preview-body-template-value="<%= ERB::Util.html_escape(@template.body) %>">

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
      <!-- Left Panel: Variables & Info -->
      <div class="lg:col-span-1 space-y-4">
        <!-- Template Info Card -->
        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
          <%= render "shared/card_header", title: "Template Info" %>
          <div class="p-4 space-y-3">
            <div>
              <label class="block text-xs font-medium text-gray-500 uppercase tracking-wider">Key</label>
              <code class="text-sm font-mono bg-gray-100 px-2 py-1 rounded block mt-1 break-all"><%= @template.key %></code>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-500 uppercase tracking-wider">Category</label>
              <span class="text-sm text-gray-900"><%= @template.category&.titleize || "Uncategorized" %></span>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-500 uppercase tracking-wider">Status</label>
              <% if @template.active? %>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                  Active
                </span>
              <% else %>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600">
                  Inactive
                </span>
              <% end %>
            </div>
            <% if @template.prepend_production_name? %>
              <div>
                <label class="block text-xs font-medium text-gray-500 uppercase tracking-wider">Subject Prefix</label>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-pink-100 text-pink-800">
                  [Production Name] prepended
                </span>
              </div>
            <% end %>

            <!-- Template Type -->
            <div>
              <label class="block text-xs font-medium text-gray-500 uppercase tracking-wider">Template Type</label>
              <% if @template.passthrough? %>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-800">
                  <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                  </svg>
                  Pass-through
                </span>
                <p class="text-xs text-gray-500 mt-1">Content is passed directly from user input</p>
              <% elsif @template.hybrid? %>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                  <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 00-1-1H4a2 2 0 110-4h1a1 1 0 001-1V7a1 1 0 011-1h3a1 1 0 001-1V4z" />
                  </svg>
                  Hybrid
                </span>
                <p class="text-xs text-gray-500 mt-1">User can customize the pre-filled template</p>
              <% else %>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                  <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6z" />
                  </svg>
                  Structured
                </span>
                <p class="text-xs text-gray-500 mt-1">Fixed layout with variable placeholders</p>
              <% end %>
            </div>

            <% if @template.description.present? %>
              <div>
                <label class="block text-xs font-medium text-gray-500 uppercase tracking-wider">Description</label>
                <p class="text-sm text-gray-600 mt-1"><%= @template.description %></p>
              </div>
            <% end %>
          </div>
        </div>

        <!-- Variable Editor -->
        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
          <div class="px-4 py-3 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-sm font-medium text-gray-900">Preview Variables</h3>
            <button type="button" class="text-xs text-pink-600 hover:text-pink-800 font-medium"
                    data-action="email-template-preview#resetVariables">Reset</button>
          </div>
          <div class="p-4 space-y-4 max-h-96 overflow-y-auto">
            <% if @template.hybrid? %>
              <div class="bg-blue-50 border border-blue-200 rounded p-3 mb-3">
                <p class="text-xs text-blue-800">
                  <strong>Hybrid Template:</strong> The <code class="bg-blue-100 px-1 rounded">body_content</code> or similar variable
                  below shows what the user can customize. Edit it to preview different content.
                </p>
              </div>
            <% elsif @template.passthrough? %>
              <div class="bg-amber-50 border border-amber-200 rounded p-3 mb-3">
                <p class="text-xs text-amber-800">
                  <strong>Pass-through Template:</strong> The main content is provided entirely by the user at send time.
                  The sample below shows a placeholder.
                </p>
              </div>
            <% end %>
            <% if @sample_variables.present? %>
              <% @sample_variables.each do |var| %>
                <div>
                  <label class="block text-xs font-medium text-gray-700 mb-1">
                    <code class="text-purple-700 bg-purple-50 px-1 py-0.5 rounded">{{<%= var[:name] %>}}</code>
                  </label>
                  <% if var[:name].to_s.match?(/content|message|body/i) %>
                    <textarea class="w-full text-sm border border-gray-200 rounded px-2 py-1.5 focus:ring-pink-500 focus:border-pink-500 font-mono"
                              rows="8"
                              data-email-template-preview-target="variableInput"
                              data-variable-name="<%= var[:name] %>"
                              data-default-value="<%= var[:value] %>"
                              data-action="input->email-template-preview#updatePreview"><%= var[:value] %></textarea>
                  <% else %>
                    <input type="text"
                           class="w-full text-sm border border-gray-200 rounded px-2 py-1.5 focus:ring-pink-500 focus:border-pink-500"
                           value="<%= var[:value] %>"
                           data-email-template-preview-target="variableInput"
                           data-variable-name="<%= var[:name] %>"
                           data-default-value="<%= var[:value] %>"
                           data-action="input->email-template-preview#updatePreview">
                  <% end %>
                  <% if var[:description].present? %>
                    <p class="text-xs text-gray-400 mt-1"><%= var[:description] %></p>
                  <% end %>
                </div>
              <% end %>
            <% else %>
              <p class="text-sm text-gray-500">No variables in this template.</p>
            <% end %>
          </div>
        </div>

        <!-- Usage Locations -->
        <% if @template.usage_locations.present? || @template.mailer_class.present? %>
          <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
            <%= render "shared/card_header", title: "Used In" %>
            <div class="p-4 space-y-2">
              <% if @template.mailer_class.present? %>
                <div class="flex items-start gap-2">
                  <svg class="w-4 h-4 text-gray-400 mt-0.5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                  </svg>
                  <div>
                    <code class="text-xs font-mono text-gray-800"><%= @template.mailer_class %></code>
                    <% if @template.mailer_action.present? %>
                      <code class="text-xs font-mono text-gray-600">#<%= @template.mailer_action %></code>
                    <% end %>
                  </div>
                </div>
              <% end %>
              <% if @template.usage_locations.present? %>
                <% @template.usage_locations.each do |location| %>
                  <div class="flex items-start gap-2 text-sm">
                    <svg class="w-4 h-4 text-gray-400 mt-0.5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <span class="text-gray-600 text-xs break-all"><%= location %></span>
                  </div>
                <% end %>
              <% end %>
            </div>
          </div>
        <% end %>

        <!-- Developer Info -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <div class="text-sm text-blue-800">
            <strong class="block mb-2">Usage in code:</strong>
            <pre class="bg-blue-100 p-2 rounded text-xs overflow-x-auto font-mono whitespace-pre-wrap">EmailTemplateService.render(
  "<%= @template.key %>",
  {
<% @preview[:variables_used].each do |var| %>
    <%= var %>: value,
<% end %>
  }
)</pre>
          </div>
        </div>

        <% if @template.notes.present? %>
          <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
            <div class="text-sm text-amber-800">
              <strong class="block mb-1">Notes:</strong>
              <p><%= @template.notes %></p>
            </div>
          </div>
        <% end %>
      </div>

      <!-- Right Panel: Preview Tabs -->
      <div class="lg:col-span-3">
        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
          <!-- Tabs Navigation -->
          <nav class="flex border-b border-gray-200 bg-gray-50">
            <button type="button" class="px-6 py-3 text-sm font-medium border-b-2 border-pink-500 text-pink-600 bg-white"
                    data-tabs-target="tab"
                    data-index="0"
                    data-action="click->tabs#select">
              <svg class="w-4 h-4 inline mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
              </svg>
              Styled Preview
            </button>
            <button type="button" class="px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 bg-gray-50 hover:text-gray-700"
                    data-tabs-target="tab"
                    data-index="1"
                    data-action="click->tabs#select">
              <svg class="w-4 h-4 inline mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
              </svg>
              Raw Template
            </button>
          </nav>

          <!-- Tab Panels -->
          <!-- Styled Preview Panel -->
          <div data-tabs-target="panel" class="p-6">
            <!-- Subject -->
            <div class="mb-4">
              <label class="block text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">Subject</label>
              <div class="text-lg font-medium text-gray-900 bg-gray-50 p-3 rounded border border-gray-200"
                   data-email-template-preview-target="subjectPreview">
                <% if @template.prepend_production_name? %>
                  <span class="text-pink-600">[Sample Production]</span>
                <% end %>
                <%= @preview[:subject] %>
              </div>
            </div>

            <!-- Styled Email Body in iframe for isolation -->
            <div>
              <label class="block text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">Email Body</label>
              <div class="border border-gray-200 rounded-lg overflow-hidden bg-gray-100" style="min-height: 500px;">
                <iframe id="email-preview-frame" class="w-full" style="min-height: 500px; background: #f5f5f5;"
                        srcdoc="<%= ERB::Util.html_escape(@styled_body) %>">
                </iframe>
              </div>
            </div>
          </div>

          <script>
            // Auto-resize iframe to fit content
            const iframe = document.getElementById('email-preview-frame');
            if (iframe) {
              iframe.onload = function() {
                try {
                  const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                  const height = iframeDoc.body.scrollHeight;
                  iframe.style.height = Math.max(height, 500) + 'px';
                } catch (e) {
                  console.log('Could not resize iframe:', e);
                }
              };
            }
          </script>
        </div>

          <!-- Raw Template Panel -->
          <div data-tabs-target="panel" class="hidden p-6 space-y-4">
            <div>
              <label class="block text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">Subject Template</label>
              <code class="block bg-gray-100 p-3 rounded text-sm font-mono text-gray-800"
                    data-email-template-preview-target="subjectRaw"><%= @template.subject %></code>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">Body Template</label>
              <pre class="bg-gray-100 p-3 rounded text-sm font-mono text-gray-800 whitespace-pre-wrap overflow-x-auto"
                   data-email-template-preview-target="bodyRaw"><%= @template.body %></pre>
            </div>

            <!-- Variable Highlighting Legend -->
            <div class="mt-4 p-4 bg-purple-50 rounded-lg border border-purple-200">
              <h4 class="text-sm font-medium text-purple-900 mb-2">Variables Used</h4>
              <div class="flex flex-wrap gap-2">
                <% @preview[:variables_used].each do |var| %>
                  <code class="text-xs font-mono text-purple-700 bg-purple-100 px-2 py-1 rounded">{{<%= var %>}}</code>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
