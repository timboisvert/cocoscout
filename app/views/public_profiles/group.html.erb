<% content_for :title, @entity.name %>

<div class="w-full bg-gradient-to-b from-gray-50 to-white min-h-screen">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 sm:py-12">

    <%# Check if profile has rich content (not just basic info) %>
    <% primary_hs = @entity.primary_headshot %>
    <% has_headshot = primary_hs&.image&.attached? || @entity.headshot&.attached? %>
    <% is_person = @entity.is_a?(Person) %>
    <%
      has_performance_credits = begin
        @entity.performance_sections.joins(:performance_credits).any?
      rescue
        false
      end

      profile_has_content = has_headshot ||
                             @entity.profile_headshots.any? ||
                             @entity.profile_videos.any? ||
                             has_performance_credits ||
                             (is_person && @entity.training_credits.any?) ||
                             @entity.profile_skills.any? ||
                             @entity.profile_resumes.any? ||
                             (is_person && @entity.resume&.attached?) ||
                             (is_person && @entity.groups.where(archived_at: nil).any?)
    %>

    <%# Hero Section with Primary Headshot %>
    <% if has_headshot %>
      <div class="bg-white rounded-lg shadow-sm border border-gray-100 overflow-hidden mb-6">
        <div class="relative">
          <%# Background Pattern %>
          <div class="absolute inset-0 bg-gradient-to-br from-pink-50 via-white to-purple-50 opacity-50"></div>

          <div class="relative flex items-stretch">
            <%# Primary Headshot - Left Side %>
            <div class="flex-shrink-0 w-48 sm:w-64">
              <% if primary_hs&.image&.attached? %>
                <%= image_tag primary_hs.image.variant(resize_to_limit: [600, 1200]), class: "w-full h-full object-cover" %>
              <% elsif @entity.headshot&.attached? %>
                <%= image_tag @entity.headshot, class: "w-full h-full object-cover" %>
              <% end %>
            </div>

            <%# Name and Info - Right Side %>
            <div class="flex-1 p-6 sm:p-8 flex flex-col justify-center">
              <%# Name %>
              <div class="mb-4">
                <div class="flex items-center gap-2 flex-wrap">
                  <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 inter-bold leading-none"><%= @entity.name %></h1>
                </div>
              </div>

              <%# Contact Info %>
              <% if @entity.email.present? && !@entity.hide_contact_info %>
                <div class="mb-3">
                  <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Contact</div>
                  <div class="flex flex-col gap-2">
                    <%= mail_to @entity.email, class: "inline-flex items-center gap-2 text-sm text-gray-700 hover:text-pink-600 transition-colors" do %>
                      <svg width="16" height="16" class="fill-current flex-shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
                        <path d="M112 128C85.5 128 64 149.5 64 176C64 191.1 71.1 205.3 83.2 214.4L291.2 370.4C308.3 383.2 331.7 383.2 348.8 370.4L556.8 214.4C568.9 205.3 576 191.1 576 176C576 149.5 554.5 128 528 128L112 128zM64 260L64 448C64 483.3 92.7 512 128 512L512 512C547.3 512 576 483.3 576 448L576 260L377.6 408.8C343.5 434.4 296.5 434.4 262.4 408.8L64 260z"/>
                      </svg>
                      <span><%= @entity.email %></span>
                    <% end %>
                  </div>
                </div>
              <% end %>

              <%# Social Media & Links %>
              <% if @entity.social_media_visible? && @entity.socials.any? %>
                <div>
                  <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Links</div>
                  <div class="flex flex-col gap-2">
                    <% @entity.socials.each do |social| %>
                      <%= link_to social.url, target: "_blank", rel: "noopener", class: "inline-flex items-center gap-2 text-sm text-gray-700 hover:text-pink-600 transition-colors" do %>
                        <%= social.icon(16) %>
                        <span><%= social.display_name %></span>
                      <% end %>
                    <% end %>
                  </div>
                </div>
              <% end %>

              <%# Empty state prompt for group members with edit access %>
              <% if Current.user %>
                <% membership = @entity.group_memberships.find_by(person: Current.user.person) %>
                <% if membership && (membership.owner? || membership.write?) && !profile_has_content %>
                  <div class="mt-6 pt-6 border-t border-gray-200">
                    <div class="flex items-start gap-3 p-4 bg-pink-50 rounded-lg">
                      <div class="flex-shrink-0">
                        <%= image_tag "cocoscoutsmall.png", alt: "CocoScout", class: "w-8 h-8" %>
                      </div>
                      <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900 mb-1">Complete your group profile</p>
                        <p class="text-sm text-gray-600">Add headshots, videos, performance credits, and more to showcase your group.</p>
                      </div>
                    </div>
                  </div>
                <% end %>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    <% else %>
      <%# Without Headshot: Simple Card %>
      <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-6 sm:p-8 mb-6">
        <div class="relative">
          <%# Background Pattern %>
          <div class="absolute inset-0 bg-gradient-to-br from-pink-50 via-white to-purple-50 opacity-30 rounded-lg"></div>

          <div class="relative">
            <%# Name %>
              <div class="mb-4">
                <div class="flex items-center gap-2 flex-wrap">
                  <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 inter-bold leading-none"><%= @entity.name %></h1>
                </div>
              </div>

              <%# Contact Info %>
              <% if @entity.email.present? && !@entity.hide_contact_info %>
                <div class="mb-4">
                  <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Contact</div>
                  <div class="flex flex-col gap-2">
                    <%= mail_to @entity.email, class: "inline-flex items-center gap-2 text-sm text-gray-700 hover:text-pink-600 transition-colors" do %>
                      <svg width="16" height="16" class="fill-current flex-shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
                        <path d="M112 128C85.5 128 64 149.5 64 176C64 191.1 71.1 205.3 83.2 214.4L291.2 370.4C308.3 383.2 331.7 383.2 348.8 370.4L556.8 214.4C568.9 205.3 576 191.1 576 176C576 149.5 554.5 128 528 128L112 128zM64 260L64 448C64 483.3 92.7 512 128 512L512 512C547.3 512 576 483.3 576 448L576 260L377.6 408.8C343.5 434.4 296.5 434.4 262.4 408.8L64 260z"/>
                      </svg>
                      <span><%= @entity.email %></span>
                    <% end %>
                  </div>
                </div>
              <% end %>

              <%# Social Media & Links %>
              <% if @entity.social_media_visible? && @entity.socials.any? %>
                <div class="mb-4">
                  <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Links</div>
                  <div class="flex flex-col gap-2">
                    <% @entity.socials.each do |social| %>
                      <%= link_to social.url, target: "_blank", rel: "noopener", class: "inline-flex items-center gap-2 text-sm text-gray-700 hover:text-pink-600 transition-colors" do %>
                        <%= social.icon(16) %>
                        <span><%= social.display_name %></span>
                      <% end %>
                    <% end %>
                  </div>
                </div>
              <% end %>

              <%# Empty state prompt for group members with edit access %>
              <% if Current.user %>
                <% membership = @entity.group_memberships.find_by(person: Current.user.person) %>
                <% if membership && (membership.owner? || membership.write?) && !profile_has_content %>
                  <div class="mt-6 pt-6 border-t border-gray-200">
                    <div class="flex items-start gap-3 p-4 bg-pink-50 rounded-lg">
                      <div class="flex-shrink-0">
                        <%= image_tag "cocoscoutsmall.png", alt: "CocoScout", class: "w-8 h-8" %>
                      </div>
                      <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900 mb-1">Complete your group profile</p>
                        <p class="text-sm text-gray-600">Add headshots, videos, performance credits, and more to showcase your group.</p>
                      </div>
                    </div>
                  </div>
                <% end %>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    <% end %>

    <%# About/Bio Section %>
    <% if @entity.bio_visible? && @entity.bio.present? %>
      <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-4 sm:p-5 mb-4">
        <h2 class="text-lg sm:text-xl font-bold text-gray-900 inter-bold mb-3">Bio</h2>
        <div class="prose prose-sm max-w-none text-gray-700 whitespace-pre-wrap"><%= h(@entity.bio) %></div>
      </div>
    <% end %>

    <%# Headshots Gallery %>
    <% if @entity.headshots_visible? && @entity.profile_headshots.any? %>
      <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-4 sm:p-5 mb-4">
        <h2 class="text-lg sm:text-xl font-bold text-gray-900 inter-bold mb-3">Headshots</h2>
        <div class="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-6 gap-2">
          <% @entity.profile_headshots.each do |headshot| %>
            <div class="group relative aspect-[3/4] rounded overflow-hidden border border-gray-200 hover:border-pink-300 transition-all cursor-pointer" onclick="openHeadshotModal('<%= url_for(headshot.image.variant(resize_to_limit: [1200, 1800])) %>')">
              <%= image_tag headshot.image.variant(resize_to_limit: [200, 300]), class: "w-full h-full object-cover transition-transform group-hover:scale-105" %>
            </div>
          <% end %>
        </div>
      </div>

      <%# Headshot Modal %>
      <div id="headshot-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center p-4" onclick="closeHeadshotModal()">
        <button onclick="closeHeadshotModal()" class="absolute top-4 right-4 text-white hover:text-gray-300 transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-8 h-8">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
        <img id="modal-image" src="" class="max-w-full max-h-full object-contain" onclick="event.stopPropagation()" />
      </div>

      <script>
        function openHeadshotModal(imageUrl) {
          document.getElementById('modal-image').src = imageUrl;
          document.getElementById('headshot-modal').classList.remove('hidden');
        }

        function closeHeadshotModal() {
          document.getElementById('headshot-modal').classList.add('hidden');
        }

        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape') {
            closeHeadshotModal();
          }
        });
      </script>
    <% end %>

    <%# Videos & Reels Grid %>
    <% if @entity.videos_visible? && @entity.profile_videos.any? %>
      <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-4 sm:p-5 mb-4">
        <h2 class="text-lg sm:text-xl font-bold text-gray-900 inter-bold mb-3">Videos & Reels</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
          <% @entity.profile_videos.each do |video| %>
            <a href="<%= video.url %>" target="_blank" rel="noopener" class="group relative bg-gray-50 rounded-lg overflow-hidden border border-gray-200 group-hover:border-pink-300 group-hover:shadow-md transition-all flex flex-col">
              <% if video.embed_html.present? %>
                <div class="aspect-video w-full">
                  <%= video.embed_html.html_safe %>
                </div>
              <% end %>
              <div class="p-3 flex-1 flex flex-col">
                <h3 class="font-medium text-gray-900 text-xs mb-2 line-clamp-2 group-hover:text-pink-600 transition-colors"><%= video.title %></h3>
                <div class="mt-auto flex items-center gap-1 text-xs text-pink-600 group-hover:text-pink-700 font-medium">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-3 h-3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" />
                  </svg>
                  <span>View on <%= video.platform || "Platform" %></span>
                </div>
              </div>
            </a>
          <% end %>
        </div>
      </div>
    <% end %>

    <%# Shoutouts Section %>
    <% shoutouts_count = @entity.received_shoutouts.left_joins(:replacement).where(replacement: { id: nil }).count %>
    <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-4 sm:p-5 mb-4">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg sm:text-xl font-bold text-gray-900 inter-bold">Shoutouts</h2>
      </div>

      <div class="flex items-center justify-between">
        <div>
          <p class="text-gray-600 text-sm mb-3">
            <%= @entity.name %> has received
            <% if shoutouts_count > 0 %>
              <%= link_to "#{shoutouts_count} #{'shoutout'.pluralize(shoutouts_count)}", public_profile_shoutouts_path(@entity.public_key), class: "text-pink-600 hover:text-pink-700 font-medium" %>.
            <% else %>
              <%= shoutouts_count %> <%= "shoutout".pluralize(shoutouts_count) %>.
            <% end %>
          </p>
        </div>
      </div>

      <% if Current.user && !@entity.group_memberships.exists?(person: Current.user.person) %>
        <%= render "shared/button",
            text: "Give #{@entity.name} a Shoutout",
            path: my_shoutouts_path(tab: "given", shoutee_type: @entity.class.name, shoutee_id: @entity.id),
            variant: "primary",
            size: "medium" %>
      <% elsif !Current.user %>
        <%= render "shared/button",
            text: "Sign in to Give a Shoutout",
            path: signin_path,
            variant: "primary",
            size: "medium" %>
      <% end %>
    </div>

    <%# Performance History with Sections %>
    <% if @entity.performance_credits_visible? %>
      <% sections_with_credits = @entity.performance_sections.includes(:performance_credits).where.not(performance_credits: { id: nil }).order(position: :asc) %>
      <% if sections_with_credits.any? %>
        <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-4 sm:p-5 mb-4">
          <h2 class="text-lg sm:text-xl font-bold text-gray-900 inter-bold mb-3">Performance History</h2>

          <% sections_with_credits.each do |section| %>
            <div class="mb-4 last:mb-0">
              <h3 class="text-sm font-bold text-gray-800 mb-1.5 pb-1 border-b border-gray-200"><%= section.name %></h3>
              <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                  <tbody class="divide-y divide-gray-100">
                    <% section.performance_credits.order(year_start: :desc, created_at: :desc).each do |credit| %>
                      <tr class="hover:bg-gray-50 transition-colors">
                        <td class="py-1.5 pr-4 text-sm w-1/3 text-gray-900"><%= credit.title %></td>
                        <td class="py-1.5 px-4 text-sm w-1/3 text-gray-700"><%= credit.role %></td>
                        <td class="py-1.5 pl-4 text-sm w-1/3 text-right text-gray-600 whitespace-nowrap"><%= credit.display_year_range_with_present %></td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>
    <% end %>

    <%# Resume %>
    <% if @entity.resumes_visible? && @entity.profile_resumes.any? %>
      <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-4 sm:p-5 mb-4">
        <h2 class="text-lg sm:text-xl font-bold text-gray-900 inter-bold mb-3">Resume</h2>
        <div class="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-6 gap-2">
          <% @entity.profile_resumes.each do |resume| %>
            <% if resume.file.attached? %>
              <% content_type = resume.file.content_type.to_s %>
              <% is_pdf = content_type.include?("pdf") %>
              <% is_image = content_type.start_with?("image/") %>
              <a href="<%= rails_blob_path(resume.file, disposition: "attachment") %>" class="group flex flex-col">
                <div class="bg-white aspect-[3/4] flex items-center justify-center overflow-hidden rounded border-2 border-gray-300 group-hover:border-pink-400 group-hover:shadow-md transition-all mb-1.5 flex-shrink-0">
                  <% if is_image %>
                    <%= image_tag resume.file.variant(resize_to_limit: [100, 150]), class: "w-full h-full object-cover" %>
                  <% elsif is_pdf || content_type.include?("pdf") %>
                    <% if resume.file.representable? %>
                      <%= image_tag resume.file.representation(resize_to_limit: [300, 450]), class: "w-full h-full object-cover" %>
                    <% else %>
                      <div class="flex flex-col items-center justify-center w-full h-full bg-gradient-to-br from-red-50 to-red-100">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-red-600 mb-1">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                        </svg>
                        <span class="text-xs font-bold text-red-700">PDF</span>
                      </div>
                    <% end %>
                  <% else %>
                    <div class="flex flex-col items-center justify-center w-full h-full bg-gradient-to-br from-gray-100 to-gray-200">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-gray-600 mb-1">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                      </svg>
                      <span class="text-xs font-medium text-gray-600">File</span>
                    </div>
                  <% end %>
                </div>
                <h3 class="font-medium text-gray-900 text-xs line-clamp-2 group-hover:text-pink-600 transition-colors leading-tight mb-0.5"><%= resume.name.presence || "Resume" %></h3>
                <div class="flex items-center gap-1 text-xs text-pink-600 group-hover:text-pink-700 font-medium">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-3 h-3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                  </svg>
                  <span>Download</span>
                </div>
              </a>
            <% end %>
          <% end %>
        </div>
      </div>
    <% end %>

    <%# Legacy Resume (if present and no new resumes) %>
    <% if @entity.resumes_visible? && is_person && @entity.resume&.attached? && @entity.profile_resumes.empty? %>
      <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-3 sm:p-4 mb-4">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg sm:text-xl font-bold text-gray-900 inter-bold">Resume</h2>
          <%= link_to rails_blob_path(@entity.resume, disposition: "attachment"), class: "inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-pink-600 hover:bg-pink-700 rounded-lg shadow-sm transition-colors" do %>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
            </svg>
            Download
          <% end %>
        </div>
      </div>
    <% end %>

    <%# Members Section %>
    <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-4 sm:p-5">
      <h2 class="text-lg sm:text-xl font-bold text-gray-900 inter-bold mb-3">Members</h2>
      <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
        <% @entity.group_memberships.includes(:person).each do |membership| %>
          <%= link_to public_profile_path(membership.person.public_key), class: "group" do %>
            <div class="flex flex-col items-center p-4 bg-gradient-to-br from-gray-50 to-white border border-gray-200 rounded-xl hover:border-pink-300 hover:shadow-lg transition-all">
              <% if membership.person.headshot&.attached? %>
                <%= image_tag membership.person.headshot.variant(:thumb), class: "w-20 h-20 rounded-xl object-cover mb-3 ring-2 ring-gray-100 group-hover:ring-pink-200 transition-all" %>
              <% else %>
                <div class="w-20 h-20 rounded-xl bg-gradient-to-br from-pink-400 to-purple-500 flex items-center justify-center text-white font-bold text-xl mb-3 ring-2 ring-gray-100 group-hover:ring-pink-200 transition-all">
                  <%= membership.person.initials %>
                </div>
              <% end %>
              <span class="text-sm font-semibold text-gray-900 text-center group-hover:text-pink-600 transition-colors line-clamp-2">
                <%= membership.person.name %>
              </span>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>

    <%# CocoScout Footer %>
    <div class="mt-16 pt-4 border-t border-gray-100">
      <div class="flex items-center gap-2 text-xs text-gray-400">
        <%= render "shared/cocoscout_logo", size: :tiny, class: "opacity-50" %>
        <span class="coustard-regular">CocoScout</span>
        <% unless Current.user %>
          <span class="text-gray-300 mx-1">Â·</span>
          <%= link_to "Create your profile", signup_path, class: "hover:text-pink-500 transition-colors" %>
        <% end %>
      </div>
    </div>

  </div>
</div>
