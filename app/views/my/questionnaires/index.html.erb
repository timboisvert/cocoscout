<% content_for :title, "My Questionnaires" %>

<div class="w-full">
  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [],
    text: "My Questionnaires",
    links: []
  } %>

  <div class="pb-10">
    <!-- Filter Buttons -->
    <div class="flex items-center justify-between mb-4 gap-4">
      <!-- Left: Filter -->
      <div class="flex flex-wrap gap-1">
        <%= link_to "Awaiting My Response", my_questionnaires_path(filter: 'awaiting', entity: @entity_filter.join(",")), data: { turbo_prefetch: false }, class: "px-3 py-1 rounded-lg border text-sm font-normal transition-all #{@filter == 'awaiting' ? 'bg-pink-500 text-white border-pink-500' : 'bg-white text-gray-700 border-gray-200 hover:bg-gray-50'}" %>
        <%= link_to "All", my_questionnaires_path(filter: 'all', entity: @entity_filter.join(",")), data: { turbo_prefetch: false }, class: "px-3 py-1 rounded-lg border text-sm font-normal transition-all #{@filter == 'all' ? 'bg-pink-500 text-white border-pink-500' : 'bg-white text-gray-700 border-gray-200 hover:bg-gray-50'}" %>
      </div>

      <% if @groups.any? %>
      <!-- Right: Entity Filter -->
      <div class="flex flex-wrap gap-1 justify-end">
        <%
          # Build the toggle URL for person
          current_entities = @entity_filter.dup
          person_url_entities = if current_entities.include?('person')
            current_entities - ['person']
          else
            current_entities + ['person']
          end
          person_url_entities = ['person'] if person_url_entities.empty? # Keep at least one
        %>
        <%= link_to my_questionnaires_path(filter: @filter, entity: person_url_entities.join(",")),
                data: { turbo_prefetch: false },
                class: "inline-flex items-center gap-1.5 px-3 py-1 rounded-lg border text-sm font-normal transition-all #{@entity_filter.include?("person") ? "bg-pink-500 text-white border-pink-500" : "bg-white text-gray-700 border-gray-300 hover:border-pink-300 hover:bg-pink-50"}" do %>
          <svg class="w-3.5 h-3.5 <%= @entity_filter.include?("person") ? "" : "opacity-20" %>" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
          <%= @person.name %>
        <% end %>

        <% @groups.each do |group| %>
          <%
            # Build the toggle URL for this group
            group_key = "group_#{group.id}"
            current_entities = @entity_filter.dup
            group_url_entities = if current_entities.include?(group_key)
              current_entities - [group_key]
            else
              current_entities + [group_key]
            end
            group_url_entities = ['person'] if group_url_entities.empty? # Keep at least one
          %>
          <%= link_to my_questionnaires_path(filter: @filter, entity: group_url_entities.join(",")),
                  data: { turbo_prefetch: false },
                  class: "inline-flex items-center gap-1.5 px-3 py-1 rounded-lg border text-sm font-normal transition-all #{@entity_filter.include?(group_key) ? "bg-pink-500 text-white border-pink-500" : "bg-white text-gray-700 border-gray-300 hover:border-pink-300 hover:bg-pink-50"}" do %>
            <svg class="w-3.5 h-3.5 <%= @entity_filter.include?(group_key) ? "" : "opacity-20" %>" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
            <%= group.name %>
          <% end %>
        <% end %>
      </div>
      <% end %>
    </div>

    <% if @questionnaire_entity_pairs.any? %>
      <div class="grid grid-cols-1 gap-2">
        <% @questionnaire_entity_pairs.each do |pair| %>
          <% questionnaire = pair[:questionnaire] %>
          <% entity = pair[:entity] %>
          <div class="p-4 bg-white border border-gray-200 rounded-lg <%= questionnaire.archived_at.nil? && questionnaire.accepting_responses ? 'hover:border-gray-400' : '' %> transition-all flex items-start">
            <% if questionnaire.archived_at.nil? && questionnaire.accepting_responses %>
              <%
                # Build the questionnaire URL with entity params if user has groups
                questionnaire_url = if @groups.any?
                  my_questionnaire_form_path(token: questionnaire.token, respondent_type: pair[:entity_type].classify, respondent_id: entity.id)
                else
                  my_questionnaire_form_path(token: questionnaire.token)
                end
              %>
              <%= link_to questionnaire_url, class: "flex-1 no-underline" do %>
                <h3 class="text-md font-semibold text-gray-900"><%= questionnaire.title %></h3>
                <p class="text-sm text-gray-600 mt-1"><%= questionnaire.production.name %></p>
                <div class="flex items-center gap-3 mt-2">
                  <% if questionnaire.questionnaire_responses.exists?(respondent: entity) %>
                    <span class="inline-flex items-center rounded-md px-2 py-1 text-xs font-medium bg-pink-50 text-pink-700 ring-1 ring-inset ring-pink-600/20">
                      Responded
                    </span>
                  <% else %>
                    <span class="inline-flex items-center rounded-md px-2 py-1 text-xs font-medium bg-yellow-50 text-yellow-700 ring-1 ring-inset ring-yellow-600/20">
                      Not Responded
                    </span>
                  <% end %>
                  <% unless questionnaire.accepting_responses %>
                    <span class="inline-flex items-center rounded-md px-2 py-1 text-xs font-medium bg-gray-50 text-gray-600 ring-1 ring-inset ring-gray-500/10">
                      Closed
                    </span>
                  <% end %>
                </div>
              <% end %>
            <% else %>
              <div class="flex-1">
                <h3 class="text-md font-semibold text-gray-900"><%= questionnaire.title %></h3>
                <p class="text-sm text-gray-600 mt-1"><%= questionnaire.production.name %></p>
                <div class="flex items-center gap-3 mt-2">
                  <% if questionnaire.questionnaire_responses.exists?(respondent: entity) %>
                    <span class="inline-flex items-center rounded-md px-2 py-1 text-xs font-medium bg-pink-50 text-pink-700 ring-1 ring-inset ring-pink-600/20">
                      Responded
                    </span>
                  <% else %>
                    <span class="inline-flex items-center rounded-md px-2 py-1 text-xs font-medium bg-yellow-50 text-yellow-700 ring-1 ring-inset ring-yellow-600/20">
                      Not Responded
                    </span>
                  <% end %>
                  <% unless questionnaire.accepting_responses %>
                    <span class="inline-flex items-center rounded-md px-2 py-1 text-xs font-medium bg-gray-50 text-gray-600 ring-1 ring-inset ring-gray-500/10">
                      Closed
                    </span>
                  <% end %>
                </div>
              </div>
            <% end %>

            <% if @groups.any? %>
              <% headshot = entity.safe_headshot_variant(:thumb) %>
              <% if headshot %>
                <%= image_tag headshot, class: "w-10 h-10 rounded-lg object-cover ml-2", alt: entity.name %>
              <% end %>
            <% end %>
          </div>
        <% end %>
      </div>
    <% else %>
      <p class="text-gray-500 text-sm pt-2">
        <% if @filter == 'awaiting' %>
          You're caught up on responding to questionnaires.
        <% else %>
          You haven't been assigned any questionnaires.
        <% end %>
      </p>
    <% end %>
  </div>
</div>
