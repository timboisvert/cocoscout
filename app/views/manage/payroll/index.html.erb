<% content_for :title, "Payroll" %>

<div class="w-full mb-10">
  <%= render partial: "shared/notice", locals: { notice: notice, alert: alert } %>

  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [
      ["Money", manage_money_index_path],
      ["Payouts", manage_money_payouts_path]
    ],
    text: "Payroll"
  } %>

  <% if @schedule %>
    <%# 60/40 Layout for configured payroll %>
    <div class="flex flex-col lg:flex-row gap-6">
      <%# Left side - 60% - Current Period %>
      <div class="lg:w-3/5">
        <%# Current Pay Period %>
        <div class="bg-white rounded-lg border border-gray-200 mb-6">
          <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="font-semibold text-gray-900">Current Pay Period</h3>
                <p class="text-sm text-gray-500">
                  <%= @current_period[:start].strftime("%B %-d") %> â€” <%= @current_period[:end].strftime("%B %-d, %Y") %>
                  <span class="text-gray-400">â€¢</span>
                  Payday: <%= @current_period[:payday].strftime("%A, %B %-d") %>
                </p>
              </div>
              <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-pink-100 text-pink-800">
                <%= @schedule.period_type_label %>
              </span>
            </div>
          </div>

          <% if @preview_items.any? %>
            <div class="divide-y divide-gray-100">
              <% @preview_items.sort_by { |person, data| person.name.downcase }.each do |person, data| %>
                <div class="px-6 py-3 flex items-center justify-between hover:bg-gray-50">
                  <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 text-sm font-medium">
                      <%= person.name.first.upcase %>
                    </div>
                    <div>
                      <div class="font-medium text-gray-900"><%= person.name %></div>
                      <div class="text-sm text-gray-500">
                        <%= data[:show_count] %> show<%= data[:show_count] != 1 ? "s" : "" %>
                        <% if data[:productions].size > 1 %>
                          across <%= data[:productions].size %> productions
                        <% end %>
                      </div>
                    </div>
                  </div>
                  <div class="text-right">
                    <div class="font-semibold text-gray-900"><%= number_to_currency(data[:net]) %></div>
                    <% if data[:deductions] && data[:deductions] > 0 %>
                      <div class="text-xs text-gray-500">
                        <%= number_to_currency(data[:gross]) %> âˆ’ <%= number_to_currency(data[:deductions]) %> advances
                      </div>
                    <% end %>
                  </div>
                </div>
              <% end %>
            </div>

            <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 rounded-b-lg">
              <div class="flex items-center justify-between">
                <div class="text-gray-600">
                  <span class="font-semibold text-gray-900"><%= @preview_items.count %></span> people
                  <span class="text-gray-400 mx-2">â€¢</span>
                  Total: <span class="font-semibold text-gray-900"><%= number_to_currency(@preview_items.sum { |_, d| d[:net] }) %></span>
                </div>
              </div>
            </div>
          <% else %>
            <div class="px-6 py-12 text-center text-gray-500">
              <div class="text-3xl mb-2">ðŸŽ‰</div>
              <p>No payouts due for this period.</p>
              <p class="text-sm mt-1">All set! Check back next pay period.</p>
            </div>
          <% end %>
        </div>

        <%# Pending Runs (if any) %>
        <% if @pending_runs.any? %>
          <div class="bg-white rounded-lg border border-gray-200 mb-6">
            <div class="px-6 py-4 border-b border-gray-200">
              <h3 class="font-semibold text-gray-900">Pending Payroll Runs</h3>
            </div>
            <div class="divide-y divide-gray-100">
              <% @pending_runs.each do |run| %>
                <div class="px-6 py-4 flex items-center justify-between hover:bg-gray-50">
                  <div>
                    <div class="font-medium text-gray-900">
                      <%= run.period_start.strftime("%b %-d") %> â€“ <%= run.period_end.strftime("%b %-d, %Y") %>
                    </div>
                    <div class="text-sm text-gray-500">
                      <%= run.line_item_count %> people
                      <span class="text-gray-400">â€¢</span>
                      <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium <%= run.processing? ? 'bg-pink-100 text-pink-700' : 'bg-gray-100 text-gray-700' %>">
                        <%= run.status.titleize %>
                      </span>
                    </div>
                  </div>
                  <div class="flex items-center gap-4">
                    <span class="font-semibold text-gray-900"><%= number_to_currency(run.calculated_total_amount) %></span>
                    <%= link_to "View â†’", manage_money_payroll_run_path(run), class: "text-pink-600 hover:text-pink-700 text-sm font-medium" %>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>

        <%# Previous Periods / Completed Runs %>
        <% if @completed_runs.any? %>
          <div class="bg-white rounded-lg border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200">
              <h3 class="font-semibold text-gray-900">Payment History</h3>
            </div>
            <div class="divide-y divide-gray-100">
              <% @completed_runs.each do |run| %>
                <div class="px-6 py-3 flex items-center justify-between hover:bg-gray-50">
                  <div>
                    <div class="font-medium text-gray-900">
                      <%= run.period_start.strftime("%b %-d") %> â€“ <%= run.period_end.strftime("%b %-d, %Y") %>
                    </div>
                    <div class="text-sm text-gray-500">
                      Paid <%= run.processed_at&.strftime("%b %-d, %Y") || "â€”" %>
                      <span class="text-gray-400">â€¢</span>
                      <%= run.line_item_count %> people
                    </div>
                  </div>
                  <div class="flex items-center gap-4">
                    <span class="font-medium text-pink-600"><%= number_to_currency(run.calculated_total_amount) %></span>
                    <%= link_to "View â†’", manage_money_payroll_run_path(run), class: "text-gray-500 hover:text-gray-700 text-sm" %>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>

      <%# Right side - 40% - Quick Actions & Settings %>
      <div class="lg:w-2/5 space-y-6">
        <%# Make Payments Now %>
        <div class="bg-white rounded-lg border border-gray-200">
          <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="font-semibold text-gray-900">Quick Actions</h3>
          </div>
          <div class="p-6">
            <% if @preview_items.any? %>
              <p class="text-gray-600 mb-4">
                Ready to pay <span class="font-semibold"><%= @preview_items.count %></span> people
                <span class="font-semibold"><%= number_to_currency(@preview_items.sum { |_, d| d[:net] }) %></span>
                for the current period.
              </p>
              <%= link_to manage_new_money_payroll_run_path do %>
                <%= render "shared/button", text: "Create Payroll Run", variant: "primary", size: "medium", icon: "arrow-right", full_width: true %>
              <% end %>
            <% else %>
              <p class="text-gray-500 text-center py-4">
                No payments due for the current period.
              </p>
            <% end %>
          </div>
        </div>

        <%# Payroll Schedule Summary %>
        <div class="bg-white rounded-lg border border-gray-200">
          <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
            <h3 class="font-semibold text-gray-900">Schedule</h3>
            <%= link_to manage_money_payroll_settings_path, class: "text-pink-600 hover:text-pink-700 text-sm font-medium" do %>
              Edit
            <% end %>
          </div>
          <div class="p-6 space-y-3">
            <div class="flex justify-between text-sm">
              <span class="text-gray-500">Pay periods</span>
              <span class="font-medium text-gray-900"><%= @schedule.period_type_label %></span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-gray-500">Payday</span>
              <span class="font-medium text-gray-900"><%= @schedule.payday_timing_label %></span>
            </div>
            <% if @schedule.semi_monthly? %>
              <div class="flex justify-between text-sm">
                <span class="text-gray-500">Split</span>
                <span class="font-medium text-gray-900">
                  <%= @schedule.semi_monthly_days == "1_and_16" ? "1stâ€“15th & 16thâ€“end" : "1stâ€“14th & 15thâ€“end" %>
                </span>
              </div>
            <% end %>
          </div>
        </div>

        <%# Stats %>
        <div class="bg-white rounded-lg border border-gray-200">
          <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="font-semibold text-gray-900">All Unpaid</h3>
          </div>
          <div class="p-6">
            <div class="text-3xl font-bold text-pink-600"><%= number_to_currency(@unpaid_amount) %></div>
            <div class="text-gray-500 mt-1">
              <%= @unpaid_line_items_count %> line items across <%= @productions.count %> production<%= @productions.count != 1 ? "s" : "" %>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% else %>
    <%# No payroll schedule - show setup prompt %>
    <div class="max-w-2xl mx-auto">
      <div class="bg-white rounded-lg border border-gray-200 p-8 text-center">
        <div class="text-5xl mb-4">ðŸ“…</div>
        <h2 class="text-xl font-semibold text-gray-900 mb-2">Set Up Payroll</h2>
        <p class="text-gray-600 mb-6">
          Configure your pay periods and payday schedule. Once set up, payroll runs will be automatically calculated based on your schedule.
        </p>
        <%= link_to manage_money_payroll_settings_path do %>
          <%= render "shared/button", text: "Configure Payroll Schedule", variant: "primary", size: "large", icon: "settings" %>
        <% end %>
      </div>

      <%# Still show unpaid stats %>
      <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-white rounded-lg border border-gray-200 p-6">
          <div class="text-3xl font-bold text-pink-600"><%= number_to_currency(@unpaid_amount) %></div>
          <div class="text-gray-500 mt-1">Unpaid payouts</div>
          <div class="text-sm text-gray-400 mt-1"><%= @unpaid_line_items_count %> line items</div>
        </div>

        <div class="bg-white rounded-lg border border-gray-200 p-6">
          <div class="text-3xl font-bold text-gray-700"><%= @productions.count %></div>
          <div class="text-gray-500 mt-1">In-house productions</div>
        </div>
      </div>

      <%# Manual run option %>
      <div class="mt-6 text-center">
        <p class="text-gray-500 mb-4">Or create a one-off payroll run manually:</p>
        <%= link_to manage_new_money_payroll_run_path do %>
          <%= render "shared/button", text: "Create Manual Run", variant: "secondary", size: "medium" %>
        <% end %>
      </div>
    </div>
  <% end %>
</div>
