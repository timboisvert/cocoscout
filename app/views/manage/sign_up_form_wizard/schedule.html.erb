<%
  # Calculate step number based on scope
  step_num = @wizard_state[:scope] == "shared_pool" ? 4 : 5
  is_waitlist = @wizard_state[:scope] == "shared_pool"

  # Get current values or defaults
  opens_value = @wizard_state[:opens_value] || 7
  opens_unit = @wizard_state[:opens_unit] || 'days'
  opens_minutes = @wizard_state[:opens_minutes] || 0
  closes_mode = @wizard_state[:closes_mode] || 'event_start'
  closes_offset_value = @wizard_state[:closes_offset_value] || 2
  closes_offset_unit = @wizard_state[:closes_offset_unit] || 'hours'
  closes_before_after = @wizard_state[:closes_before_after] || 'before'
  schedule_mode = @wizard_state[:schedule_mode] || 'relative'
%>
<%= render layout: "manage/sign_up_form_wizard/wizard_layout", locals: { current_step: step_num, step_name: is_waitlist ? "Activation" : "Schedule" } do %>
  <% if is_waitlist %>
    <h2 class="text-xl font-bold text-gray-900 mb-2 coustard-regular">When should this waitlist go live?</h2>
    <p class="text-gray-600 mb-6">Choose when people can start signing up.</p>
  <% else %>
    <h2 class="text-xl font-bold text-gray-900 mb-2 coustard-regular">When can people register?</h2>
    <p class="text-gray-600 mb-6">Set when sign-ups open and close.</p>
  <% end %>

  <%
    # For waitlists, use activation_mode (now/scheduled); for events, use schedule_mode
    initial_selected = if is_waitlist
      @wizard_state[:opens_at].present? ? 'scheduled' : 'now'
    else
      schedule_mode
    end
  %>
  <%= form_with url: manage_signups_forms_wizard_save_schedule_path(@production), method: :post, local: true, data: { controller: "option-select", "option-select-selected-value": initial_selected } do |form| %>
    <div class="space-y-6">
      <% if is_waitlist %>
        <!-- Simple activation date for waitlist -->
        <input type="hidden" name="schedule_mode" value="fixed">

        <div class="grid grid-cols-2 gap-3">
          <label class="block cursor-pointer">
            <div class="p-4 bg-gray-50 rounded-lg border-2 text-center h-full <%= @wizard_state[:opens_at].blank? ? 'border-pink-500 bg-pink-50' : 'border-gray-200' %> hover:border-pink-300 transition-colors"
                 data-option-select-target="option"
                 data-value="now">
              <input type="radio" name="activation_mode" value="now"
                     <%= "checked" if @wizard_state[:opens_at].blank? %>
                     class="sr-only"
                     data-option-select-target="input"
                     data-action="change->option-select#select">
              <div class="flex justify-center mb-1">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7 text-gray-600">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" />
                </svg>
              </div>
              <p class="font-medium text-gray-900 text-sm">Activate immediately</p>
              <p class="text-xs text-gray-500 mt-1">Open as soon as you create it</p>
            </div>
          </label>

          <label class="block cursor-pointer">
            <div class="p-4 bg-gray-50 rounded-lg border-2 text-center h-full <%= @wizard_state[:opens_at].present? ? 'border-pink-500 bg-pink-50' : 'border-gray-200' %> hover:border-pink-300 transition-colors"
                 data-option-select-target="option"
                 data-value="scheduled">
              <input type="radio" name="activation_mode" value="scheduled"
                     <%= "checked" if @wizard_state[:opens_at].present? %>
                     class="sr-only"
                     data-option-select-target="input"
                     data-action="change->option-select#select">
              <div class="flex justify-center mb-1">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7 text-gray-600">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
                </svg>
              </div>
              <p class="font-medium text-gray-900 text-sm">Activate on a date</p>
              <p class="text-xs text-gray-500 mt-1">Schedule for a future time</p>
            </div>
          </label>
        </div>

        <div data-option-select-target="conditionalScheduled" class="<%= @wizard_state[:opens_at].present? ? '' : 'hidden' %>">
          <div class="w-full sm:w-2/3">
            <label class="block text-gray-700 font-medium">Opens at</label>
            <input type="datetime-local" name="opens_at"
                   value="<%= @wizard_state[:opens_at].is_a?(String) ? @wizard_state[:opens_at] : @wizard_state[:opens_at]&.strftime('%Y-%m-%dT%H:%M') %>"
                   class="block shadow-sm rounded-lg border border-gray-400 px-3 py-2 mt-2 w-full">
          </div>

          <div class="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-100">
            <div class="flex">
              <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a.75.75 0 000 1.5h.253a.25.25 0 01.244.304l-.459 2.066A1.75 1.75 0 0010.747 15H11a.75.75 0 000-1.5h-.253a.25.25 0 01-.244-.304l.459-2.066A1.75 1.75 0 009.253 9H9z" clip-rule="evenodd" />
                </svg>
              </div>
              <div class="ml-3">
                <p class="text-sm text-blue-800">
                  <strong>Note:</strong> The waitlist will remain open until you close it manually.
                </p>
              </div>
            </div>
          </div>
        </div>

      <% elsif @wizard_state[:scope] == 'repeated' || @wizard_state[:scope] == 'single_event' %>
        <!-- Schedule Mode Selection -->
        <div class="grid grid-cols-2 gap-3">
          <label class="block cursor-pointer">
            <div class="p-4 bg-gray-50 rounded-lg border-2 text-center <%= schedule_mode == 'relative' ? 'border-pink-500 bg-pink-50' : 'border-gray-200' %> hover:border-pink-300 transition-colors"
                 data-option-select-target="option"
                 data-value="relative"
                 data-action="click->option-select#select">
              <input type="radio" name="schedule_mode" value="relative"
                     <%= "checked" if schedule_mode == 'relative' %>
                     class="sr-only"
                     data-option-select-target="input">
              <div class="flex justify-center mb-1">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7 text-gray-600">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5" />
                </svg>
              </div>
              <p class="font-medium text-gray-900 text-sm">Relative to Event</p>
              <p class="text-xs text-gray-500 mt-1">Based on each event's date</p>
            </div>
          </label>

          <label class="block cursor-pointer">
            <div class="p-4 bg-gray-50 rounded-lg border-2 text-center <%= schedule_mode == 'immediate' ? 'border-pink-500 bg-pink-50' : 'border-gray-200' %> hover:border-pink-300 transition-colors"
                 data-option-select-target="option"
                 data-value="immediate"
                 data-action="click->option-select#select">
              <input type="radio" name="schedule_mode" value="immediate"
                     <%= "checked" if schedule_mode == 'immediate' %>
                     class="sr-only"
                     data-option-select-target="input">
              <div class="flex justify-center mb-1">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7 text-gray-600">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" />
                </svg>
              </div>
              <p class="font-medium text-gray-900 text-sm">Opens Immediately</p>
              <p class="text-xs text-gray-500 mt-1">Open as soon as you create</p>
            </div>
          </label>

          <label class="block cursor-pointer">
            <div class="p-4 bg-gray-50 rounded-lg border-2 text-center <%= schedule_mode == 'fixed' ? 'border-pink-500 bg-pink-50' : 'border-gray-200' %> hover:border-pink-300 transition-colors"
                 data-option-select-target="option"
                 data-value="fixed"
                 data-action="click->option-select#select">
              <input type="radio" name="schedule_mode" value="fixed"
                     <%= "checked" if schedule_mode == 'fixed' %>
                     class="sr-only"
                     data-option-select-target="input">
              <div class="flex justify-center mb-1">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-7 h-7 text-gray-600">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 2.994v2.25m10.5-2.25v2.25m-14.252 13.5V7.491a2.25 2.25 0 0 1 2.25-2.25h13.5a2.25 2.25 0 0 1 2.25 2.25v11.251m-18 0a2.25 2.25 0 0 0 2.25 2.25h13.5a2.25 2.25 0 0 0 2.25-2.25m-18 0v-7.5a2.25 2.25 0 0 1 2.25-2.25h13.5a2.25 2.25 0 0 1 2.25 2.25v7.5m-6.75-6h2.25m-9 2.25h4.5m.002-2.25h.005v.006H12v-.006Zm-.001 4.5h.006v.006h-.006v-.005Zm-2.25.001h.005v.006H9.75v-.006Zm-2.25 0h.005v.005h-.006v-.005Zm6.75-2.247h.005v.005h-.005v-.005Zm0 2.247h.006v.006h-.006v-.006Zm2.25-2.248h.006V15H16.5v-.005Z" />
                </svg>
              </div>
              <p class="font-medium text-gray-900 text-sm">Fixed Dates</p>
              <p class="text-xs text-gray-500 mt-1">Same open/close for all</p>
            </div>
          </label>
        </div>

        <!-- Immediate Schedule Options -->
        <div data-option-select-target="conditionalImmediate" class="<%= schedule_mode == 'immediate' ? '' : 'hidden' %> space-y-4">
          <div class="p-4 bg-blue-50 rounded-lg border border-blue-100">
            <div class="flex">
              <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a.75.75 0 000 1.5h.253a.25.25 0 01.244.304l-.459 2.066A1.75 1.75 0 0010.747 15H11a.75.75 0 000-1.5h-.253a.25.25 0 01-.244-.304l.459-2.066A1.75 1.75 0 009.253 9H9z" clip-rule="evenodd" />
                </svg>
              </div>
              <div class="ml-3">
                <p class="text-sm text-blue-800">
                  Sign-ups will open immediately when you create this form.
                </p>
              </div>
            </div>
          </div>

          <%# Close Registration Box for Immediate mode %>
          <%
            imm_closes_days = @wizard_state[:closes_offset_days] || 0
            imm_closes_hours = @wizard_state[:closes_offset_hours] || 2
            imm_closes_mins = @wizard_state[:closes_minutes_offset] || 0
            imm_closes_before_after = @wizard_state[:closes_before_after] || 'after'
          %>
          <div class="p-4 bg-gray-50 rounded-lg" data-controller="closes-mode">
            <label class="block text-gray-700 font-medium mb-3">Close registration</label>
            <div class="space-y-2">
              <%# Option 1: Close when event starts (default) %>
              <div class="p-3 rounded-lg border-2 cursor-pointer transition-colors
                          <%= closes_mode == 'event_start' ? 'border-pink-500 bg-pink-50' : 'border-gray-200 hover:border-gray-300' %>"
                   data-action="click->closes-mode#selectEventStart">
                <label class="flex items-center cursor-pointer">
                  <input type="radio" name="closes_mode" value="event_start"
                         <%= "checked" if closes_mode == 'event_start' %>
                         class="sr-only"
                         data-closes-mode-target="eventStartRadio">
                  <span class="text-sm font-medium text-gray-900">Close when event starts</span>
                </label>
              </div>

              <%# Option 2: Close relative to event (days/hours/minutes) %>
              <div class="p-3 rounded-lg border-2 cursor-pointer transition-colors
                          <%= closes_mode == 'custom' ? 'border-pink-500 bg-pink-50' : 'border-gray-200 hover:border-gray-300' %>"
                   data-action="click->closes-mode#selectCustom">
                <label class="flex items-center cursor-pointer">
                  <input type="radio" name="closes_mode" value="custom"
                         <%= "checked" if closes_mode == 'custom' %>
                         class="sr-only"
                         data-closes-mode-target="customRadio">
                  <span class="text-sm font-medium text-gray-900">Close registration</span>
                </label>
                <div class="flex flex-wrap items-center gap-2 mt-2" data-closes-mode-target="customFields" onclick="event.stopPropagation()">
                  <input type="number" name="closes_offset_days" value="<%= imm_closes_days %>" min="0"
                         class="w-16 shadow-sm rounded-lg border border-gray-400 px-2 py-1.5 text-sm">
                  <span class="text-sm text-gray-600">days</span>
                  <input type="number" name="closes_offset_hours" value="<%= imm_closes_hours %>" min="0" max="23"
                         class="w-16 shadow-sm rounded-lg border border-gray-400 px-2 py-1.5 text-sm">
                  <span class="text-sm text-gray-600">hours</span>
                  <input type="number" name="closes_minutes_offset" value="<%= imm_closes_mins %>" min="0" max="59"
                         class="w-16 shadow-sm rounded-lg border border-gray-400 px-2 py-1.5 text-sm">
                  <span class="text-sm text-gray-600">minutes</span>
                  <select name="closes_before_after" class="shadow-sm rounded-lg border border-gray-400 px-2 py-1.5 text-sm">
                    <option value="after" <%= "selected" if imm_closes_before_after == 'after' %>>after</option>
                    <option value="before" <%= "selected" if imm_closes_before_after == 'before' %>>before</option>
                  </select>
                  <span class="text-sm text-gray-600">event start</span>
                </div>
              </div>

              <%# Option 3: Don't close automatically %>
              <div class="p-3 rounded-lg border-2 cursor-pointer transition-colors
                          <%= closes_mode == 'never' ? 'border-pink-500 bg-pink-50' : 'border-gray-200 hover:border-gray-300' %>"
                   data-action="click->closes-mode#selectNever">
                <label class="flex items-center cursor-pointer">
                  <input type="radio" name="closes_mode" value="never"
                         <%= "checked" if closes_mode == 'never' %>
                         class="sr-only"
                         data-closes-mode-target="neverRadio">
                  <span class="text-sm font-medium text-gray-900">Don't close automatically</span>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Relative Schedule Options -->
        <div data-option-select-target="conditionalRelative" class="<%= schedule_mode == 'relative' ? '' : 'hidden' %> space-y-4">
          <%# Open Registration Box - x days, y hours, z minutes before (default: 7 days, 0 hours, 0 minutes) %>
          <%
            opens_days = @wizard_state[:opens_days_before] || 7
            opens_hours = @wizard_state[:opens_hours_before] || 0
            opens_mins = @wizard_state[:opens_minutes_before] || 0
          %>
          <div class="p-4 bg-gray-50 rounded-lg">
            <label class="block text-gray-700 font-medium mb-2">Open registration</label>
            <div class="flex flex-wrap items-center gap-2">
              <input type="number" name="opens_days_before" value="<%= opens_days %>" min="0"
                     class="w-16 shadow-sm rounded-lg border border-gray-400 px-2 py-1.5 text-sm">
              <span class="text-sm text-gray-600">days</span>
              <input type="number" name="opens_hours_before" value="<%= opens_hours %>" min="0" max="23"
                     class="w-16 shadow-sm rounded-lg border border-gray-400 px-2 py-1.5 text-sm">
              <span class="text-sm text-gray-600">hours</span>
              <input type="number" name="opens_minutes_before" value="<%= opens_mins %>" min="0" max="59"
                     class="w-16 shadow-sm rounded-lg border border-gray-400 px-2 py-1.5 text-sm">
              <span class="text-sm text-gray-600">minutes before each event</span>
            </div>
          </div>

          <%# Close Registration Box %>
          <div class="p-4 bg-gray-50 rounded-lg" data-controller="closes-mode">
            <label class="block text-gray-700 font-medium mb-3">Close registration</label>
            <div class="space-y-2">
              <%# Option 1: Close when event starts (default) %>
              <div class="p-3 rounded-lg border-2 cursor-pointer transition-colors
                          <%= closes_mode == 'event_start' ? 'border-pink-500 bg-pink-50' : 'border-gray-200 hover:border-gray-300' %>"
                   data-action="click->closes-mode#selectEventStart">
                <label class="flex items-center cursor-pointer">
                  <input type="radio" name="closes_mode" value="event_start"
                         <%= "checked" if closes_mode == 'event_start' %>
                         class="sr-only"
                         data-closes-mode-target="eventStartRadio">
                  <span class="text-sm font-medium text-gray-900">Close when event starts</span>
                </label>
              </div>

              <%# Option 2: Close relative to event (default: 0 days, 2 hours, 0 minutes after) %>
              <%
                closes_days = @wizard_state[:closes_offset_days] || 0
                closes_hours = @wizard_state[:closes_offset_hours] || 2
                closes_mins = @wizard_state[:closes_minutes_offset] || 0
                closes_before_after = @wizard_state[:closes_before_after] || 'after'
              %>
              <div class="p-3 rounded-lg border-2 cursor-pointer transition-colors
                          <%= closes_mode == 'custom' ? 'border-pink-500 bg-pink-50' : 'border-gray-200 hover:border-gray-300' %>"
                   data-action="click->closes-mode#selectCustom">
                <label class="flex items-center cursor-pointer">
                  <input type="radio" name="closes_mode" value="custom"
                         <%= "checked" if closes_mode == 'custom' %>
                         class="sr-only"
                         data-closes-mode-target="customRadio">
                  <span class="text-sm font-medium text-gray-900">Close registration</span>
                </label>
                <div class="flex flex-wrap items-center gap-2 mt-2" data-closes-mode-target="customFields" onclick="event.stopPropagation()">
                  <input type="number" name="closes_offset_days" value="<%= closes_days %>" min="0"
                         class="w-16 shadow-sm rounded-lg border border-gray-400 px-2 py-1.5 text-sm">
                  <span class="text-sm text-gray-600">days</span>
                  <input type="number" name="closes_offset_hours" value="<%= closes_hours %>" min="0" max="23"
                         class="w-16 shadow-sm rounded-lg border border-gray-400 px-2 py-1.5 text-sm">
                  <span class="text-sm text-gray-600">hours</span>
                  <input type="number" name="closes_minutes_offset" value="<%= closes_mins %>" min="0" max="59"
                         class="w-16 shadow-sm rounded-lg border border-gray-400 px-2 py-1.5 text-sm">
                  <span class="text-sm text-gray-600">minutes</span>
                  <select name="closes_before_after" class="shadow-sm rounded-lg border border-gray-400 px-2 py-1.5 text-sm">
                    <option value="after" <%= "selected" if closes_before_after == 'after' %>>after</option>
                    <option value="before" <%= "selected" if closes_before_after == 'before' %>>before</option>
                  </select>
                  <span class="text-sm text-gray-600">event start</span>
                </div>
              </div>

              <%# Option 3: Don't close automatically %>
              <div class="p-3 rounded-lg border-2 cursor-pointer transition-colors
                          <%= closes_mode == 'never' ? 'border-pink-500 bg-pink-50' : 'border-gray-200 hover:border-gray-300' %>"
                   data-action="click->closes-mode#selectNever">
                <label class="flex items-center cursor-pointer">
                  <input type="radio" name="closes_mode" value="never"
                         <%= "checked" if closes_mode == 'never' %>
                         class="sr-only"
                         data-closes-mode-target="neverRadio">
                  <span class="text-sm font-medium text-gray-900">Don't close automatically</span>
                </label>
              </div>
            </div>
          </div>

          <div class="p-4 bg-blue-50 rounded-lg border border-blue-100">
            <div class="flex">
              <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a.75.75 0 000 1.5h.253a.25.25 0 01.244.304l-.459 2.066A1.75 1.75 0 0010.747 15H11a.75.75 0 000-1.5h-.253a.25.25 0 01-.244-.304l.459-2.066A1.75 1.75 0 009.253 9H9z" clip-rule="evenodd" />
                </svg>
              </div>
              <div class="ml-3">
                <p class="text-sm text-blue-800">
                  <strong>Example:</strong> For an event on Saturday at 8 PM, sign-ups would open
                  <%= @wizard_state[:opens_days_before] || 7 %> days before showtime.
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Fixed Schedule Options -->
        <div data-option-select-target="conditionalFixed" class="<%= schedule_mode == 'fixed' ? '' : 'hidden' %> space-y-4">
          <%# Opens At Box %>
          <div class="p-4 bg-gray-50 rounded-lg">
            <label class="block text-gray-700 font-medium mb-2">Opens at</label>
            <input type="datetime-local" name="opens_at"
                   value="<%= @wizard_state[:opens_at].is_a?(String) ? @wizard_state[:opens_at] : @wizard_state[:opens_at]&.strftime('%Y-%m-%dT%H:%M') %>"
                   class="block shadow-sm rounded-lg border border-gray-400 px-3 py-2 w-full sm:w-2/3">
          </div>

          <%# Closes At Box with Toggle %>
          <% has_close_date = @wizard_state[:closes_at].present? %>
          <div class="p-4 bg-gray-50 rounded-lg" data-controller="toggle-section">
            <div class="flex items-center justify-between">
              <div>
                <label class="block text-gray-700 font-medium">Set a close date</label>
                <p class="text-sm text-gray-500 mt-1">When disabled, sign-ups stay open until you close them manually</p>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox"
                       data-toggle-section-target="toggle"
                       data-action="toggle-section#toggle"
                       class="sr-only peer"
                       <%= 'checked' if has_close_date %>>
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
              </label>
            </div>
            <div data-toggle-section-target="content" class="<%= has_close_date ? '' : 'hidden' %> mt-4">
              <label class="block text-gray-700 text-sm font-medium mb-2">Closes at</label>
              <input type="datetime-local" name="closes_at"
                     value="<%= @wizard_state[:closes_at].is_a?(String) ? @wizard_state[:closes_at] : @wizard_state[:closes_at]&.strftime('%Y-%m-%dT%H:%M') %>"
                     class="block shadow-sm rounded-lg border border-gray-400 px-3 py-2 w-full sm:w-2/3"
                     data-toggle-section-target="requiredField">
            </div>
          </div>
        </div>
      <% end %>

      <%# Pre-registration Section - Allow producers/talent to sign up before form officially opens %>
      <% unless is_waitlist %>
        <%
          pre_reg_mode = @wizard_state[:pre_registration_mode] || 'producers_only'
          pre_reg_window_value = @wizard_state[:pre_registration_window_value] || 45
          pre_reg_window_unit = @wizard_state[:pre_registration_window_unit] || 'days'
        %>
        <div class="mt-6 p-4 bg-gray-50 rounded-lg border border-gray-200" data-controller="pre-registration">
          <div class="mb-3">
            <label class="block text-gray-700 font-medium">Pre-registration</label>
            <p class="text-sm text-gray-500 mt-0.5">Allow sign-ups before the form officially opens to the public.</p>
          </div>
          <div class="space-y-2">
            <%# Option 1: Disabled %>
            <label class="flex items-center p-3 rounded-lg border-2 cursor-pointer transition-colors <%= pre_reg_mode == 'disabled' ? 'border-pink-500 bg-pink-50' : 'border-gray-200 hover:border-gray-300 bg-white' %>"
                   data-action="click->pre-registration#selectMode"
                   data-pre-registration-mode="disabled">
              <input type="radio" name="pre_registration_mode" value="disabled"
                     <%= "checked" if pre_reg_mode == 'disabled' %>
                     class="sr-only"
                     data-pre-registration-target="modeInput">
              <div>
                <span class="text-sm font-medium text-gray-900">Disabled</span>
                <p class="text-xs text-gray-500 mt-0.5">No pre-registration allowed</p>
              </div>
            </label>

            <%# Option 2: Producers only (default) %>
            <label class="flex items-center p-3 rounded-lg border-2 cursor-pointer transition-colors <%= pre_reg_mode == 'producers_only' ? 'border-pink-500 bg-pink-50' : 'border-gray-200 hover:border-gray-300 bg-white' %>"
                   data-action="click->pre-registration#selectMode"
                   data-pre-registration-mode="producers_only">
              <input type="radio" name="pre_registration_mode" value="producers_only"
                     <%= "checked" if pre_reg_mode == 'producers_only' %>
                     class="sr-only"
                     data-pre-registration-target="modeInput">
              <div>
                <span class="text-sm font-medium text-gray-900">Managers only</span>
                <p class="text-xs text-gray-500 mt-0.5">Only managers can pre-register talent pool members</p>
              </div>
            </label>

            <%# Option 3: Producers and talent pool members %>
            <label class="flex items-center p-3 rounded-lg border-2 cursor-pointer transition-colors <%= pre_reg_mode == 'producers_and_talent' ? 'border-pink-500 bg-pink-50' : 'border-gray-200 hover:border-gray-300 bg-white' %>"
                   data-action="click->pre-registration#selectMode"
                   data-pre-registration-mode="producers_and_talent">
              <input type="radio" name="pre_registration_mode" value="producers_and_talent"
                     <%= "checked" if pre_reg_mode == 'producers_and_talent' %>
                     class="sr-only"
                     data-pre-registration-target="modeInput">
              <div>
                <span class="text-sm font-medium text-gray-900">Managers and talent pool members</span>
                <p class="text-xs text-gray-500 mt-0.5">Managers can pre-register talent pool members and talent pool members can pre-register themselves</p>
              </div>
            </label>
          </div>

          <%# Pre-registration window (shown when not disabled) %>
          <div data-pre-registration-target="windowFields" class="<%= pre_reg_mode == 'disabled' ? 'hidden' : '' %> mt-4 pt-4 border-t border-gray-200">
            <label class="block text-gray-700 text-sm font-medium mb-2">Pre-registration window</label>
            <p class="text-xs text-gray-500 mb-3">How far in advance of each event can pre-registration happen?</p>
            <div class="flex items-center gap-2">
              <input type="number" name="pre_registration_window_value" value="<%= pre_reg_window_value %>" min="1"
                     class="w-20 shadow-sm rounded-lg border border-gray-400 px-2 py-1.5 text-sm">
              <select name="pre_registration_window_unit" class="shadow-sm rounded-lg border border-gray-400 px-2 py-1.5 text-sm">
                <option value="hours" <%= "selected" if pre_reg_window_unit == 'hours' %>>hours</option>
                <option value="days" <%= "selected" if pre_reg_window_unit == 'days' %>>days</option>
                <option value="months" <%= "selected" if pre_reg_window_unit == 'months' %>>months</option>
              </select>
              <span class="text-sm text-gray-600">before event</span>
            </div>
          </div>
        </div>
      <% end %>

      <%# Hide Registration Names Section - shown when show_registrations is enabled %>
      <% if @wizard_state[:show_registrations] %>
        <% hide_mode = @wizard_state[:hide_registrations_mode] || 'event_start' %>
        <div class="mt-6 p-4 bg-gray-50 rounded-lg border border-gray-200" data-controller="hide-registrations">
          <div class="mb-3">
            <label class="block text-gray-700 font-medium">Hide registration names</label>
            <p class="text-sm text-gray-500 mt-0.5">Since "Show registered names" is enabled, choose when to stop showing them.</p>
          </div>
          <div class="space-y-2">
            <%# Option 1: When event starts (default) %>
            <label class="flex items-center p-3 rounded-lg border-2 cursor-pointer transition-colors <%= hide_mode == 'event_start' ? 'border-pink-500 bg-pink-50' : 'border-gray-200 hover:border-gray-300 bg-white' %>">
              <input type="radio" name="hide_registrations_mode" value="event_start"
                     <%= "checked" if hide_mode == 'event_start' %>
                     class="sr-only"
                     data-action="change->hide-registrations#updateStyles">
              <span class="text-sm font-medium text-gray-900">When event starts</span>
            </label>

            <%# Option 2: At midnight after the event %>
            <label class="flex items-center p-3 rounded-lg border-2 cursor-pointer transition-colors <%= hide_mode == 'midnight_after' ? 'border-pink-500 bg-pink-50' : 'border-gray-200 hover:border-gray-300 bg-white' %>">
              <input type="radio" name="hide_registrations_mode" value="midnight_after"
                     <%= "checked" if hide_mode == 'midnight_after' %>
                     class="sr-only"
                     data-action="change->hide-registrations#updateStyles">
              <span class="text-sm font-medium text-gray-900">At midnight after the event</span>
            </label>
          </div>
        </div>
      <% end %>
    </div>

    <div class="mt-8 flex justify-between">
      <%= link_to manage_signups_forms_wizard_rules_path(@production), class: "inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-900" do %>
        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Back
      <% end %>
      <%= render "shared/button", text: "Next", variant: "primary", size: "medium", type: :submit %>
    </div>
  <% end %>
<% end %>
