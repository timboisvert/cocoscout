<% content_for :title, "Casting - Auditions" %>

<div class="w-full mb-10">
  <%= render partial: "shared/notice", locals: { notice: notice } %>
  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [
      ["Auditions", manage_production_auditions_path(@production)]
    ],
    text: "Casting",
    links: []
  } %>

  <%= render partial: "lifecycle_panel", locals: { current_step: :communicate } %>

  <% if @production.call_to_audition.blank? %>
    <div class="mb-5 text-gray-500 text-sm">
      You aren't currently offering auditions for <%= @production.name %>
    </div>
  <% else %>
    <% call_to_audition = @production.call_to_audition %>

    <!-- Casting Changes Summary -->
    <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden mb-6">
      <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
        <h3 class="text-md font-semibold text-gray-900 coustard-regular">Casting Changes</h3>
      </div>
      <div class="p-6">
        <p class="text-sm text-gray-500 mb-4">Review the casting decisions below. Click "Select Cast Members" button to make changes.</p>

        <% has_any_changes = @cast_assignment_stages.any? %>
        <% if has_any_changes %>
          <div class="space-y-4 mb-6">
            <!-- People being added to casts -->
            <% @casts.each do |cast| %>
              <% cast_stages = @cast_assignment_stages.select { |stage| stage.cast_id == cast.id } %>
              <% if cast_stages.any? %>
                <div class="border-l-4 border-pink-500 pl-4">
                  <h4 class="text-sm font-semibold text-gray-900 mb-2">Add to <%= cast.name %></h4>
                  <div class="flex flex-wrap gap-2">
                    <% cast_stages.each do |stage| %>
                      <%= link_to manage_person_path(stage.person), class: "inline-flex items-center gap-2 px-2 py-1 rounded text-xs font-medium border border-gray-200 hover:border-gray-400 hover:bg-gray-50 transition-all" do %>
                        <% headshot_variant = stage.person.safe_headshot_variant(:thumb) %>
                        <% if headshot_variant %>
                          <%= image_tag headshot_variant, alt: stage.person.name, class: "w-5 h-5 rounded object-cover flex-shrink-0", draggable: false %>
                        <% else %>
                          <div class="w-5 h-5 rounded bg-gray-200 flex items-center justify-center text-black font-bold text-xs flex-shrink-0">
                            <%= stage.person.initials %>
                          </div>
                        <% end %>
                        <%= stage.person.name %>
                      <% end %>
                    <% end %>
                  </div>
                </div>
              <% end %>
            <% end %>
          </div>
        <% else %>
          <p class="text-gray-500 text-sm mb-6">No casting decisions have been made yet.</p>
        <% end %>

        <%= render partial: "shared/link_button", locals: { text: "Select Cast Members", path: manage_production_auditions_casting_select_path(@production) } %>
      </div>
    </div>

    <!-- Finalize and Notify -->
    <% staged_casts = @casts.select { |cast| @cast_assignment_stages.any? { |stage| stage.cast_id == cast.id } } %>
    <% # Calculate unassigned people - those who auditioned but aren't in any cast %>
    <% assigned_person_ids = @cast_assignment_stages.pluck(:person_id).uniq %>
    <% unassigned_people = @auditioned_people.reject { |person| assigned_person_ids.include?(person.id) } %>
    <% if staged_casts.any? || unassigned_people.any? %>
      <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden my-6">
        <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
          <h3 class="text-md font-semibold text-gray-900 coustard-regular">Finalize and Notify</h3>
        </div>
        <div class="p-6">
          <div data-controller="tabs">
            <nav class="flex flex-wrap gap-2 border-b border-gray-200 mb-4">
              <% staged_casts.each_with_index do |cast, index| %>
                <button
                  type="button"
                  data-tabs-target="tab"
                  data-index="<%= index %>"
                  data-action="tabs#select"
                  class="px-3 lg:px-4 py-2 text-xs lg:text-sm font-medium bg-white border-b-2 <%= index == 0 ? 'text-pink-600 border-pink-600' : 'text-gray-500 bg-gray-50 border-transparent' %> cursor-pointer whitespace-nowrap hover:text-pink-600"
                >
                  <%= cast.name %>
                </button>
              <% end %>
              <% if unassigned_people.any? %>
                <button
                  type="button"
                  data-tabs-target="tab"
                  data-index="<%= staged_casts.length %>"
                  data-action="tabs#select"
                  class="px-3 lg:px-4 py-2 text-xs lg:text-sm font-medium bg-white border-b-2 <%= staged_casts.empty? ? 'text-pink-600 border-pink-600' : 'text-gray-500 bg-gray-50 border-transparent' %> cursor-pointer whitespace-nowrap hover:text-pink-600"
                >
                  Not Being Added
                </button>
              <% end %>
            </nav>

            <div class="space-y-4">
              <% staged_casts.each_with_index do |cast, index| %>
                <div data-tabs-target="panel" class="<%= 'hidden' if index > 0 %>">
                  <div class="mb-4">
                    <h4 class="text-sm font-semibold text-gray-900 mb-3">People to be added to <%= cast.name %>:</h4>
                    <div class="flex flex-wrap gap-2">
                      <% @cast_assignment_stages.select { |stage| stage.cast_id == cast.id }.each do |stage| %>
                        <%= link_to manage_person_path(stage.person), class: "inline-flex items-center gap-2 px-2 py-1 rounded text-xs font-medium border border-gray-200 hover:border-gray-400 hover:bg-gray-50 transition-all" do %>
                          <% headshot_variant = stage.person.safe_headshot_variant(:thumb) %>
                          <% if headshot_variant %>
                            <%= image_tag headshot_variant, alt: stage.person.name, class: "w-5 h-5 rounded object-cover flex-shrink-0", draggable: false %>
                          <% else %>
                            <div class="w-5 h-5 rounded bg-gray-200 flex items-center justify-center text-black font-bold text-xs flex-shrink-0">
                              <%= stage.person.initials %>
                            </div>
                          <% end %>
                          <%= stage.person.name %>
                        <% end %>
                      <% end %>
                    </div>
                  </div>

                  <div>
                    <label class="block text-sm font-semibold text-gray-900 mb-2">Notification Email for <%= cast.name %></label>
                    <textarea
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500"
                      rows="6"
                    >Dear [Name],

Congratulations! We're excited to invite you to join the <%= cast.name %> for <%= @production.name %>.

Your audition impressed us, and we believe you'll be a great addition to the team. We look forward to working with you.

Please confirm your acceptance by [date].

Best regards,
The <%= @production.name %> Team</textarea>
                  </div>
                </div>
              <% end %>

              <% if unassigned_people.any? %>
                <div data-tabs-target="panel" class="<%= 'hidden' unless staged_casts.empty? %>">
                  <div class="mb-4">
                    <h4 class="text-sm font-semibold text-gray-900 mb-3">People not being added to the cast:</h4>
                    <div class="flex flex-wrap gap-2">
                      <% unassigned_people.each do |person| %>
                        <%= link_to manage_person_path(person), class: "inline-flex items-center gap-2 px-2 py-1 rounded text-xs font-medium border border-gray-200 hover:border-gray-400 hover:bg-gray-50 transition-all" do %>
                          <% headshot_variant = person.safe_headshot_variant(:thumb) %>
                          <% if headshot_variant %>
                            <%= image_tag headshot_variant, alt: person.name, class: "w-5 h-5 rounded object-cover flex-shrink-0", draggable: false %>
                          <% else %>
                            <div class="w-5 h-5 rounded bg-gray-200 flex items-center justify-center text-black font-bold text-xs flex-shrink-0">
                              <%= person.initials %>
                            </div>
                          <% end %>
                          <%= person.name %>
                        <% end %>
                      <% end %>
                    </div>
                  </div>

                  <div>
                    <label class="block text-sm font-semibold text-gray-900 mb-2">Notification Email</label>
                    <textarea
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500"
                      rows="6"
                    >Dear [Name],

Thank you so much for auditioning for <%= @production.name %>. We truly appreciate the time and effort you put into your audition.

Unfortunately, we won't be able to offer you a role in this production at this time. We were impressed by your talent and encourage you to audition for future productions.

We hope to work with you in the future.

Best regards,
The <%= @production.name %> Team</textarea>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    <% else %>
      <div class="bg-gray-50 border border-gray-200 rounded-lg shadow-sm p-6 mb-6">
        <p class="text-gray-600 text-sm text-center">Select auditionees for casts above to continue to notification stage</p>
      </div>
    <% end %>

  <% end %>
</div>
