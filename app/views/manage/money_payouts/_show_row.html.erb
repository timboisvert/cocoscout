<%#
  Payouts Show Row - Two Panel Layout for Revenue Events

  Required:
    - show: Show object
    - production: Production object

  Panels:
    1. Date/Time box + Show info
    2. Advances panel (if any)
    3. Payouts panel
    4. Status panel
%>

<%
  payout = show.show_payout
  financials = show.show_financials
  has_data = financials&.has_data?
  is_canceled = show.canceled?

  # Determine payout status
  if payout&.paid?
    payout_status = :paid
    status_label = "Paid"
    status_class = "text-green-600"
  elsif payout&.calculated_at.present?
    payout_status = :awaiting_payout
    status_label = "Awaiting Payout"
    status_class = "text-pink-600"
  elsif has_data
    payout_status = :ready
    status_label = "Ready to Calculate"
    status_class = "text-amber-600"
  else
    payout_status = :needs_data
    status_label = "Needs Financial Data"
    status_class = "text-gray-500"
  end

  total_payout = payout&.total_payout || 0
  line_items_count = payout&.line_items&.count || 0
  paid_count = payout&.line_items&.already_paid&.count || 0

  # Load advances for this show
  show_advances = production.person_advances.for_show(show).outstanding
  unpaid_advances = show_advances.unpaid
  outstanding_advances = show_advances.paid
  unpaid_amount = unpaid_advances.sum(:original_amount)
  outstanding_amount = outstanding_advances.sum(:remaining_balance)
  has_advances = unpaid_advances.any? || outstanding_advances.any?
%>

<div class="bg-white rounded-lg border border-gray-200 hover:border-gray-300 transition-all <%= 'opacity-60' if is_canceled %>"
     data-money-filter-target="showRow">

  <%= link_to manage_money_show_payout_path(show), class: "block" do %>
    <div class="flex flex-col lg:flex-row lg:items-stretch">

      <%# Panel 1: Date + Show Info %>
      <div class="flex-1 flex items-center gap-4 px-4 py-3 rounded-t-lg lg:rounded-l-lg lg:rounded-tr-none">
        <%# Date Box %>
        <div class="flex-shrink-0 w-14 text-center <%= 'line-through' if is_canceled %>">
          <div class="text-xs font-semibold text-pink-600 uppercase"><%= show.date_and_time.strftime("%b") %></div>
          <div class="text-2xl font-bold text-gray-900"><%= show.date_and_time.strftime("%-d") %></div>
          <div class="text-xs text-gray-500"><%= show.date_and_time.strftime("%a") %></div>
        </div>

        <%# Show Details %>
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-2 flex-wrap">
            <span class="font-medium text-gray-900 <%= 'line-through' if is_canceled %>">
              <%= show.display_name %>
            </span>
            <% if is_canceled %>
              <span class="inline-flex items-center rounded-md bg-red-50 px-2 py-0.5 text-xs font-medium text-red-700 ring-1 ring-inset ring-red-600/10">Canceled</span>
            <% end %>
          </div>
          <div class="text-sm text-gray-600 <%= 'line-through' if is_canceled %>">
            <%= show.time_range_display %>
            <% if show.location.present? %>
              &middot; <%= show.location.name %>
            <% elsif show.is_online %>
              &middot; Online
            <% end %>
          </div>
        </div>
      </div>

      <%# Panel 2: Payouts (with Advances if any) %>
      <div class="w-full lg:w-1/4 px-4 py-3 border-t lg:border-t-0 lg:border-l border-gray-200 flex flex-col justify-center">
        <% if has_advances %>
          <div class="text-[10px] text-gray-400 uppercase tracking-wide mb-0.5">Advances</div>
          <div class="text-xs space-y-0.5 mb-2">
            <% if unpaid_advances.any? %>
              <div class="text-pink-600 font-medium"><%= number_to_currency(unpaid_amount) %> Unpaid</div>
            <% end %>
            <% if outstanding_advances.any? %>
              <div class="text-amber-600 font-medium"><%= number_to_currency(outstanding_amount) %> Paid</div>
            <% end %>
          </div>
        <% end %>
        <div class="text-[10px] text-gray-400 uppercase tracking-wide mb-0.5">Payouts</div>
        <% if payout&.calculated_at.present? %>
          <div class="text-sm font-medium text-gray-900"><%= number_to_currency(total_payout) %></div>
          <div class="text-xs text-gray-500"><%= paid_count %>/<%= line_items_count %> paid</div>
        <% else %>
          <div class="text-sm text-gray-400">Not calculated</div>
        <% end %>
      </div>

      <%# Panel 3: Status %>
      <div class="w-full lg:w-1/4 px-4 py-3 border-t lg:border-t-0 lg:border-l border-gray-200 rounded-b-lg lg:rounded-r-lg lg:rounded-bl-none flex flex-col justify-center">
        <div class="text-[10px] text-gray-400 uppercase tracking-wide mb-1 flex items-center gap-1">
          Status
          <% if payout_status == :paid %>
            <svg class="w-3.5 h-3.5 text-green-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd"/>
            </svg>
          <% end %>
        </div>
        <div class="text-sm font-medium <%= status_class %>"><%= status_label %></div>
      </div>

    </div>
  <% end %>
</div>
