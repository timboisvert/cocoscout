<%
  # Profile headshots form section
  # Parameters:
  # - person_form: the form builder
%>

<div class="bg-white border border-gray-200 rounded-lg overflow-hidden mb-6" data-controller="profile-section">
  <%= render "shared/section_header",
    title: "Headshots",
    collapsible: true %>

  <div class="p-6 space-y-4" data-profile-section-target="content">
    <p class="text-sm text-gray-600 mb-4">
      Upload up to 10 professional headshots. Mark one as your primary headshot to display on your profile.
    </p>

    <div id="headshots-container" class="space-y-4">
      <%= person_form.fields_for :profile_headshots do |headshot_form| %>
        <div class="border border-gray-200 rounded-lg p-4 headshot-item">
          <%= headshot_form.hidden_field :id %>
          <%= headshot_form.hidden_field :position %>
          <%= headshot_form.hidden_field :_destroy, value: "0", class: "destroy-field" %>

          <div class="flex flex-col sm:flex-row gap-4">
            <!-- Image preview -->
            <div class="flex-shrink-0">
              <% if headshot_form.object.image.attached? %>
                <%= image_tag headshot_form.object.image.variant(resize_to_limit: [200, 200]),
                    class: "w-32 h-32 object-cover rounded border border-gray-300" %>
              <% else %>
                <div class="w-32 h-32 bg-gray-100 rounded border border-gray-300 flex items-center justify-center">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12 text-gray-400">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm10.5-11.25h.008v.008h-.008V8.25Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
                  </svg>
                </div>
              <% end %>
            </div>

            <!-- Form fields -->
            <div class="flex-1 space-y-3">
              <div>
                <%= headshot_form.label :image, "Image File", class: "block text-sm font-medium text-gray-700" %>
                <%= headshot_form.file_field :image,
                    accept: "image/*",
                    class: "mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:text-white file:bg-pink-500 hover:file:bg-pink-600" %>
              </div>

              <div>
                <%= headshot_form.label :category, "Category", class: "block text-sm font-medium text-gray-700" %>
                <%= headshot_form.select :category,
                    ProfileHeadshot::CATEGORIES.map { |c| [c.titleize, c] },
                    { include_blank: "Select category" },
                    class: "mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-pink-500 focus:ring-pink-500" %>
              </div>

              <div class="flex items-center gap-2">
                <%= headshot_form.check_box :is_primary,
                    class: "rounded border-gray-300 text-pink-600 focus:ring-pink-500" %>
                <%= headshot_form.label :is_primary, "Set as primary headshot", class: "text-sm text-gray-700" %>
              </div>
            </div>

            <!-- Remove button -->
            <div class="flex-shrink-0">
              <button type="button"
                      class="text-red-600 hover:text-red-800 text-sm"
                      onclick="this.closest('.headshot-item').querySelector('.destroy-field').value = '1'; this.closest('.headshot-item').style.display = 'none';">
                Remove
              </button>
            </div>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Add new headshot button -->
    <button type="button"
            id="add-headshot"
            class="inline-flex items-center gap-2 px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition-colors">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
      </svg>
      Add Headshot
    </button>

    <!-- Template for new headshots -->
    <template id="headshot-template">
      <div class="border border-gray-200 rounded-lg p-4 headshot-item">
        <input type="hidden" name="person[profile_headshots_attributes][NEW_RECORD][position]" value="">
        <input type="hidden" name="person[profile_headshots_attributes][NEW_RECORD][_destroy]" value="0" class="destroy-field">

        <div class="flex flex-col sm:flex-row gap-4">
          <div class="flex-shrink-0">
            <div class="w-32 h-32 bg-gray-100 rounded border border-gray-300 flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12 text-gray-400">
                <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm10.5-11.25h.008v.008h-.008V8.25Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
              </svg>
            </div>
          </div>

          <div class="flex-1 space-y-3">
            <div>
              <label class="block text-sm font-medium text-gray-700">Image File</label>
              <input type="file"
                     name="person[profile_headshots_attributes][NEW_RECORD][image]"
                     accept="image/*"
                     class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:text-white file:bg-pink-500 hover:file:bg-pink-600">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700">Category</label>
              <select name="person[profile_headshots_attributes][NEW_RECORD][category]"
                      class="mt-1 block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-pink-500 focus:ring-pink-500">
                <option value="">Select category</option>
                <% ProfileHeadshot::CATEGORIES.each do |category| %>
                  <option value="<%= category %>"><%= category.titleize %></option>
                <% end %>
              </select>
            </div>

            <div class="flex items-center gap-2">
              <input type="checkbox"
                     name="person[profile_headshots_attributes][NEW_RECORD][is_primary]"
                     value="1"
                     class="rounded border-gray-300 text-pink-600 focus:ring-pink-500">
              <label class="text-sm text-gray-700">Set as primary headshot</label>
            </div>
          </div>

          <div class="flex-shrink-0">
            <button type="button"
                    class="text-red-600 hover:text-red-800 text-sm"
                    onclick="this.closest('.headshot-item').querySelector('.destroy-field').value = '1'; this.closest('.headshot-item').style.display = 'none';">
              Remove
            </button>
          </div>
        </div>
      </div>
    </template>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        let headshotCounter = <%= @person.profile_headshots.size %>;

        document.getElementById('add-headshot')?.addEventListener('click', function() {
          const template = document.getElementById('headshot-template');
          const container = document.getElementById('headshots-container');

          if (template && container) {
            const clone = template.content.cloneNode(true);
            const html = clone.querySelector('.headshot-item').outerHTML;
            const newHtml = html.replace(/NEW_RECORD/g, new Date().getTime());

            container.insertAdjacentHTML('beforeend', newHtml);
            headshotCounter++;
          }
        });
      });
    </script>
  </div>
</div>
