<% content_for :title, "#{@show.event_type.titleize} Details" %>

<div class="w-full">
  <%= render partial: "shared/notice", locals: { notice: notice } %>
  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [
      { text: "Shows & Events", path: manage_production_shows_path(@production) }
    ],
    text: "#{@show.date_and_time.strftime("%A, %B %-d, %Y")} at #{@show.date_and_time.strftime("%l:%M %p")}",
    links: []
  } %>

  <div class="mb-4">
    <div class="flex items-center gap-2 flex-wrap">
      <% if @show.canceled %>
        <span class="inline-flex items-center rounded-md bg-red-50 px-2 py-1 text-xs font-medium text-red-700 ring-1 ring-inset ring-red-600/10 w-fit">Canceled</span>
      <% elsif @show.recurring? %>
        <span data-controller="tooltip" data-tooltip-text="This is a recurring event">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="text-pink-500 size-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
          </svg>
        </span>
      <% end %>

      <% event_type_badge_classes = case @show.event_type
        when "rehearsal" then "bg-blue-50 text-blue-700 ring-blue-600/10"
        when "meeting" then "bg-green-50 text-green-700 ring-green-600/10"
        else "bg-pink-50 text-pink-700 ring-pink-600/10"
      end %>
      <span class="inline-flex items-center rounded-md px-1.5 py-0.5 text-xs font-medium ring-1 ring-inset <%= event_type_badge_classes %>">
        <%= @show.event_type.titleize %>
      </span>

      <% if @show.secondary_name.present? %>
        <span class="text-xs text-gray-900 font-medium"><%= @show.secondary_name %></span>
      <% end %>

      <% if @show.location.present? %>
        <span class="inline-flex items-center gap-1 rounded-md px-1.5 py-0.5 text-xs font-medium ring-1 ring-inset bg-gray-50 text-gray-700 ring-gray-600/10">
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" /></svg>
          <%= @show.location.name %>
        </span>
      <% end %>
    </div>
  </div>

  <div class="flex flex-col sm:flex-row gap-6">

    <% unless @show.canceled %>
      <% poster_url = safe_poster_url(@show) %>
      <% if poster_url %>
        <div class="flex-shrink-0">
          <%= image_tag poster_url, alt: "Show Poster", class: "rounded shadow w-36 border border-gray-200" %>
        </div>
      <% end %>
    <% end %>

    <div class="flex-1 space-y-4">

      <% if current_user_can_manage?(@show.production) %>
        <div class="border border-gray-200 rounded-lg overflow-hidden">
          <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 flex items-center justify-between">
            <h3 class="text-md font-semibold text-gray-900 coustard-regular">Manage <%= @show.event_type.titleize %></h3>
          </div>
          <div class="p-4">
            <%
              event_label = @show.event_type.titleize
              edit_label = "Edit #{event_label}"
              cancel_label = "Cancel #{event_label}"
              delete_label = "Delete #{event_label}"
              uncancel_label = "Uncancel #{event_label}"
              is_past = @show.date_and_time <= Time.current
            %>
            <% if is_past %>
              <%= link_to "Duplicate", new_manage_production_show_path(@production, duplicate: @show.id), class: "text-xs text-pink-500 underline" %>
              <%= link_to delete_label, cancel_manage_production_show_path(@production, @show), class: "ml-1 text-xs text-pink-500 underline" %>
            <% elsif @show.canceled %>
              <%= link_to uncancel_label, uncancel_manage_production_show_path(@production, @show), data: {turbo_method: :patch, turbo_confirm: "Are you sure you want to uncancel this #{event_label.downcase}?"}, class: "text-xs text-pink-500 underline" %>
              <%= link_to delete_label, cancel_manage_production_show_path(@production, @show), class: "ml-1 text-xs text-pink-500 underline" %>
            <% else %>
              <%= link_to edit_label, edit_manage_production_show_path(@production, @show), class: "text-xs text-pink-500 underline" %>
              <%= link_to cancel_label, cancel_manage_production_show_path(@production, @show), class: "ml-1 text-xs text-pink-500 underline" %>
            <% end %>
          </div>
        </div>
      <% end %>

      <% if @show.event_type == "show" %>
        <div class="border border-gray-200 rounded-lg overflow-hidden">
          <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 flex items-center justify-between">
            <h3 class="text-md font-semibold text-gray-900 coustard-regular">Cast</h3>
              <% if current_user_can_manage?(@show.production) && @show.date_and_time >= Time.current %>
              <%= link_to "Edit Cast", cast_manage_production_show_path(@production, @show), class: "text-xs text-pink-500 underline" %>
            <% end %>
          </div>
          <div class="p-1 py-2 sm:p-4 sm:py-4">
            <div class="flex flex-wrap gap-2">
              <% # Get all roles in order and display them with their cast status %>
              <% @show.production.roles.each do |role| %>
                <% assignment = @show.show_person_role_assignments.find_by(role: role) %>
                <% if assignment %>
                  <% # Show cast member %>
                  <%= link_to [:manage, assignment.person] do %>
                    <div class="flex flex-col items-center w-[100px] transition-all"
                      data-controller="tooltip"
                      data-tooltip-text="<%= assignment.person.name.truncate(40, omission: '...') %> - <%= assignment.role.name %>">
                      <% headshot_variant = assignment.person.safe_headshot_variant(:thumb) %>
                      <% if headshot_variant %>
                        <%= image_tag headshot_variant, alt: assignment.person.name, class: "w-20 h-20 rounded-lg object-cover border border-gray-200", draggable: false %>
                      <% else %>
                        <div class="w-20 h-20 rounded-lg bg-gray-100 flex items-center justify-center text-gray-600 font-bold text-lg border border-gray-200">
                          <%= assignment.person.initials %>
                        </div>
                      <% end %>
                      <div class="text-xs text-center mt-2 text-gray-700 font-medium truncate w-full"><%= assignment.person.name %></div>
                      <div class="text-xs text-center text-gray-500 truncate w-full"><%= assignment.role.name %></div>
                    </div>
                  <% end %>
                <% else %>
                  <% # Show uncast role %>
                  <%= link_to cast_manage_production_show_path(@production, @show) do %>
                    <div class="flex flex-col items-center w-[100px] transition-all">
                      <div class="w-20 h-20 rounded-lg bg-gray-50 flex items-center justify-center border-2 border-dashed border-gray-300 hover:border-pink-400 hover:bg-pink-50 transition-all">
                        <span class="text-2xl">+</span>
                      </div>
                      <div class="text-xs text-center mt-2 text-gray-700 font-medium truncate w-full"><%= role.name %></div>
                    </div>
                  <% end %>
                <% end %>
              <% end %>

              <% if @show.production.roles.empty? %>
                <div class="text-sm text-gray-500">
                  No roles available
                </div>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>

      <% if @show.location.present? && !@show.canceled %>

      <div class="border border-gray-200 rounded-lg overflow-hidden">
          <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 flex items-left">
            <svg class="w-5 h-5 text-gray-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" /></svg>
            <h3 class="ml-1 text-sm font-semibold text-gray-900"><%= @show.location.name %></h3>
          </div>
          <div class="p-0">
            <% loc = @show.location %>
            <% if loc.present? %>
              <% address = [loc.address1, loc.address2, loc.city, loc.state, loc.postal_code].compact.reject(&:blank?).join(', ') %>
              <div class="w-full">
                <iframe
                  width="100%"
                  height="400"
                  style="border:0"
                  loading="lazy"
                  allowfullscreen
                  referrerpolicy="no-referrer-when-downgrade"
                  src="https://www.google.com/maps?q=<%= URI.encode_www_form_component(address) %>&output=embed">
                </iframe>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

    </div>
  </div>

</div>
