<% content_for :title, "CocoScout - Apply for an Audition" %>

<% content_for :head do %>
  <meta name="description" content="Apply to audition for <%= @production.name %>">
  <link rel="canonical" href="<%= submit_audition_request_url(@audition_cycle.token) %>">
<% end %>

<div class="min-h-screen bg-white" data-controller="audition-request-form" data-audition-request-form-profile-url-value="<%= update_profile_path(@requestable) %>">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8 sm:py-12">

    <!-- Full-Width Header -->
    <div class="mb-8 sm:mb-10">
      <h1 class="text-3xl sm:text-4xl font-bold text-slate-900 mb-3 coustard-regular"><%= @production.name %></h1>
      <% if @audition_cycle.hybrid_auditions? %>
        <p class="text-lg text-slate-600">Audition sign-up</p>
      <% elsif @audition_cycle.video_only? %>
        <p class="text-lg text-slate-600">Submit a video audition</p>
      <% else %>
        <p class="text-lg text-slate-600">Sign up for an in-person audition</p>
      <% end %>
    </div>

    <!-- Two Column Layout: Instruction Text & Form -->
    <div class="grid lg:grid-cols-2 gap-8 lg:gap-12">

      <!-- Left Column: Instruction Text -->
      <div class="space-y-6">
        <% if @audition_cycle.instruction_text.present? %>
          <div class="bg-gradient-to-br from-slate-50 to-white border border-slate-200 rounded-lg p-6 sm:p-8 shadow-sm">
            <div class="prose prose-slate max-w-none text-slate-700">
              <%= @audition_cycle.instruction_text %>
            </div>
          </div>
        <% end %>
      </div>

      <!-- Right Column: Form -->
      <div>
        <%
          # Get all user's active profiles
          user_profiles = Current.user.people.active.includes(:profile_headshots, :profile_resumes).order(:created_at)

          eligible_groups = Current.user.person.group_memberships
            .where(permission_level: [:write, :owner])
            .joins(:group)
            .where(groups: { archived_at: nil })
            .includes(group: [:profile_headshots, :profile_resumes])

          # Show dropdown if user has multiple profiles OR groups
          show_entity_dropdown = user_profiles.count > 1 || eligible_groups.any?

          is_group = @requestable.is_a?(Group)
          entity = @requestable
          entity_headshot = entity.primary_headshot
          entity_profile_path = is_group ? edit_group_path(entity) : edit_profile_path(entity)

          # Check if the selected entity (person or group) has incomplete profile
          entity_profile_incomplete = !entity.profile_headshots.exists? || !entity.profile_resumes.exists?
        %>

        <%= form_with(model: @audition_request, url: my_submit_submit_audition_request_form_path(@audition_cycle.token), method: :post, data: { turbo: false }, class: "space-y-4") do |form| %>

    <!-- Profile Section -->
    <div class="bg-white border border-slate-200 rounded-lg shadow-sm" data-audition-request-form-target="profileSection">

      <div class="p-5">
        <!-- Entity Switcher -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-3">Applying as:</label>

          <% if show_entity_dropdown %>
            <!-- Dropdown Switcher -->
            <div class="relative" data-audition-request-form-target="dropdownContainer">
              <button type="button"
                      data-action="click->audition-request-form#toggleDropdown"
                      class="w-full flex items-center gap-3 px-4 py-3 bg-white border border-gray-300 rounded-lg hover:border-pink-400 transition-all duration-200 cursor-pointer">
                <% if entity_headshot&.image&.attached? %>
                  <%= image_tag entity_headshot.image.variant(resize_to_fill: [48, 48]), class: "w-12 h-12 rounded-lg object-cover flex-shrink-0" %>
                <% else %>
                  <div class="w-12 h-12 rounded-lg bg-gray-200 flex items-center justify-center flex-shrink-0">
                    <% if is_group %>
                      <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z"></path>
                      </svg>
                    <% else %>
                      <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                      </svg>
                    <% end %>
                  </div>
                <% end %>
                <div class="flex-1 text-left min-w-0">
                  <div class="font-medium text-gray-900 truncate"><%= entity.name %></div>
                  <div class="text-sm text-gray-500 truncate">@<%= entity.public_key %></div>
                </div>
                <svg data-audition-request-form-target="dropdownChevron"
                     class="w-5 h-5 text-gray-400 transition-transform duration-200 flex-shrink-0"
                     fill="none"
                     stroke="currentColor"
                     viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </button>

              <!-- Dropdown Menu -->
              <div data-audition-request-form-target="dropdownMenu"
                   class="hidden absolute z-10 w-full mt-2 bg-white border border-gray-200 rounded-lg shadow-lg overflow-hidden">

                <!-- Person Profile Options -->
                <% user_profiles.each do |person_profile| %>
                  <button type="button"
                          data-action="click->audition-request-form#selectPersonFromDropdown"
                          data-person-id="<%= person_profile.id %>"
                          class="w-full flex items-center gap-3 px-4 py-3 hover:bg-pink-50 transition-colors duration-150 border-b border-gray-100 cursor-pointer">
                    <% person_headshot = person_profile.primary_headshot %>
                    <% if person_headshot&.image&.attached? %>
                      <%= image_tag person_headshot.image.variant(resize_to_fill: [48, 48]), class: "w-12 h-12 rounded-lg object-cover flex-shrink-0" %>
                    <% else %>
                      <div class="w-12 h-12 rounded-lg bg-gray-200 flex items-center justify-center flex-shrink-0">
                        <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                        </svg>
                      </div>
                    <% end %>
                    <div class="flex-1 text-left min-w-0">
                      <div class="font-medium text-gray-900 truncate"><%= person_profile.name %></div>
                      <div class="text-sm text-gray-500 truncate">@<%= person_profile.public_key %></div>
                    </div>
                    <% if !is_group && entity.id == person_profile.id %>
                      <svg class="w-5 h-5 text-pink-600 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                      </svg>
                    <% end %>
                  </button>
                <% end %>

                <!-- Group Options -->
                <% eligible_groups.each do |membership| %>
                  <% group = membership.group %>
                  <button type="button"
                          data-action="click->audition-request-form#selectGroupFromDropdown"
                          data-group-id="<%= group.id %>"
                          class="w-full flex items-center gap-3 px-4 py-3 hover:bg-pink-50 transition-colors duration-150 border-b border-gray-100 last:border-b-0 cursor-pointer">
                    <% group_headshot = group.primary_headshot %>
                    <% if group_headshot&.image&.attached? %>
                      <%= image_tag group_headshot.image.variant(resize_to_fill: [48, 48]), class: "w-12 h-12 rounded-lg object-cover flex-shrink-0" %>
                    <% else %>
                      <div class="w-12 h-12 rounded-lg bg-gray-200 flex items-center justify-center flex-shrink-0">
                        <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                          <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z"></path>
                        </svg>
                      </div>
                    <% end %>
                    <div class="flex-1 text-left min-w-0">
                      <div class="font-medium text-gray-900 truncate"><%= group.name %></div>
                      <div class="text-sm text-gray-500 truncate">@<%= group.public_key %></div>
                    </div>
                    <% if is_group && entity.id == group.id %>
                      <svg class="w-5 h-5 text-pink-600 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                      </svg>
                    <% end %>
                  </button>
                <% end %>
              </div>
            </div>
          <% else %>
            <!-- Static Tile (No Groups) -->
            <div class="flex items-center gap-3 px-4 py-3 bg-white border border-gray-300 rounded-lg">
              <% person_headshot = Current.user.person.primary_headshot %>
              <% if person_headshot&.image&.attached? %>
                <%= image_tag person_headshot.image.variant(resize_to_fill: [48, 48]), class: "w-12 h-12 rounded-lg object-cover flex-shrink-0" %>
              <% else %>
                <div class="w-12 h-12 rounded-lg bg-gray-200 flex items-center justify-center flex-shrink-0">
                  <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                  </svg>
                </div>
              <% end %>
              <div class="flex-1 text-left min-w-0">
                <div class="font-medium text-gray-900 truncate"><%= Current.user.person.name %></div>
                <div class="text-sm text-gray-500 truncate">@<%= Current.user.person.public_key %></div>
              </div>
            </div>
          <% end %>

          <!-- Edit Profile Link -->
          <div class="mt-0 text-left">
            <%= link_to entity_profile_path, target: "_blank", class: "text-xs text-pink-500 hover:text-pink-600 underline" do %>
              Edit <%= is_group ? "Group " : "" %>Profile
            <% end %>
          </div>
        </div>
      </div>

      <!-- Hidden fields to store selected entity type and ID -->
      <%= hidden_field_tag :requestable_type, @requestable.class.name, data: { audition_request_form_target: "requestableType" } %>
      <%= hidden_field_tag :requestable_id, @requestable.id, data: { audition_request_form_target: "requestableId", person_id: Current.user.person.id } %>
    </div>

    <!-- Profile Incomplete Warning -->
    <% if entity_profile_incomplete %>
      <div class="bg-gradient-to-br from-pink-50 to-white border-2 border-pink-200 rounded-lg shadow-sm p-5">
        <div class="flex items-start gap-3">
          <div class="flex-shrink-0 w-10 h-10 bg-pink-100 rounded-lg flex items-center justify-center">
            <svg class="w-6 h-6 text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <div class="flex-1">
            <h3 class="text-base font-semibold text-gray-900 mb-1">
              <%= is_group ? "Group profile needs a few details" : "Complete your profile!" %>
            </h3>
            <p class="text-sm text-gray-700 mb-3">
              <% if is_group %>
                This group needs a headshot and resume to submit an audition request. These help casting teams get to know your group better!
              <% else %>
                Adding a headshot and resume helps casting teams see your experience and increases your chances of being noticed. It only takes a minute!
              <% end %>
            </p>
            <% if is_group %>
              <%= link_to entity_profile_path, class: "inline-flex items-center gap-2 px-4 py-2 bg-pink-500 hover:bg-pink-600 text-white rounded-lg text-sm font-medium transition-colors" do %>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
                <span>Complete Group Profile</span>
              <% end %>
            <% else %>
              <button type="button"
                      data-action="click->audition-request-form#openProfileSetup"
                      class="inline-flex items-center gap-2 px-4 py-2 bg-pink-500 hover:bg-pink-600 text-white rounded-lg text-sm font-medium transition-colors cursor-pointer">
                <span>Add Headshot & Resume</span>
              </button>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>

    <!-- Video Upload Section -->
    <% if @audition_cycle.accepts_video_submissions? %>
      <div class="bg-white border border-slate-200 rounded-lg shadow-sm">
        <div class="p-5">

              <% if @audition_cycle.video_field_text.present? %>
                <div class="text-sm text-gray-500 mb-4">
                  <%= @audition_cycle.video_field_text %>
                </div>
              <% end %>

              <% if @audition_request.errors[:video_url].none? %>
                  <%= form.label :video_url, "Video URL" %>
                  <span class="text-sm text-gray-500"> (eg. YouTube, Google Drive, etc.)</span>
              <% else %>
                  <%= form.label :video_url, "Video URL is required", class: "text-pink-600"  %>
              <% end %>

              <%= form.text_field :video_url, class: ["block shadow-sm rounded-lg border px-3 py-2 mt-2 w-full", {"border-gray-400": @audition_request.errors[:video_url].none?, "border-pink-500": @audition_request.errors[:video_url].any?}] %>
        </div>
      </div>
    <% end %>

    <!-- Availability Section -->
    <% if @audition_cycle.include_availability_section && @shows.present? %>
      <div class="bg-white border border-slate-200 rounded-lg shadow-sm p-5">
        <p class="text-sm text-gray-500 mb-4">
          Please indicate your availability for the following shows & events. <% if @audition_cycle.require_all_availability %> <span class="text-sm text-pink-500">(required)</span><% end %>
        </p>

        <% if @missing_availability %>
          <div class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg">
            <p class="text-sm text-red-800">Please respond to all events before submitting.</p>
          </div>
        <% end %>

        <div class="space-y-3">
          <% @shows.each do |show| %>
            <div class="flex items-stretch px-3 py-2 border rounded-lg hover:border-gray-400 transition-all bg-white border-gray-200">
              <%# Left Section: Date & Show Details %>
              <div class="w-1/2 flex items-center gap-4">
                <%# Date Box %>
                <div class="flex-shrink-0 w-14 text-center">
                  <div class="text-xs font-semibold text-pink-600 uppercase"><%= show.date_and_time.strftime("%b") %></div>
                  <div class="text-2xl font-bold text-gray-900"><%= show.date_and_time.strftime("%-d") %></div>
                  <div class="text-xs text-gray-500"><%= show.date_and_time.strftime("%a") %></div>
                </div>

                <%# Show Details %>
                <div class="flex-1 min-w-0">
                  <div class="text-sm font-medium text-gray-900">
                    <%= show.display_name %>
                  </div>
                  <div class="text-xs text-gray-600">
                    <%= show.date_and_time.strftime("%l:%M %p") %>
                  </div>
                </div>
              </div>

              <%# Right Section: Availability Buttons %>
              <div class="w-1/2 border-l border-gray-200 pl-4 flex items-center">
                <div class="flex-1">
                  <div class="flex gap-0">
                    <% existing_status = @availability&.dig("#{show.id}") %>
                    <%= radio_button_tag "availability[#{show.id}]", "available", existing_status == "available", id: "availability_#{show.id}_available", class: "sr-only peer/available", required: @audition_cycle.require_all_availability %>
                    <%= label_tag "availability_#{show.id}_available", class: "w-8 sm:w-20 text-xs py-1 sm:py-1.5 text-center border border-gray-200 cursor-pointer flex items-center justify-center rounded-l border-r-0 bg-white text-gray-700 hover:bg-gray-50 peer-checked/available:bg-pink-500 peer-checked/available:text-white peer-checked/available:hover:bg-pink-500", for: "availability_#{show.id}_available" do %>
                      <span class="sm:hidden">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6.633 10.25c.806 0 1.533-.446 2.031-1.08a9.041 9.041 0 0 1 2.861-2.4c.723-.384 1.35-.956 1.653-1.715a4.498 4.498 0 0 0 .322-1.672V2.75a.75.75 0 0 1 .75-.75 2.25 2.25 0 0 1 2.25 2.25c0 1.152-.26 2.243-.723 3.218-.266.558.107 1.282.725 1.282m0 0h3.126c1.026 0 1.945.694 2.054 1.715.045.422.068.85.068 1.285a11.95 11.95 0 0 1-2.649 7.521c-.388.482-.987.729-1.605.729H13.48c-.483 0-.964-.078-1.423-.23l-3.114-1.04a4.501 4.501 0 0 0-1.423-.23H5.904m10.598-9.75H14.25M5.904 18.5c.083.205.173.405.27.602.197.4-.078.898-.523.898h-.908c-.889 0-1.713-.518-1.972-1.368a12 12 0 0 1-.521-3.507c0-1.553.295-3.036.831-4.398C3.387 9.953 4.167 9.5 5 9.5h1.053c.472 0 .745.556.5.96a8.958 8.958 0 0 0-1.302 4.665c0 1.194.232 2.333.654 3.375Z"/></svg>
                      </span>
                      <span class="hidden sm:inline">Available</span>
                    <% end %>

                    <%= radio_button_tag "availability[#{show.id}]", "unavailable", existing_status == "unavailable", id: "availability_#{show.id}_unavailable", class: "sr-only peer/unavailable", required: @audition_cycle.require_all_availability %>
                    <%= label_tag "availability_#{show.id}_unavailable", class: "w-8 sm:w-20 text-xs py-1 sm:py-1.5 text-center border border-gray-200 cursor-pointer flex items-center justify-center rounded-r bg-white text-gray-700 hover:bg-gray-50 peer-checked/unavailable:bg-pink-500 peer-checked/unavailable:text-white peer-checked/unavailable:hover:bg-pink-500", for: "availability_#{show.id}_unavailable" do %>
                      <span class="sm:hidden">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7.498 15.25H4.372c-1.026 0-1.945-.694-2.054-1.715a12.137 12.137 0 0 1-.068-1.285c0-2.848.992-5.464 2.649-7.521C5.287 4.247 5.886 4 6.504 4h4.016a4.5 4.5 0 0 1 1.423.23l3.114 1.04a4.5 4.5 0 0 0 1.423.23h1.294M7.498 15.25c.618 0 .991.724.725 1.282A7.471 7.471 0 0 0 7.5 19.75 2.25 2.25 0 0 0 9.75 22a.75.75 0 0 0 .75-.75v-.633c0-.573.11-1.14.322-1.672.304-.76.93-1.33 1.653-1.715a9.04 9.04 0 0 0 2.86-2.4c.498-.634 1.226-1.08 2.032-1.08h.384m-10.253 1.5H9.7m8.075-9.75c.01.05.027.1.05.148.593 1.2.925 2.55.925 3.977 0 1.487-.36 2.89-.999 4.125m.023-8.25c-.076-.365.183-.75.575-.75h.908c.889 0 1.713.518 1.972 1.368.339 1.11.521 2.287.521 3.507 0 1.553-.295 3.036-.831 4.398-.306.774-1.086 1.227-1.918 1.227h-1.053c-.472 0-.745-.556-.5-.96a8.95 8.95 0 0 0 .303-.54"/></svg>
                      </span>
                      <span class="hidden sm:inline">Unavailable</span>
                    <% end %>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- Audition Availability Section -->
    <% if @audition_cycle.include_audition_availability_section && @audition_sessions.present? %>
      <div class="bg-white border border-slate-200 rounded-lg shadow-sm p-5">
        <p class="text-sm text-gray-500 mb-4">
          Please indicate your availability for the following audition sessions. <% if @audition_cycle.require_all_audition_availability %> <span class="text-sm text-pink-500">(required)</span><% end %>
        </p>

        <% if @missing_audition_availability %>
          <div class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg">
            <p class="text-sm text-red-800">Please respond to all audition sessions before submitting.</p>
          </div>
        <% end %>

        <div class="space-y-3">
          <% @audition_sessions.each do |session| %>
            <div class="flex items-stretch px-3 py-2 border rounded-lg hover:border-gray-400 transition-all bg-white border-gray-200">
              <%# Left Section: Date & Session Details %>
              <div class="w-1/2 flex items-center gap-4">
                <%# Date Box %>
                <div class="flex-shrink-0 w-14 text-center">
                  <div class="text-xs font-semibold text-pink-600 uppercase"><%= session.start_at.strftime("%b") %></div>
                  <div class="text-2xl font-bold text-gray-900"><%= session.start_at.strftime("%-d") %></div>
                  <div class="text-xs text-gray-500"><%= session.start_at.strftime("%a") %></div>
                </div>

                <%# Session Details %>
                <div class="flex-1 min-w-0">
                  <div class="text-sm font-medium text-gray-900">
                    Audition Session
                  </div>
                  <div class="text-xs text-gray-600">
                    <%= session.start_at.strftime("%l:%M %p") %>
                  </div>
                </div>
              </div>

              <%# Right Section: Availability Buttons %>
              <div class="w-1/2 border-l border-gray-200 pl-4 flex items-center">
                <div class="flex-1">
                  <div class="flex gap-0">
                    <% existing_status = @audition_availability&.dig("#{session.id}") %>
                    <%= radio_button_tag "audition_availability[#{session.id}]", "available", existing_status == "available", id: "audition_availability_#{session.id}_available", class: "sr-only peer/available", required: @audition_cycle.require_all_audition_availability %>
                    <%= label_tag "audition_availability_#{session.id}_available", class: "w-8 sm:w-20 text-xs py-1 sm:py-1.5 text-center border border-gray-200 cursor-pointer flex items-center justify-center rounded-l border-r-0 bg-white text-gray-700 hover:bg-gray-50 peer-checked/available:bg-pink-500 peer-checked/available:text-white peer-checked/available:hover:bg-pink-500", for: "audition_availability_#{session.id}_available" do %>
                      <span class="sm:hidden">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6.633 10.25c.806 0 1.533-.446 2.031-1.08a9.041 9.041 0 0 1 2.861-2.4c.723-.384 1.35-.956 1.653-1.715a4.498 4.498 0 0 0 .322-1.672V2.75a.75.75 0 0 1 .75-.75 2.25 2.25 0 0 1 2.25 2.25c0 1.152-.26 2.243-.723 3.218-.266.558.107 1.282.725 1.282m0 0h3.126c1.026 0 1.945.694 2.054 1.715.045.422.068.85.068 1.285a11.95 11.95 0 0 1-2.649 7.521c-.388.482-.987.729-1.605.729H13.48c-.483 0-.964-.078-1.423-.23l-3.114-1.04a4.501 4.501 0 0 0-1.423-.23H5.904m10.598-9.75H14.25M5.904 18.5c.083.205.173.405.27.602.197.4-.078.898-.523.898h-.908c-.889 0-1.713-.518-1.972-1.368a12 12 0 0 1-.521-3.507c0-1.553.295-3.036.831-4.398C3.387 9.953 4.167 9.5 5 9.5h1.053c.472 0 .745.556.5.96a8.958 8.958 0 0 0-1.302 4.665c0 1.194.232 2.333.654 3.375Z"/></svg>
                      </span>
                      <span class="hidden sm:inline">Available</span>
                    <% end %>

                    <%= radio_button_tag "audition_availability[#{session.id}]", "unavailable", existing_status == "unavailable", id: "audition_availability_#{session.id}_unavailable", class: "sr-only peer/unavailable", required: @audition_cycle.require_all_audition_availability %>
                    <%= label_tag "audition_availability_#{session.id}_unavailable", class: "w-8 sm:w-20 text-xs py-1 sm:py-1.5 text-center border border-gray-200 cursor-pointer flex items-center justify-center rounded-r bg-white text-gray-700 hover:bg-gray-50 peer-checked/unavailable:bg-pink-500 peer-checked/unavailable:text-white peer-checked/unavailable:hover:bg-pink-500", for: "audition_availability_#{session.id}_unavailable" do %>
                      <span class="sm:hidden">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7.498 15.25H4.372c-1.026 0-1.945-.694-2.054-1.715a12.137 12.137 0 0 1-.068-1.285c0-2.848.992-5.464 2.649-7.521C5.287 4.247 5.886 4 6.504 4h4.016a4.5 4.5 0 0 1 1.423.23l3.114 1.04a4.5 4.5 0 0 0 1.423.23h1.294M7.498 15.25c.618 0 .991.724.725 1.282A7.471 7.471 0 0 0 7.5 19.75 2.25 2.25 0 0 0 9.75 22a.75.75 0 0 0 .75-.75v-.633c0-.573.11-1.14.322-1.672.304-.76.93-1.33 1.653-1.715a9.04 9.04 0 0 0 2.86-2.4c.498-.634 1.226-1.08 2.032-1.08h.384m-10.253 1.5H9.7m8.075-9.75c.01.05.027.1.05.148.593 1.2.925 2.55.925 3.977 0 1.487-.36 2.89-.999 4.125m.023-8.25c-.076-.365.183-.75.575-.75h.908c.889 0 1.713.518 1.972 1.368.339 1.11.521 2.287.521 3.507 0 1.553-.295 3.036-.831 4.398-.306.774-1.086 1.227-1.918 1.227h-1.053c-.472 0-.745-.556-.5-.96a8.95 8.95 0 0 0 .303-.54"/></svg>
                      </span>
                      <span class="hidden sm:inline">Unavailable</span>
                    <% end %>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- Questions Section -->
    <% if @questions.any? %>
      <div class="bg-white border border-slate-200 rounded-lg shadow-sm p-5 space-y-5">
        <% @questions.each do |question| %>
          <div class="">
            <label>
              <%= question.text %>
              <% if question.required %>
                <span class="text-pink-500 text-sm">(required)</span>
              <% end %>
            </label>

            <%= render_question_input(question, @answers, missing_required_questions: @missing_required_questions) %>

          </div>
        <% end %>
      </div>
    <% end %>

    <!-- Submit Button -->
    <%
      existing_request = @audition_cycle.audition_requests.exists?(requestable: @requestable)
      if @audition_cycle.video_only?
        submit_text = existing_request ? "Update video audition" : "Submit video audition"
      else
        submit_text = existing_request ? "Update Sign-up" : "Sign up"
      end
    %>
  <% if entity_profile_incomplete %>
    <button type="button"
            disabled
            class="w-full rounded-lg px-4 py-3 text-white bg-gray-400 font-semibold cursor-not-allowed">
      <%= submit_text %> (Complete profile first)
    </button>
  <% else %>
    <%= render "shared/button", text: submit_text, variant: "primary", size: "jumbo", type: :submit %>
  <% end %>
      <% end %>
    </div>    </div>
  </div>

  <!-- Coco Link -->
  <div class="w-16 pt-5 md:pt-0 fixed bottom-0 right-0 md:flex md:items-end md:justify-end">
    <%= link_to my_dashboard_path do %>
      <%= render "shared/cocoscout_logo", size: :small, class: "mr-5" %>
    <% end %>
  </div>

  <!-- Profile Setup Modal -->
  <div class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"
       data-audition-request-form-target="profileSetupModal"
       data-action="click->audition-request-form#closeProfileSetup keydown.esc@window->audition-request-form#closeProfileSetup">
    <div class="bg-white rounded-lg shadow-xl max-w-xl w-full max-h-[90vh] overflow-y-auto"
         data-action="click->audition-request-form#stopPropagation">
      <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between">
        <h3 class="text-lg font-semibold text-gray-900">Complete Your Profile</h3>
        <button type="button"
                data-action="click->audition-request-form#closeProfileSetup"
                class="text-gray-400 hover:text-gray-600 cursor-pointer">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <%= form_with(model: @requestable, url: update_profile_path(@requestable), method: :patch, scope: :person, data: { turbo: false, audition_request_form_target: "profileForm", action: "submit->audition-request-form#submitProfileForm" }, class: "p-6 space-y-6") do |person_form| %>

          <!-- Name -->
          <div>
            <%= person_form.label :name, "Name", class: "block text-sm font-medium text-gray-700 mb-2" %>
            <%= person_form.text_field :name,
                class: "block w-full rounded-lg border border-gray-300 px-3 py-2",
                placeholder: "Your full name" %>
          </div>

          <!-- Pronouns -->
          <div>
            <%= person_form.label :pronouns, "Pronouns", class: "block text-sm font-medium text-gray-700 mb-2" %>
            <%= person_form.text_field :pronouns,
                class: "block w-full rounded-lg border border-gray-300 px-3 py-2",
                placeholder: "e.g., he/him, she/her, they/them" %>
          </div>

          <!-- Headshot and Resume side by side -->
          <div class="grid grid-cols-2 gap-4">
            <!-- Headshot -->
            <div>
              <%= person_form.label :profile_headshots, "Headshot", class: "block text-sm font-medium text-gray-700 mb-2" %>
              <%= person_form.fields_for :profile_headshots, person_form.object.profile_headshots.build do |headshot_form| %>
                <div data-audition-request-form-target="headshotContainer">
                  <% if @requestable.primary_headshot&.image&.attached? %>
                    <div class="relative inline-block" data-audition-request-form-target="headshotPreview">
                      <%= image_tag @requestable.primary_headshot.image.variant(resize_to_fill: [300, 400]),
                                    class: "w-full aspect-[3/4] rounded-lg object-cover border-2 border-gray-200" %>
                      <button type="button"
                              data-action="click->audition-request-form#removeHeadshot"
                              data-headshot-id="<%= @requestable.primary_headshot.id %>"
                              class="absolute bottom-2 right-2 bg-pink-500 text-white text-xs px-2 py-1 rounded hover:bg-pink-600 cursor-pointer">
                        Remove
                      </button>
                    </div>
                  <% else %>
                    <label class="block cursor-pointer">
                      <%= headshot_form.file_field :image,
                          accept: "image/jpeg,image/jpg,image/png",
                          class: "hidden",
                          data: { action: "change->audition-request-form#uploadHeadshot" },
                          id: "headshot-upload" %>
                      <div class="w-full aspect-[3/4] border-2 border-dashed border-gray-300 rounded-lg hover:border-pink-400 transition-colors bg-gray-50 hover:bg-pink-50 flex flex-col items-center justify-center">
                        <svg class="w-10 h-10 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <p class="text-sm font-medium text-gray-700 text-center px-2">Select a headshot</p>
                        <p class="text-xs text-gray-500 mt-1">JPG, JPEG, or PNG</p>
                      </div>
                    </label>
                  <% end %>
                </div>
              <% end %>
            </div>

            <!-- Resume -->
            <div>
              <%= person_form.label :profile_resumes, "Resume", class: "block text-sm font-medium text-gray-700 mb-2" %>
              <%= person_form.fields_for :profile_resumes, person_form.object.profile_resumes.build do |resume_form| %>
                <div data-audition-request-form-target="resumeContainer">
                  <% if @requestable.profile_resumes.any? && @requestable.profile_resumes.first.file.attached? %>
                    <div class="relative inline-block" data-audition-request-form-target="resumePreview">
                      <% resume = @requestable.profile_resumes.first %>
                      <% if resume.file.content_type == 'application/pdf' %>
                        <% if resume.file.representable? %>
                          <%= image_tag resume.file.representation(resize_to_limit: [300, 400]),
                                        class: "w-full aspect-[3/4] rounded-lg object-cover border-2 border-gray-200" %>
                        <% else %>
                          <div class="w-full aspect-[3/4] rounded-lg border-2 border-gray-200 bg-gray-50 flex flex-col items-center justify-center p-4">
                            <svg class="w-16 h-16 text-pink-500 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <p class="text-sm font-medium text-gray-900 text-center">PDF Resume</p>
                          </div>
                        <% end %>
                      <% else %>
                        <%= image_tag resume.file.variant(resize_to_fill: [300, 400]),
                                      class: "w-full aspect-[3/4] rounded-lg object-cover border-2 border-gray-200" %>
                      <% end %>
                      <button type="button"
                              data-action="click->audition-request-form#removeResume"
                              data-resume-id="<%= resume.id %>"
                              class="absolute bottom-2 right-2 bg-pink-500 text-white text-xs px-2 py-1 rounded hover:bg-pink-600 cursor-pointer">
                        Remove
                      </button>
                    </div>
                  <% else %>
                    <label class="block cursor-pointer">
                      <%= resume_form.file_field :file,
                          accept: ".pdf,.jpg,.jpeg",
                          class: "hidden",
                          data: { action: "change->audition-request-form#uploadResume" },
                          id: "resume-upload" %>
                      <div class="w-full aspect-[3/4] border-2 border-dashed border-gray-300 rounded-lg hover:border-pink-400 transition-colors bg-gray-50 hover:bg-pink-50 flex flex-col items-center justify-center p-4">
                        <svg class="w-10 h-10 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <p class="text-sm font-medium text-gray-700 text-center">Select a resume</p>
                        <p class="text-xs text-gray-500 mt-1">PDF, JPG, or PNG</p>
                      </div>
                    </label>
                  <% end %>
                </div>
              <% end %>
            </div>
          </div>

        <div class="flex gap-3 pt-4">
          <button type="button"
                  data-action="click->audition-request-form#closeProfileSetup"
                  class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 font-medium cursor-pointer">
            Cancel
          </button>
          <button type="button"
                  data-action="click->audition-request-form#submitProfileForm"
                  class="flex-1 px-4 py-2 bg-pink-500 hover:bg-pink-600 text-white rounded-lg font-medium cursor-pointer">
            Save & Continue
          </button>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Entity Selector Modal -->
  <div class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"
       data-audition-request-form-target="entitySelectorModal"
       data-action="click->audition-request-form#closeEntitySelector">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full"
         data-action="click->audition-request-form#stopPropagation">
      <div class="border-b border-gray-200 px-6 py-4">
        <h3 class="text-lg font-semibold text-gray-900">Select Who to Apply As</h3>
      </div>

      <div class="p-6 space-y-3">
        <!-- Person Option -->
        <button type="button"
                data-action="click->audition-request-form#selectPerson"
                class="w-full text-left p-4 border-2 border-gray-200 hover:border-pink-500 rounded-lg transition-colors group">
          <div class="flex items-center gap-3">
            <% person_headshot = Current.user.person.primary_headshot %>
            <% if person_headshot&.image&.attached? %>
              <%= image_tag person_headshot.image.variant(resize_to_fill: [48, 48]), class: "w-12 h-12 rounded-lg object-cover" %>
            <% else %>
              <div class="w-12 h-12 bg-slate-200 rounded-lg flex items-center justify-center">
                <svg class="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
              </div>
            <% end %>
            <div>
              <div class="font-semibold text-gray-900 group-hover:text-pink-600"><%= Current.user.person.name %></div>
              <div class="text-sm text-gray-500">Individual</div>
            </div>
          </div>
        </button>

        <!-- Group Options -->
        <% eligible_groups.each do |membership| %>
          <% group = membership.group %>
          <button type="button"
                  data-action="click->audition-request-form#selectGroup"
                  data-group-id="<%= group.id %>"
                  class="w-full text-left p-4 border-2 border-gray-200 hover:border-pink-500 rounded-lg transition-colors group">
            <div class="flex items-center gap-3">
              <% group_headshot = group.primary_headshot %>
              <% if group_headshot&.image&.attached? %>
                <%= image_tag group_headshot.image.variant(resize_to_fill: [48, 48]), class: "w-12 h-12 rounded-lg object-cover" %>
              <% else %>
                <div class="w-12 h-12 bg-slate-200 rounded-lg flex items-center justify-center">
                  <svg class="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                  </svg>
                </div>
              <% end %>
              <div>
                <div class="font-semibold text-gray-900 group-hover:text-pink-600"><%= group.name %></div>
                <div class="text-sm text-gray-500">Group â€¢ <%= membership.permission_level.titleize %></div>
              </div>
            </div>
          </button>
        <% end %>
      </div>

      <div class="border-t border-gray-200 px-6 py-4">
        <button type="button"
                data-action="click->audition-request-form#closeEntitySelector"
                class="w-full px-4 py-2 text-gray-700 hover:bg-gray-50 rounded-lg font-medium">
          Cancel
        </button>
      </div>
    </div>
  </div>
</div>