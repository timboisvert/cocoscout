<% content_for :title, @production ? "#{@production.name} Advances" : "Advances" %>

<div class="w-full mb-10">
  <%= render partial: "shared/notice", locals: { notice: notice, alert: alert } %>

  <% if @production %>
    <%# Single Production View %>
    <%= render partial: "shared/top_menu", locals: {
      breadcrumbs: [
        ["Money", manage_money_index_path],
        ["Payouts", manage_money_payouts_path],
        ["Advances", manage_money_advances_path]
      ],
      text: @production.name
    } %>

    <%# Stats Cards %>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="bg-white rounded-lg border border-gray-200 p-5">
        <div class="text-sm text-gray-500 mb-1">Unpaid</div>
        <div class="text-2xl font-semibold text-pink-600"><%= number_to_currency(@total_unpaid) %></div>
        <div class="text-xs text-gray-500"><%= @unpaid_advances.count %> advance<%= @unpaid_advances.count == 1 ? "" : "s" %> to pay out</div>
      </div>
      <div class="bg-white rounded-lg border border-gray-200 p-5">
        <div class="text-sm text-gray-500 mb-1">Outstanding</div>
        <div class="text-2xl font-semibold text-amber-600"><%= number_to_currency(@total_outstanding) %></div>
        <div class="text-xs text-gray-500"><%= @outstanding_advances.count %> advance<%= @outstanding_advances.count == 1 ? "" : "s" %> to repay</div>
      </div>
      <div class="bg-white rounded-lg border border-gray-200 p-5">
        <div class="text-sm text-gray-500 mb-1">Issued This Month</div>
        <div class="text-2xl font-semibold text-gray-900"><%= number_to_currency(@total_issued_this_month) %></div>
        <div class="text-xs text-gray-500">since <%= Date.current.beginning_of_month.strftime("%B 1") %></div>
      </div>
      <div class="bg-white rounded-lg border border-gray-200 p-5">
        <div class="text-sm text-gray-500 mb-1">Repaid</div>
        <div class="text-2xl font-semibold text-green-600"><%= @repaid_advances.count %></div>
        <div class="text-xs text-gray-500">advances fully repaid</div>
      </div>
    </div>

    <%# Unpaid Advances (we owe them) %>
    <% if @unpaid_advances.any? %>
      <div class="mb-8">
        <h3 class="text-lg font-semibold text-gray-900 mb-1">Unpaid Advances</h3>
        <p class="text-sm text-gray-500 mb-3">These advances have been issued but not yet paid out.</p>
        <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Person</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Show</th>
                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Issued</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
              <% @unpaid_advances.each do |advance| %>
                <tr class="hover:bg-gray-50 cursor-pointer" onclick="window.location='<%= manage_money_advance_path(advance.production, advance) %>'">
                  <td class="px-4 py-3">
                    <div class="flex items-center gap-2">
                      <% if advance.person.safe_headshot_variant(:tiny) %>
                        <%= image_tag advance.person.safe_headshot_variant(:tiny), class: "w-8 h-8 rounded-lg object-cover" %>
                      <% else %>
                        <div class="w-8 h-8 rounded-lg bg-gray-200 flex items-center justify-center text-gray-600 text-xs font-medium">
                          <%= advance.person.initials %>
                        </div>
                      <% end %>
                      <span class="font-medium text-gray-900"><%= advance.person.name %></span>
                    </div>
                  </td>
                  <td class="px-4 py-3 text-sm text-gray-600">
                    <% if advance.show %>
                      <%= advance.show.date_and_time.strftime("%b %-d") %>
                    <% else %>
                      <span class="text-gray-400">General</span>
                    <% end %>
                  </td>
                  <td class="px-4 py-3 text-sm text-pink-600 text-right font-medium"><%= number_to_currency(advance.original_amount) %></td>
                  <td class="px-4 py-3 text-sm text-gray-500"><%= advance.issued_at.strftime("%b %-d, %Y") %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    <% end %>

    <%# Outstanding Advances (they owe us) %>
    <div class="mb-8">
      <h3 class="text-lg font-semibold text-gray-900 mb-1">Outstanding Advances</h3>
      <p class="text-sm text-gray-500 mb-3">These advances have been paid out and will be repaid from future payouts.</p>
      <% if @outstanding_advances.any? %>
        <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Person</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Show</th>
                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Original</th>
                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Remaining</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Issued</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
              <% @outstanding_advances.each do |advance| %>
                <tr class="hover:bg-gray-50 cursor-pointer" onclick="window.location='<%= manage_money_advance_path(advance.production, advance) %>'">
                  <td class="px-4 py-3">
                    <div class="flex items-center gap-2">
                      <% if advance.person.safe_headshot_variant(:tiny) %>
                        <%= image_tag advance.person.safe_headshot_variant(:tiny), class: "w-8 h-8 rounded-lg object-cover" %>
                      <% else %>
                        <div class="w-8 h-8 rounded-lg bg-gray-200 flex items-center justify-center text-gray-600 text-xs font-medium">
                          <%= advance.person.initials %>
                        </div>
                      <% end %>
                      <span class="font-medium text-gray-900"><%= advance.person.name %></span>
                    </div>
                  </td>
                  <td class="px-4 py-3 text-sm text-gray-600">
                    <% if advance.show %>
                      <%= advance.show.date_and_time.strftime("%b %-d") %>
                    <% else %>
                      <span class="text-gray-400">General</span>
                    <% end %>
                  </td>
                  <td class="px-4 py-3 text-sm text-gray-900 text-right font-medium"><%= number_to_currency(advance.original_amount) %></td>
                  <td class="px-4 py-3 text-sm text-amber-600 text-right font-medium"><%= number_to_currency(advance.remaining_balance) %></td>
                  <td class="px-4 py-3">
                    <% if advance.status == "pending" %>
                      <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-amber-100 text-amber-800">Pending</span>
                    <% else %>
                      <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">Partial</span>
                    <% end %>
                  </td>
                  <td class="px-4 py-3 text-sm text-gray-500"><%= advance.issued_at.strftime("%b %-d, %Y") %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <div class="bg-gray-50 rounded-lg border border-dashed border-gray-300 p-8 text-center">
          <p class="text-gray-600">No outstanding advances to repay.</p>
        </div>
      <% end %>
    </div>

    <%# Repaid Advances %>
    <% if @repaid_advances.any? %>
      <div class="mb-8">
        <h3 class="text-lg font-semibold text-gray-900 mb-3">Recently Repaid</h3>
        <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Person</th>
                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Issued</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Repaid</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
              <% @repaid_advances.each do |advance| %>
                <tr class="hover:bg-gray-50">
                  <td class="px-4 py-3">
                    <span class="font-medium text-gray-900"><%= advance.person.name %></span>
                  </td>
                  <td class="px-4 py-3 text-sm text-green-600 text-right font-medium"><%= number_to_currency(advance.original_amount) %></td>
                  <td class="px-4 py-3 text-sm text-gray-500"><%= advance.issued_at.strftime("%b %-d") %></td>
                  <td class="px-4 py-3 text-sm text-gray-500"><%= advance.fully_repaid_at&.strftime("%b %-d") || "â€”" %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    <% end %>

  <% else %>
    <%# All Productions View %>
    <%= render partial: "shared/top_menu", locals: {
      breadcrumbs: [
        ["Money", manage_money_index_path],
        ["Payouts", manage_money_payouts_path]
      ],
      text: "Advances",
      links: []
    } %>

    <%# Org Summary Stats %>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="bg-white rounded-lg border border-gray-200 p-5">
        <div class="text-sm text-gray-500 mb-1">Unpaid</div>
        <div class="text-2xl font-semibold text-pink-600"><%= number_to_currency(@total_unpaid) %></div>
        <div class="text-xs text-gray-500"><%= @unpaid_count %> advance<%= @unpaid_count == 1 ? "" : "s" %> to pay out</div>
      </div>
      <div class="bg-white rounded-lg border border-gray-200 p-5">
        <div class="text-sm text-gray-500 mb-1">Outstanding</div>
        <div class="text-2xl font-semibold text-amber-600"><%= number_to_currency(@total_outstanding) %></div>
        <div class="text-xs text-gray-500"><%= @outstanding_count %> advance<%= @outstanding_count == 1 ? "" : "s" %> to repay</div>
      </div>
      <div class="bg-white rounded-lg border border-gray-200 p-5">
        <div class="text-sm text-gray-500 mb-1">Issued This Month</div>
        <div class="text-2xl font-semibold text-gray-900"><%= number_to_currency(@total_issued_this_month) %></div>
        <div class="text-xs text-gray-500">since <%= Date.current.beginning_of_month.strftime("%B 1") %></div>
      </div>
      <div class="bg-white rounded-lg border border-gray-200 p-5">
        <div class="text-sm text-gray-500 mb-1">Repaid</div>
        <div class="text-2xl font-semibold text-green-600"><%= @repaid_count %></div>
        <div class="text-xs text-gray-500">advances fully repaid</div>
      </div>
    </div>

    <%# Productions List %>
    <div class="">
      <% if @production_summaries.any? %>
        <div class="space-y-2">
          <% @production_summaries.each do |summary| %>
            <%= render "manage/advances/production_row", summary: summary %>
          <% end %>
        </div>
      <% else %>
        <div class="bg-gray-50 rounded-lg border border-dashed border-gray-300 p-8 text-center">
          <p class="text-gray-600">No productions yet.</p>
        </div>
      <% end %>
    </div>
  <% end %>
</div>
