<%
  # Calculate step number based on scope
  step_num = @wizard_state[:scope] == "shared_pool" ? 6 : 7
%>
<%= render layout: "manage/sign_up_form_wizard/wizard_layout", locals: { current_step: step_num, step_name: "Review" } do %>
  <h2 class="text-xl font-bold text-gray-900 mb-2 coustard-regular">Review & Create</h2>
  <p class="text-gray-600 mb-6">Review your sign-up form settings before creating it.</p>

  <%= form_with url: manage_sign_up_wizard_production_create_form_path(@production), method: :post, local: true do |form| %>
    <!-- Form Name -->
    <div class="mb-6">
      <label class="block text-sm font-medium text-gray-700 mb-1">Form Name</label>
      <input type="text" name="name"
             placeholder="<%= generate_default_name %>"
             class="block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-pink-500 focus:ring-pink-500">
      <p class="text-xs text-gray-500 mt-1">Leave blank to use the suggested name</p>
    </div>

    <!-- Settings Summary -->
    <div class="space-y-4">
      <!-- Scope -->
      <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
        <div class="flex justify-between items-start">
          <div>
            <h3 class="font-medium text-gray-900">Scope</h3>
            <p class="text-sm text-gray-600 mt-1">
              <% case @wizard_state[:scope] %>
              <% when 'single_event' %>
                Single Event
                <% if @selected_show %>
                  — <span class="text-pink-600"><%= @selected_show.name_with_date %></span>
                <% end %>
              <% when 'repeated' %>
                Repeated Event (separate registrations for each event)
              <% when 'shared_pool' %>
                General Waitlist (one sign-up list not tied to specific events)
              <% end %>
            </p>
          </div>
          <%= link_to "Edit", manage_sign_up_wizard_production_scope_path(@production), class: "text-sm text-pink-600 hover:text-pink-700" %>
        </div>
      </div>

      <!-- Events (for repeated scope) -->
      <% if @wizard_state[:scope] == 'repeated' %>
        <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
          <div class="flex justify-between items-start">
            <div>
              <h3 class="font-medium text-gray-900">Events</h3>
              <p class="text-sm text-gray-600 mt-1">
                <% case @wizard_state[:event_matching] %>
                <% when 'all' %>
                  All events in this production
                <% when 'event_types' %>
                  Events of type: <%= @wizard_state[:event_type_filter]&.map(&:humanize)&.join(', ') %>
                <% when 'manual' %>
                  <% if @selected_shows&.any? %>
                    <%= pluralize(@selected_shows.count, 'selected event') %>
                  <% else %>
                    Manually selected events
                  <% end %>
                <% end %>
              </p>
            </div>
            <%= link_to "Edit", manage_sign_up_wizard_production_events_path(@production), class: "text-sm text-pink-600 hover:text-pink-700" %>
          </div>
        </div>
      <% end %>

      <!-- Slots & Capacity -->
      <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
        <div class="flex justify-between items-start">
          <div>
            <h3 class="font-medium text-gray-900">Slots & Capacity</h3>
            <p class="text-sm text-gray-600 mt-1">
              <% case @wizard_state[:slot_generation_mode] %>
              <% when 'numbered' %>
                <%= @wizard_state[:slot_count] %> numbered slots (<%= @wizard_state[:slot_prefix] %> 1, <%= @wizard_state[:slot_prefix] %> 2, etc.)
                with <%= pluralize(@wizard_state[:slot_capacity], 'spot') %> each
              <% when 'time_based' %>
                <%= @wizard_state[:slot_count] %> time slots starting at <%= @wizard_state[:slot_start_time] %>,
                <%= @wizard_state[:slot_interval_minutes] %> minutes apart,
                with <%= pluralize(@wizard_state[:slot_capacity], 'spot') %> each
              <% when 'named' %>
                <%= pluralize(@wizard_state[:slot_names]&.length || 0, 'named slot') %>
                with <%= pluralize(@wizard_state[:slot_capacity], 'spot') %> each
              <% when 'open_list' %>
                Open list
                <% if @wizard_state[:open_list_limit] == 'unlimited' %>
                  (no limit)
                <% else %>
                  (max <%= @wizard_state[:open_list_capacity] || 20 %> people)
                <% end %>
              <% end %>
            </p>
          </div>
          <%= link_to "Edit", manage_sign_up_wizard_production_slots_path(@production), class: "text-sm text-pink-600 hover:text-pink-700" %>
        </div>
      </div>

      <!-- Rules -->
      <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
        <div class="flex justify-between items-start">
          <div>
            <h3 class="font-medium text-gray-900">Rules</h3>
            <ul class="text-sm text-gray-600 mt-1 space-y-1">
              <li>• <%= @wizard_state[:registrations_per_person] == 999 ? 'Unlimited' : @wizard_state[:registrations_per_person] %> registration(s) per person</li>
              <li>•
                <% case @wizard_state[:slot_selection_mode] %>
                <% when 'auto_assign' %>
                  Registrant automatically assigned to next available slot
                <% when 'admin_assigns' %>
                  Production team assigns registrants to slots
                <% else %>
                  Registrant chooses their slot
                <% end %>
              </li>
              <% if @wizard_state[:enable_holdbacks] && @wizard_state[:scope] != 'shared_pool' %>
                <li>• Every <%= @wizard_state[:holdback_interval] || 5 %> slot held back ("<%= @wizard_state[:holdback_label] || 'Hold for walk-ins' %>") - <%= @wizard_state[:holdback_visible] ? 'visible' : 'hidden' %> to registrants</li>
              <% end %>
              <li>• <%= @wizard_state[:require_login] ? 'Login required' : 'Guest sign-ups allowed' %></li>
              <% if @wizard_state[:allow_edit] %>
                <% if @wizard_state[:edit_cutoff_mode].present? && @wizard_state[:scope] != 'shared_pool' %>
                  <li>• Edits allowed
                    <% case @wizard_state[:edit_cutoff_mode] %>
                    <% when 'at_event' %>
                      (until event starts)
                    <% when 'before_event' %>
                      <%
                        edit_days = @wizard_state[:edit_cutoff_days] || 0
                        edit_hours = @wizard_state[:edit_cutoff_hours] || 0
                        edit_mins = @wizard_state[:edit_cutoff_minutes] || 0
                        edit_parts = []
                        edit_parts << "#{edit_days}d" if edit_days > 0
                        edit_parts << "#{edit_hours}h" if edit_hours > 0
                        edit_parts << "#{edit_mins}m" if edit_mins > 0
                      %>
                      (until <%= edit_parts.any? ? edit_parts.join(' ') : '0m' %> before event)
                    <% when 'after_event' %>
                      <%
                        edit_days = @wizard_state[:edit_cutoff_days] || 0
                        edit_hours = @wizard_state[:edit_cutoff_hours] || 0
                        edit_mins = @wizard_state[:edit_cutoff_minutes] || 0
                        edit_parts = []
                        edit_parts << "#{edit_days}d" if edit_days > 0
                        edit_parts << "#{edit_hours}h" if edit_hours > 0
                        edit_parts << "#{edit_mins}m" if edit_mins > 0
                      %>
                      (until <%= edit_parts.any? ? edit_parts.join(' ') : '0m' %> after event starts)
                    <% end %>
                  </li>
                <% else %>
                  <li>• Edits allowed</li>
                <% end %>
              <% else %>
                <li>• Edits not allowed</li>
              <% end %>
              <% if @wizard_state[:allow_cancel] %>
                <% if @wizard_state[:cancel_cutoff_mode].present? && @wizard_state[:scope] != 'shared_pool' %>
                  <li>• Cancellations allowed
                    <% case @wizard_state[:cancel_cutoff_mode] %>
                    <% when 'at_event' %>
                      (until event starts)
                    <% when 'before_event' %>
                      <%
                        cancel_days = @wizard_state[:cancel_cutoff_days] || 0
                        cancel_hours = @wizard_state[:cancel_cutoff_hours] || 0
                        cancel_mins = @wizard_state[:cancel_cutoff_minutes] || 0
                        cancel_parts = []
                        cancel_parts << "#{cancel_days}d" if cancel_days > 0
                        cancel_parts << "#{cancel_hours}h" if cancel_hours > 0
                        cancel_parts << "#{cancel_mins}m" if cancel_mins > 0
                      %>
                      (until <%= cancel_parts.any? ? cancel_parts.join(' ') : '0m' %> before event)
                    <% when 'after_event' %>
                      <%
                        cancel_days = @wizard_state[:cancel_cutoff_days] || 0
                        cancel_hours = @wizard_state[:cancel_cutoff_hours] || 0
                        cancel_mins = @wizard_state[:cancel_cutoff_minutes] || 0
                        cancel_parts = []
                        cancel_parts << "#{cancel_days}d" if cancel_days > 0
                        cancel_parts << "#{cancel_hours}h" if cancel_hours > 0
                        cancel_parts << "#{cancel_mins}m" if cancel_mins > 0
                      %>
                      (until <%= cancel_parts.any? ? cancel_parts.join(' ') : '0m' %> after event starts)
                    <% end %>
                  </li>
                <% else %>
                  <li>• Cancellations allowed</li>
                <% end %>
              <% else %>
                <li>• Cancellations not allowed</li>
              <% end %>
            </ul>
          </div>
          <%= link_to "Edit", manage_sign_up_wizard_production_rules_path(@production), class: "text-sm text-pink-600 hover:text-pink-700" %>
        </div>
      </div>

      <!-- Schedule -->
      <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
        <div class="flex justify-between items-start">
          <div>
            <h3 class="font-medium text-gray-900"><%= @wizard_state[:scope] == 'shared_pool' ? 'Activation' : 'Schedule' %></h3>
            <p class="text-sm text-gray-600 mt-1">
              <% if @wizard_state[:scope] == 'shared_pool' %>
                <% if @wizard_state[:opens_at].present? %>
                  Activates: <%= @wizard_state[:opens_at].is_a?(String) ? Time.parse(@wizard_state[:opens_at]).strftime('%b %-d, %Y at %-l:%M %p') : @wizard_state[:opens_at].strftime('%b %-d, %Y at %-l:%M %p') rescue @wizard_state[:opens_at] %>
                <% else %>
                  Activates immediately
                <% end %>
              <% elsif @wizard_state[:schedule_mode] == 'relative' %>
                <%
                  opens_days = @wizard_state[:opens_days_before] || 7
                  opens_hours = @wizard_state[:opens_hours_before] || 0
                  opens_mins = @wizard_state[:opens_minutes_before] || 0
                  closes_mode = @wizard_state[:closes_mode] || 'event_start'
                  closes_days = @wizard_state[:closes_offset_days] || 0
                  closes_hours = @wizard_state[:closes_offset_hours] || 0
                  closes_mins = @wizard_state[:closes_minutes_offset] || 0
                  closes_before_after = @wizard_state[:closes_before_after] || 'after'
                %>
                Opens
                <% parts = [] %>
                <% parts << "#{opens_days} day#{'s' if opens_days != 1}" if opens_days > 0 %>
                <% parts << "#{opens_hours} hour#{'s' if opens_hours != 1}" if opens_hours > 0 %>
                <% parts << "#{opens_mins} minute#{'s' if opens_mins != 1}" if opens_mins > 0 %>
                <% if parts.empty? %>
                  at event time
                <% else %>
                  <%= parts.join(', ') %> before each event
                <% end %>,
                <% if closes_mode == 'never' %>
                  stays open until manually closed
                <% elsif closes_mode == 'event_start' %>
                  closes when event starts
                <% else %>
                  <% close_parts = [] %>
                  <% close_parts << "#{closes_days} day#{'s' if closes_days != 1}" if closes_days > 0 %>
                  <% close_parts << "#{closes_hours} hour#{'s' if closes_hours != 1}" if closes_hours > 0 %>
                  <% close_parts << "#{closes_mins} minute#{'s' if closes_mins != 1}" if closes_mins > 0 %>
                  closes <%= close_parts.any? ? close_parts.join(', ') : '0 hours' %> <%= closes_before_after %> event
                <% end %>
              <% else %>
                <% if @wizard_state[:opens_at].present? %>
                  Opens: <%= @wizard_state[:opens_at].is_a?(String) ? Time.parse(@wizard_state[:opens_at]).strftime('%b %-d, %Y at %-l:%M %p') : @wizard_state[:opens_at].strftime('%b %-d, %Y at %-l:%M %p') rescue @wizard_state[:opens_at] %>
                <% else %>
                  Opens immediately
                <% end %>
                <br>
                <% if @wizard_state[:closes_at].present? %>
                  Closes: <%= @wizard_state[:closes_at].is_a?(String) ? Time.parse(@wizard_state[:closes_at]).strftime('%b %-d, %Y at %-l:%M %p') : @wizard_state[:closes_at].strftime('%b %-d, %Y at %-l:%M %p') rescue @wizard_state[:closes_at] %>
                <% else %>
                  No closing date
                <% end %>
              <% end %>
            </p>
          </div>
          <%= link_to "Edit", manage_sign_up_wizard_production_schedule_path(@production), class: "text-sm text-pink-600 hover:text-pink-700" %>
        </div>
      </div>

      <!-- Notifications -->
      <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
        <div class="flex justify-between items-start">
          <div>
            <h3 class="font-medium text-gray-900">Notifications</h3>
            <p class="text-sm text-gray-600 mt-1">
              <% if @wizard_state[:notify_on_registration] %>
                Team will be notified when someone registers
              <% else %>
                No notifications on registration
              <% end %>
            </p>
          </div>
          <%= link_to "Edit", manage_sign_up_wizard_production_notifications_path(@production), class: "text-sm text-pink-600 hover:text-pink-700" %>
        </div>
      </div>
    </div>

    <div class="mt-8 flex justify-between">
      <%= link_to manage_sign_up_wizard_production_notifications_path(@production), class: "inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-900" do %>
        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Back
      <% end %>
      <%= render "shared/button", text: "Create Sign-Up Form", variant: "primary", size: "medium", type: :submit %>
    </div>
  <% end %>
<% end %>
