<% content_for :title, "Run Auditions - Auditions" %>

<div class="w-full mb-10">
  <%= render partial: "shared/notice", locals: { notice: notice } %>
  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [
      ["Sign-ups", manage_signups_path],
      [@production.name, manage_signups_production_path(@production)],
      ["Auditions", manage_signups_auditions_path(@production)]
    ],
    text: "Run Auditions",
    links: []
  } %>

  <%= render partial: "lifecycle_panel", locals: { current_step: :run } %>

  <%= render partial: "archived_banner" %>

  <% if @audition_cycle.blank? %>
    <div class="mb-5 text-gray-500 text-sm">
      You aren't currently offering auditions for <%= @production.name %>
    </div>
  <% else %>
    <% audition_cycle = @audition_cycle %>

    <% if audition_cycle.accepts_in_person_auditions? %>
      <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden mb-6">
        <%= render "shared/card_header", title: "Audition Sessions" %>
        <div class="p-6">
        <p class="text-sm text-gray-500 mb-6">View and manage your in-person audition sessions.</p>

        <% if @audition_cycle.audition_sessions.any? %>
          <div class="space-y-3 mb-6">
            <% @audition_cycle.audition_sessions.order(:start_at).each do |session| %>
              <%= render partial: "manage/audition_sessions/session_row", locals: { session: session, production: @production, audition_cycle: @audition_cycle } %>
            <% end %>
          </div>

          <div class="flex items-center justify-end">
            <% if current_user_has_role?(@production) %>
              <div class="flex items-center gap-4 px-4 py-2 bg-gray-50 border border-gray-200 rounded">
                <div class="flex items-center gap-2">
                  <% if @audition_cycle.audition_voting_enabled %>
                    <span class="relative flex h-3 w-3">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                    </span>
                    <span class="text-sm font-semibold text-green-700">Voting Live</span>
                  <% else %>
                    <span class="relative flex h-3 w-3">
                      <span class="relative inline-flex rounded-full h-3 w-3 bg-gray-400"></span>
                    </span>
                    <span class="text-sm font-semibold text-gray-500">Voting Paused</span>
                  <% end %>
                  <% if @audition_cycle.audition_voting_enabled %>
                    <span class="text-sm text-gray-500">(<%= @audition_cycle.reviewer_count %> <%= 'reviewer'.pluralize(@audition_cycle.reviewer_count) %>)</span>
                  <% end %>
                </div>
                <label class="flex items-center gap-2 cursor-pointer"
                       data-controller="toggle-voting"
                       data-toggle-voting-cycle-id-value="<%= @audition_cycle.id %>"
                       data-toggle-voting-enabled-value="<%= @audition_cycle.audition_voting_enabled %>"
                       data-toggle-voting-url-value="<%= manage_toggle_voting_signups_auditions_cycle_path(@production, @audition_cycle) %>"
                       data-toggle-voting-voting-type-value="audition">
                  <div class="relative inline-block w-10 h-6 transition duration-200 ease-in-out">
                    <input type="checkbox"
                           <%= 'checked' if @audition_cycle.audition_voting_enabled %>
                           data-action="change->toggle-voting#confirm"
                           class="sr-only peer">
                    <div class="block w-10 h-6 rounded-full <%= @audition_cycle.audition_voting_enabled ? 'bg-pink-500' : 'bg-gray-300' %> peer-focus:ring-2 peer-focus:ring-pink-300"></div>
                    <div class="absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition-transform <%= @audition_cycle.audition_voting_enabled ? 'translate-x-4' : 'translate-x-0' %>"></div>
                  </div>
                </label>
              </div>
            <% end %>
          </div>

        <% else %>
          <p class="text-gray-500 text-sm mb-4">No audition sessions have been scheduled yet.</p>
          <%= render partial: "shared/button", locals: { text: "Schedule Auditions", path: manage_signups_auditions_cycle_sessions_path(@production, @audition_cycle), variant: "primary" } %>
        <% end %>
        </div>
      </div>
    <% end %>
    <% if audition_cycle.video_only? %>
      <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden">
        <%= render "shared/card_header", title: "Video Upload Auditions" %>
        <div class="p-6">
        <p class="text-gray-600 mb-4">Auditionees have submitted their video uploads. Review their submissions.</p>

        <div class="bg-gray-50 rounded-lg p-4">
          <p class="text-gray-700 font-semibold mb-2">Total Submissions: <span class="text-lg"><%= audition_cycle.audition_requests.count %></span></p>
          <p class="text-sm text-gray-600">Video auditions don't require in-person sessions.</p>
        </div>
        </div>
      </div>
    <% end %>

  <% end %>
</div>
