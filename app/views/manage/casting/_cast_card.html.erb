<%
  # Parameters:
  # - show: the Show object
  # - title: optional string to override the date/time in the title bar (e.g., "Cast")
  # - production: the Production object
  # - roles: (optional) preloaded roles array
  # - roles_count: (optional) preloaded roles count
  # - people_by_id: (optional) preloaded people hash
  # - groups_by_id: (optional) preloaded groups hash

  # Use preloaded data if available, otherwise fall back to queries
  roles = local_assigns[:roles] || @roles || show.production.roles.order(:position).to_a
  roles_count = local_assigns[:roles_count] || @roles_count || roles.size
  people_by_id = local_assigns[:people_by_id] || @people_by_id || {}
  groups_by_id = local_assigns[:groups_by_id] || @groups_by_id || {}

  cast_count = show.show_person_role_assignments.size
  percentage = roles_count > 0 ? (cast_count.to_f / roles_count * 100).round : 0

  # Cache key includes show, assignments, and roles timestamps
  cast_card_cache_key = [
    "cast_card_v1",
    show.id,
    show.updated_at.to_i,
    show.show_person_role_assignments.maximum(:updated_at)&.to_i,
    production.roles.maximum(:updated_at)&.to_i,
    title.presence || "default"
  ]
%>

<% cache cast_card_cache_key do %>
<div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
  <!-- Title Bar -->
  <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 flex items-center justify-between">
    <h3 class="text-sm font-semibold text-gray-900">
      <%= title.present? ? title : show.date_and_time&.strftime("%A, %b %d, %Y at %l:%M %p") %>
    </h3>
    <div class="flex-shrink-0 text-right">
      <span class="text-sm font-bold <%= percentage == 100 ? 'text-green-600' : 'text-pink-600' %>">
        <%= cast_count %>/<%= roles_count %> roles cast
      </span>
    </div>
  </div>

  <!-- Content -->
  <div class="p-4">
    <!-- Event Type Badge and Secondary Name (only shown when title is not provided) -->
    <% if title.blank? %>
      <div class="flex items-center gap-2 mb-3 flex-wrap">
        <% event_type_badge_classes = case show.event_type
          when "rehearsal" then "bg-blue-50 text-blue-700 ring-blue-600/10"
          when "meeting" then "bg-green-50 text-green-700 ring-green-600/10"
          else "bg-pink-50 text-pink-700 ring-pink-600/10"
        end %>
        <span class="inline-flex items-center rounded-md px-1.5 py-0.5 text-xs font-medium ring-1 ring-inset <%= event_type_badge_classes %>">
          <%= show.event_type.titleize %>
        </span>
        <% if show.secondary_name.present? %>
          <span class="text-xs text-gray-600"><%= show.secondary_name %></span>
        <% end %>
      </div>
    <% end %>

    <!-- Progress Bar -->
    <div class="w-full bg-gray-200 rounded-full h-2 mb-3">
      <div class="<%= percentage == 100 ? 'bg-green-500' : 'bg-pink-500' %> h-2 rounded-full transition-all" style="width: <%= percentage %>%"></div>
    </div>

    <!-- Cast Members by Role -->
    <% if roles.any? %>
      <div class="flex flex-wrap gap-2 mb-3">
        <% roles.each do |role| %>
          <% assignment = show.show_person_role_assignments.find { |a| a.role_id == role.id } %>
          <% if assignment %>
            <%
              # Get assignable from preloaded hash or fall back to association
              assignable = if assignment.assignable_type == "Person"
                people_by_id[assignment.assignable_id] || assignment.assignable
              else
                groups_by_id[assignment.assignable_id] || assignment.assignable
              end
            %>
            <%
              # Build link path based on type
              link_path = if assignable.is_a?(Person)
                manage_person_path(assignable)
              elsif assignable.is_a?(Group)
                manage_group_path(assignable)
              end
            %>
            <%= link_to link_path, class: "block" do %>
              <% headshot_variant = assignable.safe_headshot_variant(:thumb) %>
              <% if headshot_variant %>
                <%= image_tag headshot_variant,
                    alt: assignable.name,
                    class: "w-12 h-12 rounded-lg object-cover shadow-sm hover:ring-2 hover:ring-pink-500 transition-all",
                    data: { controller: "tooltip", tooltip_text: "#{assignable.name} - #{role.name}" } %>
              <% else %>
                <div class="w-12 h-12 rounded-lg bg-gray-300 flex items-center justify-center text-gray-700 font-bold text-xs shadow-sm hover:ring-2 hover:ring-pink-500 transition-all"
                     data-controller="tooltip"
                     data-tooltip-text="<%= "#{assignable.name} - #{role.name}" %>">
                  <%= assignable.initials %>
                </div>
              <% end %>
            <% end %>
          <% else %>
            <%= link_to manage_production_show_cast_path(production, show), class: "block" do %>
              <div class="w-12 h-12 rounded-lg border-2 border-dashed border-gray-300 bg-gray-50 flex items-center justify-center text-gray-400 text-xs shadow-sm hover:border-pink-400 hover:bg-pink-50 transition-all"
                   data-controller="tooltip"
                   data-tooltip-text="<%= "#{role.name} - Not Cast" %>">
                +
              </div>
            <% end %>
          <% end %>
        <% end %>
      </div>
    <% else %>
      <p class="text-xs text-gray-400 italic mb-3">No roles defined yet</p>
    <% end %>
  </div>

  <!-- Footer Links -->
  <div class="bg-gray-50 px-4 py-2 border-t border-gray-200 flex gap-2 text-xs">
    <%= link_to "Manage Cast", manage_production_show_cast_path(production, show), class: "text-pink-500 underline" %>
    <%= link_to "Contact Cast", manage_production_show_contact_cast_path(production, show), class: "text-pink-500 underline" %>
  </div>
</div>
<% end %>
