<% content_for :title, @original_show.present? ? "Duplicate Show or Event" : "Schedule Shows & Events" %>

<div class="w-full" data-controller="location-modal">

  <%= render partial: "shared/notice", locals: { notice: notice } %>

  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [
      ["Shows & Events", manage_production_shows_path(@production)]
    ],
    text: @original_show.present? ? "Duplicate Show or Event" : "Schedule Shows & Events",
    links: []
  } %>

  <%= render "shared/help_section",
    title: "How to Schedule Shows & Events",
    initial_state: "closed",
    storage_key: "shows_new_help_collapsed",
    steps: [
      { text: "<strong>Event Type:</strong> Choose whether you're scheduling a show, rehearsal, meeting, or other event type." },
      { text: "<strong>Single vs Recurring:</strong> Create a single event for one date/time, or set up a recurring pattern to automatically create multiple events." },
      { text: "<strong>Duplicate:</strong> When duplicating an existing event, all settings (location, poster, etc.) are copied to save you time." },
      { text: "<strong>Optional Settings:</strong> Add a secondary name, upload a poster image, and include additional notes for any event type." }
    ] %>

  <% if @original_show.present? %>
    <div class="bg-pink-50 border-l-4 border-pink-400 p-4 mb-4">
      <div class="flex">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-pink-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a.75.75 0 000 1.5h.253a.25.25 0 01.244.304l-.459 2.066A1.75 1.75 0 0010.747 15H11a.75.75 0 000-1.5h-.253a.25.25 0 01-.244-.304l.459-2.066A1.75 1.75 0 009.253 9H9z" clip-rule="evenodd" />
          </svg>
        </div>
        <div class="ml-3">
          <p class="text-sm text-pink-700">
            You're duplicating "<strong><%= @original_show.event_type.titleize %><%= @original_show.secondary_name.present? ? ": #{@original_show.secondary_name}" : "" %></strong>" from <%= @original_show.date_and_time.strftime("%B %-d, %Y at %-I:%M %p") %>. All settings have been copied. Update the date/time and any other details as needed.
          </p>
        </div>
      </div>
    </div>
  <% end %>

  <% if @needs_confirmation %>
    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
      <div class="flex">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 9a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
          </svg>
        </div>
        <div class="ml-3">
          <h3 class="text-sm font-medium text-yellow-800">
            Same Date Detected
          </h3>
          <div class="mt-2 text-sm text-yellow-700">
            <p>You're creating a <%= @show.event_type.titleize %> with the same date (<%= @show.date_and_time.strftime("%B %-d, %Y") %>) as the one you're duplicating. Is this intentional?</p>
          </div>
          <div class="mt-4 flex gap-3">
            <%= form_with(model: [:manage, @production, @show], class: "inline") do |f| %>
              <%= f.hidden_field :event_type, value: @show.event_type %>
              <%= f.hidden_field :secondary_name, value: @show.secondary_name %>
              <%= f.hidden_field :date_and_time, value: @show.date_and_time %>
              <%= f.hidden_field :location_id, value: @show.location_id %>
              <%= f.hidden_field :event_frequency, value: "single" %>
              <%= hidden_field_tag :duplicate_from_id, @original_show.id %>
              <%= hidden_field_tag :confirm_same_date, "true" %>
              <%= f.submit "Yes, Create with Same Date", class: "inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-yellow-600 hover:bg-yellow-700 cursor-pointer" %>
            <% end %>
            <button type="button" onclick="window.scrollTo(0, document.body.scrollHeight);" class="inline-flex items-center px-3 py-2 border border-gray-300 text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
              No, Let Me Change the Date
            </button>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <%= form_with(model: [:manage, @production, @show], class: "contents", data: { controller: "recurring-event show-edit" }) do |form| %>
    <%= hidden_field_tag :duplicate_from_id, params[:duplicate] if params[:duplicate].present? %>

    <% if @show.errors.any? %>
      <div id="error_explanation" class="bg-red-50 text-red-500 px-3 py-2 font-medium rounded-lg mt-3">
        <h2><%= pluralize(show.errors.count, "error") %> prohibited this show from being saved:</h2>

        <ul class="list-disc ml-6">
          <% @show.errors.each do |error| %>
            <li><%= error.full_message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="w-full sm:flex sm:space-x-5">
      <div class="w-full sm:w-1/2">
      <%= form.label :event_type, "Event Type" %>
      <%= form.select :event_type,
        Show.event_types.keys.map { |type| [type.titleize, type] },
        { include_blank: false },
        {
          class: ["block shadow-sm rounded-lg border px-3 py-2 mt-2 w-full", {"border-gray-400": @show.errors[:event_type].none?, "border-pink-500": @show.errors[:event_type].any?}],
          data: {
          recurring_event_target: "eventTypeSelect",
          show_edit_target: "eventTypeSelect",
          action: "change->recurring-event#updateButtonText change->show-edit#eventTypeChanged"
          }
        }
      %>
      </div>

      <div class="w-full sm:w-1/2 mt-5 sm:mt-0">
        <%= form.label :location_id, "Location" %>
        <%= form.collection_select :location_id, Current.organization.locations.all, :id, :name, { prompt: "Select a location" }, {
          class: ["block shadow-sm rounded-lg border px-3 py-2 mt-2 w-full", ( @show.errors[:location_id].any? ? "border-pink-500" : "border-gray-400" )],
          required: true,
          data: {
            "location-modal-target": "locationSelect",
            action: "change->location-modal#handleLocationChange"
          }
        } %>
        <div class="mt-1 ml-1">
          <a href="#" data-action="click->location-modal#openModal" class="text-pink-500 underline text-sm">Add a Location</a>
        </div>
      </div>
    </div>

    <div class="mt-5 border border-gray-200 rounded-lg overflow-hidden">
      <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 flex items-center justify-between">
          <h3 class="text-md font-semibold text-gray-900 coustard-regular">Schedule</h3>
      </div>
      <div class="p-4">
        <div class="mb-4">
          <%= form.label :event_frequency, "Event Frequency" %>
          <%= form.select :event_frequency,
              [
                ["Single Event", "single"],
                ["Recurring Event", "recurring"]
              ],
              { selected: "single" },
              {
                class: "block shadow-sm rounded-lg border border-gray-400 px-3 py-2 mt-2 w-full sm:w-64",
                data: { action: "change->recurring-event#toggle" }
              }
          %>
        </div>

        <!-- Single Event Fields -->
        <div data-recurring-event-target="singleFields">
          <%= form.label :date_and_time, "Date and Time" %>
          <%= form.datetime_field :date_and_time, class: ["block shadow-sm rounded-lg border px-3 py-2 mt-2 w-full sm:w-64", {"border-gray-400": @show.errors[:date_and_time].none?, "border-pink-500": @show.errors[:date_and_time].any?}] %>
        </div>

        <!-- Recurring Event Fields -->
        <div data-recurring-event-target="recurringFields" class="hidden space-y-4">
          <div>
            <%= form.label :recurrence_start_datetime, "Start Date and Time" %>
            <%= form.datetime_field :recurrence_start_datetime,
                class: "block shadow-sm rounded-lg border border-gray-400 px-3 py-2 mt-2 w-full sm:w-64",
                data: { action: "change->recurring-event#updatePatternOptions" } %>
          </div>

          <div>
            <%= form.label :recurrence_pattern, "Repeat Pattern" %>
            <%= form.select :recurrence_pattern,
                [
                  ["Weekly (same day each week)", "weekly"],
                  ["Every other week", "biweekly"],
                  ["Monthly (same date each month)", "monthly_date"],
                  ["Monthly (same week and day)", "monthly_week"]
                ],
                { include_blank: "Select pattern" },
                {
                  class: "block shadow-sm rounded-lg border border-gray-400 px-3 py-2 mt-2 w-full sm:w-96",
                  data: { recurring_event_target: "patternSelect" }
                }
            %>
          </div>
          <div>
            <%= form.label :recurrence_end_type, "Duration" %>
            <%= form.select :recurrence_end_type,
                [
                  ["3 Months", "3_months"],
                  ["6 Months", "6_months"],
                  ["12 Months", "12_months"],
                  ["Until End of #{Date.current.year}", "end_of_year"],
                  ["Until Specific Date", "custom"]
                ],
                { include_blank: "Select duration" },
                {
                  class: "block shadow-sm rounded-lg border border-gray-400 px-3 py-2 mt-2 w-full sm:w-96",
                  data: { action: "change->recurring-event#toggleCustomEndDate" }
                }
            %>
          </div>

          <div data-recurring-event-target="customEndDateField" class="hidden">
            <%= form.label :recurrence_custom_end_date, "End Date" %>
            <%= form.date_field :recurrence_custom_end_date, class: "block shadow-sm rounded-lg border border-gray-400 px-3 py-2 mt-2 w-full sm:w-64" %>
          </div>
        </div>
      </div>
    </div>

    <!-- Casting Settings -->
    <div class="mt-5 border border-gray-200 rounded-lg overflow-hidden">
      <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
        <h3 class="text-md font-semibold text-gray-900 coustard-regular">Casting Settings</h3>
      </div>
      <div class="p-4">
        <label class="flex items-start gap-3 cursor-pointer">
          <%= form.check_box :casting_enabled,
            class: "mt-1 rounded accent-pink-500 border-gray-300 text-pink-600 focus:ring-pink-500",
            data: {
              show_edit_target: "castingEnabledCheckbox",
              action: "change->show-edit#castingCheckboxChanged"
            } %>
          <div>
            <div class="font-medium text-gray-900">Enable casting for this event</div>
            <div class="text-sm text-gray-500">When enabled, you can assign cast members to roles for this event. Shows default to enabled, while rehearsals and meetings default to disabled.</div>
          </div>
        </label>
      </div>
    </div>

    <div data-controller="show-toggle" data-show-toggle-initial-open-value="false" class="mt-5 border border-gray-200 rounded-lg overflow-hidden">
      <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 flex items-center justify-between cursor-pointer" data-action="click->show-toggle#toggle">
          <h3 class="text-md font-semibold text-gray-900 coustard-regular" data-show-edit-target="sectionTitle">Optional <%= (@show.event_type || 'Show').titleize %> Settings</h3>
          <div data-show-toggle-target="icon"></div>
      </div>
      <div data-show-toggle-target="content" class="p-4">

        <div>
          <%= form.label :secondary_name %>
          <div class="text-sm text-gray-500">(eg. If the show on this particular date has a sub-name or special name to go along with the Production name)</div>
          <%= form.text_field :secondary_name, class: ["w-full shadow-sm rounded-lg border px-3 py-2 mt-2", {"border-gray-400": @show.errors[:secondary_name].none?, "border-pink-500": @show.errors[:secondary_name].any?}] %>
        </div>

        <% if @show.poster.attached? %>
          <div class="text-md mt-5">Show/Event Poster</div>
          <div class="my-2 flex p-4 border border-gray-200 rounded-lg hover:border-gray-400 hover:shadow-sm transition-all items-top max-w-md">
              <div class="w-full">

                  <% if @show.poster.attached? %>
                      <div class="mb-4">
                          <%= image_tag url_for(@show.poster), class: "rounded shadow w-full max-w-72 rounded-lg border border-gray-200" %>
                      </div>
                  <% end %>

                  <div class="flex items-center justify-between">
                    <%= form.label :image, "Update Show/Event Poster:", class: "text-sm" %>
                    <span class="text-sm text-gray-500">(JPEG, JPG, or PNG)</span>
                  </div>

                  <div class="block shadow-sm rounded-lg border px-3 py-2 mt-2 border-gray-400">
                      <%= form.file_field :poster, class: "w-64 text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:text-white file:bg-pink-500 hover:file:bg-pink-600" %>
                  </div>

              </div>
          </div>
        <% else %>
          <div class="text-md mt-5">Show/Event Poster</div>
          <div class="mr-5 inline-block">

              <div class="flex items-center justify-between">
                <span class="text-sm text-gray-500">(JPEG, JPG, or PNG)</span>
              </div>

              <div class="block shadow-sm rounded-lg border px-3 py-2 mt-2 border-gray-400">
                  <%= form.file_field :poster, class: "w-64 text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:text-white file:bg-pink-500 hover:file:bg-pink-600" %>
              </div>

          </div>
        <% end %>

        <div class="mt-5" data-controller="show-links">
          <label>Show/Event Links</label>
          <div class="text-sm text-gray-500 mb-2">Add links related to this show (e.g. ticketing, event page, social media posts, etc.)</div>
          <div id="show-links-fields" data-show-links-target="list" class="mt-1">
            <%= form.fields_for :show_links do |show_link_form| %>
              <div class="flex items-start gap-2 mb-2 show-links-fields-row" data-show-links-target="row">
                <%= show_link_form.hidden_field :id %>
                <%= show_link_form.hidden_field :_destroy, value: "0", class: "destroy-flag" %>
                <div class="flex-1 flex flex-col sm:flex-row gap-2">
                  <%= show_link_form.text_field :text, placeholder: "Link Text (e.g. Buy Tickets, Event Page)", class: "flex-1 shadow-sm rounded-lg border px-3 py-2 border-gray-400" %>
                  <%= show_link_form.text_field :url, placeholder: "URL", class: "flex-1 shadow-sm rounded-lg border px-3 py-2 border-gray-400" %>
                </div>
                <%= link_to "Remove", '#', class: "remove-show-link text-pink-500 underline text-sm whitespace-nowrap mt-2", data: { action: "show-links#remove" } %>
              </div>
            <% end %>
          </div>
          <%= link_to "Add Show/Event Link", '#', class: "text-pink-500 underline text-sm", data: { action: "show-links#add" } %>
          <template data-show-links-target="template">
            <div class="flex items-start gap-2 mb-2 show-links-fields-row" data-show-links-target="row">
              <input type="hidden" name="show[show_links_attributes][new_show_links][id]" />
              <input type="hidden" name="show[show_links_attributes][new_show_links][_destroy]" value="0" class="destroy-flag" />
              <div class="flex-1 flex flex-col sm:flex-row gap-2">
                <input type="text" name="show[show_links_attributes][new_show_links][text]" placeholder="Link Text (e.g. Buy Tickets, Event Page)" class="flex-1 shadow-sm rounded-lg border px-3 py-2 border-gray-400" />
                <input type="text" name="show[show_links_attributes][new_show_links][url]" placeholder="URL" class="flex-1 shadow-sm rounded-lg border px-3 py-2 border-gray-400" />
              </div>
              <a href="#" class="remove-show-link text-pink-500 underline text-sm whitespace-nowrap mt-2" data-action="show-links#remove">Remove</a>
            </div>
          </template>
        </div>

      </div>
    </div>

    <div class="border-t border-gray-200 pt-5 mt-5">
      <%= render "shared/button", text: "Schedule Show", variant: "primary", size: "medium", type: :submit, data: { recurring_event_target: "submitButton" } %>
      <%= render "shared/button", text: "Back", variant: "ghost-cancel", size: "medium", path: "javascript:history.back()", type: :button %>
    </div>

  <% end %>

  <!-- Location Modal -->
  <div id="locationModal" data-location-modal-target="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between">
        <h2 class="text-2xl font-semibold coustard-regular">Add a Location</h2>
        <button type="button" data-action="click->location-modal#closeModal" class="text-gray-500 hover:text-gray-700">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <div class="px-6 py-6">
        <form data-location-modal-target="form" action="<%= manage_locations_path %>" method="post" data-action="submit->location-modal#submitForm">
          <div data-location-modal-target="errorContainer" class="hidden bg-pink-50 px-3 py-2 font-medium rounded-md mb-4">
            <h2 data-location-modal-target="errorCount"></h2>
            <ul data-location-modal-target="errorList" class="list-disc ml-6"></ul>
          </div>

          <%= hidden_field_tag :authenticity_token, form_authenticity_token %>

          <div>
            <label for="location_name">Name</label>
            <div class="text-gray-500 text-sm mb-1">The name of the location that will be displayed to users.</div>
            <input type="text" id="location_name" name="location[name]" value="" class="block shadow-sm rounded-md border px-3 py-2 mt-2 w-full border-gray-400" />
          </div>

          <div class="mt-10">
            <%= render partial: "shared/top_menu", locals: {
              breadcrumbs: [],
              text: "Address",
              links: []
            } %>

            <div class="my-5">
              <label for="location_address1">Street Address Line 1</label>
              <input type="text" id="location_address1" name="location[address1]" value="" class="block shadow-sm rounded-md border px-3 py-2 mt-2 w-full border-gray-400" />
            </div>

            <div class="my-5">
              <label for="location_address2">Street Address Line 2</label>
              <span class="text-sm text-gray-500">(optional)</span>
              <input type="text" id="location_address2" name="location[address2]" value="" class="block shadow-sm rounded-md border px-3 py-2 mt-2 w-full border-gray-400" />
            </div>

            <div class="my-5">
              <label for="location_city">City</label>
              <input type="text" id="location_city" name="location[city]" value="" class="block shadow-sm rounded-md border px-3 py-2 mt-2 w-full border-gray-400" />
            </div>

            <div class="my-5 flex flex-wrap gap-4">
              <div class="w-full md:w-[calc(50%-8px)]">
                <label for="location_state">State/Province</label>
                <select id="location_state" name="location[state]" class="block shadow-sm rounded-md border px-3 py-2 mt-2 w-full border-gray-400">
                  <option value="">Select State/Province</option>
                  <option value="AL">Alabama</option>
                  <option value="AK">Alaska</option>
                  <option value="AZ">Arizona</option>
                  <option value="AR">Arkansas</option>
                  <option value="CA">California</option>
                  <option value="CO">Colorado</option>
                  <option value="CT">Connecticut</option>
                  <option value="DE">Delaware</option>
                  <option value="DC">District of Columbia</option>
                  <option value="FL">Florida</option>
                  <option value="GA">Georgia</option>
                  <option value="HI">Hawaii</option>
                  <option value="ID">Idaho</option>
                  <option value="IL">Illinois</option>
                  <option value="IN">Indiana</option>
                  <option value="IA">Iowa</option>
                  <option value="KS">Kansas</option>
                  <option value="KY">Kentucky</option>
                  <option value="LA">Louisiana</option>
                  <option value="ME">Maine</option>
                  <option value="MD">Maryland</option>
                  <option value="MA">Massachusetts</option>
                  <option value="MI">Michigan</option>
                  <option value="MN">Minnesota</option>
                  <option value="MS">Mississippi</option>
                  <option value="MO">Missouri</option>
                  <option value="MT">Montana</option>
                  <option value="NE">Nebraska</option>
                  <option value="NV">Nevada</option>
                  <option value="NH">New Hampshire</option>
                  <option value="NJ">New Jersey</option>
                  <option value="NM">New Mexico</option>
                  <option value="NY">New York</option>
                  <option value="NC">North Carolina</option>
                  <option value="ND">North Dakota</option>
                  <option value="OH">Ohio</option>
                  <option value="OK">Oklahoma</option>
                  <option value="OR">Oregon</option>
                  <option value="PA">Pennsylvania</option>
                  <option value="RI">Rhode Island</option>
                  <option value="SC">South Carolina</option>
                  <option value="SD">South Dakota</option>
                  <option value="TN">Tennessee</option>
                  <option value="TX">Texas</option>
                  <option value="UT">Utah</option>
                  <option value="VT">Vermont</option>
                  <option value="VA">Virginia</option>
                  <option value="WA">Washington</option>
                  <option value="WV">West Virginia</option>
                  <option value="WI">Wisconsin</option>
                  <option value="WY">Wyoming</option>
                  <option value="">--- Canadian Provinces ---</option>
                  <option value="AB">Alberta</option>
                  <option value="BC">British Columbia</option>
                  <option value="MB">Manitoba</option>
                  <option value="NB">New Brunswick</option>
                  <option value="NL">Newfoundland and Labrador</option>
                  <option value="NT">Northwest Territories</option>
                  <option value="NS">Nova Scotia</option>
                  <option value="NU">Nunavut</option>
                  <option value="ON">Ontario</option>
                  <option value="PE">Prince Edward Island</option>
                  <option value="QC">Quebec</option>
                  <option value="SK">Saskatchewan</option>
                  <option value="YT">Yukon</option>
                </select>
              </div>

              <div class="w-full md:w-[calc(50%-8px)]">
                <label for="location_postal_code">Zip/Postal Code</label>
                <input type="text" id="location_postal_code" name="location[postal_code]" maxlength="10" value="" class="block shadow-sm rounded-md border px-3 py-2 mt-2 w-full border-gray-400" />
              </div>
            </div>
          </div>

          <div class="mt-10">
            <%= render partial: "shared/top_menu", locals: {
              breadcrumbs: [],
              text: "Notes/Instructions",
              links: []
            } %>

            <div class="my-5">
              <label for="location_notes">Notes</label>
              <div class="text-gray-500 text-sm mb-1">Any additional information about this location, such as parking instructions, entry details, etc.</div>
              <textarea id="location_notes" name="location[notes]" rows="4" class="block shadow-sm rounded-md border px-3 py-2 mt-2 w-full border-gray-400"></textarea>
            </div>
          </div>

          <div class="flex gap-2 pt-6">
            <%= render "shared/button", text: "Add Location", variant: "primary", size: "medium", type: :submit %>
            <%= render "shared/button", text: "Cancel", variant: "ghost-cancel", size: "medium", type: :button, data: { action: "click->location-modal#closeModal" } %>
          </div>
        </form>
      </div>
    </div>
  </div>

</div>
