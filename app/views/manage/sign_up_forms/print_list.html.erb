<% content_for :title, "#{@sign_up_form.name} - Print List" %>

<%
  show_slot_label = !%w[simple_capacity open_list].include?(@sign_up_form.slot_generation_mode)
%>

<div class="print-container">
  <!-- Print Controls (hidden when printing) -->
  <div class="no-print mb-6">
    <div class="flex items-center justify-end gap-3 mb-3">
      <% if @sign_up_form.repeated? && @instances.present? %>
        <select onchange="window.location.href=this.value" class="rounded-lg border border-gray-300 px-3 py-2 text-sm">
          <% @instances.each do |instance| %>
            <% next unless instance.show %>
            <option value="<%= manage_print_list_signups_form_path(@production, @sign_up_form, instance_id: instance.id) %>"
                    <%= 'selected' if instance.id == @current_instance&.id %>>
              <%= instance.show.date_and_time.strftime("%b %-d, %Y - %-I:%M %p") %>
            </option>
          <% end %>
        </select>
      <% end %>
      <button type="button" onclick="window.print()" class="inline-flex items-center justify-center gap-2 font-medium rounded transition-colors cursor-pointer whitespace-nowrap bg-pink-500 hover:bg-pink-600 text-white px-4 py-2 text-sm">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6.72 13.829c-.24.03-.48.062-.72.096m.72-.096a42.415 42.415 0 0 1 10.56 0m-10.56 0L6.34 18m10.94-4.171c.24.03.48.062.72.096m-.72-.096L17.66 18m0 0 .229 2.523a1.125 1.125 0 0 1-1.12 1.227H7.231c-.662 0-1.18-.568-1.12-1.227L6.34 18m11.318 0h1.091A2.25 2.25 0 0 0 21 15.75V9.456c0-1.081-.768-2.015-1.837-2.175a48.055 48.055 0 0 0-1.913-.247M6.34 18H5.25A2.25 2.25 0 0 1 3 15.75V9.456c0-1.081.768-2.015 1.837-2.175a48.041 48.041 0 0 1 1.913-.247m10.5 0a48.536 48.536 0 0 0-10.5 0m10.5 0V3.375c0-.621-.504-1.125-1.125-1.125h-8.25c-.621 0-1.125.504-1.125 1.125v3.659M18 10.5h.008v.008H18V10.5Zm-3 0h.008v.008H15V10.5Z" />
        </svg>
        <span>Print</span>
      </button>
    </div>
    <p class="text-xs text-gray-500 text-right">
      Tip: In your browser's print dialog, uncheck "Headers and footers" to remove the URL and date from the printout.
    </p>
  </div>

  <div class="print-page">
    <!-- Header -->
    <div class="border-b border-gray-200 pb-4 mb-6">
      <h1 class="text-2xl font-bold text-gray-900"><%= @sign_up_form.name %></h1>
      <% if @show %>
        <div class="mt-2 text-sm text-gray-600">
          <%= @show.date_and_time.strftime("%A, %B %-d, %Y at %-I:%M %p") %>
        </div>
      <% end %>
    </div>

    <!-- Registrations List -->
    <% if @slots.any? %>
      <table class="w-full text-sm">
        <thead>
          <tr class="border-b border-gray-300">
            <% if show_slot_label %>
              <th class="text-left py-2 px-2 font-semibold text-gray-700 w-24">Slot</th>
            <% end %>
            <th class="text-left py-2 px-2 font-semibold text-gray-700">Name</th>
            <th class="text-left py-2 px-2 font-semibold text-gray-700">Email</th>
          </tr>
        </thead>
        <tbody>
          <% if show_slot_label %>
            <%# Slot-based modes (numbered/named/timed): show each slot with its label %>
            <% @slots.each do |slot| %>
              <% next if slot.is_held %>
              <% registrations = slot.sign_up_registrations.active.includes(:person).order(:position).to_a %>

              <% if registrations.any? %>
                <% registrations.each do |registration| %>
                  <tr class="border-b border-gray-100">
                    <td class="py-2 px-2 text-gray-500"><%= slot.name.presence || slot.position %></td>
                    <td class="py-2 px-2 font-medium text-gray-900"><%= registration.display_name %></td>
                    <td class="py-2 px-2 text-gray-600"><%= registration.display_email %></td>
                  </tr>
                <% end %>
                <%# Show remaining capacity as empty rows %>
                <% remaining = slot.capacity - registrations.size %>
                <% remaining.times do %>
                  <tr class="border-b border-gray-100">
                    <td class="py-2 px-2 text-gray-500"><%= slot.name.presence || slot.position %></td>
                    <td colspan="2"></td>
                  </tr>
                <% end %>
              <% else %>
                <%# Empty slot - show all capacity slots %>
                <% slot.capacity.times do %>
                  <tr class="border-b border-gray-100">
                    <td class="py-2 px-2 text-gray-500"><%= slot.name.presence || slot.position %></td>
                    <td colspan="2"></td>
                  </tr>
                <% end %>
              <% end %>
            <% end %>
          <% else %>
            <%# Waitlist modes (simple_capacity/open_list): show list with empty rows %>
            <%
              all_registrations = @slots.reject(&:is_held).flat_map { |s| s.sign_up_registrations.active.includes(:person).to_a }
              total_capacity = @slots.reject(&:is_held).sum(&:capacity)
            %>
            <% all_registrations.each do |registration| %>
              <tr class="border-b border-gray-100">
                <td class="py-2 px-2 font-medium text-gray-900"><%= registration.display_name %></td>
                <td class="py-2 px-2 text-gray-600"><%= registration.display_email %></td>
              </tr>
            <% end %>
            <%# Show empty rows for remaining capacity %>
            <% (total_capacity - all_registrations.size).times do %>
              <tr class="border-b border-gray-100">
                <td class="py-2 px-2">&nbsp;</td>
                <td class="py-2 px-2"></td>
              </tr>
            <% end %>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <div class="text-center py-12 text-gray-500">
        <p>No slots configured for this sign-up form.</p>
      </div>
    <% end %>
  </div>
</div>
