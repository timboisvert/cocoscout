<%
  # Parameters:
  # - show: the Show object
  # - title: optional string to override the date/time in the title bar (e.g., "Cast")
  # - production: the Production object
  # - roles: (optional) preloaded roles array
  # - roles_count: (optional) preloaded roles count
  # - roles_max_updated_at: (optional) precomputed max updated_at for roles
  # - assignments_max_updated_at_by_show: (optional) hash of show_id => max updated_at for assignments
  # - people_by_id: (optional) preloaded people hash
  # - groups_by_id: (optional) preloaded groups hash

  # Use preloaded data if available, otherwise fall back to show.available_roles
  # IMPORTANT: For shows with custom roles, we MUST use the show-specific roles
  if show.use_custom_roles?
    roles = show.available_roles.to_a
  else
    roles = local_assigns[:roles] || @roles || show.production.roles.order(:position).to_a
  end
  roles_count = roles.size
  people_by_id = local_assigns[:people_by_id] || @people_by_id || {}
  groups_by_id = local_assigns[:groups_by_id] || @groups_by_id || {}

  cast_count = show.show_person_role_assignments.size
  percentage = roles_count > 0 ? (cast_count.to_f / roles_count * 100).round : 0
  fully_cast = percentage == 100

  # Use precomputed timestamps if available, otherwise query (for backward compatibility)
  assignments_max = if @assignments_max_updated_at_by_show
    @assignments_max_updated_at_by_show[show.id]
  else
    show.show_person_role_assignments.maximum(:updated_at)
  end
  roles_max = show.available_roles.maximum(:updated_at) || production.roles.maximum(:updated_at)

  # Cache key includes show, assignments, and roles timestamps
  cast_card_cache_key = [
    "cast_card_v4",
    show.id,
    show.updated_at.to_i,
    show.use_custom_roles?,
    assignments_max&.to_i,
    roles_max&.to_i,
    roles_count,
    title.presence || "default"
  ]
%>

<% cache cast_card_cache_key do %>
<%= link_to manage_production_show_cast_path(production, show), class: "block no-underline" do %>
  <div class="px-3 py-3 border border-gray-200 rounded-lg hover:border-gray-400 transition-all bg-white">
    <div class="flex items-stretch gap-4">
      <%# Left Third: Date & Show Details %>
      <div class="flex-1 flex items-center gap-4">
        <%# Date Box %>
        <div class="flex-shrink-0 w-14 text-center">
          <div class="text-xs font-semibold text-pink-600 uppercase"><%= show.date_and_time.strftime("%b") %></div>
          <div class="text-2xl font-bold text-gray-900"><%= show.date_and_time.strftime("%-d") %></div>
          <div class="text-xs text-gray-500"><%= show.date_and_time.strftime("%a") %></div>
        </div>

        <%# Show Details %>
        <div class="min-w-0">
          <div class="font-medium text-gray-900">
            <%= show.secondary_name.presence || show.event_type.titleize %>
          </div>
          <div class="text-sm text-gray-600">
            <%= show.date_and_time.strftime("%l:%M %p").strip %>
            <% if show.location.present? %>
              Â· <%= show.location.name %>
            <% end %>
          </div>
        </div>
      </div>

      <%# Right Two-Thirds: Casting %>
      <div class="flex-[2] border-l border-gray-200 pl-4 flex flex-col justify-center">
        <div class="text-xs font-semibold text-gray-700 mb-1">Casting Progress</div>
        <div class="h-1.5 bg-gray-200 rounded-full overflow-hidden mb-1">
          <div class="h-full rounded-full <%= fully_cast ? 'bg-green-500' : 'bg-pink-500' %>" style="width: <%= percentage %>%"></div>
        </div>
        <div class="text-xs <%= fully_cast ? 'text-green-600' : 'text-gray-500' %> mb-2">
          <% if fully_cast %>
            Fully cast
          <% else %>
            <%= cast_count %>/<%= roles_count %> roles have been cast
          <% end %>
        </div>

        <%# Cast member headshots %>
        <div class="flex flex-wrap gap-1.5">
          <% roles.each do |role| %>
            <%
              # All roles now use role_id (both production and show-specific roles are in Role model)
              assignment = show.show_person_role_assignments.find { |a| a.role_id == role.id }
            %>
            <% if assignment %>
              <%
                assignable = if assignment.assignable_type == "Person"
                  people_by_id[assignment.assignable_id] || assignment.assignable
                else
                  groups_by_id[assignment.assignable_id] || assignment.assignable
                end
              %>
              <% headshot_variant = assignable.safe_headshot_variant(:thumb) %>
              <% if headshot_variant %>
                <%= image_tag headshot_variant,
                    alt: assignable.name,
                    class: "w-8 h-8 rounded-md object-cover",
                    data: { controller: "tooltip", tooltip_text: "#{assignable.name} - #{role.name}" } %>
              <% else %>
                <div class="w-8 h-8 rounded-md bg-green-100 flex items-center justify-center text-green-700 font-bold text-xs"
                     data-controller="tooltip"
                     data-tooltip-text="<%= "#{assignable.name} - #{role.name}" %>">
                  <%= assignable.initials %>
                </div>
              <% end %>
            <% else %>
              <div class="w-8 h-8 rounded-md border-2 border-dashed border-gray-300 bg-gray-50 flex items-center justify-center text-gray-400 text-xs"
                   data-controller="tooltip"
                   data-tooltip-text="<%= "#{role.name} - Not Cast" %>">
                +
              </div>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
<% end %>
<% end %>
