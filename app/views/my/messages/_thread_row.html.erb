<%# Thread row partial - shows thread preview with metadata %>
<%
  subscription = Current.user.message_subscriptions.find_by(message: thread)
  reply_count = thread.child_messages.count
  unread = subscription&.unread?
  latest_message = thread.child_messages.order(created_at: :desc).first || thread
  latest_time = thread.latest_activity_at
%>

<%= link_to my_message_path(thread), class: "block hover:bg-gray-50 transition-colors bg-white rounded-lg border border-gray-200 overflow-hidden" do %>
  <div class="flex items-start gap-3 p-4 <%= unread ? 'bg-pink-50' : '' %>">
    <%# Sender avatar - uses shared partial for production team vs personal avatar %>
    <% sender_person = thread.sender.is_a?(Person) ? thread.sender : thread.sender.person %>
    <%= render "shared/messages/message_avatar", message: thread, sender_person: sender_person, size: :list %>

    <div class="flex-1 min-w-0">
      <div class="flex items-center gap-2 flex-wrap mb-1">
        <span class="font-semibold text-gray-900"><%= thread.sender_name %></span>
        <span class="text-gray-400">Â·</span>
        <span class="text-sm text-gray-500"><%= time_ago_in_words(latest_time) %> ago</span>
        <% if thread.regardables.any? %>
          <% regardable = thread.regardables.first %>
          <span class="text-xs text-pink-700 bg-pink-100 px-2 py-0.5 rounded-full">
            <%= (regardable.try(:name) || regardable.try(:title) || regardable.class.name).to_s.truncate(25) %>
          </span>
        <% end %>
        <% if reply_count > 0 %>
          <span class="text-xs text-blue-700 bg-blue-100 px-2 py-0.5 rounded-full">
            <%= reply_count %> <%= reply_count == 1 ? 'reply' : 'replies' %>
          </span>
        <% end %>
        <% if subscription&.muted? %>
          <span class="text-xs text-gray-600 bg-gray-200 px-2 py-0.5 rounded-full flex items-center gap-1">
            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M3.707 2.293a1 1 0 00-1.414 1.414l14 14a1 1 0 001.414-1.414l-1.473-1.473A10.014 10.014 0 0019.542 10C18.268 5.943 14.478 3 10 3a9.958 9.958 0 00-4.512 1.074l-1.78-1.781zm4.261 4.26l1.514 1.515a2.003 2.003 0 012.45 2.45l1.514 1.514a4 4 0 00-5.478-5.478z" clip-rule="evenodd"/>
              <path d="M12.454 16.697L9.75 13.992a4 4 0 01-3.742-3.741L2.335 6.578A9.98 9.98 0 00.458 10c1.274 4.057 5.065 7 9.542 7 .847 0 1.669-.105 2.454-.303z"/>
            </svg>
            Muted
          </span>
        <% end %>
      </div>

      <p class="text-base font-medium text-gray-900 mb-1"><%= thread.subject %></p>

      <%# Show preview of latest message %>
      <% if latest_message != thread %>
        <p class="text-sm text-gray-600 line-clamp-2">
          <span class="font-medium"><%= latest_message.sender_name %>:</span> <%= strip_tags(latest_message.body.to_plain_text).truncate(120) %>
        </p>
      <% else %>
        <p class="text-sm text-gray-600 line-clamp-2">
          <%= strip_tags(thread.body.to_plain_text).truncate(150) %>
        </p>
      <% end %>
    </div>

    <% if unread %>
      <div class="flex-shrink-0">
        <span class="w-2.5 h-2.5 bg-pink-500 rounded-full block"></span>
      </div>
    <% end %>
  </div>
<% end %>
