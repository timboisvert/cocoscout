<% content_for :title, "Calendar" %>

<div class="w-full mb-10">
  <%= render partial: "shared/notice", locals: { notice: notice } %>
  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [
        ["Shows & Events", manage_production_shows_path(@production)]
    ],
    text: "Calendar",
    links: [
      { text: "Schedule Shows & Events", path: new_manage_production_show_path(@production)}
    ]
  } %>

  <% if @shows.any? %>
    <div class="space-y-8">
      <% @shows_by_month.sort.each do |month_start, shows| %>
        <div class="border border-gray-200 rounded-lg p-4">
          <h2 class="text-xl font-bold mb-4"><%= month_start.strftime("%B %Y") %></h2>

          <div class="grid grid-cols-7 gap-1">
            <!-- Day headers -->
            <% %w[Sun Mon Tue Wed Thu Fri Sat].each do |day| %>
              <div class="text-center text-xs font-semibold text-gray-600 p-2">
                <%= day %>
              </div>
            <% end %>

            <!-- Empty cells for days before month starts -->
            <% (month_start.wday).times do %>
              <div class="border border-gray-100 bg-gray-50 min-h-[80px] p-1"></div>
            <% end %>

            <!-- Calendar days -->
            <% current_date = month_start %>
            <% while current_date.month == month_start.month %>
              <% day_shows = shows.select { |s| s.date_and_time.to_date == current_date.to_date } %>
              <div class="border border-gray-200 min-h-[80px] p-1 <%= 'bg-blue-50' if current_date.to_date == Date.current %>">
                <div class="text-xs font-semibold text-gray-700 mb-1">
                  <%= current_date.day %>
                </div>

                <% day_shows.each do |show| %>
                  <%= link_to edit_manage_production_show_path(@production, show),
                      class: "block mb-1" do %>
                    <% is_past = show.date_and_time < Time.current %>
                    <% event_type_badge_classes = if is_past
                      "bg-gray-100 text-gray-600 border-gray-300"
                    else
                      case show.event_type
                        when "rehearsal" then "bg-blue-100 text-blue-800 border-blue-300"
                        when "meeting" then "bg-green-100 text-green-800 border-green-300"
                        else "bg-pink-100 text-pink-800 border-pink-300"
                      end
                    end %>
                    <div class="text-xs p-1 rounded border <%= event_type_badge_classes %> <%= 'opacity-50 line-through' if show.canceled %>">
                      <div class="font-semibold"><%= show.date_and_time.strftime("%l:%M %p").strip %></div>
                      <% if show.secondary_name.present? %>
                        <div class="truncate"><%= show.secondary_name %></div>
                      <% end %>
                      <% if show.canceled %>
                        <div class="text-red-600 font-semibold">Canceled</div>
                      <% end %>
                    </div>
                  <% end %>
                <% end %>
              </div>
              <% current_date = current_date + 1.day %>
            <% end %>

            <!-- Empty cells to complete the week -->
            <% remaining_cells = (7 - current_date.wday) % 7 %>
            <% remaining_cells.times do %>
              <div class="border border-gray-100 bg-gray-50 min-h-[80px] p-1"></div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  <% else %>
    <p class="text-gray-500 text-sm">No events scheduled.</p>
  <% end %>
</div>
