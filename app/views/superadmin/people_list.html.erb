<% content_for :title, "People - Superadmin" %>

<div class="w-full px-5 pt-5">
  <%= render partial: "shared/notice", locals: { notice: notice } %>

  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [
        ["Superadmin", superadmin_path]
    ],
    text: "People",
    links: []
  } %>

  <!-- Search Bar -->
  <div class="mb-4 mt-4">
    <%= form_with url: people_list_path, method: :get, class: "flex gap-2" do |f| %>
      <div class="relative flex-1">
        <%= f.text_field :search,
            value: @search,
            placeholder: "Search by name or email...",
            class: "w-full h-12 px-4 pl-10 pr-10 rounded border border-gray-300 focus:ring-2 focus:ring-pink-500 focus:border-transparent",
            autocomplete: "off" %>
        <svg class="absolute left-3 top-3.5 w-5 h-5 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
      </div>
      <%= f.hidden_field :filter, value: @filter %>

      <%= render "shared/button",
          text: "Search",
          variant: "primary",
          size: "large",
          icon: "search",
          type: :submit %>
    <% end %>
  </div>

  <%= render "shared/filters/filter_bar", filter_groups: [
    {
      label: "Filter",
      filters: [
        { text: "All", path: people_list_path(search: @search), active: @filter.blank? },
        { text: "Suspicious (#{@suspicious_count})", path: people_list_path(filter: "suspicious", search: @search), active: @filter == "suspicious" }
      ]
    },
    { separator: true },
    {
      partial: "superadmin/people_list_actions",
      locals: { suspicious_count: @suspicious_count }
    }
  ] %>

  <!-- People table with bulk selection -->
  <div class="bg-white border border-gray-200 rounded-lg overflow-hidden" id="people-list">
    <%= render "shared/card_header", title: "People" do %>
      <div class="flex items-center gap-4">
        <% if @search.present? || @filter.present? %>
          <span class="text-sm font-normal text-gray-600">(filtered)</span>
        <% end %>
        <!-- Bulk actions -->
        <div class="flex gap-2 items-center" id="bulk-actions" style="display: none;">
          <span class="text-sm text-gray-600" id="selected-count">0 selected</span>
          <%= render "shared/button",
              text: "Delete Selected",
              variant: "danger",
              size: "small",
              icon: "trash",
              type: :button,
              data: { action: "click->bulk-delete#confirm" } %>
        </div>
      </div>
    <% end %>

    <% if @people.empty? %>
      <div class="text-center py-12 text-gray-500">
        No people found.
      </div>
    <% else %>
      <!-- Hidden form for bulk delete -->
      <form id="bulk-delete-form" action="<%= bulk_destroy_people_path %>" method="post" style="display: none;">
        <input type="hidden" name="_method" value="delete">
        <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
        <input type="hidden" name="person_ids" id="bulk-person-ids" value="">
        <input type="hidden" name="filter" value="<%= @filter %>">
        <input type="hidden" name="search" value="<%= @search %>">
      </form>

      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-10">
                <input type="checkbox" id="select-all" class="rounded border-gray-300 text-pink-600 focus:ring-pink-500">
              </th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Has User</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Public Key</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Talent Pools</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <% @people.each do |person| %>
              <tr class="hover:bg-gray-50 <%= Person.name_looks_suspicious?(person.name) ? 'bg-red-50' : '' %>">
                <td class="px-4 py-3 whitespace-nowrap">
                  <input type="checkbox"
                         class="person-checkbox rounded border-gray-300 text-pink-600 focus:ring-pink-500"
                         data-person-id="<%= person.id %>"
                         onclick="event.stopPropagation();">
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900 cursor-pointer" onclick="window.location='<%= person_detail_path(person) %>'">
                  <% if Person.name_looks_suspicious?(person.name) %>
                    <span class="inline-flex items-center gap-1">
                      <svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                      </svg>
                      <code class="text-xs bg-red-100 px-1.5 py-0.5 rounded text-red-800 break-all max-w-xs"><%= truncate(person.name, length: 40) %></code>
                    </span>
                  <% else %>
                    <%= person.name %>
                  <% end %>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600 cursor-pointer" onclick="window.location='<%= person_detail_path(person) %>'">
                  <%= truncate(person.email, length: 40) %>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600 cursor-pointer" onclick="window.location='<%= person_detail_path(person) %>'">
                  <%= person.created_at&.strftime("%b %d, %Y") %>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-center cursor-pointer" onclick="window.location='<%= person_detail_path(person) %>'">
                  <% if person.user.present? %>
                    <span class="inline-flex items-center rounded-full bg-green-100 px-2 py-0.5 text-xs font-medium text-green-800">Yes</span>
                  <% else %>
                    <span class="inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 text-xs font-medium text-gray-600">No</span>
                  <% end %>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600 cursor-pointer" onclick="window.location='<%= person_detail_path(person) %>'">
                  <% if person.public_key.present? %>
                    <code class="text-xs bg-gray-100 px-1.5 py-0.5 rounded"><%= person.public_key %></code>
                  <% else %>
                    <span class="text-gray-400">â€”</span>
                  <% end %>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600 text-center cursor-pointer" onclick="window.location='<%= person_detail_path(person) %>'">
                  <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-gray-100 text-gray-700 font-medium text-xs">
                    <%= person.talent_pool_memberships.count %>
                  </span>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <% if @pagy.pages > 1 %>
        <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
          <div class="flex-1 flex justify-between sm:hidden">
            <% if @pagy.previous %>
              <%= link_to "Previous", people_list_path(page: @pagy.previous, search: @search, filter: @filter), class: "relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50" %>
            <% else %>
              <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-500 bg-white cursor-not-allowed">Previous</span>
            <% end %>
            <% if @pagy.next %>
              <%= link_to "Next", people_list_path(page: @pagy.next, search: @search, filter: @filter), class: "ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50" %>
            <% else %>
              <span class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-500 bg-white cursor-not-allowed">Next</span>
            <% end %>
          </div>
          <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
            <div>
              <p class="text-sm text-gray-700">
                Showing page
                <span class="font-medium"><%= @pagy.page %></span>
                of
                <span class="font-medium"><%= @pagy.pages %></span>
                (<span class="font-medium"><%= @pagy.count %></span> total)
              </p>
            </div>
            <div class="flex gap-2">
              <% if @pagy.previous %>
                <%= link_to "Previous", people_list_path(page: @pagy.previous, search: @search, filter: @filter), class: "relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50" %>
              <% else %>
                <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-300 bg-white cursor-not-allowed">Previous</span>
              <% end %>
              <% if @pagy.next %>
                <%= link_to "Next", people_list_path(page: @pagy.next, search: @search, filter: @filter), class: "relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50" %>
              <% else %>
                <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-300 bg-white cursor-not-allowed">Next</span>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    <% end %>
  </div>
</div>

<script>
(function() {
  function initPeopleList() {
    const peopleList = document.getElementById('people-list');
    if (!peopleList || peopleList.dataset.initialized) return;
    peopleList.dataset.initialized = 'true';

    const selectAll = document.getElementById('select-all');
    const bulkActions = document.getElementById('bulk-actions');
    const selectedCount = document.getElementById('selected-count');
    const bulkDeleteForm = document.getElementById('bulk-delete-form');
    const bulkPersonIds = document.getElementById('bulk-person-ids');

    if (!selectAll || !bulkActions) return;

    function updateBulkActions() {
      const checkboxes = document.querySelectorAll('.person-checkbox');
      const selected = document.querySelectorAll('.person-checkbox:checked');
      const count = selected.length;

      if (count > 0) {
        bulkActions.style.display = 'flex';
        selectedCount.textContent = count + ' selected';
      } else {
        bulkActions.style.display = 'none';
      }

      // Update select all checkbox state
      selectAll.checked = checkboxes.length > 0 && selected.length === checkboxes.length;
      selectAll.indeterminate = selected.length > 0 && selected.length < checkboxes.length;
    }

    selectAll.addEventListener('change', function() {
      const checkboxes = document.querySelectorAll('.person-checkbox');
      checkboxes.forEach(cb => cb.checked = this.checked);
      updateBulkActions();
    });

    // Use event delegation for checkboxes
    peopleList.addEventListener('change', function(e) {
      if (e.target.classList.contains('person-checkbox')) {
        updateBulkActions();
      }
    });

    // Use event delegation for delete button
    bulkActions.addEventListener('click', function(e) {
      const btn = e.target.closest('button');
      if (!btn) return;

      e.preventDefault();

      const selected = document.querySelectorAll('.person-checkbox:checked');
      const count = selected.length;

      if (count === 0) return;

      if (confirm(`Are you sure you want to delete ${count} selected ${count === 1 ? 'person' : 'people'}? This cannot be undone.`)) {
        const ids = Array.from(selected).map(cb => cb.dataset.personId).join(',');
        bulkPersonIds.value = ids;
        bulkDeleteForm.submit();
      }
    });
  }

  // Handle both regular page load and Turbo navigation
  document.addEventListener('DOMContentLoaded', initPeopleList);
  document.addEventListener('turbo:load', initPeopleList);
})();
</script>
