<%#
  Unified Compose Message Modal

  A reusable modal for composing messages to people, groups, or production teams.
  Include this once per page and trigger it via Stimulus actions.

  Usage:
     render "shared/compose_message_modal"

    Then on any button, use data attributes to configure:

    Contact a single person:
    <button data-controller="compose-message"
            data-action="click->compose-message#open"
            data-compose-message-recipient-type-value="person"
            data-compose-message-recipient-id-value="123"
            data-compose-message-recipient-name-value="John Smith">
      Contact
    </button>

    Contact a group:
    <button data-controller="compose-message"
            data-action="click->compose-message#open"
            data-compose-message-recipient-type-value="group"
            data-compose-message-recipient-id-value="456"
            data-compose-message-recipient-name-value="Ensemble">
      Contact Group
    </button>

    Contact production team (from performer side):
    <button data-controller="compose-message"
            data-action="click->compose-message#open"
            data-compose-message-recipient-type-value="production_team"
            data-compose-message-recipient-id-value="789"
            data-compose-message-recipient-name-value="Hamilton">
      Contact Production
    </button>
%>

<div id="compose-message-modal"
     data-controller="compose-message"
     data-compose-message-target="modal"
     class="hidden fixed inset-0 z-50 overflow-y-auto"
     aria-labelledby="compose-message-title"
     role="dialog"
     aria-modal="true">

  <%# Backdrop %>
  <div class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm transition-opacity"
       data-action="click->compose-message#closeOnBackdrop"></div>

  <%# Modal Panel %>
  <div class="flex min-h-full items-center justify-center p-4">
    <div class="relative w-full max-w-lg transform overflow-hidden rounded-2xl bg-white shadow-2xl transition-all"
         data-action="click->compose-message#stopPropagation">

      <%# Header %>
      <div class="bg-gradient-to-r from-pink-500 to-pink-600 px-6 py-5">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="flex h-10 w-10 items-center justify-center rounded-full bg-white/20">
              <svg class="h-5 w-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
              </svg>
            </div>
            <h3 id="compose-message-title" class="text-lg font-semibold text-white" data-compose-message-target="title">
              Send Message
            </h3>
          </div>
          <button type="button"
                  class="rounded-full p-1 text-white/80 hover:text-white hover:bg-white/10 transition-colors cursor-pointer"
                  data-action="click->compose-message#close">
            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
      </div>

      <%# Form %>
      <form data-compose-message-target="form"
            method="post"
            enctype="multipart/form-data"
            class="p-6 space-y-5"
            data-action="submit->compose-message#submit"
            data-turbo="false">
        <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
        <input type="hidden" name="recipient_type" data-compose-message-target="recipientType">
        <input type="hidden" name="recipient_id" data-compose-message-target="recipientId">

        <%# Recipients Section %>
        <div data-compose-message-target="recipientSection" class="flex items-center gap-3 pb-4 border-b border-gray-100">
          <span class="text-sm font-medium text-gray-500">To:</span>
          <div class="flex items-center gap-2" data-compose-message-target="recipientDisplay">
            <%# Single recipient with headshot - populated by JS %>
            <div data-compose-message-target="singleRecipient" class="flex items-center gap-2">
              <div data-compose-message-target="recipientHeadshot" class="w-8 h-8 rounded-lg bg-pink-100 flex items-center justify-center text-pink-600 font-bold text-xs ring-2 ring-white">
                <%# Initials or image inserted by JS %>
              </div>
              <span data-compose-message-target="recipientName" class="text-sm font-medium text-gray-900"></span>
            </div>
            <%# Batch recipients - stacked headshots - populated by JS %>
            <div data-compose-message-target="batchRecipients" class="hidden flex items-center -space-x-1.5">
              <%# Headshots inserted by JS %>
            </div>
          </div>
        </div>

        <%# Subject %>
        <div>
          <label for="compose-subject" class="block text-sm font-medium text-gray-700 mb-1.5">
            Subject
          </label>
          <input type="text"
                 name="subject"
                 id="compose-subject"
                 data-compose-message-target="subject"
                 class="w-full rounded-lg border border-gray-300 px-4 py-2.5 text-gray-900 placeholder-gray-400 focus:border-pink-500 focus:ring-2 focus:ring-pink-500/20 focus:outline-none transition-colors"
                 placeholder="What's this about?"
                 required>
        </div>

        <%# Message %>
        <div>
          <label for="compose-body" class="block text-sm font-medium text-gray-700 mb-1.5">
            Message
          </label>
          <%= rich_text_area_tag :body, nil,
              id: "compose-body",
              data: { "compose-message-target": "body" },
              class: "w-full min-h-[120px]",
              placeholder: "Write your message here..." %>
        </div>

        <%# Image Attachments %>
        <%= render "shared/image_dropzone", size: "medium" %>

        <%# Poll %>
        <%= render "shared/messages/poll_form" %>

        <%# Send Separately Toggle - only shown for batch messages %>
        <div data-compose-message-target="sendSeparatelySection" class="hidden">
          <label class="flex items-start gap-2 cursor-pointer">
            <input type="checkbox"
                   name="send_separately"
                   data-compose-message-target="sendSeparately"
                   data-action="change->compose-message#toggleSendSeparately"
                   class="h-4 w-4 mt-0.5 rounded border-gray-300 accent-pink-500">
            <span>
              <span class="text-sm text-gray-700">Send as separate message threads</span>
              <p class="text-xs text-gray-500 mt-0.5">Each person will receive their own conversation instead of a group message.</p>
            </span>
          </label>
        </div>

        <%# Actions %>
        <div class="flex items-center justify-end gap-3">
          <%= render "shared/button",
              text: "Cancel",
              variant: "ghost",
              type: :button,
              data: { action: "click->compose-message#close" } %>
          <%= render "shared/button",
              text: "Send Message",
              variant: "primary",
              type: :submit,
              data: { "compose-message-target": "submitButton" } %>
        </div>
      </form>
    </div>
  </div>
</div>
