<%#
  Image Gallery Partial

  Usage:
     render "shared/image_gallery", items: @person.profile_resumes, type: "resume"
    render "shared/image_gallery", items: @person.profile_headshots, type: "headshot"

  Parameters:
    items: Collection of ProfileResume or ProfileHeadshot records
    type: "resume" or "headshot" - determines how to access attachments
    empty_message: Optional custom empty state message
%>

<%
  type ||= "resume"
  empty_message ||= "No #{type}s found"

  # Generate a unique ID for this gallery's modal
  gallery_id = "gallery_#{SecureRandom.hex(4)}"

  # Build the images array for the gallery controller
  gallery_images = []

  items.each do |item|
    if type == "resume"
      next unless item.file&.attached?

      if item.file.content_type == "application/pdf"
        if item.file.representable?
          preview_url = url_for(item.file.representation(resize_to_limit: [612, 792]))
          full_url = url_for(item.file.representation(resize_to_limit: [1224, 1584]))
        else
          preview_url = nil
          full_url = rails_blob_path(item.file, disposition: "attachment")
        end
      else
        preview_url = url_for(item.file.variant(resize_to_limit: [612, 792]))
        full_url = url_for(item.file)
      end

      gallery_images << {
        id: item.id,
        name: item.name,
        preview_url: preview_url,
        full_url: full_url,
        is_pdf: item.file.content_type == "application/pdf",
        previewable: item.file.representable? || item.file.content_type.start_with?("image/")
      } if preview_url
    else
      next unless item.image&.attached?

      preview_url = url_for(item.image.variant(resize_to_limit: [400, 533]))
      full_url = url_for(item.image)

      gallery_images << {
        id: item.id,
        name: item.category || "Headshot",
        preview_url: preview_url,
        full_url: full_url,
        is_primary: item.is_primary
      }
    end
  end
%>

<% if gallery_images.empty? %>
  <p class="text-left text-gray-500 text-sm"><%= empty_message %></p>
<% elsif gallery_images.length == 1 %>
  <%# Single item - simple display with modal %>
  <div class="w-full">
    <div class="relative inline-block cursor-pointer" data-action="click->image-gallery#openModal" data-controller="image-gallery" data-image-gallery-images-value="<%= gallery_images.to_json %>" data-image-gallery-current-index-value="0" data-image-gallery-modal-id-value="<%= gallery_id %>">
      <% if type == "resume" %>
        <img src="<%= gallery_images.first[:preview_url] %>"
             alt="<%= gallery_images.first[:name] %>"
             class="max-w-full h-auto rounded-lg shadow-sm border border-gray-200 hover:opacity-90 transition-opacity">
      <% else %>
        <img src="<%= gallery_images.first[:preview_url] %>"
             alt="<%= gallery_images.first[:name] %>"
             class="max-w-md h-auto rounded-lg shadow-sm border border-gray-200 hover:opacity-90 transition-opacity">
      <% end %>
      <div class="absolute inset-0 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity bg-black/10 rounded-lg">
        <div class="bg-white/90 rounded-full p-2 shadow-lg">
          <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"/>
          </svg>
        </div>
      </div>
    </div>
    <p class="mt-2 text-sm text-gray-500">Click to view full size</p>
  </div>
<% else %>
  <%# Multiple items - gallery with navigation %>
  <div class="w-full"
       data-controller="image-gallery"
       data-image-gallery-images-value="<%= gallery_images.to_json %>"
       data-image-gallery-current-index-value="0"
       data-image-gallery-modal-id-value="<%= gallery_id %>">

    <%# Main image display %>
    <div class="relative">
      <%# Navigation arrows %>
      <button type="button"
              data-image-gallery-target="prevButton"
              data-action="click->image-gallery#previous"
              class="absolute left-2 top-1/2 -translate-y-1/2 z-10 bg-white/90 hover:bg-white rounded-full p-2 shadow-lg transition-all cursor-pointer">
        <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
      </button>

      <button type="button"
              data-image-gallery-target="nextButton"
              data-action="click->image-gallery#next"
              class="absolute right-2 top-1/2 -translate-y-1/2 z-10 bg-white/90 hover:bg-white rounded-full p-2 shadow-lg transition-all cursor-pointer">
        <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
      </button>

      <%# Main image %>
      <div class="flex justify-center bg-gray-50 rounded-lg p-4 cursor-pointer" data-action="click->image-gallery#openModal">
        <% if type == "resume" %>
          <img data-image-gallery-target="image"
               src="<%= gallery_images.first[:preview_url] %>"
               data-full-url="<%= gallery_images.first[:full_url] %>"
               alt="<%= gallery_images.first[:name] %>"
               class="max-w-full h-auto max-h-[70vh] rounded shadow-sm border border-gray-200 hover:opacity-90 transition-opacity">
        <% else %>
          <img data-image-gallery-target="image"
               src="<%= gallery_images.first[:preview_url] %>"
               data-full-url="<%= gallery_images.first[:full_url] %>"
               alt="<%= gallery_images.first[:name] %>"
               class="max-w-full max-h-[70vh] rounded-lg shadow-sm border border-gray-200 hover:opacity-90 transition-opacity">
        <% end %>
      </div>
    </div>

    <%# Counter and keyboard hint %>
    <div class="mt-3 flex items-center justify-between">
      <p class="text-sm text-gray-500" data-image-gallery-target="counter">1 of <%= gallery_images.length %></p>
      <p class="text-xs text-gray-400">Use ← → arrow keys to navigate • Click to zoom</p>
    </div>

    <%# Thumbnail strip %>
    <% if gallery_images.length <= 10 %>
      <div class="mt-4 flex gap-2 overflow-x-auto pb-2" data-image-gallery-target="thumbnailContainer">
        <% gallery_images.each_with_index do |img, index| %>
          <button type="button"
                  data-image-gallery-target="thumbnail"
                  data-index="<%= index %>"
                  data-action="click->image-gallery#goToIndex"
                  class="flex-shrink-0 rounded-lg overflow-hidden border-2 transition-all cursor-pointer hover:border-pink-300 <%= index == 0 ? 'border-pink-500' : 'border-gray-200 opacity-60' %>">
            <% if type == "resume" %>
              <img src="<%= img[:preview_url] %>" alt="<%= img[:name] %>" class="w-16 h-20 object-cover">
            <% else %>
              <img src="<%= img[:preview_url] %>" alt="<%= img[:name] %>" class="w-16 h-20 object-cover">
            <% end %>
          </button>
        <% end %>
      </div>
    <% end %>
  </div>
<% end %>

<%# Self-contained modal for this gallery %>
<% if gallery_images.any? %>
<div id="<%= gallery_id %>" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4" data-action="click->image-gallery#closeModal keydown.escape->image-gallery#closeModal">
  <div class="relative max-w-6xl max-h-full" data-action="click->image-gallery#stopPropagation">
    <button type="button"
            data-action="click->image-gallery#closeModal"
            class="absolute -top-12 right-0 text-white hover:text-gray-300 transition-colors cursor-pointer">
      <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </button>
    <img id="<%= gallery_id %>_image" src="" alt="Full size image" class="max-w-full max-h-[90vh] object-contain rounded-lg shadow-2xl">
  </div>
</div>
<% end %>
