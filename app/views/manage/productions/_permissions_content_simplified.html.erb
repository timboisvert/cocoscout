<%= render "shared/help_section",
  title: "About Global Roles",
  initial_state: "open",
  storage_key: "team_permissions_help_collapsed",
  steps: [
    { text: "<strong>Manager:</strong> Full access to manage all productions, team members, and settings." },
    { text: "<strong>Viewer:</strong> Read-only access to view all productions and their data." },
    { text: "For production-specific access, use the Team tab on individual production settings pages." }
  ] %>

<div class="mt-4" data-controller="org-role-notifications">
  <div class="p-4 border border-gray-200 rounded-lg mb-4">
    <h3 class="text-lg font-semibold mb-2">Global Role</h3>
    <p class="text-sm text-gray-600 mb-3">
      This role applies to all productions managed by <%= Current.organization.name %>.
    </p>
    <div class="flex flex-col md:flex-row md:items-center gap-4">
      <div class="w-full md:w-96">
        <%= form_with url: update_global_role_manage_team_path(user), method: :patch, data: { turbo: false, controller: "auto-submit" } do |f| %>
          <%= select_tag :global_role,
              options_for_select(
                [
                  ["Manager (full access to all productions)", "manager"],
                  ["Viewer (read-only access to all productions)", "viewer"]
                ],
                organization_role&.company_role || "viewer"
              ),
              class: "block shadow-sm rounded-lg border px-3 py-2 w-full border-gray-400",
              data: { action: "change->auto-submit#submit change->org-role-notifications#roleChanged", "org-role-notifications-target": "roleSelect" }
          %>
        <% end %>
      </div>
    </div>
  </div>

  <div class="p-4 border border-gray-200 rounded-lg mb-4">
    <h3 class="text-lg font-semibold mb-2">Production-Specific Access</h3>
    <p class="text-sm text-gray-600 mb-3">
      This person has global access to all productions. To manage access to individual productions, use the Team tab on each production's settings page.
    </p>
    <% production_permissions = user.production_permissions.where(production_id: productions.pluck(:id)).includes(:production) %>
    <% if production_permissions.any? %>
      <div class="mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
        <p class="text-sm text-yellow-800 font-medium mb-2">
          <svg class="inline w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
          </svg>
          This person also has production-specific permissions:
        </p>
        <ul class="text-sm text-yellow-700 ml-6 list-disc">
          <% production_permissions.each do |perm| %>
            <li><%= perm.production.name %>: <%= perm.role.capitalize %></li>
          <% end %>
        </ul>
        <p class="text-xs text-yellow-600 mt-2">These can be managed from each production's settings page.</p>
      </div>
    <% end %>
  </div>

  <div class="p-4 border border-gray-200 rounded-lg mb-4">
    <h3 class="text-lg font-semibold mb-2">Email Notifications</h3>
    <p class="text-sm text-gray-600 mb-3">
      Receive email notifications for audition submissions and other important updates.
    </p>
    <%= form_with url: update_global_notifications_manage_team_path(user), method: :patch, data: { turbo: false, controller: "auto-submit" } do |f| %>
      <div class="flex items-center gap-3">
        <button type="button"
                data-org-role-notifications-target="toggle"
                data-action="click->org-role-notifications#toggleNotifications"
                class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-pink-500 focus:ring-offset-2 <%= organization_role&.notifications_enabled? ? 'bg-pink-500' : 'bg-gray-200' %>"
                role="switch"
                aria-checked="<%= organization_role&.notifications_enabled? %>">
          <span class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out <%= organization_role&.notifications_enabled? ? 'translate-x-5' : 'translate-x-0' %>"></span>
        </button>
        <span class="text-sm text-gray-700">Enable email notifications</span>
        <%= hidden_field_tag :notifications_enabled, organization_role&.notifications_enabled? ? "1" : "0", data: { "org-role-notifications-target": "hiddenField" } %>
      </div>
    <% end %>
  </div>
</div>

<div class="mt-4" data-controller="team-remove">
  <div class="p-4 border border-gray-200 rounded-lg mb-4">
    <h3 class="text-lg font-semibold mb-2">Remove from Organization Team</h3>
    <p class="text-sm text-gray-600 mb-3">
      Removing this person will revoke all their access to <%= Current.organization.name %>'s productions.
    </p>
    <%= render "shared/button",
        text: "Remove from Team",
        variant: "danger",
        size: "medium",
        type: :button,
        data: {
            team_remove_target: "removeButton",
            action: "team-remove#remove",
            url: remove_member_manage_team_index_path(id: user.id, format: :json)
        } %>
  </div>
</div>
