<% content_for :title, "Communications - #{@production.name}" %>

<div class="w-full" data-controller="communications">
  <%= render partial: "shared/notice", locals: { notice: notice, alert: alert } %>

  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [
      ["Communications", manage_communications_path]
    ],
    text: @production.name,
    links: [
      { text: "Send Message", path: "#send-message", data_action: "click->communications#openModal" }
    ]
  } %>

  <div class="border-t border-gray-200 pt-4 mt-2">
  <%# Search form %>
  <div class="mb-4" data-controller="search-bar">
    <%= form_with url: manage_communications_production_path(@production), method: :get, data: { turbo: false, search_bar_target: "form" }, class: "relative flex gap-2" do |f| %>
      <div class="relative flex-1">
        <input
          type="text"
          name="search"
          value="<%= @search_query %>"
          placeholder="Search emails by subject or recipient..."
          class="w-full h-12 px-4 pl-10 pr-10 rounded border border-gray-300 focus:ring-2 focus:ring-pink-500 focus:border-transparent"
          autocomplete="off"
          data-action="input->search-bar#toggleClear"
          data-search-bar-target="input"
        />
        <svg class="absolute left-3 top-3.5 w-5 h-5 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        <% if @search_query.present? %>
          <button
            type="button"
            data-action="click->search-bar#clear"
            data-search-bar-target="clearBtn"
            class="absolute right-2 top-2.5 p-1 rounded-full hover:bg-gray-100 transition cursor-pointer"
            title="Clear search"
          >
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 text-gray-400 hover:text-gray-600">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        <% end %>
      </div>

      <%= render "shared/button",
          text: "Search",
          variant: "primary",
          size: "large",
          icon: "search",
          type: :submit %>
    <% end %>
  </div>

  <%# Results count %>
  <div class="mb-3 text-sm text-gray-600">
    <% if @search_query.present? %>
      <%= pluralize(@email_logs_pagy.count, "email") %> matching "<%= @search_query %>"
    <% else %>
      <%= pluralize(@email_logs_pagy.count, "email") %>
    <% end %>
  </div>

  <% if @email_logs.empty? %>
    <div class="text-center py-12 text-gray-500 bg-white border border-gray-200 rounded-lg">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor" class="size-12 mx-auto mb-3 text-gray-300">
        <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 9v.906a2.25 2.25 0 0 1-1.183 1.981l-6.478 3.488M2.25 9v.906a2.25 2.25 0 0 0 1.183 1.981l6.478 3.488m8.839 2.51-4.66-2.51m0 0-1.023-.55a2.25 2.25 0 0 0-2.134 0l-1.022.55m0 0-4.661 2.51m16.5 1.615a2.25 2.25 0 0 1-2.25 2.25h-15a2.25 2.25 0 0 1-2.25-2.25V8.844a2.25 2.25 0 0 1 1.183-1.981l7.5-4.039a2.25 2.25 0 0 1 2.134 0l7.5 4.039a2.25 2.25 0 0 1 1.183 1.98V19.5Z" />
      </svg>
      <% if @search_query.present? %>
        <p>No emails found matching "<%= @search_query %>"</p>
      <% else %>
        <p>No emails sent for <%= @production.name %> yet.</p>
        <p class="text-sm mt-2">Click "Send Message" to contact talent pool members.</p>
      <% end %>
    </div>
  <% else %>
    <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
      <div class="divide-y divide-gray-200">
        <% @email_logs.each do |log| %>
          <%= link_to manage_communication_path(@production, log), class: "block px-4 py-3 hover:bg-pink-50 transition group" do %>
            <div class="flex items-center justify-between gap-4">
              <div class="flex-1 min-w-0">
                <div class="text-sm text-gray-900 font-medium truncate group-hover:text-pink-600">
                  <%= log.subject || "(no subject)" %>
                </div>
                <div class="text-xs text-gray-500 mt-0.5 truncate">
                  <% if log.email_batch && log.email_batch.recipient_count > 1 %>
                    <% total_count = log.email_batch.recipient_count %>
                    <% if total_count <= 5 %>
                      <% # Show all recipient names for small batches %>
                      <% batch_logs = log.email_batch.email_logs.includes(:recipient_entity) %>
                      <% names = batch_logs.map { |l| l.recipient_entity&.name }.compact %>
                      To: <%= names.join(", ") %>
                    <% else %>
                      <% # For larger batches, show count %>
                      To: <%= pluralize(total_count, "person") %>
                    <% end %>
                  <% else %>
                    <% # Single recipient - show name if available %>
                    To: <%= log.recipient_entity&.name || log.recipient %>
                  <% end %>
                </div>
              </div>
              <div class="flex items-center gap-2 flex-shrink-0">
                <span class="text-xs text-gray-500 whitespace-nowrap">
                  <%= log.sent_at&.strftime("%b %-d, %Y · %-I:%M %p") %>
                </span>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 text-gray-400 group-hover:text-pink-500">
                  <path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" />
                </svg>
              </div>
            </div>
          <% end %>
        <% end %>
      </div>

      <%# Pagination %>
      <% if @email_logs_pagy.pages > 1 %>
        <div class="border-t border-gray-200 px-4 py-3 bg-gray-50 flex items-center justify-between rounded-b-lg">
          <div class="text-sm text-gray-500">
            Page <%= @email_logs_pagy.page %> of <%= @email_logs_pagy.pages %>
          </div>
          <div class="flex gap-2">
            <% if @email_logs_pagy.previous %>
              <%= link_to "← Previous", manage_communications_production_path(@production, page: @email_logs_pagy.previous, search: @search_query), class: "px-3 py-1.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50", data: { turbo: false } %>
            <% else %>
              <span class="px-3 py-1.5 text-sm font-medium text-gray-300 bg-white border border-gray-200 rounded-md cursor-not-allowed">← Previous</span>
            <% end %>
            <% if @email_logs_pagy.next %>
              <%= link_to "Next →", manage_communications_production_path(@production, page: @email_logs_pagy.next, search: @search_query), class: "px-3 py-1.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50", data: { turbo: false } %>
            <% else %>
              <span class="px-3 py-1.5 text-sm font-medium text-gray-300 bg-white border border-gray-200 rounded-md cursor-not-allowed">Next →</span>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  <% end %>

  <%# Send Message Modal %>
  <div id="send-message-modal"
       class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center"
       data-communications-target="modal"
       data-action="click->communications#closeModalOnBackdrop">
    <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto"
         data-communications-target="modalContent"
         data-action="click->communications#stopPropagation">
      <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between">
        <h2 class="text-lg font-semibold text-gray-900">Send Message</h2>
        <button type="button"
                data-action="click->communications#closeModal"
                class="text-gray-400 hover:text-gray-600 transition cursor-pointer">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <div class="p-6">
        <%= form_with model: @email_draft, url: manage_communications_send_message_path(@production), method: :post, class: "space-y-4", data: { turbo: false } do |form| %>
          <%# Recipient Selection %>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Send To</label>
            <div class="space-y-2">
              <div>
                <label class="flex items-center cursor-pointer">
                  <input type="radio" name="recipient_type" value="all" checked
                         data-action="change->communications#toggleRecipientType"
                         class="mr-2 accent-pink-500 cursor-pointer">
                  <span class="text-sm">Entire talent pool (<%= @talent_pool_people.count %>)</span>
                  <button type="button" data-action="click->communications#toggleRecipientList" class="ml-2 text-xs text-pink-500 hover:text-pink-600 underline cursor-pointer">
                    Show
                  </button>
                </label>
              </div>

              <div id="talent-pool-list" class="hidden ml-6 p-3 bg-gray-50 border border-gray-200 rounded-lg text-xs" data-communications-target="recipientList">
                <div class="space-y-1 max-h-32 overflow-y-auto">
                  <% @talent_pool_people.each do |person| %>
                    <div class="text-gray-600"><%= person.name %></div>
                  <% end %>
                </div>
              </div>

              <label class="flex items-center cursor-pointer">
                <input type="radio" name="recipient_type" value="individuals"
                       data-action="change->communications#toggleRecipientType"
                       class="mr-2 accent-pink-500 cursor-pointer">
                <span class="text-sm">Select specific people</span>
              </label>
            </div>

            <%# Hidden field for send_to_all %>
            <input type="hidden" name="send_to_all" value="1" data-communications-target="sendToAllField">

            <%# Individual Selection (hidden by default) %>
            <div class="hidden ml-6 mt-3" data-communications-target="individualsSection">
              <div class="max-h-64 overflow-y-auto border border-gray-200 rounded-lg p-3 bg-gray-50 space-y-2">
                <% @talent_pool_people.each do |person| %>
                  <label class="flex items-center cursor-pointer">
                    <input type="checkbox" name="person_ids[]" value="<%= person.id %>" class="mr-2 accent-pink-500 cursor-pointer">
                    <span class="text-sm"><%= person.name %></span>
                  </label>
                <% end %>
              </div>
            </div>
          </div>

          <%# Subject with production prefix preview %>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Subject</label>
            <%= render "shared/subject_field_with_prefix", form: form, field_name: :title, production: @production, placeholder: "Email subject...", required: true %>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Message</label>
            <%= form.rich_text_area :body,
              class: "block w-full rounded-lg border border-gray-300 px-3 py-2 text-gray-900 placeholder:text-gray-400 focus:border-pink-500 focus:ring-pink-500" %>
          </div>

          <div class="flex items-center justify-end gap-3 pt-2">
            <%= render "shared/button", text: "Cancel", variant: "secondary", size: "medium", data: { action: "click->communications#closeModal" } %>
            <%= render "shared/button", text: "Send Email", variant: "primary", size: "medium", type: :submit %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
  </div><%# Close module content wrapper %>
</div>
