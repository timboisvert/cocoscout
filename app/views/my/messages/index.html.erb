<% content_for :title, "My Messages" %>

<div class="w-full pb-8" data-controller="inbox contact-production">
  <%# New messages banner - shown when new messages arrive via ActionCable %>
  <div data-inbox-target="banner" class="hidden sticky top-0 z-40 mb-4">
    <button
      type="button"
      data-action="click->inbox#refresh"
      class="w-full bg-pink-500 hover:bg-pink-600 text-white text-sm font-medium py-2 px-4 rounded-lg shadow-lg flex items-center justify-center gap-2 transition-colors cursor-pointer">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
      </svg>
      <span data-inbox-target="count">New messages</span>
    </button>
  </div>

  <%= render partial: "shared/notice", locals: { notice: notice } %>

  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [],
    text: "My Messages",
    links: [
      { icon: "check", text: "Mark All Read", path: mark_all_read_my_messages_path, method: :post, disabled: @unread_count == 0 }
    ]
  } %>

  <%# Contact Production Team Card %>
  <% if @contactable_productions.any? %>
    <div class="mt-4">
      <% if @contactable_productions.size == 1 %>
        <%= render "shared/contact_production_card", production: @contactable_productions.first %>
      <% else %>
        <%= render "shared/contact_production_card", productions: @contactable_productions %>
      <% end %>
    </div>
  <% end %>

  <%# Filter Bar %>
  <%= form_with url: my_messages_path, method: :get, data: { turbo_action: "advance" }, class: "mt-4" do |f| %>
    <%= render "shared/filters/filter_bar",
        toggle_label: "Filters",
        wrapper_data_controller: "filter-select",
        filter_groups: [
          {
            label: "Show",
            filters: [
              { text: "All", path: my_messages_path(q: @search, production_id: @production_filter, order: @order), active: @filter == "all" },
              { text: "Unread", path: my_messages_path(filter: "unread", q: @search, production_id: @production_filter, order: @order), active: @filter == "unread" }
            ]
          },
          { separator: true },
          {
            partial: "shared/filters/dropdown_filter",
            locals: {
              label: "Order",
              name: "order",
              options: [
                { value: "newest", text: "Newest First" },
                { value: "oldest", text: "Oldest First" }
              ],
              selected: @order || "newest",
              data_attributes: {
                action: "change->filter-select#update",
                filter_select_filter_value: @filter,
                filter_select_q_value: @search,
                filter_select_production_id_value: @production_filter
              }
            }
          },
          (@user_productions.any? ? { separator: true } : nil),
          (@user_productions.any? ? {
            partial: "shared/filters/dropdown_filter",
            locals: {
              label: "Production",
              name: "production_id",
              options: [{ value: "", text: "All Productions" }] + @user_productions.map { |p| { value: p.id.to_s, text: p.name } },
              selected: @production_filter.to_s,
              data_attributes: {
                action: "change->filter-select#update",
                filter_select_filter_value: @filter,
                filter_select_q_value: @search,
                filter_select_order_value: @order
              }
            }
          } : nil),
          { separator: true },
          {
            partial: "shared/filters/search_input",
            locals: {
              placeholder: "Search messages...",
              value: @search,
              name: "q"
            }
          }
        ].compact
    %>
    <%# Hidden fields to preserve filters when searching %>
    <%= f.hidden_field :filter, value: @filter %>
    <%= f.hidden_field :production_id, value: @production_filter %>
  <% end %>

  <% if @messages.any? %>
    <div class="mt-4 space-y-4">
      <% @messages.each do |thread| %>
        <%= render "shared/messages/message_card", message: thread %>
      <% end %>
    </div>

    <% if @pagy.pages > 1 %>
      <div class="mt-6 flex items-center justify-between">
        <div class="text-sm text-gray-500">
          Page <%= @pagy.page %> of <%= @pagy.pages %>
        </div>
        <div class="flex gap-2">
          <% if @pagy.previous %>
            <%= link_to "← Previous", my_messages_path(page: @pagy.previous), class: "px-3 py-1.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50" %>
          <% else %>
            <span class="px-3 py-1.5 text-sm font-medium text-gray-300 bg-white border border-gray-200 rounded-md cursor-not-allowed">← Previous</span>
          <% end %>
          <% if @pagy.next %>
            <%= link_to "Next →", my_messages_path(page: @pagy.next), class: "px-3 py-1.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50" %>
          <% else %>
            <span class="px-3 py-1.5 text-sm font-medium text-gray-300 bg-white border border-gray-200 rounded-md cursor-not-allowed">Next →</span>
          <% end %>
        </div>
      </div>
    <% end %>
  <% else %>
    <div class="mt-8 text-center py-12">
      <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
      </svg>
      <%
        empty_title, empty_message = case @filter
        when "unread"
          ["All caught up!", "You have no unread messages."]
        when "has_images"
          ["No messages with images", "None of your messages contain images."]
        when "archived"
          ["No archived messages", "You haven't archived any messages yet."]
        else
          if @search.present?
            ["No results", "No messages match \"#{@search}\"."]
          elsif @production_filter.present?
            ["No messages", "No messages for this production yet."]
          else
            ["No messages", "Your inbox is empty."]
          end
        end
      %>
      <h3 class="mt-2 text-sm font-medium text-gray-900"><%= empty_title %></h3>
      <p class="mt-1 text-sm text-gray-500"><%= empty_message %></p>
    </div>
  <% end %>

  <%# Contact Production Modal %>
  <% if @contactable_productions.any? %>
    <%= render "shared/contact_production_modal" %>
  <% end %>
</div>