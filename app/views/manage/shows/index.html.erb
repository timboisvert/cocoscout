<% content_for :title, "Shows - #{@production.name}" %>

<div class="w-full" data-turbo-cache="false">
  <%= render partial: "shared/notice", locals: { notice: notice } %>

  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [
      ["Shows & Events", manage_shows_path]
    ],
    text: @production.name,
    links: [
      { text: "Calendar", path: manage_production_shows_calendar_path(@production, filter: @filter) },
      { text: "Schedule Event", path: manage_shows_wizard_path(@production) }
    ]
  } %>

  <div class="border-t border-gray-200 pt-4 mt-2">
    <%= render "shared/filters/filter_bar", filter_groups: [
    {
      label: "View",
      filters: [
        { text: "Upcoming", path: manage_production_shows_path(@production, filter: "upcoming", event_type: @event_type_filter.join(",")), active: @filter == "upcoming" },
        { text: "Past", path: manage_production_shows_path(@production, filter: "past", event_type: @event_type_filter.join(",")), active: @filter == "past" }
      ]
    },
    { separator: true },
    {
      partial: "shared/filters/event_type_multiselect_filter",
      locals: {
        path_helper: ->(event_type:, entity:, filter: nil) { manage_production_shows_path(@production, event_type: event_type, filter: filter || @filter) },
        event_type_filter: @event_type_filter,
        entity_filter: [],
        filter: @filter
      }
    }
  ] %>

  <% if @shows.any? %>
    <div class="space-y-1" data-controller="linked-highlight">
      <% @shows.each do |show| %>
        <%
          is_third_party = @production.type_third_party?

          if is_third_party
            # For third-party: show rental and services
            services = @contract_services || []
          else
            # For in-house: show cast summary
            assignments = @assignments_by_show[show.id] || []
            roles = @roles_by_show[show.id] || []
            cant_make_it = @cant_make_it_by_show[show.id] || {}
            sign_up_regs = @sign_up_registrations_by_show[show.id] || []
            assignments_by_role = assignments.group_by(&:role_id)
            cast_summary = {
              roles: roles,
              assignments_by_role: assignments_by_role,
              cant_make_it_by_assignment: cant_make_it,
              sign_up_registrations: sign_up_regs
            }
          end
        %>
        <%= render partial: "shared/show_row", locals: {
          show: show,
          link_path: manage_show_path(@production, show),
          show_canceled: true,
          show_recurring: true,
          show_linked: true,
          show_location: true,
          right_panel: is_third_party ? :rental_services : :cast_summary,
          cast_summary: is_third_party ? nil : cast_summary,
          services: is_third_party ? services : nil
        } %>
      <% end %>
    </div>
  <% else %>
    <div class="text-sm text-gray-500">
      You haven't scheduled any shows or events.
    </div>
  <% end %>
  </div>
</div>

<%# Turbo frame for recurring series modal %>
<%= turbo_frame_tag "recurring_series_modal" %>
