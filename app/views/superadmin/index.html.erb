<% content_for :title, "Superadmin" %>

<div class="w-full px-5 pt-5">

  <%= render partial: "shared/notice", locals: { notice: notice } %>

  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [],
    text: "Superadmin",
    links: [
      { text: "Exit", path: manage_path }
    ]
  } %>

  <!-- First Row: Organizations (left) and Queue Monitor + Email Logs (right stacked) -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
    <!-- Organizations Overview Card (left, tall) -->
    <%= link_to organizations_list_path, class: "block md:row-span-2" do %>
      <div class="border border-gray-200 rounded-lg overflow-hidden hover:border-pink-500 transition-all h-full">
        <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
          <h3 class="text-md font-semibold text-gray-900 coustard-regular">Organizations</h3>
        </div>
        <div class="p-6">

          <!-- Stats Grid -->
          <div class="grid grid-cols-3 gap-3 mt-4">
            <div>
              <div class="text-2xl font-bold text-gray-900"><%= @organizations_total %></div>
              <div class="text-xs text-gray-500 mt-1">Total</div>
            </div>
            <div>
              <div class="text-2xl font-bold text-green-600"><%= @organizations_new_this_week %></div>
              <div class="text-xs text-gray-500 mt-1">New This Week</div>
            </div>
            <div>
              <div class="text-2xl font-bold text-blue-600"><%= @organizations_new_this_month %></div>
              <div class="text-xs text-gray-500 mt-1">New This Month</div>
            </div>
          </div>

          <!-- Recent Organizations -->
          <% if @recent_organizations.any? %>
            <div class="mt-4 pt-3 border-t border-gray-200">
              <p class="text-xs font-medium text-gray-600 mb-2">Recent:</p>
              <div class="space-y-1">
                <% @recent_organizations.each do |org| %>
                  <div class="text-sm text-gray-700">
                    <%= org.name %>
                    <span class="text-xs text-gray-400"><%= org.created_at.strftime("%b %d") %></span>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- Right Column: Queue Monitor and Email Logs (stacked) -->
    <div class="grid grid-cols-1 gap-4">
      <!-- Queue Monitor Link Card -->
      <%= link_to queue_monitor_path, class: "block" do %>
        <div class="border border-gray-200 rounded-lg overflow-hidden hover:border-pink-500 transition-all">
          <div class="p-6">
            <h3 class="text-lg font-semibold text-gray-900 coustard-regular">Queue Monitor</h3>
            <p class="text-sm text-gray-600 mt-1">View job queue status and failed jobs</p>
          </div>
        </div>
      <% end %>

      <!-- Email Logs Link Card -->
      <%= link_to email_logs_path, class: "block" do %>
        <div class="border border-gray-200 rounded-lg overflow-hidden hover:border-pink-500 transition-all">
          <div class="p-6">
            <h3 class="text-lg font-semibold text-gray-900 coustard-regular">Email Logs</h3>
            <p class="text-sm text-gray-600 mt-1">View all sent emails and delivery status</p>
          </div>
        </div>
      <% end %>

      <!-- Storage Monitor Link Card -->
      <%= link_to storage_monitor_path, class: "block" do %>
        <div class="border border-gray-200 rounded-lg overflow-hidden hover:border-pink-500 transition-all">
          <div class="p-6">
            <h3 class="text-lg font-semibold text-gray-900 coustard-regular">Storage Monitor</h3>
            <p class="text-sm text-gray-600 mt-1">View S3 storage stats and run cleanup tasks</p>
          </div>
        </div>
      <% end %>

      <!-- Cache Monitor Link Card -->
      <%= link_to cache_monitor_path, class: "block" do %>
        <div class="border border-gray-200 rounded-lg overflow-hidden hover:border-pink-500 transition-all">
          <div class="p-6">
            <h3 class="text-lg font-semibold text-gray-900 coustard-regular">Cache Monitor</h3>
            <p class="text-sm text-gray-600 mt-1">View cache stats, patterns, and clear cache</p>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Impersonate -->
  <div class="border border-gray-200 rounded-lg overflow-hidden mt-4">
    <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
      <h3 class="text-md font-semibold text-gray-900 coustard-regular">Impersonate</h3>
    </div>
    <div class="p-4">
      <%= form_with url: impersonate_user_path, method: :post, local: true, class: "flex items-center space-x-2" do |f| %>
        <%= f.email_field :email, required: true, autocapitalize: "none", class: "inline-block shadow-sm rounded-lg border px-3 py-2 flex-1 border-gray-400" %>
        <%= f.submit "Impersonate", class: "sm:w-auto rounded-lg px-3.5 py-2.5 text-white bg-pink-500 hover:bg-pink-600 inline-block font-medium cursor-pointer" %>
      <% end %>

      <% if @recent_impersonations.any? %>
        <h1 class="text-sm font-medium mt-4 mb-1">Recent Impersonations:</h1>
        <div class="grid grid-cols-1 gap-2">
          <% @recent_impersonations.each do |recent| %>
            <div class="p-2 border border-gray-200 rounded-lg hover:border-gray-400 transition-all items-top">
              <%= button_to impersonate_user_path, method: :post, params: { email: recent["email"] }, class: "w-full text-left cursor-pointer" do %>
                <div class="font-bold text-pink-500"><%= recent["name"] %></div>
                <div class="text-sm text-gray-500"><%= recent["email"] %></div>
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>

      <% if session[:impersonate_user_id] %>
        <div class="my-4">
          <%= button_to "Stop Impersonating", stop_impersonating_user_path, method: :post, class: "px-3 py-1 rounded bg-gray-500 text-white" %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Change Email Address -->
  <div class="border border-gray-200 rounded-lg overflow-hidden mt-4">
    <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
      <h3 class="text-md font-semibold text-gray-900 coustard-regular">Change Email Address</h3>
    </div>
    <div class="p-4">
      <p class="text-xs text-gray-500">This will update the user's email_address and their person's email to the new address.</p>
      <%= form_with url: change_email_user_path, method: :post, local: true, class: "space-y-3 mt-2" do |f| %>
        <div>
          <%= f.label :old_email, "Current Email Address", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= f.email_field :old_email, required: true, autocapitalize: "none", class: "block shadow-sm rounded-lg border px-3 py-2 w-full border-gray-400" %>
        </div>
        <div>
          <%= f.label :new_email, "New Email Address", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= f.email_field :new_email, required: true, autocapitalize: "none", class: "block shadow-sm rounded-lg border px-3 py-2 w-full border-gray-400" %>
        </div>
        <%= f.submit "Change Email", class: "rounded-lg px-3.5 py-2.5 text-white bg-pink-500 hover:bg-pink-600 font-medium cursor-pointer" %>
      <% end %>
    </div>
  </div>