<% content_for :title, "Show: #{@show.date_and_time.strftime("%A, %B %-d, %Y")}" %>

<div class="w-full pb-10">
  <%= render partial: "shared/notice", locals: { notice: notice } %>
  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [
      ["Casting & Roles", manage_production_casting_path(@production)],
      [@show.date_and_time.strftime("%A, %b %d, %Y"), manage_production_show_path(@production, @show)]
    ],
    text: @show.casting_finalized? ? "Finalized Cast" : "Edit Cast",
    links: []
  } %>

  <%= render "manage/shows/show_info_card", show: @show %>

  <% if @show.casting_finalized? %>
    <%# ===== FINALIZED STATE ===== %>
    <%= render "manage/casting/finalized_cast", show: @show, production: @production, roles: @roles, assignments_by_role_id: @assignments_by_role_id, people_by_id: @people_by_id, groups_by_id: @groups_by_id %>
  <% else %>
    <%# ===== EDITING STATE ===== %>
    <div data-controller="drop-role" data-drop-role-show-id-value="<%= @show.id %>" data-drop-role-production-id-value="<%= @production.id %>">
    <%= render "shared/help_section",
      title: "How to assign talent pool members to roles",
      initial_state: "closed",
      storage_key: "casting_help_collapsed",
      steps: [
        { text: "<strong>Drag to assign:</strong> Drag a talent pool member from the right panel onto a role box on the left." },
        { text: "<strong>Swap roles:</strong> Drag a person from one role to another to swap their assignments." },
        { text: "<strong>Remove assignment:</strong> Hover over an assigned person and click the Ã— button to remove them." },
        { text: "<strong>Filter by availability:</strong> Use the \"Available\" button to see only people who've marked themselves available for this show." }
      ] %>

    <%
      # Count filled slots (assignments) vs total slots
      filled_slots = @assignments.size
      total_slots = @roles_count  # This is now sum of quantities from controller
      percentage = total_slots > 0 ? (filled_slots.to_f / total_slots * 100).round : 0
      fully_cast = percentage == 100

      # Linkage sync status
      is_linked = @show.linked?
      sync_info = @linkage_sync_info
      all_in_sync = sync_info.present? ? sync_info[:all_in_sync] : true
      can_finalize = fully_cast && (!is_linked || all_in_sync)
    %>

    <% if total_slots > 0 %>
      <div id="casting-progress-bar" class="bg-white border border-gray-200 rounded-lg overflow-hidden mb-6">
        <div class="p-4">
          <div class="flex items-center justify-between mb-3">
            <span id="progress-label" class="text-sm font-semibold text-gray-900">
              <% if fully_cast %>
                This show is 100% cast
              <% else %>
                <%= filled_slots %> of <%= total_slots %> slots filled
              <% end %>
            </span>
            <span id="progress-fraction" class="text-sm font-bold <%= fully_cast ? 'text-green-600' : 'text-pink-600' %>">
              <%= filled_slots %>/<%= total_slots %> cast
            </span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div id="progress-bar" class="<%= fully_cast ? 'bg-green-500' : 'bg-pink-500' %> h-2 rounded-full transition-all" style="width: <%= percentage %>%"></div>
          </div>
        </div>

        <%# Linkage sync section - always shown for linked shows %>
        <% if is_linked && sync_info.present? %>
          <%= render "manage/casting/linkage_sync_section",
              show: @show,
              linked_shows: @linked_shows,
              sync_info: sync_info,
              production: @production,
              fully_cast: fully_cast %>
        <% end %>

        <%# Finalize section - shown when fully cast AND (not linked OR in sync) %>
        <div id="finalize-section-wrapper" class="<%= can_finalize ? '' : 'hidden' %>">
          <%= render "manage/casting/finalize_section",
              show: @show,
              production: @production,
              linked_shows: is_linked ? @linked_shows : [],
              cast_email_draft: @cast_email_draft,
              removed_email_draft: @removed_email_draft %>
        </div>
      </div>
    <% end %>

    <div class="flex flex-col lg:flex-row gap-6 lg:gap-8">

      <!-- Roles on the left (or top on mobile) -->
      <div class="w-full lg:w-1/2">
        <%= render partial: "manage/casting/roles_list", locals: {
          show: @show,
          roles: @roles,
          assignments_by_role_id: @assignments_by_role_id,
          people_by_id: @people_by_id,
          groups_by_id: @groups_by_id,
          sync_info: @linkage_sync_info
        } %>
      </div>

      <!-- Cast Members on the right (or bottom on mobile) - sticky on desktop -->
      <div class="hidden lg:block w-full lg:w-1/2 lg:sticky lg:top-4 lg:h-fit">
        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
          <%= render "shared/card_header", title: "Talent Pool" %>
          <%
            is_linked = @show.linked?
            linked_count = is_linked ? @linked_shows.count : 0
          %>
          <div class="p-4 border-b border-gray-200" data-controller="cast-filter" data-cast-filter-is-linked-value="<%= is_linked %>" data-cast-filter-linked-count-value="<%= linked_count %>">
            <!-- Availability Filter -->
            <% if is_linked && linked_count > 0 %>
              <%# Linked shows: Show Fully Available / Partially Available / All filters %>
              <%= render "shared/filters/filter_bar", bare: true, filter_groups: [
                {
                  filters: [
                    {
                      text: "Fully Available",
                      path: "#",
                      active: true,
                      data: {
                        action: "cast-filter#filterByAvailability",
                        value: "fully-available"
                      }
                    },
                    {
                      text: "Partially Available",
                      path: "#",
                      active: false,
                      data: {
                        action: "cast-filter#filterByAvailability",
                        value: "partially-available"
                      }
                    },
                    {
                      text: "All Talent Pool Members",
                      path: "#",
                      active: false,
                      data: {
                        action: "cast-filter#filterByAvailability",
                        value: "all"
                      }
                    }
                  ]
                }
              ] %>
            <% else %>
              <%# Non-linked shows: Show Available / All filters %>
              <%= render "shared/filters/filter_bar", bare: true, filter_groups: [
                {
                  filters: [
                    {
                      text: "Available",
                      path: "#",
                      active: true,
                      data: {
                        action: "cast-filter#filterByAvailability",
                        value: "available"
                      }
                    },
                    {
                      text: "All Talent Pool Members",
                      path: "#",
                      active: false,
                      data: {
                        action: "cast-filter#filterByAvailability",
                        value: "all"
                      }
                    }
                  ]
                }
              ] %>
            <% end %>
          </div>
          <div class="p-4 max-h-[calc(100vh-200px)] overflow-y-auto" data-cast-filter-target="list">
            <%= render partial: "manage/casting/cast_members_list", locals: {
              show: @show,
              availability: @availability,
              pool_members: @pool_members,
              assigned_member_keys: @assigned_member_keys,
              linked_availability: @linked_availability || {},
              linked_shows: @linked_shows || []
            } %>
          </div>
        </div>
      </div>

    </div>

    <%# Mobile Assign Modal %>
    <div data-drop-role-target="assignModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-end lg:hidden" data-action="click->drop-role#closeAssignModal">
      <div class="bg-white w-full rounded-t-2xl max-h-[60vh] flex flex-col" data-action="click->drop-role#stopPropagation">
        <div class="px-4 py-3 border-b border-gray-200 flex items-center justify-between flex-shrink-0">
          <h2 data-modal-title class="text-lg font-semibold text-gray-900">Assign Role</h2>
          <button type="button" data-action="click->drop-role#closeAssignModal" class="text-gray-400 hover:text-gray-600 p-1 cursor-pointer">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <div class="p-4 flex-1 overflow-hidden flex flex-col">
          <p class="text-xs text-gray-500 mb-3 flex-shrink-0">Available members appear first</p>
          <div class="space-y-1 overflow-y-auto flex-1">
            <%
              # Sort pool members: fully available first, then partially, then unavailable
              is_linked = @show.linked?
              linked_shows = @linked_shows || []
              total_linked_shows = linked_shows.count

              sorted_pool_members = (@pool_members || []).sort_by do |member|
                member_key = "#{member.class.name}_#{member.id}"
                member_availability = @availability[member_key] || @availability[member.id]
                is_available = member_availability&.available?
                linked_data = (@linked_availability || {})[member_key] || { available: 0 }
                linked_available_count = linked_data[:available]
                is_fully_available = is_available && linked_available_count == total_linked_shows
                is_partially_available = is_available || linked_available_count > 0
                is_assigned = (@assigned_member_keys || Set.new).include?(member_key)

                # Sort order: assigned last, then by availability (fully > partially > unavailable)
                [is_assigned ? 1 : 0, is_fully_available ? 0 : (is_partially_available ? 1 : 2), member.name]
              end
            %>
            <% sorted_pool_members.each do |member| %>
              <%
                member_key = "#{member.class.name}_#{member.id}"
                member_availability = @availability[member_key] || @availability[member.id]
                is_available = member_availability&.available?
                linked_data = (@linked_availability || {})[member_key] || { available: 0 }
                linked_available_count = linked_data[:available]
                is_fully_available = is_available && linked_available_count == total_linked_shows
                is_partially_available = is_available || linked_available_count > 0
                is_assigned = (@assigned_member_keys || Set.new).include?(member_key)
                is_person = member.is_a?(Person)
              %>
              <button type="button"
                class="w-full flex items-center gap-3 p-3 rounded-lg transition-all cursor-pointer <%= is_assigned ? 'opacity-50 bg-gray-50' : 'hover:bg-pink-50 active:bg-pink-100' %>"
                data-action="click->drop-role#assignFromModal"
                data-assignable-type="<%= is_person ? 'Person' : 'Group' %>"
                data-assignable-id="<%= member.id %>"
                <%= 'disabled' if is_assigned %>>
                <% headshot_variant = member.safe_headshot_variant(:thumb) %>
                <% if headshot_variant %>
                  <%= image_tag headshot_variant, alt: member.name, class: "w-10 h-10 rounded-lg object-cover flex-shrink-0" %>
                <% else %>
                  <div class="w-10 h-10 rounded-lg bg-gray-200 flex items-center justify-center text-gray-700 font-bold text-sm flex-shrink-0">
                    <%= member.initials %>
                  </div>
                <% end %>
                <div class="flex-1 text-left min-w-0">
                  <div class="font-medium text-sm text-gray-900 truncate"><%= member.name %></div>
                  <div class="text-xs text-gray-500">
                    <% if is_assigned %>
                      Already assigned
                    <% elsif is_fully_available %>
                      <span class="text-green-600">Available for all events</span>
                    <% elsif is_partially_available %>
                      <%
                        # Get the dates they're available for (current show + linked shows)
                        available_dates = []
                        available_dates << @show.date_and_time if is_available
                        linked_data[:shows]&.each do |show_data|
                          available_dates << show_data[:date_and_time] if show_data[:available] && show_data[:date_and_time]
                        end
                        available_dates = available_dates.compact.sort
                      %>
                      <span class="text-yellow-600">Available <%= available_dates.map { |d| d.strftime("%-m/%-d") }.join(", ") %></span>
                    <% elsif is_available %>
                      <span class="text-green-600">Available</span>
                    <% else %>
                      Not available
                    <% end %>
                  </div>
                </div>
                <% unless is_assigned %>
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-gray-400">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                  </svg>
                <% end %>
              </button>
            <% end %>
          </div>
        </div>
      </div>
    </div>
    </div><%# End drop-role controller wrapper %>
  <% end %>

</div>
