<% content_for :title, "Shows & Events" %>

<div class="w-full">

  <%= render partial: "shared/notice", locals: { notice: notice } %>

  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [],
    text: "My Shows & Events",
    links: [
      {
        text: "Calendar",
        path: my_shows_calendar_path,
        icon: "calendar"
      }
    ]
  } %>

  <% if @has_any_shows %>

  <%= render "shared/filters/filter_bar",
      toggle_label: "Filters & View Options",
      filter_groups: [
        {
          label: "View",
          filters: [
            { text: "My Assignments", path: my_shows_path(filter: 'my_assignments', event_type: @event_type_filter.join(','), entity: @entity_filter.join(',')), active: @filter == 'my_assignments' },
            { text: "All Shows", path: my_shows_path(filter: 'all', event_type: @event_type_filter.join(','), entity: @entity_filter.join(',')), active: @filter == 'all' },
            { text: "By Production", path: my_shows_path(filter: 'by_production', event_type: @event_type_filter.join(','), entity: @entity_filter.join(',')), active: @filter == 'by_production' }
          ]
        },
        { separator: true },
        {
          partial: "shared/filters/entity_filter",
          locals: {
            path_helper: method(:my_shows_path),
            person: @person,
            groups: @groups,
            entity_filter: @entity_filter,
            label: "Include",
            filter: @filter,
            event_type: @event_type_filter.join(",")
          }
        }
      ]
  %>

  <% if @filter == 'by_production' %>
    <!-- By Production View -->
    <% if @productions.any? %>
      <% @productions.each do |production| %>
        <% production_shows = @shows.select { |show| show.production_id == production.id } %>
        <% if production_shows.any? %>
          <div class="mb-6">
            <h2 class="text-lg font-bold mb-2"><%= production.name %></h2>
            <div class="space-y-1">
              <% production_shows.each do |show| %>
                <%
                  # Compute filtered assignments and roles for this show
                  filtered_assignments = []
                  role_names = []
                  if @show_assignments[show.id].present?
                    filtered_assignments = @show_assignments[show.id].select do |entity_info|
                      (entity_info[:type] == "person" && @entity_filter.include?("person")) ||
                      (entity_info[:type] == "group" && @entity_filter.include?("group_#{entity_info[:entity].id}"))
                    end
                    filtered_assignments.each do |entity_info|
                      assignment = ShowPersonRoleAssignment.find_by(
                        show_id: show.id,
                        assignable_type: entity_info[:type] == "person" ? "Person" : "Group",
                        assignable_id: entity_info[:entity].id
                      )
                      role_names << assignment.role.name if assignment
                    end
                  end
                  entity_headshots = filtered_assignments.map { |ei| ei[:entity] }
                %>
                <%= render partial: "shared/show_row", locals: {
                  show: show,
                  link_path: my_show_path(show),
                  show_canceled: true,
                  show_location: true,
                  roles: role_names,
                  entity_headshots: entity_headshots,
                  show_entity_headshots: @groups.any?
                } %>
              <% end %>
            </div>
          </div>
        <% end %>
      <% end %>
    <% else %>
      <div class="text-sm text-gray-500">
        No upcoming shows or events found for the selected filters.
      </div>
    <% end %>
  <% else %>
    <!-- All Shows View -->
    <% if @shows.any? %>
      <div class="space-y-1">
        <% @shows.each do |show| %>
          <%
            # Compute filtered assignments and roles for this show
            filtered_assignments = []
            role_names = []
            if @show_assignments[show.id].present?
              filtered_assignments = @show_assignments[show.id].select do |entity_info|
                (entity_info[:type] == "person" && @entity_filter.include?("person")) ||
                (entity_info[:type] == "group" && @entity_filter.include?("group_#{entity_info[:entity].id}"))
              end
              filtered_assignments.each do |entity_info|
                assignment = ShowPersonRoleAssignment.find_by(
                  show_id: show.id,
                  assignable_type: entity_info[:type] == "person" ? "Person" : "Group",
                  assignable_id: entity_info[:entity].id
                )
                role_names << assignment.role.name if assignment
              end
            end
            entity_headshots = filtered_assignments.map { |ei| ei[:entity] }
          %>
          <%= render partial: "shared/show_row", locals: {
            show: show,
            link_path: my_show_path(show),
            show_canceled: true,
            show_production: true,
            show_location: true,
            roles: role_names,
            entity_headshots: entity_headshots,
            show_entity_headshots: @groups.any?
          } %>
        <% end %>
      </div>
    <% else %>
      <div class="text-sm text-gray-500">
        No upcoming shows or events found for the selected filters.
      </div>
    <% end %>
  <% end %>

  <% else %>
    <p class="text-gray-500 text-sm">You aren't a cast member of any shows.</p>
  <% end %>

</div>