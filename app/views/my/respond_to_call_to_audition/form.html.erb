<% content_for :title, "CocoScout - Apply for an Audition" %>

<% content_for :head do %>
  <meta name="description" content="Apply to audition for <%= @production.name %>">
  <link rel="canonical" href="<%= respond_to_call_to_audition_url(@call_to_audition.token) %>">
<% end %>

<div class="max-w-4xl mx-auto p-6 mb-10">
  <h1 class="font-bold text-4xl"><%= @production.name %></h1>

  <% if @call_to_audition.audition_type == "in_person" %>
    <h1 class="font-bold text-2xl pt-5">Sign up for an in-person audition</h1>
  <% elsif @call_to_audition.audition_type == "video_upload" %>
    <h1 class="font-bold text-2xl pt-5">Submit a video audition</h1>
  <% end %>

  <% if @call_to_audition.header_text.present? %>
    <div class="pt-5">
      <%= @call_to_audition.header_text %>
    </div>
  <% end %>

  <%= form_with(model: @audition_request, url: my_submit_respond_to_call_to_audition_form_path(@call_to_audition.token), method: :post, class: "contents", data: { turbo: false }) do |form| %>

    <%
      # Show person form if there's an error, or if profile is incomplete
      show_person_form = @update_person_error ||
                        !Current.user.person.headshot.attached? ||
                        !Current.user.person.resume.attached? ||
                        Current.user.person.name == Current.user.email_address.split("@").first
    %>

    <div class="bg-white border border-gray-200 rounded-lg shadow-sm my-6">

      <div class="p-5 flex items-top gap-4">

        <% if Current.user.person.headshot.attached? %>
          <div class="flex-shrink-0">

            <%= image_tag url_for(Current.user.person.headshot.variant(:thumb)), class: "relative inline-block rounded-lg" %>
          </div>
        <% end %>

        <div>
          <div class="text-sm text-gray-700">
            Applying as:
          </div>

          <div class="font-bold text-lg text-gray-900">
            <%= Current.user.person.name %>
          </div>

          <div class="text-sm text-gray-600">
            <%= Current.user.email_address %>
          </div>

          <% unless show_person_form %>
            <div class="mt-2">
              <a id="update-profile-link" class="text-sm text-pink-500 cursor-pointer underline" onclick="document.getElementById('person-form-div').classList.remove('hidden'); this.classList.add('hidden');">Update your profile</a>
            </div>
          <% end %>

        </div>

      </div>

      <div class="px-5 <%= 'hidden' unless show_person_form %>" id="person-form-div">
        <%= form.fields_for @person do |person_form| %>
          <%= render "shared/person_form", person_form: person_form %>
        <% end %>
      </div>

    </div>

    <% if @call_to_audition.audition_type == "video_upload" %>
      <div class="bg-white border border-gray-200 rounded-lg shadow-sm my-6">
        <div class="p-5 flex items-top gap-4">
          <div class="w-full">

              <% if @call_to_audition.video_field_text.present? %>
                <div class="text-sm text-gray-500 mb-4">
                  <%= @call_to_audition.video_field_text %>
                </div>
              <% end %>

              <% if @audition_request.errors[:video_url].none? %>
                  <%= form.label :video_url, "Video URL" %>
                  <span class="text-sm text-gray-500"> (eg. YouTube, Google Drive, etc.)</span>
              <% else %>
                  <%= form.label :video_url, "Video URL is required", class: "text-pink-600"  %>
              <% end %>

              <%= form.text_field :video_url, class: ["block shadow-sm rounded-lg border px-3 py-2 mt-2 w-full", {"border-gray-400": @audition_request.errors[:video_url].none?, "border-pink-500": @audition_request.errors[:video_url].any?}] %>
          </div>
        </div>
      </div>
    <% end %>

    <% if @questions.any? %>
      <div class="bg-white border border-gray-200 rounded-lg shadow-sm p-5 mb-6 space-y-5">
        <% @questions.each do |question| %>
          <div class="">
            <label><%= question.text %></label>

            <% if question.question_type == "text" %>

              <%= text_area_tag "question[#{question.id}]", @answers["#{question.id}"], class: "block shadow-sm rounded-lg border px-3 py-2 mt-2 w-full" %>

            <% elsif question.question_type == "yesno" %>

              <div class="px-2 py-1">
                <%= radio_button_tag "question[#{question.id}]", "yes", checked: (@answers["#{question.id}"] == "yes" || @answers["#{question.id}"].blank?), class: "accent-pink-500 mr-1" %>
                <%= label_tag "question[#{question.id}][yes]", "Yes" %>
              </div>
              <div class="px-2 py-1">
                <%= radio_button_tag "question[#{question.id}]", "no", checked: (@answers["#{question.id}"] == "no"), class: "accent-pink-500 mr-1" %>
                <%= label_tag "question[#{question.id}][no]", "No" %>
              </div>

            <% elsif question.question_type == "multiple-multiple" %>

              <label class="text-sm text-gray-500">(Select all that apply)</label>

              <% question.question_options.each do |option| %>

                <div class="px-2 py-1">
                  <%= check_box_tag "question[#{question.id}][#{option.text}]", option.text, @answers["#{question.id}"]&.include?(option.text),class: "accent-pink-500 mr-1" %>
                  <%= label_tag "question[#{question.id}][#{option.text}]", option.text %>
                </div>
              <% end %>

            <% elsif question.question_type == "multiple-single" %>

              <label class="text-sm text-gray-500">(Select one)</label>

              <% question.question_options.each do |option| %>
                <div class="px-2 py-1">
                  <%= radio_button_tag "question[#{question.id}]", option.text, @answers["#{question.id}"] == option.text, class: "accent-pink-500 mr-1" %>
                  <%= label_tag "question[#{question.id}][#{option.text}]", option.text %>
                </div>
              <% end %>

          <% end %>

          </div>
        <% end %>
      </div>
    <% end %>

    <div class="">

      <%
        if @call_to_audition.audition_type == "in_person"
          if @call_to_audition.audition_requests.exists?(person: Current.user.person)
            submit_text = "Update Sign-up"
          else
            submit_text = "Sign up"
          end
        elsif @call_to_audition.audition_type == "video_upload"
          if @call_to_audition.audition_requests.exists?(person: Current.user.person)
            submit_text = "Update video audition"
          else
            submit_text = "Submit video audition"
          end
        end
      %>
      <%= form.submit submit_text, class: "sm:w-auto rounded-lg px-3.5 py-2.5 text-white bg-pink-500 hover:bg-pink-600 focus:ring-4 focus:outline-none focus:ring-pink-300 dark:focus:ring-pink-800inline-block font-medium cursor-pointer" %>
    </div>
  <% end %>

  <div class="w-16 pt-5 md:pt-0 fixed bottom-0 right-0 md:flex md:items-end md:justify-end">
    <%= link_to my_dashboard_path do %>
      <img src="<%= asset_path('cocoscout.png') %>" alt="CocoScout" class="object-contain select-none pointer-events-none mr-5" />
    <% end %>
  </div>

</div>