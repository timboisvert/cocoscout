<% content_for :title, "Edit #{ @show.event_type.titleize }: #{@show.date_and_time.strftime("%A, %B %-d, %Y")}" %>

<div class="w-full mb-10" data-controller="location-modal tabs" data-location-modal-event-type-value="<%= @show.event_type&.titleize&.downcase || 'event' %>">
  <%= render partial: "shared/notice", locals: { notice: notice } %>
  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [
       ["Shows & Events", manage_production_shows_path(@production)]
    ],
    text: @show.date_and_time.strftime("%A, %B %-d, %Y"),
    links: []
  } %>

  <%= render "shared/help_section",
    title: "Editing Shows & Events",
    initial_state: "closed",
    storage_key: "shows_edit_help_collapsed",
    steps: [
      { text: "<strong>Event Type:</strong> You can change the event type (show, rehearsal, meeting, etc.) after creation." },
      { text: "<strong>Recurring Events:</strong> For recurring series, you can update properties on all events at once, or optionally change the schedule (which recreates the series)." },
      { text: "<strong>Optional Settings:</strong> Update the secondary name, change the poster image, or modify notes as needed." }
    ] %>

<%= form_with(model: [:manage, @production, @show], class: "contents", data: { controller: "show-edit recurring-edit", "show-edit-casting-defaults-value": EventTypes.casting_enabled_defaults.to_json }) do |form| %>

  <!-- Tabs Navigation -->
  <nav class="flex space-x-2 border-b border-gray-200 mt-6 mb-4 overflow-x-auto">
    <button type="button" data-tabs-target="tab" data-index="0" data-action="tabs#select" class="px-4 py-2 text-sm font-medium bg-white border-b-2 text-pink-600 cursor-pointer whitespace-nowrap">Basic Information</button>
    <button type="button" data-tabs-target="tab" data-index="1" data-action="tabs#select" class="px-4 py-2 text-sm font-medium bg-gray-50 border-b-2 text-gray-500 cursor-pointer whitespace-nowrap">Schedule</button>
    <button type="button" data-tabs-target="tab" data-index="2" data-action="tabs#select" class="px-4 py-2 text-sm font-medium bg-gray-50 border-b-2 text-gray-500 cursor-pointer whitespace-nowrap">Poster & Links</button>
    <button type="button" data-tabs-target="tab" data-index="3" data-action="tabs#select" class="px-4 py-2 text-sm font-medium bg-gray-50 border-b-2 text-gray-500 cursor-pointer whitespace-nowrap">Linked Events</button>
    <button type="button" data-tabs-target="tab" data-index="4" data-action="tabs#select" class="px-4 py-2 text-sm font-medium bg-gray-50 border-b-2 text-gray-500 cursor-pointer whitespace-nowrap">Public Listing</button>
    <button type="button" data-tabs-target="tab" data-index="5" data-action="tabs#select" class="px-4 py-2 text-sm font-medium bg-gray-50 border-b-2 text-red-500 cursor-pointer whitespace-nowrap">Danger Zone</button>
  </nav>

  <!-- Tab 1: Basic Information -->
  <div data-tabs-target="panel">
    <!-- Event Type and Location -->
    <div class="w-full sm:flex sm:space-x-5">
      <div class="w-full sm:w-1/2">
        <%= form.label :event_type, "Event Type" %>
        <%= form.select :event_type,
            EventTypes.for_select,
            { include_blank: false },
            {
              class: ["block shadow-sm rounded-lg border px-3 py-2 mt-2 w-full", {"border-gray-400": @show.errors[:event_type].none?, "border-pink-500": @show.errors[:event_type].any?}],
              data: {
                recurring_edit_target: "eventTypeSelect",
                show_edit_target: "eventTypeSelect",
                action: "change->recurring-edit#updateButtonText change->show-edit#updateTitle change->location-modal#updateEventType"
              }
            }
        %>
      </div>

      <div class="w-full sm:w-1/2 mt-5 sm:mt-0">
        <label class="">Location</label>

        <!-- Hidden field for is_online -->
        <%= form.hidden_field :is_online, value: @show.is_online, data: { "location-modal-target": "isOnlineField" } %>

        <!-- In-Person Location Container -->
        <div data-location-modal-target="inPersonContainer" class="<%= @show.is_online ? 'hidden' : '' %>">
          <%= form.collection_select :location_id, Current.organization.locations.order(:created_at), :id, :name, { prompt: "Select a location" }, {
            class: ["block shadow-sm rounded-lg border px-3 py-2 mt-2 w-full", ( @show.errors[:location_id].any? ? "border-pink-500" : "border-gray-400" )],
            data: {
              "location-modal-target": "locationSelect",
              action: "change->location-modal#handleLocationChange"
            }
          } %>
          <div class="mt-1 ml-1 flex gap-2">
            <a href="#" data-action="click->location-modal#openModal" class="text-pink-500 underline text-sm">Add a Location</a>
            <span class="text-gray-400">|</span>
            <a href="#" data-action="click->location-modal#toggleLocationType" class="text-pink-500 underline text-sm" data-location-modal-target="toggleLink">
              <span data-location-modal-target="toggleLinkText">Host <%= @show.event_type&.titleize&.downcase || 'event' %> online</span>
            </a>
          </div>
        </div>

        <!-- Online Location Container -->
        <div data-location-modal-target="onlineContainer" class="<%= @show.is_online ? '' : 'hidden' %>">
          <%= form.text_field :online_location_info,
            placeholder: "e.g., Zoom link, YouTube Live URL, or 'Link will be emailed'",
            class: "block shadow-sm rounded-lg border border-gray-400 px-3 py-2 mt-2 w-full" %>
          <div class="mt-1 ml-1">
            <p class="text-xs text-gray-500 inline">Optional: Add a URL or instructions for joining online</p>
            <span class="text-gray-400 mx-1">|</span>
            <a href="#" data-action="click->location-modal#toggleLocationType" class="text-pink-500 underline text-sm" data-location-modal-target="toggleLink">
              <span data-location-modal-target="toggleLinkText">Host <%= @show.event_type&.titleize&.downcase || 'event' %> in person</span>
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Secondary Name -->
    <div class="mt-5">
      <%= form.label :secondary_name %>
      <div class="text-sm text-gray-500">(eg. If the event on this particular date has a sub-name or special name to go along with the Production name)</div>
      <%= form.text_field :secondary_name, class: ["w-full shadow-sm rounded-lg border px-3 py-2 mt-2", {"border-gray-400": @show.errors[:secondary_name].none?, "border-pink-500": @show.errors[:secondary_name].any?}] %>
    </div>
  </div>

  <!-- Tab 2: Schedule -->
  <div data-tabs-target="panel" class="hidden">

        <% if @show.recurring? %>
          <div class="w-full mb-4 p-4 bg-pink-50 border border-pink-200 rounded-lg">
            <div class="flex items-center mb-2">
              <svg class="w-5 h-5 text-pink-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              <span class="font-medium text-pink-900">This is a recurring event</span>
            </div>
            <p class="text-sm text-pink-700 mb-3">This event is part of a series of <%= @show.recurrence_group.count %> events.</p>

            <%= form.label :recurrence_edit_scope, "What would you like to edit?", class: "block text-sm font-medium text-gray-700 mb-2" %>
            <div class="space-y-2">
              <label class="flex items-center">
                <%= form.radio_button :recurrence_edit_scope, "this", checked: true, class: "accent-pink-500 mr-2",
                    data: { recurring_edit_target: "editScopeThis", action: "change->recurring-edit#toggleFields" } %>
                <span class="text-sm">Only this occurrence (<%= @show.date_and_time.strftime("%B %-d, %Y at %-l:%M %p") %>)</span>
              </label>
              <label class="flex items-center">
                <%= form.radio_button :recurrence_edit_scope, "all", class: "accent-pink-500 mr-2",
                    data: { recurring_edit_target: "editScopeAll", action: "change->recurring-edit#toggleFields" } %>
                <span class="text-sm">All <%= @show.recurrence_group.count %> occurrences in this series</span>
              </label>
            </div>
          </div>
        <% end %>

        <!-- Single Event Fields (shown when editing just this occurrence) -->
        <div data-recurring-edit-target="singleFields" class="<%= @show.recurring? ? '' : '' %>">
          <div class="w-full">
            <%= form.label :date_and_time, "Date and Time" %>
            <%= form.datetime_field :date_and_time, class: ["block shadow-sm rounded-lg border px-3 py-2 mt-2 w-full sm:w-64", {"border-gray-400": @show.errors[:date_and_time].none?, "border-pink-500": @show.errors[:date_and_time].any?}] %>
          </div>
        </div>

        <!-- Recurring Event Fields (shown when editing all occurrences) -->
        <% if @show.recurring? %>
          <div data-recurring-edit-target="recurringFields" class="hidden space-y-4">
            <!-- Info: changes will apply to all events -->
            <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
              <div class="flex items-start">
                <svg class="w-5 h-5 text-green-500 mr-2 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div>
                  <p class="text-sm font-medium text-green-900">Bulk Update</p>
                  <p class="text-sm text-green-700 mt-1">Changes you make here (event type, location, call time, etc.) will be applied to all <%= @show.recurrence_group.count %> events in this series.</p>
                </div>
              </div>
            </div>

            <!-- Optional: Change Schedule -->
            <details class="border border-gray-200 rounded-lg" data-recurring-edit-target="scheduleDetails">
              <summary class="px-4 py-3 cursor-pointer bg-gray-50 hover:bg-gray-100 rounded-lg font-medium text-sm text-gray-700 flex items-center justify-between">
                <span class="flex items-center">
                  <svg class="w-4 h-4 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                  </svg>
                  Change Schedule (Optional)
                </span>
                <span class="text-xs text-gray-500">(Click to expand)</span>
              </summary>
              <div class="p-4 space-y-4 border-t border-gray-200">
                <div class="p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                  <div class="flex items-start">
                    <svg class="w-5 h-5 text-yellow-500 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                    <p class="text-sm text-yellow-700">This will <strong>delete all existing events</strong> and create new ones. Cast assignments and customizations will be lost.</p>
                  </div>
                </div>

                <div>
                  <%= form.label :recurrence_start_datetime, "Start Date and Time" %>
                  <%= form.datetime_field :recurrence_start_datetime,
                      value: @show.recurrence_group.order(:date_and_time).first.date_and_time,
                      class: "block shadow-sm rounded-lg border border-gray-400 px-3 py-2 mt-2 w-full sm:w-64",
                      data: {
                        recurring_edit_target: "startDatetime",
                        action: "change->recurring-edit#updatePatternOptions"
                      } %>
                  <p class="text-sm text-gray-500 mt-1">This will become the new first event in the series</p>
                </div>

                <div>
                  <%= form.label :recurrence_pattern, "Repeat Pattern" %>
                  <%= form.select :recurrence_pattern,
                      [
                        ["Weekly (same day each week)", "weekly"],
                        ["Every other week", "biweekly"],
                        ["Monthly (same date each month)", "monthly_date"],
                        ["Monthly (same week and day)", "monthly_week"]
                      ],
                      { include_blank: "Select pattern" },
                      {
                        class: "block shadow-sm rounded-lg border border-gray-400 px-3 py-2 mt-2 w-full sm:w-96",
                        data: { recurring_edit_target: "patternSelect" }
                      }
                  %>
                </div>

                <div>
                  <%= form.label :recurrence_end_type, "Duration" %>
                  <%= form.select :recurrence_end_type,
                      [
                        ["3 Months", "3_months"],
                        ["6 Months", "6_months"],
                        ["12 Months", "12_months"],
                        ["Until End of #{Date.current.year}", "end_of_year"],
                        ["Until Specific Date", "custom"]
                      ],
                      { include_blank: "Select duration" },
                      {
                        class: "block shadow-sm rounded-lg border border-gray-400 px-3 py-2 mt-2 w-full sm:w-96",
                        data: { action: "change->recurring-edit#toggleCustomEndDate" }
                      }
                  %>
                </div>

                <div data-recurring-edit-target="customEndDateField" class="hidden">
                  <%= form.label :recurrence_custom_end_date, "End Date" %>
                  <%= form.date_field :recurrence_custom_end_date, class: "block shadow-sm rounded-lg border border-gray-400 px-3 py-2 mt-2 w-full sm:w-64" %>
                </div>
              </div>
            </details>
          </div>
        <% end %>

        <!-- Call Time Section -->
        <div class="mt-6 pt-6 border-t border-gray-200" data-controller="call-time">
          <div class="flex items-center justify-between mb-4">
            <div>
              <h4 class="text-sm font-semibold text-gray-900">Call Time</h4>
              <p class="text-xs text-gray-500 mt-1">Set a separate arrival time for cast before the event starts</p>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <%= form.check_box :call_time_enabled,
                  class: "sr-only peer",
                  data: {
                    call_time_target: "enabledToggle",
                    action: "change->call-time#toggleEnabled"
                  }
              %>
              <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
            </label>
          </div>
          <div data-call-time-target="callTimeFields" class="<%= @show.call_time_enabled? ? '' : 'hidden' %>">
            <%= form.label :call_time, "When should cast arrive?" %>
            <%= form.time_field :call_time,
                value: @show.call_time&.strftime("%H:%M"),
                class: "block shadow-sm rounded-lg border border-gray-400 px-3 py-2 mt-2 w-full sm:w-48",
                data: { call_time_target: "callTimeField" }
            %>
          </div>
        </div>
  </div>

  <!-- Tab 3: Poster & Links -->
  <div data-tabs-target="panel" class="hidden">
        <% if @show.poster.attached? && @show.poster.blob&.persisted? %>
          <div class="text-md flex items-center">
            <span>Show/Event Poster</span>
            <%= render "shared/button", text: "Remove Poster", variant: "danger", size: "small", type: :button, data: { action: "click->show-edit#removePoster" }, class: "ml-3" %>
          </div>
          <div class="my-2 flex p-4 border border-gray-200 rounded-lg hover:border-gray-400 hover:shadow-sm transition-all items-top max-w-md poster-container">
            <div class="w-full">
              <div class="mb-4 poster-image">
                <%= image_tag url_for(@show.poster), class: "rounded shadow w-full max-w-72 rounded-lg border border-gray-200" %>
              </div>

              <div class="flex items-center justify-between">
                <%= form.label :image, "Update Show/Event Poster:", class: "text-sm" %>
                <span class="text-sm text-gray-500">(JPEG, JPG, or PNG)</span>
              </div>

              <div class="block shadow-sm rounded-lg border px-3 py-2 mt-2 border-gray-400">
                <%= form.file_field :poster, class: "w-64 text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:text-white file:bg-pink-500 hover:file:bg-pink-600" %>
              </div>

              <%= form.hidden_field :remove_poster, value: "0", class: "remove-poster-hidden" %>
            </div>
          </div>
        <% else %>
          <div class="text-md">Show/Event Poster</div>
          <div class="mr-5 inline-block">
            <div class="flex items-center justify-between">
              <span class="text-sm text-gray-500">(JPEG, JPG, or PNG)</span>
            </div>

            <div class="block shadow-sm rounded-lg border px-3 py-2 mt-2 border-gray-400">
              <%= form.file_field :poster, class: "w-64 text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:text-white file:bg-pink-500 hover:file:bg-pink-600" %>
            </div>
          </div>
        <% end %>

        <div class="mt-5" data-controller="show-links">
          <label>Show/Event Links</label>
          <div class="text-sm text-gray-500 mb-2">Add links related to this show (e.g. ticketing, event page, social media posts, etc.)</div>
          <div id="show-links-fields" data-show-links-target="list" class="mt-1">
            <%= form.fields_for :show_links do |show_link_form| %>
              <div class="flex items-start gap-2 mb-2 show-links-fields-row" data-show-links-target="row">
                <%= show_link_form.hidden_field :id %>
                <%= show_link_form.hidden_field :_destroy, value: 0, class: "destroy-flag" %>
                <div class="flex-1 flex flex-col sm:flex-row gap-2">
                  <%= show_link_form.text_field :text, placeholder: "Link Text (e.g. Buy Tickets, Event Page)", class: "flex-1 shadow-sm rounded-lg border px-3 py-2 border-gray-400" %>
                  <%= show_link_form.text_field :url, placeholder: "URL", class: "flex-1 shadow-sm rounded-lg border px-3 py-2 border-gray-400" %>
                </div>
                <%= link_to "Remove", '#', class: "remove-show-link text-pink-500 underline text-sm whitespace-nowrap mt-2", data: { action: "show-links#remove" } %>
              </div>
            <% end %>
          </div>
          <%= link_to "Add Show/Event Link", '#', class: "text-pink-500 underline text-sm", data: { action: "show-links#add" } %>
          <template data-show-links-target="template">
            <div class="flex items-start gap-2 mb-2 show-links-fields-row" data-show-links-target="row">
              <input type="hidden" name="show[show_links_attributes][new_show_links][id]" />
              <input type="hidden" name="show[show_links_attributes][new_show_links][_destroy]" value="0" class="destroy-flag" />
              <div class="flex-1 flex flex-col sm:flex-row gap-2">
                <input type="text" name="show[show_links_attributes][new_show_links][text]" placeholder="Link Text (e.g. Buy Tickets, Event Page)" class="flex-1 shadow-sm rounded-lg border px-3 py-2 border-gray-400" />
                <input type="text" name="show[show_links_attributes][new_show_links][url]" placeholder="URL" class="flex-1 shadow-sm rounded-lg border px-3 py-2 border-gray-400" />
              </div>
              <a href="#" class="remove-show-link text-pink-500 underline text-sm whitespace-nowrap mt-2" data-action="show-links#remove">Remove</a>
            </div>
          </template>
        </div>
  </div>

  <!-- Tab 3: Linked Events -->
  <div data-tabs-target="panel" class="hidden">
    <%= render "manage/shows/linked_events", show: @show, production: @production %>
  </div>

  <!-- Tab 4: Public Listing -->
  <div data-tabs-target="panel" class="hidden">
    <%
      event_type_default = @production.event_type_publicly_visible?(@show.event_type)
      will_be_visible = @show.public_profile_visible.nil? ? event_type_default : @show.public_profile_visible
    %>

    <!-- Toggle Row -->
    <div class="flex items-center justify-between">
      <div class="flex-1">
        <p class="text-sm font-medium text-gray-700">Include this show/event on <%= @production.name %>'s public listing</p>
        <p class="text-xs text-gray-500 mt-1">
          When enabled, this event will be visible to anyone viewing your public profile.
          By default, <strong><%= @show.event_type %></strong> events are <strong><%= event_type_default ? "visible" : "hidden" %></strong>.
        </p>
      </div>
      <label class="relative inline-flex items-center cursor-pointer ml-4">
        <%= form.hidden_field :public_profile_visible, value: "false", id: "public_profile_visible_hidden" %>
        <%= form.check_box :public_profile_visible,
          {
            checked: will_be_visible,
            class: "sr-only peer",
            data: {
              show_edit_target: "publicProfileCheckbox",
              action: "change->show-edit#publicProfileToggled"
            }
          },
          true,
          false %>
        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
      </label>
    </div>

    <% if @production.public_profile_enabled && @production.public_key.present? %>
      <div class="mt-5 pt-5 border-t border-gray-200 <%= 'hidden' unless will_be_visible %>" data-show-edit-target="publicProfileContent">
        <%= render "shared/copy_url", url: public_profile_show_url(@production.public_key, @show), label: "This event's public listing URL:" %>
      </div>
    <% else %>
      <div class="mt-5 pt-5 border-t border-gray-200">
        <p class="text-sm text-gray-500">
          Public listing is not enabled for <%= @production.name %>.
          <a href="<%= edit_manage_production_path(@production) %>#tab-2" class="text-pink-500 hover:text-pink-600 underline">Enable it in production settings</a>
          to share your schedule publicly.
        </p>
      </div>
    <% end %>
  </div>

  <!-- Tab 5: Danger Zone -->
  <div data-tabs-target="panel" class="hidden">
    <div class="space-y-6">
      <!-- Move to Another Production -->
      <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
        <div class="flex items-start gap-4">
          <div class="flex-shrink-0">
            <svg class="w-8 h-8 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
            </svg>
          </div>
          <div class="flex-1">
            <h3 class="text-lg font-semibold text-yellow-800 mb-2">Move to Another Production</h3>
            <p class="text-sm text-yellow-700 mb-4">
              Move this <%= @show.event_type %> to a different production you have access to.
              All assignments, vacancies, and associated data will be moved along with it.
            </p>
            <div class="mt-4">
              <button type="button"
                      onclick="window.dispatchEvent(new CustomEvent('show-actions:open-move-modal')); return false;"
                      class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-lg border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-pink-500 focus:ring-offset-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/>
                </svg>
                Move <%= @show.event_type.titleize %>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Delete Event -->
      <div class="bg-red-50 border border-red-200 rounded-lg p-6">
        <div class="flex items-start gap-4">
          <div class="flex-shrink-0">
            <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
            </svg>
          </div>
          <div class="flex-1">
            <h3 class="text-lg font-semibold text-red-800 mb-2">Cancel or Delete this <%= @show.event_type.titleize %></h3>
            <p class="text-sm text-red-700 mb-4">
              Cancel to mark the event as canceled (preserves history), or delete to permanently remove it from the system.
              <% if @show.recurring? %>
                <strong>This is part of a recurring series of <%= @show.recurrence_group.count %> events.</strong>
              <% end %>
            </p>
            <div class="mt-4">
              <%= render "shared/button",
                  text: "Cancel or Delete",
                  variant: "danger",
                  size: "medium",
                  icon: "trash",
                  path: cancel_manage_production_show_path(@production, @show) %>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <div class="border-t border-gray-200 pt-5 mt-5">
    <%= render "shared/button", text: "Update #{sanitize(@show.event_type.titleize)}", variant: "primary", size: "medium", type: :submit, data: { show_edit_target: "submitButton", recurring_edit_target: "submitButton" } %>
    <%= render "shared/button", text: "Back", variant: "ghost-cancel", size: "medium", path: "javascript:history.back()", type: :button %>
  </div>

<% end %>

<!-- Move Modal (outside form to avoid nested form issues) -->
<%
  # Re-compute the values for the modal
  modal_accessible_productions = Current.user.accessible_productions
                                      .where.not(id: @production.id)
                                      .order(:name)
                                      .map { |prod| { id: prod.id, name: prod.name, show_count: prod.shows.count, logo_url: prod.logo.attached? ? url_for(prod.logo.variant(:small)) : nil } }

  modal_move_warnings = []
  modal_move_warnings << "#{@show.show_person_role_assignments.count} cast assignments will be moved with this event." if @show.show_person_role_assignments.any?
  modal_move_warnings << "#{@show.role_vacancies.count} vacancy records will be moved with this event." if @show.role_vacancies.any?
  modal_move_warning = modal_move_warnings.any? ? modal_move_warnings.join(" ") : nil
%>
<div id="show-move-modal"
     data-controller="show-actions"
     data-show-actions-productions-value="<%= modal_accessible_productions.to_json %>"
     data-show-actions-warning-value="<%= modal_move_warning %>">
  <div data-show-actions-target="moveModal"
       class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4"
       data-action="click->show-actions#closeMoveModal keydown.esc@window->show-actions#closeMoveModal">
    <div class="bg-white w-full max-w-md rounded-lg shadow-xl" data-action="click->show-actions#stopPropagation">
      <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
        <h2 class="text-lg font-semibold text-gray-900">Move <%= @show.event_type.titleize %> to Another Production</h2>
        <button type="button" data-action="click->show-actions#closeMoveModal" class="text-gray-400 hover:text-gray-600 p-1 cursor-pointer">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="p-6">
        <!-- Warning Box -->
        <div data-show-actions-target="warningBox" class="hidden mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
          <p data-show-actions-target="warningText" class="text-sm text-yellow-700"></p>
        </div>

        <p class="text-sm text-gray-600 mb-4">Select the production to move this <%= @show.event_type %> to:</p>

        <!-- Productions List -->
        <div data-show-actions-target="productionsList" class="space-y-2 max-h-64 overflow-y-auto">
          <div class="flex items-center justify-center py-8">
            <svg class="animate-spin h-6 w-6 text-pink-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="ml-2 text-sm text-gray-500">Loading productions...</span>
          </div>
        </div>
      </div>
      <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-end gap-3">
        <button type="button"
                data-action="click->show-actions#closeMoveModal"
                class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-900">
          Cancel
        </button>
        <%= form_with url: transfer_manage_production_show_path(@production, @show), method: :patch, data: { show_actions_target: "moveForm" } do |f| %>
          <%= f.hidden_field :target_production_id, value: "", data: { show_actions_target: "targetProductionId" } %>
          <%= render "shared/button", text: "Move #{@show.event_type.titleize}", variant: "primary", size: "medium", type: :submit, disabled: true, data: { show_actions_target: "moveButton" } %>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Location Modal -->
<div id="locationModal" data-location-modal-target="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
    <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between">
      <h2 class="text-2xl font-semibold coustard-regular">Add a Location</h2>
      <button type="button" data-action="click->location-modal#closeModal" class="text-gray-500 hover:text-gray-700">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <div class="px-6 py-6">
      <form data-location-modal-target="form" action="<%= manage_locations_path %>" method="post" data-action="submit->location-modal#submitForm">
        <div data-location-modal-target="errorContainer" class="hidden bg-pink-50 px-3 py-2 font-medium rounded-md mb-4">
          <h2 data-location-modal-target="errorCount"></h2>
          <ul data-location-modal-target="errorList" class="list-disc ml-6"></ul>
        </div>

        <%= hidden_field_tag :authenticity_token, form_authenticity_token %>

        <div>
          <label for="location_name">Name</label>
          <div class="text-gray-500 text-sm mb-1">The name of the location that will be displayed to users.</div>
          <input type="text" id="location_name" name="location[name]" value="" class="block shadow-sm rounded-md border px-3 py-2 mt-2 w-full border-gray-400" />
        </div>

        <div class="mt-10">
          <%= render partial: "shared/top_menu", locals: {
            breadcrumbs: [],
            text: "Address",
            links: []
          } %>

          <div class="my-5">
            <label for="location_address1">Street Address Line 1</label>
            <input type="text" id="location_address1" name="location[address1]" value="" class="block shadow-sm rounded-md border px-3 py-2 mt-2 w-full border-gray-400" />
          </div>

          <div class="my-5">
            <label for="location_address2">Street Address Line 2</label>
            <span class="text-sm text-gray-500">(optional)</span>
            <input type="text" id="location_address2" name="location[address2]" value="" class="block shadow-sm rounded-md border px-3 py-2 mt-2 w-full border-gray-400" />
          </div>

          <div class="my-5">
            <label for="location_city">City</label>
            <input type="text" id="location_city" name="location[city]" value="" class="block shadow-sm rounded-md border px-3 py-2 mt-2 w-full border-gray-400" />
          </div>

          <div class="my-5 flex flex-wrap gap-4">
            <div class="w-full md:w-[calc(50%-8px)]">
              <label for="location_state">State/Province</label>
              <select id="location_state" name="location[state]" class="block shadow-sm rounded-md border px-3 py-2 mt-2 w-full border-gray-400">
                <option value="">Select State/Province</option>
                <option value="AL">Alabama</option>
                <option value="AK">Alaska</option>
                <option value="AZ">Arizona</option>
                <option value="AR">Arkansas</option>
                <option value="CA">California</option>
                <option value="CO">Colorado</option>
                <option value="CT">Connecticut</option>
                <option value="DE">Delaware</option>
                <option value="DC">District of Columbia</option>
                <option value="FL">Florida</option>
                <option value="GA">Georgia</option>
                <option value="HI">Hawaii</option>
                <option value="ID">Idaho</option>
                <option value="IL">Illinois</option>
                <option value="IN">Indiana</option>
                <option value="IA">Iowa</option>
                <option value="KS">Kansas</option>
                <option value="KY">Kentucky</option>
                <option value="LA">Louisiana</option>
                <option value="ME">Maine</option>
                <option value="MD">Maryland</option>
                <option value="MA">Massachusetts</option>
                <option value="MI">Michigan</option>
                <option value="MN">Minnesota</option>
                <option value="MS">Mississippi</option>
                <option value="MO">Missouri</option>
                <option value="MT">Montana</option>
                <option value="NE">Nebraska</option>
                <option value="NV">Nevada</option>
                <option value="NH">New Hampshire</option>
                <option value="NJ">New Jersey</option>
                <option value="NM">New Mexico</option>
                <option value="NY">New York</option>
                <option value="NC">North Carolina</option>
                <option value="ND">North Dakota</option>
                <option value="OH">Ohio</option>
                <option value="OK">Oklahoma</option>
                <option value="OR">Oregon</option>
                <option value="PA">Pennsylvania</option>
                <option value="RI">Rhode Island</option>
                <option value="SC">South Carolina</option>
                <option value="SD">South Dakota</option>
                <option value="TN">Tennessee</option>
                <option value="TX">Texas</option>
                <option value="UT">Utah</option>
                <option value="VT">Vermont</option>
                <option value="VA">Virginia</option>
                <option value="WA">Washington</option>
                <option value="WV">West Virginia</option>
                <option value="WI">Wisconsin</option>
                <option value="WY">Wyoming</option>
                <option value="">--- Canadian Provinces ---</option>
                <option value="AB">Alberta</option>
                <option value="BC">British Columbia</option>
                <option value="MB">Manitoba</option>
                <option value="NB">New Brunswick</option>
                <option value="NL">Newfoundland and Labrador</option>
                <option value="NT">Northwest Territories</option>
                <option value="NS">Nova Scotia</option>
                <option value="NU">Nunavut</option>
                <option value="ON">Ontario</option>
                <option value="PE">Prince Edward Island</option>
                <option value="QC">Quebec</option>
                <option value="SK">Saskatchewan</option>
                <option value="YT">Yukon</option>
              </select>
            </div>

            <div class="w-full md:w-[calc(50%-8px)]">
              <label for="location_postal_code">Postal Code</label>
              <input type="text" id="location_postal_code" name="location[postal_code]" value="" class="block shadow-sm rounded-md border px-3 py-2 mt-2 w-full border-gray-400">
            </div>
          </div>
        </div>

        <div class="mt-10">
          <%= render partial: "shared/top_menu", locals: {
            breadcrumbs: [],
            text: "Notes/Instructions",
            links: []
          } %>

          <div class="my-5">
            <div class="text-gray-500 text-sm mb-1">Any additional information about this location, such as parking instructions, entry details, etc.</div>
            <textarea id="location_notes" name="location[notes]" rows="4" class="block shadow-sm rounded-md border px-3 py-2 mt-2 w-full border-gray-400"></textarea>
          </div>
        </div>

        <div class="flex gap-2 pt-6">
          <%= render "shared/button", text: "Add Location", variant: "primary", size: "medium", type: :submit %>
          <%= render "shared/button", text: "Cancel", variant: "ghost-cancel", size: "medium", type: :button, data: { action: "click->location-modal#closeModal" } %>
        </div>
      </form>
    </div>
  </div>
</div>

</div>
