<%#
  Renders a list of shows for the my/shows pages.
  Each show is rendered individually using _show_row.

  Required params:
    - show_rows: Array of row hashes with { show:, assignments: [...] }

  Optional params:
    - show_production: Show production name (default: false)
    - show_location: Show location (default: true)
    - has_groups: Whether user has groups (default: false)
    - show_cant_make_it: Show "Can't make it" link (default: false)
    - cant_make_it_person: Person for vacancy token (default: nil)
    - my_vacancies_by_show: Hash of show_id => vacancies user created (default: {})
    - my_vacancies_by_show: Hash of show_id => vacancies user created affecting that show (default: {})
    - link_path_helper: Lambda to generate link path for a show (default: nil)
%>

<%
  show_production = local_assigns.fetch(:show_production, false)
  show_location = local_assigns.fetch(:show_location, true)
  has_groups = local_assigns.fetch(:has_groups, false)
  show_cant_make_it = local_assigns.fetch(:show_cant_make_it, false)
  cant_make_it_person = local_assigns.fetch(:cant_make_it_person, nil)
  my_vacancies_by_show = local_assigns.fetch(:my_vacancies_by_show, {})
  link_path_helper = local_assigns.fetch(:link_path_helper, nil)

  # Sort rows by show date
  sorted_rows = show_rows.sort_by { |row| row[:show].date_and_time }
%>

<div class="space-y-1" data-controller="linked-highlight">
  <% sorted_rows.each do |row| %>
    <% show = row[:show] %>
    <%
      # Group assignments by entity for stacked right panels
      assignments_by_entity = row[:assignments].group_by { |a| [a[:type], a[:entity]&.id] }
      entity_assignments = assignments_by_entity.map do |(_type, _id), assignments|
        entity = assignments.first[:entity]
        {
          entity: entity,
          role_assignments: assignments.map { |a| { role_name: a[:assignment].role.name, entity_name: entity.name } }
        }
      end

      # Check for sign-up registrations
      sign_up_registrations = row[:sign_up_registrations] || []

      row_link_path = link_path_helper ? link_path_helper.call(show) : nil

      # Only show "Can't make it" if the user has assignments for this show (not sign-ups)
      row_show_cant_make_it = show_cant_make_it && row[:assignments].any?

      # For the vacancy link, use the first Person assignment's entity, or fall back to cant_make_it_person
      # This handles cases where user has multiple profiles with different assignments
      person_assignment = row[:assignments].find { |a| a[:type] == "person" }
      row_cant_make_it_person = person_assignment ? person_assignment[:entity] : cant_make_it_person

      # Get user's vacancies for this show (they've notified they can't make it)
      my_vacancies = my_vacancies_by_show[show.id] || []

      # Determine right panel type based on what data we have
      right_panel_type = if entity_assignments.any?
        :cast_assignment
      elsif sign_up_registrations.any?
        :sign_up
      else
        nil
      end
    %>
    <%= render partial: "shared/show_row", locals: {
      show: show,
      link_path: row_link_path,
      show_canceled: true,
      show_production: show_production,
      show_location: show_location,
      show_linked: true,
      entity_assignments: entity_assignments,
      sign_up_registrations: sign_up_registrations,
      has_groups: has_groups,
      right_panel: right_panel_type,
      show_cant_make_it: row_show_cant_make_it,
      cant_make_it_person: row_cant_make_it_person,
      my_vacancies: my_vacancies
    } %>
  <% end %>
</div>
