<% content_for :title, @group.name %>

<div class="w-full">

  <%= render partial: "shared/notice", locals: { notice: notice } %>

  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [
      ["Directory", manage_directory_path]
    ],
    text: @group.name,
    links: []
  } %>

  <%# Public Profile Link %>
  <div class="mb-4">
    <%= link_to public_profile_path(@group.public_key), target: "_blank", class: "inline-flex items-center gap-1 text-sm text-pink-600 hover:text-pink-700" do %>
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
        <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" />
      </svg>
      View Public Profile
    <% end %>
  </div>

  <div class="w-full" data-controller="tabs">
    <nav class="flex space-x-2 border-b border-gray-200 mb-4">
      <button type="button" data-tabs-target="tab" data-index="0" data-action="tabs#select" class="px-4 py-2 text-sm font-medium bg-white border-b-2 text-pink-600 cursor-pointer">Profile</button>
      <button type="button" data-tabs-target="tab" data-index="1" data-action="tabs#select" class="px-4 py-2 text-sm font-medium bg-gray-50 border-b-2 text-gray-500 cursor-pointer">Members</button>
      <button type="button" data-tabs-target="tab" data-index="2" data-action="tabs#select" class="px-4 py-2 text-sm font-medium bg-gray-50 border-b-2 text-gray-500 cursor-pointer">Availability</button>
    </nav>

    <div data-tabs-target="panel">
      <% headshot = @group.primary_headshot %>
      <% if headshot&.image&.attached? %>
        <div class="lg:hidden w-full">
          <%= image_tag url_for(headshot.image), class: "relative inline-block rounded-lg w-full" %>
        </div>
      <% end %>

      <div class="flex flex-col lg:flex-row items-start lg:space-x-6">
        <div class="flex-1 w-full">
          <div class="font-bold text-2xl sm:text-3xl mt-3"><%= @group.name %></div>

          <div class="mt-5">
            <%= render partial: "shared/top_menu", locals: {
              breadcrumbs: [],
              text: "Email & Socials",
              links: []
            } %>
          </div>

        <div class="flex items-center space-x-2 border-gray-200 mt-4">
          <svg width="20" height="20" class="fill-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path d="M112 128C85.5 128 64 149.5 64 176C64 191.1 71.1 205.3 83.2 214.4L291.2 370.4C308.3 383.2 331.7 383.2 348.8 370.4L556.8 214.4C568.9 205.3 576 191.1 576 176C576 149.5 554.5 128 528 128L112 128zM64 260L64 448C64 483.3 92.7 512 128 512L512 512C547.3 512 576 483.3 576 448L576 260L377.6 408.8C343.5 434.4 296.5 434.4 262.4 408.8L64 260z"/></svg>
          <%= mail_to @group.email, @group.email, class: "text-pink-500 text-sm hover:underline" %>
        </div>

        <div class="space-y-1 mt-1">
          <% @group.socials.each do |social| %>
            <div class="flex items-center space-x-2">
              <%= social.icon(20) %>
              <%= link_to social.handle, social.url, class: "text-pink-500 text-sm hover:underline", target: "_blank", rel: "noopener" %>
            </div>
          <% end %>
        </div>

        <% if current_user_can_manage? || Current.user&.superadmin? %>
          <div class="mt-5">
            <%= render partial: "shared/top_menu", locals: {
              breadcrumbs: [],
              text: "Actions",
              links: []
            } %>
          </div>

          <div class="mt-2">
            <% if current_user_can_manage? %>
              <% if @group.organizations.include?(Current.organization) %>
                <%= link_to "Remove from #{Current.organization.name}",
                    remove_from_organization_manage_group_path(@group),
                    data: {
                        turbo_method: :post,
                        turbo_confirm: "Are you sure you want to remove #{@group.name} from #{Current.organization.name}?"
                    },
                    class: "block text-xs text-pink-500 underline cursor-pointer mt-1"
                %>
              <% end %>
            <% end %>
          </div>
        <% end %>

        <% if Current.user&.superadmin? %>
          <div class="mt-5">
            <%= render partial: "shared/top_menu", locals: {
              breadcrumbs: [],
              text: "Superadmin Actions",
              links: []
            } %>
          </div>

          <div class="mt-2">
            <div class="space-y-1">
              <%= link_to "Delete",
                  manage_group_path(@group),
                  data: {
                      turbo_method: :delete,
                      turbo_confirm: "Are you sure you want to delete this group? This will remove them from ALL production companies."
                  },
                  class: "block text-xs text-pink-500 underline"
              %>
            </div>
          </div>
        <% end %>
      </div>

      <% if headshot&.image&.attached? %>
        <div class="hidden lg:block flex-shrink-0 max-w-[40%] w-full">
          <%= image_tag url_for(headshot.image), class: "relative inline-block rounded-lg w-full" %>
        </div>
      <% end %>
    </div>
    </div>

    <div data-tabs-target="panel" class="hidden">
      <% if @group.members.empty? %>
        <p class="text-left text-gray-500 text-sm">No members found.</p>
      <% else %>
        <div class="space-y-3">
          <% @group.members.each do |member| %>
            <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50">
              <%= link_to manage_person_path(member), class: "flex items-center space-x-4" do %>
                <% headshot = member.primary_headshot %>
                <% if headshot&.image&.attached? %>
                  <%= image_tag url_for(headshot.image.variant(:thumb)), class: "w-12 h-12 rounded-full object-cover" %>
                <% else %>
                  <div class="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center">
                    <span class="text-gray-500 text-sm font-semibold"><%= member.initials %></span>
                  </div>
                <% end %>
                <div class="flex-1">
                  <div class="text-sm font-semibold text-gray-900"><%= member.name %></div>
                  <div class="text-xs text-gray-500"><%= member.email %></div>
                </div>
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>

    <div data-tabs-target="panel" class="hidden">
      <% if @shows.empty? %>
        <p class="text-left text-gray-500 text-sm">No upcoming shows found for this group's productions.</p>
      <% else %>
        <div class="space-y-4">
          <% @shows.group_by(&:production).each do |production, shows| %>
            <div class="border border-gray-200 rounded-lg overflow-hidden">
              <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 flex items-center justify-between">
                <h3 class="text-md font-semibold text-gray-900 coustard-regular"><%= production.name %></h3>
                <% if current_user_can_manage?(production) %>
                  <% if @edit_mode %>
                    <%= link_to "Done", manage_group_path(@group, tab: 2), class: "text-pink-500 text-xs underline" %>
                  <% else %>
                    <%= link_to "Edit Availability", manage_group_path(@group, edit: 'true', tab: 2), class: "text-pink-500 text-xs underline" %>
                  <% end %>
                <% end %>
              </div>
              <% if @edit_mode && current_user_can_manage?(production) %>
                <%= form_with url: update_availability_manage_group_path(@group), method: :patch, local: true do |f| %>
                  <div class="divide-y divide-gray-200">
                    <% shows.each do |show| %>
                      <% availability = @availabilities[show.id] %>
                      <div class="px-4 py-3">
                        <div class="flex items-start justify-between">
                          <div class="flex-1">
                            <div class="text-sm text-gray-600 font-semibold">
                              <%= show.date_and_time.strftime("%A, %B %d, %Y at %l:%M %p") %>
                            </div>
                            <div class="flex items-center gap-2 mt-1">
                              <% event_type_badge_classes = case show.event_type
                                when "rehearsal" then "bg-blue-50 text-blue-700 ring-blue-600/10"
                                when "meeting" then "bg-green-50 text-green-700 ring-green-600/10"
                                else "bg-pink-50 text-pink-700 ring-pink-600/10"
                              end %>
                              <span class="inline-flex items-center rounded-md px-1.5 py-0.5 text-xs font-medium ring-1 ring-inset <%= event_type_badge_classes %>">
                                <%= show.event_type.titleize %>
                              </span>
                              <% if show.secondary_name.present? %>
                                <span class="text-xs text-gray-900 font-medium"><%= show.secondary_name %></span>
                              <% end %>
                            </div>
                          </div>
                          <div class="ml-4 flex gap-0 flex-shrink-0">
                            <%= f.radio_button "availability_Group_#{show.id}", 'available', { checked: availability&.available?, class: "sr-only peer/available", id: "availability_Group_#{show.id}_available" } %>
                            <%= label_tag "availability_Group_#{show.id}_available", class: "w-24 text-sm px-3 py-2 text-center border border-gray-200 cursor-pointer flex items-center justify-center rounded-l-lg border-r-0 bg-white text-gray-700 hover:bg-gray-50 peer-checked/available:bg-pink-500 peer-checked/available:text-white peer-checked/available:hover:bg-pink-500" do %>
                              Available
                            <% end %>

                            <%= f.radio_button "availability_Group_#{show.id}", 'unavailable', { checked: availability&.unavailable?, class: "sr-only peer/unavailable", id: "availability_Group_#{show.id}_unavailable" } %>
                            <%= label_tag "availability_Group_#{show.id}_unavailable", class: "w-24 text-sm px-3 py-2 text-center border border-gray-200 cursor-pointer flex items-center justify-center rounded-r-lg bg-white text-gray-700 hover:bg-gray-50 peer-checked/unavailable:bg-pink-500 peer-checked/unavailable:text-white peer-checked/unavailable:hover:bg-pink-500" do %>
                              Unavailable
                            <% end %>
                          </div>
                        </div>
                      </div>
                    <% end %>
                  </div>
                  <div class="px-4 py-3 bg-gray-50 border-t border-gray-200">
                    <%= f.submit "Update Availability", class: "font-medium rounded-lg text-sm px-5 h-10 py-2.5 text-center mb-0 inline-block text-white bg-pink-500 hover:bg-pink-600 cursor-pointer" %>
                  </div>
                <% end %>
              <% else %>
                <div class="divide-y divide-gray-200">
                  <% shows.each do |show| %>
                    <% availability = @availabilities[show.id] %>
                    <div class="px-4 py-3 flex items-center justify-between hover:bg-gray-50">
                      <div class="flex-1">
                        <div class="text-sm text-gray-600 font-semibold">
                          <%= show.date_and_time.strftime("%A, %B %d, %Y at %l:%M %p") %>
                        </div>
                        <div class="flex items-center gap-2 mt-1">
                          <% event_type_badge_classes = case show.event_type
                            when "rehearsal" then "bg-blue-50 text-blue-700 ring-blue-600/10"
                            when "meeting" then "bg-green-50 text-green-700 ring-green-600/10"
                            else "bg-pink-50 text-pink-700 ring-pink-600/10"
                          end %>
                          <span class="inline-flex items-center rounded-md px-1.5 py-0.5 text-xs font-medium ring-1 ring-inset <%= event_type_badge_classes %>">
                            <%= show.event_type.titleize %>
                          </span>
                          <% if show.secondary_name.present? %>
                            <span class="text-xs text-gray-900 font-medium"><%= show.secondary_name %></span>
                          <% end %>
                        </div>
                      </div>
                      <div class="ml-4">
                        <% if availability %>
                          <% if availability.available? %>
                            <span class="text-sm font-medium text-pink-500">Available</span>
                          <% elsif availability.unavailable? %>
                            <span class="text-sm font-medium text-gray-900">Unavailable</span>
                          <% else %>
                            <span class="text-sm text-gray-400">No response</span>
                          <% end %>
                        <% else %>
                          <span class="text-sm text-gray-400">No response</span>
                        <% end %>
                      </div>
                    </div>
                  <% end %>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>

  </div>

</div>
