<% content_for :title, "Sign-ups" %>

<div class="w-full">

  <%= render partial: "shared/notice", locals: { notice: notice } %>

  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [],
    text: "My Sign-ups",
    links: []
  } %>

  <%= render "shared/filters/filter_bar",
      toggle_label: "Filters",
      filter_groups: [
        {
          label: "View",
          filters: [
            {
              text: "Open Sign-up Windows",
              path: my_audition_requests_path(requests_filter: "open", entity: @entity_filter.join(",")),
              active: @requests_filter == "open"
            },
            {
              text: "All Sign-ups",
              path: my_audition_requests_path(requests_filter: "all", entity: @entity_filter.join(",")),
              active: @requests_filter == "all"
            }
          ]
        },
        { separator: true },
        {
          partial: "shared/filters/entity_filter",
          locals: {
            path_helper: method(:my_audition_requests_path),
            people: @people,
            groups: @groups,
            entity_filter: @entity_filter,
            label: "Include",
            requests_filter: @requests_filter
          }
        }
      ]
  %>

    <% if @audition_requests.any? %>

        <div class="grid grid-cols-1 gap-1 mt-2">
            <% @audition_requests.each do |audition_request| %>
                <div class="p-4 bg-white border border-gray-200 rounded-lg hover:border-gray-400 transition-all flex items-start">

                    <% production = audition_request.audition_cycle.production %>

                    <div class="grid grid-cols-1 sm:grid-cols-5 gap-2 w-full">
                        <div class="col-span-1 sm:col-span-3 items-center">

                            <div class="flex flex-col sm:flex-row sm:items-center gap-4">
                                <% logo_variant = production.safe_logo_variant(:small) %>
                                <% if logo_variant %>
                                    <div class="w-full sm:w-auto sm:flex-shrink-0">
                                        <%= image_tag logo_variant, alt: "#{production.name} logo", class: "w-full sm:w-[100px] object-contain rounded" %>
                                    </div>
                                <% end %>
                                <div class="w-full sm:w-auto text-left">
                                    <div class="font-bold text-lg sm:text-xl"><%= production.name %></div>

                                    <% cycle = audition_request.audition_cycle %>

                                    <% if cycle.editable_by_talent? %>

                                        <% if cycle.closes_at.present? && cycle.closes_at > 1.day.from_now %>
                                            <div class="text-xs text-gray-500 mt-1">

                                                <% if cycle.video_only? %>
                                                    Video auditions
                                                <% else %>
                                                    Sign-ups
                                                <% end %>
                                                close on <%= cycle.closes_at.strftime('%b %d, %Y') %> at <%= cycle.closes_at.strftime('%l:%M %p') %>
                                            </div>
                                        <% elsif cycle.closes_at.present? %>
                                            <div class="text-xs <%= cycle.closes_at < 4.hours.from_now ? 'text-red-500' : 'text-gray-500' %> mt-1" data-controller="countdown" data-countdown-until-value="<%= cycle.closes_at.utc.iso8601 %>">
                                                <% if cycle.video_only? %>
                                                    Video auditions
                                                <% else %>
                                                    Sign-ups
                                                <% end %>
                                                close in <span data-countdown-target="clock" class="text-pink-500"></span>
                                            </div>
                                        <% else %>
                                            <div class="text-xs text-gray-500 mt-1">(open-ended)</div>
                                        <% end %>

                                        <%
                                          # Build URL with entity params if user has groups
                                          edit_url = if @groups.any?
                                            my_submit_audition_request_form_path(
                                              cycle.token,
                                              requestable_type: audition_request.requestable_type,
                                              requestable_id: audition_request.requestable_id
                                            )
                                          else
                                            my_submit_audition_request_form_path(cycle.token)
                                          end
                                        %>
                                        <%= link_to "Edit my Sign-up", edit_url, class: "text-xs text-pink-500 underline", target: "_blank" %>

                                    <% elsif cycle.timeline_status == :closed || !cycle.active %>
                                        <div class="text-xs text-gray-500 mt-1">Sign-up window closed<% if cycle.closes_at.present? %> on <%= cycle.closes_at.strftime('%b %d, %Y') %><% end %></div>
                                    <% elsif cycle.timeline_status == :upcoming %>
                                        <div class="text-xs text-gray-500 mt-1">Sign-ups open on <%= cycle.opens_at.strftime('%b %d, %Y') %></div>
                                    <% end %>
                                </div>
                            </div>
                        </div>

                        <div class="col-span-1 sm:col-span-2 mt-2 sm:mt-0 flex flex-col justify-center items-start">
                            <% if cycle.editable_by_talent? %>
                              <%# Window is still open - show appropriate status %>
                              <div class="text-lg">
                                <% if cycle.video_only? %>
                                  <div class="bg-green-500 text-white px-2 py-1 text-sm rounded-lg">Video Submitted</div>
                                <% else %>
                                  <div class="bg-green-500 text-white px-2 py-1 text-sm rounded-lg">Signed Up</div>
                                <% end %>
                              </div>
                              <div class="text-sm text-gray-500 mt-1">
                                <% if cycle.video_only? %>
                                  Your video audition has been submitted. You can still edit it until the window closes.
                                <% else %>
                                  Your sign-up has been submitted. You can still edit it until the window closes.
                                <% end %>
                              </div>
                            <% else %>
                              <%# Window is closed - show actual status %>
                              <div class="text-lg">
                                  <% if audition_request.audition_cycle.video_only? %>
                                      <%= video_audition_status_name(audition_request) %>
                                  <% else %>
                                      <%= in_person_signup_status_name(audition_request) %>
                                  <% end %>
                              </div>
                              <div class="text-sm text-gray-500 mt-1">
                                  <% if audition_request.audition_cycle.video_only? %>
                                      <%= video_audition_status_text(audition_request) %>
                                  <% else %>
                                      <%= in_person_signup_status_text(audition_request) %>
                                  <% end %>
                              </div>
                            <% end %>
                        </div>
                    </div>

                    <% if @groups.any? && @audition_request_entities[audition_request.id].present? %>
                      <div class="flex flex-col gap-2 ml-2">
                        <% @audition_request_entities[audition_request.id].each do |entity_info| %>
                          <% headshot = entity_info[:entity].safe_headshot_variant(:thumb) %>
                          <% if headshot %>
                            <%= image_tag headshot, class: "w-10 h-10 rounded-lg object-cover", alt: entity_info[:entity].try(:preferred_name) || entity_info[:entity].name %>
                          <% end %>
                        <% end %>
                      </div>
                    <% end %>
                </div>
            <% end %>
        </div>
    <% else %>
         <p class="text-gray-500 text-sm pt-2">
            <% if @requests_filter == "all" %>
                You haven't signed up for any auditions.
            <% elsif @requests_filter == "open" %>
                None of the shows you've applied for are currently auditioning.
            <% end %>
        </p>
    <% end %>

</div>