<% content_for :title, "Request Availability for #{@production.name}" %>

<div class="w-full">
  <%= render partial: "shared/notice", locals: { notice: notice } %>

  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [
      ["Availability", manage_production_availability_index_path(@production)]
    ],
    text: "Request Availability",
    links: []
  } %>

  <div class="mb-5 text-gray-500 text-sm">
    Send an email to cast members requesting they submit their availability for upcoming shows and events.
  </div>

  <%= form_with url: handle_request_availability_manage_production_availability_index_path(@production), method: :post, local: true, class: "contents", data: { controller: "availability-request" } do |form| %>

    <div class="mb-5">
      <label class="block font-semibold mb-2 text-sm">
        Request availability for:
      </label>
      <div class="space-y-2">
        <div>
          <label class="flex items-center cursor-pointer">
            <input type="radio" name="show_selection_type" value="all" checked class="mr-2 accent-pink-500 cursor-pointer" data-action="change->availability-request#toggleShowSelection">
            <span class="text-sm">All shows & events (<%= @shows.count %>)</span>
          </label>
        </div>

        <div>
          <label class="flex items-center cursor-pointer">
            <input type="radio" name="show_selection_type" value="specific" class="mr-2 accent-pink-500 cursor-pointer" data-action="change->availability-request#toggleShowSelection">
            <span class="text-sm">Specific shows & events</span>
          </label>
        </div>
      </div>

      <div class="hidden ml-6 mt-3" data-availability-request-target="showsSection">
        <label class="block font-semibold mb-2 text-sm">
          Select Shows & Events
        </label>
        <div class="space-y-1 max-h-64 overflow-y-auto border border-gray-300 rounded-lg p-3 bg-gray-50">
          <% @shows.each do |show| %>
            <label class="flex items-center cursor-pointer py-1">
              <%= check_box_tag "show_ids[]", show.id, false, class: "mr-2 accent-pink-500 cursor-pointer", data: { action: "change->availability-request#updateMessage" } %>
              <% event_type_badge_classes = case show.event_type
                when "rehearsal" then "bg-blue-50 text-blue-700 ring-blue-600/10"
                when "meeting" then "bg-green-50 text-green-700 ring-green-600/10"
                else "bg-pink-50 text-pink-700 ring-pink-600/10"
              end %>
              <span class="inline-flex items-center rounded-md px-1.5 py-0.5 text-xs font-medium ring-1 ring-inset <%= event_type_badge_classes %> mr-2">
                <%= show.event_type.titleize %>
              </span>
              <span class="text-sm">
                <%= show.date_and_time.strftime("%a, %b %-d, %Y at %-l:%M %p") %>
                <% if show.secondary_name.present? %>
                  <span class="text-gray-500">- <%= show.secondary_name %></span>
                <% end %>
              </span>
            </label>
          <% end %>
        </div>
      </div>
    </div>

    <div class="mb-5">
      <label class="block font-semibold mb-2 text-sm">
        Send to:
      </label>
      <div class="space-y-2">
        <div>
          <label class="flex items-center cursor-pointer">
            <%= radio_button_tag :recipient_type, "all", true, class: "mr-2 accent-pink-500 cursor-pointer" %>
            <span class="text-sm">All cast members needing updates (<%= @cast_members_needing_update.count %>)</span>
            <button type="button" onclick="document.getElementById('cast-member-status').classList.toggle('hidden')" class="ml-2 text-xs text-pink-500 hover:text-pink-600 underline cursor-pointer" data-availability-request-target="viewDetailsButton">
              Show People
            </button>
          </label>
        </div>

        <div id="cast-member-status" class="hidden ml-6 p-3 bg-gray-50 border border-gray-200 rounded-lg text-xs">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <div class="font-semibold text-gray-700 uppercase mb-2">Needs Updates (<%= @cast_members_needing_update.count %>)</div>
              <div class="space-y-1">
                <% if @cast_members_needing_update.any? %>
                  <% @cast_members_needing_update.each do |person| %>
                    <div class="text-gray-600"><%= person.name %></div>
                  <% end %>
                <% else %>
                  <div class="text-gray-400 italic">None</div>
                <% end %>
              </div>
            </div>
            <div>
              <div class="font-semibold text-gray-700 uppercase mb-2">Up to Date (<%= @cast_members_up_to_date.count %>)</div>
              <div class="space-y-1">
                <% if @cast_members_up_to_date.any? %>
                  <% @cast_members_up_to_date.each do |person| %>
                    <div class="text-green-600 flex items-center">
                      <span class="mr-1">✓</span> <%= person.name %>
                    </div>
                  <% end %>
                <% else %>
                  <div class="text-gray-400 italic">None</div>
                <% end %>
              </div>
            </div>
          </div>
        </div>

        <% if @production.casts.count > 1 %>
          <label class="flex items-center cursor-pointer">
            <%= radio_button_tag :recipient_type, "cast", false, class: "mr-2 accent-pink-500 cursor-pointer", data: { action: "change->availability-request#toggleCastDropdown" } %>
            <span class="text-sm mr-3">Specific cast</span>
            <span class="hidden" data-availability-request-target="castDropdown">
              <% cast_options = @production.casts.map do |cast|
                needing_update = cast.people.select { |p| @cast_members_needing_update.include?(p) }.count
                ["#{cast.name} (#{needing_update} needing updates)", cast.id]
              end %>
              <%= select_tag :cast_id, options_for_select(cast_options, @production.casts.first&.id), class: "shadow-sm rounded-lg border border-gray-400 px-3 py-1.5 text-sm focus:border-pink-500 focus:ring-pink-500" %>
            </span>
          </label>
        <% end %>

        <label class="flex items-center cursor-pointer">
          <%= radio_button_tag :recipient_type, "specific", false, class: "mr-2 accent-pink-500 cursor-pointer", data: { action: "change->availability-request#toggleSpecific" } %>
          <span class="text-sm">Specific people</span>
        </label>
      </div>

      <div class="hidden ml-6 mt-3" data-availability-request-target="specificSection">
        <label class="block font-semibold mb-2 text-sm">
          Select Recipients
        </label>
        <div class="space-y-2 max-h-64 overflow-y-auto border border-gray-300 rounded-lg p-3 bg-gray-50">
          <% if @cast_members_needing_update.any? %>
            <div class="text-xs font-semibold text-gray-700 uppercase mb-2">Needs Update</div>
            <% @cast_members_needing_update.each do |person| %>
              <% person_casts = @production.casts.select { |c| c.people.include?(person) } %>
              <label class="flex items-center cursor-pointer">
                <%= check_box_tag "person_ids[]", person.id, false, class: "mr-2 accent-pink-500 cursor-pointer" %>
                <span class="text-sm"><%= person.name %> <span class="text-gray-500">- <%= person_casts.map(&:name).join(", ") %></span></span>
              </label>
            <% end %>
          <% end %>

          <% if @cast_members_up_to_date.any? %>
            <div class="text-xs font-semibold text-gray-700 uppercase mb-2 <%= 'mt-4' if @cast_members_needing_update.any? %>">Up to Date</div>
            <% @cast_members_up_to_date.each do |person| %>
              <% person_casts = @production.casts.select { |c| c.people.include?(person) } %>
              <div class="flex items-center opacity-50">
                <%= check_box_tag "person_ids[]", person.id, false, disabled: true, class: "mr-2 cursor-not-allowed" %>
                <span class="text-sm"><%= person.name %> <span class="text-gray-500">- <%= person_casts.map(&:name).join(", ") %></span></span>
                <span class="ml-2 text-xs text-green-600">✓</span>
              </div>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>

    <div class="mb-5">
      <%= label_tag :message, "Message Preview:", class: "block font-semibold mb-2 text-sm" %>
      <%= text_area_tag :message, @default_message, rows: 12, class: "block shadow-sm rounded-lg border border-gray-400 px-3 py-2 w-full focus:border-pink-500 focus:ring-pink-500" %>
      <p class="mt-2 text-sm text-gray-500">
        This is a preview of the email message. Each person will receive a personalized version listing only the shows they haven't submitted availability for yet.
      </p>
    </div>

    <div class="w-full border-t border-gray-200 pt-5 my-5">
      <%= form.submit "Send Availability Request", class: "sm:w-auto rounded-lg px-3.5 py-2.5 text-white bg-pink-500 hover:bg-pink-600  inline-block font-medium cursor-pointer" %>
      <%= link_to "Back", manage_production_availability_index_path(@production), class: "sm:w-auto rounded-lg px-3.5 py-2.5 text-pink-500 bg-gray-200 hover:bg-pink-600 hover:text-white inline-block font-medium cursor-pointer" %>
    </div>

  <% end %>
</div>
