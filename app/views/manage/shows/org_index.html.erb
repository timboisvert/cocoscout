<% content_for :title, "Shows & Events" %>

<%
  shows_actions = [
    { icon: "calendar", text: "Calendar", description: "View all events on a calendar", path: manage_shows_calendar_path },
    { icon: "clipboard-list", text: "Schedule Event", description: "Create a new show or event", path: manage_shows_new_wizard_path }
  ]

  shows_description = <<~HTML
    <p>
      Manage all your shows and events across all productions. View upcoming performances, track
      past events, and see cast assignments at a glance.
    </p>
  HTML
%>

<div class="w-full" data-turbo-cache="false">
  <%= render partial: "shared/notice", locals: { notice: notice } %>

  <%= render "shared/module_header",
    title: "Shows & Events",
    description: shows_description,
    actions: shows_actions
  %>

  <div class="border-t border-gray-200 pt-4 mt-2">
    <%= render "shared/filters/filter_bar", wrapper_data_controller: "filter-select", filter_groups: [
    {
      label: "View",
      filters: [
        { text: "Upcoming", path: manage_shows_path(filter: "upcoming", event_type: @event_type_filter.join(","), production: @production_filter), active: @filter == "upcoming" },
        { text: "Past", path: manage_shows_path(filter: "past", event_type: @event_type_filter.join(","), production: @production_filter), active: @filter == "past" }
      ]
    },
    { separator: true },
    {
      partial: "shared/filters/dropdown_filter",
      locals: {
        label: "Production",
        name: "production",
        options: [{ value: "", text: "All Productions" }] + @productions.map { |p| { value: p.id.to_s, text: p.name } },
        selected: @production_filter.to_s,
        data_attributes: {
          action: "change->filter-select#update",
          filter_select_param_value: "production",
          filter_select_event_type_value: @event_type_filter.join(","),
          filter_select_filter_value: @filter
        }
      }
    },
    { separator: true },
    {
      partial: "shared/filters/event_type_multiselect_filter",
      locals: {
        path_helper: ->(event_type:, entity:, filter: nil) { manage_shows_path(event_type: event_type, filter: filter || @filter, production: @production_filter) },
        event_type_filter: @event_type_filter,
        entity_filter: [],
        filter: @filter
      }
    }
  ] %>

  <% if @shows.any? %>
    <div class="space-y-1" data-controller="linked-highlight">
      <% @shows.each do |show| %>
        <%
          is_third_party = show.production.type_third_party?

          if is_third_party
            # For third-party: show rental and services
            services = show.production.contract&.draft_services || []
            cast_summary = nil
          elsif show.casting_enabled?
            # For in-house with casting enabled: show cast summary with roles and sign-ups
            assignments = @assignments_by_show[show.id] || []
            roles = @roles_by_show[show.id] || []
            cant_make_it = @cant_make_it_by_show[show.id] || {}
            sign_up_regs = @sign_up_registrations_by_show[show.id] || []
            assignments_by_role = assignments.group_by(&:role_id)
            cast_summary = {
              roles: roles,
              assignments_by_role: assignments_by_role,
              cant_make_it_by_assignment: cant_make_it,
              sign_up_registrations: sign_up_regs
            }
            services = nil
          else
            # Casting disabled: still show sign-ups but no roles
            sign_up_regs = @sign_up_registrations_by_show[show.id] || []
            if sign_up_regs.any?
              cast_summary = {
                roles: [],
                assignments_by_role: {},
                cant_make_it_by_assignment: {},
                sign_up_registrations: sign_up_regs
              }
            else
              cast_summary = nil
            end
            services = nil
          end

          # Determine right panel type
          right_panel_type = if is_third_party
            :rental_services
          elsif show.casting_enabled? || cast_summary.present?
            :cast_summary
          else
            nil
          end
        %>
        <%= render partial: "shared/show_row", locals: {
          show: show,
          link_path: manage_show_path(show.production, show),
          show_canceled: true,
          show_recurring: true,
          show_linked: true,
          show_location: true,
          show_production: true,
          right_panel: right_panel_type,
          cast_summary: cast_summary,
          services: services
        } %>
      <% end %>
    </div>
  <% else %>
    <div class="text-sm text-gray-500">
      <% if @filter == "upcoming" %>
        No upcoming shows or events scheduled.
      <% else %>
        No past shows or events found.
      <% end %>
    </div>
  <% end %>
  </div>
</div>

<%# Turbo frame for recurring series modal %>
<%= turbo_frame_tag "recurring_series_modal" %>