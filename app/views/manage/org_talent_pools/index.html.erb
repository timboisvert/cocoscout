<% content_for :title, "Talent Pools" %>

<div class="w-full mb-10">
  <%= render partial: "shared/notice", locals: { notice: notice } %>

  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [
      ["Casting", manage_casting_path]
    ],
    text: "Talent Pools",
    links: []
  } %>

  <%# Mode Toggle Section %>
  <div class="mt-4 mb-6 bg-white border border-gray-200 rounded-lg p-4">
    <div class="flex items-center justify-between">
      <div>
        <h3 class="text-sm font-semibold text-gray-900">Talent Pool Organization</h3>
        <p class="text-sm text-gray-500 mt-0.5">
          <% if @is_single_mode %>
            Using a single talent pool shared across all productions.
          <% else %>
            Each production has its own talent pool.
          <% end %>
        </p>
      </div>
      <div class="flex items-center gap-2">
        <% if @is_single_mode %>
          <%= link_to manage_casting_talent_pools_switch_to_per_production_confirm_path,
                      data: { turbo_frame: "talent_pool_mode_modal" } do %>
            <%= render "shared/button", text: "Switch to Per-Production", variant: "secondary", size: "small", tag: :span %>
          <% end %>
        <% else %>
          <%= link_to manage_casting_talent_pools_switch_to_single_confirm_path,
                      data: { turbo_frame: "talent_pool_mode_modal" } do %>
            <%= render "shared/button", text: "Switch to Single Pool", variant: "secondary", size: "small", tag: :span %>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>

  <div class="pt-2">
    <% if @is_single_mode %>
      <%# Single Mode: Show the one org-level talent pool %>
      <% if @org_talent_pool %>
        <% first_production = @productions.first %>
        <% if first_production %>
          <%= link_to manage_casting_talent_pool_path(first_production), class: "flex items-stretch px-4 py-4 border rounded-lg hover:border-gray-400 transition-all group bg-white border-gray-200" do %>
            <div class="w-1/3 flex flex-col justify-center pr-4">
              <div class="font-semibold text-gray-900"><%= @organization.name %> Talent Pool</div>
              <div class="text-sm text-gray-500 mt-1">
                Shared across <%= pluralize(@productions.count, 'production') %>
              </div>
            </div>
            <div class="w-2/3 border-l border-gray-200 pl-4 flex items-center">
              <% if @memberships.any? %>
                <div class="flex items-center gap-1 flex-wrap">
                  <% @memberships.each do |membership| %>
                    <% member = membership.member %>
                    <% next unless member %>
                    <% headshot = member.safe_headshot_variant(:thumb) if member.respond_to?(:safe_headshot_variant) %>
                    <% if headshot %>
                      <%= image_tag headshot,
                          alt: member.name,
                          class: "w-8 h-8 rounded-lg object-cover",
                          data: { controller: "tooltip", tooltip_text: member.name } %>
                    <% else %>
                      <div class="w-8 h-8 rounded-lg bg-gray-200 flex items-center justify-center"
                           data-controller="tooltip"
                           data-tooltip-text="<%= member.name %>">
                        <span class="text-xs font-medium text-gray-500"><%= member.respond_to?(:initials) ? member.initials[0] : member.name[0] %></span>
                      </div>
                    <% end %>
                  <% end %>
                </div>
              <% else %>
                <div class="text-sm text-gray-400">No members yet</div>
              <% end %>
            </div>
          <% end %>
        <% end %>
      <% else %>
        <div class="bg-gray-50 rounded-lg border border-dashed border-gray-300 p-8 text-center">
          <p class="text-gray-600">No talent pool configured. Switch to per-production mode or create productions first.</p>
        </div>
      <% end %>
    <% else %>
      <%# Per-Production Mode: Show grouped talent pools %>
      <% if @talent_pool_groups.any? %>
        <div class="space-y-1">
          <% @talent_pool_groups.each do |group| %>
            <% pool = group[:pool] %>
            <% productions = group[:productions] %>
            <% memberships = group[:memberships] %>
            <% first_production = productions.first %>

            <%= link_to manage_casting_talent_pool_path(first_production), class: "flex items-stretch px-3 py-2 border rounded-lg hover:border-gray-400 transition-all group bg-white border-gray-200" do %>
              <%# Left Section: Productions that use this pool %>
              <div class="w-1/2 flex flex-col justify-center gap-2 pr-4">
                <% productions.each do |production| %>
                  <div class="flex items-center gap-4">
                    <% logo_variant = production.safe_logo_variant(:small) %>
                    <% if logo_variant %>
                      <div class="flex-shrink-0 w-14 h-8 rounded flex items-center justify-center overflow-hidden">
                        <%= image_tag logo_variant, alt: production.name, class: "w-full h-full object-cover rounded" %>
                      </div>
                    <% else %>
                      <div class="flex-shrink-0 w-14 h-8 rounded-lg bg-pink-100 flex items-center justify-center">
                        <span class="text-sm font-bold text-pink-600"><%= production.initials %></span>
                      </div>
                    <% end %>
                    <span class="font-medium text-gray-900"><%= production.name %></span>
                  </div>
                <% end %>
              </div>

              <%# Right Section: Talent pool members with headshots %>
              <div class="w-1/2 border-l border-gray-200 pl-4 flex items-center">
                <% if memberships.any? %>
                  <div class="flex items-center gap-1 flex-wrap">
                    <% memberships.each do |membership| %>
                      <% member = membership.member %>
                      <% next unless member %>
                      <% headshot = member.safe_headshot_variant(:thumb) if member.respond_to?(:safe_headshot_variant) %>
                      <% if headshot %>
                        <%= image_tag headshot,
                            alt: member.name,
                            class: "w-8 h-8 rounded-lg object-cover",
                            data: { controller: "tooltip", tooltip_text: member.name } %>
                      <% else %>
                        <div class="w-8 h-8 rounded-lg bg-gray-200 flex items-center justify-center"
                             data-controller="tooltip"
                             data-tooltip-text="<%= member.name %>">
                          <span class="text-xs font-medium text-gray-500"><%= member.respond_to?(:initials) ? member.initials[0] : member.name[0] %></span>
                        </div>
                      <% end %>
                    <% end %>
                  </div>
                <% else %>
                  <div class="text-sm text-gray-400">No members yet</div>
                <% end %>
              </div>
            <% end %>
          <% end %>
        </div>
      <% else %>
        <div class="bg-gray-50 rounded-lg border border-dashed border-gray-300 p-8 text-center">
          <p class="text-gray-600">No productions found. Create a production first to set up talent pools.</p>
        </div>
      <% end %>
    <% end %>
  </div>
</div>

<%# Turbo frame for mode switch modals %>
<%= turbo_frame_tag "talent_pool_mode_modal" %>
