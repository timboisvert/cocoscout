<%
  # Parameters:
  # - show: the Show object
  # - compact: optional boolean to make the poster smaller (default: false)
  compact = local_assigns.fetch(:compact, false)
%>

<% cache ["show_info_card_v2", show.id, show.updated_at.to_i, compact] do %>
<div class="border border-gray-200 rounded-lg overflow-hidden bg-white mb-6">
  <div class="flex flex-col sm:flex-row">
    <!-- Poster Section -->
    <div class="flex-shrink-0 bg-gray-50 flex items-center justify-center p-4">
      <% poster_url = safe_poster_url(show) %>
      <% if poster_url && !show.canceled %>
        <%= image_tag poster_url, alt: "Show Poster", class: "rounded shadow-sm object-contain #{compact ? 'max-h-[120px]' : 'max-h-[180px]'} max-w-[200px] border border-gray-200" %>
      <% else %>
        <div class="<%= compact ? 'w-[90px] h-[120px]' : 'w-[90px] h-[120px]' %> rounded bg-gray-200 flex items-center justify-center border border-gray-300">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="<%= compact ? 'w-8 h-8' : 'w-8 h-8' %> text-gray-400">
            <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm10.5-11.25h.008v.008h-.008V8.25Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
          </svg>
        </div>
      <% end %>
    </div>

    <!-- Details Section -->
    <div class="flex-1 p-6">
      <div class="space-y-4">
        <!-- Title and Badges -->
        <div>
          <h2 class="text-2xl font-bold text-gray-900 mb-2">
            <%= show.date_and_time.strftime("%A, %B %-d, %Y") %>
          </h2>
          <div class="flex items-center gap-2 flex-wrap">
            <% if show.canceled %>
              <span class="inline-flex items-center rounded-md bg-red-50 px-2 py-1 text-xs font-medium text-red-700 ring-1 ring-inset ring-red-600/10">Canceled</span>
            <% end %>
            <% unless compact %>
              <% if show.recurring? %>
                <span data-controller="tooltip" data-tooltip-text="This is a recurring event" class="inline-flex items-center rounded-md bg-purple-50 px-2 py-1 text-xs font-medium text-purple-700 ring-1 ring-inset ring-purple-600/10">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3 mr-1">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
                  </svg>
                  Recurring
                </span>
              <% end %>
            <% end %>
            <span class="inline-flex items-center rounded-md px-2 py-1 text-xs font-medium ring-1 ring-inset <%= event_type_badge_classes(show.event_type) %>">
              <%= show.event_type.titleize %>
            </span>
          </div>
        </div>

        <!-- Show Details -->
        <div class="space-y-2 text-sm">
          <div class="flex items-start gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-gray-400 flex-shrink-0 mt-0.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
            </svg>
            <span class="text-gray-900 font-medium"><%= show.date_and_time.strftime("%l:%M %p") %></span>
          </div>

          <% if show.is_online %>
            <div class="flex items-start gap-2">
              <!-- Globe icon for online -->
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-gray-400 flex-shrink-0 mt-0.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 0 0 8.716-6.747M12 21a9.004 9.004 0 0 1-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 0 1 7.843 4.582M12 3a8.997 8.997 0 0 0-7.843 4.582m15.686 0A11.953 11.953 0 0 1 12 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0 1 21 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0 1 12 16.5c-3.162 0-6.133-.815-8.716-2.247m0 0A9.015 9.015 0 0 1 3 12c0-1.605.42-3.113 1.157-4.418" />
              </svg>
              <span class="text-gray-900 font-medium">Online Event</span>
            </div>
          <% elsif show.location.present? %>
            <div class="flex items-start gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-gray-400 flex-shrink-0 mt-0.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" />
              </svg>
              <span class="text-gray-900 font-medium"><%= show.location.name %></span>
            </div>
          <% end %>

          <% if show.secondary_name.present? %>
            <div class="flex items-start gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-gray-400 flex-shrink-0 mt-0.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 3.75V16.5L12 14.25 7.5 16.5V3.75m9 0H18A2.25 2.25 0 0 1 20.25 6v12A2.25 2.25 0 0 1 18 20.25H6A2.25 2.25 0 0 1 3.75 18V6A2.25 2.25 0 0 1 6 3.75h1.5m9 0h-9" />
              </svg>
              <span class="text-gray-900 font-medium"><%= show.secondary_name %></span>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <%# Linked Events Indicator (compact disclosure at bottom of hero) %>
  <% if show.linked? %>
    <% other_linked_shows = show.event_linkage.shows.where.not(id: show.id).order(:date_and_time) %>
    <% if other_linked_shows.any? %>
      <div class="border-t border-gray-200 bg-gray-50" data-controller="disclosure">
        <button type="button" 
                data-action="click->disclosure#toggle" 
                class="w-full px-4 py-2 flex items-center justify-between text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-100 transition-colors cursor-pointer">
          <span class="flex items-center gap-2">
            <svg class="w-4 h-4 text-pink-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
            </svg>
            <span>Linked with <%= other_linked_shows.count %> other <%= "event".pluralize(other_linked_shows.count) %></span>
          </span>
          <svg data-disclosure-target="icon" class="w-4 h-4 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </button>
        <div data-disclosure-target="content" class="hidden border-t border-gray-200 divide-y divide-gray-100 bg-white">
          <% other_linked_shows.each do |linked_show| %>
            <% event_name = linked_show.secondary_name.presence || linked_show.event_type.titleize %>
            <%= link_to manage_production_show_path(show.production, linked_show), class: "flex items-center gap-3 px-4 py-2.5 hover:bg-gray-50 transition-colors" do %>
              <div class="flex-shrink-0 w-10 text-center">
                <div class="text-[10px] font-semibold text-pink-600 uppercase leading-tight"><%= linked_show.date_and_time.strftime("%b") %></div>
                <div class="text-lg font-bold text-gray-900 leading-tight"><%= linked_show.date_and_time.strftime("%-d") %></div>
              </div>
              <div class="flex-1 min-w-0">
                <div class="text-sm font-medium text-gray-900 truncate"><%= event_name %></div>
                <div class="text-xs text-gray-500"><%= linked_show.date_and_time.strftime("%-I:%M %p") %></div>
              </div>
              <svg class="w-4 h-4 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            <% end %>
          <% end %>
        </div>
      </div>
    <% end %>
  <% end %>
</div>
<% end %>
