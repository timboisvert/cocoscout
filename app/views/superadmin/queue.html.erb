<% content_for :title, "Queue Monitor - Superadmin" %>

<div class="w-full px-5 pt-5">
  <%= render partial: "shared/notice", locals: { notice: notice } %>

  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [
        ["Superadmin", superadmin_path]
    ],
    text: "Queue Monitor",
    links: []
  } %>

  <!-- Bulk Actions -->
  <div class="mt-4 flex gap-3">
    <% if @failed_jobs > 0 %>
      <%= button_to "Retry All Failed Jobs (#{@failed_jobs})", queue_retry_all_failed_path,
          method: :post,
          class: "px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium text-sm",
          data: { confirm: "Are you sure you want to retry all #{@failed_jobs} failed jobs?" } %>
      <%= button_to "Clear All Failed Jobs (#{@failed_jobs})", queue_clear_failed_path,
          method: :delete,
          class: "px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-medium text-sm",
          data: { confirm: "Are you sure you want to delete all #{@failed_jobs} failed jobs? This cannot be undone." } %>
    <% end %>

    <% if @pending_jobs > 0 %>
      <%= button_to "Clear All Pending Jobs (#{@pending_jobs})", queue_clear_pending_path,
          method: :delete,
          class: "px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg font-medium text-sm",
          data: { confirm: "Are you sure you want to delete all #{@pending_jobs} pending jobs? This cannot be undone." } %>
    <% end %>
  </div>

  <div class="mt-4 space-y-4">

    <!-- Stats Overview -->
    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
      <!-- Total Jobs -->
      <div class="bg-white border border-gray-200 rounded-lg p-4">
        <div class="text-sm text-gray-600 font-medium">Total Jobs</div>
        <div class="text-3xl font-bold text-gray-900 mt-1"><%= number_with_delimiter(@total_jobs) %></div>
      </div>

      <!-- Pending Jobs -->
      <div class="bg-white border <%= @pending_jobs > 100 ? 'border-yellow-400' : 'border-gray-200' %> rounded-lg p-4">
        <div class="text-sm text-gray-600 font-medium">Pending</div>
        <div class="text-3xl font-bold <%= @pending_jobs > 100 ? 'text-yellow-600' : 'text-blue-600' %> mt-1">
          <%= number_with_delimiter(@pending_jobs) %>
        </div>
      </div>

      <!-- Finished Today -->
      <div class="bg-white border border-gray-200 rounded-lg p-4">
        <div class="text-sm text-gray-600 font-medium">Finished Today</div>
        <div class="text-3xl font-bold text-green-600 mt-1"><%= number_with_delimiter(@finished_today) %></div>
      </div>

      <!-- Failed Jobs -->
      <div class="bg-white border <%= @failed_jobs > 0 ? 'border-red-400' : 'border-gray-200' %> rounded-lg p-4">
        <div class="text-sm text-gray-600 font-medium">
          <%= link_to "Failed", queue_failed_path, class: "hover:underline" %>
        </div>
        <div class="text-3xl font-bold <%= @failed_jobs > 0 ? 'text-red-600' : 'text-gray-900' %> mt-1">
          <%= number_with_delimiter(@failed_jobs) %>
        </div>
      </div>

      <!-- Active Workers -->
      <div class="bg-white border <%= @active_workers == 0 ? 'border-red-400' : 'border-gray-200' %> rounded-lg p-4">
        <div class="text-sm text-gray-600 font-medium">Active Workers</div>
        <div class="text-3xl font-bold <%= @active_workers == 0 ? 'text-red-600' : 'text-green-600' %> mt-1">
          <%= @active_workers %>
        </div>
      </div>
    </div>

    <!-- Queue Breakdown -->
    <% if @queue_stats.any? %>
      <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
        <%= render "shared/card_header", title: "Pending Jobs by Queue" %>
        <div class="p-4">
          <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            <% @queue_stats.each do |queue_name, count| %>
              <div class="border border-gray-200 rounded p-3">
                <div class="text-sm text-gray-600 font-mono"><%= queue_name %></div>
                <div class="text-2xl font-bold text-gray-900 mt-1"><%= number_with_delimiter(count) %></div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>

    <!-- Recurring Jobs -->
    <% if @recurring_jobs.any? %>
      <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
        <%= render "shared/card_header", title: "Recurring Jobs" %>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Job</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Schedule</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Run</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <% @recurring_jobs.each do |job| %>
                <tr class="hover:bg-gray-50">
                  <td class="px-4 py-3 text-sm">
                    <div class="font-medium text-gray-900"><%= job[:key] %></div>
                    <div class="text-xs text-gray-500 font-mono"><%= job[:class_name] || job[:command]&.truncate(40) %></div>
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">
                    <span class="font-mono text-xs bg-gray-100 px-2 py-1 rounded"><%= job[:schedule] %></span>
                  </td>
                  <td class="px-4 py-3 text-sm text-gray-600 max-w-md">
                    <%= job[:description] %>
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">
                    <% if job[:last_run_at] %>
                      <%= time_ago_in_words(job[:last_run_at]) %> ago
                    <% else %>
                      <span class="text-gray-400">Never</span>
                    <% end %>
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm">
                    <% case job[:last_run_status] %>
                    <% when "success" %>
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        ✓ Success
                      </span>
                    <% when "running" %>
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        ⏳ Running
                      </span>
                    <% else %>
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600">
                        — Never
                      </span>
                    <% end %>
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm">
                    <% if job[:runnable] %>
                      <%= button_to "Run Now", queue_run_recurring_job_path(job_key: job[:key]),
                          method: :post,
                          class: "text-blue-600 hover:text-blue-800 font-medium",
                          data: { confirm: "Run #{job[:class_name]} now?" } %>
                    <% else %>
                      <span class="text-gray-400 text-xs">Command only</span>
                    <% end %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    <% end %>

    <!-- Recent Jobs -->
    <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
      <%= render "shared/card_header", title: "Recent Jobs (Last 50)" %>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Queue</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Job Class</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Duration</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <% @recent_jobs.each do |job| %>
              <tr class="hover:bg-gray-50">
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 font-mono"><%= job.id %></td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600 font-mono"><%= job.queue_name %></td>
                <td class="px-4 py-3 text-sm text-gray-900">
                  <div class="max-w-md truncate"><%= job.class_name %></div>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">
                  <%= time_ago_in_words(job.created_at) %> ago
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm">
                  <% if job.finished_at %>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                      ✓ Finished
                    </span>
                  <% elsif job.scheduled_at && job.scheduled_at > Time.current %>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                      ⏰ Scheduled
                    </span>
                  <% else %>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                      ⏳ Pending
                    </span>
                  <% end %>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">
                  <% if job.finished_at %>
                    <%= distance_of_time_in_words(job.created_at, job.finished_at) %>
                  <% elsif job.scheduled_at && job.scheduled_at > Time.current %>
                    in <%= distance_of_time_in_words(Time.current, job.scheduled_at) %>
                  <% else %>
                    -
                  <% end %>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm">
                  <% unless job.finished_at %>
                    <%= button_to "Delete", queue_delete_job_path(job.id),
                        method: :delete,
                        class: "text-red-600 hover:text-red-800 font-medium",
                        data: { confirm: "Delete this job?" } %>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>
