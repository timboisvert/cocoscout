<% content_for :title, "Production Team" %>

<div class="w-full" data-controller="team-modals">

  <%= render partial: "shared/notice", locals: { notice: notice } %>

  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [],
    text: "Production Team",
    links: current_user_is_global_manager? ? [
      { text: "Invite Team Member", path: "#", data_action: "click->team-modals#openInviteModal" }
    ] : []
  } %>

<%= render "shared/help_section",
  title: "About Production Team Members",
  initial_state: "open",
  storage_key: "team_help_collapsed",
  steps: [
    { text: "This page is for inviting <strong>production team members</strong> (co-producers, production assistants, etc.) who need access to manage productions in CocoScout." },
    { text: "This is <strong>not</strong> for adding talent/performers to your cast. Use the <strong>Directory</strong> for inviting performers." },
    { text: "After inviting someone, you can click <strong>Manage Permissions</strong> to control what they can view and manage." }
  ] %>

<div class="w-full">

    <% @members.each do |member| %>
        <% organization_role = member.organization_roles.find { |r| r.organization_id == Current.organization.id } %>
        <div class="p-4 bg-white border border-gray-200 rounded-lg hover:border-gray-400 transition-all flex mb-2" data-controller="team-remove" data-team-remove-target="row">

                <div class="<%= current_user_can_manage? ? 'w-2/3' : 'w-full' %>">
                    <div class="h-full flex flex-col justify-center">
                        <div class="">
                            <div class="font-bold text-md">
                                <%= member.person&.name || member.email_address %>
                                <% if member == Current.user %>
                                    <span class="ml-1 text-sm text-gray-500">(Me)</span>
                                <% end %>
                            </div>
                            <div class="text-sm text-gray-500"><%= member.email_address %></div>
                        </div>
                        <% if current_user_is_global_manager? && member != Current.user %>
                            <%= link_to "Manage Permissions", permissions_manage_team_path(member), class: "mt-1 text-xs text-pink-500 underline" %>
                        <% end %>
                    </div>
                </div>

                <% if current_user_is_global_manager? %>
                    <div class="w-1/3 flex items-center justify-end text-sm text-gray-500">
                        <% role_display = case organization_role&.company_role
                             when 'manager' then 'Manager'
                             when 'viewer' then 'Viewer'
                             when 'none' then 'Per-production access'
                             else 'Unknown'
                             end %>
                        <%= role_display %>
                    </div>
                <% end %>
            </div>
        <% end %>

    <% if current_user_is_global_manager? && @team_invitations.any? %>
        <% @team_invitations.each do |invite| %>
            <div class="p-4 border border-gray-200 rounded-lg hover:border-gray-400 transition-all flex mb-2">
                    <div class="w-2/3">
                        <div class="h-full flex flex-col justify-center">
                            <div class="flex items-center">
                                <p class=""><%= invite.email %></p>
                            </div>
                            <%= button_to "Revoke Invitation", revoke_invite_manage_team_index_path(id: invite.id), method: :delete, data: { turbo_confirm: "Are you sure?" }, class: "text-xs text-pink-500 underline mt-1 cursor-pointer w-fit" %>
                        </div>
                    </div>
                    <div class="w-1/3 flex items-center justify-end text-gray-500">
                        <span class="ml-2 text-xs text-gray-500 bg-yellow-100 px-2 py-1 rounded">Pending Invitation</span>
                    </div>
                </div>
            <% end %>
        <% end %>

</div>

<!-- Invite Team Member Modal -->
<% if current_user_is_global_manager? %>
  <div data-team-modals-target="inviteModal" data-action="click->team-modals#closeModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full" data-action="click->team-modals#stopPropagation">
      <div class="px-6 py-4 border-b border-gray-200">
        <h2 class="text-xl font-semibold text-gray-900 coustard-regular">Invite a Team Member</h2>
      </div>
      <div class="p-6">
        <% if @team_invitation_error %>
          <p class="text-sm text-pink-500 mb-4">Email address is required</p>
        <% end %>

        <%= form_with(model: @team_invitation, url: invite_manage_team_index_path, method: :post) do |f| %>
          <div class="space-y-4">
            <div>
              <%= f.label :email, "Email Address", class: "block text-sm font-medium text-gray-700 mb-2" %>
              <%= f.email_field :email, placeholder: "email@example.com", autocapitalize: "none", class: "block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-pink-500 focus:ring-pink-500" %>
            </div>

            <div>
              <%= f.label :invitation_subject, "Email Subject", class: "block text-sm font-medium text-gray-700 mb-2" %>
              <% default_subject = "You've been invited to join #{Current.organization.name}'s team on CocoScout" %>
              <%= f.text_field :invitation_subject, value: default_subject, class: "block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-pink-500 focus:ring-pink-500" %>
            </div>

            <div>
              <%= f.label :invitation_message, "Email Message", class: "block text-sm font-medium text-gray-700 mb-2" %>
              <% default_message = "Welcome to CocoScout!\n\n#{Current.organization.name} is using CocoScout to manage its productions. You've been invited to join the team.\n\nClick the link below to accept the invitation and sign in or create an account." %>
              <%= f.text_area :invitation_message, value: default_message, rows: 6, class: "block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-pink-500 focus:ring-pink-500" %>
              <p class="mt-2 text-xs text-gray-500">
                The invitation link will be automatically included in the email.
              </p>
            </div>
          </div>

          <div class="flex items-center justify-end gap-3 mt-6 pt-4 border-t border-gray-200">
            <%= render "shared/button",
                text: "Cancel",
                variant: "ghost-cancel",
                data: { action: "click->team-modals#closeInviteModal" },
                type: :button %>
            <%= render "shared/button",
                text: "Send Invite",
                variant: "primary",
                size: "medium",
                type: :submit %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
<% end %>

</div>
