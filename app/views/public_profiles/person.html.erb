<% content_for :title, @entity.name %>

<div class="w-full bg-gradient-to-b from-gray-50 to-white min-h-screen">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 sm:py-12">

    <%# Hero Section with Primary Headshot %>
    <div class="bg-white rounded-lg shadow-sm border border-gray-100 overflow-hidden mb-6">
      <div class="relative">
        <%# Background Pattern %>
        <div class="absolute inset-0 bg-gradient-to-br from-pink-50 via-white to-purple-50 opacity-50"></div>
        
        <div class="relative p-3 sm:p-4">
          <div class="flex flex-col sm:flex-row items-start gap-3">
            <%# Primary Headshot %>
            <% primary_hs = @entity.primary_headshot %>
            <div class="flex-shrink-0">
              <% if primary_hs&.image&.attached? %>
                <%= image_tag primary_hs.image.variant(resize_to_limit: [400, 600]), class: "w-24 h-36 sm:w-32 sm:h-44 rounded object-cover shadow-sm ring-1 ring-white" %>
              <% elsif @entity.headshot.attached? %>
                <%= image_tag @entity.headshot, class: "w-24 h-36 sm:w-32 sm:h-44 rounded object-cover shadow-sm ring-1 ring-white" %>
              <% else %>
                <div class="w-24 h-36 sm:w-32 sm:h-44 rounded bg-gradient-to-br from-pink-400 to-purple-500 flex items-center justify-center text-white font-bold text-2xl shadow-sm ring-1 ring-white">
                  <%= @entity.initials %>
                </div>
              <% end %>
            </div>

            <%# Name and Info %>
            <div class="flex-1 min-w-0">
              <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-2 mb-3">
                <div>
                  <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 inter-bold mb-0.5"><%= @entity.name %></h1>
                  <% if @entity.pronouns.present? %>
                    <p class="text-sm text-gray-600"><%= @entity.pronouns %></p>
                  <% end %>
                </div>
                <% if Current.user && @entity == Current.user.person %>
                  <%= link_to profile_path, class: "inline-flex items-center gap-2 px-6 py-3 text-sm font-medium text-white bg-pink-600 hover:bg-pink-700 rounded-lg shadow-sm transition-colors" do %>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" />
                    </svg>
                    Edit Profile
                  <% end %>
                <% end %>
              </div>

              <%# Contact Info %>
              <% if (@entity.email.present? && !@entity.hide_contact_info) || (@entity.social_media_visible? && @entity.socials.any?) %>
                <div class="flex flex-wrap items-center gap-1.5">
                  <% if @entity.email.present? && !@entity.hide_contact_info %>
                    <%= mail_to @entity.email, class: "inline-flex items-center gap-2 px-4 py-2 bg-white border border-gray-200 rounded-lg hover:border-pink-300 hover:bg-pink-50 transition-colors text-sm font-medium text-gray-700 hover:text-pink-700" do %>
                      <svg width="18" height="18" class="fill-current" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
                        <path d="M112 128C85.5 128 64 149.5 64 176C64 191.1 71.1 205.3 83.2 214.4L291.2 370.4C308.3 383.2 331.7 383.2 348.8 370.4L556.8 214.4C568.9 205.3 576 191.1 576 176C576 149.5 554.5 128 528 128L112 128zM64 260L64 448C64 483.3 92.7 512 128 512L512 512C547.3 512 576 483.3 576 448L576 260L377.6 408.8C343.5 434.4 296.5 434.4 262.4 408.8L64 260z"/>
                      </svg>
                      Email
                    <% end %>
                  <% end %>

                  <% if @entity.social_media_visible? %>
                    <% @entity.socials.each do |social| %>
                      <%= link_to social.url, target: "_blank", rel: "noopener", class: "inline-flex items-center gap-2 px-4 py-2 bg-white border border-gray-200 rounded-lg hover:border-pink-300 hover:bg-pink-50 transition-colors text-sm font-medium text-gray-700 hover:text-pink-700" do %>
                        <%= social.icon(18) %>
                        <%= social.handle %>
                      <% end %>
                    <% end %>
                  <% end %>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <%# Headshots Gallery %>
    <% if @entity.headshots_visible? && @entity.profile_headshots.any? %>
      <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-3 sm:p-4 mb-4">
        <h2 class="text-lg sm:text-xl font-bold text-gray-900 inter-bold mb-3">Headshots</h2>
        <div class="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-6 gap-2">
          <% @entity.profile_headshots.each do |headshot| %>
            <div class="group relative aspect-[3/4] rounded overflow-hidden border border-gray-200 hover:border-pink-300 transition-all cursor-pointer" onclick="openHeadshotModal('<%= url_for(headshot.image.variant(resize_to_limit: [1200, 1800])) %>')">
              <%= image_tag headshot.image.variant(resize_to_limit: [200, 300]), class: "w-full h-full object-cover transition-transform group-hover:scale-105" %>
            </div>
          <% end %>
        </div>
      </div>

      <%# Headshot Modal %>
      <div id="headshot-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center p-4" onclick="closeHeadshotModal()">
        <button onclick="closeHeadshotModal()" class="absolute top-4 right-4 text-white hover:text-gray-300 transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-8 h-8">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
        <img id="modal-image" src="" class="max-w-full max-h-full object-contain" onclick="event.stopPropagation()" />
      </div>

      <script>
        function openHeadshotModal(imageUrl) {
          document.getElementById('modal-image').src = imageUrl;
          document.getElementById('headshot-modal').classList.remove('hidden');
        }

        function closeHeadshotModal() {
          document.getElementById('headshot-modal').classList.add('hidden');
        }

        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape') {
            closeHeadshotModal();
          }
        });
      </script>
    <% end %>

    <%# Videos & Reels Grid %>
    <% if @entity.videos_visible? && @entity.profile_videos.any? %>
      <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-3 sm:p-4 mb-4">
        <h2 class="text-lg sm:text-xl font-bold text-gray-900 inter-bold mb-3">Videos & Reels</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
          <% @entity.profile_videos.each do |video| %>
            <div class="group relative bg-gray-50 rounded-xl overflow-hidden border border-gray-200 hover:border-pink-300 hover:shadow-md transition-all">
              <% if video.embed_html.present? %>
                <div class="aspect-video w-full">
                  <%= video.embed_html.html_safe %>
                </div>
              <% end %>
              <div class="p-4">
                <h3 class="font-semibold text-gray-900 mb-2 line-clamp-2"><%= video.title %></h3>
                <%= link_to video.url, target: "_blank", rel: "noopener", class: "inline-flex items-center gap-1 text-sm text-pink-600 hover:text-pink-700 font-medium" do %>
                  View on <%= video.platform || "Platform" %>
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" />
                  </svg>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <%# Performance History with Sections %>
    <% if @entity.performance_credits_visible? %>
      <% sections_with_credits = @entity.performance_sections.includes(:performance_credits).where.not(performance_credits: { id: nil }).order(position: :asc) %>
      <% if sections_with_credits.any? %>
        <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-3 sm:p-4 mb-4">
          <h2 class="text-lg sm:text-xl font-bold text-gray-900 inter-bold mb-3">Performance History</h2>
          
          <% sections_with_credits.each do |section| %>
            <div class="mb-4 last:mb-0">
              <h3 class="text-sm font-bold text-gray-800 mb-1.5 pb-1 border-b border-gray-200"><%= section.name %></h3>
              <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                  <tbody class="divide-y divide-gray-100">
                    <% section.performance_credits.order(year_start: :desc, created_at: :desc).each do |credit| %>
                      <tr class="hover:bg-gray-50 transition-colors">
                        <td class="py-1.5 pr-4 text-sm w-1/3 text-gray-900"><%= credit.title %></td>
                        <td class="py-1.5 px-4 text-sm w-1/3 text-gray-700"><%= credit.role %></td>
                        <td class="py-1.5 pl-4 text-sm w-1/3 text-right text-gray-600 whitespace-nowrap"><%= credit.display_year_range_with_present %></td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>
    <% end %>

    <%# Training & Education %>
    <% if @entity.training_credits_visible? && @entity.training_credits.any? %>
      <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-3 sm:p-4 mb-4">
        <h2 class="text-lg sm:text-xl font-bold text-gray-900 inter-bold mb-3">Training & Education</h2>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <tbody class="divide-y divide-gray-100">
              <% @entity.training_credits.order(year_start: :desc, created_at: :desc).each do |training| %>
                <tr class="hover:bg-gray-50 transition-colors">
                  <td class="py-1.5 pr-4 text-sm w-1/3 text-gray-900"><%= training.institution %></td>
                  <td class="py-1.5 px-4 text-sm w-1/3 text-gray-700"><%= training.program %></td>
                  <td class="py-1.5 pl-4 text-sm w-1/3 text-right text-gray-600 whitespace-nowrap"><%= training.display_year_range_with_present %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    <% end %>

    <%# Skills & Talents - Organized by Category %>
    <% if @entity.profile_skills_visible? && @entity.profile_skills.any? %>
      <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-3 sm:p-4 mb-4">
        <h2 class="text-lg sm:text-xl font-bold text-gray-900 inter-bold mb-3">Skills & Talents</h2>
        
        <% skills_by_category = @entity.profile_skills.group_by(&:category) %>
        <div class="space-y-3">
          <% skills_by_category.each do |category, skills| %>
            <div class="flex flex-col sm:flex-row gap-2 sm:gap-4 text-sm">
              <div class="font-bold text-gray-700 sm:w-40 flex-shrink-0">
                <%= ProfileSkillsService.category_display_name(category) %>:
              </div>
              <div class="text-gray-600">
                <%= skills.map(&:skill_name).join(", ") %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <%# Resumes Section - Compact %>
    <% if @entity.resumes_visible? && @entity.profile_resumes.any? %>
      <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-3 sm:p-4 mb-4">
        <h2 class="text-lg sm:text-xl font-bold text-gray-900 inter-bold mb-3">Resumes</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
          <% @entity.profile_resumes.each do |resume| %>
            <% if resume.file.attached? %>
              <div class="group relative bg-gradient-to-br from-gray-50 to-white rounded-lg p-5 border border-gray-200 hover:border-pink-300 hover:shadow-md transition-all">
                <div class="flex items-start gap-4">
                  <div class="flex-shrink-0 w-12 h-12 bg-pink-100 rounded-lg flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-pink-600">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                    </svg>
                  </div>
                  <div class="flex-1 min-w-0">
                    <h3 class="font-semibold text-gray-900 text-sm mb-1 truncate"><%= resume.name.presence || "Resume" %></h3>
                    <%= link_to rails_blob_path(resume.file, disposition: "attachment"), class: "inline-flex items-center gap-1 text-sm text-pink-600 hover:text-pink-700 font-medium" do %>
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                      </svg>
                      Download
                    <% end %>
                  </div>
                </div>
              </div>
            <% end %>
          <% end %>
        </div>
      </div>
    <% end %>

    <%# Legacy Resume (if present and no new resumes) %>
    <% if @entity.resumes_visible? && @entity.resume.attached? && @entity.profile_resumes.empty? %>
      <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-3 sm:p-4 mb-4">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg sm:text-xl font-bold text-gray-900 inter-bold">Resume</h2>
          <%= link_to rails_blob_path(@entity.resume, disposition: "attachment"), class: "inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-pink-600 hover:bg-pink-700 rounded-lg shadow-sm transition-colors" do %>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
            </svg>
            Download
          <% end %>
        </div>
      </div>
    <% end %>

    <%# Groups & Ensembles %>
    <% groups = @entity.groups.where(archived_at: nil) %>
    <% if groups.any? %>
      <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-3 sm:p-4">
        <h2 class="text-lg sm:text-xl font-bold text-gray-900 inter-bold mb-3">
          Groups & Ensembles
          <span class="text-sm font-normal text-gray-500">(<%= groups.count %>)</span>
        </h2>

        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
          <% groups.each do |group| %>
            <%= link_to public_profile_path(group.public_key), class: "group" do %>
              <div class="flex flex-col items-center p-4 bg-gradient-to-br from-gray-50 to-white border border-gray-200 rounded-xl hover:border-pink-300 hover:shadow-lg transition-all">
                <% if group.headshot.attached? %>
                  <%= image_tag group.headshot.variant(:thumb), class: "w-20 h-20 rounded-xl object-cover mb-3 ring-2 ring-gray-100 group-hover:ring-pink-200 transition-all" %>
                <% else %>
                  <div class="w-20 h-20 rounded-xl bg-gradient-to-br from-pink-400 to-purple-500 flex items-center justify-center text-white font-bold text-xl mb-3 ring-2 ring-gray-100 group-hover:ring-pink-200 transition-all">
                    <%= group.initials %>
                  </div>
                <% end %>
                <span class="text-sm font-semibold text-gray-900 text-center group-hover:text-pink-600 transition-colors line-clamp-2">
                  <%= group.name %>
                </span>
              </div>
            <% end %>
          <% end %>
        </div>
      </div>
    <% end %>

  </div>
</div>
