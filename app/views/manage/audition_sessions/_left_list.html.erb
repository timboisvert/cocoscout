<div class="p-4 rounded-lg border border-gray-200" id="left_panel">

    <h2 class="font-semibold text-lg mb-1">Sign-ups</h2>

    <span class="text-sm text-gray-500 mb-3 block">
        Drag each person from the list on the left to an audition slot on the right to schedule them.
    </span>

    <%= render "shared/filters/filter_bar", filter_groups: [
      {
        label: "View",
        filters: [
          { text: "To Be Scheduled", path: manage_production_audition_sessions_path(production, filter: "to_be_scheduled"), active: filter.blank? || filter == "to_be_scheduled" },
          { text: "All Yes", path: manage_production_audition_sessions_path(production, filter: "accepted"), active: filter == "accepted" },
          { text: "All Sign-ups", path: manage_production_audition_sessions_path(production, filter: "all"), active: filter == "all" }
        ]
      },
      { separator: true }
    ] %>

    <%
        ar = AuditionRequest.joins(:audition_cycle).where(audition_cycles: { production_id: production.id })

        if filter == "all"
            ar = ar.where(status: [ :unreviewed, :undecided, :passed, :accepted ])
        elsif filter == "to_be_scheduled"
            audition_cycle = production.active_audition_cycle
            ar = ar.where(status: :accepted, requestable_type: 'Person').where.not(requestable_id: audition_cycle&.audition_sessions&.joins(:auditions)&.select("auditions.person_id") || [])
        elsif filter == "accepted"
            ar = ar.where(status: :accepted)
        end

        ar = ar.order(created_at: :asc)

    %>

    <% if ar.any? %>

        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
            <% ar.each do |audition_request| %>

                <% audition_cycle = production.active_audition_cycle %>
                <% scheduled = audition_request.scheduled_in_any?(audition_cycle&.audition_sessions || []) %>

                <% requestable = audition_request.requestable %>
                <div
                    class="flex flex-col items-center p-3 border border-gray-200 rounded-lg hover:border-gray-400 transition-all cursor-grab bg-[#f9f9f7]"
                    data-drag-target="item" data-id="<%= audition_request.id %>" draggable="true" data-action="dragstart->drag#dragStart"
                >
                    <% headshot_url = safe_headshot_url(requestable, variant: :thumb) %>
                    <% if headshot_url %>
                      <%= image_tag headshot_url, alt: requestable.name, class: "w-12 h-12 rounded-lg object-cover mb-1 #{'opacity-40' if scheduled}", draggable: false %>
                    <% elsif requestable.is_a?(Person) %>
                     <div class="w-12 h-12 rounded-lg bg-gray-100 flex items-center justify-center mb-1 text-black font-bold">
                        <%= requestable.initials %>
                    </div>
                    <% else %>
                     <div class="w-12 h-12 rounded-lg bg-gray-100 flex items-center justify-center mb-1 text-black font-bold">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m.94 3.198l.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0112 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 016 18.719m12 0a5.971 5.971 0 00-.941-3.197m0 0A5.995 5.995 0 0012 12.75a5.995 5.995 0 00-5.058 2.772m0 0a3 3 0 00-4.681 2.72 8.986 8.986 0 003.74.477m.94-3.197a5.971 5.971 0 00-.94 3.197M15 6.75a3 3 0 11-6 0 3 3 0 016 0zm6 3a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0zm-13.5 0a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0z" />
                        </svg>
                    </div>
                    <% end %>
                    <span class="font-medium text-xs text-center <%= 'text-gray-300' if scheduled %>"><%= requestable.name.truncate(20, omission: '...') %></span>
                </div>
            <% end %>
        </div>
    <% else %>
        <% if filter == "to_be_scheduled" %>
            <p class="text-gray-500 text-sm">All accepted sign-ups have been scheduled</p>
        <% else %>
            <p class="text-gray-500 text-sm">No sign-ups</p>
        <% end %>
    <% end %>
</div>