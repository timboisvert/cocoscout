<% content_for :title, "Message Details" %>

<div class="w-full">
  <%= render partial: "shared/notice", locals: { notice: notice } %>

  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [
      ["Directory", manage_directory_path],
      [@recipient_entity&.name || "Unknown", @back_path],
      ["Emails", "#{@back_path}?tab=3"]
    ],
    text: @email_log.subject || "(no subject)",
    links: []
  } %>

  <div class="mt-4">
    <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
      <div class="px-6 py-4 border-b border-gray-200">
        <h1 class="text-lg font-semibold text-gray-900">
          <%= @email_log.subject || "(no subject)" %>
        </h1>
        <p class="text-sm text-gray-500 mt-1">
          <%= @email_log.sent_at&.strftime("%B %-d, %Y at %-I:%M %p") %>
        </p>
      </div>

      <% if @other_recipients.any? %>
        <div class="px-6 py-3 border-b border-gray-200 bg-gray-50" data-controller="disclosure">
          <button
            type="button"
            class="flex items-center gap-2 text-sm text-gray-600 hover:text-gray-900 cursor-pointer"
            data-action="click->disclosure#toggle"
          >
            <svg data-disclosure-target="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 transition-transform">
              <path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" />
            </svg>
            Also sent to <%= pluralize(@other_recipients.count, "other person") %>
          </button>
          <div data-disclosure-target="content" class="hidden mt-3">
            <div class="flex flex-wrap gap-3">
              <% @other_recipients.each do |log| %>
                <% entity = log.recipient_entity %>
                <% if entity %>
                  <%= link_to(entity.is_a?(Person) ? manage_person_path(entity) : manage_group_path(entity), class: "flex items-center gap-2 px-3 py-1.5 bg-white border border-gray-200 rounded hover:border-pink-300 hover:bg-pink-50 transition") do %>
                    <% if entity.respond_to?(:headshot) && entity.headshot&.attached? %>
                      <% headshot_variant = entity.safe_headshot_variant(:thumb) %>
                      <% if headshot_variant %>
                        <%= image_tag headshot_variant, class: "w-6 h-6 rounded object-cover" %>
                      <% else %>
                        <div class="w-6 h-6 rounded bg-gray-200 flex items-center justify-center text-xs text-gray-500"><%= entity.name.first.upcase %></div>
                      <% end %>
                    <% else %>
                      <div class="w-6 h-6 rounded bg-gray-200 flex items-center justify-center text-xs text-gray-500"><%= entity.name.first.upcase %></div>
                    <% end %>
                    <span class="text-sm text-gray-700"><%= entity.name %></span>
                  <% end %>
                <% end %>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>

      <div class="p-0">
        <% body = @email_log.body_content %>
        <% if body.present? %>
          <iframe
            class="w-full min-h-[600px] border-0"
            sandbox="allow-same-origin"
            srcdoc="<%= ERB::Util.html_escape(body) %>"
          ></iframe>
        <% else %>
          <div class="text-center py-8 text-gray-500">
            No email body available
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>
