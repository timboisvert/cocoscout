# Name of your application. Used to uniquely configure containers.
service: cocoscout

# Name of the container image (ECR in us-east-2).
image: cocoscout

# Deploy to these servers.
servers:
  web:
    hosts:
      - ec2-18-188-157-224.us-east-2.compute.amazonaws.com # CocoScout Web 1
      - ec2-18-224-17-140.us-east-2.compute.amazonaws.com # CocoScout Web 2
    options:
      memory: 3g  # Limit to leave headroom on 4GB instance
    env:
      clear:
        WEB_CONCURRENCY: 2  # Puma workers (1 per vCPU on t4g.medium)
        RAILS_MAX_THREADS: 5
        DB_POOL: 5
  job:
    hosts:
      - ec2-3-140-1-189.us-east-2.compute.amazonaws.com # CocoScout Jobs
    cmd: bin/jobs
    proxy: false
    options:
      health-cmd: "true"
      memory: 1200m  # Limit to leave headroom on 2GB instance
    env:
      clear:
        JOB_CONCURRENCY: 2  # Solid Queue workers
        DB_POOL: 8  # Jobs need more connections

ssh:
  user: ec2-user
  keys: [ "~/.ssh/Tim.pem" ]

# Deploy to all hosts in parallel (instead of one at a time)
boot:
  limit: 100%

# Faster health checks for quicker rollouts
proxy:
  healthcheck:
    interval: 1
    timeout: 2

# Enable SSL auto certification via Let's Encrypt and allow for multiple apps on a single web server.
# Remove this section when using multiple web servers and ensure you terminate SSL at your load balancer.
#
# Note: If using Cloudflare, set encryption mode in SSL/TLS setting to "Full" to enable CF-to-app encryption.
# proxy:
#   ssl: false
#   hosts:
#     - cocoscout.com
#     - www.cocoscout.com

# ECR registry (password fetched dynamically via AWS CLI)
registry:
  server: 769979514680.dkr.ecr.us-east-2.amazonaws.com
  username: AWS
  password:
    - KAMAL_REGISTRY_PASSWORD

# Inject ENV variables into containers (secrets come from .kamal/secrets).
env:
  secret:
    - RAILS_MASTER_KEY
    - DATABASE_URL
    - AWS_ACCESS_KEY_ID
    - AWS_SECRET_ACCESS_KEY
    - MAILGUN_API_KEY
    - SENTRY_DSN
    - REDIS_URL
  clear:
    # Job processing is handled by the dedicated job server (bin/jobs)
    SOLID_QUEUE_IN_PUMA: false

    RAILS_ENV: production

# Aliases are triggered with "bin/kamal <alias>". You can overwrite arguments on invocation:
# "bin/kamal logs -r job" will tail logs from the first server in the job section.
aliases:
  console: app exec --interactive --reuse "bin/rails console"
  shell: app exec --interactive --reuse "bash"
  logs: app logs -f
  dbc: app exec --interactive --reuse "bin/rails dbconsole"
  ps: app exec "ps aux"

# Automatically clean up old images/containers after deploy
retain_containers: 2

# Bridge fingerprinted assets, like JS and CSS, between versions to avoid
# hitting 404 on in-flight requests. Combines all files from new and old
# version inside the asset_path.
asset_path: /rails/public/assets

# Configure the image builder.
builder:
  arch:
    - arm64
  cache:
    type: registry
