<% content_for :title, "Edit Questionnaire - #{@questionnaire.title}" %>

<div class="w-full" data-controller="question-modal" data-create-path="<%= manage_create_question_communications_questionnaire_path(@production, @questionnaire) %>" data-has-errors="<%= @question.errors.any? %>">
  <%= render partial: "shared/notice", locals: { notice: notice } %>
  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [
      ["Communications", manage_communications_path],
      [@production.name, manage_communications_production_path(@production)],
      ["Questionnaires", manage_communications_questionnaires_path(@production)],
      [@questionnaire.title, manage_communications_questionnaire_path(@production, @questionnaire)]
    ],
    text: "Edit Questionnaire",
    links: [
      { text: "Preview Questionnaire", path: manage_preview_communications_questionnaire_path(@production, @questionnaire), target: "_blank" }
    ]
  } %>

  <% if @questionnaire.archived_at.present? %>
    <div class="mb-4 p-4 bg-gray-100 border border-gray-300 rounded-lg">
      <div class="flex items-center gap-2">
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-200 text-gray-800">
          Archived
        </span>
        <span class="text-sm text-gray-700">This questionnaire was archived on <%= @questionnaire.archived_at.strftime("%b %d, %Y") %>. You can view the settings but cannot make changes.</span>
      </div>
    </div>
  <% end %>

  <!-- Section 1: Basic Settings -->
  <div class="mb-4 border border-gray-200 rounded-lg overflow-hidden" data-controller="show-toggle" data-show-toggle-initial-open-value="false">
    <%= render "shared/card_header", title: "Basic Settings", clickable: true do %>
      <div data-show-toggle-target="icon"></div>
    <% end %>
    <div data-show-toggle-target="content" class="hidden">
      <%= form_with model: [:manage, @production, @questionnaire], class: "contents" do |form| %>
        <div class="p-4">
          <div class="space-y-6">
            <div>
              <%= form.label :title, "Questionnaire Title", class: "block text-sm font-medium text-gray-700 mb-2" %>
              <%= form.text_field :title, class: "block w-full rounded-lg border border-gray-300 px-3 py-2", placeholder: "e.g., Actor Information Form", disabled: @questionnaire.archived_at.present? %>
              <% if @questionnaire.errors[:title].any? %>
                <p class="mt-1 text-sm text-red-600"><%= @questionnaire.errors[:title].first %></p>
              <% end %>
            </div>

            <div>
              <%= form.label :instruction_text, "Instruction Text", class: "block text-sm font-medium text-gray-700 mb-2" %>
              <p class="text-sm text-gray-500 mb-2">At the top of the questionnaire you can add text to provide instructions or context.</p>
              <%= form.rich_text_area :instruction_text, class: ["block shadow-sm rounded-lg border px-3 py-2 w-full max-h-96 overflow-auto min-w-0", {"border-gray-400": @questionnaire.errors[:instruction_text].none?, "border-pink-500": @questionnaire.errors[:instruction_text].any?}], disabled: @questionnaire.archived_at.present? %>
            </div>

            <% unless @questionnaire.archived_at.present? %>
              <div class="border-t border-gray-200 pt-4 mt-4">
                <%= render "shared/button", text: "Save Settings", variant: "primary", size: "medium", type: :submit %>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Section 2: Availability -->
  <div class="mb-4 border border-gray-200 rounded-lg overflow-hidden" data-controller="show-toggle availability-filter" data-show-toggle-initial-open-value="false">
    <%= render "shared/card_header", title: "Availability", clickable: true do %>
      <div data-show-toggle-target="icon"></div>
    <% end %>
    <div data-show-toggle-target="content" class="hidden">
      <%= form_with model: [:manage, @production, @questionnaire], class: "contents" do |form| %>
        <div class="p-4">
          <p class="text-sm text-gray-500 mb-4">Include a section on the questionnaire where respondents can indicate their availability for scheduled events.</p>

          <div class="mb-1">
            <%= form.check_box :include_availability_section, class: "rounded accent-pink-500 border-gray-300 text-pink-600 focus:ring-pink-500", data: { action: "change->availability-filter#toggleSection", availability_filter_target: "enableCheckbox" }, disabled: @questionnaire.archived_at.present? %>
            <%= form.label :include_availability_section, "Request availability in questionnaire", class: "ml-2 text-sm text-gray-700" %>
          </div>

          <div class="<%= @questionnaire.include_availability_section == true ? '' : 'hidden' %>" data-availability-filter-target="eventSection">
            <div class="mb-4">
              <%= form.check_box :require_all_availability, class: "rounded accent-pink-500 border-gray-300 text-pink-600 focus:ring-pink-500", disabled: @questionnaire.archived_at.present? %>
              <%= form.label :require_all_availability, "Require respondents to enter availability in order to submit questionnaire", class: "ml-2 text-sm text-gray-700" %>
            </div>

            <label class="text-sm font-medium text-gray-700 block mb-2">Include:</label>
            <div class="space-y-2">
              <div>
                <%= radio_button_tag "show_filter_mode", "all", @questionnaire.availability_show_ids.blank?, class: "rounded-full accent-pink-500 border-gray-300 text-pink-600 focus:ring-pink-500", data: { action: "change->availability-filter#updateFilter" }, disabled: @questionnaire.archived_at.present? %>
                <%= label_tag "show_filter_mode_all", "All Shows & Events", class: "ml-2 text-sm text-gray-700" %>
                <% if @shows.any? %>
                  <button type="button" class="ml-2 text-xs text-pink-500 underline cursor-pointer <%= @questionnaire.availability_show_ids.present? ? 'hidden' : '' %>" data-action="click->availability-filter#toggleShowList" data-availability-filter-target="showListToggle">
                    Show Shows & Events (<span data-availability-filter-target="count"><%= @shows.count %></span>)
                  </button>
                <% end %>
              </div>

              <% if @shows.any? %>
                <div class="hidden ml-6 bg-gray-50 rounded-lg p-3 max-h-40 overflow-y-auto" data-availability-filter-target="showList">
                  <ul class="space-y-1 text-sm">
                    <% @shows.each do |show| %>
                      <li class="flex justify-between" data-show-id="<%= show.id %>">
                        <span class="text-gray-900">
                          <span class="inline-flex items-center rounded-md px-1.5 py-0.5 text-xs font-medium ring-1 ring-inset <%= case show.event_type
                            when "rehearsal" then "bg-blue-50 text-blue-700 ring-blue-600/10"
                            when "meeting" then "bg-green-50 text-green-700 ring-green-600/10"
                            else "bg-pink-50 text-pink-700 ring-pink-600/10"
                          end %>">
                            <%= show.event_type.titleize %>
                          </span>
                          <%= show.date_and_time.strftime("%a, %b %-d at %-l:%M %p") %>
                          <% if show.secondary_name.present? %>
                            - <%= show.secondary_name %>
                          <% end %>
                        </span>
                      </li>
                    <% end %>
                  </ul>
                </div>
              <% end %>

              <div>
                <%= radio_button_tag "show_filter_mode", "specific", @questionnaire.availability_show_ids.present?, class: "rounded-full accent-pink-500 border-gray-300 text-pink-600 focus:ring-pink-500", data: { action: "change->availability-filter#updateFilter" }, disabled: @questionnaire.archived_at.present? %>
                <%= label_tag "show_filter_mode_specific", "Specific shows & events", class: "ml-2 text-sm text-gray-700" %>
              </div>
            </div>

            <%= hidden_field_tag "questionnaire[availability_show_ids][]", "" %>
            <div class="ml-6 mt-2 space-y-1 <%= @questionnaire.availability_show_ids.present? ? '' : 'hidden' %>" data-availability-filter-target="checkboxes">
              <% @shows.each do |show| %>
                <div>
                  <%= check_box_tag "questionnaire[availability_show_ids][]", show.id, @questionnaire.availability_show_ids&.include?(show.id), id: "questionnaire_availability_show_ids_#{show.id}", class: "rounded accent-pink-500 border-gray-300 text-pink-600 focus:ring-pink-500", data: { action: "change->availability-filter#updateShowList", availability_filter_target: "checkbox" }, disabled: @questionnaire.archived_at.present? %>
                  <%= label_tag "questionnaire_availability_show_ids_#{show.id}", class: "ml-2 text-sm text-gray-700 cursor-pointer" do %>
                    <span class="inline-flex items-center rounded-md px-1.5 py-0.5 text-xs font-medium ring-1 ring-inset <%= case show.event_type
                      when "rehearsal" then "bg-blue-50 text-blue-700 ring-blue-600/10"
                      when "meeting" then "bg-green-50 text-green-700 ring-green-600/10"
                      else "bg-pink-50 text-pink-700 ring-pink-600/10"
                    end %>">
                      <%= show.event_type.titleize %>
                    </span>
                    <%= show.date_and_time.strftime("%a, %b %-d at %-l:%M %p") %>
                    <% if show.secondary_name.present? %>
                      <span class="text-gray-500">- <%= show.secondary_name %></span>
                    <% end %>
                  <% end %>
                </div>
              <% end %>
            </div>

            <div class="mt-2">
              <%= link_to "Manage Shows & Events", manage_production_shows_path(@production), class: "text-xs text-pink-500 underline" %>
            </div>
          </div>

          <% unless @questionnaire.archived_at.present? %>
            <div class="border-t border-gray-200 pt-4 mt-4">
              <%= render "shared/button", text: "Save Availability Settings", variant: "primary", size: "medium", type: :submit %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Section 3: Custom Questions -->
  <div class="mb-4 border border-gray-200 rounded-lg overflow-hidden" data-controller="show-toggle" data-show-toggle-initial-open-value="<%= params[:question_id].present? || params[:questions_open].present? || @question.errors.any? %>">
    <%= render "shared/card_header", title: "Custom Questions", clickable: true do %>
      <div data-show-toggle-target="icon"></div>
    <% end %>
    <div data-show-toggle-target="content">
      <div class="p-4">
        <p class="text-sm text-gray-500 mb-4">Add custom questions to your questionnaire.</p>

        <div class="space-y-2">
            <% if @questions.any? %>
              <div class="space-y-2" data-controller="<%= @questionnaire.archived_at.present? ? '' : 'question-order' %>" data-question-order-url="<%= manage_reorder_questions_communications_questionnaire_path(@production, @questionnaire) %>">
                <% @questions.each do |question| %>
                  <div class="p-4 border border-gray-200 bg-white rounded-lg <%= @questionnaire.archived_at.present? ? '' : 'hover:border-gray-400 transition-all cursor-move' %>" <%= 'draggable="true"' unless @questionnaire.archived_at.present? %> data-question-order-target="item" data-id="<%= question.id %>" data-action="<%= @questionnaire.archived_at.present? ? '' : 'dragstart->question-order#startDrag dragend->question-order#endDrag dragover->question-order#dragOver drop->question-order#drop touchstart->question-order#touchStart touchmove->question-order#touchMove touchend->question-order#touchEnd' %>" onclick="event.stopPropagation();">
                    <div class="flex items-start gap-4">
                      <% unless @questionnaire.archived_at.present? %>
                        <span class="text-gray-400 cursor-move mt-1" title="Drag to reorder">
                          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9h16.5m-16.5 6.75h16.5" />
                          </svg>
                        </span>
                      <% end %>
                      <div class="flex-1">
                        <p class="mb-1 font-bold">
                          <%= question.text %>
                        </p>
                        <p class="text-sm text-gray-500 mb-1">
                          Type: <%= question.question_type_class&.label || question.question_type %>
                          <% if question.question_type_class&.needs_options? && question.question_options.any? %>
                          <span class="ml-1 text-gray-500">(Options: <%= question.question_options.pluck(:text).join(", ") %>)</span>
                          <% end %>
                        </p>
                        <p class="text-sm text-gray-500 mb-2">
                          Required: <%= question.required ? "Yes" : "No" %>
                        </p>
                        <% unless @questionnaire.archived_at.present? %>
                          <div class="flex gap-2 items-baseline">
                            <button
                              type="button"
                              data-action="question-modal#openForEdit"
                              data-question-text="<%= question.text %>"
                              data-question-type="<%= question.question_type %>"
                              data-question-required="<%= question.required %>"
                              data-update-path="<%= manage_update_question_communications_questionnaire_path(@production, @questionnaire, question_id: question.id) %>"
                              class="text-xs underline text-pink-500 hover:text-pink-600 cursor-pointer">
                              Edit
                            </button>
                            <%= button_to "Delete",
                                manage_destroy_question_communications_questionnaire_path(@production, @questionnaire, question_id: question.id),
                                method: :delete,
                                form: { data: { turbo_confirm: "Are you sure you want to delete this question?" }, class: "inline" },
                                class: "text-xs underline text-pink-500 hover:text-pink-600 cursor-pointer border-0 bg-transparent p-0 font-normal leading-none"
                            %>
                          </div>
                        <% end %>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            <% else %>
              <div class="p-4 text-sm border border-gray-200 bg-white rounded-lg text-center text-gray-500">
                <% if @questionnaire.archived_at.present? %>
                  No questions in this questionnaire.
                <% else %>
                  No questions yet. Click "Add Question" to create your first question.
                <% end %>
              </div>
            <% end %>

            <% unless @questionnaire.archived_at.present? %>
              <div class="mt-4">
                <%= render "shared/button",
                  text: "Add Question",
                  variant: "primary",
                  size: "medium",
                  type: :button,
                  icon: "plus",
                  data: { action: "question-modal#openForNew" } %>
              </div>
            <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Question Modal -->
  <% unless @questionnaire.archived_at.present? %>
    <%= render "shared/question_modal" %>
  <% end %>

</div>
