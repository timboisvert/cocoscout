<%
  # Parameters:
  # - show: the Show object
  # - title: optional string to override the date/time in the title bar (e.g., "Cast")
  # - production: the Production object
  # - roles: (optional) preloaded roles array
  # - roles_count: (optional) preloaded roles count
  # - roles_max_updated_at: (optional) precomputed max updated_at for roles
  # - assignments_max_updated_at_by_show: (optional) hash of show_id => max updated_at for assignments
  # - people_by_id: (optional) preloaded people hash
  # - groups_by_id: (optional) preloaded groups hash

  # Use preloaded data if available, otherwise fall back to show.available_roles
  # IMPORTANT: For shows with custom roles, we MUST use the show-specific roles
  if show.use_custom_roles?
    roles = show.available_roles.to_a
  else
    roles = local_assigns[:roles] || @roles || show.production.roles.order(:position).to_a
  end
  roles_count = roles.size
  people_by_id = local_assigns[:people_by_id] || @people_by_id || {}
  groups_by_id = local_assigns[:groups_by_id] || @groups_by_id || {}

  cast_count = show.show_person_role_assignments.size
  percentage = roles_count > 0 ? (cast_count.to_f / roles_count * 100).round : 0
  fully_cast = percentage == 100

  # Use precomputed timestamps if available, otherwise query (for backward compatibility)
  assignments_max = if @assignments_max_updated_at_by_show
    @assignments_max_updated_at_by_show[show.id]
  else
    show.show_person_role_assignments.maximum(:updated_at)
  end
  roles_max = if @roles_max_updated_at_by_show
    @roles_max_updated_at_by_show[show.id]
  else
    show.available_roles.maximum(:updated_at) || production.roles.maximum(:updated_at)
  end

  # Get cancelled vacancies for this show if available (for cache key and display)
  cancelled_vacancies = @cancelled_vacancies_by_show&.dig(show.id) || {}
  cancelled_vacancies_key = cancelled_vacancies.keys.sort.hash

  # Get open vacancies for non-linked shows (person removed, role needs filling)
  open_vacancies_by_role = @open_vacancies_by_show&.dig(show.id) || {}
  open_vacancies_key = open_vacancies_by_role.keys.sort.hash

  # Cache key includes show, assignments, and roles timestamps
  cast_card_cache_key = [
    "cast_card_v7",
    show.id,
    show.updated_at.to_i,
    show.use_custom_roles?,
    assignments_max&.to_i,
    roles_max&.to_i,
    roles_count,
    cancelled_vacancies_key,
    open_vacancies_key,
    title.presence || "default"
  ]
%>

<% cache cast_card_cache_key do %>
<%
  # Build data attributes for linked highlight
  card_data_attrs = {}
  if show.linked?
    card_data_attrs["linked-highlight-target"] = "row"
    card_data_attrs["linkage-id"] = show.event_linkage_id
  end
  card_data_attrs_str = card_data_attrs.map { |k, v| "data-#{k}=\"#{v}\"" }.join(" ")
%>
<%= link_to manage_production_show_cast_path(production, show), class: "block no-underline" do %>
  <div class="px-3 py-3 border border-gray-200 rounded-lg hover:border-gray-400 transition-all bg-white group" <%= card_data_attrs_str.html_safe %>>
    <div class="flex flex-col sm:flex-row sm:items-stretch gap-3 sm:gap-4">
      <%# Left Third: Date & Show Details %>
      <div class="flex items-center gap-3 sm:gap-4 sm:flex-1">
        <%# Date Box %>
        <div class="flex-shrink-0 w-12 sm:w-14 text-center">
          <div class="text-xs font-semibold text-pink-600 uppercase"><%= show.date_and_time.strftime("%b") %></div>
          <div class="text-2xl font-bold text-gray-900"><%= show.date_and_time.strftime("%-d") %></div>
          <div class="text-xs text-gray-500"><%= show.date_and_time.strftime("%a") %></div>
        </div>

        <%# Show Details %>
        <div class="min-w-0">
          <div class="font-medium text-gray-900 flex items-center gap-1.5">
            <%= show.secondary_name.presence || show.event_type.titleize %>
            <% if show.linked? %>
              <%
                other_shows = show.event_linkage.shows.where.not(id: show.id).order(:date_and_time)
                linked_tooltip = "Linked with: " + other_shows.map { |s|
                  name = s.secondary_name.presence || s.event_type.titleize
                  "#{s.date_and_time.strftime('%b %-d')} #{name}"
                }.join(", ")
              %>
              <span data-controller="tooltip" data-tooltip-text="<%= linked_tooltip %>">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="text-pink-500 w-4 h-4">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.757-1.757m13.35-.622 1.757-1.757a4.5 4.5 0 0 0-6.364-6.364l-4.5 4.5a4.5 4.5 0 0 0 1.242 7.244" />
                </svg>
              </span>
            <% end %>
          </div>
          <div class="text-sm text-gray-600">
            <%= show.date_and_time.strftime("%l:%M %p").strip %>
            <% if show.location.present? %>
              Â· <%= show.location.name %>
            <% end %>
          </div>
        </div>
      </div>

      <%# Right Two-Thirds: Casting %>
      <div class="flex-1 sm:flex-[2] sm:border-l border-t sm:border-t-0 border-gray-200 pt-3 sm:pt-0 sm:pl-4 flex flex-col justify-center">
        <div class="text-xs font-semibold text-gray-700 mb-1">Casting Progress</div>
        <div class="h-1.5 bg-gray-200 rounded-full overflow-hidden mb-1">
          <div class="h-full rounded-full <%= fully_cast ? 'bg-green-500' : 'bg-pink-500' %>" style="width: <%= percentage %>%"></div>
        </div>
        <div class="text-xs <%= fully_cast ? 'text-green-600' : 'text-gray-500' %> mb-2">
          <% if fully_cast %>
            Fully cast
          <% else %>
            <%= cast_count %>/<%= roles_count %> roles have been cast
          <% end %>
        </div>

        <%# Cast member headshots %>
        <div class="flex flex-wrap gap-1.5">
          <% roles.each do |role| %>
            <%
              # All roles now use role_id (both production and show-specific roles are in Role model)
              assignment = show.show_person_role_assignments.find { |a| a.role_id == role.id }
            %>
            <% if assignment %>
              <%
                assignable = if assignment.assignable_type == "Person"
                  people_by_id[assignment.assignable_id] || assignment.assignable
                else
                  groups_by_id[assignment.assignable_id] || assignment.assignable
                end
                cant_make_it = cancelled_vacancies[[role.id, assignable.class.name, assignable.id]].present?
                tooltip_text = "#{assignable.name} - #{role.name}"
                tooltip_text += " (Can't make it)" if cant_make_it
              %>
              <% headshot_variant = assignable.safe_headshot_variant(:thumb) %>
              <div class="relative">
                <% if headshot_variant %>
                  <%= image_tag headshot_variant,
                      alt: assignable.name,
                      class: "w-10 h-10 rounded-md object-cover #{cant_make_it ? 'ring-2 ring-amber-400' : ''}",
                      data: { controller: "tooltip", tooltip_text: tooltip_text } %>
                <% else %>
                  <div class="w-10 h-10 rounded-md <%= cant_make_it ? 'bg-amber-100 text-amber-700 ring-2 ring-amber-400' : 'bg-green-100 text-green-700' %> flex items-center justify-center font-bold text-xs"
                       data-controller="tooltip"
                       data-tooltip-text="<%= tooltip_text %>">
                    <%= assignable.initials %>
                  </div>
                <% end %>
                <% if cant_make_it %>
                  <div class="absolute -bottom-0.5 -right-0.5 w-3.5 h-3.5 bg-amber-500 rounded-full flex items-center justify-center" data-controller="tooltip" data-tooltip-text="Can't make it">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="white" class="w-2.5 h-2.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
                    </svg>
                  </div>
                <% end %>
              </div>
            <% else %>
              <%
                # Check for open vacancy on this role (non-linked shows)
                role_open_vacancies = open_vacancies_by_role[role.id] || []
                has_open_vacancy = role_open_vacancies.any?
                vacancy = role_open_vacancies.first
                vacated_by = vacancy&.vacated_by
                tooltip_text = if has_open_vacancy && vacated_by
                  "#{role.name} - #{vacated_by.name} can't make it"
                elsif has_open_vacancy
                  "#{role.name} - Looking for someone"
                else
                  "#{role.name} - Not Cast"
                end
              %>
              <div class="w-10 h-10 rounded-md border-2 border-dashed <%= has_open_vacancy ? 'border-amber-400 bg-amber-50' : 'border-gray-300 bg-gray-50' %> flex items-center justify-center <%= has_open_vacancy ? 'text-amber-500' : 'text-gray-400' %> text-xs relative"
                   data-controller="tooltip"
                   data-tooltip-text="<%= tooltip_text %>">
                <% if has_open_vacancy %>
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                  </svg>
                <% else %>
                  +
                <% end %>
              </div>
            <% end %>
          <% end %>
        </div>

        <%# Show "Can't make it" warning if any cast members have vacancies %>
        <% cant_make_it_list = [] %>
        <% roles.each do |role| %>
          <% assignment = show.show_person_role_assignments.find { |a| a.role_id == role.id } %>
          <% if assignment %>
            <%
              assignable = if assignment.assignable_type == "Person"
                people_by_id[assignment.assignable_id] || assignment.assignable
              else
                groups_by_id[assignment.assignable_id] || assignment.assignable
              end
              vacancy = cancelled_vacancies[[role.id, assignable.class.name, assignable.id]]
              if vacancy
                cant_make_it_list << { name: assignable.name, role: role.name, vacancy: vacancy }
              end
            %>
          <% end %>
        <% end %>
        <% if cant_make_it_list.any? %>
          <div class="mt-2 px-2 py-1.5 bg-amber-50 border border-amber-200 rounded-md">
            <div class="flex items-center gap-1.5 text-amber-700">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 flex-shrink-0">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
              </svg>
              <span class="text-xs font-medium">Can't make it:</span>
              <span class="text-xs">
                <%= cant_make_it_list.map { |item| "#{item[:name]} (#{item[:role]})" }.join(", ") %>
              </span>
            </div>
          </div>
        <% end %>

        <%# Show "Needs replacement" warning for non-linked shows with open vacancies %>
        <% if !show.linked? %>
          <%
            needs_replacement_list = []
            open_vacancies_by_role.each do |role_id, vacancies|
              role = roles.find { |r| r.id == role_id }
              next unless role
              vacancy = vacancies.first
              vacated_by = vacancy&.vacated_by
              needs_replacement_list << { name: vacated_by&.name || "Someone", role: role.name }
            end
          %>
          <% if needs_replacement_list.any? %>
            <div class="mt-2 px-2 py-1.5 bg-amber-50 border border-amber-200 rounded-md">
              <div class="flex items-center gap-1.5 text-amber-700">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 flex-shrink-0">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                </svg>
                <span class="text-xs font-medium">Needs replacement:</span>
                <span class="text-xs">
                  <%= needs_replacement_list.map { |item| "#{item[:name]} can't make it (#{item[:role]})" }.join(", ") %>
                </span>
              </div>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
<% end %>
<% end %>
