<%#
  Ticketing Show Row - Three Panel Layout for Show Ticketing Setup

  Required:
    - show: Show object
    - production: Production object

  Optional:
    - ticketing: ShowTicketing object (if exists)
    - link_path: Path to link to (defaults to show ticketing management)
    - show_action_link: Whether to show action link (default: true)
    - action_text: Text for action link (default: "Manage" or "Set Up")
    - action_path: Path for action link (defaults based on ticketing existence)

  Panels:
    1. Date/Time box + Show info
    2. Status panel (Set Up / Not Set Up)
    3. Capacity & Sold panel
    4. Action link panel
%>

<%
  ticketing = local_assigns[:ticketing]
  is_set_up = ticketing.present?
  is_canceled = show.canceled?
  show_action_link = local_assigns.fetch(:show_action_link, true)
  
  if is_set_up
    action_text = local_assigns.fetch(:action_text, "Manage")
    action_path = local_assigns.fetch(:action_path, manage_show_ticketing_path(production, show))
    link_path = local_assigns.fetch(:link_path, manage_show_ticketing_path(production, show))
  else
    action_text = local_assigns.fetch(:action_text, "Set Up")
    action_path = local_assigns.fetch(:action_path, manage_setup_show_ticketing_path(production, show))
    link_path = local_assigns.fetch(:link_path, manage_setup_show_ticketing_path(production, show))
  end
  
  total_capacity = ticketing&.total_capacity || 0
  total_sold = ticketing&.total_sold || 0
  sold_percentage = total_capacity > 0 ? ((total_sold.to_f / total_capacity) * 100).round : 0
%>

<div class="bg-white rounded-lg border border-gray-200 hover:border-gray-300 transition-all <%= 'opacity-60' if is_canceled %>">

  <%= link_to link_path, class: "block" do %>
    <div class="flex flex-col lg:flex-row lg:items-stretch">

      <%# Panel 1: Date + Show Info %>
      <div class="flex-1 flex items-center gap-4 px-4 py-3 rounded-t-lg lg:rounded-l-lg lg:rounded-tr-none">
        <%# Date Box %>
        <div class="flex-shrink-0 w-14 text-center <%= 'line-through' if is_canceled %>">
          <div class="text-xs font-semibold text-pink-600 uppercase"><%= show.date_and_time.strftime("%b") %></div>
          <div class="text-2xl font-bold text-gray-900"><%= show.date_and_time.strftime("%-d") %></div>
          <div class="text-xs text-gray-500"><%= show.date_and_time.strftime("%a") %></div>
        </div>

        <%# Show Details %>
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-2 flex-wrap">
            <span class="font-medium text-gray-900 <%= 'line-through' if is_canceled %>">
              <%= show.display_name %>
            </span>
            <% if is_canceled %>
              <span class="inline-flex items-center rounded-md bg-red-50 px-2 py-0.5 text-xs font-medium text-red-700 ring-1 ring-inset ring-red-600/10">Canceled</span>
            <% end %>
          </div>
          <div class="text-sm text-gray-600 <%= 'line-through' if is_canceled %>">
            <%= show.date_and_time.strftime("%l:%M %p").strip %>
            <% if show.location.present? %>
              &middot; <%= show.location.name %>
            <% elsif show.is_online %>
              &middot; Online
            <% end %>
          </div>
        </div>
      </div>

      <%# Panel 2: Status %>
      <div class="w-full lg:w-1/6 px-4 py-3 border-t lg:border-t-0 lg:border-l border-gray-200 flex flex-col justify-center">
        <div class="text-[10px] text-gray-400 uppercase tracking-wide mb-1">Status</div>
        <% if is_set_up %>
          <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 w-fit">
            Set Up
          </span>
        <% else %>
          <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600 w-fit">
            Not Set Up
          </span>
        <% end %>
      </div>

      <%# Panel 3: Capacity & Sold %>
      <div class="w-full lg:w-1/6 px-4 py-3 border-t lg:border-t-0 lg:border-l border-gray-200 flex flex-col justify-center">
        <div class="text-[10px] text-gray-400 uppercase tracking-wide mb-1">Tickets</div>
        <% if is_set_up && total_capacity > 0 %>
          <div class="text-sm font-medium text-gray-900">
            <span class="text-green-600"><%= total_sold %></span>
            <span class="text-gray-400">/</span>
            <span><%= total_capacity %></span>
          </div>
          <div class="text-xs text-gray-400"><%= sold_percentage %>% sold</div>
        <% elsif is_set_up %>
          <div class="text-sm text-gray-400">No capacity set</div>
        <% else %>
          <div class="text-sm text-gray-400">â€”</div>
        <% end %>
      </div>

      <%# Panel 4: Action %>
      <% if show_action_link %>
        <div class="w-full lg:w-1/6 px-4 py-3 border-t lg:border-t-0 lg:border-l border-gray-200 rounded-b-lg lg:rounded-r-lg lg:rounded-bl-none flex items-center justify-end">
          <span class="text-sm font-medium text-pink-600 group-hover:text-pink-800"><%= action_text %> &rarr;</span>
        </div>
      <% end %>

    </div>
  <% end %>
</div>
