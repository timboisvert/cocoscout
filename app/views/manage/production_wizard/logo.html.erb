<%= render layout: "manage/production_wizard/wizard_layout", locals: { current_step: 2, step_name: "Logo" } do %>
  <div class="text-center mb-6">
    <div class="w-16 h-16 bg-pink-100 rounded-full flex items-center justify-center mx-auto mb-4" id="logo-placeholder">
      <svg class="w-8 h-8 text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
      </svg>
    </div>
    <h2 class="text-xl font-bold text-gray-900 coustard-regular">Add a logo</h2>
    <p class="text-gray-600 mt-2">Upload a logo to give your production a visual identity. You can always add or change this later.</p>
  </div>

  <%= form_with url: manage_productions_wizard_save_logo_path, method: :post, multipart: true, local: true, id: "logo-form" do |form| %>
    <div class="space-y-6">
      <!-- Logo Preview Area -->
      <div class="flex flex-col items-center">
        <!-- Preview Container - shows selected image -->
        <div id="preview-container" class="hidden mb-4">
          <div class="relative inline-block">
            <img id="logo-preview" src="" alt="Logo preview" class="max-h-40 max-w-xs rounded-lg border-2 border-pink-200 shadow-sm">
            <button type="button" id="remove-logo" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 hover:bg-red-600 transition-colors shadow-md">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
          <p id="file-name" class="text-sm text-gray-600 mt-2 text-center"></p>
        </div>

        <% if @wizard_state[:logo_temp_path].present? && File.exist?(@wizard_state[:logo_temp_path]) %>
          <div class="mb-4" id="existing-logo-info">
            <p class="text-sm font-medium text-gray-700 mb-2">Current selection:</p>
            <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
              <p class="text-sm text-gray-600"><%= @wizard_state[:logo_filename] %></p>
            </div>
          </div>
        <% end %>

        <!-- Logo Upload - Dropzone -->
        <div class="w-full max-w-sm" id="dropzone-container">
          <label class="relative block cursor-pointer">
            <div id="dropzone" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-pink-400 transition-colors">
              <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
              </svg>
              <div class="mt-4 flex justify-center text-sm text-gray-600">
                <span class="font-medium text-pink-600 hover:text-pink-500">Upload a file</span>
                <span class="pl-1">or drag and drop</span>
              </div>
              <p class="mt-1 text-xs text-gray-500">PNG, JPG, GIF up to 10MB</p>
            </div>
            <input type="file" name="logo" accept="image/png,image/jpeg,image/gif" id="logo-input" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
          </label>
        </div>
      </div>
    </div>

    <div class="mt-8 flex justify-between items-center">
      <%= link_to manage_productions_wizard_path, class: "text-gray-500 hover:text-gray-700 text-sm py-2" do %>
        ‚Üê Back
      <% end %>

      <div class="flex gap-3">
        <%= render "shared/button", text: "Skip for now", variant: "ghost", size: "medium", type: :button, id: "skip-button" %>
        <%= render "shared/button", text: "Next", variant: "primary", size: "medium", type: :submit %>
      </div>
    </div>

    <input type="hidden" name="skip" value="false" id="skip-field">
  <% end %>
<% end %>

<script>
(function() {
  // Get all elements
  const input = document.getElementById('logo-input');
  const preview = document.getElementById('logo-preview');
  const previewContainer = document.getElementById('preview-container');
  const fileNameDisplay = document.getElementById('file-name');
  const dropzone = document.getElementById('dropzone');
  const dropzoneContainer = document.getElementById('dropzone-container');
  const removeButton = document.getElementById('remove-logo');
  const skipButton = document.getElementById('skip-button');
  const skipField = document.getElementById('skip-field');
  const form = document.getElementById('logo-form');
  const placeholder = document.getElementById('logo-placeholder');
  const existingLogoInfo = document.getElementById('existing-logo-info');

  // Handle file selection
  function handleFileSelect(file) {
    if (!file) return;

    // Validate file type
    const validTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif'];
    if (!validTypes.includes(file.type)) {
      alert('Please select a PNG, JPG, or GIF image.');
      return;
    }

    // Validate file size (10MB)
    if (file.size > 10 * 1024 * 1024) {
      alert('File size must be less than 10MB.');
      return;
    }

    // Read and display the file
    const reader = new FileReader();
    reader.onload = function(e) {
      preview.src = e.target.result;
      fileNameDisplay.textContent = file.name;
      previewContainer.classList.remove('hidden');
      dropzoneContainer.classList.add('hidden');
      if (placeholder) placeholder.classList.add('hidden');
      if (existingLogoInfo) existingLogoInfo.classList.add('hidden');
    };
    reader.onerror = function() {
      alert('Error reading file. Please try again.');
    };
    reader.readAsDataURL(file);
  }

  // File input change
  if (input) {
    input.addEventListener('change', function(e) {
      if (e.target.files && e.target.files[0]) {
        handleFileSelect(e.target.files[0]);
      }
    });
  }

  // Drag and drop
  if (dropzone) {
    ['dragenter', 'dragover'].forEach(eventName => {
      dropzone.addEventListener(eventName, function(e) {
        e.preventDefault();
        e.stopPropagation();
        dropzone.classList.add('border-pink-400', 'bg-pink-50');
      });
    });

    ['dragleave', 'drop'].forEach(eventName => {
      dropzone.addEventListener(eventName, function(e) {
        e.preventDefault();
        e.stopPropagation();
        dropzone.classList.remove('border-pink-400', 'bg-pink-50');
      });
    });

    dropzone.addEventListener('drop', function(e) {
      const files = e.dataTransfer.files;
      if (files && files[0]) {
        // Update the input with the dropped file
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(files[0]);
        input.files = dataTransfer.files;
        handleFileSelect(files[0]);
      }
    });
  }

  // Remove button
  if (removeButton) {
    removeButton.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      input.value = '';
      preview.src = '';
      fileNameDisplay.textContent = '';
      previewContainer.classList.add('hidden');
      dropzoneContainer.classList.remove('hidden');
      if (placeholder) placeholder.classList.remove('hidden');
    });
  }

  // Skip button
  if (skipButton && skipField && form) {
    skipButton.addEventListener('click', function(e) {
      e.preventDefault();
      skipField.value = 'true';
      form.submit();
    });
  }
})();
</script>
