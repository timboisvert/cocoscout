<% content_for :title, "Review - Auditions" %>

<div class="w-full mb-10">
  <%= render partial: "shared/notice", locals: { notice: notice } %>
  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [
      ["Auditions", manage_production_auditions_path(@production)]
    ],
    text: "Review",
    links: []
  } %>

  <%= render partial: "lifecycle_panel", locals: { current_step: :review } %>

  <%= render partial: "archived_banner" %>

  <% if @audition_cycle.blank? %>
    <div class="mb-5 text-gray-500 text-sm">
      You aren't currently offering auditions for <%= @production.name %>
    </div>
  <% else %>
    <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden mb-6">
      <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
        <h3 class="text-md font-semibold text-gray-900 coustard-regular">
          <% if @audition_cycle.audition_type == "video_upload" %>
            Video Auditions
          <% elsif @audition_cycle.audition_type == "in_person" %>
            Sign-ups
          <% end %>
        </h3>
      </div>
      <div class="p-6">
        <p class="text-sm text-gray-500 mb-6">Review and decide on each auditionee's application.</p>

        <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 mb-6">
          <%= link_to manage_production_audition_cycle_audition_requests_path(@production, @audition_cycle, filter: :unreviewed) do %>
            <div class="p-4 bg-white border border-gray-200 rounded-lg hover:border-gray-400 transition-all min-h-24">
              <p class="font-bold text-5xl text-center"><%= @audition_cycle.counts[:unreviewed] %></p>
              <p class="text-xs text-center">Unreviewed</p>
            </div>
          <% end %>
          <%= link_to manage_production_audition_cycle_audition_requests_path(@production, @audition_cycle, filter: :undecided) do %>
            <div class="p-4 bg-white border border-gray-200 rounded-lg hover:border-gray-400 transition-all min-h-24">
              <p class="font-bold text-5xl text-center"><%= @audition_cycle.counts[:undecided] %></p>
              <p class="text-xs text-center">Revisit</p>
            </div>
          <% end %>
          <%= link_to manage_production_audition_cycle_audition_requests_path(@production, @audition_cycle, filter: :accepted) do %>
            <div class="p-4 bg-white border border-gray-200 rounded-lg hover:border-gray-400 transition-all min-h-24">
              <p class="font-bold text-5xl text-center"><%= @audition_cycle.counts[:accepted] %></p>
              <p class="text-xs text-center">Yes</p>
            </div>
          <% end %>
          <%= link_to manage_production_audition_cycle_audition_requests_path(@production, @audition_cycle, filter: :passed) do %>
            <div class="p-4 bg-white border border-gray-200 rounded-lg hover:border-gray-400 transition-all min-h-24">
              <p class="font-bold text-5xl text-center"><%= @audition_cycle.counts[:passed] %></p>
              <p class="text-xs text-center">No</p>
            </div>
          <% end %>
        </div>

        <%
          button_text = @audition_cycle.audition_type == "video_upload" ? "View all Video Auditions" : "View all Sign-ups"
        %>
        <%= render partial: "shared/button", locals: {text: button_text, path: manage_production_audition_cycle_audition_requests_path(@production, @audition_cycle, filter: :all), variant: "primary"} %>
      </div>
    </div>

    <% if @audition_cycle.audition_type == "in_person" %>
    <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden">
      <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
        <h3 class="text-md font-semibold text-gray-900 coustard-regular">Schedule Auditions</h3>
      </div>
      <div class="p-6">
        <p class="text-sm text-gray-500 mb-6">Assign people to audition sessions.</p>

        <% if @audition_cycle.audition_sessions.any? %>
          <div class="space-y-3">
            <% @audition_cycle.audition_sessions.order(:start_at).each do |session| %>
              <div class="flex items-stretch px-3 py-2 border rounded-lg hover:border-gray-400 transition-all bg-white border-gray-200">
                <%# Left Section: Date & Session Details %>
                <div class="w-1/2 flex items-center gap-4">
                  <%# Date Box %>
                  <div class="flex-shrink-0 w-14 text-center">
                    <div class="text-xs font-semibold text-pink-600 uppercase"><%= session.start_at.strftime("%b") %></div>
                    <div class="text-2xl font-bold text-gray-900"><%= session.start_at.strftime("%-d") %></div>
                    <div class="text-xs text-gray-500"><%= session.start_at.strftime("%a") %></div>
                  </div>

                  <%# Session Details %>
                  <div class="flex-1 min-w-0">
                    <div class="font-medium text-gray-900">Audition Session</div>
                    <div class="text-sm text-gray-600">
                      <%= session.start_at.strftime("%l:%M %p") %>
                      <% if session.location.present? %>
                        Â· <%= session.location.name %>
                      <% end %>
                    </div>
                  </div>
                </div>

                <%# Right Section: People %>
                <div class="w-1/2 border-l border-gray-200 pl-4 flex items-center">
                  <div class="flex-1">
                    <div class="text-[10px] text-gray-400 uppercase tracking-wide mb-1">Scheduled</div>
                    <% if session.auditions.any? %>
                      <div class="flex flex-wrap gap-1">
                        <% session.auditions.limit(10).each do |audition| %>
                          <% auditionable = audition.auditionable %>
                          <% headshot_url = safe_headshot_url(auditionable, variant: :thumb) %>
                          <span data-controller="tooltip" data-tooltip-text="<%= auditionable.name %>">
                            <% if headshot_url %>
                              <%= image_tag headshot_url, alt: auditionable.name, class: "w-8 h-8 rounded-lg object-cover" %>
                            <% elsif auditionable.is_a?(Person) %>
                              <div class="w-8 h-8 rounded-lg bg-pink-100 flex items-center justify-center text-pink-600 font-bold text-xs">
                                <%= auditionable.initials %>
                              </div>
                            <% else %>
                              <div class="w-8 h-8 rounded-lg bg-pink-100 flex items-center justify-center text-pink-600">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m.94 3.198l.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0112 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 016 18.719m12 0a5.971 5.971 0 00-.941-3.197m0 0A5.995 5.995 0 0012 12.75a5.995 5.995 0 00-5.058 2.772m0 0a3 3 0 00-4.681 2.72 8.986 8.986 0 003.74.477m.94-3.197a5.971 5.971 0 00-.94 3.197M15 6.75a3 3 0 11-6 0 3 3 0 016 0zm6 3a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0zm-13.5 0a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0z" />
                                </svg>
                              </div>
                            <% end %>
                          </span>
                        <% end %>
                        <% if session.auditions.count > 10 %>
                          <div class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center text-gray-600 text-xs font-medium">
                            +<%= session.auditions.count - 10 %>
                          </div>
                        <% end %>
                      </div>
                    <% else %>
                      <p class="text-gray-500 text-sm">None</p>
                    <% end %>
                  </div>
                </div>
              </div>
            <% end %>
          </div>

          <div class="mt-4">
            <%= render partial: "shared/button", locals: {text: "Schedule Auditions", path: schedule_auditions_manage_production_audition_cycle_path(@production, @audition_cycle), variant: "primary"} %>
          </div>
        <% else %>
          <p class="text-gray-500 text-sm mb-4">No audition sessions have been scheduled yet.</p>
          <%= render partial: "shared/button", locals: {text: "Schedule Auditions", path: manage_production_audition_cycle_audition_sessions_path(@production, @audition_cycle), variant: "primary"} %>
        <% end %>
      </div>
    </div>
    <% end %>

    <% if @audition_cycle.audition_type == "in_person" %>
    <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden mt-6">
      <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
        <h3 class="text-md font-semibold text-gray-900 coustard-regular">Finalize Audition Plans and Notify</h3>
      </div>
      <div class="p-6">
        <p class="text-sm text-gray-500 mb-4">Send notification emails to all applicants about their audition status and schedule.</p>

        <% # Get all audition requests %>
        <% all_audition_requests = @audition_cycle.audition_requests.includes(:requestable) %>

        <% # Get all scheduled auditionables (people and groups) for this audition cycle %>
        <% scheduled_auditionables = @audition_cycle.audition_sessions.joins(:auditions).pluck('auditions.auditionable_type', 'auditions.auditionable_id').map { |type, id| [type, id] }.to_set %>

        <% # Count people who have been notified and whose status hasn't changed since %>
        <% notified_requests = all_audition_requests.select { |req| req.invitation_notification_sent_at.present? && req.notified_status == req.status && (scheduled_auditionables.include?([req.requestable_type, req.requestable_id]) == req.notified_scheduled) } %>
        <% notified_people_count = notified_requests.count %>

        <% # Show requests that haven't been notified yet OR whose status has changed OR whose scheduling status has changed %>
        <% audition_requests = all_audition_requests.select { |req| req.invitation_notification_sent_at.nil? || req.notified_status != req.status || (scheduled_auditionables.include?([req.requestable_type, req.requestable_id]) != req.notified_scheduled) } %>
        <% accepted_requests = audition_requests.select { |req| req.status == "accepted" } %>
        <% not_accepted_requests = audition_requests.reject { |req| req.status == "accepted" } %>

        <% # Load email assignments for requestables (people and groups) who haven't been notified %>
        <% requestable_tuples = audition_requests.map { |r| [r.requestable_type, r.requestable_id] } %>
        <% email_assignments = @audition_cycle.audition_email_assignments
             .where(assignable_type: requestable_tuples.map(&:first).uniq, assignable_id: requestable_tuples.map(&:last))
             .index_by { |a| [a.assignable_type, a.assignable_id] } %>
        <% # Load custom email groups (exclude default group_ids to avoid duplicates) %>
        <% custom_groups = @audition_cycle.email_groups.where(group_type: 'audition').where.not(group_id: ['invitation_accepted', 'invitation_not_accepted']).order(:created_at) %>

        <% if @audition_cycle.finalize_audition_invitations %>
          <%# Finalized state - show notice %>
          <% if audition_requests.any? %>
            <%# There are new people to notify %>
            <div class="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
              <div class="flex items-start gap-3">
                <div class="flex-shrink-0">
                  <svg class="w-5 h-5 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 9a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/>
                  </svg>
                </div>
                <div class="flex-1">
                  <h4 class="text-sm font-semibold text-yellow-900 mb-1">New Auditions have been scheduled</h4>
                  <p class="text-sm text-yellow-800 mb-0">
                    <%= notified_people_count %> <%= 'auditionee'.pluralize(notified_people_count) %> <%= notified_people_count == 1 ? 'has' : 'have' %> already been notified.
                    <%= audition_requests.count %> <%= 'auditionee'.pluralize(audition_requests.count) %> still need<%= audition_requests.count == 1 ? 's' : '' %> to be notified.
                  </p>
                </div>
              </div>
            </div>
          <% else %>
            <%# Everyone has been notified %>
            <div class="mb-4 p-4 bg-green-50 border border-green-200 rounded-lg">
              <div class="flex items-start gap-3">
                <div class="flex-shrink-0">
                  <svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                  </svg>
                </div>
                <div class="flex-1">
                  <h4 class="text-sm font-semibold text-green-900 mb-1">All Audition decision notifications have been sent</h4>
                  <p class="text-sm text-green-800 mb-0">
                    Notification emails have been sent to all <%= notified_people_count %> <%= 'sign-up'.pluralize(notified_people_count) %>.
                    If new people sign up or more people are offered an audition, they will appear here for notification.
                  </p>
                </div>
              </div>
            </div>
          <% end %>
        <% end %>

        <% if accepted_requests.any? || not_accepted_requests.any? %>
          <div data-controller="email-groups tabs" data-email-groups-production-id-value="<%= @production.id %>" data-email-groups-audition-cycle-id-value="<%= @audition_cycle.id %>" data-email-groups-group-type-value="audition">

            <nav class="flex flex-wrap gap-2 border-b border-gray-200 mb-4">
              <% # Helper method to get email group ID for a requestable (person or group) %>
              <% get_email_group_id = lambda do |requestable|
                assignment = email_assignments[[requestable.class.name, requestable.id]]
                if assignment&.email_group_id.present?
                  assignment.email_group_id
                else
                  # Default group: requestables are in "Invited to Audition" ONLY if they're currently scheduled
                  # Otherwise they go to "Not Invited" even if their request status is "accepted"
                  if scheduled_auditionables.include?([requestable.class.name, requestable.id])
                    "invitation_accepted"
                  else
                    "invitation_not_accepted"
                  end
                end
              end %>
              <% # Group all requestables by their email group %>
              <% requestables_by_group = audition_requests.map(&:requestable).compact.group_by(&get_email_group_id) %>

              <%# Tab for accepted invitations %>
              <% accepted_group_requestables = requestables_by_group["invitation_accepted"] || [] %>
              <button
                type="button"
                data-tabs-target="tab"
                data-index="0"
                data-group-tab
                data-group-id="invitation_accepted"
                data-action="tabs#select email-groups#selectGroup"
                class="px-3 lg:px-4 py-2 text-xs lg:text-sm font-medium bg-white border-b-2 text-pink-600 border-pink-600 cursor-pointer whitespace-nowrap hover:text-pink-600 flex items-center gap-2"
              >
                <svg class="hidden w-5 h-5 text-pink-600" data-email-groups-target="tabIndicator" data-tab-group-id="invitation_accepted" fill="currentColor" viewBox="0 0 24 24">
                  <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm13.36-1.814a.75.75 0 1 0-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 0 0-1.06 1.06l2.25 2.25a.75.75 0 0 0 1.14-.094l3.75-5.25Z" clip-rule="evenodd" />
                </svg>
                <span>Invited to Audition (<%= accepted_group_requestables.size %>)</span>
              </button>

              <%# Tab for not accepted %>
              <% not_accepted_group_requestables = requestables_by_group["invitation_not_accepted"] || [] %>
              <button
                type="button"
                data-tabs-target="tab"
                data-index="1"
                data-group-tab
                data-group-id="invitation_not_accepted"
                data-action="tabs#select email-groups#selectGroup"
                class="px-3 lg:px-4 py-2 text-xs lg:text-sm font-medium bg-white border-b-2 text-gray-500 bg-gray-50 border-transparent cursor-pointer whitespace-nowrap hover:text-pink-600 flex items-center gap-2"
              >
                <svg class="hidden w-5 h-5 text-pink-600" data-email-groups-target="tabIndicator" data-tab-group-id="invitation_not_accepted" fill="currentColor" viewBox="0 0 24 24">
                  <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm13.36-1.814a.75.75 0 1 0-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 0 0-1.06 1.06l2.25 2.25a.75.75 0 0 0 1.14-.094l3.75-5.25Z" clip-rule="evenodd" />
                </svg>
                <span>Not Invited (<%= not_accepted_group_requestables.size %>)</span>
              </button>

              <%# Custom email group tabs %>
              <% custom_groups.each_with_index do |custom_group, idx| %>
                <% group_requestables = requestables_by_group[custom_group.group_id] || [] %>
                <button
                  type="button"
                  data-tabs-target="tab"
                  data-index="<%= 2 + idx %>"
                  data-group-tab
                  data-group-id="<%= custom_group.group_id %>"
                  data-action="tabs#select email-groups#selectGroup"
                  class="px-3 lg:px-4 py-2 text-xs lg:text-sm font-medium bg-white border-b-2 text-gray-500 bg-gray-50 border-transparent cursor-pointer whitespace-nowrap hover:text-pink-600 flex items-center gap-2"
                >
                  <svg class="hidden w-5 h-5 text-pink-600" data-email-groups-target="tabIndicator" data-tab-group-id="<%= custom_group.group_id %>" fill="currentColor" viewBox="0 0 24 24">
                    <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm13.36-1.814a.75.75 0 1 0-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 0 0-1.06 1.06l2.25 2.25a.75.75 0 0 0 1.14-.094l3.75-5.25Z" clip-rule="evenodd" />
                  </svg>
                  <span><%= custom_group.name %> (<%= group_people.size %>)</span>
                </button>
              <% end %>

              <%# Add button for creating new email group %>
              <button
                type="button"
                data-action="click->email-groups#createNewGroup"
                class="px-3 lg:px-4 py-2 text-xs lg:text-sm font-medium bg-white border-b-2 border-transparent text-gray-400 hover:text-pink-600 cursor-pointer whitespace-nowrap"
              >
                + New Email Group
              </button>
            </nav>

            <div class="space-y-4">
              <%# Panel for accepted invitations %>
              <div data-tabs-target="panel" data-group-panel data-group-id="invitation_accepted">
                <div class="mb-4">
                  <h5 class="text-sm font-semibold text-gray-900 mb-3">People/Groups being invited to audition:</h5>
                  <div class="flex flex-wrap gap-2">
                    <% if accepted_group_requestables.any? %>
                      <% accepted_group_requestables.each do |requestable| %>
                        <% assignment = email_assignments[[requestable.class.name, requestable.id]] %>
                        <% request = audition_requests.find { |r| r.requestable == requestable } %>
                        <% original_group = request&.status == 'accepted' ? 'invitation_accepted' : 'invitation_not_accepted' %>
                        <div
                          class="inline-flex items-center gap-2 px-2 py-1 rounded text-xs font-medium border border-gray-200 hover:border-pink-400 cursor-pointer transition-all"
                          data-requestable-type="<%= requestable.class.name %>"
                          data-requestable-id="<%= requestable.id %>"
                          data-email-assignment-id="<%= assignment&.id || '' %>"
                          data-original-group="<%= original_group %>"
                          data-action="click->email-groups#showPopup"
                        >
                          <% headshot_url = safe_headshot_url(requestable, variant: :thumb) %>
                          <% if headshot_url %>
                            <%= image_tag headshot_url, alt: requestable.name, class: "w-5 h-5 rounded object-cover flex-shrink-0", draggable: false %>
                          <% elsif requestable.is_a?(Person) %>
                            <div class="w-5 h-5 rounded bg-gray-200 flex items-center justify-center text-black font-bold text-xs flex-shrink-0">
                              <%= requestable.initials %>
                            </div>
                          <% else %>
                            <div class="w-5 h-5 rounded bg-gray-200 flex items-center justify-center text-black font-bold text-xs flex-shrink-0">
                              <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" class="w-3 h-3">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m.94 3.198l.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0112 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 016 18.719m12 0a5.971 5.971 0 00-.941-3.197m0 0A5.995 5.995 0 0012 12.75a5.995 5.995 0 00-5.058 2.772m0 0a3 3 0 00-4.681 2.72 8.986 8.986 0 003.74.477m.94-3.197a5.971 5.971 0 00-.94 3.197M15 6.75a3 3 0 11-6 0 3 3 0 016 0zm6 3a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0zm-13.5 0a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0z" />
                              </svg>
                            </div>
                          <% end %>
                          <span><%= requestable.name %></span>
                        </div>
                      <% end %>
                    <% else %>
                      <p class="text-sm text-gray-500 italic">No people or groups in this category yet.</p>
                    <% end %>
                  </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-900 mb-2">Notification Email</label>
                    <textarea
                      data-email-groups-target="emailTemplate"
                      data-group-id="invitation_accepted"
                      <% if @invitation_accepted_group %>data-email-group-id="<%= @invitation_accepted_group.id %>"<% end %>
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500"
                      rows="6"
                    ><% if @invitation_accepted_group&.email_template.present? %><%= @invitation_accepted_group.email_template %><% else %>Dear [Name],

Congratulations! You've been invited to audition for <%= @production.name %>.

<% if @audition_cycle.audition_type == "video_upload" %>Your audition materials have been received and are under review. We'll notify you once decisions have been made.<% else %>Your audition is scheduled for [Date and Time] at [Location]. Please arrive 10 minutes early.

You can view your full audition details on your Auditions page.<% end %>

We look forward to seeing you!

Best regards,
The <%= @production.name %> Team<% end %></textarea>
                  </div>

                  <% if accepted_group_requestables.any? %>
                    <div class="mt-4 pt-4 border-t border-gray-200">
                      <label class="flex items-center gap-3 cursor-pointer">
                        <input
                          type="checkbox"
                          data-email-groups-target="reviewCheckbox"
                          data-checkbox-group-id="invitation_accepted"
                          data-action="change->email-groups#checkAllReviewed"
                          class="rounded accent-pink-500 border-gray-300 text-pink-600 focus:ring-pink-500"
                        >
                        <span class="text-sm text-gray-700">I have reviewed the recipient list and email text for this group</span>
                      </label>
                    </div>
                  <% end %>
                </div>

              <%# Panel for not accepted %>
              <div data-tabs-target="panel" data-group-panel data-group-id="invitation_not_accepted" class="hidden">
                <div class="mb-4">
                  <h5 class="text-sm font-semibold text-gray-900 mb-3">People/Groups not being invited to audition:</h5>
                  <div class="flex flex-wrap gap-2">
                    <% if not_accepted_group_requestables.any? %>
                      <% not_accepted_group_requestables.each do |requestable| %>
                        <% assignment = email_assignments[[requestable.class.name, requestable.id]] %>
                        <% request = audition_requests.find { |r| r.requestable == requestable } %>
                        <% original_group = request&.status == 'accepted' ? 'invitation_accepted' : 'invitation_not_accepted' %>
                        <div
                          class="inline-flex items-center gap-2 px-2 py-1 rounded text-xs font-medium border border-gray-200 hover:border-pink-400 cursor-pointer transition-all"
                          data-requestable-type="<%= requestable.class.name %>"
                          data-requestable-id="<%= requestable.id %>"
                          data-email-assignment-id="<%= assignment&.id || '' %>"
                          data-original-group="<%= original_group %>"
                          data-action="click->email-groups#showPopup"
                        >
                          <% headshot_url = safe_headshot_url(requestable, variant: :thumb) %>
                          <% if headshot_url %>
                            <%= image_tag headshot_url, alt: requestable.name, class: "w-5 h-5 rounded object-cover flex-shrink-0", draggable: false %>
                          <% elsif requestable.is_a?(Person) %>
                            <div class="w-5 h-5 rounded bg-gray-200 flex items-center justify-center text-black font-bold text-xs flex-shrink-0">
                              <%= requestable.initials %>
                            </div>
                          <% else %>
                            <div class="w-5 h-5 rounded bg-gray-200 flex items-center justify-center text-black font-bold text-xs flex-shrink-0">
                              <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" class="w-3 h-3">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m.94 3.198l.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0112 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 016 18.719m12 0a5.971 5.971 0 00-.941-3.197m0 0A5.995 5.995 0 0012 12.75a5.995 5.995 0 00-5.058 2.772m0 0a3 3 0 00-4.681 2.72 8.986 8.986 0 003.74.477m.94-3.197a5.971 5.971 0 00-.94 3.197M15 6.75a3 3 0 11-6 0 3 3 0 016 0zm6 3a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0zm-13.5 0a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0z" />
                              </svg>
                            </div>
                          <% end %>
                          <%= requestable.name %>
                        </div>
                      <% end %>
                    <% else %>
                      <p class="text-sm text-gray-500 italic">No people or groups in this category yet.</p>
                    <% end %>
                  </div>
                </div>

                  <div>
                    <label class="block text-sm font-semibold text-gray-900 mb-2">Notification Email</label>
                    <textarea
                      data-email-groups-target="emailTemplate"
                      data-group-id="invitation_not_accepted"
                      <% if @invitation_not_accepted_group %>data-email-group-id="<%= @invitation_not_accepted_group.id %>"<% end %>
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500"
                      rows="6"
                    ><% if @invitation_not_accepted_group&.email_template.present? %><%= @invitation_not_accepted_group.email_template %><% else %>Dear [Name],

Thank you so much for your interest in <%= @production.name %>. We truly appreciate you taking the time to apply.

Unfortunately, we won't be able to offer you an audition for this production at this time. We received many qualified applicants and had to make some difficult decisions.

We encourage you to apply for future productions and wish you all the best in your performing arts journey.

Best regards,
The <%= @production.name %> Team<% end %></textarea>
                  </div>

                  <% if not_accepted_group_requestables.any? %>
                    <div class="mt-4 pt-4 border-t border-gray-200">
                      <label class="flex items-center gap-3 cursor-pointer">
                        <input
                          type="checkbox"
                          data-email-groups-target="reviewCheckbox"
                          data-checkbox-group-id="invitation_not_accepted"
                          data-action="change->email-groups#checkAllReviewed"
                          class="rounded accent-pink-500 border-gray-300 text-pink-600 focus:ring-pink-500"
                        >
                        <span class="text-sm text-gray-700">I have reviewed the recipient list and email text for this group</span>
                      </label>
                    </div>
                  <% end %>
                </div>

              <%# Custom email group panels %>
              <% custom_groups.each do |custom_group| %>
                <% group_requestables = requestables_by_group[custom_group.group_id] || [] %>
                <div data-tabs-target="panel" data-group-panel data-group-id="<%= custom_group.group_id %>" class="hidden">
                  <div class="mb-4">
                    <h5 class="text-sm font-semibold text-gray-900 mb-3">People/Groups in this email group:</h5>
                    <div class="flex flex-wrap gap-2">
                      <% if group_requestables.any? %>
                        <% group_requestables.each do |requestable| %>
                          <% assignment = email_assignments[[requestable.class.name, requestable.id]] %>
                          <% request = audition_requests.find { |r| r.requestable == requestable } %>
                          <% original_group = request&.status == 'accepted' ? 'invitation_accepted' : 'invitation_not_accepted' %>
                          <div
                            class="inline-flex items-center gap-2 px-2 py-1 rounded text-xs font-medium border border-gray-200 hover:border-pink-400 cursor-pointer transition-all"
                            data-requestable-type="<%= requestable.class.name %>"
                            data-requestable-id="<%= requestable.id %>"
                            data-email-assignment-id="<%= assignment&.id || '' %>"
                            data-original-group="<%= original_group %>"
                            data-action="click->email-groups#showPopup"
                          >
                            <% headshot_url = safe_headshot_url(requestable, variant: :thumb) %>
                            <% if headshot_url %>
                              <%= image_tag headshot_url, alt: requestable.name, class: "w-5 h-5 rounded object-cover flex-shrink-0", draggable: false %>
                            <% elsif requestable.is_a?(Person) %>
                              <div class="w-5 h-5 rounded bg-gray-200 flex items-center justify-center text-black font-bold text-xs flex-shrink-0">
                                <%= requestable.initials %>
                              </div>
                            <% else %>
                              <div class="w-5 h-5 rounded bg-gray-200 flex items-center justify-center text-black font-bold text-xs flex-shrink-0">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" class="w-3 h-3">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m.94 3.198l.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0112 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 016 18.719m12 0a5.971 5.971 0 00-.941-3.197m0 0A5.995 5.995 0 0012 12.75a5.995 5.995 0 00-5.058 2.772m0 0a3 3 0 00-4.681 2.72 8.986 8.986 0 003.74.477m.94-3.197a5.971 5.971 0 00-.94 3.197M15 6.75a3 3 0 11-6 0 3 3 0 016 0zm6 3a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0zm-13.5 0a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0z" />
                                </svg>
                              </div>
                            <% end %>
                            <span><%= requestable.name %></span>
                          </div>
                        <% end %>
                      <% else %>
                        <p class="text-sm text-gray-500 italic">No people or groups in this category yet. Click on people/groups in other categories to move them here.</p>
                      <% end %>
                    </div>
                  </div>

                  <div>
                    <label class="block text-sm font-semibold text-gray-900 mb-2">Notification Email</label>
                    <textarea
                      data-email-groups-target="emailTemplate"
                      data-group-id="<%= custom_group.group_id %>"
                      data-email-group-id="<%= custom_group.id %>"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500"
                      rows="6"
                      placeholder="Type your custom email message here..."
                    ><%= custom_group.email_template %></textarea>
                  </div>

                  <% if group_people.empty? %>
                    <div class="mt-4 pt-4 border-t border-gray-200">
                      <button
                        type="button"
                        data-action="click->email-groups#deleteGroup"
                        data-group-id="<%= custom_group.id %>"
                        class="bg-pink-600 text-white px-4 py-2 rounded-lg hover:bg-pink-700 transition-colors text-sm font-medium"
                      >
                        Delete this empty email group
                      </button>
                    </div>
                  <% else %>
                    <div class="mt-4 pt-4 border-t border-gray-200">
                      <label class="flex items-center gap-3 cursor-pointer">
                        <input
                          type="checkbox"
                          data-email-groups-target="reviewCheckbox"
                          data-checkbox-group-id="<%= custom_group.group_id %>"
                          data-action="change->email-groups#checkAllReviewed"
                          class="rounded accent-pink-500 border-gray-300 text-pink-600 focus:ring-pink-500"
                        >
                        <span class="text-sm text-gray-700">I have reviewed the recipient list and email text for this group</span>
                      </label>
                    </div>
                  <% end %>
                </div>
              <% end %>
            </div>

            <%# Send notifications section (shown when all groups are reviewed) %>
            <div
              data-email-groups-target="sendSection"
              class="hidden mt-6 p-4 bg-pink-50 border border-pink-200 rounded-lg"
            >
              <h4 class="text-sm font-semibold text-gray-900 mb-2">Ready to Send Notifications and Reveal Decisions</h4>
              <p class="text-sm text-gray-700 mb-4">
                All email groups have been reviewed. Click the button below to send notification emails to all applicants about their audition status.
              </p>
              <%= render "shared/button",
                text: "Send Audition Invitation Notifications",
                variant: "primary",
                size: "medium",
                type: :button,
                data: { action: "click->email-groups#sendNotifications", email_groups_notification_type_value: "invitation" } %>
            </div>
          </div>
        <% end %>

        <% if @audition_cycle.finalize_audition_invitations %>
          </div> <%# Close invitation-editing-area %>
        <% end %>
      </div>
    </div>
    <% end %>

  <% end %>
</div>
