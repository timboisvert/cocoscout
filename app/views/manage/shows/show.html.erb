<% content_for :title, "#{@show.event_type.titleize} Details" %>

<%
  is_past = @show.date_and_time <= Time.current
  is_canceled = @show.canceled
%>

<div class="w-full">
  <%= render partial: "shared/notice", locals: { notice: notice } %>

  <%# Banner for canceled shows %>
  <% if is_canceled %>
    <div class="mb-4 px-4 py-3 bg-red-50 border border-red-200 rounded-lg">
      <div class="flex items-center gap-2 text-red-800">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 flex-shrink-0">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
        </svg>
        <span class="font-medium">This <%= @show.event_type %> has been canceled.</span>
      </div>
    </div>
  <% elsif is_past %>
    <%# Banner for past shows %>
    <div class="mb-4 px-4 py-3 bg-pink-50 border border-pink-200 rounded-lg">
      <div class="flex items-center gap-2 text-pink-800">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 flex-shrink-0">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
        </svg>
        <span class="font-medium">You're viewing a past <%= @show.event_type %> that has already happened.</span>
      </div>
    </div>
  <% end %>

  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [
      ["Shows & Events", manage_shows_path],
      [@production.name, manage_production_shows_path(@production)]
    ],
    text: "#{@show.event_type.titleize}",
    links: []
  } %>

  <%= render "manage/shows/show_info_card", show: @show, compact: false %>

  <div class="space-y-4">

      <% if current_user_can_manage?(@show.production) %>
        <% if @production.type_third_party? && @production.contract.present? %>
          <%# Contract info box for third-party productions %>
          <div class="border border-gray-200 rounded-lg overflow-hidden">
            <%= render "shared/card_header", title: "Contract" %>
            <div class="p-4">
              <div class="mb-3">
                <div class="text-sm font-medium text-gray-900"><%= @production.contract.contractor_name %></div>
                <% if @production.contract.draft_services.any? %>
                  <div class="flex flex-wrap gap-1 mt-2">
                    <% @production.contract.draft_services.each do |service| %>
                      <span class="inline-flex items-center rounded-full bg-green-100 px-2 py-0.5 text-xs font-medium text-green-700">
                        <%= service.is_a?(Hash) ? (service["name"] || service[:name]) : service %>
                      </span>
                    <% end %>
                  </div>
                <% end %>
              </div>
              <div class="flex flex-wrap gap-2 items-center">
                <%= render "shared/button", text: "View Contract", path: manage_contract_path(@production.contract), variant: "primary", size: "small" %>
              </div>
            </div>
          </div>
        <% else %>
          <%# Standard manage show box for in-house productions %>
          <div class="border border-gray-200 rounded-lg overflow-hidden">
            <%= render "shared/card_header", title: "Manage #{sanitize(@show.event_type.titleize)}" %>
            <div class="p-4">
              <%
                # Sanitize event_type to prevent XSS (even though it's from an enum)
                event_label = sanitize(@show.event_type.titleize)
                edit_label = "Edit #{event_label}"
                cancel_label = "Cancel #{event_label}"
                duplicate_label = "Duplicate #{event_label}"
                delete_label = "Delete #{event_label}"
                uncancel_label = "Uncancel #{event_label}"
              %>
              <div class="flex flex-wrap gap-2 items-center">
                <% if is_canceled %>
                  <%= render "shared/button", text: uncancel_label, path: manage_uncancel_show_path(@production, @show), variant: "primary", size: "small", data: {turbo_method: :patch, turbo_confirm: "Are you sure you want to uncancel this #{event_label.downcase}?"} %>
                  <%= render "shared/button", text: delete_label, path: manage_cancel_show_form_path(@production, @show), variant: "primary", size: "small" %>
                <% else %>
                  <%# Always show edit button, even for past events %>
                  <%= render "shared/button", text: edit_label, path: manage_edit_show_path(@production, @show), variant: "primary", size: "small" %>
                  <%= render "shared/button", text: duplicate_label, path: manage_shows_wizard_path(@production, duplicate: @show.id), variant: "primary", size: "small" %>
                  <% unless is_past %>
                    <%= render "shared/button", text: cancel_label, path: manage_cancel_show_form_path(@production, @show), variant: "primary", size: "small" %>
                  <% end %>
                  <%= render "shared/button", text: "Transfer Show", path: manage_transfer_show_select_path(@production, @show), variant: "primary", size: "small" %>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      <% end %>

      <%# Notes Box %>
      <% if @show.notes.present? %>
        <div class="border border-gray-200 rounded-lg overflow-hidden">
          <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
            <h3 class="text-sm font-semibold text-gray-900 flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.86-8.888z" />
              </svg>
              Notes
            </h3>
          </div>
          <div class="p-4">
            <p class="text-sm text-gray-700 whitespace-pre-wrap"><%= @show.notes %></p>
          </div>
        </div>
      <% end %>

      <% if @show.casting_enabled && !@production.type_third_party? %>
        <% if @open_vacancies.any? %>
          <div class="border border-pink-200 rounded-lg overflow-hidden bg-pink-50">
            <div class="bg-pink-100 px-4 py-3 border-b border-pink-200 flex items-center justify-between">
              <h3 class="text-md font-semibold text-pink-900 coustard-regular flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
                </svg>
                Open Vacancies
              </h3>
            </div>
            <div class="p-4 space-y-1">
              <% @open_vacancies.each do |vacancy| %>
                <% vacated_by = vacancy.vacated_by %>
                <% is_linked = @show.linked? %>
                <% affected_shows = is_linked ? vacancy.affected_shows.order(:date_and_time) : [@show] %>
                <div class="group flex items-stretch bg-white border border-pink-200 rounded-lg hover:border-pink-400 transition-colors overflow-hidden">
                  <%# Left half: Show dates %>
                  <div class="w-1/2 px-3 py-2">
                    <% if affected_shows.size > 1 %>
                      <%# Multiple shows stacked vertically %>
                      <div class="space-y-2">
                        <% affected_shows.each do |affected_show| %>
                          <div class="flex items-center gap-4">
                            <div class="flex-shrink-0 w-14 text-center">
                              <div class="text-xs font-semibold text-pink-600 uppercase"><%= affected_show.date_and_time.strftime("%b") %></div>
                              <div class="text-2xl font-bold text-gray-900"><%= affected_show.date_and_time.strftime("%-d") %></div>
                              <div class="text-xs text-gray-500"><%= affected_show.date_and_time.strftime("%a") %></div>
                            </div>
                            <div class="min-w-0">
                              <div class="font-medium text-gray-900">
                                <%= affected_show.display_name %>
                              </div>
                              <div class="text-sm text-gray-600">
                                <%= affected_show.time_range_display %>
                                <% if affected_show.is_online %>
                                  路 Online
                                <% elsif affected_show.location.present? %>
                                  路 <%= affected_show.location.name %>
                                <% end %>
                              </div>
                            </div>
                          </div>
                        <% end %>
                      </div>
                    <% else %>
                      <%# Single show %>
                      <div class="flex items-center gap-4">
                        <div class="flex-shrink-0 w-14 text-center">
                          <div class="text-xs font-semibold text-pink-600 uppercase"><%= @show.date_and_time.strftime("%b") %></div>
                          <div class="text-2xl font-bold text-gray-900"><%= @show.date_and_time.strftime("%-d") %></div>
                          <div class="text-xs text-gray-500"><%= @show.date_and_time.strftime("%a") %></div>
                        </div>
                        <div class="min-w-0">
                          <div class="font-medium text-gray-900">
                            <%= @show.display_name %>
                          </div>
                          <div class="text-sm text-gray-600">
                            <%= @show.time_range_display %>
                            <% if @show.is_online %>
                              路 Online
                            <% elsif @show.location.present? %>
                              路 <%= @show.location.name %>
                            <% end %>
                          </div>
                        </div>
                      </div>
                    <% end %>
                  </div>

                  <%# Right half: Vacated by entity with role %>
                  <div class="w-1/2 border-l border-pink-200 px-3 py-2 flex items-center gap-3">
                    <% if vacated_by %>
                      <% headshot_variant = vacated_by.safe_headshot_variant(:thumb) %>
                      <% if headshot_variant %>
                        <%= image_tag headshot_variant, class: "w-10 h-10 rounded-lg object-cover flex-shrink-0" %>
                      <% else %>
                        <div class="w-10 h-10 rounded-lg bg-gray-200 flex items-center justify-center text-gray-700 font-bold text-sm flex-shrink-0">
                          <%= vacated_by.initials %>
                        </div>
                      <% end %>
                    <% end %>
                    <div class="flex-1 min-w-0">
                      <div class="text-[10px] text-gray-400 uppercase tracking-wide">Can't make it</div>
                      <div class="text-sm flex items-center gap-1">
                        <span class="font-medium text-gray-900"><%= vacated_by&.name %></span>
                        <span class="text-gray-400">as</span>
                        <strong class="text-pink-500"><%= vacancy.role.name %></strong>
                      </div>
                    </div>
                    <div class="flex-shrink-0 hidden group-hover:block">
                      <%= render "shared/button", text: "Review", path: manage_casting_vacancy_path(@production, vacancy), variant: "primary", size: "small" %>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>

        <div class="border border-gray-200 rounded-lg overflow-hidden">
          <%= render "shared/card_header", title: "Casting" do %>
            <%= render "shared/button", text: "Manage Cast", path: manage_casting_show_cast_path(@production, @show), variant: "primary", size: "small" %>
            <% cast_members = @show.people.distinct %>
            <% if cast_members.any? %>
              <% cast_members_json = cast_members.map { |p| { name: p.name, headshot: p.safe_headshot_variant(:thumb) ? url_for(p.safe_headshot_variant(:thumb)) : nil } }.to_json %>
              <div data-controller="compose-message"
                   data-compose-message-recipient-type-value="show_cast"
                   data-compose-message-recipient-id-value="<%= @show.id %>"
                   data-compose-message-recipient-name-value="<%= @show.display_name %> Cast"
                   data-compose-message-cast-members-value="<%= cast_members_json %>">
                <%= render "shared/button", text: "Contact Cast", variant: "primary", size: "small", type: :button, data: { action: "click->compose-message#open" } %>
              </div>
            <% else %>
              <%= render "shared/button", text: "Contact Cast", variant: "secondary", size: "small", type: :button, disabled: true %>
            <% end %>
          <% end %>
          <div class="p-4">
            <%
              cast_count = @show.show_person_role_assignments.size
              percentage = @roles_count > 0 ? (cast_count.to_f / @roles_count * 100).round : 0
              fully_cast = percentage == 100
            %>

            <%# Progress bar %>
            <div class="mb-3">
              <div class="flex items-center justify-between mb-1">
                <span class="text-xs font-semibold text-gray-700">Casting Progress</span>
                <span class="text-xs font-medium <%= fully_cast ? 'text-green-600' : 'text-gray-500' %>">
                  <% if fully_cast %>
                    Fully cast
                  <% else %>
                    <%= cast_count %>/<%= @roles_count %> roles have been cast
                  <% end %>
                </span>
              </div>
              <div class="h-1.5 bg-gray-200 rounded-full overflow-hidden">
                <div class="h-full rounded-full <%= fully_cast ? 'bg-green-500' : 'bg-pink-500' %>" style="width: <%= percentage %>%"></div>
              </div>
            </div>

            <%# Cast member headshots - show all slots for multi-person roles %>
            <% if @roles.any? %>
              <%
                is_linked = @show.linked?
                cancelled_vacancies = @cancelled_vacancies_by_assignment || {}
                open_vacancies_by_role = @open_vacancies_by_role || {}
              %>
              <div class="flex flex-wrap gap-1.5">
                <% @roles.each do |role| %>
                  <%
                    role_quantity = role.quantity || 1
                    role_assignments = @show.show_person_role_assignments.select { |a| a.role_id == role.id }.sort_by { |a| a.position || 0 }
                    role_open_vacancies = (open_vacancies_by_role[role.id] || []).dup
                  %>
                  <% (1..role_quantity).each do |slot_position| %>
                    <% assignment = role_assignments.find { |a| a.position == slot_position } %>
                    <% if assignment %>
                      <%
                        is_guest = assignment.guest?
                        assignable = nil
                        unless is_guest
                          assignable = if assignment.assignable_type == "Person"
                            @people_by_id[assignment.assignable_id] || assignment.assignable
                          else
                            @groups_by_id[assignment.assignable_id] || assignment.assignable
                          end
                          next unless assignable # Skip if assignable was deleted
                        end
                        cant_make_it = !is_guest && cancelled_vacancies[[role.id, assignable.class.name, assignable.id]].present?
                        tooltip_text = is_guest ? "#{assignment.guest_name} - #{role.name}" : "#{assignable.name} - #{role.name}"
                        tooltip_text += " (Can't make it)" if cant_make_it
                      %>
                      <% headshot_variant = assignable&.safe_headshot_variant(:thumb) %>
                      <div class="relative">
                        <% if headshot_variant %>
                          <%= image_tag headshot_variant,
                              alt: assignable.name,
                              class: "w-10 h-10 rounded-md object-cover #{cant_make_it ? 'ring-2 ring-amber-400' : ''}",
                              data: { controller: "tooltip", tooltip_text: tooltip_text } %>
                        <% elsif is_guest %>
                          <div class="w-10 h-10 rounded-md bg-gray-200 text-gray-700 flex items-center justify-center font-bold text-xs"
                               data-controller="tooltip"
                               data-tooltip-text="<%= tooltip_text %>">
                            <%= assignment.display_initials %>
                          </div>
                        <% else %>
                          <div class="w-10 h-10 rounded-md <%= cant_make_it ? 'bg-amber-100 text-amber-700 ring-2 ring-amber-400' : 'bg-gray-200 text-gray-700' %> flex items-center justify-center font-bold text-xs"
                               data-controller="tooltip"
                               data-tooltip-text="<%= tooltip_text %>">
                            <%= assignable.initials %>
                          </div>
                        <% end %>
                        <% if cant_make_it %>
                          <div class="absolute -bottom-0.5 -right-0.5 w-3.5 h-3.5 bg-amber-500 rounded-full flex items-center justify-center" data-controller="tooltip" data-tooltip-text="Can't make it">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="white" class="w-2.5 h-2.5">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
                            </svg>
                          </div>
                        <% end %>
                      </div>
                    <% else %>
                      <%
                        # Check for open vacancy on this slot - take the first available
                        slot_vacancy = role_open_vacancies.shift
                        has_open_vacancy = slot_vacancy.present? && !is_linked
                        vacated_by = slot_vacancy&.vacated_by
                        tooltip_text = if has_open_vacancy && vacated_by
                          "#{role.name} - #{vacated_by.name} can't make it"
                        elsif has_open_vacancy
                          "#{role.name} - Looking for replacement"
                        else
                          "#{role.name} - Not Cast"
                        end
                      %>
                      <%= link_to manage_casting_show_cast_path(@production, @show), class: "block" do %>
                        <div class="w-10 h-10 rounded-md border-2 border-dashed <%= has_open_vacancy ? 'border-amber-400 bg-amber-50' : 'border-gray-300 bg-gray-50' %> flex items-center justify-center <%= has_open_vacancy ? 'text-amber-500' : 'text-gray-400' %> text-xs hover:border-pink-400 hover:bg-pink-50 transition-all"
                             data-controller="tooltip"
                             data-tooltip-text="<%= tooltip_text %>">
                          <% if has_open_vacancy %>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                            </svg>
                          <% else %>
                            +
                          <% end %>
                        </div>
                      <% end %>
                    <% end %>
                  <% end %>
                <% end %>
              </div>

              <%# Show "Can't make it" warning for linked shows %>
              <% if is_linked %>
                <%
                  cant_make_it_list = []
                  @roles.each do |role|
                    assignment = @show.show_person_role_assignments.find { |a| a.role_id == role.id }
                    if assignment && !assignment.guest?
                      assignable = if assignment.assignable_type == "Person"
                        @people_by_id[assignment.assignable_id] || assignment.assignable
                      else
                        @groups_by_id[assignment.assignable_id] || assignment.assignable
                      end
                      next unless assignable
                      vacancy = cancelled_vacancies[[role.id, assignable.class.name, assignable.id]]
                      if vacancy
                        cant_make_it_list << { name: assignable.name, role: role.name, vacancy: vacancy }
                      end
                    end
                  end
                %>
                <% if cant_make_it_list.any? %>
                  <div class="mt-3 px-3 py-2 bg-amber-50 border border-amber-200 rounded-md">
                    <div class="flex items-center gap-1.5 text-amber-700">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 flex-shrink-0">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                      </svg>
                      <span class="text-sm font-medium">Can't make it:</span>
                      <span class="text-sm">
                        <%= cant_make_it_list.map { |item| "#{item[:name]} (#{item[:role]})" }.join(", ") %>
                      </span>
                    </div>
                  </div>
                <% end %>
              <% end %>

              <%# Show "Needs replacement" warning for non-linked shows %>
              <% if !is_linked %>
                <%
                  needs_replacement_list = []
                  open_vacancies_by_role.each do |role_id, vacancies|
                    role = @roles.find { |r| r.id == role_id }
                    next unless role
                    vacancy = vacancies.first
                    vacated_by = vacancy&.vacated_by
                    needs_replacement_list << { name: vacated_by&.name || "Someone", role: role.name }
                  end
                %>
                <% if needs_replacement_list.any? %>
                  <div class="mt-3 px-3 py-2 bg-amber-50 border border-amber-200 rounded-md">
                    <div class="flex items-center gap-1.5 text-amber-700">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 flex-shrink-0">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                      </svg>
                      <span class="text-sm font-medium">Needs replacement:</span>
                      <span class="text-sm">
                        <%= needs_replacement_list.map { |item| "#{item[:name]} can't make it (#{item[:role]})" }.join(", ") %>
                      </span>
                    </div>
                  </div>
                <% end %>
              <% end %>
            <% else %>
              <p class="text-xs text-gray-400 italic">No roles defined yet</p>
            <% end %>
          </div>
        </div>

        <%# Attendees Section - from sign-up registrations %>
        <% if @sign_up_registrations.any? %>
          <%
            # Get sign-up form for linking (use first registration's form)
            first_sign_up_form = @sign_up_registrations.first&.sign_up_form
          %>
          <div class="border border-gray-200 rounded-lg overflow-hidden">
            <%= render "shared/card_header", title: "Attendees" do %>
              <div class="flex items-center gap-2">
                <% if first_sign_up_form %>
                  <%= render "shared/button", text: "View Sign-ups", path: manage_signups_form_path(@production, first_sign_up_form), variant: "secondary", size: "small" %>
                <% end %>
                <%= render "shared/attendance_modal", show: @show, production: @production, variant: "primary" %>
              </div>
            <% end %>
            <div class="p-4">
              <div class="flex flex-wrap gap-1.5">
                <% @sign_up_registrations.each do |registration| %>
                  <%
                    person = registration.person
                    slot = registration.sign_up_slot
                    sign_up_form = registration.sign_up_form
                    tooltip_text = registration_slot_tooltip(registration)
                    display_name = person&.name || registration.guest_name || "Guest"
                  %>
                  <% if person %>
                    <% headshot_variant = person.safe_headshot_variant(:thumb) %>
                    <% if headshot_variant %>
                      <% if sign_up_form %>
                        <%= link_to manage_signups_form_path(@production, sign_up_form) do %>
                          <%= image_tag headshot_variant,
                              alt: display_name,
                              class: "w-10 h-10 rounded-md object-cover hover:ring-2 hover:ring-pink-300 transition-all",
                              data: { controller: "tooltip", tooltip_text: tooltip_text } %>
                        <% end %>
                      <% else %>
                        <%= image_tag headshot_variant,
                            alt: display_name,
                            class: "w-10 h-10 rounded-md object-cover",
                            data: { controller: "tooltip", tooltip_text: tooltip_text } %>
                      <% end %>
                    <% else %>
                      <% if sign_up_form %>
                        <%= link_to manage_signups_form_path(@production, sign_up_form) do %>
                          <div class="w-10 h-10 rounded-md bg-gray-100 text-gray-700 hover:ring-2 hover:ring-pink-300 transition-all flex items-center justify-center font-bold text-xs"
                               data-controller="tooltip"
                               data-tooltip-text="<%= tooltip_text %>">
                            <%= person.initials %>
                          </div>
                        <% end %>
                      <% else %>
                        <div class="w-10 h-10 rounded-md bg-gray-100 text-gray-700 flex items-center justify-center font-bold text-xs"
                             data-controller="tooltip"
                             data-tooltip-text="<%= tooltip_text %>">
                          <%= person.initials %>
                        </div>
                      <% end %>
                    <% end %>
                  <% else %>
                    <% if sign_up_form %>
                      <%= link_to manage_signups_form_path(@production, sign_up_form) do %>
                        <div class="w-10 h-10 rounded-md bg-gray-100 text-gray-700 hover:ring-2 hover:ring-pink-300 transition-all flex items-center justify-center font-bold text-xs"
                             data-controller="tooltip"
                             data-tooltip-text="<%= tooltip_text %>">
                          <%= registration.display_initials %>
                        </div>
                      <% end %>
                    <% else %>
                      <div class="w-10 h-10 rounded-md bg-gray-100 text-gray-700 flex items-center justify-center font-bold text-xs"
                           data-controller="tooltip"
                           data-tooltip-text="<%= tooltip_text %>">
                        <%= registration.display_initials %>
                      </div>
                    <% end %>
                  <% end %>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>

        <%# Vacancy History - show all vacancies including resolved ones %>
        <% if @all_vacancies.any? %>
          <div class="border border-gray-200 rounded-lg overflow-hidden">
            <%= render "shared/card_header", title: "Vacancy History" %>
            <div class="divide-y divide-gray-200">
              <% @all_vacancies.each do |vacancy| %>
                <% vacated_by = vacancy.vacated_by %>
                <%= link_to manage_casting_vacancy_path(@production, vacancy), class: "flex items-center justify-between px-4 py-3 hover:bg-gray-50 transition-colors group" do %>
                  <div class="flex items-center gap-3">
                    <% if vacated_by %>
                      <% headshot = vacated_by.safe_headshot_variant(:thumb) %>
                      <% if headshot %>
                        <%= image_tag headshot, class: "w-8 h-8 rounded-lg object-cover" %>
                      <% else %>
                        <div class="w-8 h-8 rounded-lg bg-gray-200 flex items-center justify-center text-gray-700 font-bold text-xs">
                          <%= vacated_by.initials %>
                        </div>
                      <% end %>
                    <% else %>
                      <div class="w-8 h-8 rounded-lg bg-gray-200 flex items-center justify-center text-gray-400">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" />
                        </svg>
                      </div>
                    <% end %>
                    <div>
                      <div class="text-sm font-medium text-gray-900">
                        <%= vacated_by&.name || "Unknown" %>
                        <span class="text-gray-400">as</span>
                        <span class="text-pink-600"><%= vacancy.role.name %></span>
                      </div>
                      <div class="text-xs text-gray-500">
                        Created <%= time_ago_in_words(vacancy.created_at) %> ago
                      </div>
                    </div>
                  </div>
                  <div class="flex items-center gap-2">
                    <% status_classes = case vacancy.status
                      when "open" then "bg-amber-100 text-amber-700"
                      when "finding_replacement" then "bg-blue-100 text-blue-700"
                      when "not_filling" then "bg-gray-100 text-gray-700"
                      when "filled" then "bg-green-100 text-green-700"
                      when "cancelled" then "bg-purple-100 text-purple-700"
                      else "bg-gray-100 text-gray-700"
                    end %>
                    <% status_text = case vacancy.status
                      when "open" then "Open"
                      when "finding_replacement" then "Finding Replacement"
                      when "not_filling" then "Not Filling"
                      when "filled" then "Filled"
                      when "cancelled" then "Reclaimed"
                      else vacancy.status.titleize
                    end %>
                    <span class="inline-flex items-center rounded-md px-2 py-1 text-xs font-medium <%= status_classes %>">
                      <%= status_text %>
                    </span>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 text-gray-400 group-hover:text-pink-500">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
                    </svg>
                  </div>
                <% end %>
              <% end %>
            </div>
          </div>
        <% end %>
      <% end %>

      <% if @show.is_online && !@show.canceled %>
        <!-- Online Event Card -->
        <div class="border border-gray-200 rounded-lg overflow-hidden">
          <%= render "shared/card_header", title: "Online Event" %>
          <div class="p-4">
            <% if @show.online_location_info.present? %>
              <div class="text-sm text-gray-700">
                <% if @show.online_location_info.start_with?('http://', 'https://') %>
                  <a href="<%= @show.online_location_info %>" target="_blank" rel="noopener noreferrer" class="text-pink-500 underline hover:text-pink-600">
                    <%= @show.online_location_info %>
                  </a>
                <% else %>
                  <%= @show.online_location_info %>
                <% end %>
              </div>
            <% else %>
              <p class="text-sm text-gray-500">No additional details provided for this online event.</p>
            <% end %>
          </div>
        </div>
      <% elsif @show.location.present? && !@show.canceled %>
        <!-- In-Person Location Card -->
        <div class="border border-gray-200 rounded-lg overflow-hidden">
          <%= render "shared/card_header", title: @show.location.name %>
          <div class="p-4 flex flex-col lg:flex-row gap-4">
            <% loc = @show.location %>
            <% if loc.present? %>
              <% address = [loc.address1, loc.address2, loc.city, loc.state, loc.postal_code].compact.reject(&:blank?).join(', ') %>

              <!-- Left: Location Info -->
              <div class="lg:w-1/3 space-y-3">
                <div>
                  <% if loc.address1.present? %>
                    <div class="text-sm text-gray-900"><%= loc.address1 %></div>
                  <% end %>
                  <% if loc.address2.present? %>
                    <div class="text-sm text-gray-900"><%= loc.address2 %></div>
                  <% end %>
                  <% if loc.city.present? || loc.state.present? || loc.postal_code.present? %>
                    <div class="text-sm text-gray-900">
                      <%= loc.city %><% if loc.city.present? && loc.state.present? %>,<% end %> <%= loc.state %> <%= loc.postal_code %>
                    </div>
                  <% end %>
                </div>

                <% if loc.notes.present? %>
                  <div class="pt-2 border-t border-gray-200">
                    <div class="text-xs font-semibold text-gray-700 mb-1">Notes</div>
                    <div class="text-sm text-gray-600"><%= simple_format(loc.notes, class: "whitespace-pre-wrap") %></div>
                  </div>
                <% end %>

                <div class="flex gap-2 pt-2">
                  <a href="http://maps.apple.com/?address=<%= URI.encode_www_form_component(address) %>" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-1 px-3 py-1.5 text-xs font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" />
                    </svg>
                    Open in Maps
                  </a>
                  <a href="https://www.google.com/maps/search/?api=1&query=<%= URI.encode_www_form_component(address) %>" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-1 px-3 py-1.5 text-xs font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" />
                    </svg>
                    Google Maps
                  </a>
                </div>
              </div>

              <!-- Right: Map -->
              <div class="lg:w-2/3">
                <div class="w-full h-[400px] lg:h-full min-h-[300px]">
                  <iframe
                    width="100%"
                    height="100%"
                    style="border:0; border-radius: 0.5rem;"
                    loading="lazy"
                    allowfullscreen
                    referrerpolicy="no-referrer-when-downgrade"
                    src="https://www.google.com/maps?q=<%= URI.encode_www_form_component(address) %>&output=embed">
                  </iframe>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <% if @show.show_links.any? %>
        <!-- Show Links Card -->
        <div class="border border-gray-200 rounded-lg overflow-hidden">
          <%= render "shared/card_header", title: "Links" do %>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-gray-600 flex-shrink-0">
              <path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.757-1.757m13.35-.622 1.757-1.757a4.5 4.5 0 0 0-6.364-6.364l-4.5 4.5a4.5 4.5 0 0 0 1.242 7.244" />
            </svg>
          <% end %>
          <div class="p-4">
            <div class="flex flex-wrap gap-2">
              <% @show.show_links.each do |link| %>
                <%= link_to link.url, target: "_blank", rel: "noopener noreferrer", class: "inline-flex items-center gap-1 px-3 py-1.5 text-xs font-medium text-pink-700 bg-pink-50 rounded-md hover:bg-pink-100 transition-colors" do %>
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.757-1.757m13.35-.622 1.757-1.757a4.5 4.5 0 0 0-6.364-6.364l-4.5 4.5a4.5 4.5 0 0 0 1.242 7.244" />
                  </svg>
                  <%= link.display_text %>
                <% end %>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>

    </div>
  </div>

</div>

<%# Turbo frame for recurring series modal %>
<%= turbo_frame_tag "recurring_series_modal" %>

<%# Compose message modal for contacting cast %>
<%= render "shared/compose_message_modal" %>
