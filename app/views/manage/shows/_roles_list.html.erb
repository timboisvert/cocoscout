<div id="show-roles" data-controller="drop-role" data-show-id="<%= @show.id %>">

  <%
    assignment_count = show.show_person_role_assignments.count
    role_count = show.production.roles.count
    full = assignment_count == role_count
  %>

  <div class="mb-4 p-4 rounded-lg <%= full ? 'bg-pink-50' : 'bg-yellow-50' %>">
    <span class="font-semibold text-black">
      <% if full %>
        ðŸŽ‰ This show is fully cast
      <% else %>
        <%= assignment_count %> of <%= role_count %> roles have been cast
      <% end %>
    </span>
  </div>

  <div class="space-y-2">

    <% show.production.roles.each do |role| %>

      <%
        has_assignment = false
        assignments = show.show_person_role_assignments.where(role: role)
        if assignments.any?
          has_assignment = true
        end
      %>

      <div class="p-4 bg-white border border-gray-200 rounded-lg hover:border-gray-400 transition-all"
          data-drop-role-target="role"
          data-role-id="<%= role.id %>"
          data-action="drop->drop-role#assign dragover->drop-role#allowDrop dragleave->drop-role#dragLeave">

        <% if has_assignment %>
          <div class="flex items-center gap-4">
            <div class="font-bold text-md flex-shrink-0">
              <%= role.name %>
            </div>

            <div class="space-y-2 flex-1">
              <% assignments.each do |assignment| %>

                <div class="flex items-center gap-3 p-2 border border-gray-200 rounded-lg hover:border-gray-400 transition-all bg-white group relative cursor-grab active:cursor-grabbing"
                    draggable="true"
                    data-action="dragstart->drop-role#dragStartAssignment dragend->drop-role#dragEnd"
                    data-person-id="<%= assignment.person.id %>"
                    data-assignment-id="<%= assignment.id %>"
                    data-source-role-id="<%= role.id %>">
                  <% headshot_variant = assignment.person.safe_headshot_variant(:thumb) %>
                  <% if headshot_variant %>
                    <%= image_tag headshot_variant, alt: assignment.person.name, class: "w-10 h-10 rounded-lg object-cover flex-shrink-0", draggable: false %>
                  <% else %>
                    <div class="w-10 h-10 rounded-lg bg-gray-100 flex items-center justify-center text-black font-bold text-xs flex-shrink-0">
                      <%= assignment.person.initials %>
                    </div>
                  <% end %>

                  <span class="font-medium text-sm flex-1 truncate"><%= assignment.person.name %></span>
                  <button type="button"
                    class="text-pink-500 hover:bg-pink-100 rounded px-2 py-1 text-xs font-bold transition-all border border-pink-200 opacity-0 group-hover:opacity-100 cursor-pointer"
                    data-action="click->drop-role#removeAssignment"
                    data-assignment-id="<%= assignment.id %>"
                    data-person-id="<%= assignment.person.id %>"
                    title="Remove assignment"
                  >
                    Remove
                  </button>
                </div>

              <% end %>
            </div>
          </div>
        <% else %>
          <div class="flex items-center gap-4">
            <div class="font-bold text-md flex-shrink-0">
              <%= role.name %>
            </div>

            <div class="flex-1 flex items-center justify-center p-3 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 text-sm min-h-12">
              <span>Drag a cast member here to assign this role</span>
            </div>
          </div>
        <% end %>

      </div>
    <% end %>
  </div>

</div>