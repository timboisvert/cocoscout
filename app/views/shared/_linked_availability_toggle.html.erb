<%#
  Linked Availability Display - Toggle with Expansion
  
  Single availability row for the group with Available/Unavailable buttons.
  Clicking sets all member shows at once. Expandable to see all events.
  No individual event availability - it's all or nothing.
  
  Required params:
    - event_linkage: EventLinkage object
    - entity: Person or Group to show availability for
    - entity_key: String key for entity (e.g., "person" or "group_123")
    - availabilities: Hash of { show_id => ShowAvailability }
  
  Optional params:
    - show_production: Show production name (default: false)
    - show_location: Show location (default: true)
%>

<%
  show_production = local_assigns.fetch(:show_production, false)
  show_location = local_assigns.fetch(:show_location, true)
  
  # Get all shows sorted by date (no more sibling/child distinction)
  all_shows = event_linkage.shows.respond_to?(:order) ? event_linkage.shows.order(:date_and_time).to_a : event_linkage.shows.sort_by(&:date_and_time)
  
  # Use resolved_primary_show (explicitly set primary, or first by date as fallback)
  primary_show = event_linkage.resolved_primary_show
  last_show = all_shows.last
  
  # Determine if we span multiple months
  spans_months = primary_show && last_show && primary_show.date_and_time.month != last_show.date_and_time.month
  
  # Primary show name (secondary_name or event type as fallback)
  primary_name = primary_show&.secondary_name.presence || primary_show&.event_type&.titleize
  
  # Location from primary show
  location_name = primary_show&.location&.name
  
  # Determine overall status (all same = that status, mixed = unset display)
  statuses = all_shows.map { |s| availabilities[s.id]&.status || 'unset' }
  all_same = statuses.uniq.size == 1
  overall_status = all_same ? statuses.first : 'mixed'
  current_status = overall_status
%>

<div data-controller="linked-availability" 
     data-linked-availability-entity-key-value="<%= entity_key %>"
     data-linked-availability-show-ids-value="<%= all_shows.map(&:id).to_json %>"
     data-linked-availability-status-value="<%= overall_status %>"
     class="border border-gray-200 rounded-lg overflow-hidden hover:border-gray-400 transition-all bg-white">
  
  <div class="flex items-stretch px-3 py-2">
    <%# Left Section: Date Box(es) + Event Info %>
    <div class="w-1/2 flex items-center gap-4">
      <%# Date Box(es) - show_row style %>
      <% if spans_months %>
        <%# Two date boxes for different months %>
        <div class="flex items-center gap-1">
          <div class="flex-shrink-0 w-12 text-center">
            <div class="text-xs font-semibold text-pink-600 uppercase"><%= primary_show.date_and_time.strftime("%b") %></div>
            <div class="text-xl font-bold text-gray-900"><%= primary_show.date_and_time.strftime("%-d") %></div>
          </div>
          <span class="text-gray-400 text-sm">–</span>
          <div class="flex-shrink-0 w-12 text-center">
            <div class="text-xs font-semibold text-pink-600 uppercase"><%= last_show.date_and_time.strftime("%b") %></div>
            <div class="text-xl font-bold text-gray-900"><%= last_show.date_and_time.strftime("%-d") %></div>
          </div>
        </div>
      <% elsif primary_show.date_and_time.to_date == last_show.date_and_time.to_date %>
        <%# Single day - one date box %>
        <div class="flex-shrink-0 w-14 text-center">
          <div class="text-xs font-semibold text-pink-600 uppercase"><%= primary_show.date_and_time.strftime("%b") %></div>
          <div class="text-2xl font-bold text-gray-900"><%= primary_show.date_and_time.strftime("%-d") %></div>
          <div class="text-xs text-gray-500"><%= primary_show.date_and_time.strftime("%a") %></div>
        </div>
      <% else %>
        <%# Same month, different days - combined date box %>
        <div class="flex-shrink-0 w-14 text-center">
          <div class="text-xs font-semibold text-pink-600 uppercase"><%= primary_show.date_and_time.strftime("%b") %></div>
          <div class="text-xl font-bold text-gray-900"><%= primary_show.date_and_time.strftime("%-d") %>-<%= last_show.date_and_time.strftime("%-d") %></div>
        </div>
      <% end %>
      
      <%# Event Info - styled like show_row %>
      <div class="flex-1 min-w-0">
        <div class="flex items-center gap-2 flex-wrap">
          <svg class="w-4 h-4 text-pink-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
          </svg>
          <span class="font-medium text-gray-900"><%= primary_name %></span>
          <% if show_production && primary_show&.respond_to?(:production) && primary_show&.production %>
            <span class="text-sm text-gray-600"><%= primary_show.production.name %></span>
          <% end %>
        </div>
        <div class="text-sm text-gray-600">
          <%= all_shows.count %> linked events
          <% if show_location && location_name.present? %>
            · <%= location_name %>
          <% end %>
        </div>
      </div>
    </div>
    
    <%# Right Section: Availability Buttons - matching show_row style %>
    <div class="w-1/2 border-l border-gray-200 pl-4 flex items-center gap-3">
      <% headshot_variant = entity.safe_headshot_variant(:thumb) %>
      <% if headshot_variant %>
        <%= image_tag headshot_variant, class: "w-10 h-10 rounded-lg object-cover flex-shrink-0" %>
      <% else %>
        <div class="w-10 h-10 rounded-lg bg-gray-200 flex items-center justify-center text-gray-700 font-bold text-sm flex-shrink-0">
          <%= entity.respond_to?(:initials) ? entity.initials : entity.name[0..1].upcase %>
        </div>
      <% end %>
      <div class="flex-1 min-w-0">
        <div class="text-[10px] text-gray-400 uppercase tracking-wide mb-1">Availability</div>
        <div class="flex gap-0">
          <%
            [:available, :unavailable].each do |status|
              classes = "w-8 sm:w-20 text-xs py-1 sm:py-1.5 text-center border border-gray-200 cursor-pointer flex items-center justify-center"

              if status == :available
                classes += " rounded-l border-r-0"
              elsif status == :unavailable
                classes += " rounded-r"
              end

              if current_status == status.to_s
                classes += " bg-pink-500 text-white"
              else
                classes += " bg-white text-gray-700 hover:bg-gray-50"
              end
          %>
            <%= link_to "#", class: classes, data: { action: "click->linked-availability#setStatus", status: status } do %>
              <span class="sm:hidden">
                <% if status == :available %>
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6.633 10.25c.806 0 1.533-.446 2.031-1.08a9.041 9.041 0 0 1 2.861-2.4c.723-.384 1.35-.956 1.653-1.715a4.498 4.498 0 0 0 .322-1.672V2.75a.75.75 0 0 1 .75-.75 2.25 2.25 0 0 1 2.25 2.25c0 1.152-.26 2.243-.723 3.218-.266.558.107 1.282.725 1.282m0 0h3.126c1.026 0 1.945.694 2.054 1.715.045.422.068.85.068 1.285a11.95 11.95 0 0 1-2.649 7.521c-.388.482-.987.729-1.605.729H13.48c-.483 0-.964-.078-1.423-.23l-3.114-1.04a4.501 4.501 0 0 0-1.423-.23H5.904m10.598-9.75H14.25M5.904 18.5c.083.205.173.405.27.602.197.4-.078.898-.523.898h-.908c-.889 0-1.713-.518-1.972-1.368a12 12 0 0 1-.521-3.507c0-1.553.295-3.036.831-4.398C3.387 9.953 4.167 9.5 5 9.5h1.053c.472 0 .745.556.5.96a8.958 8.958 0 0 0-1.302 4.665c0 1.194.232 2.333.654 3.375Z"/></svg>
                <% else %>
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7.498 15.25H4.372c-1.026 0-1.945-.694-2.054-1.715a12.137 12.137 0 0 1-.068-1.285c0-2.848.992-5.464 2.649-7.521C5.287 4.247 5.886 4 6.504 4h4.016a4.5 4.5 0 0 1 1.423.23l3.114 1.04a4.5 4.5 0 0 0 1.423.23h1.294M7.498 15.25c.618 0 .991.724.725 1.282A7.471 7.471 0 0 0 7.5 19.75 2.25 2.25 0 0 0 9.75 22a.75.75 0 0 0 .75-.75v-.633c0-.573.11-1.14.322-1.672.304-.76.93-1.33 1.653-1.715a9.04 9.04 0 0 0 2.86-2.4c.498-.634 1.226-1.08 2.032-1.08h.384m-10.253 1.5H9.7m8.075-9.75c.01.05.027.1.05.148.593 1.2.925 2.55.925 3.977 0 1.487-.36 2.89-.999 4.125m.023-8.25c-.076-.365.183-.75.575-.75h.908c.889 0 1.713.518 1.972 1.368.339 1.11.521 2.287.521 3.507 0 1.553-.295 3.036-.831 4.398-.306.774-1.086 1.227-1.918 1.227h-1.053c-.472 0-.745-.556-.5-.96a8.95 8.95 0 0 0 .303-.54"/></svg>
                <% end %>
              </span>
              <span class="hidden sm:inline"><%= status.to_s.humanize %></span>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
  
  <%# Expandable Details - all events in date order %>
  <div data-controller="accordion" data-accordion-expanded-value="false">
    <button type="button" 
            data-action="accordion#toggle"
            class="w-full flex items-center justify-center gap-1 py-1.5 bg-gray-50 border-t border-gray-100 text-xs text-gray-500 hover:bg-gray-100 transition cursor-pointer">
      <span>View all <%= all_shows.count %> events</span>
      <svg data-accordion-target="icon" class="w-3 h-3 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
      </svg>
    </button>
    
    <div data-accordion-target="content" class="hidden border-t border-gray-200">
      <% all_shows.each do |show| %>
        <% event_name = show.secondary_name.presence || show.event_type.titleize %>
        <div class="flex items-center px-3 py-2 border-b border-gray-100 last:border-b-0">
          <%# Date Box %>
          <div class="flex-shrink-0 w-14 text-center">
            <div class="text-xs font-semibold text-pink-600 uppercase"><%= show.date_and_time.strftime("%b") %></div>
            <div class="text-2xl font-bold text-gray-900"><%= show.date_and_time.strftime("%-d") %></div>
            <div class="text-xs text-gray-500"><%= show.date_and_time.strftime("%a") %></div>
          </div>
          
          <%# Show Details %>
          <div class="flex-1 ml-4">
            <div class="font-medium text-gray-900"><%= event_name %></div>
            <div class="text-sm text-gray-600">
              <%= show.date_and_time.strftime("%-I:%M %p") %>
              <% if show.secondary_name.present? %>
                <span class="mx-1">·</span>
                <span class="text-gray-400"><%= show.event_type.titleize %></span>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>
