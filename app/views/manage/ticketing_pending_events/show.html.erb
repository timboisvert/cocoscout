<%= render partial: "shared/top_menu", locals: {
  breadcrumbs: [
    ["Ticketing", manage_ticketing_index_path],
    ["Pending Events", manage_ticketing_pending_events_path]
  ],
  text: "Link Ticketing Event"
} %>

<div class="max-w-3xl mx-auto px-4 py-6">
  <% if flash[:alert] %>
    <div class="mb-4 bg-red-50 border border-red-200 rounded-lg p-4 text-red-700">
      <%= flash[:alert] %>
    </div>
  <% end %>
  <% if flash[:notice] %>
    <div class="mb-4 bg-green-50 border border-green-200 rounded-lg p-4 text-green-700">
      <%= flash[:notice] %>
    </div>
  <% end %>
  <!-- Event Details -->
  <div class="bg-white border border-gray-200 rounded-lg p-6 mb-6">
    <div class="flex items-start justify-between mb-4">
      <div>
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-700 mb-2">
          <%= @pending_event.ticketing_provider.provider_display_name %>
        </span>
        <h2 class="text-xl font-bold text-gray-900"><%= @pending_event.provider_event_name %></h2>
      </div>
      <%= button_to manage_dismiss_ticketing_pending_event_path(@pending_event),
                   method: :post,
                   class: "text-sm text-gray-500 hover:text-red-600",
                   data: { turbo_confirm: "Dismiss this event? It won't be synced." } do %>
        Dismiss Event
      <% end %>
    </div>

    <div class="grid grid-cols-2 gap-4 text-sm">
      <div>
        <span class="text-gray-500">Platform:</span>
        <span class="font-medium text-gray-900 ml-1"><%= @pending_event.ticketing_provider.name %></span>
      </div>
      <div>
        <span class="text-gray-500">Occurrences:</span>
        <span class="font-medium text-gray-900 ml-1"><%= @pending_event.occurrence_count %></span>
      </div>
      <% if @pending_event.first_occurrence_at %>
        <div>
          <span class="text-gray-500">First Date:</span>
          <span class="font-medium text-gray-900 ml-1"><%= @pending_event.first_occurrence_at.strftime("%b %-d, %Y") %></span>
        </div>
      <% end %>
      <% if @pending_event.last_occurrence_at %>
        <div>
          <span class="text-gray-500">Last Date:</span>
          <span class="font-medium text-gray-900 ml-1"><%= @pending_event.last_occurrence_at.strftime("%b %-d, %Y") %></span>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Production Selection -->
  <div class="bg-white border border-gray-200 rounded-lg p-6">
    <h3 class="text-lg font-medium text-gray-900 mb-2">Select a Production</h3>
    <p class="text-sm text-gray-500 mb-4">Choose which CocoScout production this ticketing event belongs to.</p>

    <% if @productions.any? %>
      <div class="space-y-2">
        <% @production_scores.each do |item| %>
          <% production = item[:production] %>
          <% score = item[:score] %>
          <% is_suggested = @pending_event.suggested_production_id == production.id %>

          <%= form_with url: manage_link_ticketing_pending_event_path(@pending_event), method: :post, class: "w-full", data: { turbo: false } do |f| %>
            <%= f.hidden_field :production_id, value: production.id %>
            <button type="submit" class="w-full text-left p-4 border rounded-lg transition-colors cursor-pointer <%= is_suggested ? 'border-pink-300 bg-pink-50 hover:border-pink-400' : 'border-gray-200 hover:border-gray-300 bg-white' %>">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                  <% logo_variant = production.safe_logo_variant(:small) %>
                  <% if logo_variant %>
                    <div class="w-12 h-12 rounded-lg overflow-hidden flex-shrink-0">
                      <%= image_tag logo_variant, alt: production.name, class: "w-full h-full object-cover" %>
                    </div>
                  <% else %>
                    <div class="w-12 h-12 rounded-lg bg-pink-100 flex items-center justify-center flex-shrink-0">
                      <span class="text-sm font-bold text-pink-600"><%= production.initials %></span>
                    </div>
                  <% end %>

                  <div>
                    <div class="font-medium text-gray-900">
                      <%= production.name %>
                      <% if is_suggested %>
                        <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-pink-100 text-pink-700">
                          Suggested
                        </span>
                      <% end %>
                    </div>
                    <div class="text-sm text-gray-500">
                      <%= pluralize(production.shows.count, "show") %>
                      <% if production.shows.any? %>
                        Â· <%= production.shows.minimum(:date_and_time)&.strftime("%b %Y") %> - <%= production.shows.maximum(:date_and_time)&.strftime("%b %Y") %>
                      <% end %>
                    </div>
                  </div>
                </div>

                <div class="flex items-center gap-3">
                  <% if score > 0 %>
                    <div class="text-right">
                      <div class="text-xs text-gray-400">Match</div>
                      <div class="text-sm font-medium <%= score >= 0.8 ? 'text-green-600' : score >= 0.5 ? 'text-amber-600' : 'text-gray-500' %>">
                        <%= (score * 100).round %>%
                      </div>
                    </div>
                  <% end %>
                  <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                  </svg>
                </div>
              </div>
            </button>
          <% end %>
        <% end %>
      </div>
    <% else %>
      <div class="text-center py-8 text-gray-500">
        <p>No productions found.</p>
        <p class="text-sm mt-1">Create a production first, then come back to link this event.</p>
        <%= link_to manage_productions_wizard_path, class: "inline-block mt-4" do %>
          <%= render "shared/button", text: "Create Production", variant: "primary", size: "medium" %>
        <% end %>
      </div>
    <% end %>
  </div>

  <!-- Info Box -->
  <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
    <div class="flex">
      <svg class="w-5 h-5 text-blue-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <div class="ml-3 text-sm text-blue-700">
        <p class="font-medium">What happens when you link?</p>
        <p class="mt-1">After linking, we'll automatically match the ticketing event's occurrences with your production's shows by date and time. You can review and adjust the matches before syncing ticket sales.</p>
      </div>
    </div>
  </div>
</div>
