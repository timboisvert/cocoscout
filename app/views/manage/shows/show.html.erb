<% content_for :title, "#{@show.event_type.titleize} Details" %>

<div class="w-full">
  <%= render partial: "shared/notice", locals: { notice: notice } %>
  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [
      ["Shows & Events", manage_production_shows_path(@production) ]
    ],
    text: "#{@show.event_type.titleize}",
    links: []
  } %>

  <%= render "manage/shows/show_info_card", show: @show, compact: false %>

  <div class="space-y-4">

      <% if current_user_can_manage?(@show.production) %>
        <div class="border border-gray-200 rounded-lg overflow-hidden">
          <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 flex items-center justify-between">
            <h3 class="text-md font-semibold text-gray-900 coustard-regular">Manage <%= @show.event_type.titleize %></h3>
          </div>
          <div class="p-4">
            <%
              event_label = @show.event_type.titleize
              edit_label = "Edit #{event_label}"
              cancel_label = "Cancel #{event_label}"
              duplicate_label = "Duplicate #{event_label}"
              delete_label = "Delete #{event_label}"
              uncancel_label = "Uncancel #{event_label}"
              is_past = @show.date_and_time <= Time.current
            %>
            <% if is_past %>
              <%= link_to duplicate_label, new_manage_production_show_path(@production, duplicate: @show.id), class: "text-xs text-pink-500 underline" %>
              <%= link_to delete_label, cancel_manage_production_show_path(@production, @show), class: "ml-1 text-xs text-pink-500 underline" %>
            <% elsif @show.canceled %>
              <%= link_to uncancel_label, uncancel_manage_production_show_path(@production, @show), data: {turbo_method: :patch, turbo_confirm: "Are you sure you want to uncancel this #{event_label.downcase}?"}, class: "text-xs text-pink-500 underline" %>
              <%= link_to delete_label, cancel_manage_production_show_path(@production, @show), class: "ml-1 text-xs text-pink-500 underline" %>
            <% else %>
              <%= link_to edit_label, edit_manage_production_show_path(@production, @show), class: "text-xs text-pink-500 underline" %>
              <%= link_to duplicate_label, new_manage_production_show_path(@production, duplicate: @show.id), class: "ml-1 text-xs text-pink-500 underline" %>
              <%= link_to cancel_label, cancel_manage_production_show_path(@production, @show), class: "ml-1 text-xs text-pink-500 underline" %>
            <% end %>
          </div>
        </div>
      <% end %>

      <% if @show.casting_enabled %>
        <%= render "manage/casting/cast_card", show: @show, production: @production, title: "Cast", roles: @roles, roles_count: @roles_count, people_by_id: @people_by_id, groups_by_id: @groups_by_id %>
      <% end %>

      <% if @show.is_online && !@show.canceled %>
        <!-- Online Event Card -->
        <div class="border border-gray-200 rounded-lg overflow-hidden">
          <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 flex items-center">
            <!-- Globe icon for online -->
            <svg class="w-5 h-5 text-gray-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 21a9.004 9.004 0 0 0 8.716-6.747M12 21a9.004 9.004 0 0 1-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 0 1 7.843 4.582M12 3a8.997 8.997 0 0 0-7.843 4.582m15.686 0A11.953 11.953 0 0 1 12 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0 1 21 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0 1 12 16.5c-3.162 0-6.133-.815-8.716-2.247m0 0A9.015 9.015 0 0 1 3 12c0-1.605.42-3.113 1.157-4.418" />
            </svg>
            <h3 class="ml-2 text-sm font-semibold text-gray-900">Online Event</h3>
          </div>
          <div class="p-4">
            <% if @show.online_location_info.present? %>
              <div class="text-sm text-gray-700">
                <% if @show.online_location_info.start_with?('http://', 'https://') %>
                  <a href="<%= @show.online_location_info %>" target="_blank" rel="noopener noreferrer" class="text-pink-500 underline hover:text-pink-600">
                    <%= @show.online_location_info %>
                  </a>
                <% else %>
                  <%= @show.online_location_info %>
                <% end %>
              </div>
            <% else %>
              <p class="text-sm text-gray-500">No additional details provided for this online event.</p>
            <% end %>
          </div>
        </div>
      <% elsif @show.location.present? && !@show.canceled %>
        <!-- In-Person Location Card -->
        <div class="border border-gray-200 rounded-lg overflow-hidden">
          <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 flex items-left">
            <svg class="w-5 h-5 text-gray-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" /></svg>
            <h3 class="ml-1 text-sm font-semibold text-gray-900"><%= @show.location.name %></h3>
          </div>
          <div class="p-4 flex flex-col lg:flex-row gap-4">
            <% loc = @show.location %>
            <% if loc.present? %>
              <% address = [loc.address1, loc.address2, loc.city, loc.state, loc.postal_code].compact.reject(&:blank?).join(', ') %>

              <!-- Left: Location Info -->
              <div class="lg:w-1/3 space-y-3">
                <div>
                  <% if loc.address1.present? %>
                    <div class="text-sm text-gray-900"><%= loc.address1 %></div>
                  <% end %>
                  <% if loc.address2.present? %>
                    <div class="text-sm text-gray-900"><%= loc.address2 %></div>
                  <% end %>
                  <% if loc.city.present? || loc.state.present? || loc.postal_code.present? %>
                    <div class="text-sm text-gray-900">
                      <%= loc.city %><% if loc.city.present? && loc.state.present? %>,<% end %> <%= loc.state %> <%= loc.postal_code %>
                    </div>
                  <% end %>
                </div>

                <% if loc.notes.present? %>
                  <div class="pt-2 border-t border-gray-200">
                    <div class="text-xs font-semibold text-gray-700 mb-1">Notes</div>
                    <div class="text-sm text-gray-600"><%= simple_format(loc.notes, class: "whitespace-pre-wrap") %></div>
                  </div>
                <% end %>

                <div class="flex gap-2 pt-2">
                  <a href="http://maps.apple.com/?address=<%= URI.encode_www_form_component(address) %>" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-1 px-3 py-1.5 text-xs font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" />
                    </svg>
                    Open in Maps
                  </a>
                  <a href="https://www.google.com/maps/search/?api=1&query=<%= URI.encode_www_form_component(address) %>" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-1 px-3 py-1.5 text-xs font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" />
                    </svg>
                    Google Maps
                  </a>
                </div>
              </div>

              <!-- Right: Map -->
              <div class="lg:w-2/3">
                <div class="w-full h-[400px] lg:h-full min-h-[300px]">
                  <iframe
                    width="100%"
                    height="100%"
                    style="border:0; border-radius: 0.5rem;"
                    loading="lazy"
                    allowfullscreen
                    referrerpolicy="no-referrer-when-downgrade"
                    src="https://www.google.com/maps?q=<%= URI.encode_www_form_component(address) %>&output=embed">
                  </iframe>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

    </div>
  </div>

</div>
