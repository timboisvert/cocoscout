<% content_for :title, "Availability for #{@production.name}" %>

<style>
  .column-hover {
    background-color: rgb(243 244 246) !important; /* bg-gray-100 */
  }
</style>

<%= render partial: "shared/notice", locals: { notice: notice } %>

<%= render partial: "shared/top_menu", locals: {
  breadcrumbs: [],
  text: "Availability",
  links: [
    { text: "Request Availability", path: manage_production_questionnaires_path(@production) }
  ]
} %>

<% if @cast_members.empty? %>
  <div class="w-full">
    <div class="text-gray-500 text-sm mt-4">
      No cast members found. Add people to casts to see their availability.
    </div>
  </div>
<% elsif @shows.empty? %>
  <div class="w-full">
    <div class="text-gray-500 text-sm mt-4">
      No shows scheduled yet. Create shows to track availability.
    </div>
  </div>
<% else %>
  <div class="mt-4 overflow-auto border border-gray-200 rounded-lg max-h-[calc(100vh-200px)] relative z-0" data-controller="availability-grid">
    <table class="border-collapse" style="table-layout: fixed; min-width: max-content;">
      <colgroup>
        <col class="w-[180px] sm:w-[250px]">
        <% @shows.each do |show| %>
          <col class="w-[100px] sm:w-[150px]">
        <% end %>
      </colgroup>
      <thead class="sticky top-0 z-30">
        <tr>
          <th class="sticky left-0 bg-white z-20 border-b-2 border-r-2 border-gray-300 px-3 sm:px-4 py-3 text-left shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]">
            <div class="font-semibold text-sm">Cast Member</div>
            </th>
            <% @shows.each_with_index do |show, col_index| %>
              <th class="border-b-2 border-gray-300 px-2 py-2 sm:py-3 text-center bg-white cursor-pointer hover:bg-gray-50 align-top" data-col="<%= col_index %>">
                <%= link_to manage_production_availability_path(@production, show), class: "block no-underline" do %>
                  <div class="text-[10px] sm:text-xs font-medium text-pink-600 uppercase tracking-wide">
                    <%= show.date_and_time.strftime("%a, %b %-d") %>
                  </div>
                  <div class="text-xs sm:text-sm font-semibold text-gray-900 mt-0.5">
                    <%= show.date_and_time.strftime("%-I:%M %p") %>
                  </div>
                  <% if show.secondary_name.present? %>
                    <div class="hidden sm:block text-xs text-gray-500 truncate mt-0.5 max-w-[130px] mx-auto" title="<%= show.secondary_name %>">
                      <%= show.secondary_name %>
                    </div>
                  <% end %>
                <% end %>
              </th>
            <% end %>
          </tr>
        </thead>
        <tbody>
          <% @cast_members.each do |member| %>
            <tr class="border-b border-gray-200 group" data-availability-grid-target="row">
              <td class="sticky left-0 bg-white group-hover:bg-gray-100 z-10 border-r-2 border-gray-200 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)] p-0">
                <%
                  link_path = if member.is_a?(Person)
                    manage_person_path(member, tab: 1)
                  else
                    manage_group_path(member, tab: 1)
                  end
                %>
                <%= link_to link_path, class: "block px-3 sm:px-4 py-2 sm:py-3 w-full h-full" do %>
                  <div class="flex items-center space-x-2 sm:space-x-3">
                    <% headshot_variant = member.safe_headshot_variant(:thumb) %>
                    <% if headshot_variant %>
                      <%= image_tag headshot_variant, alt: member.name, class: "w-8 h-8 sm:w-10 sm:h-10 rounded-lg object-cover flex-shrink-0" %>
                    <% else %>
                      <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-lg bg-gray-200 flex items-center justify-center text-gray-600 font-semibold text-xs sm:text-sm flex-shrink-0">
                        <%= member.initials %>
                      </div>
                    <% end %>
                    <div class="min-w-0">
                      <div class="font-medium text-xs sm:text-sm text-gray-900 truncate">
                        <%= member.name %>
                      </div>
                    </div>
                  </div>
                <% end %>
              </td>
              <% @shows.each_with_index do |show, col_index| %>
                <%
                  availability_key = "#{member.class.name}_#{member.id}"
                  availability = @availabilities[availability_key][show.id]
                %>
                <td class="px-2 sm:px-4 py-2 sm:py-3 text-center bg-white group-hover:bg-gray-100"
                    data-col="<%= col_index %>"
                    data-availability-grid-target="cell"
                    data-action="mouseenter->availability-grid#highlightColumn mouseleave->availability-grid#unhighlightColumn">
                  <%= link_to manage_production_availability_path(@production, show), class: "block no-underline text-gray-900 hover:text-gray-900" do %>
                    <% if availability %>
                      <% if availability.available? %>
                        <span class="text-xs sm:text-sm font-medium text-pink-500">
                          <span class="hidden sm:inline">Available</span>
                          <span class="sm:hidden">✓</span>
                        </span>
                      <% elsif availability.unavailable? %>
                        <span class="text-xs sm:text-sm font-medium text-gray-900">
                          <span class="hidden sm:inline">Unavailable</span>
                          <span class="sm:hidden">✗</span>
                        </span>
                      <% else %>
                        <span class="text-gray-400 text-xs sm:text-sm">-</span>
                      <% end %>
                    <% else %>
                      <span class="text-gray-400 text-xs sm:text-sm">-</span>
                    <% end %>
                  <% end %>
                </td>
              <% end %>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
<% end %>
