<% content_for :title, @production.name %>

<%
  # Check if current user has assignments for this show
  my_assignments = @show_person_role_assignments.select do |a|
    (a.assignable_type == "Person" && a.assignable_id == @person.id) ||
    (a.assignable_type == "Group" && @groups.map(&:id).include?(a.assignable_id))
  end
  can_show_cant_make_it = my_assignments.any? && !@show.canceled && @show.date_and_time > Time.current
%>

<div class="w-full">

  <%= render partial: "shared/notice", locals: { notice: notice } %>

  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [
      ["My Shows & Events", my_shows_path]
    ],
    text: @show.event_type.titleize,
    links: []
  } %>

  <!-- Information Card -->
  <div class="border border-gray-200 rounded-lg overflow-hidden bg-white mb-6">
    <div class="flex flex-col sm:flex-row">
      <!-- Poster Section (only for shows) -->
      <% if @show.event_type == "show" %>
        <div class="flex-shrink-0 sm:w-48 bg-gray-50 flex items-center justify-center p-4">
          <% poster_url = safe_poster_url(@show) %>
          <% if poster_url && !@show.canceled %>
            <%= image_tag poster_url, alt: "Show/Event Poster", class: "rounded shadow-sm w-full max-w-[180px] border border-gray-200" %>
          <% else %>
            <div class="w-full max-w-[180px] aspect-[2/3] rounded bg-gray-200 flex items-center justify-center border border-gray-300">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16 text-gray-400">
                <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm10.5-11.25h.008v.008h-.008V8.25Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
              </svg>
            </div>
          <% end %>
        </div>
      <% end %>

      <!-- Details Section -->
      <div class="flex-1 p-6">
        <div class="space-y-4">
          <!-- Title and Badges -->
          <div>
            <h2 class="text-2xl font-bold text-gray-900 mb-2">
              <%= @show.date_and_time.strftime("%A, %B %-d, %Y") %>
            </h2>
            <div class="flex items-center gap-2 flex-wrap">
              <% if @show.canceled %>
                <span class="inline-flex items-center rounded-md bg-red-50 px-2 py-1 text-xs font-medium text-red-700 ring-1 ring-inset ring-red-600/10">Canceled</span>
              <% end %>
              <% if @show.recurring? %>
                <span data-controller="tooltip" data-tooltip-text="This is a recurring event" class="inline-flex items-center rounded-md bg-purple-50 px-2 py-1 text-xs font-medium text-purple-700 ring-1 ring-inset ring-purple-600/10">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3 mr-1">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
                  </svg>
                  Recurring
                </span>
              <% end %>
              <span class="inline-flex items-center rounded-md px-2 py-1 text-xs font-medium ring-1 ring-inset <%= event_type_badge_classes(@show.event_type) %>">
                <%= @show.event_type.titleize %>
              </span>
            </div>
          </div>

          <!-- Show Details -->
          <div class="space-y-2 text-sm">
            <div class="flex items-start gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-gray-400 flex-shrink-0 mt-0.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
              </svg>
              <span class="text-gray-900 font-medium"><%= @show.date_and_time.strftime("%l:%M %p") %></span>
            </div>

            <div class="flex items-start gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-gray-400 flex-shrink-0 mt-0.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 21h16.5M4.5 3h15M5.25 3v18m13.5-18v18M9 6.75h1.5m-1.5 3h1.5m-1.5 3h1.5m3-6H15m-1.5 3H15m-1.5 3H15M9 21v-3.375c0-.621.504-1.125 1.125-1.125h3.75c.621 0 1.125.504 1.125 1.125V21" />
              </svg>
              <span class="text-gray-900 font-medium"><%= @production.name %></span>
            </div>

            <% if @show.secondary_name.present? %>
              <div class="flex items-start gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-gray-400 flex-shrink-0 mt-0.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 3.75V16.5L12 14.25 7.5 16.5V3.75m9 0H18A2.25 2.25 0 0 1 20.25 6v12A2.25 2.25 0 0 1 18 20.25H6A2.25 2.25 0 0 1 3.75 18V6A2.25 2.25 0 0 1 6 3.75h1.5m9 0h-9" />
                </svg>
                <span class="text-gray-900 font-medium"><%= @show.secondary_name %></span>
              </div>
            <% end %>
          </div>

          <!-- Show Links -->
          <% if @show.show_links.any? %>
            <div class="pt-2 border-t border-gray-200">
              <div class="text-xs font-semibold text-gray-700 mb-2">Links</div>
              <div class="flex flex-wrap gap-2">
                <% @show.show_links.each do |link| %>
                  <%= link_to link.url, target: "_blank", rel: "noopener noreferrer", class: "inline-flex items-center gap-1 px-3 py-1.5 text-xs font-medium text-pink-700 bg-pink-50 rounded-md hover:bg-pink-100 transition-colors" do %>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.757-1.757m13.35-.622 1.757-1.757a4.5 4.5 0 0 0-6.364-6.364l-4.5 4.5a4.5 4.5 0 0 0 1.242 7.244" />
                    </svg>
                    <%= link.display_text %>
                  <% end %>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Linked Events Indicator (compact, at bottom of hero) -->
    <% if @show.linked? %>
      <% other_linked_shows = @show.event_linkage.shows.where.not(id: @show.id).order(:date_and_time) %>
      <% if other_linked_shows.any? %>
        <div class="border-t border-gray-200 bg-gray-50" data-controller="disclosure">
          <button type="button"
                  data-action="click->disclosure#toggle"
                  class="w-full px-4 py-2 flex items-center justify-between text-sm text-gray-600 hover:text-gray-900 hover:bg-gray-100 transition-colors cursor-pointer">
            <span class="flex items-center gap-2">
              <svg class="w-4 h-4 text-pink-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
              </svg>
              <span>Linked with <%= other_linked_shows.count %> other <%= "event".pluralize(other_linked_shows.count) %></span>
            </span>
            <svg data-disclosure-target="icon" class="w-4 h-4 text-gray-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>
          <div data-disclosure-target="content" class="hidden border-t border-gray-200 divide-y divide-gray-100 bg-white">
            <% other_linked_shows.each do |linked_show| %>
              <% event_name = linked_show.secondary_name.presence || linked_show.event_type.titleize %>
              <%= link_to my_show_path(linked_show), class: "flex items-center gap-3 px-4 py-2.5 hover:bg-gray-50 transition-colors" do %>
                <div class="flex-shrink-0 w-10 text-center">
                  <div class="text-[10px] font-semibold text-pink-600 uppercase leading-tight"><%= linked_show.date_and_time.strftime("%b") %></div>
                  <div class="text-lg font-bold text-gray-900 leading-tight"><%= linked_show.date_and_time.strftime("%-d") %></div>
                </div>
                <div class="flex-1 min-w-0">
                  <div class="text-sm font-medium text-gray-900 truncate"><%= event_name %></div>
                  <div class="text-xs text-gray-500"><%= linked_show.date_and_time.strftime("%-I:%M %p") %></div>
                </div>
                <svg class="w-4 h-4 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              <% end %>
            <% end %>
          </div>
        </div>
      <% end %>
    <% end %>
  </div>

  <div class="space-y-4">

    <!-- Cast Section - 50/50 layout when both exist -->
    <% if @show.casting_enabled %>
      <div class="flex flex-col lg:flex-row gap-4">
        <!-- My Cast Assignment (left side) -->
        <% if my_assignments.any? %>
          <div class="lg:w-1/2 border border-gray-200 rounded-lg overflow-hidden">
            <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
              <h3 class="text-md font-semibold text-gray-900 coustard-regular">My Cast Assignment</h3>
            </div>
            <div class="p-4">
              <div class="space-y-3">
                <% my_assignments.each do |assignment| %>
                  <div class="flex items-center gap-3 <%= 'pb-3 border-b border-gray-200' if my_assignments.size > 1 && assignment != my_assignments.last %>">
                    <% if assignment.assignable_type == "Group" %>
                      <% headshot_variant = assignment.assignable.safe_headshot_variant(:thumb) %>
                      <% if headshot_variant %>
                        <%= image_tag headshot_variant, class: "w-10 h-10 rounded-lg object-cover flex-shrink-0" %>
                      <% else %>
                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-pink-400 to-purple-500 flex items-center justify-center text-white font-bold text-sm flex-shrink-0">
                          <%= assignment.assignable.initials %>
                        </div>
                      <% end %>
                    <% else %>
                      <% headshot_variant = assignment.assignable.safe_headshot_variant(:thumb) %>
                      <% if headshot_variant %>
                        <%= image_tag headshot_variant, class: "w-10 h-10 rounded-lg object-cover flex-shrink-0" %>
                      <% else %>
                        <div class="w-10 h-10 rounded-lg bg-gray-100 flex items-center justify-center text-gray-600 font-bold text-sm flex-shrink-0">
                          <%= assignment.assignable.initials %>
                        </div>
                      <% end %>
                    <% end %>
                    <div class="flex-1">
                      <div class="text-sm">
                        <span class="text-gray-700"><%= assignment.assignable.name %></span>
                        <span class="text-gray-400">as</span>
                        <strong class="text-pink-500"><%= assignment.role.name %></strong>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
              <% if can_show_cant_make_it %>
                <div class="mt-4 pt-3 border-t border-gray-200">
                  <%= render "shared/button", text: "Can't make it?", path: vacancy_link_for(@person, @show), variant: "secondary", size: "small" %>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>

        <!-- Full Cast (right side) -->
        <div class="<%= my_assignments.any? ? 'lg:w-1/2' : 'w-full' %> border border-gray-200 rounded-lg overflow-hidden">
          <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 flex items-center justify-between">
            <h3 class="text-md font-semibold text-gray-900 coustard-regular">Full Cast</h3>
          </div>
          <div class="p-1 py-2 sm:p-4 sm:py-4">
            <% if @show_person_role_assignments.any? %>
              <div class="flex flex-wrap gap-2">
                <% @show_person_role_assignments.each do |assignment| %>
                  <% if assignment.assignable_type == "Person" %>
                    <%= link_to public_profile_path(assignment.assignable.public_key), class: "flex flex-col items-center w-[100px] hover:opacity-80 transition-opacity" do %>
                      <% headshot_variant = assignment.assignable.safe_headshot_variant(:thumb) %>
                      <% if headshot_variant %>
                        <%= image_tag headshot_variant, alt: assignment.assignable.name, class: "w-20 h-20 rounded-lg object-cover border border-gray-200 #{'ring-2 ring-pink-500' if assignment.assignable == Current.user.person}", draggable: false %>
                      <% else %>
                        <div class="w-20 h-20 rounded-lg bg-gray-100 flex items-center justify-center text-gray-600 font-bold text-lg border border-gray-200 #{'ring-2 ring-pink-500' if assignment.assignable == Current.user.person}">
                          <%= assignment.assignable.initials %>
                        </div>
                      <% end %>
                      <div class="text-xs text-center mt-2 font-medium truncate w-full <%= 'text-pink-500' if assignment.assignable == Current.user.person %>"><%= assignment.assignable.name %></div>
                      <div class="text-xs text-center text-gray-500 truncate w-full"><%= assignment.role&.name %></div>
                    <% end %>
                  <% elsif assignment.assignable_type == "Group" %>
                    <% is_my_group = @groups.include?(assignment.assignable) %>
                    <%= link_to public_profile_path(assignment.assignable.public_key), class: "flex flex-col items-center w-[100px] hover:opacity-80 transition-opacity" do %>
                      <% if assignment.assignable.headshot&.attached? %>
                        <%= image_tag assignment.assignable.headshot.variant(:thumb), alt: assignment.assignable.name, class: "w-20 h-20 rounded-lg object-cover border border-gray-200 #{'ring-2 ring-pink-500' if is_my_group}", draggable: false %>
                      <% else %>
                        <div class="w-20 h-20 rounded-lg bg-gradient-to-br from-pink-400 to-purple-500 flex items-center justify-center text-white font-bold text-lg border border-gray-200 #{'ring-2 ring-pink-500' if is_my_group}">
                          <%= assignment.assignable.initials %>
                        </div>
                      <% end %>
                      <div class="text-xs text-center mt-2 font-medium truncate w-full <%= 'text-pink-500' if is_my_group %>"><%= assignment.assignable.name %></div>
                      <div class="text-xs text-center text-gray-500 truncate w-full"><%= assignment.role&.name %></div>
                    <% end %>
                  <% end %>
                <% end %>
              </div>
            <% else %>
              <div class="text-sm text-gray-500">No cast members assigned yet</div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>

    <!-- Location -->
    <% if @show.is_online %>
      <!-- Online Event Card -->
      <div class="border border-gray-200 rounded-lg overflow-hidden">
        <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 flex items-center">
          <!-- Globe icon for online -->
          <svg class="w-5 h-5 text-gray-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 21a9.004 9.004 0 0 0 8.716-6.747M12 21a9.004 9.004 0 0 1-8.716-6.747M12 21c2.485 0 4.5-4.03 4.5-9S14.485 3 12 3m0 18c-2.485 0-4.5-4.03-4.5-9S9.515 3 12 3m0 0a8.997 8.997 0 0 1 7.843 4.582M12 3a8.997 8.997 0 0 0-7.843 4.582m15.686 0A11.953 11.953 0 0 1 12 10.5c-2.998 0-5.74-1.1-7.843-2.918m15.686 0A8.959 8.959 0 0 1 21 12c0 .778-.099 1.533-.284 2.253m0 0A17.919 17.919 0 0 1 12 16.5c-3.162 0-6.133-.815-8.716-2.247m0 0A9.015 9.015 0 0 1 3 12c0-1.605.42-3.113 1.157-4.418" />
          </svg>
          <h3 class="ml-2 text-sm font-semibold text-gray-900">Online Event</h3>
        </div>
        <div class="p-4">
          <% if @show.online_location_info.present? %>
            <div class="text-sm text-gray-700">
              <% if @show.online_location_info.start_with?('http://', 'https://') %>
                <a href="<%= @show.online_location_info %>" target="_blank" rel="noopener noreferrer" class="text-pink-500 underline hover:text-pink-600">
                  <%= @show.online_location_info %>
                </a>
              <% else %>
                <%= @show.online_location_info %>
              <% end %>
            </div>
          <% else %>
            <p class="text-sm text-gray-500">No additional details provided for this online event.</p>
          <% end %>
        </div>
      </div>
    <% elsif @show.location.present? %>
      <div class="border border-gray-200 rounded-lg overflow-hidden">
        <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 flex items-left">
          <svg class="w-5 h-5 text-gray-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" /></svg>
          <h3 class="ml-1 text-sm font-semibold text-gray-900"><%= @show.location.name %></h3>
        </div>
        <div class="p-4 flex flex-col lg:flex-row gap-4">
          <% loc = @show.location %>
          <% if loc.present? %>
            <% address = [loc.address1, loc.address2, loc.city, loc.state, loc.postal_code].compact.reject(&:blank?).join(', ') %>

            <!-- Left: Location Info -->
            <div class="lg:w-1/3 space-y-3">
              <div>
                <% if loc.address1.present? %>
                  <div class="text-sm text-gray-900"><%= loc.address1 %></div>
                <% end %>
                <% if loc.address2.present? %>
                  <div class="text-sm text-gray-900"><%= loc.address2 %></div>
                <% end %>
                <% if loc.city.present? || loc.state.present? || loc.postal_code.present? %>
                  <div class="text-sm text-gray-900">
                    <%= loc.city %><% if loc.city.present? && loc.state.present? %>,<% end %> <%= loc.state %> <%= loc.postal_code %>
                  </div>
                <% end %>
              </div>

              <% if loc.notes.present? %>
                <div class="pt-2 border-t border-gray-200">
                  <div class="text-xs font-semibold text-gray-700 mb-1">Notes</div>
                  <div class="text-sm text-gray-600"><%= simple_format(loc.notes, class: "whitespace-pre-wrap") %></div>
                </div>
              <% end %>

              <div class="flex gap-2 pt-2">
                <a href="http://maps.apple.com/?address=<%= URI.encode_www_form_component(address) %>" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-1 px-3 py-1.5 text-xs font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 transition-colors">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" />
                  </svg>
                  Open in Maps
                </a>
                <a href="https://www.google.com/maps/search/?api=1&query=<%= URI.encode_www_form_component(address) %>" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-1 px-3 py-1.5 text-xs font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 transition-colors">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" />
                  </svg>
                  Google Maps
                </a>
              </div>
            </div>

            <!-- Right: Map -->
            <div class="lg:w-2/3">
              <div class="w-full h-[400px] lg:h-full min-h-[300px]">
                <iframe
                  width="100%"
                  height="100%"
                  style="border:0; border-radius: 0.5rem;"
                  loading="lazy"
                  allowfullscreen
                  referrerpolicy="no-referrer-when-downgrade"
                  src="https://www.google.com/maps?q=<%= URI.encode_www_form_component(address) %>&output=embed">
                </iframe>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

  </div>

</div>