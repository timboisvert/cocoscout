<% content_for :title, "Show: #{@show.date_and_time.strftime("%A, %B %-d, %Y")}" %>

<div class="w-full pb-10">
  <%= render partial: "shared/notice", locals: { notice: notice } %>
  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [
      ["Casting & Roles", manage_production_casting_path(@production)],
      [@show.date_and_time.strftime("%A, %b %d, %Y"), manage_production_show_path(@production, @show)]
    ],
    text: @show.casting_finalized? ? "Finalized Cast" : "Edit Cast",
    links: []
  } %>

  <%= render "manage/shows/show_info_card", show: @show %>

  <% if @show.casting_finalized? %>
    <%# ===== FINALIZED STATE ===== %>
    <%= render "manage/casting/finalized_cast", show: @show, production: @production, roles: @roles, assignments_by_role_id: @assignments_by_role_id, people_by_id: @people_by_id, groups_by_id: @groups_by_id %>
  <% else %>
    <%# ===== EDITING STATE ===== %>
    <%= render "shared/help_section",
      title: "How to assign talent pool members to roles",
      initial_state: "closed",
      storage_key: "casting_help_collapsed",
      steps: [
        { text: "<strong>Drag to assign:</strong> Drag a talent pool member from the right panel onto a role box on the left." },
        { text: "<strong>Swap roles:</strong> Drag a person from one role to another to swap their assignments." },
        { text: "<strong>Remove assignment:</strong> Hover over an assigned person and click the Ã— button to remove them." },
        { text: "<strong>Filter by availability:</strong> Use the \"Available\" button to see only people who've marked themselves available for this show." }
      ] %>

    <%
      # Count roles that have at least one assignment
      roles_with_assignments = @assignments_by_role_id.keys.count
      role_count = @roles_count
      percentage = role_count > 0 ? (roles_with_assignments.to_f / role_count * 100).round : 0
      fully_cast = percentage == 100

      # Linkage sync status
      is_linked = @show.linked?
      sync_info = @linkage_sync_info
      all_in_sync = sync_info.present? ? sync_info[:all_in_sync] : true
      can_finalize = fully_cast && (!is_linked || all_in_sync)
    %>

    <% if role_count > 0 %>
      <div id="casting-progress-bar" class="bg-white border border-gray-200 rounded-lg overflow-hidden mb-6">
        <div class="p-4">
          <div class="flex items-center justify-between mb-3">
            <span id="progress-label" class="text-sm font-semibold text-gray-900">
              <% if fully_cast %>
                This show is 100% cast
              <% else %>
                <%= roles_with_assignments %> of <%= role_count %> roles have been cast
              <% end %>
            </span>
            <span id="progress-fraction" class="text-sm font-bold <%= fully_cast ? 'text-green-600' : 'text-pink-600' %>">
              <%= roles_with_assignments %>/<%= role_count %> roles cast
            </span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div id="progress-bar" class="<%= fully_cast ? 'bg-green-500' : 'bg-pink-500' %> h-2 rounded-full transition-all" style="width: <%= percentage %>%"></div>
          </div>
        </div>

        <%# Linkage sync section - always shown for linked shows %>
        <% if is_linked && sync_info.present? %>
          <%= render "manage/casting/linkage_sync_section",
              show: @show,
              linked_shows: @linked_shows,
              sync_info: sync_info,
              production: @production,
              fully_cast: fully_cast %>
        <% end %>

        <%# Finalize section - shown when fully cast AND (not linked OR in sync) %>
        <div id="finalize-section-wrapper" class="<%= can_finalize ? '' : 'hidden' %>">
          <%= render "manage/casting/finalize_section",
              show: @show,
              production: @production,
              linked_shows: is_linked ? @linked_shows : [],
              cast_email_draft: @cast_email_draft,
              removed_email_draft: @removed_email_draft %>
        </div>
      </div>
    <% end %>

    <div class="flex gap-8">

      <!-- Roles on the left - equal width -->
      <div class="w-1/2">
        <%= render partial: "manage/casting/roles_list", locals: {
          show: @show,
          roles: @roles,
          assignments_by_role_id: @assignments_by_role_id,
          people_by_id: @people_by_id,
          groups_by_id: @groups_by_id,
          sync_info: @linkage_sync_info
        } %>
      </div>

      <!-- Cast Members on the right - equal width and sticky -->
      <div class="w-1/2 lg:sticky lg:top-4 lg:h-fit">
        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
          <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 flex items-center justify-between">
            <h2 class="text-sm font-semibold text-gray-900">Talent Pool</h2>
          </div>
          <%
            is_linked = @show.linked?
            linked_count = is_linked ? @linked_shows.count : 0
          %>
          <div class="p-4 border-b border-gray-200" data-controller="cast-filter" data-cast-filter-is-linked-value="<%= is_linked %>" data-cast-filter-linked-count-value="<%= linked_count %>">
            <!-- Availability Filter -->
            <% if is_linked && linked_count > 0 %>
              <%# Linked shows: Show Fully Available / Partially Available / All filters %>
              <%= render "shared/filters/filter_bar", bare: true, filter_groups: [
                {
                  filters: [
                    {
                      text: "Fully Available",
                      path: "#",
                      active: true,
                      data: {
                        action: "cast-filter#filterByAvailability",
                        value: "fully-available"
                      }
                    },
                    {
                      text: "Partially Available",
                      path: "#",
                      active: false,
                      data: {
                        action: "cast-filter#filterByAvailability",
                        value: "partially-available"
                      }
                    },
                    {
                      text: "All Talent Pool Members",
                      path: "#",
                      active: false,
                      data: {
                        action: "cast-filter#filterByAvailability",
                        value: "all"
                      }
                    }
                  ]
                }
              ] %>
            <% else %>
              <%# Non-linked shows: Show Available / All filters %>
              <%= render "shared/filters/filter_bar", bare: true, filter_groups: [
                {
                  filters: [
                    {
                      text: "Available",
                      path: "#",
                      active: true,
                      data: {
                        action: "cast-filter#filterByAvailability",
                        value: "available"
                      }
                    },
                    {
                      text: "All Talent Pool Members",
                      path: "#",
                      active: false,
                      data: {
                        action: "cast-filter#filterByAvailability",
                        value: "all"
                      }
                    }
                  ]
                }
              ] %>
            <% end %>
          </div>
          <div class="p-4 max-h-[calc(100vh-200px)] overflow-y-auto" data-cast-filter-target="list">
            <%= render partial: "manage/casting/cast_members_list", locals: {
              show: @show,
              availability: @availability,
              pool_members: @pool_members,
              assigned_member_keys: @assigned_member_keys,
              linked_availability: @linked_availability || {},
              linked_shows: @linked_shows || []
            } %>
          </div>
        </div>
      </div>

    </div>
  <% end %>

</div>
