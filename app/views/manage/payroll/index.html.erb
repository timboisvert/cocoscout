<% content_for :title, "Payroll" %>

<div class="w-full mb-10">
  <%= render partial: "shared/notice", locals: { notice: notice, alert: alert } %>

  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [
      ["Money", manage_money_index_path],
      ["Payouts", manage_money_payouts_path]
    ],
    text: "Payroll"
  } %>

  <% if @schedule %>
    <%# 60/40 Layout for configured payroll %>
    <div class="flex flex-col lg:flex-row gap-6">
      <%# Left side - 60% - Current Period Preview %>
      <div class="lg:w-3/5">
        <%# Current Pay Period Preview %>
        <div class="bg-white rounded-lg border border-gray-200 mb-6">
          <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex items-center justify-between">
              <div>
                <div class="flex items-center gap-2">
                  <h3 class="font-semibold text-gray-900">Next Payroll Run</h3>
                  <%= render "shared/badge", text: "Preview", color: "gray" %>
                </div>
                <p class="text-sm text-gray-500">
                  <%= @current_period[:start].strftime("%B %-d") %> â€” <%= @current_period[:end].strftime("%B %-d, %Y") %>
                  <span class="text-gray-400">â€¢</span>
                  Payday: <%= @current_period[:payday].strftime("%A, %B %-d") %>
                </p>
              </div>
              <%= render "shared/badge", text: @schedule.period_type_label, color: "pink" %>
            </div>
          </div>

          <% if @preview_items.any? %>
            <div class="divide-y divide-gray-100">
              <% @preview_items.sort_by { |person, data| person.name.downcase }.each do |person, data| %>
                <div class="px-6 py-3 flex items-center justify-between hover:bg-gray-50">
                  <div class="flex items-center gap-3">
                    <% headshot_variant = person.safe_headshot_variant(:thumb) %>
                    <% if headshot_variant %>
                      <%= image_tag headshot_variant, alt: person.name, class: "w-8 h-8 rounded-lg object-cover" %>
                    <% else %>
                      <div class="w-8 h-8 rounded-lg bg-gray-200 flex items-center justify-center text-gray-600 text-sm font-medium">
                        <%= person.initials %>
                      </div>
                    <% end %>
                    <div>
                      <div class="font-medium text-gray-900"><%= person.name %></div>
                      <div class="text-sm text-gray-500">
                        <%= pluralize(data[:show_count], 'event') %>
                        <% if data[:prior_period_count] && data[:prior_period_count] > 0 %>
                          <span class="text-pink-600">(incl. <%= data[:prior_period_count] %> from prior periods)</span>
                        <% end %>
                        <% if data[:productions].size > 1 %>
                          across <%= data[:productions].size %> productions
                        <% end %>
                      </div>
                    </div>
                  </div>
                  <div class="text-right">
                    <div class="font-semibold text-gray-900"><%= number_to_currency(data[:net]) %></div>
                    <% if data[:deductions] && data[:deductions] > 0 %>
                      <div class="text-xs text-gray-500">
                        <%= number_to_currency(data[:gross]) %> âˆ’ <%= number_to_currency(data[:deductions]) %> advances
                      </div>
                    <% end %>
                  </div>
                </div>
              <% end %>
            </div>

            <% prior_total = @preview_items.sum { |_, d| d[:prior_period_count] || 0 } %>
            <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 rounded-b-lg">
              <div class="flex items-center justify-between">
                <div class="text-gray-600">
                  <span class="font-semibold text-gray-900"><%= @preview_items.count %></span> people
                  <span class="text-gray-400 mx-2">â€¢</span>
                  Total: <span class="font-semibold text-gray-900"><%= number_to_currency(@preview_items.sum { |_, d| d[:net] }) %></span>
                  <% if prior_total > 0 %>
                    <span class="text-gray-400 mx-2">â€¢</span>
                    <span class="text-pink-600"><%= prior_total %> unpaid from prior periods</span>
                  <% end %>
                </div>
              </div>
            </div>
          <% else %>
            <div class="px-6 py-8 text-center text-gray-500">
              <div class="text-3xl mb-2">ðŸ“…</div>
              <p class="font-medium text-gray-700">No events in this pay period</p>
              <p class="text-sm mt-1">Events from <%= @current_period[:start].strftime("%b %-d") %> â€“ <%= @current_period[:end].strftime("%b %-d") %> will appear here.</p>
              <% if @unpaid_amount > 0 %>
                <p class="text-sm mt-3 text-pink-600">
                  Note: You have <%= number_to_currency(@unpaid_amount) %> in unpaid payouts from other periods.
                </p>
              <% end %>
            </div>
          <% end %>
        </div>

        <%# Active Runs (pending or processing) %>
        <% if @pending_runs.any? %>
          <div class="bg-white rounded-lg border border-gray-200 mb-6">
            <div class="px-6 py-4 border-b border-gray-200">
              <h3 class="font-semibold text-gray-900">Active Payroll Runs</h3>
            </div>
            <div class="divide-y divide-gray-100">
              <% @pending_runs.each do |run| %>
                <div class="px-6 py-4 flex items-center justify-between hover:bg-gray-50">
                  <div>
                    <div class="font-medium text-gray-900">
                      <%= run.period_start.strftime("%b %-d") %> â€“ <%= run.period_end.strftime("%b %-d, %Y") %>
                    </div>
                    <div class="text-sm text-gray-500">
                      <%= run.line_item_count %> people
                      <span class="text-gray-400">â€¢</span>
                      <%= render "shared/badge", text: run.processing? ? "Processing" : "Pending", color: run.processing? ? "pink" : "gray" %>
                    </div>
                  </div>
                  <div class="flex items-center gap-4">
                    <span class="font-semibold text-gray-900"><%= number_to_currency(run.calculated_total_amount) %></span>
                    <%= link_to run.processing? ? "Continue â†’" : "View â†’", manage_money_payroll_run_path(run), class: "text-pink-600 hover:text-pink-700 text-sm font-medium" %>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>

        <%# Previous Periods / Completed Runs %>
        <% if @completed_runs.any? %>
          <div class="bg-white rounded-lg border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200">
              <h3 class="font-semibold text-gray-900">Payment History</h3>
            </div>
            <div class="divide-y divide-gray-100">
              <% @completed_runs.each do |run| %>
                <div class="px-6 py-3 flex items-center justify-between hover:bg-gray-50">
                  <div>
                    <div class="font-medium text-gray-900">
                      <%= run.period_start.strftime("%b %-d") %> â€“ <%= run.period_end.strftime("%b %-d, %Y") %>
                    </div>
                    <div class="text-sm text-gray-500">
                      Paid <%= run.processed_at&.strftime("%b %-d, %Y") || "â€”" %>
                      <span class="text-gray-400">â€¢</span>
                      <%= run.line_item_count %> people
                    </div>
                  </div>
                  <div class="flex items-center gap-4">
                    <span class="font-medium text-pink-600"><%= number_to_currency(run.calculated_total_amount) %></span>
                    <%= link_to "View â†’", manage_money_payroll_run_path(run), class: "text-gray-500 hover:text-gray-700 text-sm" %>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>

      <%# Right side - 40% - Schedule & One-Off %>
      <div class="lg:w-2/5 space-y-6">
        <%# Payroll Schedule Summary %>
        <div class="bg-white rounded-lg border border-gray-200">
          <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
            <h3 class="font-semibold text-gray-900">Schedule</h3>
            <%= link_to manage_money_payroll_settings_path, data: { turbo_frame: "payroll_settings_modal" }, class: "text-pink-600 hover:text-pink-700 text-sm font-medium" do %>
              Edit
            <% end %>
          </div>
          <div class="p-6 space-y-3">
            <div class="flex justify-between text-sm">
              <span class="text-gray-500">Pay periods</span>
              <span class="font-medium text-gray-900"><%= @schedule.period_type_label %></span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-gray-500">Payday</span>
              <span class="font-medium text-gray-900"><%= @schedule.payday_timing_label %></span>
            </div>
            <% if @schedule.semi_monthly? %>
              <div class="flex justify-between text-sm">
                <span class="text-gray-500">Split</span>
                <span class="font-medium text-gray-900">
                  <%= @schedule.semi_monthly_days == "1_and_16" ? "1stâ€“15th & 16thâ€“end" : "1stâ€“14th & 15thâ€“end" %>
                </span>
              </div>
            <% end %>
            <div class="flex justify-between text-sm">
              <span class="text-gray-500">Autopilot</span>
              <% if @schedule.autopilot? %>
                <%= render "shared/badge", text: "On", color: "pink" %>
              <% else %>
                <%= render "shared/badge", text: "Off", color: "gray" %>
              <% end %>
            </div>
          </div>
        </div>

        <%# One-Off Payroll Run %>
        <div class="bg-white rounded-lg border border-gray-200">
          <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="font-semibold text-gray-900">One-Off Payroll Run</h3>
          </div>
          <div class="p-6 space-y-4">
            <% if @preview_items.any? %>
              <p class="text-sm text-gray-600">
                Pay everyone now without waiting for the scheduled run.
                <span class="font-medium"><%= @preview_items.count %> people</span> owed
                <span class="font-medium"><%= number_to_currency(@preview_items.sum { |_, d| d[:net] }) %></span>.
              </p>
              <%= form_with url: manage_money_payroll_pay_now_path, method: :post, data: { turbo: false } do %>
                <%= render "shared/button", text: "Create One-Off Run", variant: "secondary", size: "medium", full_width: true, type: :submit %>
              <% end %>
              <% if @schedule.autopilot? %>
                <p class="text-xs text-gray-500">
                  This won't affect your scheduled runsâ€”items paid now won't appear in the next autopilot run.
                </p>
              <% end %>
            <% else %>
              <p class="text-gray-500 text-center">
                No payments due.
              </p>
            <% end %>
          </div>
        </div>

        <%# Stats %>
        <div class="bg-white rounded-lg border border-gray-200">
          <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="font-semibold text-gray-900">All Unpaid</h3>
          </div>
          <div class="p-6">
            <div class="text-3xl font-bold text-pink-600"><%= number_to_currency(@unpaid_amount) %></div>
            <div class="text-gray-500 mt-1">
              <%= pluralize(@unpaid_line_items_count, 'payout') %> across <%= pluralize(@productions.count, 'production') %>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% else %>
    <%# No payroll schedule - show setup prompt %>
    <div class="max-w-2xl mx-auto">
      <div class="bg-white rounded-lg border border-gray-200 p-8 text-center">
        <div class="text-5xl mb-4">ðŸ“…</div>
        <h2 class="text-xl font-semibold text-gray-900 mb-2">Set Up Payroll</h2>
        <p class="text-gray-600 mb-6">
          Configure your pay periods and payday schedule. Once set up, payroll runs will be automatically calculated based on your schedule.
        </p>
        <%= link_to manage_money_payroll_settings_path, data: { turbo_frame: "payroll_settings_modal" } do %>
          <%= render "shared/button", text: "Configure Payroll Schedule", variant: "primary", size: "large", icon: "settings" %>
        <% end %>
      </div>

      <%# Still show unpaid stats %>
      <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-white rounded-lg border border-gray-200 p-6">
          <div class="text-3xl font-bold text-pink-600"><%= number_to_currency(@unpaid_amount) %></div>
          <div class="text-gray-500 mt-1">Unpaid payouts</div>
          <div class="text-sm text-gray-400 mt-1"><%= pluralize(@unpaid_line_items_count, 'payout') %></div>
        </div>

        <div class="bg-white rounded-lg border border-gray-200 p-6">
          <div class="text-3xl font-bold text-gray-700"><%= @productions.count %></div>
          <div class="text-gray-500 mt-1">In-house productions</div>
        </div>
      </div>

      <%# Manual run option %>
      <div class="mt-6 text-center">
        <p class="text-gray-500 mb-4">Or create a one-off payroll run manually:</p>
        <%= link_to manage_new_money_payroll_run_path do %>
          <%= render "shared/button", text: "Create Manual Run", variant: "secondary", size: "medium" %>
        <% end %>
      </div>
    </div>
  <% end %>
</div>

<%# Turbo frame for settings modal %>
<%= turbo_frame_tag "payroll_settings_modal" %>
