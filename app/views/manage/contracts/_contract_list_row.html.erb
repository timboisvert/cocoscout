<%#
  A show_row-style row for displaying a contract in the contracts list.
  Styled to match the production_row on manage/money.

  Required params:
    - contract: Contract object
%>
<%
  is_draft = contract.status_draft?
  is_active = contract.status_active?
  contract_path = is_draft ? manage_resume_contract_wizard_path(contract) : manage_contract_path(contract)

  # Determine payment status
  pending_payments = contract.contract_payments.select(&:status_pending?)
  late_payments = pending_payments.select(&:overdue?)
  is_paid = pending_payments.empty? && contract.contract_payments.any?
  is_behind = late_payments.any?
  total_value = contract.contract_payments.sum(&:amount)

  # Check for revenue share
  payment_structure = contract.draft_payment_structure
  is_revenue_share = payment_structure == "revenue_share"
  payment_config = contract.draft_payment_config
  our_share = payment_config["revenue_our_share"].to_i if is_revenue_share
  their_share = payment_config["revenue_their_share"].to_i if is_revenue_share

  # Get services from draft or actual data
  services = contract.draft_services.presence || []

  # Check if there are space bookings
  bookings_count = contract.space_rentals.count.positive? ? contract.space_rentals.count : contract.draft_bookings.count
  has_space_rental = bookings_count > 0
%>

<div class="bg-white rounded-lg border border-gray-200 hover:border-gray-300 transition-all">
  <%= link_to contract_path, class: "block" do %>
    <div class="flex flex-col lg:flex-row lg:items-stretch">

      <%# Panel 1 (50%): Contractor Info %>
      <div class="flex-1 flex items-center gap-4 px-4 py-3 rounded-t-lg lg:rounded-l-lg lg:rounded-tr-none">
        <%# Contract Details %>
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-2 flex-wrap">
            <span class="font-medium text-gray-900">
              <%= contract.contractor_name %>
            </span>
            <% if is_draft %>
              <span class="inline-flex items-center rounded-md bg-gray-100 px-2 py-0.5 text-xs font-medium text-gray-600">
                Draft
              </span>
              <% if contract.wizard_step > 1 %>
                <span class="inline-flex items-center rounded-md bg-pink-100 px-2 py-0.5 text-xs font-medium text-pink-700">
                  Step <%= contract.wizard_step %>/8
                </span>
              <% end %>
            <% elsif is_active %>
              <span class="inline-flex items-center rounded-md bg-green-100 px-2 py-0.5 text-xs font-medium text-green-700">
                Active
              </span>
            <% end %>
          </div>
          <div class="text-sm text-gray-600">
            <% if contract.date_range.present? %>
              <%= contract.date_range %>
            <% elsif contract.contractor_email.present? %>
              <%= contract.contractor_email %>
            <% end %>
          </div>
        </div>
      </div>

      <%# Panel 2 (25%): Contract Type & Services %>
      <div class="w-full lg:w-1/4 px-4 py-3 border-t lg:border-t-0 lg:border-l border-gray-200 flex flex-col justify-center">
        <div class="text-[10px] text-gray-400 uppercase tracking-wide mb-1">Type</div>
        <% if has_space_rental %>
          <div class="text-sm font-medium text-gray-900">Space Rental</div>
          <div class="text-xs text-gray-500"><%= pluralize(bookings_count, "booking") %></div>
        <% else %>
          <div class="text-sm text-gray-400">â€”</div>
        <% end %>
        <% if services.any? %>
          <div class="flex flex-wrap gap-1 mt-1.5">
            <% services.first(3).each do |service| %>
              <span class="inline-flex items-center rounded bg-gray-100 px-1.5 py-0.5 text-[10px] font-medium text-gray-600">
                <%= service["name"] %>
              </span>
            <% end %>
            <% if services.size > 3 %>
              <span class="text-[10px] text-gray-400">+<%= services.size - 3 %></span>
            <% end %>
          </div>
        <% end %>
      </div>

      <%# Panel 3 (25%): Value & Payment Status %>
      <div class="w-full lg:w-1/4 px-4 py-3 border-t lg:border-t-0 lg:border-l border-gray-200 rounded-b-lg lg:rounded-r-lg lg:rounded-bl-none flex flex-col justify-center">
        <div class="text-[10px] text-gray-400 uppercase tracking-wide mb-1">Value</div>
        <% if is_revenue_share %>
          <div class="text-sm font-medium text-gray-900"><%= our_share %>/<%= their_share %> Revenue Share</div>
          <div class="text-[10px] text-gray-500">We receive <%= our_share %>% of ticket sales</div>
        <% elsif total_value > 0 %>
          <div class="text-sm font-medium text-gray-900"><%= number_to_currency(total_value) %></div>
          <div class="flex items-center gap-1">
            <% if is_paid %>
              <%= icon("check-circle", class: "w-3 h-3 text-green-500") %>
              <span class="text-[10px] text-green-600 font-medium">Paid</span>
            <% elsif is_behind %>
              <%= icon("alert-circle", class: "w-3 h-3 text-pink-500") %>
              <span class="text-[10px] text-pink-600 font-medium"><%= pluralize(late_payments.size, "payment") %> late</span>
            <% elsif pending_payments.any? %>
              <%= icon("clock", class: "w-3 h-3 text-gray-400") %>
              <span class="text-[10px] text-gray-500"><%= pluralize(pending_payments.size, "payment") %> pending</span>
            <% end %>
          </div>
        <% elsif is_draft %>
          <div class="text-sm text-gray-400">Not configured</div>
        <% else %>
          <div class="text-sm text-gray-400">$0.00</div>
        <% end %>
      </div>

    </div>
  <% end %>
</div>
