<% content_for :title, @questionnaire.title %>

<div class="w-full mb-10">
  <%= render partial: "shared/notice", locals: { notice: notice } %>
  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [
      ["Questionnaires", manage_production_questionnaires_path(@production)]
    ],
    text: @questionnaire.title,
    links: [
      {text: "Edit Questionnaire", path: form_manage_production_questionnaire_path(@production, @questionnaire)},
      {text: "Preview Questionnaire", path: preview_manage_production_questionnaire_path(@production, @questionnaire), target: "_blank"}
    ]
  } %>

  <!-- Status & Share -->
  <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden mb-6" data-controller="questionnaire-status" data-questionnaire-id="<%= @questionnaire.id %>" data-production-id="<%= @production.id %>">
    <div class="p-6">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="p-3 bg-gray-50 rounded-lg">
          <p class="text-xs text-gray-600 font-medium mb-2">Status</p>
          <div class="flex flex-col gap-2">
            <% if @questionnaire.archived_at.present? %>
              <div class="flex items-center gap-2">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-200 text-gray-800">
                  Archived
                </span>
                <span class="text-xs text-gray-500">on <%= @questionnaire.archived_at.strftime("%b %d, %Y") %></span>
              </div>
              <%= link_to "Unarchive this Questionnaire", unarchive_manage_production_questionnaire_path(@production, @questionnaire), method: :patch, data: { turbo_method: :patch }, class: "text-xs text-pink-500 hover:text-pink-600" %>
            <% else %>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" <%= 'checked' if @questionnaire.accepting_responses %> class="sr-only peer" data-questionnaire-status-target="toggle" data-action="change->questionnaire-status#toggleStatus">
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
                <span class="ms-3 text-sm font-medium text-gray-900" data-questionnaire-status-target="statusLabel"><%= @questionnaire.accepting_responses ? 'Accepting Responses' : 'Not Accepting Responses' %></span>
              </label>
              <%= link_to "Archive this Questionnaire", archive_manage_production_questionnaire_path(@production, @questionnaire), method: :patch, data: { confirm: "Are you sure you want to archive this questionnaire?", "questionnaire-status-target": "archiveButton", turbo_method: :patch }, class: "text-xs text-pink-500 hover:text-pink-600 #{'hidden' if @questionnaire.accepting_responses}" %>
            <% end %>
          </div>
        </div>
        <div class="p-3 bg-gray-50 rounded-lg">
          <p class="text-xs text-gray-600 font-medium">Responses</p>
          <p class="text-sm font-semibold text-gray-900 mt-1">
            <%= @questionnaire.questionnaire_responses.count %>
          </p>
        </div>
        <div class="p-3 bg-gray-50 rounded-lg">
          <p class="text-xs text-gray-600 font-medium">People Invited</p>
          <p class="text-sm font-semibold text-gray-900 mt-1">
            <%= @questionnaire.questionnaire_invitations.count %>
          </p>
        </div>
      </div>

      <div class="border-t border-gray-200 pt-4">
        <p class="text-sm font-medium text-gray-700 mb-2">Share Link</p>
        <div class="flex items-center gap-3">
          <input type="text" readonly value="<%= @questionnaire.respond_url %>" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm font-mono bg-gray-50" id="questionnaire-url">
          <button onclick="navigator.clipboard.writeText(document.getElementById('questionnaire-url').value)" class="px-4 py-2 bg-pink-500 text-white rounded-lg hover:bg-pink-600 transition text-sm">
            Copy Link
          </button>
        </div>
        <p class="mt-2 text-xs text-gray-600">Only people you've invited can access this questionnaire</p>
      </div>
    </div>
  </div>

  <!-- Invite People -->
  <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden mb-6">
    <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
      <h3 class="text-md font-semibold text-gray-900 coustard-regular">
        Invitations and Responses
      </h3>
    </div>
    <div class="p-6">
      <% if @questionnaire.archived_at.present? %>
        <!-- Read-only view for archived questionnaires -->
        <% invited_people = @questionnaire.questionnaire_invitations.includes(:person).map(&:person).sort_by(&:name) %>
        <% if invited_people.any? %>
          <div class="mb-5">
            <h4 class="text-sm font-semibold text-gray-700 mb-3">Invited People (<%= invited_people.count %>)</h4>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
              <% invited_people.each do |person| %>
                <div class="p-3 border border-gray-200 rounded-lg bg-gray-50">
                  <div class="flex items-center gap-3">
                    <% headshot_variant = person.safe_headshot_variant(:thumb) %>
                    <% if headshot_variant %>
                      <%= image_tag headshot_variant, alt: person.name, class: "w-10 h-10 rounded-lg object-cover" %>
                    <% else %>
                      <div class="w-10 h-10 rounded-lg bg-pink-100 flex items-center justify-center text-pink-600 font-bold text-sm">
                        <%= person.initials %>
                      </div>
                    <% end %>
                    <div class="flex-1 min-w-0">
                      <p class="text-sm font-medium text-gray-900 truncate"><%= person.name %></p>
                      <% if @questionnaire.questionnaire_responses.exists?(person: person) %>
                        <p class="text-xs text-pink-600">✓ Responded</p>
                      <% else %>
                        <p class="text-xs text-gray-500">Not yet responded</p>
                      <% end %>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        <% else %>
          <p class="text-sm text-gray-600">No one was invited to this questionnaire.</p>
        <% end %>
      <% else %>
        <!-- Active invitation form -->
        <%= form_with url: invite_people_manage_production_questionnaire_path(@production, @questionnaire), method: :post, local: true, data: { controller: "questionnaire-invitation" } do |form| %>

        <!-- Already Invited People -->
        <% invited_people = @questionnaire.questionnaire_invitations.includes(:person).map(&:person).sort_by(&:name) %>
        <% if invited_people.any? %>
          <div class="mb-5">
            <h4 class="text-sm font-semibold text-gray-700 mb-3">Already Invited (<%= invited_people.count %>)</h4>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
              <% invited_people.each do |person| %>
                <% response = @questionnaire.questionnaire_responses.find_by(person: person) %>
                <% if response %>
                  <%= link_to response_manage_production_questionnaire_path(@production, @questionnaire, response_id: response.id), class: "block p-3 border border-gray-200 rounded-lg bg-gray-50 hover:bg-gray-100 hover:border-gray-300 transition" do %>
                    <div class="flex items-center gap-3">
                      <% headshot_variant = person.safe_headshot_variant(:thumb) %>
                      <% if headshot_variant %>
                        <%= image_tag headshot_variant, alt: person.name, class: "w-10 h-10 rounded-lg object-cover" %>
                      <% else %>
                        <div class="w-10 h-10 rounded-lg bg-pink-100 flex items-center justify-center text-pink-600 font-bold text-sm">
                          <%= person.initials %>
                        </div>
                      <% end %>
                      <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-900 truncate"><%= person.name %></p>
                        <p class="text-xs text-pink-600">✓ Responded</p>
                      </div>
                    </div>
                  <% end %>
                <% else %>
                  <div class="p-3 border border-gray-200 rounded-lg bg-gray-50">
                    <div class="flex items-center gap-3">
                      <% headshot_variant = person.safe_headshot_variant(:thumb) %>
                      <% if headshot_variant %>
                        <%= image_tag headshot_variant, alt: person.name, class: "w-10 h-10 rounded-lg object-cover" %>
                      <% else %>
                        <div class="w-10 h-10 rounded-lg bg-pink-100 flex items-center justify-center text-pink-600 font-bold text-sm">
                          <%= person.initials %>
                        </div>
                      <% end %>
                      <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-900 truncate"><%= person.name %></p>
                        <p class="text-xs text-gray-500">Not yet responded</p>
                      </div>
                    </div>
                  </div>
                <% end %>
              <% end %>
            </div>
          </div>
        <% end %>

        <% all_people = @production.talent_pools.flat_map(&:people).uniq.sort_by(&:name) %>
        <% invited_person_ids = @questionnaire.questionnaire_invitations.pluck(:person_id) %>
        <% not_invited_people = all_people.reject { |p| invited_person_ids.include?(p.id) } %>

        <% if not_invited_people.any? %>
          <div class="mb-5 <%= 'border-t border-gray-200 pt-5' if invited_people.any? %>">
            <div class="mb-4">
              <label class="block font-semibold mb-2 text-sm">
                <%= invited_people.any? ? "Select More Recipients:" : "Select Recipients:" %>
              </label>
              <div class="space-y-2">
                <div>
                  <label class="flex items-center cursor-pointer">
                    <%= radio_button_tag :recipient_type, "all", true, class: "mr-2 accent-pink-500 cursor-pointer" %>
                    <span class="text-sm">All cast members not yet invited (<%= not_invited_people.count %>)</span>
                    <button type="button" onclick="document.getElementById('cast-member-status').classList.toggle('hidden')" class="ml-2 text-xs text-pink-500 hover:text-pink-600 underline cursor-pointer" data-questionnaire-invitation-target="viewDetailsButton">
                      Show People
                    </button>
                  </label>
                </div>

                <div id="cast-member-status" class="hidden ml-6 p-3 bg-gray-50 border border-gray-200 rounded-lg text-xs">
                  <div class="space-y-1">
                    <% not_invited_people.each do |person| %>
                      <div class="text-gray-600"><%= person.name %></div>
                    <% end %>
                  </div>
                </div>

                <% if @production.talent_pools.count > 1 %>
                  <label class="flex items-center cursor-pointer">
                    <%= radio_button_tag :recipient_type, "cast", false, class: "mr-2 accent-pink-500 cursor-pointer", data: { action: "change->questionnaire-invitation#toggleCastDropdown" } %>
                    <span class="text-sm mr-3">Specific cast</span>
                    <span class="hidden" data-questionnaire-invitation-target="castDropdown">
                      <% talent_pool_options = @production.talent_pools.map do |cast|
                        not_invited = cast.people.select { |p| not_invited_people.include?(p) }.count
                        ["#{cast.name} (#{not_invited} not yet invited)", cast.id]
                      end %>
                      <%= select_tag :talent_pool_id, options_for_select(talent_pool_options, @production.talent_pools.first&.id), class: "shadow-sm rounded-lg border border-gray-400 px-3 py-1.5 text-sm focus:border-pink-500 focus:ring-pink-500" %>
                    </span>
                  </label>
                <% end %>

                <label class="flex items-center cursor-pointer">
                  <%= radio_button_tag :recipient_type, "specific", false, class: "mr-2 accent-pink-500 cursor-pointer", data: { action: "change->questionnaire-invitation#toggleSpecific" } %>
                  <span class="text-sm">Specific people</span>
                </label>
              </div>

              <div class="hidden ml-6 mt-3" data-questionnaire-invitation-target="specificSection">
                <label class="block font-semibold mb-2 text-sm">
                  Select Recipients
                </label>
                <div class="space-y-2 max-h-64 overflow-y-auto border border-gray-300 rounded-lg p-3 bg-gray-50">
                  <% not_invited_people.each do |person| %>
                    <% person_talent_pools = @production.talent_pools.select { |c| c.people.include?(person) } %>
                    <label class="flex items-center cursor-pointer">
                      <%= check_box_tag "person_ids[]", person.id, false, class: "mr-2 accent-pink-500 cursor-pointer" %>
                      <span class="text-sm"><%= person.name %> <span class="text-gray-500">- <%= person_talent_pools.map(&:name).join(", ") %></span></span>
                    </label>
                  <% end %>
                </div>
              </div>
            </div>

            <div class="mb-4">
              <%= label_tag :message, "Email Message:", class: "block font-semibold mb-2 text-sm" %>
              <% default_message = "You're invited to respond to #{@questionnaire.title} for #{@production.name}.\n\nPlease click the link below to access the questionnaire:\n#{@questionnaire.respond_url}\n\nThank you!" %>
              <%= text_area_tag :message, default_message, rows: 6, class: "block shadow-sm rounded-lg border border-gray-400 px-3 py-2 w-full focus:border-pink-500 focus:ring-pink-500 text-sm" %>
              <p class="mt-2 text-xs text-gray-500">
                This email will be sent to each person you invite.
              </p>
            </div>

            <div class="flex gap-3">
              <%= form.submit "Send Invitations", class: "rounded-lg px-4 py-2 text-white bg-pink-500 hover:bg-pink-600 text-sm font-medium cursor-pointer" %>
            </div>
          </div>
        <% else %>
          <div class="text-sm text-gray-600 border-t border-gray-200 pt-5">
            Everyone has been invited!
          </div>
        <% end %>

        <% end %>
      <% end %>
    </div>
  </div>
</div>
