<% content_for :title, "#{@group.name} Settings" %>

<div class="w-full">

  <%= render partial: "shared/notice", locals: { notice: notice } %>

  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [
      { text: "My Groups", path: my_groups_path }
    ],
    text: @group.name,
    links: [
      { text: "View Public Profile", path: public_profile_path(@group.public_key), target: "_blank" }
    ]
  } %>

  <div class="max-w-4xl mx-auto mt-6 space-y-6">

    <%# Basic Info Section %>
    <div class="bg-white border border-gray-200 rounded-lg p-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">Basic Information</h3>

      <%= form_with model: @group, url: my_update_group_path(@group), method: :patch, class: "space-y-4" do |f| %>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <%= f.label :name, "Group Name", class: "block text-sm font-medium text-gray-700 mb-1" %>
            <%= f.text_field :name, required: true, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500" %>
          </div>

          <div>
            <%= f.label :email, "Contact Email", class: "block text-sm font-medium text-gray-700 mb-1" %>
            <%= f.email_field :email, required: true, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500" %>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <%= f.label :phone, "Phone Number", class: "block text-sm font-medium text-gray-700 mb-1" %>
            <%= f.telephone_field :phone, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500" %>
          </div>

          <div>
            <%= f.label :website, "Website", class: "block text-sm font-medium text-gray-700 mb-1" %>
            <%= f.url_field :website, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500" %>
          </div>
        </div>

        <div>
          <%= f.label :bio, "About", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <%= f.text_area :bio, rows: 4, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500" %>
        </div>

        <%# Public Profile URL %>
        <div>
          <%= f.label :public_key, "Public Profile URL", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <div class="flex items-center">
            <span class="text-sm text-gray-500 mr-2">cocoscout.com/</span>
            <%= f.text_field :public_key, required: true, pattern: "[a-z0-9][a-z0-9\-]{2,29}", class: "flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500" %>
          </div>
          <p class="mt-1 text-xs text-gray-500">3-30 characters: lowercase letters, numbers, and hyphens only</p>
        </div>

        <%# Photo Upload %>
        <div>
          <%= f.label :headshot, "Group Photo", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <% if @group.headshot.attached? %>
            <div class="mb-3">
              <%= image_tag @group.headshot.variant(:thumb), class: "w-24 h-24 rounded-lg object-cover" %>
            </div>
          <% end %>
          <%= f.file_field :headshot, accept: "image/*", class: "block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-pink-50 file:text-pink-700 hover:file:bg-pink-100" %>
        </div>

        <%# Resume Upload %>
        <div>
          <%= f.label :resume, "Group Resume/EPK", class: "block text-sm font-medium text-gray-700 mb-1" %>
          <% if @group.resume.attached? %>
            <div class="mb-2 text-sm text-gray-600">
              Current: <%= link_to @group.resume.filename, rails_blob_path(@group.resume, disposition: "attachment"), class: "text-pink-600 hover:text-pink-700" %>
            </div>
          <% end %>
          <%= f.file_field :resume, accept: "application/pdf,image/*", class: "block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-pink-50 file:text-pink-700 hover:file:bg-pink-100" %>
        </div>

        <%# Social Links %>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Social Media</label>
          <%= f.fields_for :socials do |social_form| %>
            <div class="flex gap-2 mb-2">
              <%= social_form.select :platform, Social::PLATFORMS.map { |p| [p.titleize, p] }, {}, class: "px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500" %>
              <%= social_form.text_field :url, placeholder: "Profile URL", class: "flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500" %>
              <%= social_form.check_box :_destroy, class: "hidden" %>
              <button type="button" onclick="this.previousElementSibling.checked = true; this.closest('.flex').style.display = 'none';" class="px-3 py-2 text-sm text-red-600 hover:text-red-700">Remove</button>
            </div>
          <% end %>
        </div>

        <div class="flex justify-end">
          <%= f.submit "Save Changes", class: "px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-pink-600 hover:bg-pink-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pink-500" %>
        </div>
      <% end %>
    </div>

    <%# Members Section %>
    <div class="bg-white border border-gray-200 rounded-lg p-6" data-controller="group-members">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-gray-900">Members</h3>
        <% if @membership&.owner? || @membership&.write? %>
          <button type="button" data-action="click->group-members#openInviteModal" class="px-4 py-2 text-sm font-medium text-white bg-pink-600 hover:bg-pink-700 rounded-md">
            Invite Member
          </button>
        <% end %>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <% @group.group_memberships.includes(:person).each do |membership| %>
          <div class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg">
            <% if membership.person.headshot.attached? %>
              <%= image_tag membership.person.headshot.variant(:thumb), class: "w-12 h-12 rounded-lg object-cover" %>
            <% else %>
              <div class="w-12 h-12 rounded-lg bg-pink-100 flex items-center justify-center text-pink-600 font-bold">
                <%= membership.person.initials %>
              </div>
            <% end %>

            <div class="flex-1 min-w-0">
              <%= link_to membership.person.name, public_profile_path(membership.person.public_key), class: "text-sm font-medium text-gray-900 hover:text-pink-600 truncate block" %>
              <div class="flex items-center gap-2 mt-1">
                <% if @membership&.owner? || @membership&.write? %>
                  <%= select_tag "role_#{membership.id}",
                      options_for_select([['Owner', 'owner'], ['Write', 'write'], ['View', 'view']], membership.permission_level),
                      data: { action: "change->group-members#updateRole", membership_id: membership.id },
                      class: "text-xs px-2 py-1 border border-gray-200 rounded" %>
                <% else %>
                  <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium <%= membership.owner? ? 'bg-pink-100 text-pink-700' : membership.write? ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-700' %>">
                    <%= membership.permission_level.titleize %>
                  </span>
                <% end %>
              </div>
            </div>

            <% if @membership&.owner? || @membership&.write? %>
              <% unless membership.person == Current.user.person && @group.group_memberships.where(permission_level: :owner).count == 1 %>
                <button type="button"
                        data-action="click->group-members#removeMember"
                        data-membership-id="<%= membership.id %>"
                        class="text-sm text-red-600 hover:text-red-700">
                  Remove
                </button>
              <% end %>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>

    <%# Notification Settings %>
    <div class="bg-white border border-gray-200 rounded-lg p-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">Notification Settings</h3>
      <p class="text-sm text-gray-600 mb-4">Choose which members receive email notifications for auditions, questionnaires, and other group activities.</p>

      <div class="space-y-2">
        <% @group.group_memberships.includes(:person).each do |membership| %>
          <div class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg">
            <input type="checkbox"
                   <%= 'checked' if membership.notifications_enabled? %>
                   <%= 'disabled' if membership.owner? %>
                   data-membership-id="<%= membership.id %>"
                   data-action="change->group-members#updateNotifications"
                   class="rounded border-gray-300 text-pink-600 focus:ring-pink-500">
            <span class="text-sm text-gray-900"><%= membership.person.name %></span>
            <% if membership.owner? %>
              <span class="text-xs text-gray-500">(Owners always receive notifications)</span>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>

    <%# Archive Section - Only for owners %>
    <% if @membership&.owner? %>
      <div class="bg-white border border-red-200 rounded-lg p-6">
        <h3 class="text-lg font-semibold text-red-900 mb-2">Archive Group</h3>
        <p class="text-sm text-gray-600 mb-4">
          Archiving will hide this group from all searches and directories. Historical data will be preserved.
          <% if @group.group_memberships.count == 1 %>
            You are the last member, so leaving will automatically archive this group.
          <% end %>
        </p>
        <%= button_to "Archive Group",
            my_archive_group_path(@group),
            method: :patch,
            data: { turbo_confirm: "Are you sure you want to archive #{@group.name}? It will no longer appear in searches or directories." },
            class: "px-4 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-md" %>
      </div>
    <% end %>

  </div>

</div>

<script>
// Simple Stimulus-like controller in vanilla JS for now
document.addEventListener('turbo:load', () => {
  const groupId = <%= @group.id %>;

  const controller = {
    updateRole(event) {
      const select = event.target;
      const membershipId = select.dataset.membershipId;
      const newRole = select.value;

      fetch(`/manage/groups/${groupId}/update_member_role`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
        },
        body: JSON.stringify({ person_id: membershipId, role: newRole })
      }).then(response => {
        if (!response.ok) alert('Could not update role');
      });
    },

    removeMember(event) {
      const button = event.target;
      const membershipId = button.dataset.membershipId;

      if (!confirm('Remove this member from the group?')) return;

      fetch(`/manage/groups/${groupId}/remove_member`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
        },
        body: JSON.stringify({ person_id: membershipId })
      }).then(response => {
        if (response.ok) {
          button.closest('.flex').remove();
        } else {
          alert('Could not remove member');
        }
      });
    },

    updateNotifications(event) {
      const checkbox = event.target;
      const membershipId = checkbox.dataset.membershipId;

      fetch(`/manage/groups/${groupId}/update_member_notifications`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
        },
        body: JSON.stringify({
          person_id: membershipId,
          receives_notifications: checkbox.checked
        })
      }).then(response => {
        if (!response.ok) {
          checkbox.checked = !checkbox.checked;
          alert('Could not update notification settings');
        }
      });
    }
  };

  // Attach event listeners
  document.querySelectorAll('[data-action*="updateRole"]').forEach(el => {
    el.addEventListener('change', controller.updateRole);
  });
  document.querySelectorAll('[data-action*="removeMember"]').forEach(el => {
    el.addEventListener('click', controller.removeMember);
  });
  document.querySelectorAll('[data-action*="updateNotifications"]').forEach(el => {
    el.addEventListener('change', controller.updateNotifications);
  });
});
</script>
