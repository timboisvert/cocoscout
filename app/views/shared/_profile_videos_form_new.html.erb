<%
  # Profile videos form section
%>

<%= form_with(model: @person, url: update_profile_path, method: :patch, id: "videos-form", data: { turbo: true }) do |person_form| %>
<div id="videos" class="bg-white border border-gray-200 rounded-lg overflow-hidden mb-6" data-controller="profile-videos profile-section">
  <%= render "shared/section_header",
    title: "Videos & Reels",
    collapsible: true,
    visibility_toggle: true,
    visibility_field_name: "person[profile_visibility_settings][videos_visible]",
    visibility_checked: @person.videos_visible? %>

  <div class="p-6 space-y-4" data-profile-section-target="content">
    <p class="text-sm text-gray-600 mb-4">
      Add links to your demo reels, performance videos, or other video content.
    </p>

    <div id="videos-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4" data-profile-videos-target="list">
      <%= person_form.fields_for :profile_videos do |video_form| %>
        <div class="border border-gray-200 rounded-lg overflow-hidden"
             data-video-id="<%= video_form.object.id || "new-#{video_form.object.object_id}" %>"
             data-title="<%= video_form.object.title %>"
             data-url="<%= video_form.object.url %>">
          <%= video_form.hidden_field :id %>
          <%= video_form.hidden_field :title %>
          <%= video_form.hidden_field :url %>
          <%= video_form.hidden_field :position %>
          <%= video_form.hidden_field :_destroy, value: "0", class: "destroy-field" %>

          <!-- Video Embed -->
          <% if video_form.object.url.present? %>
            <% if video_form.object.url =~ /youtube\.com|youtu\.be/ %>
              <% youtube_id = video_form.object.url[/(?:v=|\/)([0-9A-Za-z_-]{11})/, 1] %>
              <% if youtube_id %>
                <div class="w-full" style="aspect-ratio: 16/9;">
                  <iframe class="w-full h-full"
                          src="https://www.youtube.com/embed/<%= youtube_id %>"
                          frameborder="0"
                          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                          allowfullscreen>
                  </iframe>
                </div>
              <% end %>
            <% elsif video_form.object.url =~ /vimeo\.com/ %>
              <% vimeo_id = video_form.object.url[/vimeo\.com\/(\d+)/, 1] %>
              <% if vimeo_id %>
                <div class="w-full" style="aspect-ratio: 16/9;">
                  <iframe class="w-full h-full"
                          src="https://player.vimeo.com/video/<%= vimeo_id %>"
                          frameborder="0"
                          allow="autoplay; fullscreen; picture-in-picture"
                          allowfullscreen>
                  </iframe>
                </div>
              <% end %>
            <% elsif video_form.object.url =~ /drive\.google\.com/ %>
              <% google_drive_id = video_form.object.url[/\/file\/d\/([^\/\?]+)/, 1] || video_form.object.url[/[?&]id=([^&]+)/, 1] %>
              <% if google_drive_id %>
                <div class="w-full" style="aspect-ratio: 16/9;">
                  <iframe class="w-full h-full"
                          src="https://drive.google.com/file/d/<%= google_drive_id %>/preview"
                          frameborder="0"
                          allow="autoplay"
                          allowfullscreen>
                  </iframe>
                </div>
              <% end %>
            <% end %>
          <% end %>

          <!-- Video Info and Actions -->
          <div class="p-4">
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <div class="font-medium text-gray-900"><%= video_form.object.title %></div>
              </div>
              <div class="flex gap-2 ml-4">
                <button type="button"
                        class="text-xs text-pink-500 hover:text-pink-700 underline cursor-pointer"
                        data-action="click->profile-videos#edit"
                        data-video-id="<%= video_form.object.id || "new-#{video_form.object.object_id}" %>">
                  Edit
                </button>
                <button type="button"
                        class="text-xs text-pink-500 hover:text-pink-700 underline cursor-pointer"
                        data-action="click->profile-videos#remove"
                        data-video-id="<%= video_form.object.id || "new-#{video_form.object.object_id}" %>">
                  Remove
                </button>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    </div>

    <button type="button"
            class="inline-flex items-center gap-2 px-4 py-2 bg-gray-100 hover:bg-pink-500 hover:text-white text-gray-700 rounded-lg text-sm font-medium transition-colors cursor-pointer"
            data-action="click->profile-videos#openModal">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
      </svg>
      Add Video
    </button>
  </div>

  <!-- Video Modal -->
  <div class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4"
       data-profile-videos-target="modal"
       data-action="click->profile-videos#closeModal">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full p-6"
         data-action="click->profile-videos#stopPropagation">
      <h3 class="text-lg font-semibold text-gray-900 mb-4 coustard-regular">Add Video</h3>

      <div data-profile-videos-target="form">
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Title</label>
            <input type="text"
                   name="title"
                   data-field="title"
                   data-action="keydown->profile-videos#handleKeydown"
                   placeholder="e.g., Demo Reel 2024"
                   class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:border-pink-500 focus:ring-pink-500">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Video URL</label>
            <input type="text"
                   name="url"
                   data-field="url"
                   placeholder="https://youtube.com/watch?v=... or https://vimeo.com/..."
                   class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:border-pink-500 focus:ring-pink-500">
            <p class="mt-1 text-xs text-gray-500">Supports YouTube, Vimeo, and most video platforms</p>
          </div>
        </div>

        <div class="flex justify-end gap-2 mt-6">
          <button type="button"
                  class="px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg text-sm font-medium cursor-pointer"
                  data-action="click->profile-videos#closeModal">
            Cancel
          </button>
          <button type="button"
                  data-action="click->profile-videos#save"
                  class="px-4 py-2 bg-pink-500 hover:bg-pink-600 text-white rounded-lg text-sm font-medium cursor-pointer">
            Save Video
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
<% end %>
