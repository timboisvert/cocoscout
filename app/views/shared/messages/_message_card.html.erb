<%#
  Unified Message Card Component

  Used for both feed lists and show pages with IDENTICAL styling.

  Required:
    message: The message to display

  Optional:
    context: :feed (default) or :show
      - :feed - Clickable card for lists, shows "X comments" link
      - :show - Non-clickable, shows Comment button + typing indicator
    hide_production_via: Hide the "via Production" link (default: false)
    production_context: Override the production to show (default: message.production)
%>

<%
  # Context determines feed list vs show page behavior
  context = local_assigns[:context] || :feed
  is_feed = context == :feed
  is_show = context == :show

  # System-generated messages have different display rules
  is_system_generated = message.system_generated?

  # Message metadata
  reply_count = message.descendant_ids.count
  sender_person = message.sender.is_a?(Person) ? message.sender : message.sender&.person
  recipient_count = message.recipient_count

  # Production context for "via" link
  show_production_via = !local_assigns[:hide_production_via]
  production_context = local_assigns[:production_context] || (show_production_via ? message.production : nil)

  # Unread status (feed only)
  subscription = is_feed && defined?(Current) && Current.user ? Current.user.message_subscriptions.find_by(message: message) : nil
  is_unread = subscription&.unread?

  # Determine correct paths based on controller context
  is_manage_context = controller.class.name.start_with?("Manage::")

  # For production-scoped pages, use the nested URL pattern
  production_for_message_path = local_assigns[:hide_production_via] && message.production ? message.production : nil

  if is_manage_context
    if production_for_message_path
      message_path = production_message_manage_messages_path(production_for_message_path, message)
      comment_path = production_message_manage_messages_path(production_for_message_path, message, focus: :comment)
    else
      message_path = manage_message_path(message)
      comment_path = manage_message_path(message, focus: :comment)
    end
    production_link = production_context ? production_manage_messages_path(production_context) : nil
  else
    if production_for_message_path
      message_path = production_message_my_messages_path(production_for_message_path, message)
      comment_path = production_message_my_messages_path(production_for_message_path, message, focus: :comment)
    else
      message_path = my_message_path(message)
      comment_path = my_message_path(message, focus: :comment)
    end
    production_link = production_context ? production_my_messages_path(production_context) : nil
  end

  # Show regardable (only Shows are shown as cards)
  show_regardable = message.show
%>

<div class="relative bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden <%= is_feed ? 'hover:bg-gray-50 transition-colors' : '' %> <%= is_unread ? 'ring-2 ring-pink-200' : '' %>" data-message-id="<%= message.id %>">
  <% if is_feed %>
    <%# Stretched link - covers entire card (feed only) %>
    <%= link_to message_path, class: "absolute inset-0 z-0", "aria-label": message.subject || "View message" do %><% end %>
  <% end %>

  <%# Compact Header %>
  <% can_delete = !message.deleted? && message.can_be_deleted_by?(Current.user) %>
  <% can_view_receipts = message.can_view_read_receipts_by?(Current.user) %>

  <%#
    Determine recipient context label based on message type and regardables:
    - Show cast: "[Show Name] Cast" + cast member headshots
    - Talent pool: "Talent Pool" + member headshots
    - Group: "Group Name" + member headshots
    - Multiple people: "X people" + headshots
    - Single person: just show name
  %>
  <%
    recipient_context_label = nil
    show_recipient_headshots = false

    if message.message_type == "production_contact" && message.production.present?
      recipient_context_label = "#{message.production.name} Team"
    elsif message.message_type == "cast_contact" && message.show.present?
      recipient_context_label = "#{message.show.display_name} Cast"
      show_recipient_headshots = true
    elsif message.message_type == "talent_pool" && message.production.present?
      recipient_context_label = "Talent Pool"
      show_recipient_headshots = true
    elsif recipient_count > 1
      recipient_context_label = "#{recipient_count} people"
      show_recipient_headshots = true
    elsif recipient_count == 1
      # Single recipient - just show their name, no special context
      show_recipient_headshots = false
    end
  %>

  <div class="p-3 bg-gray-50/80">
    <div class="flex items-center gap-2">
      <%# Avatar - system icon for automated messages, otherwise normal avatar %>
      <% if is_system_generated %>
        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-pink-100 to-pink-50 flex items-center justify-center flex-shrink-0 border border-pink-200">
          <svg class="w-4 h-4 text-pink-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
          </svg>
        </div>
      <% else %>
        <%= render "shared/messages/message_avatar", message: message, sender_person: sender_person, size: :small %>
      <% end %>

      <div class="flex-1 min-w-0 flex items-center gap-2 flex-wrap text-sm">
        <%# Sender + via inline - system messages show "Automated Notification" %>
        <% if is_system_generated %>
          <span class="font-semibold text-gray-700">Automated Notification</span>
          <% if message.production %>
            <span class="text-gray-400">from</span>
            <% if production_link %>
              <%= link_to message.production.name, production_link, class: "relative z-10 font-medium text-pink-600 hover:text-pink-700 hover:underline" %>
            <% else %>
              <span class="font-medium text-pink-600"><%= message.production.name %></span>
            <% end %>
          <% end %>
        <% elsif message.sent_as_production_team? && production_link %>
          <%= link_to message.sender_name, production_link, class: "relative z-10 font-semibold text-pink-600 hover:text-pink-700 hover:underline" %>
        <% else %>
          <span class="font-semibold text-gray-900"><%= message.sender_name %></span>
          <%# Show "via Production" only for non-personal messages that aren't sent as production team %>
          <% if production_context && !message.sent_as_production_team? && message.visibility != "personal" %>
            <span class="text-gray-400">via</span>
            <% if production_link %>
              <%= link_to production_context.name, production_link, class: "relative z-10 font-medium text-pink-600 hover:text-pink-700 hover:underline" %>
            <% else %>
              <span class="font-medium text-pink-600"><%= production_context.name %></span>
            <% end %>
          <% end %>
        <% end %>

        <span class="text-gray-300">·</span>
        <span class="text-gray-500"><%= message.created_at.strftime("%b %-d") %></span>

        <%# Recipients with context label and headshots %>
        <% if recipient_context_label %>
          <span class="text-gray-300">·</span>
          <span class="text-gray-500">To <span class="font-medium text-gray-700"><%= recipient_context_label %></span></span>
          <% if show_recipient_headshots && recipient_count > 0 %>
            <div class="flex items-center -space-x-1">
              <% message.recipient_people.limit(8).each do |person| %>
                <% headshot_variant = person.safe_headshot_variant(:thumb) %>
                <span data-controller="tooltip" data-tooltip-text-value="<%= person.name %>" class="relative">
                  <% if headshot_variant %>
                    <%= image_tag rails_storage_proxy_url(headshot_variant),
                        alt: person.name,
                        class: "w-6 h-6 rounded-lg object-cover ring-1 ring-white relative z-10 hover:z-20 hover:scale-110 transition-transform cursor-default" %>
                  <% else %>
                    <div class="w-6 h-6 rounded-lg bg-gray-200 flex items-center justify-center text-gray-600 font-bold text-[9px] ring-1 ring-white relative z-10 hover:z-20 hover:scale-110 transition-transform cursor-default">
                      <%= person.initials %>
                    </div>
                  <% end %>
                </span>
              <% end %>
              <% if recipient_count > 8 %>
                <span data-controller="tooltip" data-tooltip-text-value="<%= recipient_count - 8 %> more" class="relative">
                  <div class="w-6 h-6 rounded-lg bg-pink-100 flex items-center justify-center text-pink-600 font-bold text-[9px] ring-1 ring-white relative z-10">
                    +<%= recipient_count - 8 %>
                  </div>
                </span>
              <% end %>
            </div>
          <% end %>
        <% elsif recipient_count == 1 %>
          <% recipient = message.recipient_people.first %>
          <% if recipient %>
            <span class="text-gray-300">·</span>
            <span class="text-gray-500">To</span>
            <span class="font-medium text-gray-700"><%= recipient.name %></span>
          <% end %>
        <% end %>

        <% if is_unread %>
          <span class="w-2 h-2 bg-pink-500 rounded-full"></span>
        <% end %>
      </div>

      <%= render "shared/messages/message_actions_menu", message: message, message_path: message_path, can_delete: can_delete, can_view_receipts: can_view_receipts %>
    </div>
  </div>

  <% if message.deleted? %>
    <%# Deleted message placeholder %>
    <div class="px-4 py-4">
      <span class="text-sm text-gray-400 italic">This message has been deleted</span>
    </div>
  <% else %>
    <%# Subject %>
    <% if message.subject.present? %>
      <div class="px-4 pt-4 pb-2">
        <h2 class="text-lg font-bold text-gray-900"><%= message.subject %></h2>
      </div>
    <% end %>

    <%# Body %>
    <div class="px-4 pb-3">
      <div class="prose prose-sm max-w-none text-gray-800">
        <%= auto_link_content(message.body) %>
      </div>
    </div>

    <%# Images %>
    <% if message.images.attached? %>
      <%= render "shared/messages/image_gallery", message: message, style: :lightbox %>
    <% end %>

    <%# Poll %>
    <% if message.message_poll.present? %>
      <%= render "shared/messages/poll", poll: message.message_poll, message: message %>
    <% end %>

    <%# Regarding Card (Show only) %>
    <% if show_regardable.present? %>
      <div class="px-4 pb-3">
        <%= render "shared/messages/regarding_card", regardable: show_regardable %>
      </div>
    <% end %>
  <% end %>

  <%# Action Bar - hidden for system-generated messages %>
  <% unless is_system_generated %>
    <div class="px-4 py-2.5 border-t border-gray-100 bg-gray-50/80">
      <div class="flex items-center justify-between relative z-10">
        <%# Left: Reactions %>
        <%= render "shared/messages/reactions", message: message %>

        <%# Right: Comments/Reply info %>
        <div class="flex items-center gap-3">
          <% if is_show %>
            <%# Show context: typing indicator + Comment button %>
            <% if reply_count > 0 %>
              <span class="text-sm text-pink-600 font-medium"><%= reply_count %> <%= reply_count == 1 ? 'reply' : 'replies' %></span>
            <% end %>
            <% unless message.deleted? %>
              <span data-message-thread-target="typingIndicator" class="text-sm text-gray-500 italic hidden"></span>
              <button
                type="button"
                class="text-sm font-medium text-gray-500 hover:text-pink-600 transition-colors cursor-pointer"
                data-action="click->message-thread#showCommentForm">
                Comment
              </button>
            <% end %>
          <% else %>
            <%# Feed context: Reply count as link %>
            <% if reply_count > 0 %>
              <%= link_to comment_path, class: "text-sm text-pink-600 hover:text-pink-700 font-medium cursor-pointer relative z-10" do %>
                <%= reply_count %> <%= reply_count == 1 ? 'comment' : 'comments' %>
              <% end %>
            <% elsif !message.deleted? %>
              <%= link_to comment_path, class: "text-sm text-gray-500 hover:text-pink-600 font-medium cursor-pointer relative z-10" do %>
                Comment
              <% end %>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>
</div>
