<% content_for :title, "Availability" %>

<div class="w-full" data-controller="availability">

  <%= render partial: "shared/notice", locals: { notice: notice } %>

  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [],
    text: "My Availability",
    links: [
      {
        text: "Calendar",
        path: my_availability_calendar_path,
        icon: "calendar"
      }
    ]
  } %>

  <% if @has_any_productions %>

  <%
    # Only show "By Cast Member" filter if user has multiple profiles or groups
    has_multiple_entities = @people.size > 1 || @groups.any?
    view_filters = [
      { text: "Awaiting My Response", path: my_availability_path(filter: 'no_response', entity: @entity_filter.join(',')), active: @filter == 'no_response' },
      { text: "All Shows", path: my_availability_path(filter: 'all', entity: @entity_filter.join(',')), active: @filter == 'all' },
      { text: "By Production", path: my_availability_path(filter: 'by_production', entity: @entity_filter.join(',')), active: @filter == 'by_production' }
    ]
    view_filters << { text: "By Cast Member", path: my_availability_path(filter: 'by_entity', entity: @entity_filter.join(',')), active: @filter == 'by_entity' } if has_multiple_entities
  %>

  <%= render "shared/filters/filter_bar",
      toggle_label: "Filters & View Options",
      filter_groups: [
        {
          label: "View",
          filters: view_filters
        },
        { separator: true },
        {
          partial: "shared/filters/entity_filter",
          locals: {
            path_helper: method(:my_availability_path),
            people: @people,
            groups: @groups,
            entity_filter: @entity_filter,
            label: "Include",
            filter: @filter
          }
        }
      ]
  %>

  <% if @filter == 'no_response' %>
    <% if @no_response_shows.any? %>
      <%# Group no-response shows by entity, then render with linkage awareness %>
      <% @entity_data.each do |entity_key, data| %>
        <% entity_no_response = data[:no_response_shows] %>
        <% if entity_no_response.any? %>
          <%= render "shared/availability_list",
                     shows: entity_no_response,
                     entity_key: entity_key,
                     entity: data[:entity],
                     availabilities: data[:availabilities],
                     show_production: true,
                     show_location: true,
                     has_groups: @groups.any? %>
        <% end %>
      <% end %>
    <% else %>
      <p class="text-gray-500 text-sm">You're up to date on your show availabilities</p>
    <% end %>

  <% elsif @filter == 'all' %>
    <% if @all_shows.any? %>
      <%# Group all shows by entity, then render with linkage awareness %>
      <% @entity_data.each do |entity_key, data| %>
        <% if data[:shows].any? %>
          <%= render "shared/availability_list",
                     shows: data[:shows],
                     entity_key: entity_key,
                     entity: data[:entity],
                     availabilities: data[:availabilities],
                     show_production: true,
                     show_location: true,
                     has_groups: @groups.any? %>
        <% end %>
      <% end %>
    <% else %>
      <p class="text-gray-500 text-sm">You don't have any upcoming shows</p>
    <% end %>

  <% elsif @filter == 'by_production' %>
        <% if @productions.any? %>
        <% @productions.each do |production| %>
          <div class="mb-8">

            <%= render partial: "shared/top_menu", locals: {
              breadcrumbs: [],
              text: production.name,
              links: []
            } %>

            <% production_shows = @shows_by_production[production] %>
            <% if production_shows.any? %>
              <%# Render each entity's shows for this production with linkage awareness %>
              <% @entity_data.each do |entity_key, data| %>
                <% entity_production_shows = data[:shows].select { |s| s.production_id == production.id } %>
                <% if entity_production_shows.any? %>
                  <%= render "shared/availability_list",
                             shows: entity_production_shows,
                             entity_key: entity_key,
                             entity: data[:entity],
                             availabilities: data[:availabilities],
                             show_production: false,
                             show_location: true,
                             has_groups: @groups.any? %>
                <% end %>
              <% end %>
            <% else %>
              <p class="text-gray-500 text-sm"><%= production.name %> doesn't have any upcoming events</p>
            <% end %>
          </div>
        <% end %>
      <% end %>

  <% elsif @filter == 'by_entity' %>
      <% @entity_data.each do |entity_key, data| %>
        <div class="mb-8">

          <%= render partial: "shared/top_menu", locals: {
            breadcrumbs: [],
            text: data[:entity].name,
            links: []
          } %>

          <% if data[:shows].any? %>
            <%= render "shared/availability_list",
                       shows: data[:shows],
                       entity_key: entity_key,
                       entity: data[:entity],
                       availabilities: data[:availabilities],
                       show_production: true,
                       show_location: true,
                       has_groups: @groups.any? %>
          <% else %>
            <p class="text-gray-500 text-sm"><%= data[:entity].name %> doesn't have any upcoming shows</p>
          <% end %>
        </div>
      <% end %>

  <% end %>

  <% else %>
    <p class="text-gray-500 text-sm">You aren't a cast member of any shows</p>
  <% end %>

</div>
