<% content_for :title, "Casting - Auditions" %>

<div class="w-full mb-10">
  <%= render partial: "shared/notice", locals: { notice: notice } %>
  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [
      ["Auditions", manage_production_auditions_path(@production)]
    ],
    text: "Casting",
    links: []
  } %>

  <%= render partial: "lifecycle_panel", locals: { current_step: :communicate } %>

  <%= render partial: "archived_banner" %>

  <% if @audition_cycle.blank? %>
    <div class="mb-5 text-gray-500 text-sm">
      You aren't currently offering auditions for <%= @production.name %>
    </div>
  <% else %>
    <% audition_cycle = @audition_cycle %>

    <%# Check if any notifications have been sent %>
    <% has_sent_notifications = audition_cycle.casting_finalized_at.present? %>
    <% notified_stages = @cast_assignment_stages.select(&:finalized?) %>

    <%# Show summary if notifications have been sent %>
    <% if has_sent_notifications %>
      <div data-controller="show-toggle">
        <div data-show-toggle-target="finalizedBox" class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden mb-6">
          <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
            <h3 class="text-md font-semibold text-gray-900 coustard-regular">Finalize Casting and Notify</h3>
          </div>
          <div class="p-6">
            <%# Finalized state - show notice and require button click to edit %>
            <div class="mb-4 p-4 bg-green-50 border border-green-200 rounded-lg">
              <div class="flex items-start gap-3">
                <div class="flex-shrink-0">
                  <svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                  </svg>
                </div>
                <div class="flex-1">
                  <h4 class="text-sm font-semibold text-green-900 mb-1">Casting Notifications Finalized</h4>
                  <p class="text-sm text-green-800 mb-3">
                    Notification emails have been sent to <%= notified_stages.count %> <%= 'person'.pluralize(notified_stages.count) %>. To add more cast members and send additional notifications, click the button below.
                  </p>
                  <button
                    type="button"
                    data-action="click->show-toggle#toggle"
                    class="font-medium rounded-lg text-sm px-4 py-2 text-center text-white bg-green-600 hover:bg-green-700 transition cursor-pointer"
                  >
                    Edit Invitations & Add More Cast Members
                  </button>
                </div>
              </div>
            </div>

            <%# Group notified people by cast %>
            <div class="space-y-3">
              <% notified_by_cast = notified_stages.group_by(&:cast_id) %>
              <% notified_by_cast.each do |cast_id, stages| %>
                <% cast = @casts.find { |c| c.id == cast_id } %>
                <div class="border-l-4 border-green-500 pl-4">
                  <h4 class="text-sm font-semibold text-gray-900 mb-2">Added to <%= cast.name %></h4>
                  <div class="flex flex-wrap gap-2">
                    <% stages.each do |stage| %>
                      <%= link_to manage_person_path(stage.person), class: "inline-flex items-center gap-2 px-2 py-1 rounded text-xs font-medium border border-gray-200 hover:border-gray-400 hover:bg-gray-50 transition-all" do %>
                        <% headshot_variant = stage.person.safe_headshot_variant(:thumb) %>
                        <% if headshot_variant %>
                          <%= image_tag headshot_variant, alt: stage.person.name, class: "w-5 h-5 rounded object-cover flex-shrink-0", draggable: false %>
                        <% else %>
                          <div class="w-5 h-5 rounded bg-gray-200 flex items-center justify-center text-black font-bold text-xs flex-shrink-0">
                            <%= stage.person.initials %>
                          </div>
                        <% end %>
                        <%= stage.person.name %>
                      <% end %>
                    <% end %>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        </div>

        <div data-show-toggle-target="content" class="hidden">
          <%= render "casting_changes" %>
          <%= render "finalize_notify", audition_cycle: audition_cycle %>
        </div><%# Close the show-toggle content div %>
      </div><%# Close the show-toggle controller div %>
    <% else %>
      <%# When notifications haven't been sent, show Casting Changes and Finalize boxes directly %>
      <%= render "casting_changes" %>
      <%= render "finalize_notify", audition_cycle: @audition_cycle %>
    <% end %>

  <% end %>
</div>
