<% content_for :title, "#{@person.name} - Superadmin" %>

<div class="w-full px-5 pt-5">
  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [
        ["Superadmin", superadmin_path],
        ["People", people_list_path]
    ],
    text: @person.name,
    links: []
  } %>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-4">
    <!-- Main Content - 2 cols -->
    <div class="lg:col-span-2 space-y-6">
      <!-- Header section -->
      <div class="bg-white border border-gray-200 rounded-lg p-6">
        <div class="flex items-start gap-6">
          <% if @person.primary_headshot.present? %>
            <%= image_tag @person.primary_headshot.image.variant(:thumb), class: "w-24 h-24 rounded-full object-cover border border-gray-200" %>
          <% else %>
            <div class="w-24 h-24 rounded-full bg-gray-200 flex items-center justify-center text-gray-400 text-2xl font-bold">
              <%= @person.name.to_s.first.upcase %>
            </div>
          <% end %>
          <div class="flex-1 min-w-0">
            <h1 class="text-3xl font-bold text-gray-900 coustard-regular mb-2">
              <%= @person.name %>
            </h1>
            <div class="space-y-1.5 text-sm text-gray-600">
              <div class="flex items-center gap-2">
                <span class="font-medium text-gray-500">Email:</span>
                <span class="truncate"><%= @person.email || "â€”" %></span>
              </div>
              <% if @person.public_key.present? %>
                <div class="flex items-center gap-2">
                  <span class="font-medium text-gray-500">Public Profile:</span>
                  <%= link_to @person.public_key, public_profile_path(@person.public_key), class: "text-pink-600 hover:text-pink-700" %>
                </div>
              <% end %>
              <% if @person.user.present? %>
                <div class="flex items-center gap-2">
                  <span class="font-medium text-gray-500">User Email:</span>
                  <span class="truncate"><%= @person.user.email_address %></span>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </div>

      <!-- Activity Summary -->
      <div class="bg-white border border-gray-200 rounded-lg p-6">
        <h2 class="text-lg font-bold text-gray-900 coustard-regular mb-4">Activity</h2>
        <dl class="grid grid-cols-2 gap-4 text-sm">
          <div>
            <dt class="text-gray-500">Created</dt>
            <dd class="font-medium text-gray-900"><%= @person.created_at&.strftime("%b %d, %Y") %></dd>
          </div>
          <div>
            <dt class="text-gray-500">Last Updated</dt>
            <dd class="font-medium text-gray-900"><%= @person.updated_at&.strftime("%b %d, %Y") %></dd>
          </div>
          <div>
            <dt class="text-gray-500">Last Seen</dt>
            <dd class="font-medium text-gray-900">
              <% if @person.user&.last_seen_at.present? %>
                <%= @person.user.last_seen_at.strftime("%b %d, %Y") %>
                <span class="text-gray-400 text-xs">(<%= time_ago_in_words(@person.user.last_seen_at) %> ago)</span>
              <% elsif @person.user.present? %>
                <span class="text-gray-400">Never logged in</span>
              <% else %>
                <span class="text-gray-400">No user account</span>
              <% end %>
            </dd>
          </div>
          <div>
            <dt class="text-gray-500">Profile Status</dt>
            <dd class="font-medium">
              <% if @person.public_profile_enabled? && @person.public_key.present? %>
                <span class="inline-flex items-center rounded-full bg-green-100 px-2 py-0.5 text-xs font-medium text-green-800">Active</span>
              <% elsif @person.public_key.present? %>
                <span class="inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 text-xs font-medium text-gray-600">Disabled</span>
              <% else %>
                <span class="inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 text-xs font-medium text-gray-600">No Profile</span>
              <% end %>
            </dd>
          </div>
        </dl>

        <% if @person.organizations.any? %>
          <div class="mt-4 pt-4 border-t border-gray-100">
            <dt class="text-gray-500 text-sm mb-2">Organizations</dt>
            <dd class="flex flex-wrap gap-1.5">
              <% @person.organizations.each do |org| %>
                <%= link_to org.name, organization_detail_path(org), class: "inline-flex items-center px-2 py-0.5 bg-gray-100 text-gray-700 rounded text-xs hover:bg-gray-200" %>
              <% end %>
            </dd>
          </div>
        <% end %>
      </div>

      <!-- Profile Info -->
      <div class="bg-white border border-gray-200 rounded-lg p-6">
        <h2 class="text-lg font-bold text-gray-900 coustard-regular mb-4">Profile Info</h2>
        <dl class="grid grid-cols-2 gap-4 text-sm">
          <% if @person.pronouns.present? %>
            <div>
              <dt class="text-gray-500">Pronouns</dt>
              <dd class="font-medium text-gray-900"><%= @person.pronouns %></dd>
            </div>
          <% end %>
          <% if @person.phone.present? %>
            <div>
              <dt class="text-gray-500">Phone</dt>
              <dd class="font-medium text-gray-900"><%= @person.phone %></dd>
            </div>
          <% end %>
          <div>
            <dt class="text-gray-500">Headshots</dt>
            <dd class="font-medium text-gray-900"><%= @person.profile_headshots.count %></dd>
          </div>
          <div>
            <dt class="text-gray-500">Resumes</dt>
            <dd class="font-medium text-gray-900"><%= @person.profile_resumes.count %></dd>
          </div>
          <% if @person.bio.present? %>
            <div class="col-span-2">
              <dt class="text-gray-500">Bio</dt>
              <dd class="font-medium text-gray-900"><%= truncate(@person.bio, length: 200) %></dd>
            </div>
          <% end %>
        </dl>
      </div>
    </div>

    <!-- Sidebar - Actions - 1 col -->
    <div class="space-y-6">
      <!-- Actions Panel -->
      <div class="bg-white border border-gray-200 rounded-lg p-5">
        <h3 class="font-semibold text-gray-900 mb-4">Actions</h3>
        <div class="space-y-3">
          <% if @person.user.present? %>
            <%= form_with url: impersonate_user_path, method: :post, local: true, class: "block" do |f| %>
              <%= f.hidden_field :email, value: @person.user.email_address %>
              <%= render "shared/button",
                    text: "Impersonate User",
                    variant: "outline",
                    size: "small",
                    icon: "user",
                    type: :submit,
                    full_width: true %>
            <% end %>
          <% else %>
            <div class="text-xs text-gray-500 text-center py-2 bg-gray-50 rounded">
              No user account to impersonate
            </div>
          <% end %>

          <% if @person.user.present? %>
            <div data-controller="show-toggle">
              <button type="button" data-action="click->show-toggle#toggle" class="w-full">
                <%= render "shared/button",
                      text: "Change Email",
                      variant: "outline",
                      size: "small",
                      icon: "mail",
                      type: :button,
                      full_width: true %>
              </button>
              <div data-show-toggle-target="content" class="hidden mt-3 p-3 bg-gray-50 rounded-lg">
                <%= form_with url: change_email_user_path, method: :post, local: true do |f| %>
                  <%= f.hidden_field :old_email, value: @person.user.email_address %>
                  <div class="mb-3">
                    <%= f.label :new_email, "New Email Address", class: "block text-xs font-medium text-gray-700 mb-1" %>
                    <%= f.email_field :new_email, required: true, autocapitalize: "none", class: "block shadow-sm rounded-lg border px-3 py-2 w-full border-gray-300 text-sm" %>
                  </div>
                  <%= f.submit "Update Email", class: "w-full rounded-lg px-3 py-2 text-white bg-pink-500 hover:bg-pink-600 font-medium text-sm cursor-pointer" %>
                <% end %>
              </div>
            </div>
          <% end %>

          <div data-controller="show-toggle">
            <button type="button" data-action="click->show-toggle#toggle" class="w-full">
              <%= render "shared/button",
                    text: "Merge with Another Person",
                    variant: "outline",
                    size: "small",
                    icon: "switch",
                    type: :button,
                    full_width: true %>
            </button>
            <div data-show-toggle-target="content" class="hidden mt-3 p-3 bg-gray-50 rounded-lg">
              <%= form_with url: merge_person_path(@person), method: :post, local: true do |f| %>
                <div class="mb-3">
                  <%= f.label :target_person_id, "Merge into Person ID", class: "block text-xs font-medium text-gray-700 mb-1" %>
                  <%= f.number_field :target_person_id, required: true, placeholder: "Enter Person ID to merge into", class: "block shadow-sm rounded-lg border px-3 py-2 w-full border-gray-300 text-sm" %>
                  <p class="text-xs text-gray-500 mt-1">This person's data will be merged into the target, then this person will be deleted.</p>
                </div>
                <%= f.submit "Merge Person", class: "w-full rounded-lg px-3 py-2 text-white bg-amber-500 hover:bg-amber-600 font-medium text-sm cursor-pointer", data: { turbo_confirm: "Are you sure? This will merge all data from #{@person.name} into the target person, then delete this person record. This cannot be undone." } %>
              <% end %>
            </div>
          </div>

          <hr class="border-gray-200">

          <%= render "shared/button",
                text: "Delete Person",
                variant: "danger",
                size: "small",
                icon: "trash",
                path: destroy_person_path(@person),
                full_width: true,
                data: {
                  turbo_method: :delete,
                  turbo_confirm: "Are you sure you want to permanently delete #{@person.name}? This will remove them from ALL organizations and cannot be undone."
                }
          %>
        </div>
      </div>

      <!-- Quick Stats -->
      <div class="bg-white border border-gray-200 rounded-lg p-5">
        <h3 class="font-semibold text-gray-900 mb-4">Stats</h3>
        <dl class="space-y-3 text-sm">
          <div class="flex justify-between">
            <dt class="text-gray-500">User Account</dt>
            <dd>
              <% if @person.user.present? %>
                <span class="inline-flex items-center rounded-full bg-green-100 px-2 py-0.5 text-xs font-medium text-green-800">Yes</span>
              <% else %>
                <span class="inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 text-xs font-medium text-gray-600">No</span>
              <% end %>
            </dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-gray-500">Talent Pools</dt>
            <dd class="font-semibold text-gray-900"><%= @person.talent_pool_memberships.count %></dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-gray-500">Organizations</dt>
            <dd class="font-semibold text-gray-900"><%= @person.organizations.count %></dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-gray-500">Sign-up Forms</dt>
            <dd class="font-semibold text-gray-900"><%= @person.sign_up_registrations.count %></dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-gray-500">Audition Requests</dt>
            <dd class="font-semibold text-gray-900"><%= @person.audition_requests.count %></dd>
          </div>
        </dl>
      </div>
    </div>
  </div>
</div>
