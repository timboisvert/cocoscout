<%= render layout: "manage/contract_wizard/wizard_layout", locals: { step_name: "Bookings" } do %>
  <h2 class="text-xl font-bold text-gray-900 mb-2 coustard-regular">When will they use your space?</h2>
  <p class="text-gray-600 mb-6">Define the booking pattern for this contract.</p>

  <%= form_with url: manage_bookings_contract_wizard_path(@contract), method: :post, local: true, data: { controller: "contract-bookings", "contract-bookings-locations-value": @locations.map { |l| { id: l.id, name: l.name, spaces: l.location_spaces.map { |s| { id: s.id, name: s.name } } } }.to_json } do |form| %>

    <%# Booking Mode Selection %>
    <div class="mb-6">
      <h3 class="text-sm font-semibold text-gray-900 mb-3">Booking Type</h3>
      <div class="grid grid-cols-2 gap-3">
        <label class="cursor-pointer">
          <div data-contract-bookings-target="singleOption" class="p-4 rounded-lg border-2 <%= @existing_rules["mode"] == "recurring" ? "border-gray-200 bg-gray-50" : "border-pink-500 bg-pink-50" %> transition-colors hover:border-pink-400">
            <div class="flex items-start">
              <input type="radio" name="booking_mode" value="single" 
                     <%= "checked" unless @existing_rules["mode"] == "recurring" %>
                     data-action="change->contract-bookings#toggleBookingMode"
                     class="mt-1 h-4 w-4 text-pink-500 border-gray-300 focus:ring-pink-500 accent-pink-500">
              <div class="ml-3">
                <p class="font-medium text-gray-900">Single Event</p>
                <p class="text-xs text-gray-500 mt-0.5">One specific date and time</p>
              </div>
            </div>
          </div>
        </label>
        <label class="cursor-pointer">
          <div data-contract-bookings-target="recurringOption" class="p-4 rounded-lg border-2 <%= @existing_rules["mode"] == "recurring" ? "border-pink-500 bg-pink-50" : "border-gray-200 bg-gray-50" %> transition-colors hover:border-pink-400">
            <div class="flex items-start">
              <input type="radio" name="booking_mode" value="recurring"
                     <%= "checked" if @existing_rules["mode"] == "recurring" %>
                     data-action="change->contract-bookings#toggleBookingMode"
                     class="mt-1 h-4 w-4 text-pink-500 border-gray-300 focus:ring-pink-500 accent-pink-500">
              <div class="ml-3">
                <p class="font-medium text-gray-900">Recurring Series</p>
                <p class="text-xs text-gray-500 mt-0.5">Weekly, biweekly, or monthly</p>
              </div>
            </div>
          </div>
        </label>
      </div>
    </div>

    <%# Single Event Form %>
    <div data-contract-bookings-target="singleForm" class="<%= "hidden" if @existing_rules["mode"] == "recurring" %> bg-gray-50 rounded-lg p-5 mb-6 border border-gray-200">
      <h4 class="text-sm font-semibold text-gray-900 mb-4 flex items-center gap-2">
        <%= icon("calendar", class: "w-4 h-4 text-pink-600") %>
        Event Details
      </h4>
      <div class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1.5">Location</label>
            <select name="single_location" data-contract-bookings-target="location"
                    data-action="change->contract-bookings#locationChanged"
                    class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
              <option value="">Select a location...</option>
              <% @locations.each do |location| %>
                <option value="<%= location.id %>" <%= "selected" if @existing_rules["location_id"].to_s == location.id.to_s && @existing_rules["mode"] != "recurring" %>><%= location.name %></option>
              <% end %>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1.5">
              Space <span class="text-gray-400 font-normal">(optional)</span>
            </label>
            <select name="single_space" data-contract-bookings-target="space"
                    class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
              <option value="">Entire venue</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1.5">Date & Time</label>
            <input type="datetime-local" name="single_starts_at"
                   value="<%= @existing_rules["starts_at"] unless @existing_rules["mode"] == "recurring" %>"
                   data-contract-bookings-target="startDateTime"
                   class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1.5">Duration</label>
            <select name="single_duration" data-contract-bookings-target="duration"
                    class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
              <% duration = @existing_rules["mode"] != "recurring" ? @existing_rules["duration"].to_s : "" %>
              <option value="1" <%= "selected" if duration == "1" %>>1 hour</option>
              <option value="1.5" <%= "selected" if duration == "1.5" %>>1.5 hours</option>
              <option value="2" <%= "selected" if duration == "2" || duration.blank? %>>2 hours</option>
              <option value="2.5" <%= "selected" if duration == "2.5" %>>2.5 hours</option>
              <option value="3" <%= "selected" if duration == "3" %>>3 hours</option>
              <option value="4" <%= "selected" if duration == "4" %>>4 hours</option>
              <option value="6" <%= "selected" if duration == "6" %>>6 hours</option>
              <option value="8" <%= "selected" if duration == "8" %>>8 hours</option>
            </select>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1.5">
            Notes <span class="text-gray-400 font-normal">(optional)</span>
          </label>
          <input type="text" name="single_notes"
                 value="<%= @existing_rules["notes"] unless @existing_rules["mode"] == "recurring" %>"
                 placeholder="e.g., Setup time included"
                 data-contract-bookings-target="notes"
                 class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500 placeholder-gray-400">
        </div>
      </div>
    </div>

    <%# Recurring Series Form %>
    <div data-contract-bookings-target="recurringForm" class="<%= "hidden" unless @existing_rules["mode"] == "recurring" %> bg-gray-50 rounded-lg p-5 mb-6 border border-gray-200">
      <h4 class="text-sm font-semibold text-gray-900 mb-4 flex items-center gap-2">
        <%= icon("repeat", class: "w-4 h-4 text-pink-600") %>
        Recurring Pattern
      </h4>
      <div class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1.5">Location</label>
            <select name="recurring_location" data-contract-bookings-target="recurringLocation"
                    data-action="change->contract-bookings#recurringLocationChanged"
                    class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
              <option value="">Select a location...</option>
              <% @locations.each do |location| %>
                <option value="<%= location.id %>" <%= "selected" if @existing_rules["location_id"].to_s == location.id.to_s && @existing_rules["mode"] == "recurring" %>><%= location.name %></option>
              <% end %>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1.5">
              Space <span class="text-gray-400 font-normal">(optional)</span>
            </label>
            <select name="recurring_space" data-contract-bookings-target="recurringSpace"
                    class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
              <option value="">Entire venue</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1.5">Frequency</label>
            <select name="recurring_frequency" data-contract-bookings-target="frequency"
                    class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
              <option value="weekly" <%= "selected" if @existing_rules["frequency"] == "weekly" %>>Weekly</option>
              <option value="biweekly" <%= "selected" if @existing_rules["frequency"] == "biweekly" %>>Every 2 weeks</option>
              <option value="monthly" <%= "selected" if @existing_rules["frequency"] == "monthly" %>>Monthly (same day of week)</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1.5">Day of Week</label>
            <select name="recurring_day_of_week" data-contract-bookings-target="dayOfWeek"
                    class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
              <option value="0" <%= "selected" if @existing_rules["day_of_week"].to_s == "0" %>>Sunday</option>
              <option value="1" <%= "selected" if @existing_rules["day_of_week"].to_s == "1" %>>Monday</option>
              <option value="2" <%= "selected" if @existing_rules["day_of_week"].to_s == "2" %>>Tuesday</option>
              <option value="3" <%= "selected" if @existing_rules["day_of_week"].to_s == "3" %>>Wednesday</option>
              <option value="4" <%= "selected" if @existing_rules["day_of_week"].to_s == "4" %>>Thursday</option>
              <option value="5" <%= "selected" if @existing_rules["day_of_week"].to_s == "5" || @existing_rules["day_of_week"].blank? %>>Friday</option>
              <option value="6" <%= "selected" if @existing_rules["day_of_week"].to_s == "6" %>>Saturday</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1.5">Time</label>
            <input type="time" name="recurring_time"
                   value="<%= @existing_rules["time"] || "19:00" %>"
                   data-contract-bookings-target="recurringTime"
                   class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1.5">Duration</label>
            <select name="recurring_duration" data-contract-bookings-target="recurringDuration"
                    class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
              <% r_duration = @existing_rules["mode"] == "recurring" ? @existing_rules["duration"].to_s : "" %>
              <option value="1" <%= "selected" if r_duration == "1" %>>1 hour</option>
              <option value="1.5" <%= "selected" if r_duration == "1.5" %>>1.5 hours</option>
              <option value="2" <%= "selected" if r_duration == "2" || r_duration.blank? %>>2 hours</option>
              <option value="2.5" <%= "selected" if r_duration == "2.5" %>>2.5 hours</option>
              <option value="3" <%= "selected" if r_duration == "3" %>>3 hours</option>
              <option value="4" <%= "selected" if r_duration == "4" %>>4 hours</option>
              <option value="6" <%= "selected" if r_duration == "6" %>>6 hours</option>
              <option value="8" <%= "selected" if r_duration == "8" %>>8 hours</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1.5">Start Date</label>
            <input type="date" name="recurring_start_date"
                   value="<%= @existing_rules["start_date"] || Date.current.to_s %>"
                   data-contract-bookings-target="startDate"
                   class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1.5">Number of Events</label>
            <select name="recurring_event_count" data-contract-bookings-target="eventCount"
                    class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
              <option value="4" <%= "selected" if @existing_rules["event_count"].to_s == "4" %>>4 events</option>
              <option value="8" <%= "selected" if @existing_rules["event_count"].to_s == "8" || @existing_rules["event_count"].blank? %>>8 events</option>
              <option value="12" <%= "selected" if @existing_rules["event_count"].to_s == "12" %>>12 events</option>
              <option value="16" <%= "selected" if @existing_rules["event_count"].to_s == "16" %>>16 events</option>
              <option value="24" <%= "selected" if @existing_rules["event_count"].to_s == "24" %>>24 events</option>
              <option value="52" <%= "selected" if @existing_rules["event_count"].to_s == "52" %>>52 events (1 year weekly)</option>
            </select>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1.5">
            Notes <span class="text-gray-400 font-normal">(optional)</span>
          </label>
          <input type="text" name="recurring_notes"
                 value="<%= @existing_rules["notes"] if @existing_rules["mode"] == "recurring" %>"
                 placeholder="e.g., Weekly open mic"
                 data-contract-bookings-target="recurringNotes"
                 class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500 placeholder-gray-400">
        </div>
      </div>
    </div>

    <%# Manage Spaces Link %>
    <p class="text-xs text-gray-500 text-center mb-6">
      Need to add spaces?
      <%= link_to "Manage locations", manage_locations_path, class: "text-pink-600 hover:text-pink-700 underline", target: "_blank" %>
    </p>

    <%# Navigation %>
    <div class="flex justify-between">
      <%= render "shared/button", text: "Back", variant: "secondary", size: "medium", icon: "arrow-left", path: manage_contractor_contract_wizard_path(@contract) %>
      <%= render "shared/button", text: "Next: Preview Schedule", variant: "primary", size: "medium", type: :submit %>
    </div>
  <% end %>
<% end %>
