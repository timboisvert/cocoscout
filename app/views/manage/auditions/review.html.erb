<% content_for :title, "Review - Auditions" %>

<div class="w-full mb-10">
  <%= render partial: "shared/notice", locals: { notice: notice } %>
  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [
      ["Sign-ups", manage_signups_path],
      [@production.name, manage_signups_production_path(@production)],
      ["Auditions", manage_signups_auditions_path(@production)]
    ],
    text: "Review",
    links: []
  } %>

  <% # Hide lifecycle panel for non-managers on video-only since there's only one step %>
  <% unless !current_user_can_manage?(@production) && @audition_cycle&.video_only? %>
    <%= render partial: "lifecycle_panel", locals: { current_step: :review } %>
  <% end %>

  <%= render partial: "archived_banner" %>

  <% if @audition_cycle.blank? %>
    <div class="mb-5 text-gray-500 text-sm">
      You aren't currently offering auditions for <%= @production.name %>
    </div>
  <% else %>
    <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden mb-6">
      <% review_title = @audition_cycle.video_only? ? "Video Auditions" : "Audition Requests" %>
      <%= render "shared/card_header", title: review_title %>
      <div class="p-6">
        <p class="text-sm text-gray-500 mb-6">Review and vote on each auditionee's application.</p>

        <% vote_summary = @audition_cycle.vote_summary %>

        <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 mb-6">
          <%= link_to manage_signups_auditions_cycle_requests_path(@production, @audition_cycle) do %>
            <div class="p-4 bg-white border border-gray-200 rounded-lg hover:border-gray-400 transition-all min-h-24">
              <p class="font-bold text-4xl text-center text-pink-600"><%= vote_summary[:total_requests] %></p>
              <p class="text-xs text-center text-gray-500">
                <% if @audition_cycle.video_only? %>
                  Total Video Auditions
                <% else %>
                  Open Sign-ups
                <% end %>
              </p>
            </div>
          <% end %>
          <%= link_to manage_signups_auditions_cycle_requests_path(@production, @audition_cycle) do %>
            <div class="p-4 bg-white border border-gray-200 rounded-lg hover:border-gray-400 transition-all min-h-24">
              <p class="font-bold text-4xl text-center text-pink-600"><%= vote_summary[:total_votes] %></p>
              <p class="text-xs text-center text-gray-500">Votes Cast</p>
            </div>
          <% end %>
          <%= link_to manage_signups_auditions_cycle_requests_path(@production, @audition_cycle) do %>
            <div class="p-4 bg-white border border-gray-200 rounded-lg hover:border-gray-400 transition-all min-h-24">
              <p class="font-bold text-4xl text-center text-pink-600"><%= vote_summary[:total_comments] %></p>
              <p class="text-xs text-center text-gray-500">Comments</p>
            </div>
          <% end %>
        </div>

        <%
          button_text = @audition_cycle.video_only? ? "View all Video Auditions" : "View all Audition Requests"
        %>
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
          <%= render partial: "shared/button", locals: {text: button_text, path: manage_signups_auditions_cycle_requests_path(@production, @audition_cycle), variant: "primary"} %>

          <% if current_user_has_role?(@production) %>
            <div class="flex items-center justify-between sm:justify-start gap-4 px-4 py-2 bg-gray-50 border border-gray-200 rounded">
              <div class="flex items-center gap-2">
                <% if @audition_cycle.voting_enabled %>
                  <span class="relative flex h-3 w-3">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                  </span>
                  <span class="text-sm font-semibold text-green-700">Voting Live</span>
                <% else %>
                  <span class="relative flex h-3 w-3">
                    <span class="relative inline-flex rounded-full h-3 w-3 bg-gray-400"></span>
                  </span>
                  <span class="text-sm font-semibold text-gray-500">Voting Paused</span>
                <% end %>
                <% if @audition_cycle.voting_enabled %>
                  <span class="text-sm text-gray-500">(<%= @audition_cycle.reviewer_count %> <%= 'reviewer'.pluralize(@audition_cycle.reviewer_count) %>)</span>
                <% end %>
              </div>
              <label class="flex items-center gap-2 cursor-pointer"
                     data-controller="toggle-voting"
                     data-toggle-voting-cycle-id-value="<%= @audition_cycle.id %>"
                     data-toggle-voting-enabled-value="<%= @audition_cycle.voting_enabled %>"
                     data-toggle-voting-url-value="<%= manage_toggle_voting_signups_auditions_cycle_path(@production, @audition_cycle) %>">
                <div class="relative inline-block w-10 h-6 transition duration-200 ease-in-out">
                  <input type="checkbox"
                         <%= 'checked' if @audition_cycle.voting_enabled %>
                         data-action="change->toggle-voting#confirm"
                         class="sr-only peer">
                  <div class="block w-10 h-6 rounded-full <%= @audition_cycle.voting_enabled ? 'bg-pink-500' : 'bg-gray-300' %> peer-focus:ring-2 peer-focus:ring-pink-300"></div>
                  <div class="absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition-transform <%= @audition_cycle.voting_enabled ? 'translate-x-4' : 'translate-x-0' %>"></div>
                </div>
              </label>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <% if @audition_cycle.accepts_in_person_auditions? && current_user_has_role?(@production) %>
    <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden">
      <%= render "shared/card_header", title: "Schedule Auditions" %>
      <div class="p-6">
        <p class="text-sm text-gray-500 mb-6">Assign people to audition sessions.</p>

        <% if @audition_cycle.audition_sessions.any? %>
          <div class="space-y-3">
            <% @audition_cycle.audition_sessions.order(:start_at).each do |session| %>
              <%= render partial: "manage/audition_sessions/session_row", locals: { session: session, production: @production, audition_cycle: @audition_cycle } %>
            <% end %>
          </div>

          <div class="mt-4">
            <%= render partial: "shared/button", locals: {text: "Schedule Auditions", path: manage_schedule_auditions_signups_auditions_cycle_path(@production, @audition_cycle), variant: "primary"} %>
          </div>
        <% else %>
          <p class="text-gray-500 text-sm mb-4">No audition sessions have been scheduled yet.</p>
          <%= render partial: "shared/button", locals: {text: "Schedule Auditions", path: manage_signups_auditions_cycle_sessions_path(@production, @audition_cycle), variant: "primary"} %>
        <% end %>
      </div>
    </div>
    <% end %>

    <% if @audition_cycle.accepts_in_person_auditions? && current_user_has_role?(@production) %>
    <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden mt-6">
      <%= render "shared/card_header", title: "Finalize Audition Plans and Notify" %>
      <div class="p-6">
        <p class="text-sm text-gray-500 mb-4">Send notification emails to all applicants about their audition status and schedule.</p>

        <% # Get all active (non-archived) audition requests %>
        <% all_audition_requests = @audition_cycle.audition_requests.active.includes(:requestable) %>

        <% # Get all scheduled auditionables (people and groups) for this audition cycle %>
        <% scheduled_auditionables = @audition_cycle.audition_sessions.joins(:auditions).pluck('auditions.auditionable_type', 'auditions.auditionable_id').map { |type, id| [type, id] }.to_set %>

        <% # Count people who have been notified and whose scheduling status hasn't changed since %>
        <% notified_requests = all_audition_requests.select { |req| req.invitation_notification_sent_at.present? && (scheduled_auditionables.include?([req.requestable_type, req.requestable_id]) == req.notified_scheduled) } %>
        <% notified_people_count = notified_requests.count %>

        <% # Show requests that haven't been notified yet OR whose scheduling status has changed %>
        <% audition_requests = all_audition_requests.select { |req| req.invitation_notification_sent_at.nil? || (scheduled_auditionables.include?([req.requestable_type, req.requestable_id]) != req.notified_scheduled) } %>
        <% # Split by whether they're currently scheduled %>
        <% scheduled_requests = audition_requests.select { |req| scheduled_auditionables.include?([req.requestable_type, req.requestable_id]) } %>
        <% not_scheduled_requests = audition_requests.reject { |req| scheduled_auditionables.include?([req.requestable_type, req.requestable_id]) } %>

        <% # Load email assignments for requestables (people and groups) who haven't been notified %>
        <% requestable_tuples = audition_requests.map { |r| [r.requestable_type, r.requestable_id] } %>
        <% email_assignments = @audition_cycle.audition_email_assignments
             .where(assignable_type: requestable_tuples.map(&:first).uniq, assignable_id: requestable_tuples.map(&:last))
             .index_by { |a| [a.assignable_type, a.assignable_id] } %>
        <% # Load custom email groups (exclude default group_ids to avoid duplicates) %>
        <% custom_groups = @audition_cycle.email_groups.where(group_type: 'audition').where.not(group_id: ['invitation_accepted', 'invitation_not_accepted']).order(:created_at) %>

        <% if @audition_cycle.finalize_audition_invitations %>
          <%# Finalized state - show notice %>
          <% if audition_requests.any? %>
            <%# There are new people to notify %>
            <div class="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
              <div class="flex items-start gap-3">
                <div class="flex-shrink-0">
                  <svg class="w-5 h-5 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 9a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/>
                  </svg>
                </div>
                <div class="flex-1">
                  <h4 class="text-sm font-semibold text-yellow-900 mb-1">New Auditions have been scheduled</h4>
                  <p class="text-sm text-yellow-800 mb-0">
                    <%= notified_people_count %> <%= 'auditionee'.pluralize(notified_people_count) %> <%= notified_people_count == 1 ? 'has' : 'have' %> already been notified.
                    <%= audition_requests.count %> <%= 'auditionee'.pluralize(audition_requests.count) %> still need<%= audition_requests.count == 1 ? 's' : '' %> to be notified.
                  </p>
                </div>
              </div>
            </div>
          <% else %>
            <%# Everyone has been notified %>
            <div class="mb-4 p-4 bg-green-50 border border-green-200 rounded-lg">
              <div class="flex items-start gap-3">
                <div class="flex-shrink-0">
                  <svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                  </svg>
                </div>
                <div class="flex-1">
                  <h4 class="text-sm font-semibold text-green-900 mb-1">All Audition decision notifications have been sent</h4>
                  <p class="text-sm text-green-800 mb-0">
                    Notification emails have been sent to all <%= notified_people_count %> <%= 'audition request'.pluralize(notified_people_count) %>.
                    If new people submit an audition request or more people are offered an audition, they will appear here for notification.
                  </p>
                </div>
              </div>
            </div>
          <% end %>
        <% end %>

        <% if scheduled_requests.any? || not_scheduled_requests.any? %>
          <% has_both_groups = scheduled_requests.any? && not_scheduled_requests.any? %>
          <div data-controller="tabs">
            <%# Tab buttons - always show for visual consistency %>
            <div class="flex border-b border-gray-200 mb-6">
              <% tab_index = 0 %>
              <% if scheduled_requests.any? %>
                <button type="button"
                        class="px-4 py-2 text-sm font-medium border-b-2 border-pink-500 text-pink-600 bg-white"
                        data-tabs-target="tab"
                        data-action="click->tabs#select"
                        data-index="<%= tab_index %>">
                  Invited to Audition (<%= scheduled_requests.count %>)
                </button>
                <% tab_index += 1 %>
              <% end %>
              <% if not_scheduled_requests.any? %>
                <button type="button"
                        class="px-4 py-2 text-sm font-medium border-b-2 <%= scheduled_requests.any? ? 'border-transparent text-gray-500 bg-gray-50 hover:text-gray-700' : 'border-pink-500 text-pink-600 bg-white' %>"
                        data-tabs-target="tab"
                        data-action="click->tabs#select"
                        data-index="<%= tab_index %>">
                  Not Invited (<%= not_scheduled_requests.count %>)
                </button>
              <% end %>
            </div>

            <% if scheduled_requests.any? %>
              <%# Panel 1: Invited to Audition %>
              <div data-tabs-target="panel">
                <div class="mb-4">
                  <h5 class="text-sm font-semibold text-gray-900 mb-3">People/Groups being invited to audition:</h5>
                  <div class="flex flex-wrap gap-2 mb-4">
                    <% scheduled_requests.each do |request| %>
                      <% requestable = request.requestable %>
                      <% headshot_variant = requestable.safe_headshot_variant(:thumb) if requestable.respond_to?(:safe_headshot_variant) %>
                      <div class="inline-flex items-center gap-2 px-2 py-1 rounded text-xs font-medium border border-gray-200">
                        <% if headshot_variant %>
                          <%= image_tag headshot_variant, alt: requestable.name, class: "w-5 h-5 rounded object-cover flex-shrink-0", draggable: false %>
                        <% else %>
                          <div class="w-5 h-5 rounded bg-gray-200 flex items-center justify-center text-black font-bold text-xs flex-shrink-0">
                            <%= requestable.is_a?(Person) ? requestable.initials : raw('<i class="fa-solid fa-users text-xs"></i>') %>
                          </div>
                        <% end %>
                        <span><%= requestable.name %></span>
                      </div>
                    <% end %>
                  </div>
                  <%= fields_for :invitation_email_draft, EmailDraft.new(title: ContentTemplate.find_by(key: "audition_invitation")&.subject || "Auditions", body: ContentTemplateService.render_body("audition_invitation", { recipient_name: "[Name]", production_name: @production.name, audition_date: "[date]" })) do |email_form| %>
                    <div class="space-y-3">
                      <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Subject</label>
                        <%= email_form.text_field :title, class: "block w-full rounded-lg border border-gray-300 px-3 py-2 text-gray-900 placeholder:text-gray-400 focus:border-pink-500 focus:ring-pink-500 text-sm", placeholder: "Email subject..." %>
                      </div>
                      <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Body</label>
                        <%= email_form.rich_text_area :body, class: "w-full rounded-lg border border-gray-300 focus:ring-2 focus:ring-pink-500 focus:border-transparent" %>
                      </div>
                    </div>
                  <% end %>
                </div>
                <%# Review checkbox for invited group %>
                <div class="mt-6 pt-4 border-t border-gray-200">
                  <label class="flex items-center gap-3 cursor-pointer">
                    <input type="checkbox"
                           data-tabs-target="reviewCheckbox"
                           data-action="change->tabs#checkAllReviewed"
                           class="w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                    <span class="text-sm text-gray-700">I have reviewed the recipient list and email text for this group</span>
                  </label>
                </div>
              </div>
            <% end %>

            <% if not_scheduled_requests.any? %>
              <%# Panel 2: Not Invited %>
              <div data-tabs-target="panel" class="<%= 'hidden' if has_both_groups %>">
                <div class="mb-4">
                  <h5 class="text-sm font-semibold text-gray-900 mb-3">People/Groups not being invited to audition:</h5>
                  <div class="flex flex-wrap gap-2 mb-4">
                    <% not_scheduled_requests.each do |request| %>
                      <% requestable = request.requestable %>
                      <% headshot_variant = requestable.safe_headshot_variant(:thumb) if requestable.respond_to?(:safe_headshot_variant) %>
                      <div class="inline-flex items-center gap-2 px-2 py-1 rounded text-xs font-medium border border-gray-200">
                        <% if headshot_variant %>
                          <%= image_tag headshot_variant, alt: requestable.name, class: "w-5 h-5 rounded object-cover flex-shrink-0", draggable: false %>
                        <% else %>
                          <div class="w-5 h-5 rounded bg-gray-200 flex items-center justify-center text-black font-bold text-xs flex-shrink-0">
                            <%= requestable.is_a?(Person) ? requestable.initials : raw('<i class="fa-solid fa-users text-xs"></i>') %>
                          </div>
                        <% end %>
                        <span><%= requestable.name %></span>
                      </div>
                    <% end %>
                  </div>
                  <%= fields_for :not_invited_email_draft, EmailDraft.new(title: ContentTemplate.find_by(key: "audition_not_invited")&.subject || "Auditions", body: ContentTemplateService.render_body("audition_not_invited", { recipient_name: "[Name]", production_name: @production.name })) do |email_form| %>
                    <div class="space-y-3">
                      <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Subject</label>
                        <%= email_form.text_field :title, class: "block w-full rounded-lg border border-gray-300 px-3 py-2 text-gray-900 placeholder:text-gray-400 focus:border-pink-500 focus:ring-pink-500 text-sm", placeholder: "Email subject..." %>
                      </div>
                      <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Body</label>
                        <%= email_form.rich_text_area :body, class: "w-full rounded-lg border border-gray-300 focus:ring-2 focus:ring-pink-500 focus:border-transparent" %>
                      </div>
                    </div>
                  <% end %>
                </div>
                <%# Review checkbox for not invited group %>
                <div class="mt-6 pt-4 border-t border-gray-200">
                  <label class="flex items-center gap-3 cursor-pointer">
                    <input type="checkbox"
                           data-tabs-target="reviewCheckbox"
                           data-action="change->tabs#checkAllReviewed"
                           class="w-4 h-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                    <span class="text-sm text-gray-700">I have reviewed the recipient list and email text for this group</span>
                  </label>
                </div>
              </div>
            <% end %>

            <%# Send notifications section (shown when all groups are reviewed) %>
            <div
              data-tabs-target="sendSection"
              class="hidden mt-6 p-4 bg-pink-50 border border-pink-200 rounded-lg"
            >
              <h4 class="text-sm font-semibold text-gray-900 mb-2">Ready to Send Notifications</h4>
              <p class="text-sm text-gray-700 mb-4">
                All email groups have been reviewed. Click the button below to send notification emails to all applicants about their audition status.
              </p>
              <%= form_with url: manage_finalize_and_notify_invitations_signups_auditions_cycle_path(@production, @audition_cycle), method: :post, local: true do %>
                <%= render "shared/button",
                  text: "Send Audition Invitation Notifications",
                  variant: "primary",
                  size: "medium",
                  type: :submit %>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
    <% end %>

  <% end %>
</div>
