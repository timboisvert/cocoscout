<% content_for :title, "Notification Preferences" %>

<div class="w-full">
  <div id="notice-container">
    <%= render partial: "shared/notice", locals: { notice: notice, alert: alert } %>
  </div>

  <% if Current.user.superadmin? %>
  <!-- Text Message Notifications Section (Superadmin Only) -->
  <div class="bg-white border-2 border-dashed border-orange-300 rounded-lg overflow-hidden mb-6 relative">
    <div class="absolute top-3 right-3 z-10">
      <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
        </svg>
        Superadmin Only
      </span>
    </div>
    <%= render "shared/card_header", title: "Text Message Notifications" %>
    <div class="p-6">
      <p class="text-sm text-gray-600 mb-6">
        Get important CocoScout notifications via text message. You must verify your phone number to enable text notifications.
      </p>

      <% if Current.user.phone_verified? %>
        <!-- Phone is verified - show current number and preferences -->
        <div class="mb-6 p-4 bg-pink-50 border border-pink-200 rounded-lg">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-pink-200">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 text-pink-700">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </span>
              <div>
                <p class="text-sm font-medium text-pink-800">Phone Verified</p>
                <p class="text-sm text-pink-700"><%= Current.user.formatted_sms_phone %></p>
              </div>
            </div>
            <%= button_to remove_sms_path, method: :delete, class: "text-sm text-red-600 hover:text-red-800 font-medium", data: { turbo_confirm: "Are you sure you want to remove your phone number? Text notifications will be disabled." } do %>
              Remove
            <% end %>
          </div>
        </div>

        <!-- SMS Preferences Form -->
        <%= form_with url: update_sms_preferences_path, method: :patch, class: "space-y-4" do |f| %>
          <!-- Master SMS Toggle -->
          <div class="flex items-center justify-between py-3 border-b border-gray-100">
            <div>
              <p class="text-sm font-medium text-gray-700">Enable Text Notifications</p>
              <p class="text-xs text-gray-500 mt-1">Turn on to receive text messages for enabled notifications below</p>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="hidden" name="sms_notifications[enabled]" value="0">
              <input type="checkbox"
                     name="sms_notifications[enabled]"
                     value="1"
                     <%= 'checked' if Current.user.notification_preferences['sms_enabled'] != false %>
                     class="sr-only peer">
              <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
            </label>
          </div>

          <!-- Show Cancellations -->
          <div class="flex items-center justify-between py-3 border-b border-gray-100">
            <div>
              <p class="text-sm font-medium text-gray-700">Show Cancellations</p>
              <p class="text-xs text-gray-500 mt-1">Get texted immediately when a show you're cast in is cancelled</p>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="hidden" name="sms_notifications[show_cancellation]" value="0">
              <input type="checkbox"
                     name="sms_notifications[show_cancellation]"
                     value="1"
                     <%= 'checked' if Current.user.notification_preferences['sms_show_cancellation'] != false %>
                     class="sr-only peer">
              <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
            </label>
          </div>

          <!-- Vacancy Notifications -->
          <div class="flex items-center justify-between py-3 border-b border-gray-100">
            <div>
              <p class="text-sm font-medium text-gray-700">Vacancy Notifications</p>
              <p class="text-xs text-gray-500 mt-1">Get texted when you're invited to fill an open vacancy</p>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="hidden" name="sms_notifications[vacancy_notification]" value="0">
              <input type="checkbox"
                     name="sms_notifications[vacancy_notification]"
                     value="1"
                     <%= 'checked' if Current.user.notification_preferences['sms_vacancy_notification'] != false %>
                     class="sr-only peer">
              <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
            </label>
          </div>

          <div class="pt-4">
            <%= render "shared/button", text: "Save Text Message Preferences", type: :submit, variant: "primary" %>
          </div>
        <% end %>

      <% elsif Current.user.phone_verification_pending? %>
        <!-- Verification pending - show code entry form -->
        <div class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
          <div class="flex items-start gap-3">
            <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-yellow-200 flex-shrink-0 mt-0.5">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 text-yellow-700">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </span>
            <div>
              <p class="text-sm font-medium text-yellow-800">Verification Code Sent</p>
              <p class="text-sm text-yellow-700">
                We sent a 6-digit code to
                <strong><%= "(#{Current.user.phone_pending_verification[0..2]}) #{Current.user.phone_pending_verification[3..5]}-#{Current.user.phone_pending_verification[6..9]}" %></strong>.
                Enter it below to verify your number.
              </p>
              <p class="text-xs text-yellow-600 mt-1">
                Code expires in <%= distance_of_time_in_words(Time.current, Current.user.phone_verification_sent_at + 10.minutes) %>.
              </p>
            </div>
          </div>
        </div>

        <% if SmsService.test_mode? && Current.user.phone_verification_code.present? %>
        <div class="mb-4 p-3 bg-orange-50 border border-orange-200 rounded-lg">
          <p class="text-sm font-medium text-orange-800">ðŸ§ª Test Mode - Your Verification Code:</p>
          <p class="text-2xl font-mono font-bold text-orange-900 tracking-widest"><%= Current.user.phone_verification_code %></p>
        </div>
        <% end %>

        <%= form_with url: verify_sms_path, method: :post, class: "mb-6" do |f| %>
          <div class="flex items-end gap-3">
            <div>
              <label for="verification_code" class="block text-sm font-medium text-gray-700 mb-1">Verification Code</label>
              <input type="text"
                     id="verification_code"
                     name="verification_code"
                     placeholder="123456"
                     maxlength="6"
                     pattern="[0-9]{6}"
                     inputmode="numeric"
                     autocomplete="one-time-code"
                     class="w-32 rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-pink-500 focus:ring-pink-500 text-center text-lg tracking-widest font-mono">
            </div>
            <%= render "shared/button", text: "Verify", type: :submit, variant: "primary" %>
          </div>
        <% end %>

        <!-- Option to resend or use different number -->
        <div class="flex gap-4 text-sm">
          <%= form_with url: send_sms_verification_path, method: :post, class: "inline" do |f| %>
            <input type="hidden" name="phone" value="<%= Current.user.phone_pending_verification %>">
            <%= render "shared/button", text: "Resend Code", type: :submit, variant: "ghost", size: "small" %>
          <% end %>
          <button type="button" onclick="document.getElementById('change-phone-form').classList.toggle('hidden')" class="text-gray-500 hover:text-gray-700">
            Use different number
          </button>
        </div>

        <!-- Hidden form to change number -->
        <div id="change-phone-form" class="hidden mt-4 p-4 bg-gray-50 rounded-lg">
          <%= form_with url: send_sms_verification_path, method: :post do |f| %>
            <label for="new_phone" class="block text-sm font-medium text-gray-700 mb-1">New Phone Number</label>
            <div class="flex items-center gap-2">
              <span class="text-gray-500 text-sm">+1</span>
              <input type="tel"
                     id="new_phone"
                     name="phone"
                     placeholder="(555) 123-4567"
                     inputmode="tel"
                     class="w-48 rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-pink-500 focus:ring-pink-500">
              <%= render "shared/button", text: "Send Code", type: :submit, variant: "primary", size: "small" %>
            </div>
          <% end %>
        </div>

      <% else %>
        <!-- No phone - show phone entry form -->
        <%= form_with url: send_sms_verification_path, method: :post do |f| %>
          <div class="mb-6">
            <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
            <div class="flex items-center gap-2">
              <span class="text-gray-500 text-sm">+1</span>
              <input type="tel"
                     id="phone"
                     name="phone"
                     placeholder="(555) 123-4567"
                     inputmode="tel"
                     autocomplete="tel-national"
                     class="w-48 rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-pink-500 focus:ring-pink-500">
              <%= render "shared/button", text: "Send Verification Code", type: :submit, variant: "primary" %>
            </div>
            <p class="text-xs text-gray-500 mt-2">US phone numbers only (10 digits). We'll send a code to verify your number.</p>
          </div>
        <% end %>
      <% end %>

      <!-- SMS Consent Disclosures -->
      <div class="mt-6 p-4 bg-gray-50 rounded-lg text-xs text-gray-500 space-y-2">
        <p>Text messages are reserved for urgent, time-sensitive notifications only:</p>
        <ul class="list-disc list-inside ml-2 space-y-1">
          <li>Show cancellations (when a show you're cast in is cancelled)</li>
          <li>Vacancy invitations (when you're invited to fill an open spot)</li>
        </ul>
        <p>Message frequency varies based on your activity (typically 0-5 messages per month). Message and data rates may apply. Reply STOP to opt out at any time. Reply HELP for assistance.</p>
        <p>
          View our
          <%= link_to "Terms of Service", "/terms", class: "text-pink-600 hover:text-pink-800 underline", target: "_blank" %>
          and
          <%= link_to "Privacy Policy", "/privacy", class: "text-pink-600 hover:text-pink-800 underline", target: "_blank" %>.
        </p>
      </div>
    </div>
  </div>
  <% end %>

  <!-- Email Notifications Section -->
  <%= form_with(url: account_notifications_path, method: :patch, data: { turbo: true }) do |f| %>
    <div class="bg-white border border-gray-200 rounded-lg overflow-hidden mb-6">
      <%= render "shared/card_header", title: "Email Notifications" %>
      <div class="p-6">
        <p class="text-sm text-gray-600 mb-6">
          Control which email notifications you receive from CocoScout.
        </p>

        <div class="space-y-4">
          <div class="flex items-center justify-between py-3 border-b border-gray-100">
            <div>
              <p class="text-sm font-medium text-gray-700">Open Vacancy Invitations</p>
              <p class="text-xs text-gray-500 mt-1">Get notified when you're invited to fill an open vacancy</p>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="hidden" name="notifications[vacancy_invitations]" value="0">
              <input type="checkbox" name="notifications[vacancy_invitations]" value="1" <%= 'checked' if Current.user.notification_enabled?(:vacancy_invitations) %> class="sr-only peer">
              <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
            </label>
          </div>

          <div class="flex items-center justify-between py-3 border-b border-gray-100">
            <div>
              <p class="text-sm font-medium text-gray-700">Audition Invitations</p>
              <p class="text-xs text-gray-500 mt-1">Get notified when you're invited to audition</p>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="hidden" name="notifications[audition_invitations]" value="0">
              <input type="checkbox" name="notifications[audition_invitations]" value="1" <%= 'checked' if Current.user.notification_enabled?(:audition_invitations) %> class="sr-only peer">
              <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
            </label>
          </div>

          <div class="flex items-center justify-between py-3 border-b border-gray-100">
            <div>
              <p class="text-sm font-medium text-gray-700">Group Invitations</p>
              <p class="text-xs text-gray-500 mt-1">Get notified when you're invited to join a group</p>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="hidden" name="notifications[group_invitations]" value="0">
              <input type="checkbox" name="notifications[group_invitations]" value="1" <%= 'checked' if Current.user.notification_enabled?(:group_invitations) %> class="sr-only peer">
              <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
            </label>
          </div>

          <div class="flex items-center justify-between py-3 border-b border-gray-100">
            <div>
              <p class="text-sm font-medium text-gray-700">Shoutouts</p>
              <p class="text-xs text-gray-500 mt-1">Get notified when someone sends you a shoutout</p>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="hidden" name="notifications[shoutouts]" value="0">
              <input type="checkbox" name="notifications[shoutouts]" value="1" <%= 'checked' if Current.user.notification_enabled?(:shoutouts) %> class="sr-only peer">
              <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
            </label>
          </div>

          <div class="flex items-center justify-between py-3">
            <div>
              <p class="text-sm font-medium text-gray-700">Message Digest</p>
              <p class="text-xs text-gray-500 mt-1">Get reminded about unread messages (adapts to your engagement: daily if you check, less often if you don't)</p>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="hidden" name="notifications[message_digest]" value="0">
              <input type="checkbox" name="notifications[message_digest]" value="1" <%= 'checked' if Current.user.message_digest_enabled %> class="sr-only peer">
              <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
            </label>
          </div>
        </div>

        <div class="mt-6">
          <%= render "shared/button", text: "Save Email Preferences", type: :submit, variant: "primary" %>
        </div>
      </div>
    </div>
  <% end %>
</div>
