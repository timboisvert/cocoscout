<% content_for :title, "My Sign-ups" %>

<div class="w-full">

  <%= render partial: "shared/notice", locals: { notice: notice } %>

  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [],
    text: "My Sign-ups",
    links: []
  } %>

  <%= render "shared/filters/filter_bar",
      toggle_label: "Filters",
      filter_groups: [
        {
          label: "View",
          filters: [
            {
              text: "Open Windows",
              path: my_sign_ups_path(requests_filter: "open", entity: @entity_filter.join(",")),
              active: @requests_filter == "open"
            },
            {
              text: "All",
              path: my_sign_ups_path(requests_filter: "all", entity: @entity_filter.join(",")),
              active: @requests_filter == "all"
            }
          ]
        },
        { separator: true },
        {
          partial: "shared/filters/entity_filter",
          locals: {
            path_helper: method(:my_sign_ups_path),
            people: @people,
            groups: @groups,
            entity_filter: @entity_filter,
            label: "Include",
            requests_filter: @requests_filter
          }
        }
      ]
  %>

  <% if @combined_items.any? %>
    <div class="space-y-2 mt-4">
      <% @combined_items.each do |item| %>
        <% if item[:type] == :sign_up_registrations %>
          <% registrations = item[:records] %>
          <% first_reg = registrations.first %>
          <% form = first_reg.sign_up_slot&.sign_up_form %>
          <% production = form&.production %>
          <% next unless form && production %>

          <% is_open = form.status_service&.accepting_registrations? %>

          <%# Get the show - for single_event use form.show, for repeated use instance.show %>
          <%
            instance = first_reg.sign_up_slot&.sign_up_form_instance
            single_show = instance&.show || form.show
          %>

          <div class="flex items-stretch px-3 py-2 border rounded-lg bg-white border-gray-200 hover:border-gray-400 transition-all">
            <div class="flex flex-col md:flex-row md:items-center gap-2 md:gap-0 w-full">
              <%# Left Section: Date & Details %>
              <div class="w-full md:w-1/2 flex items-center gap-4">
                <% if single_show %>
                  <%# Date Box for event-tied registrations %>
                  <div class="flex-shrink-0 w-14 text-center">
                    <div class="text-xs font-semibold text-pink-600 uppercase"><%= single_show.date_and_time.strftime("%b") %></div>
                    <div class="text-2xl font-bold text-gray-900"><%= single_show.date_and_time.strftime("%-d") %></div>
                    <div class="text-xs text-gray-500"><%= single_show.date_and_time.strftime("%a") %></div>
                  </div>

                  <%# Show Details %>
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 flex-wrap">
                      <span class="font-medium text-gray-900">
                        <%= single_show.secondary_name.presence || single_show.event_type.titleize %>
                      </span>
                    </div>
                    <div class="text-sm text-gray-600">
                      <%= single_show.date_and_time.strftime("%l:%M %p").strip %>
                      <% if single_show.location.present? %>
                        · <%= single_show.location.name %>
                      <% elsif single_show.is_online %>
                        · Online
                      <% end %>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">
                      <%= production.name %>
                    </div>
                  </div>
                <% else %>
                  <%# No show or multiple shows - show form name %>
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 flex-wrap">
                      <span class="font-medium text-gray-900"><%= form.name %></span>
                    </div>
                    <div class="text-sm text-gray-600"><%= production.name %></div>
                  </div>
                <% end %>
              </div>

              <%# Right Section: Status & Actions %>
              <div class="w-full md:w-1/2 flex items-center border-t border-gray-100 md:border-t-0 mt-2 md:mt-0 pt-2 md:pt-0 md:border-l md:border-gray-200 md:pl-4">
                <div class="flex-1 min-w-0">
                  <% if form.slot_generation_mode == 'open_list' %>
                    <%# Open list - show status instead of slot numbers %>
                    <%
                      # Check if any registration is on waitlist
                      on_waitlist = registrations.any? { |r| r.status == 'waitlisted' }
                    %>
                    <div class="text-[10px] text-gray-400 uppercase tracking-wide">Status</div>
                    <div class="text-sm font-medium <%= on_waitlist ? 'text-amber-600' : 'text-green-600' %>">
                      <%= on_waitlist ? 'On Waitlist' : 'Signed Up' %>
                    </div>
                  <% else %>
                    <%# Numbered/time-based slots - show slot info %>
                    <div class="text-[10px] text-gray-400 uppercase tracking-wide">
                      <%= registrations.size == 1 ? "Your Position" : "Your Positions" %>
                    </div>
                    <% if registrations.size == 1 %>
                      <div class="text-sm font-medium text-gray-900"><%= first_reg.sign_up_slot&.display_name %></div>
                    <% else %>
                      <div class="text-sm font-medium text-gray-900">
                        <%= registrations.map { |r| r.sign_up_slot&.display_name }.compact.join(", ") %>
                      </div>
                    <% end %>
                  <% end %>
                  <% if is_open %>
                    <%
                      # For repeated events, include instance_id so they go to the right date
                      link_params = form.scope == 'repeated' && instance ? { instance_id: instance.id } : {}
                    %>
                    <%= link_to my_sign_up_form_path(form.short_code, **link_params), class: "text-xs text-pink-500 hover:text-pink-600 underline" do %>
                      View Registration
                    <% end %>
                  <% else %>
                    <span class="text-xs text-gray-400">Window closed</span>
                  <% end %>
                </div>

                <% if @groups.any? %>
                  <%# Collect all unique entities from all registrations %>
                  <%
                    all_entities = registrations.flat_map { |r| @sign_up_registration_entities[r.id] || [] }.uniq { |e| [e[:type], e[:entity].id] }
                  %>
                  <% if all_entities.any? %>
                    <div class="flex flex-col gap-1 ml-3">
                      <% all_entities.each do |entity_info| %>
                        <% headshot = entity_info[:entity].safe_headshot_variant(:thumb) %>
                        <% if headshot %>
                          <%= image_tag headshot, class: "w-8 h-8 rounded-lg object-cover", alt: entity_info[:entity].try(:preferred_name) || entity_info[:entity].name %>
                        <% end %>
                      <% end %>
                    </div>
                  <% end %>
                <% end %>
              </div>
            </div>
          </div>

        <% elsif item[:type] == :audition_request %>
          <% audition_request = item[:record] %>
          <% cycle = audition_request.audition_cycle %>
          <% production = cycle.production %>
          <% is_open = cycle.editable_by_talent? %>

          <div class="flex items-stretch px-4 py-3 border rounded-lg bg-white border-gray-200 hover:border-gray-400 transition-all">
            <div class="flex flex-col md:flex-row md:items-center gap-3 md:gap-0 w-full">
              <%# Left Section: Production Info %>
              <div class="w-full md:w-1/2 flex items-center gap-4">
                <div class="flex-1 min-w-0">
                  <div class="text-lg font-medium text-gray-900"><%= production.name %></div>
                  <div class="text-sm text-gray-600">
                    <% if cycle.video_only? %>
                      Video Audition
                    <% else %>
                      In-Person Audition
                    <% end %>
                  </div>
                </div>
              </div>

              <%# Right Section: Status & Actions %>
              <div class="w-full md:w-1/2 flex items-center border-t border-gray-100 md:border-t-0 mt-2 md:mt-0 pt-2 md:pt-0 md:border-l md:border-gray-200 md:pl-4">
                <div class="flex-1 min-w-0">
                  <% if is_open %>
                    <%# Window is open - show green status badge %>
                    <div class="mb-2">
                      <% if cycle.video_only? %>
                        <span class="inline-flex items-center bg-green-500 text-white px-2.5 py-1 text-sm font-medium rounded">
                          Video Submitted
                        </span>
                      <% else %>
                        <span class="inline-flex items-center bg-green-500 text-white px-2.5 py-1 text-sm font-medium rounded">
                          Signed Up
                        </span>
                      <% end %>
                    </div>
                    <div class="text-sm text-gray-500">
                      <% if cycle.closes_at.present? && cycle.closes_at > 1.day.from_now %>
                        You can edit until <%= cycle.closes_at.strftime('%b %d') %> at <%= cycle.closes_at.strftime('%l:%M %p') %>.
                      <% elsif cycle.closes_at.present? %>
                        <span data-controller="countdown" data-countdown-until-value="<%= cycle.closes_at.utc.iso8601 %>">
                          You can edit for <span data-countdown-target="clock" class="<%= cycle.closes_at < 4.hours.from_now ? 'text-red-500' : 'text-pink-500' %>"></span>.
                        </span>
                      <% else %>
                        No deadline — edit whenever you need to.
                      <% end %>
                    </div>
                    <%
                      edit_url = if @groups.any?
                        my_submit_audition_request_form_path(
                          cycle.token,
                          requestable_type: audition_request.requestable_type,
                          requestable_id: audition_request.requestable_id
                        )
                      else
                        my_submit_audition_request_form_path(cycle.token)
                      end
                    %>
                    <%= link_to "Edit Sign-up", edit_url, class: "text-xs text-pink-500 hover:text-pink-600 underline mt-1 inline-block" %>
                  <% else %>
                    <%# Window is closed - show final status %>
                    <div class="mb-1">
                      <% if cycle.video_only? %>
                        <%= video_audition_status_name(audition_request) %>
                      <% else %>
                        <%= in_person_signup_status_name(audition_request) %>
                      <% end %>
                    </div>
                    <div class="text-sm text-gray-500">
                      <% if cycle.video_only? %>
                        <%= video_audition_status_text(audition_request) %>
                      <% else %>
                        <%= in_person_signup_status_text(audition_request) %>
                      <% end %>
                    </div>
                  <% end %>
                </div>

                <% if @groups.any? && @audition_request_entities[audition_request.id].present? %>
                  <div class="flex flex-col gap-1 ml-4">
                    <% @audition_request_entities[audition_request.id].each do |entity_info| %>
                      <% headshot = entity_info[:entity].safe_headshot_variant(:thumb) %>
                      <% if headshot %>
                        <%= image_tag headshot, class: "w-10 h-10 rounded-lg object-cover", alt: entity_info[:entity].try(:preferred_name) || entity_info[:entity].name %>
                      <% end %>
                    <% end %>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      <% end %>
    </div>
  <% else %>
    <p class="text-gray-500 text-sm pt-4">
      <% if @requests_filter == "all" %>
        You haven't signed up for any auditions or events yet.
      <% elsif @requests_filter == "open" %>
        You don't have any sign-ups in currently open windows.
      <% end %>
    </p>
  <% end %>

</div>
