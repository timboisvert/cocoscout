<%# Message row partial %>
<%
  subscription = Current.user.message_subscriptions.find_by(message: message)
  is_unread = subscription&.unread?
%>
<%= link_to my_message_path(message), class: "block hover:bg-gray-50 transition-colors border-b border-gray-200 last:border-b-0" do %>
  <div class="flex items-start gap-3 p-4 <%= is_unread ? 'bg-pink-50 border-l-4 border-l-pink-500' : 'bg-white border-l-4 border-l-transparent' %>">
    <%# Sender avatar - uses shared partial for production team vs personal avatar %>
    <% sender_person = message.sender.is_a?(Person) ? message.sender : message.sender.person %>
    <%= render "shared/messages/message_avatar", message: message, sender_person: sender_person, size: :medium %>

    <div class="flex-1 min-w-0">
      <div class="flex items-center gap-2 flex-wrap mb-1">
        <span class="font-medium text-gray-900"><%= message.sender_name %></span>
        <% if message.production.present? %>
          <span class="text-xs text-purple-700 bg-purple-100 px-2 py-0.5 rounded-full">
            <%= message.production.name.truncate(20) %>
          </span>
        <% end %>
        <% if message.recipient_count > 1 %>
          <span class="text-xs text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full">
            +<%= message.recipient_count - 1 %> others
          </span>
        <% end %>
      </div>
      <p class="text-gray-900 font-medium truncate"><%= message.subject %></p>
      <p class="text-sm text-gray-500"><%= time_ago_in_words(message.created_at) %> ago</p>
    </div>

    <% if is_unread %>
      <span class="w-3 h-3 bg-pink-500 rounded-full flex-shrink-0 mt-1"></span>
    <% end %>
  </div>
<% end %>
