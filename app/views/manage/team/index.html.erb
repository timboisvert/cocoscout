<% content_for :title, "Production Team" %>

<div class="w-full">

  <%= render partial: "shared/notice", locals: { notice: notice } %>

  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [],
    text: "Production Team",
    links: []
  } %>

<%= render "shared/help_section",
  title: "About Production Team Members",
  initial_state: "open",
  storage_key: "team_help_collapsed",
  steps: [
    { text: "This page is for inviting <strong>production team members</strong> (co-producers, production assistants, etc.) who need access to manage productions in CocoScout." },
    { text: "This is <strong>not</strong> for adding talent/performers to your cast. Use the <strong>Directory</strong> for inviting performers." },
    { text: "After inviting someone, you can click <strong>Manage Permissions</strong> to control what they can view and manage." }
  ] %>

<div class="flex flex-col md:flex-row gap-2 mt-4">

    <div class="flex-1 space-y-2">

        <% @members.each do |member| %>
            <% organization_role = member.organization_roles.find_by(organization: Current.organization) %>
            <div class="p-4 bg-white border border-gray-200 rounded-lg hover:border-gray-400 transition-all flex" data-controller="team-remove" data-team-remove-target="row">

                <div class="<%= current_user_can_manage? ? 'w-2/3' : 'w-full' %>">
                    <div class="h-full flex flex-col justify-center">
                        <div class="">
                            <div class="font-bold text-md">
                                <%= member.person.name %>
                                <% if member == Current.user %>
                                    <span class="ml-1 text-sm text-gray-500">(Me)</span>
                                <% end %>
                            </div>
                            <div class="text-sm text-gray-500"><%= member.email_address %></div>
                        </div>
                        <% if current_user_is_global_manager? && member != Current.user %>
                            <%= link_to "Manage Permissions", permissions_manage_team_path(member), class: "mt-1 text-xs text-pink-500 underline" %>
                        <% end %>
                    </div>
                </div>

                <% if current_user_is_global_manager? %>
                    <div class="w-1/3 flex items-center justify-end text-sm text-gray-500">
                        <% role_display = case organization_role&.company_role
                             when 'manager' then 'Manager'
                             when 'viewer' then 'Viewer'
                             when 'none' then 'Per-production access'
                             else 'Unknown'
                             end %>
                        <%= role_display %>
                    </div>
                <% end %>
            </div>
        <% end %>

        <% if current_user_is_global_manager? && @team_invitations.any? %>
            <% @team_invitations.each do |invite| %>
                <div class="p-4 border border-gray-200 rounded-lg hover:border-gray-400 transition-all flex">
                    <div class="w-2/3">
                        <div class="h-full flex flex-col justify-center">
                            <div class="flex items-center">
                                <p class=""><%= invite.email %></p>
                            </div>
                            <%= button_to "Revoke Invitation", revoke_invite_manage_team_index_path(id: invite.id), method: :delete, data: { turbo_confirm: "Are you sure?" }, class: "text-xs text-pink-500 underline mt-1 cursor-pointer w-fit" %>
                        </div>
                    </div>
                    <div class="w-1/3 flex items-center justify-end text-gray-500">
                        <span class="ml-2 text-xs text-gray-500 bg-yellow-100 px-2 py-1 rounded">Pending Invitation</span>
                    </div>
                </div>
            <% end %>
        <% end %>

    </div>

    <% if current_user_is_global_manager? %>
        <div class="flex-1">

            <div class="sticky top-4 border border-gray-200 rounded-lg overflow-hidden">
                <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 flex items-center justify-between">
                    <h3 class="text-md font-semibold text-gray-900 coustard-regular">Invite a Team Member</h3>
                </div>
                <div class="p-4">
                    <% if @team_invitation_error %>
                        <p class="text-sm text-pink-500 mb-2">Email address is required</p>
                    <% end %>

                    <%= form_with(model: @team_invitation, url: invite_manage_team_index_path, method: :post) do |f| %>
                        <div class="mb-4">
                            <%= f.label :email, "Email Address:", class: "block font-semibold mb-2 text-sm" %>
                            <%= f.email_field :email, placeholder: "Email address", autocapitalize: "none", class: "block shadow-sm rounded-lg border border-gray-400 px-3 py-2 w-full focus:border-pink-500 focus:ring-pink-500 text-sm" %>
                        </div>

                        <div class="mb-4">
                            <%= f.label :invitation_subject, "Email Subject:", class: "block font-semibold mb-2 text-sm" %>
                            <% default_subject = "You've been invited to join #{Current.organization.name}'s team on CocoScout" %>
                            <%= f.text_field :invitation_subject, value: default_subject, class: "block shadow-sm rounded-lg border border-gray-400 px-3 py-2 w-full focus:border-pink-500 focus:ring-pink-500 text-sm" %>
                        </div>

                        <div class="mb-4">
                            <%= f.label :invitation_message, "Email Message:", class: "block font-semibold mb-2 text-sm" %>
                            <% default_message = "Welcome to CocoScout!\n\n#{Current.organization.name} is using CocoScout to manage its productions. You've been invited to join the team.\n\nClick the link below to accept the invitation and sign in or create an account." %>
                            <%= f.text_area :invitation_message, value: default_message, rows: 6, class: "block shadow-sm rounded-lg border border-gray-400 px-3 py-2 w-full focus:border-pink-500 focus:ring-pink-500 text-sm" %>
                            <p class="mt-2 text-xs text-gray-500">
                                The invitation link will be automatically included in the email.
                            </p>
                        </div>

                        <%= f.submit "Send Invite", class: "w-full px-3 py-2 rounded-lg bg-pink-500 text-white font-bold hover:bg-pink-600 cursor-pointer" %>
                    <% end %>
                </div>
            </div>

        </div>
    <% end %>

  </div>

</div>
