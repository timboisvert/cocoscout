<% content_for :title, "Claim Role" %>

<div class="min-h-screen bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
  <div class="max-w-md mx-auto">
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-2xl font-bold text-gray-900">You're Invited!</h1>
      <p class="mt-2 text-sm text-gray-600">
        You've been invited to fill a role in <%= @production.name %>.
      </p>
    </div>

    <!-- Flash Messages -->
    <% if flash[:alert] %>
      <div class="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg">
        <p class="text-sm text-red-600"><%= flash[:alert] %></p>
      </div>
    <% end %>

    <% if @invitation.claimed? %>
      <!-- Already Claimed -->
      <div class="bg-white shadow rounded-lg p-6 text-center">
        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
          <svg class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
          </svg>
        </div>
        <h2 class="text-lg font-semibold text-gray-900 mb-2">Already Claimed</h2>
        <p class="text-gray-600 text-sm">You've already claimed this role. See you at the show!</p>
      </div>

    <% elsif @invitation.expired? %>
      <!-- Expired -->
      <div class="bg-white shadow rounded-lg p-6 text-center">
        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-gray-100 mb-4">
          <svg class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
          </svg>
        </div>
        <h2 class="text-lg font-semibold text-gray-900 mb-2">No Longer Available</h2>
        <p class="text-gray-600 text-sm">This role has already been filled or the vacancy was cancelled.</p>
      </div>

    <% else %>
      <!-- Show Info -->
      <div class="bg-white shadow rounded-lg p-4 mb-6">
        <div class="flex items-center gap-4">
          <% poster_url = safe_poster_url(@show) %>
          <% if poster_url %>
            <%= image_tag poster_url,
                alt: @production.name,
                class: "w-16 h-24 object-cover rounded-lg" %>
          <% end %>
          <div>
            <h2 class="font-semibold text-gray-900"><%= @production.name %></h2>
            <% unless @show.linked? %>
              <p class="text-sm text-gray-600"><%= @show.date_and_time.strftime("%A, %B %d, %Y at %l:%M %p") %></p>
              <p class="text-xs text-pink-600 font-medium"><%= @show.secondary_name.presence || @show.event_type.titleize %></p>
              <% if @show.location %>
                <p class="text-xs text-gray-500"><%= @show.location.name %></p>
              <% end %>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Role Card -->
      <div class="bg-white shadow rounded-lg overflow-hidden mb-6">
        <div class="p-4 bg-pink-50">
          <div class="text-xs text-pink-600 uppercase tracking-wide font-semibold mb-1">Role</div>
          <div class="text-xl font-bold text-gray-900"><%= @role.name %></div>
        </div>
      </div>

      <% if @show.linked? %>
        <% linked_shows = @show.event_linkage.shows.order(:date_and_time).to_a %>
        <% if linked_shows.any? %>
          <div class="bg-white shadow rounded-lg overflow-hidden mb-6">
            <div class="p-4 border-b border-gray-200">
              <p class="text-sm font-medium text-gray-700">This event is linked to other events</p>
              <p class="text-xs text-gray-500 mt-1">By claiming this role, you're confirming availability for all of these events:</p>
            </div>

            <div class="divide-y divide-gray-100">
              <% linked_shows.each do |event_show| %>
                <% is_past = event_show.date_and_time < Time.current %>
                <div class="flex items-center gap-3 p-4 <%= 'opacity-50' if is_past %>">
                  <div class="flex-shrink-0 w-5 h-5 rounded-full <%= is_past ? 'bg-gray-300' : 'bg-pink-500' %> flex items-center justify-center">
                    <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                  </div>
                  <div class="flex-1">
                    <p class="text-sm font-medium <%= is_past ? 'text-gray-400' : 'text-gray-900' %>">
                      <%= event_show.date_and_time.strftime("%A, %B %d") %>
                      <span class="<%= is_past ? 'text-gray-400' : 'text-gray-500' %> font-normal">at <%= event_show.date_and_time.strftime("%l:%M %p").strip %></span>
                    </p>
                    <p class="text-xs <%= is_past ? 'text-gray-400' : 'text-gray-500' %>">
                      <%= event_show.secondary_name.presence || event_show.event_type.titleize %>
                    </p>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      <% end %>

      <!-- Other Cast Members -->
      <% if @other_cast_assignments.any? %>
        <div class="bg-white shadow rounded-lg overflow-hidden mb-6">
          <div class="p-4 border-b border-gray-200">
            <p class="text-sm font-medium text-gray-700">Who else is in the cast?</p>
          </div>
          <div class="p-4">
            <div class="space-y-2">
              <% @other_cast_assignments.each do |assignment| %>
                <% assignable = assignment.assignable %>
                <div class="flex items-center gap-2">
                  <% headshot_variant = assignable.safe_headshot_variant(:thumb) %>
                  <% if headshot_variant %>
                    <%= image_tag headshot_variant, class: "w-8 h-8 rounded-full object-cover flex-shrink-0" %>
                  <% else %>
                    <div class="w-8 h-8 rounded-full <%= assignable.is_a?(Person) ? 'bg-gray-200 text-gray-700' : 'bg-blue-100 text-blue-600' %> flex items-center justify-center font-bold text-xs flex-shrink-0">
                      <% if assignable.is_a?(Person) %>
                        <%= assignable.initials %>
                      <% else %>
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                          <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-7 8c0-2.66 5.33-4 8-4s8 1.34 8 4v2H5v-2z"/>
                        </svg>
                      <% end %>
                    </div>
                  <% end %>
                  <div class="text-sm">
                    <span class="font-medium text-gray-900"><%= assignable.name %></span>
                    <span class="text-gray-400 mx-1">as</span>
                    <span class="text-pink-500"><%= assignment.role.name %></span>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>

      <!-- Action Buttons -->
      <div class="space-y-3">
        <%= form_with url: do_claim_vacancy_path(@invitation.token), method: :post do %>
          <%= render "shared/button", text: "Claim This Role", variant: "primary", size: "jumbo", type: :submit %>
        <% end %>

        <%= form_with url: decline_claim_vacancy_path(@invitation.token), method: :post do %>
          <%= render "shared/button", text: "Decline", variant: "secondary", size: "jumbo", type: :submit %>
        <% end %>
      </div>

      <p class="text-center text-xs text-gray-500 mt-4">
        By claiming this role, you're confirming your availability for <%= @show.linked? ? "all of these events" : "this show" %>.
      </p>
    <% end %>
  </div>
</div>
