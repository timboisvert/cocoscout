<%
  # Calculate step number based on scope
  step_num = @wizard_state[:scope] == "shared_pool" ? 3 : 4
  is_waitlist = @wizard_state[:scope] == "shared_pool"
  is_open_list = @wizard_state[:slot_generation_mode] == "open_list"

  # Default require_login to true if not set
  require_login_checked = @wizard_state[:require_login].nil? ? true : @wizard_state[:require_login]

  # Default cutoff modes
  edit_cutoff_mode = @wizard_state[:edit_cutoff_mode] || 'at_event'
  cancel_cutoff_mode = @wizard_state[:cancel_cutoff_mode] || 'at_event'

  # Default slot selection mode - auto_assign for waitlist and open_list
  default_slot_mode = (is_waitlist || is_open_list) ? 'auto_assign' : 'choose_slot'
  slot_selection_mode = @wizard_state[:slot_selection_mode] || default_slot_mode
%>
<%= render layout: "manage/sign_up_form_wizard/wizard_layout", locals: { current_step: step_num, step_name: "Rules" } do %>
  <h2 class="text-xl font-bold text-gray-900 mb-2 coustard-regular">Registration Rules</h2>
  <p class="text-gray-600 mb-6">Set limits and permissions for how people can register.</p>

  <%= form_with url: manage_sign_up_wizard_production_save_rules_path(@production), method: :post, local: true, data: { controller: "rules-form" } do |form| %>
    <div class="space-y-8">
      <% if is_waitlist %>
      <%# For waitlists, use sensible defaults - no need to show this section %>
      <input type="hidden" name="registrations_per_person" value="1">
      <input type="hidden" name="slot_selection_mode" value="auto_assign">
      <% else %>
      <!-- Registration Limits Section -->
      <div class="bg-gray-50 rounded-lg border border-gray-200 p-5">
        <h3 class="font-semibold text-gray-900 mb-4">Registration Limits</h3>

        <div class="w-full sm:flex sm:space-x-5">
          <div class="w-full sm:w-1/2">
            <label class="block text-gray-700 font-medium">Registrations per person</label>
            <select name="registrations_per_person" class="block shadow-sm rounded-lg border border-gray-300 px-3 py-2 mt-2 w-full">
              <option value="1" <%= "selected" if @wizard_state[:registrations_per_person].nil? || @wizard_state[:registrations_per_person] == 1 %>>1 (one slot per person)</option>
              <option value="2" <%= "selected" if @wizard_state[:registrations_per_person] == 2 %>>2</option>
              <option value="3" <%= "selected" if @wizard_state[:registrations_per_person] == 3 %>>3</option>
              <option value="5" <%= "selected" if @wizard_state[:registrations_per_person] == 5 %>>5</option>
              <option value="10" <%= "selected" if @wizard_state[:registrations_per_person] == 10 %>>10</option>
              <option value="999" <%= "selected" if @wizard_state[:registrations_per_person] && @wizard_state[:registrations_per_person] >= 999 %>>Unlimited</option>
            </select>
          </div>

          <div class="w-full sm:w-1/2 mt-5 sm:mt-0">
            <label class="block text-gray-700 font-medium">Slot selection</label>
            <select name="slot_selection_mode" class="block shadow-sm rounded-lg border border-gray-300 px-3 py-2 mt-2 w-full" data-rules-form-target="slotSelectionMode" data-action="change->rules-form#toggleSlotSelectionMode">
              <option value="choose_slot" <%= "selected" if slot_selection_mode == 'choose_slot' %>>Registrant chooses their slot</option>
              <option value="auto_assign" <%= "selected" if slot_selection_mode == 'auto_assign' %>>Registrant automatically assigned to next available slot</option>
              <option value="admin_assigns" <%= "selected" if slot_selection_mode == 'admin_assigns' %>>Production team assigns registrants to slots</option>
            </select>
            <p class="text-sm text-gray-500 mt-1" data-rules-form-target="slotSelectionDescription">
              <% case slot_selection_mode %>
              <% when 'auto_assign' %>
                Good for waitlists or when slot choice doesn't matter.
              <% when 'admin_assigns' %>
                People sign up to a queue. You assign them to slots later.
              <% else %>
                People select their preferred slot when signing up.
              <% end %>
            </p>
          </div>
        </div>
      </div>

      <!-- Temporary Slot Hold Section (only for choose_slot mode) -->
      <div data-rules-form-target="slotHoldSettings" class="bg-gray-50 rounded-lg border border-gray-200 p-5 <%= slot_selection_mode == 'choose_slot' ? '' : 'hidden' %>" data-controller="toggle-section">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="font-semibold text-gray-900">Temporary Slot Hold</h3>
            <p class="text-sm text-gray-500 mt-1">Reserve a slot while the user completes their registration</p>
          </div>
          <label class="relative inline-flex items-center cursor-pointer">
            <input type="hidden" name="slot_hold_enabled" value="0">
            <input type="checkbox" name="slot_hold_enabled" value="1"
                   <%= "checked" if @wizard_state[:slot_hold_enabled].nil? || @wizard_state[:slot_hold_enabled] %>
                   data-action="change->toggle-section#toggle"
                   data-toggle-section-target="toggle"
                   class="sr-only peer">
            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
          </label>
        </div>
        <p class="text-sm text-gray-500 mt-3">When enabled, clicking a slot temporarily reserves it so no one else can select it while the user fills out the form. Helps prevent two people from registering for the same slot.</p>
        <div data-toggle-section-target="content" class="<%= @wizard_state[:slot_hold_enabled].nil? || @wizard_state[:slot_hold_enabled] ? '' : 'hidden' %> mt-4 pt-4 border-t border-gray-200">
          <div class="flex items-center gap-3">
            <span class="text-sm text-gray-700">Hold slot for</span>
            <input type="number" name="slot_hold_seconds" value="<%= @wizard_state[:slot_hold_seconds] || 30 %>" min="10" max="300"
                   class="w-20 rounded-lg border border-gray-300 px-3 py-2 text-center">
            <span class="text-sm text-gray-600">seconds</span>
          </div>
          <p class="text-xs text-gray-500 mt-2">Recommended: 30-60 seconds. The hold automatically expires if the user doesn't complete registration.</p>
        </div>
      </div>

      <!-- Queue Settings Section (only for admin_assigns mode) -->
      <div data-rules-form-target="queueSettings" class="bg-gray-50 rounded-lg border border-gray-200 p-5 <%= slot_selection_mode == 'admin_assigns' ? '' : 'hidden' %>">
        <h3 class="font-semibold text-gray-900 mb-4">Queue Settings</h3>
        <p class="text-sm text-gray-600 mb-4">Since you're assigning people to slots, registrations go into a queue first.</p>

        <div class="space-y-4">
          <div>
            <label class="block text-gray-700 font-medium">Queue limit</label>
            <div class="flex items-center gap-2 mt-2">
              <input type="number" name="queue_limit" value="<%= @wizard_state[:queue_limit] %>" min="1" placeholder="Unlimited"
                     class="w-32 shadow-sm rounded-lg border border-gray-300 px-3 py-2">
              <span class="text-sm text-gray-500">Leave empty for unlimited</span>
            </div>
          </div>

          <% if @wizard_state[:scope] == 'repeated' %>
          <div class="flex items-center justify-between">
            <div>
              <p class="font-medium text-gray-900">Carry over unassigned to next event</p>
              <p class="text-sm text-gray-500 mt-0.5">People not assigned for one event automatically join the queue for the next</p>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="hidden" name="queue_carryover" value="0">
              <input type="checkbox" name="queue_carryover" value="1"
                     <%= "checked" if @wizard_state[:queue_carryover] %>
                     class="sr-only peer">
              <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
            </label>
          </div>
          <% end %>
        </div>
      </div>
      <% end %>

      <!-- Show Registrations Section -->
      <div class="bg-gray-50 rounded-lg border border-gray-200 p-5">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="font-semibold text-gray-900">Show registered names</h3>
            <p class="text-sm text-gray-500 mt-1">Display who's signed up in each slot</p>
          </div>
          <label class="relative inline-flex items-center cursor-pointer">
            <input type="hidden" name="show_registrations" value="0">
            <input type="checkbox" name="show_registrations" value="1"
                   <%= "checked" if @wizard_state[:show_registrations] %>
                   class="sr-only peer">
            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
          </label>
        </div>
        <p class="text-sm text-gray-500 mt-3">When enabled, the names of registered participants will be displayed below each slot on the sign-up form. This helps participants see who else is signed up.</p>
      </div>

      <% unless is_waitlist %>
      <!-- Hold-backs Section (not for waitlist) -->
      <div class="bg-gray-50 rounded-lg border border-gray-200 p-5" data-controller="holdback-toggle">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="font-semibold text-gray-900">Hold-back Slots</h3>
            <p class="text-sm text-gray-500 mt-1">Reserve some slots that won't be available for public sign-ups</p>
          </div>
          <label class="relative inline-flex items-center cursor-pointer">
            <input type="hidden" name="enable_holdbacks" value="0">
            <input type="checkbox" name="enable_holdbacks" value="1"
                   <%= "checked" if @wizard_state[:enable_holdbacks] %>
                   data-action="change->holdback-toggle#toggle"
                   data-holdback-toggle-target="toggle"
                   class="sr-only peer">
            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
          </label>
        </div>

        <div data-holdback-toggle-target="options" class="<%= @wizard_state[:enable_holdbacks] ? '' : 'hidden' %> mt-4 space-y-4">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-gray-700 font-medium">Hold every</label>
              <div class="flex items-center gap-2 mt-2">
                <input type="number" name="holdback_interval" value="<%= @wizard_state[:holdback_interval] || 5 %>" min="2" max="20"
                       class="w-20 shadow-sm rounded-lg border border-gray-300 px-3 py-2">
                <span class="text-gray-600">slot(s)</span>
              </div>
              <p class="text-xs text-gray-500 mt-1">e.g., "5" means slots 5, 10, 15... are held back</p>
            </div>
            <div>
              <label class="block text-gray-700 font-medium">Label for held slots</label>
              <input type="text" name="holdback_label" value="<%= @wizard_state[:holdback_label] || 'Hold for walk-ins' %>"
                     placeholder="Hold for walk-ins"
                     class="block shadow-sm rounded-lg border border-gray-300 px-3 py-2 mt-2 w-full">
            </div>
          </div>

          <div class="flex items-center gap-3">
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="hidden" name="holdback_visible" value="0">
              <input type="checkbox" name="holdback_visible" value="1"
                     <%= "checked" if @wizard_state[:holdback_visible] %>
                     class="sr-only peer">
              <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-pink-500"></div>
            </label>
            <div>
              <span class="text-sm text-gray-700">Show held slots to people signing up</span>
              <p class="text-xs text-gray-500">When enabled, held slots are visible but marked as unavailable</p>
            </div>
          </div>
        </div>
      </div>
      <% end %>

      <!-- Require Login Section -->
      <div class="bg-gray-50 rounded-lg border border-gray-200 p-5">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="font-semibold text-gray-900">Require Login</h3>
            <p class="text-sm text-gray-500 mt-1">Only logged-in users can register (no guest sign-ups)</p>
          </div>
          <label class="relative inline-flex items-center cursor-pointer">
            <input type="hidden" name="require_login" value="0">
            <input type="checkbox" name="require_login" value="1"
                   <%= "checked" if require_login_checked %>
                   class="sr-only peer">
            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
          </label>
        </div>

        <!-- Why Require Login info box -->
        <div class="mt-4 p-3 bg-green-50 rounded-lg border border-green-100">
          <div class="flex">
            <div class="flex-shrink-0">
              <svg class="h-5 w-5 text-green-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />
              </svg>
            </div>
            <div class="ml-3">
              <p class="text-sm text-green-800">
                <strong>Recommended:</strong> Requiring login helps prevent duplicate sign-ups, lets people manage their own registrations, and allows you to contact registrants through the platform.
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Changes & Cancellations Section -->
      <div class="bg-gray-50 rounded-lg border border-gray-200 p-5" data-controller="cutoff-timing">
        <h3 class="font-semibold text-gray-900 mb-4">Changes & Cancellations</h3>

        <!-- Allow Editing (not for open_list - nothing to edit) -->
        <% unless is_open_list %>
        <div class="space-y-3">
          <div class="flex items-center justify-between">
            <div>
              <p class="font-medium text-gray-900">Allow edits</p>
              <p class="text-sm text-gray-500 mt-1">People can change their registration details</p>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="hidden" name="allow_edit" value="0">
              <input type="checkbox" name="allow_edit" value="1"
                     <%= "checked" if @wizard_state[:allow_edit].nil? || @wizard_state[:allow_edit] %>
                     data-action="change->cutoff-timing#toggleEditSection"
                     data-cutoff-timing-target="allowEdit"
                     class="sr-only peer">
              <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
            </label>
          </div>

          <% unless is_waitlist %>
          <%
            # Edit cutoff defaults - toggle off by default (edit_cutoff_mode is nil when off)
            edit_has_cutoff = @wizard_state[:edit_cutoff_mode].present?
            edit_cutoff_mode = @wizard_state[:edit_cutoff_mode] || 'at_event'
            edit_cutoff_days = @wizard_state[:edit_cutoff_days] || 0
            edit_cutoff_hours = @wizard_state[:edit_cutoff_hours] || 0
            edit_cutoff_minutes = @wizard_state[:edit_cutoff_minutes] || 0
          %>
          <div data-cutoff-timing-target="editSection" class="<%= @wizard_state[:allow_edit] == false ? 'hidden' : '' %> ml-4 space-y-3">
            <div class="flex items-center gap-3">
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="hidden" name="edit_has_cutoff" value="0">
                <input type="checkbox" name="edit_has_cutoff" value="1"
                       <%= "checked" if edit_has_cutoff %>
                       data-action="change->cutoff-timing#toggleEditCutoff"
                       data-cutoff-timing-target="editHasCutoff"
                       class="sr-only peer">
                <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-pink-500"></div>
              </label>
              <span class="text-sm text-gray-700">Set a cutoff for edits</span>
            </div>

            <div data-cutoff-timing-target="editCutoff" class="<%= edit_has_cutoff ? '' : 'hidden' %> space-y-3 ml-4 p-4 bg-white rounded-lg border border-gray-200">
              <%# Option 1: At time of event %>
              <label class="flex items-center gap-3 p-3 rounded-lg border-2 cursor-pointer transition-colors <%= edit_cutoff_mode == 'at_event' ? 'border-pink-500 bg-pink-50' : 'border-gray-200 hover:border-gray-300' %>"
                     data-action="click->cutoff-timing#selectEditMode" data-value="at_event">
                <input type="radio" name="edit_cutoff_mode" value="at_event"
                       <%= "checked" if edit_cutoff_mode == 'at_event' %>
                       class="sr-only"
                       data-cutoff-timing-target="editModeAtEvent">
                <span class="text-sm font-medium text-gray-900">At the time of the event</span>
              </label>

              <%# Option 2: Before the event %>
              <div class="p-3 rounded-lg border-2 cursor-pointer transition-colors <%= edit_cutoff_mode == 'before_event' ? 'border-pink-500 bg-pink-50' : 'border-gray-200 hover:border-gray-300' %>"
                   data-action="click->cutoff-timing#selectEditMode" data-value="before_event">
                <label class="flex items-center gap-3 cursor-pointer">
                  <input type="radio" name="edit_cutoff_mode" value="before_event"
                         <%= "checked" if edit_cutoff_mode == 'before_event' %>
                         class="sr-only"
                         data-cutoff-timing-target="editModeBefore">
                  <span class="text-sm font-medium text-gray-900">Before the event</span>
                </label>
                <div data-cutoff-timing-target="editBeforeFields" class="<%= edit_cutoff_mode == 'before_event' ? '' : 'hidden' %> flex flex-wrap items-center gap-2 mt-3 ml-1" onclick="event.stopPropagation()">
                  <input type="number" name="edit_cutoff_days" value="<%= edit_cutoff_days %>" min="0"
                         class="w-16 shadow-sm rounded-lg border border-gray-300 px-2 py-1.5 text-sm">
                  <span class="text-sm text-gray-600">days</span>
                  <input type="number" name="edit_cutoff_hours" value="<%= edit_cutoff_hours %>" min="0" max="23"
                         class="w-16 shadow-sm rounded-lg border border-gray-300 px-2 py-1.5 text-sm">
                  <span class="text-sm text-gray-600">hours</span>
                  <input type="number" name="edit_cutoff_minutes" value="<%= edit_cutoff_minutes %>" min="0" max="59"
                         class="w-16 shadow-sm rounded-lg border border-gray-300 px-2 py-1.5 text-sm">
                  <span class="text-sm text-gray-600">minutes before</span>
                </div>
              </div>

              <%# Option 3: After the event starts %>
              <div class="p-3 rounded-lg border-2 cursor-pointer transition-colors <%= edit_cutoff_mode == 'after_event' ? 'border-pink-500 bg-pink-50' : 'border-gray-200 hover:border-gray-300' %>"
                   data-action="click->cutoff-timing#selectEditMode" data-value="after_event">
                <label class="flex items-center gap-3 cursor-pointer">
                  <input type="radio" name="edit_cutoff_mode" value="after_event"
                         <%= "checked" if edit_cutoff_mode == 'after_event' %>
                         class="sr-only"
                         data-cutoff-timing-target="editModeAfter">
                  <span class="text-sm font-medium text-gray-900">After the event starts</span>
                </label>
                <div data-cutoff-timing-target="editAfterFields" class="<%= edit_cutoff_mode == 'after_event' ? '' : 'hidden' %> flex flex-wrap items-center gap-2 mt-3 ml-1" onclick="event.stopPropagation()">
                  <input type="number" name="edit_cutoff_after_days" value="<%= @wizard_state[:edit_cutoff_after_days] || 0 %>" min="0"
                         class="w-16 shadow-sm rounded-lg border border-gray-300 px-2 py-1.5 text-sm">
                  <span class="text-sm text-gray-600">days</span>
                  <input type="number" name="edit_cutoff_after_hours" value="<%= @wizard_state[:edit_cutoff_after_hours] || 0 %>" min="0" max="23"
                         class="w-16 shadow-sm rounded-lg border border-gray-300 px-2 py-1.5 text-sm">
                  <span class="text-sm text-gray-600">hours</span>
                  <input type="number" name="edit_cutoff_after_minutes" value="<%= @wizard_state[:edit_cutoff_after_minutes] || 0 %>" min="0" max="59"
                         class="w-16 shadow-sm rounded-lg border border-gray-300 px-2 py-1.5 text-sm">
                  <span class="text-sm text-gray-600">minutes after</span>
                </div>
              </div>
            </div>
          </div>
          <% end %>
        </div>
        <% end %>

        <div class="border-t border-gray-200 my-4"></div>

        <!-- Allow Cancellation -->
        <div class="space-y-3">
          <div class="flex items-center justify-between">
            <div>
              <p class="font-medium text-gray-900">Allow cancellations</p>
              <p class="text-sm text-gray-500 mt-1">People can cancel their own registration</p>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="hidden" name="allow_cancel" value="0">
              <input type="checkbox" name="allow_cancel" value="1"
                     <%= "checked" if @wizard_state[:allow_cancel].nil? || @wizard_state[:allow_cancel] %>
                     data-action="change->cutoff-timing#toggleCancelSection"
                     data-cutoff-timing-target="allowCancel"
                     class="sr-only peer">
              <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
            </label>
          </div>

          <% unless is_waitlist %>
          <%
            # Cancel cutoff defaults - toggle off by default (cancel_cutoff_mode is nil when off)
            cancel_has_cutoff = @wizard_state[:cancel_cutoff_mode].present?
            cancel_cutoff_mode = @wizard_state[:cancel_cutoff_mode] || 'at_event'
            cancel_cutoff_days = @wizard_state[:cancel_cutoff_days] || 0
            cancel_cutoff_hours = @wizard_state[:cancel_cutoff_hours] || 0
            cancel_cutoff_minutes = @wizard_state[:cancel_cutoff_minutes] || 0
          %>
          <div data-cutoff-timing-target="cancelSection" class="<%= @wizard_state[:allow_cancel] == false ? 'hidden' : '' %> ml-4 space-y-3">
            <div class="flex items-center gap-3">
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="hidden" name="cancel_has_cutoff" value="0">
                <input type="checkbox" name="cancel_has_cutoff" value="1"
                       <%= "checked" if cancel_has_cutoff %>
                       data-action="change->cutoff-timing#toggleCancelCutoff"
                       data-cutoff-timing-target="cancelHasCutoff"
                       class="sr-only peer">
                <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-pink-500"></div>
              </label>
              <span class="text-sm text-gray-700">Set a cutoff for cancellations</span>
            </div>

            <div data-cutoff-timing-target="cancelCutoff" class="<%= cancel_has_cutoff ? '' : 'hidden' %> space-y-3 ml-4 p-4 bg-white rounded-lg border border-gray-200">
              <%# Option 1: At time of event %>
              <label class="flex items-center gap-3 p-3 rounded-lg border-2 cursor-pointer transition-colors <%= cancel_cutoff_mode == 'at_event' ? 'border-pink-500 bg-pink-50' : 'border-gray-200 hover:border-gray-300' %>"
                     data-action="click->cutoff-timing#selectCancelMode" data-value="at_event">
                <input type="radio" name="cancel_cutoff_mode" value="at_event"
                       <%= "checked" if cancel_cutoff_mode == 'at_event' %>
                       class="sr-only"
                       data-cutoff-timing-target="cancelModeAtEvent">
                <span class="text-sm font-medium text-gray-900">At the time of the event</span>
              </label>

              <%# Option 2: Before the event %>
              <div class="p-3 rounded-lg border-2 cursor-pointer transition-colors <%= cancel_cutoff_mode == 'before_event' ? 'border-pink-500 bg-pink-50' : 'border-gray-200 hover:border-gray-300' %>"
                   data-action="click->cutoff-timing#selectCancelMode" data-value="before_event">
                <label class="flex items-center gap-3 cursor-pointer">
                  <input type="radio" name="cancel_cutoff_mode" value="before_event"
                         <%= "checked" if cancel_cutoff_mode == 'before_event' %>
                         class="sr-only"
                         data-cutoff-timing-target="cancelModeBefore">
                  <span class="text-sm font-medium text-gray-900">Before the event</span>
                </label>
                <div data-cutoff-timing-target="cancelBeforeFields" class="<%= cancel_cutoff_mode == 'before_event' ? '' : 'hidden' %> flex flex-wrap items-center gap-2 mt-3 ml-1" onclick="event.stopPropagation()">
                  <input type="number" name="cancel_cutoff_days" value="<%= cancel_cutoff_days %>" min="0"
                         class="w-16 shadow-sm rounded-lg border border-gray-300 px-2 py-1.5 text-sm">
                  <span class="text-sm text-gray-600">days</span>
                  <input type="number" name="cancel_cutoff_hours" value="<%= cancel_cutoff_hours %>" min="0" max="23"
                         class="w-16 shadow-sm rounded-lg border border-gray-300 px-2 py-1.5 text-sm">
                  <span class="text-sm text-gray-600">hours</span>
                  <input type="number" name="cancel_cutoff_minutes" value="<%= cancel_cutoff_minutes %>" min="0" max="59"
                         class="w-16 shadow-sm rounded-lg border border-gray-300 px-2 py-1.5 text-sm">
                  <span class="text-sm text-gray-600">minutes before</span>
                </div>
              </div>

              <%# Option 3: After the event starts %>
              <div class="p-3 rounded-lg border-2 cursor-pointer transition-colors <%= cancel_cutoff_mode == 'after_event' ? 'border-pink-500 bg-pink-50' : 'border-gray-200 hover:border-gray-300' %>"
                   data-action="click->cutoff-timing#selectCancelMode" data-value="after_event">
                <label class="flex items-center gap-3 cursor-pointer">
                  <input type="radio" name="cancel_cutoff_mode" value="after_event"
                         <%= "checked" if cancel_cutoff_mode == 'after_event' %>
                         class="sr-only"
                         data-cutoff-timing-target="cancelModeAfter">
                  <span class="text-sm font-medium text-gray-900">After the event starts</span>
                </label>
                <div data-cutoff-timing-target="cancelAfterFields" class="<%= cancel_cutoff_mode == 'after_event' ? '' : 'hidden' %> flex flex-wrap items-center gap-2 mt-3 ml-1" onclick="event.stopPropagation()">
                  <input type="number" name="cancel_cutoff_after_days" value="<%= @wizard_state[:cancel_cutoff_after_days] || 0 %>" min="0"
                         class="w-16 shadow-sm rounded-lg border border-gray-300 px-2 py-1.5 text-sm">
                  <span class="text-sm text-gray-600">days</span>
                  <input type="number" name="cancel_cutoff_after_hours" value="<%= @wizard_state[:cancel_cutoff_after_hours] || 0 %>" min="0" max="23"
                         class="w-16 shadow-sm rounded-lg border border-gray-300 px-2 py-1.5 text-sm">
                  <span class="text-sm text-gray-600">hours</span>
                  <input type="number" name="cancel_cutoff_after_minutes" value="<%= @wizard_state[:cancel_cutoff_after_minutes] || 0 %>" min="0" max="59"
                         class="w-16 shadow-sm rounded-lg border border-gray-300 px-2 py-1.5 text-sm">
                  <span class="text-sm text-gray-600">minutes after</span>
                </div>
              </div>
            </div>
          </div>
          <% end %>
        </div>
      </div>

    </div>

    <div class="mt-8 flex justify-between">
      <%= link_to manage_sign_up_wizard_production_slots_path(@production), class: "inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-900" do %>
        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Back
      <% end %>
      <%= render "shared/button", text: "Next", variant: "primary", size: "medium", type: :submit %>
    </div>
  <% end %>
<% end %>
