<% show_production = local_assigns.fetch(:show_production, false) %>
<% is_reply = local_assigns.fetch(:is_reply, false) %>
<% indent_class = is_reply ? "ml-12 border-l-2 border-gray-200" : "" %>
<div class="bg-white px-6 py-4 <%= indent_class %>" id="post-<%= post.id %>" data-controller="post-replies" data-post-replies-post-id-value="<%= post.id %>">
  <div class="flex gap-3">
    <%# Author Avatar %>
    <% headshot_variant = post.author_headshot_variant(:thumb) %>
    <% if headshot_variant %>
      <%= image_tag headshot_variant, alt: post.author_name, class: "w-10 h-10 rounded-lg object-cover flex-shrink-0" %>
    <% else %>
      <div class="w-10 h-10 rounded-lg bg-gray-200 flex items-center justify-center flex-shrink-0">
        <span class="text-sm font-bold text-gray-600"><%= post.author_initials %></span>
      </div>
    <% end %>

    <div class="flex-1 min-w-0">
      <%# Author Name and Timestamp %>
      <div class="flex items-center gap-2 mb-1">
        <span class="font-medium text-gray-900"><%= post.author_name %></span>
        <span class="text-xs text-gray-500"><%= time_ago_in_words(post.created_at) %> ago</span>
        <% if show_production %>
          <span class="text-xs text-gray-400">in</span>
          <span class="text-xs font-medium text-pink-600"><%= post.production.name %></span>
        <% end %>
      </div>

      <%# Post Body %>
      <div class="text-gray-700 text-sm prose prose-sm max-w-none"><%= post.body %></div>

      <%# Actions - Reply button and Replies toggle %>
      <% unless is_reply %>
        <div class="mt-2 flex items-center gap-4">
          <button type="button"
                  data-action="click->post-replies#toggleReplyForm"
                  class="text-xs text-gray-500 hover:text-pink-600 cursor-pointer flex items-center gap-1">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 20.25c4.97 0 9-3.694 9-8.25s-4.03-8.25-9-8.25S3 7.444 3 12c0 2.104.859 4.023 2.273 5.48.432.447.74 1.04.586 1.641a4.483 4.483 0 0 1-.923 1.785A5.969 5.969 0 0 0 6 21c1.282 0 2.47-.402 3.445-1.087.81.22 1.668.337 2.555.337Z" />
            </svg>
            Reply
          </button>

          <% if post.replies_count > 0 %>
            <button type="button"
                    data-action="click->post-replies#toggleReplies"
                    data-post-replies-target="toggleButton"
                    class="text-xs text-pink-500 hover:text-pink-600 cursor-pointer flex items-center gap-1">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4" data-post-replies-target="chevron">
                <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
              </svg>
              <span data-post-replies-target="count"><%= pluralize(post.replies_count, "reply") %></span>
            </button>
          <% end %>
        </div>

        <%# Reply Form - pre-rendered but hidden %>
        <div class="mt-3 hidden" data-post-replies-target="replyForm" id="reply-form-<%= post.id %>">
          <%= render "my/messages/reply_form", production: post.production, post: Post.new, parent_id: post.id %>
        </div>

        <%# Replies Section (hidden by default) %>
        <div class="mt-3 hidden" data-post-replies-target="replies" id="replies-for-<%= post.id %>">
          <% post.replies.oldest_first.each do |reply| %>
            <%= render "my/messages/post", post: reply, is_reply: true %>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div>
