<%#
  Money Show Row - Four Panel Layout for Revenue Events, Simplified for Non-Revenue

  Required:
    - show: Show object
    - production: Production object

  Optional:
    - hide_non_revenue: Boolean, whether this row is in a filterable list

  Panels (revenue events):
    1-2. Date/Time box + Show info (left half) -> links to show detail
    3. Financials summary with indicator -> links to edit financials
    4. Payout status and progress -> links to payout detail

  Panels (non-revenue events):
    1-2. Date/Time box + Show info (left half) -> links to show detail
    3. Single panel to mark as revenue event -> links to edit financials
%>

<%
  financials = show.show_financials
  payout = show.show_payout
  has_data = financials&.has_data?
  data_confirmed = financials&.data_confirmed?
  is_revenue_event = show.revenue_event?
  is_canceled = show.canceled?
  # Check if this is a type that defaults to revenue but was marked as non-revenue
  is_overridden_non_revenue = financials&.non_revenue_override? && EventTypes.revenue_event_default(show.event_type)

  # Determine payout status with new terminology
  if payout&.paid?
    payout_status = :paid
    payout_label = "Paid"
    payout_class = "text-pink-600"
  elsif payout&.calculated_at.present?
    payout_status = :awaiting_payout
    payout_label = "Awaiting Payout"
    payout_class = "text-pink-600"
  elsif has_data
    payout_status = :ready
    payout_label = "Ready to Calculate"
    payout_class = "text-gray-600"
  else
    payout_status = :awaiting_calculation
    payout_label = "Awaiting Calculation"
    payout_class = "text-pink-600"
  end
%>

<div class="bg-white rounded-lg border border-gray-200 hover:border-gray-300 transition-all <%= is_revenue_event ? '' : 'opacity-60' %> <%= 'opacity-60' if is_canceled %>"
     data-money-filter-target="showRow"
     data-non-revenue="<%= !is_revenue_event %>">
  <div class="flex flex-col lg:flex-row lg:items-stretch">

    <%# Panel 1 & 2: Show Info (left half) %>
    <div class="flex-1 flex items-center gap-4 px-4 py-3 rounded-t-lg lg:rounded-l-lg lg:rounded-tr-none">
      <%# Date Box %>
      <div class="flex-shrink-0 w-14 text-center <%= 'line-through' if is_canceled %>">
        <div class="text-xs font-semibold text-pink-600 uppercase"><%= show.date_and_time.strftime("%b") %></div>
        <div class="text-2xl font-bold text-gray-900"><%= show.date_and_time.strftime("%-d") %></div>
        <div class="text-xs text-gray-500"><%= show.date_and_time.strftime("%a") %></div>
      </div>

      <%# Show Details %>
      <div class="flex-1 min-w-0">
        <div class="flex items-center gap-2 flex-wrap">
          <span class="font-medium text-gray-900 <%= 'line-through' if is_canceled %>">
            <%= show.secondary_name.presence || show.event_type.titleize %>
          </span>
          <% if is_canceled %>
            <span class="inline-flex items-center rounded-md bg-red-50 px-2 py-0.5 text-xs font-medium text-red-700 ring-1 ring-inset ring-red-600/10">Canceled</span>
          <% end %>
          <% unless is_revenue_event %>
            <span class="inline-flex items-center rounded-md px-2 py-0.5 text-xs font-medium bg-gray-100 text-gray-500">
              Non-revenue
            </span>
          <% end %>
        </div>
        <div class="text-sm text-gray-600 <%= 'line-through' if is_canceled %>">
          <%= show.date_and_time.strftime("%l:%M %p").strip %>
          <% if show.location.present? %>
            &middot; <%= show.location.name %>
          <% elsif show.is_online %>
            &middot; Online
          <% end %>
        </div>
      </div>
    </div>

    <% if is_revenue_event %>
      <%# Panel 3: Financials (revenue events) %>
      <%= link_to manage_production_money_show_financials_path(production, show), class: "w-full lg:w-1/4 px-4 py-3 border-t lg:border-t-0 lg:border-l border-gray-200 hover:bg-gray-50 transition-colors flex flex-col justify-center" do %>
        <div class="text-[10px] text-gray-400 uppercase tracking-wide mb-1 flex items-center gap-1">
          Financials
          <% if data_confirmed %>
            <svg class="w-3.5 h-3.5 text-pink-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd"/>
            </svg>
          <% end %>
        </div>
        <% if has_data %>
          <div class="text-sm font-medium text-gray-900"><%= number_to_currency(financials.total_revenue) %> revenue</div>
          <div class="text-xs text-gray-500"><%= number_to_currency(financials.calculated_expenses) %> expenses</div>
        <% else %>
          <div class="text-sm font-medium text-pink-600">Awaiting Financials</div>
        <% end %>
      <% end %>

      <%# Panel 4: Payout Status (revenue events) %>
      <%= link_to manage_production_money_show_payout_path(production, show), class: "w-full lg:w-1/4 px-4 py-3 border-t lg:border-t-0 lg:border-l border-gray-200 hover:bg-gray-50 transition-colors rounded-b-lg lg:rounded-r-lg lg:rounded-bl-none flex flex-col justify-center" do %>
        <div class="text-[10px] text-gray-400 uppercase tracking-wide mb-1 flex items-center gap-1">
          Payout
          <% if payout_status == :paid %>
            <svg class="w-3.5 h-3.5 text-pink-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd"/>
            </svg>
          <% end %>
        </div>
        <div class="flex items-center gap-2">
          <span class="text-sm font-medium <%= payout_class %>"><%= payout_label %></span>
        </div>
        <% if payout&.total_payout && payout.total_payout > 0 %>
          <div class="text-xs text-gray-500"><%= number_to_currency(payout.total_payout) %> total</div>
        <% end %>
      <% end %>
    <% else %>
      <%# Single panel for non-revenue events %>
      <% if is_overridden_non_revenue %>
        <%# Was marked as non-revenue - can be undone %>
        <%= button_to manage_production_unmark_non_revenue_money_show_financials_path(production, show),
            method: :post,
            class: "w-full lg:w-1/2 px-4 py-3 border-t lg:border-t-0 lg:border-l border-gray-200 hover:bg-gray-50 transition-colors rounded-b-lg lg:rounded-r-lg lg:rounded-bl-none flex flex-col justify-center text-left cursor-pointer",
            form: { data: { turbo_confirm: "Restore this as a revenue event?" } } do %>
          <div class="flex items-center gap-2">
            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <span class="text-sm text-gray-500">Marked as non-revenue</span>
          </div>
          <div class="text-xs text-gray-400 mt-0.5">Click to undo and enter financial data</div>
        <% end %>
      <% else %>
        <%# Naturally non-revenue event type - can add financial data if needed %>
        <%= link_to manage_production_money_show_financials_path(production, show), class: "w-full lg:w-1/2 px-4 py-3 border-t lg:border-t-0 lg:border-l border-gray-200 hover:bg-gray-50 transition-colors rounded-b-lg lg:rounded-r-lg lg:rounded-bl-none flex flex-col justify-center" do %>
          <div class="flex items-center gap-2">
            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <span class="text-sm text-gray-500">No payout for this event type</span>
          </div>
          <div class="text-xs text-gray-400 mt-0.5">Click if this event generated revenue or requires payout</div>
        <% end %>
      <% end %>
    <% end %>

  </div>
</div>
