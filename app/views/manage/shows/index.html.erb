<% content_for :title, "Shows" %>

<div class="w-full mb-10">
  <%= render partial: "shared/notice", locals: { notice: notice } %>
  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [],
    text: "Shows",
    links: []
  } %>

   <div class="flex w-full space-x-2 mb-4">
    <div class="flex flex-1 space-x-1">
      <%= link_to "Upcoming",
              manage_production_shows_path(@production, filter: "upcoming"),
              data: { turbo_prefetch: false },
              class: "px-3 py-1 rounded-md border text-sm #{(@filter == "upcoming") ? 'bg-pink-500 text-white border-pink-500' : 'bg-white text-gray-700 border-gray-200'}"
      %>
      <%= link_to "Past",
              manage_production_shows_path(@production, filter: "past"),
              data: { turbo_prefetch: false },
              class: "px-3 py-1 rounded-md border text-sm #{(@filter == "past") ? 'bg-pink-500 text-white border-pink-500' : 'bg-white text-gray-700 border-gray-200'}"
      %>
    </div>
  </div>

  <div class="grid grid-cols-1 gap-2">
    <% @shows.each_with_index do |show, idx| %>
      <div class="p-4 border border-gray-200 rounded-lg hover:border-gray-400 transition-all" data-controller="show-toggle" <%= 'data-show-toggle-initial-open-value="true"' if idx == 0 && @filter == "upcoming" %>>
        <div class="flex items-center cursor-pointer select-none" data-action="click->show-toggle#toggle">
          <span data-show-toggle-target="icon" class="mr-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="size-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
          </span>
          <p class="font-bold text-lg"><%= show.date_and_time.strftime("%A, %B %-d, %Y") %> &bull; <%= show.date_and_time.strftime("%l:%M %p") %></p>
        </div>

        <div data-show-toggle-target="content" class="mt-4 <%= 'hidden' unless idx == 0 %>">

          <div class="flex items-start gap-6">

            <div class="flex w-1/2">

              <div class="flex-shrink">
                <% if show.poster.present? %>
                  <div class="mb-2 pr-4">
                    <%= image_tag url_for(show.poster.variant(:small)), alt: "Show Poster", class: "rounded shadow max-w-36 border border-gray-200" %>
                  </div>
                <% end %>
              </div>

                <div class="flex flex-col items-start justify-start w-2/3 min-w-0">
                <% if show.secondary_name.present? %>
                  <p class="text-md font-bold truncate"><%= show.secondary_name %></p>
                <% end %>
                <% if show.location.present? %>
                  <p class="text-sm text-gray-500 flex items-center mt-1">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4 mr-1">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" />
                  </svg>
                  <%= show.location.name %>
                  </p>
                <% end %>

                <% if Current.user.manager? %>
                  <div class="mt-4 flex flex-col space-y-1">
                    <%= link_to "Edit Show/Schedule", edit_manage_production_show_path(@production, show), class: "text-xs text-pink-500 underline" %>
                    <%= link_to "Edit Cast", manage_production_show_path(@production, show), class: "text-xs text-pink-500 underline" %>
                    <%= link_to "Duplicate", new_manage_production_show_path(@production, duplicate: show.id), class: "text-xs text-pink-500 underline" %>
                    <%= link_to "Cancel Show", manage_production_show_path(@production, show), data: {turbo_method: :delete, turbo_confirm: "Are you sure you want to cancel this show?"}, class: "text-xs text-pink-500 underline" %>
                  </div>
                <% end %>

              </div>
            </div>

            <div class="w-1/2">
              <div class="p-2 flex border border-gray-200 rounded-lg hover:border-gray-400 transition-all space-x-2">
                <% if show.show_person_role_assignments.any? %>
                  <% show.show_person_role_assignments.each do |assignment| %>
                    <%= link_to [:manage, assignment.person] do %>
                      <div class="flex flex-col items-center transition-all relative"
                        data-controller="tooltip"
                        data-tooltip-text="<%= assignment.person.name.truncate(40, omission: '...') %> - <%= assignment.role.name %>">
                        <% if assignment.person.headshot.present? %>
                          <%= image_tag assignment.person.headshot.variant(:thumb), alt: assignment.person.name, class: "w-15 h-15 rounded-lg object-cover", draggable: false %>
                        <% else %>
                          <div class="w-15 h-15 rounded-lg bg-gray-100 flex items-center justify-center text-black font-bold">
                            <%= assignment.person.initials %>
                          </div>
                        <% end %>
                      </div>
                    <% end %>
                  <% end %>
                <% else %>
                  <div class="text-sm text-gray-500 items-center">
                    You haven't added any cast members to this show yet.
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>
    <% end %>

    <% if Current.user.manager? %>
      <div class="mt-2">
        <%= render partial: "shared/link_button", locals: {text: "+ Schedule a Show", path: new_manage_production_show_path(@production)} %>
      </div>
    <% end %>
  </div>
</div>
