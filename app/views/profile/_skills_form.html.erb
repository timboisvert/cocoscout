<%
  # Skills form section
  # Parameters:
  # - person_form: the form builder

  # Group existing skills by category
  skills_by_category = @person.profile_skills.group_by(&:category)
  all_categories = ProfileSkillsService.all_categories
%>

<div id="skills" class="bg-white border border-gray-200 rounded-lg overflow-hidden mb-6" data-controller="profile-section">
  <%= render "shared/section_header",
    title: "Skills & Talents",
    collapsible: true,
    visibility_toggle: true,
    visibility_field_name: "person[profile_visibility_settings][skills_visible]",
    visibility_checked: @person.profile_skills_visible? %>

  <div class="p-6 space-y-6" data-profile-section-target="content">
    <p class="text-sm text-gray-600">
      Select skills from the categories below. You can add multiple skills per category.
    </p>

    <% all_categories.each do |category| %>
      <div class="border-t border-gray-200 pt-4 first:border-t-0 first:pt-0">
        <h4 class="text-sm font-semibold text-gray-900 mb-3">
          <%= ProfileSkillsService.category_display_name(category) %>
        </h4>

        <div class="flex flex-wrap gap-2">
          <% available_skills = ProfileSkillsService.skills_for_category(category) %>
          <% available_skills.each do |skill_name| %>
            <%
              existing_skill = @person.profile_skills.find { |s| s.category == category && s.skill_name == skill_name }
              is_checked = existing_skill.present?
            %>

            <label class="inline-flex items-center px-3 py-1 rounded-full border cursor-pointer transition-all <%= is_checked ? 'bg-pink-50 border-pink-500 text-pink-700' : 'bg-gray-50 border-gray-300 text-gray-700 hover:border-gray-400' %>">
              <% if existing_skill %>
                <%= person_form.fields_for :profile_skills, existing_skill do |skill_form| %>
                  <%= skill_form.hidden_field :id %>
                  <%= skill_form.hidden_field :category %>
                  <%= skill_form.hidden_field :skill_name %>
                  <%= skill_form.check_box :_destroy,
                      { checked: false, class: "sr-only skill-checkbox" },
                      "0", "1" %>
                <% end %>
              <% else %>
                <input type="checkbox"
                       name="person[profile_skills_attributes][<%= category %>_<%= skill_name.parameterize.underscore %>][category]"
                       value="<%= category %>"
                       class="sr-only skill-checkbox"
                       data-skill-category="<%= category %>"
                       data-skill-name="<%= skill_name %>"
                       onchange="this.checked ? this.nextElementSibling.value = '<%= skill_name %>' : this.nextElementSibling.value = ''">
                <input type="hidden"
                       name="person[profile_skills_attributes][<%= category %>_<%= skill_name.parameterize.underscore %>][skill_name]"
                       value="">
              <% end %>
              <span class="text-sm"><%= skill_name %></span>
            </label>
          <% end %>
        </div>
      </div>
    <% end %>

    <style>
      .skill-checkbox:checked + span,
      .skill-checkbox:checked ~ span {
        font-weight: 500;
      }
      label:has(.skill-checkbox:checked) {
        background-color: rgb(253 242 248);
        border-color: rgb(236 72 153);
        color: rgb(190 24 93);
      }
    </style>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // Handle skill checkbox changes
        document.querySelectorAll('.skill-checkbox').forEach(checkbox => {
          checkbox.addEventListener('change', function() {
            const label = this.closest('label');
            if (this.checked) {
              label.classList.remove('bg-gray-50', 'border-gray-300', 'text-gray-700');
              label.classList.add('bg-pink-50', 'border-pink-500', 'text-pink-700');
            } else {
              label.classList.remove('bg-pink-50', 'border-pink-500', 'text-pink-700');
              label.classList.add('bg-gray-50', 'border-gray-300', 'text-gray-700');
            }
          });
        });
      });
    </script>
  </div>
</div>
