<% content_for :title, "Edit Questionnaire - #{@questionnaire.title}" %>

<div class="w-full">
  <%= render partial: "shared/notice", locals: { notice: notice } %>
  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [
      ["Questionnaires", manage_production_questionnaires_path(@production)],
      [@questionnaire.title, manage_production_questionnaire_path(@production, @questionnaire)]
    ],
    text: "Edit Questionnaire",
    links: [
      { text: "Preview Questionnaire", path: preview_manage_production_questionnaire_path(@production, @questionnaire), target: "_blank" }
    ]
  } %>

  <% if @questionnaire.archived_at.present? %>
    <div class="mb-4 p-4 bg-gray-100 border border-gray-300 rounded-lg">
      <div class="flex items-center gap-2">
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-200 text-gray-800">
          Archived
        </span>
        <span class="text-sm text-gray-700">This questionnaire was archived on <%= @questionnaire.archived_at.strftime("%b %d, %Y") %>. You can view the settings but cannot make changes.</span>
      </div>
    </div>
  <% end %>

  <!-- Section 1: Basic Settings -->
  <div class="mb-4 border border-gray-200 rounded-lg overflow-hidden" data-controller="show-toggle" data-show-toggle-initial-open-value="false">
    <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 flex items-center justify-between cursor-pointer" data-action="click->show-toggle#toggle">
      <h3 class="text-md font-semibold text-gray-900 coustard-regular">Basic Settings</h3>
      <div data-show-toggle-target="icon"></div>
    </div>
    <div data-show-toggle-target="content" class="hidden">
      <%= form_with model: [:manage, @production, @questionnaire], class: "contents" do |form| %>
        <div class="p-4">
          <div class="space-y-6">
            <div>
              <%= form.label :title, "Questionnaire Title", class: "block text-sm font-medium text-gray-700 mb-2" %>
              <%= form.text_field :title, class: "block w-full rounded-lg border border-gray-300 px-3 py-2", placeholder: "e.g., Actor Information Form", disabled: @questionnaire.archived_at.present? %>
              <% if @questionnaire.errors[:title].any? %>
                <p class="mt-1 text-sm text-red-600"><%= @questionnaire.errors[:title].first %></p>
              <% end %>
            </div>

            <div>
              <%= form.label :instruction_text, "Instruction Text", class: "block text-sm font-medium text-gray-700 mb-2" %>
              <p class="text-sm text-gray-500 mb-2">At the top of the questionnaire you can add text to provide instructions or context.</p>
              <%= form.rich_text_area :instruction_text, class: ["block shadow-sm rounded-lg border px-3 py-2 w-full max-h-96 overflow-auto min-w-0", {"border-gray-400": @questionnaire.errors[:instruction_text].none?, "border-pink-500": @questionnaire.errors[:instruction_text].any?}], disabled: @questionnaire.archived_at.present? %>
            </div>

            <% unless @questionnaire.archived_at.present? %>
              <div class="border-t border-gray-200 pt-4">
                <%= form.submit "Save Settings", class: "w-full sm:w-auto rounded-lg px-3.5 py-2.5 bg-pink-500 hover:bg-pink-600 text-white inline-block font-medium text-sm cursor-pointer" %>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Section 2: Availability -->
  <div class="mb-4 border border-gray-200 rounded-lg overflow-hidden" data-controller="show-toggle availability-filter" data-show-toggle-initial-open-value="false">
    <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 flex items-center justify-between cursor-pointer" data-action="click->show-toggle#toggle">
      <h3 class="text-md font-semibold text-gray-900 coustard-regular">Availability</h3>
      <div data-show-toggle-target="icon"></div>
    </div>
    <div data-show-toggle-target="content" class="hidden">
      <%= form_with model: [:manage, @production, @questionnaire], class: "contents" do |form| %>
        <div class="p-4">
          <p class="text-sm text-gray-500 mb-4">Include a section on the questionnaire where respondents can indicate their availability for scheduled events.</p>

          <div class="mb-1">
            <%= form.check_box :include_availability_section, class: "rounded accent-pink-500 border-gray-300 text-pink-600 focus:ring-pink-500", data: { action: "change->availability-filter#toggleSection", availability_filter_target: "enableCheckbox" }, disabled: @questionnaire.archived_at.present? %>
            <%= form.label :include_availability_section, "Request availability in questionnaire", class: "ml-2 text-sm text-gray-700" %>
          </div>

          <div class="<%= @questionnaire.include_availability_section == true ? '' : 'hidden' %>" data-availability-filter-target="eventSection">
            <div class="mb-4">
              <%= form.check_box :require_all_availability, class: "rounded accent-pink-500 border-gray-300 text-pink-600 focus:ring-pink-500", disabled: @questionnaire.archived_at.present? %>
              <%= form.label :require_all_availability, "Require respondents to enter availability in order to submit questionnaire", class: "ml-2 text-sm text-gray-700" %>
            </div>

            <label class="text-sm font-medium text-gray-700 block mb-2">Include:</label>
            <div class="space-y-2">
              <div>
                <%= radio_button_tag "show_filter_mode", "all", @questionnaire.availability_show_ids.blank?, class: "rounded-full accent-pink-500 border-gray-300 text-pink-600 focus:ring-pink-500", data: { action: "change->availability-filter#updateFilter" }, disabled: @questionnaire.archived_at.present? %>
                <%= label_tag "show_filter_mode_all", "All Shows & Events", class: "ml-2 text-sm text-gray-700" %>
                <% if @shows.any? %>
                  <button type="button" class="ml-2 text-xs text-pink-500 underline cursor-pointer <%= @questionnaire.availability_show_ids.present? ? 'hidden' : '' %>" data-action="click->availability-filter#toggleShowList" data-availability-filter-target="showListToggle">
                    Show Shows & Events (<span data-availability-filter-target="count"><%= @shows.count %></span>)
                  </button>
                <% end %>
              </div>

              <% if @shows.any? %>
                <div class="hidden ml-6 bg-gray-50 rounded-lg p-3 max-h-40 overflow-y-auto" data-availability-filter-target="showList">
                  <ul class="space-y-1 text-sm">
                    <% @shows.each do |show| %>
                      <li class="flex justify-between" data-show-id="<%= show.id %>">
                        <span class="text-gray-900">
                          <span class="inline-flex items-center rounded-md px-1.5 py-0.5 text-xs font-medium ring-1 ring-inset <%= case show.event_type
                            when "rehearsal" then "bg-blue-50 text-blue-700 ring-blue-600/10"
                            when "meeting" then "bg-green-50 text-green-700 ring-green-600/10"
                            else "bg-pink-50 text-pink-700 ring-pink-600/10"
                          end %>">
                            <%= show.event_type.titleize %>
                          </span>
                          <%= show.date_and_time.strftime("%a, %b %-d at %-l:%M %p") %>
                          <% if show.secondary_name.present? %>
                            - <%= show.secondary_name %>
                          <% end %>
                        </span>
                      </li>
                    <% end %>
                  </ul>
                </div>
              <% end %>

              <div>
                <%= radio_button_tag "show_filter_mode", "specific", @questionnaire.availability_show_ids.present?, class: "rounded-full accent-pink-500 border-gray-300 text-pink-600 focus:ring-pink-500", data: { action: "change->availability-filter#updateFilter" }, disabled: @questionnaire.archived_at.present? %>
                <%= label_tag "show_filter_mode_specific", "Specific shows & events", class: "ml-2 text-sm text-gray-700" %>
              </div>
            </div>

            <%= hidden_field_tag "questionnaire[availability_show_ids][]", "" %>
            <div class="ml-6 mt-2 space-y-1 <%= @questionnaire.availability_show_ids.present? ? '' : 'hidden' %>" data-availability-filter-target="checkboxes">
              <% @shows.each do |show| %>
                <div>
                  <%= check_box_tag "questionnaire[availability_show_ids][]", show.id, @questionnaire.availability_show_ids&.include?(show.id), id: "questionnaire_availability_show_ids_#{show.id}", class: "rounded accent-pink-500 border-gray-300 text-pink-600 focus:ring-pink-500", data: { action: "change->availability-filter#updateShowList", availability_filter_target: "checkbox" }, disabled: @questionnaire.archived_at.present? %>
                  <%= label_tag "questionnaire_availability_show_ids_#{show.id}", class: "ml-2 text-sm text-gray-700 cursor-pointer" do %>
                    <span class="inline-flex items-center rounded-md px-1.5 py-0.5 text-xs font-medium ring-1 ring-inset <%= case show.event_type
                      when "rehearsal" then "bg-blue-50 text-blue-700 ring-blue-600/10"
                      when "meeting" then "bg-green-50 text-green-700 ring-green-600/10"
                      else "bg-pink-50 text-pink-700 ring-pink-600/10"
                    end %>">
                      <%= show.event_type.titleize %>
                    </span>
                    <%= show.date_and_time.strftime("%a, %b %-d at %-l:%M %p") %>
                    <% if show.secondary_name.present? %>
                      <span class="text-gray-500">- <%= show.secondary_name %></span>
                    <% end %>
                  <% end %>
                </div>
              <% end %>
            </div>

            <div class="mt-2">
              <%= link_to "Manage Shows & Events", manage_production_shows_path(@production), class: "text-xs text-pink-500 underline" %>
            </div>
          </div>

          <% unless @questionnaire.archived_at.present? %>
            <div class="border-t border-gray-200 pt-4 mt-4">
              <%= form.submit "Save Availability Settings", class: "w-full sm:w-auto rounded-lg px-3.5 py-2.5 bg-pink-500 hover:bg-pink-600 text-white inline-block font-medium text-sm cursor-pointer" %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Section 3: Custom Questions -->
  <div class="mb-4 border border-gray-200 rounded-lg overflow-hidden" data-controller="show-toggle" data-show-toggle-initial-open-value="<%= params[:question_id].present? || params[:questions_open].present? || @question.errors.any? %>">
    <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 flex items-center justify-between cursor-pointer" data-action="click->show-toggle#toggle">
      <h3 class="text-md font-semibold text-gray-900 coustard-regular">Custom Questions</h3>
      <div data-show-toggle-target="icon"></div>
    </div>
    <div data-show-toggle-target="content">
      <div class="p-4">
        <p class="text-sm text-gray-500 mb-4">Add custom questions to your questionnaire.</p>

        <div class="flex flex-col md:flex-row gap-4">
          <!-- Left: Questions List -->
          <div class="flex-1 space-y-2">
            <% if @questions.any? %>
              <div class="space-y-2" data-controller="<%= @questionnaire.archived_at.present? ? '' : 'question-order' %>" data-question-order-url="<%= reorder_questions_manage_production_questionnaire_path(@production, @questionnaire) %>">
                <% @questions.each do |question| %>
                  <div class="p-4 border border-gray-200 bg-white rounded-lg <%= @questionnaire.archived_at.present? ? '' : 'hover:border-gray-400 transition-all cursor-move' %>" <%= 'draggable="true"' unless @questionnaire.archived_at.present? %> data-question-order-target="item" data-id="<%= question.id %>" data-action="<%= @questionnaire.archived_at.present? ? '' : 'dragstart->question-order#startDrag dragend->question-order#endDrag dragover->question-order#dragOver drop->question-order#drop touchstart->question-order#touchStart touchmove->question-order#touchMove touchend->question-order#touchEnd' %>" onclick="event.stopPropagation();">
                    <div class="flex items-start gap-4">
                      <% unless @questionnaire.archived_at.present? %>
                        <span class="text-gray-400 cursor-move mt-1" title="Drag to reorder">
                          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9h16.5m-16.5 6.75h16.5" />
                          </svg>
                        </span>
                      <% end %>
                      <div class="flex-1">
                        <p class="mb-1 font-bold">
                          <%= question.text %>
                        </p>
                        <p class="text-sm text-gray-500 mb-1">
                          Type: <%= question.question_type_class&.label || question.question_type %>
                          <% if question.question_type_class&.needs_options? && question.question_options.any? %>
                          <span class="ml-1 text-gray-500">(Options: <%= question.question_options.pluck(:text).join(", ") %>)</span>
                          <% end %>
                        </p>
                        <p class="text-sm text-gray-500 mb-2">
                          Required: <%= question.required ? "Yes" : "No" %>
                        </p>
                        <% unless @questionnaire.archived_at.present? %>
                          <div class="flex gap-2 items-baseline">
                            <%= link_to "Edit",
                                form_manage_production_questionnaire_path(@production, @questionnaire, question_id: question.id),
                                class: "text-xs underline text-pink-500 hover:text-pink-600",
                                data: { turbo_frame: "_top" }
                            %>
                            <%= button_to "Delete",
                                destroy_question_manage_production_questionnaire_path(@production, @questionnaire, question_id: question.id),
                                method: :delete,
                                form: { data: { turbo_confirm: "Are you sure you want to delete this question?" }, class: "inline" },
                                class: "text-xs underline text-pink-500 hover:text-pink-600 cursor-pointer border-0 bg-transparent p-0 font-normal leading-none"
                            %>
                          </div>
                        <% end %>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            <% else %>
              <div class="p-4 text-sm border border-gray-200 bg-white rounded-lg text-left text-gray-500">
                No questions yet. Add your first question using the form on the right.
              </div>
            <% end %>
          </div>

          <!-- Right: Question Form -->
          <% unless @questionnaire.archived_at.present? %>
            <div class="flex-1">
              <div class="sticky top-4 border border-gray-200 rounded-lg overflow-hidden bg-white" id="question-form">
                <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
                  <h3 class="text-md font-semibold text-gray-900 coustard-regular"><%= @question.persisted? ? "Edit Question" : "Add a Question" %></h3>
                </div>

                <%= form_with url: (@question.persisted? ? update_question_manage_production_questionnaire_path(@production, @questionnaire, question_id: @question.id) : create_question_manage_production_questionnaire_path(@production, @questionnaire)), model: @question, method: (@question.persisted? ? :patch : :post), class: "p-6" do |form| %>

                  <div class="mb-4">
                    <%= form.label :text, "Question Text", class: "text-sm font-medium" %>
                    <%= form.text_field :text, class: ["block shadow-sm rounded-lg border px-3 py-2 mt-2 w-full", {"border-gray-400": @question.errors[:text].none?, "border-pink-500": @question.errors[:text].any?}] %>
                  </div>

                  <div data-controller="form-toggle">
                    <div class="flex gap-2 mb-4">
                      <div class="flex-1">
                        <%= form.label :question_type, "Question Type", class: "text-sm font-medium" %>
                        <%= form.select :question_type,
                          QuestionTypes::Base.all_types.map { |type| [type.label, type.key] },
                          {},
                          { class: ["block shadow-sm rounded-lg border px-3 py-2 mt-2 w-full", {"border-gray-400": @question.errors[:question_type].none?, "border-pink-500": @question.errors[:question_type].any?}],
                            data: { "form-toggle-target": "select", action: "change->form-toggle#toggle"}
                          } %>
                      </div>

                      <div class="w-32">
                        <%= form.label :required, "Required", class: "text-sm font-medium" %>
                        <%= form.select :required,
                          [["No", false], ["Yes", true]],
                          {},
                          { class: ["block shadow-sm rounded-lg border px-3 py-2 mt-2 w-full", {"border-gray-400": @question.errors[:required].none?, "border-pink-500": @question.errors[:required].any?}] } %>
                      </div>
                    </div>

                    <div data-form-toggle-target="section" data-toggle-value="multiple,ranking" class="hidden mb-4">
                      <%= render partial: "manage/audition_cycles/multiple_options", locals: { form: form } %>
                    </div>
                  </div>

                  <div class="border-t border-gray-200 pt-4">
                    <%= form.submit @question.persisted? ? "Update Question" : "Add Question", class: "w-full sm:w-auto rounded-lg px-3.5 py-2.5 bg-pink-500 hover:bg-pink-600 text-white font-medium cursor-pointer" %>
                    <% if @question.persisted? %>
                      <%= link_to "Cancel", form_manage_production_questionnaire_path(@production, @questionnaire), class: "w-full sm:w-auto text-center mt-2 sm:mt-0 sm:ml-2 rounded-lg px-3.5 py-2.5 bg-gray-100 hover:bg-gray-50 inline-block font-medium" %>
                    <% end %>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

</div>
