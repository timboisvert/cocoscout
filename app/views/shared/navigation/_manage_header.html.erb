<header class="hidden lg:flex fixed top-0 left-0 right-0 h-16 bg-white border-b border-gray-200 items-center justify-between z-30">
  <div class="flex items-center gap-8 pl-4">
    <%= link_to manage_path, class:"mt-2" do %>
      <span class="text-3xl font-semibold coustard-regular text-pink-500">CocoScout</span>
    <% end %>

    <div class="flex items-center gap-4 mt-2 ml-10">
      <span class="text-2xl font-semibold coustard-regular text-slate-800">Production Dashboard</span>
      <%= link_to "Switch to Talent Dashboard", my_dashboard_path, data: { turbo: false }, class: "text-xs text-pink-500 hover:text-pink-600 transition font-medium mt-1" %>
    </div>
  </div>

  <div class="flex items-center mr-2">
    <!-- Production Selector -->
    <% if Current.organization.present? %>
      <div class="relative" data-controller="dropdown">
        <button data-action="click->dropdown#toggle click@window->dropdown#hide" class="flex items-center gap-3 hover:bg-slate-50 px-3 py-2 transition cursor-pointer h-12 border-l border-r border-slate-200">
          <% if Current.production.present? && !Current.production.new_record? %>
            <% logo_variant = Current.production.safe_logo_variant(:small) %>
            <% if logo_variant %>
              <div class="w-16 h-8 flex items-center justify-center flex-shrink-0 rounded">
                <%= image_tag logo_variant, alt: "#{Current.production.name} logo", class: "w-16 h-8 object-cover rounded" %>
              </div>
            <% else %>
              <div class="w-16 h-8 flex items-center justify-center flex-shrink-0 rounded bg-gray-100 text-gray-600 font-bold text-xs">
                <%= Current.production.initials %>
              </div>
            <% end %>
            <div class="text-sm font-medium text-slate-700 max-w-[200px] truncate"><%= Current.production.name %></div>
          <% else %>
            <div class="text-sm font-medium text-slate-700">Select Production</div>
          <% end %>
          <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </button>

        <div data-dropdown-target="menu" class="hidden absolute right-0 mt-2 w-72 bg-white rounded-lg shadow-lg border border-slate-200 py-1">
          <!-- Current Production Section -->
          <% if Current.production.present? && !Current.production.new_record? %>
            <%= link_to edit_manage_production_path(Current.production), data: { turbo: false }, class: "block px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 transition cursor-pointer" do %>
              <div class="flex items-center gap-3">
                <% logo_variant = Current.production.safe_logo_variant(:small) %>
                <% if logo_variant %>
                  <div class="w-16 h-8 flex items-center justify-center flex-shrink-0 rounded">
                    <%= image_tag logo_variant, alt: "#{Current.production.name} logo", class: "w-16 h-8 object-cover rounded" %>
                  </div>
                <% else %>
                  <div class="w-16 h-8 flex items-center justify-center flex-shrink-0 rounded bg-gray-100 text-gray-600 font-bold text-xs">
                    <%= Current.production.initials %>
                  </div>
                <% end %>
                <div class="flex flex-col">
                  <span class="text-sm text-slate-900 font-medium"><%= Current.production.name %></span>
                  <% if current_user_is_global_manager? %>
                    <span class="text-xs text-pink-500 hover:text-pink-600 underline">Production Settings</span>
                  <% end %>
                </div>
              </div>
            <% end %>
          <% end %>

          <!-- Other Productions List -->
          <% other_productions = Current.user.accessible_productions.reject { |p| p.id == Current.production&.id } %>
          <% if other_productions.any? %>
            <% if Current.production.present? && !Current.production.new_record? %>
              <div class="border-t border-slate-200 my-1"></div>
            <% end %>

            <div class="px-4 py-2 text-xs text-slate-500 font-semibold uppercase">Other Productions</div>
            <% other_productions.each do |production| %>
              <%= link_to manage_production_path(production), data: { turbo: false }, class: "flex items-center hover:bg-slate-50 transition cursor-pointer py-2 px-4" do %>
                <% logo_variant = production.safe_logo_variant(:small) %>
                <% if logo_variant %>
                  <div class="w-16 h-8 flex items-center justify-center flex-shrink-0 rounded">
                    <%= image_tag logo_variant, alt: "#{production.name} logo", class: "w-16 h-8 object-cover rounded" %>
                  </div>
                <% else %>
                  <div class="w-16 h-8 flex items-center justify-center flex-shrink-0 rounded bg-gray-100 text-gray-600 font-bold text-xs">
                    <%= production.initials %>
                  </div>
                <% end %>
                <span class="truncate text-sm ml-3"><%= production.name %></span>
              <% end %>
            <% end %>
          <% end %>

          <!-- Create Production Link -->
          <% if Current.user.manager? %>
            <div class="border-t border-slate-200 my-1"></div>
            <%= link_to new_manage_production_path, data: { turbo: false }, class: "flex items-center gap-3 px-4 py-2 text-sm text-pink-500 hover:bg-slate-50 transition cursor-pointer font-medium" do %>
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
              </svg>
              Create a Production
            <% end %>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- User Profile and Impersonation Banner -->
    <div class="flex items-center gap-3">
      <% if impersonating? %>
        <div class="flex items-center gap-3 bg-pink-100 border border-pink-300 px-4 py-2 rounded-lg">
          <div class="flex flex-col">
            <div class="text-xs font-semibold text-pink-800 uppercase">Impersonating</div>
            <div class="text-sm font-medium text-pink-900"><%= Current.user.person&.name || Current.user.email_address %></div>
          </div>
          <%= button_to stop_impersonating_user_path, method: :post, class: "px-3 py-1 rounded-md bg-pink-600 text-white font-semibold text-sm hover:bg-pink-700 transition cursor-pointer" do %>
            Stop
          <% end %>
        </div>
      <% end %>

      <div class="relative" data-controller="dropdown">
        <button data-action="click->dropdown#toggle click@window->dropdown#hide" class="flex items-center gap-3 hover:bg-slate-50 rounded-lg px-3 py-2 transition cursor-pointer h-12">
          <% if Current.user.person&.headshot&.attached? %>
            <%= image_tag Current.user.person.headshot, class: "w-8 h-8 rounded-lg object-cover" %>
          <% else %>
            <div class="w-8 h-8 rounded-lg bg-pink-100 text-pink-500 flex items-center justify-center font-semibold text-sm">
              <%= Current.user.person&.name&.split&.map(&:first)&.join&.upcase || Current.user.email_address[0].upcase %>
            </div>
          <% end %>
          <div class="flex flex-col items-start">
            <div class="text-sm font-medium text-slate-700"><%= Current.user.person&.name || Current.user.email_address %></div>
            <% if Current.organization.present? %>
              <div class="text-xs text-slate-500"><%= Current.organization.name %></div>
            <% end %>
          </div>
          <svg class="w-4 h-4 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </button>

        <div data-dropdown-target="menu" class="hidden absolute right-0 mt-2 w-72 bg-white rounded-lg shadow-lg border border-slate-200 py-1">
          <%= link_to "My Profile", profile_path, class: "block px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 transition cursor-pointer" %>

          <% if Current.organization.present? %>
            <div class="border-t border-slate-200 my-1"></div>

            <!-- Organization Section -->
            <div class="px-4 py-3">
              <div class="text-xs text-slate-500 font-semibold uppercase mb-2">Organization</div>
              <div class="flex items-center justify-between mb-2">
                <div class="text-sm text-slate-900 font-medium"><%= Current.organization.name %></div>
              </div>
              <div class="flex flex-col gap-1">
                <% if current_user_is_global_manager? %>
                  <%= link_to "Manage this Organization", manage_organization_path(Current.organization), class: "text-xs text-pink-500 hover:text-pink-600 underline" %>
                <% end %>
                <% if Current.user.organizations.count > 1 %>
                  <%= link_to "Switch Organization", select_organization_path, class: "text-xs text-pink-500 hover:text-pink-600 underline" %>
                <% end %>
                <%= link_to "All My Organizations", manage_organizations_path, class: "text-xs text-pink-500 hover:text-pink-600 underline" %>
              </div>
            </div>
          <% end %>

          <% if Current.user.superadmin? %>
            <div class="border-t border-slate-200 my-1"></div>
            <%= link_to "Superadmin", superadmin_path, class: "block px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 transition cursor-pointer" %>
          <% end %>

          <div class="border-t border-slate-200 my-1"></div>

          <%= link_to "Sign Out", signout_path, data: { turbo_prefetch: false }, class: "block px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 transition cursor-pointer" %>
        </div>
      </div>
    </div>
  </div>
</header>
