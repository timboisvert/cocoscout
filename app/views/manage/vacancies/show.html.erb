<% content_for :title, "Vacancy: #{@vacancy.role.name}" %>

<%
  # Determine current step
  if @vacancy.filled?
    current_step = :filled
  elsif @vacancy.not_filling?
    current_step = :not_filling
  elsif @vacancy.cancelled?
    current_step = :cancelled
  elsif @invitations.any?
    current_step = :invite
  else
    current_step = :identified
  end

  show = @vacancy.show
  vacated_by = @vacancy.vacated_by
%>

<div class="w-full">
  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [
      [@production.name, manage_production_path(@production)]
    ],
    text: "Open Vacancy",
    links: []
  } %>

  <!-- Timeline -->
  <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden mb-6">
    <div class="p-6">
      <div class="relative">
        <!-- Timeline line - hidden on mobile -->
        <div class="hidden md:block absolute top-6 left-0 right-0 h-0.5 bg-gray-200" aria-hidden="true" style="left: 4rem; right: 4rem;"></div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-8">
          <!-- Step 1: Vacancy Identified -->
          <div class="relative flex flex-row md:flex-col items-center md:text-center gap-3 md:gap-0">
            <div class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center z-10 ring-4 md:mb-3 transition-all bg-pink-500 ring-pink-500 <%= current_step == :identified ? 'shadow-lg shadow-pink-500/50' : '' %>">
              <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
              </svg>
            </div>
            <h4 class="text-sm font-semibold mb-1 <%= current_step == :identified ? 'text-pink-600' : 'text-gray-900' %>">Vacancy Identified</h4>
            <p class="text-xs text-gray-500">Cast member can't make it</p>
          </div>

          <!-- Step 2: Replacement Invitations Sent -->
          <div class="relative flex flex-row md:flex-col items-center md:text-center gap-3 md:gap-0">
            <div class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center z-10 ring-4 md:mb-3 transition-all <%= [:invite, :filled].include?(current_step) ? 'bg-pink-500 ring-pink-500' : 'bg-gray-200 ring-white' %> <%= current_step == :invite ? 'shadow-lg shadow-pink-500/50' : '' %>">
              <svg class="w-6 h-6 <%= [:invite, :filled].include?(current_step) ? 'text-white' : 'text-gray-400' %>" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" />
              </svg>
            </div>
            <h4 class="text-sm font-semibold mb-1 <%= current_step == :invite ? 'text-pink-600' : 'text-gray-900' %>">Invitations Sent</h4>
            <p class="text-xs text-gray-500">Invite cast members to fill the role</p>
          </div>

          <!-- Step 3: Vacancy Resolved -->
          <div class="relative flex flex-row md:flex-col items-center md:text-center gap-3 md:gap-0">
            <div class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center z-10 ring-4 md:mb-3 transition-all <%= current_step == :filled ? 'bg-pink-500 ring-pink-500 shadow-lg shadow-pink-500/50' : (current_step == :cancelled ? 'bg-gray-400 ring-gray-400' : 'bg-gray-200 ring-white') %>">
              <svg class="w-6 h-6 <%= [:filled, :cancelled].include?(current_step) ? 'text-white' : 'text-gray-400' %>" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            <h4 class="text-sm font-semibold mb-1 <%= current_step == :filled ? 'text-pink-600' : (current_step == :cancelled ? 'text-gray-600' : 'text-gray-900') %>">
              <%= current_step == :cancelled ? 'Cancelled' : 'Vacancy Resolved' %>
            </h4>
            <p class="text-xs text-gray-500"><%= current_step == :cancelled ? 'Vacancy was cancelled' : 'Role has been filled' %></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Show Row -->
  <div class="border border-gray-200 rounded-lg overflow-hidden mb-6 bg-white">
    <%= render "shared/card_header", title: "Show & Role" %>
    <div class="p-4">
      <div class="flex flex-col md:flex-row md:items-stretch bg-white border border-gray-200 rounded-lg overflow-hidden">
        <%# Left half: Affected dates %>
        <div class="w-full md:w-1/2 px-3 py-2">
          <% affected_shows_list = @vacancy.affected_shows.any? ? @vacancy.affected_shows.order(:date_and_time).to_a : [show] %>
          <% if affected_shows_list.size > 1 %>
            <%# Multiple shows stacked vertically %>
            <div class="space-y-2">
              <% affected_shows_list.each do |affected_show| %>
                <div class="flex items-center gap-4">
                  <div class="flex-shrink-0 w-14 text-center">
                    <div class="text-xs font-semibold text-pink-600 uppercase"><%= affected_show.date_and_time.strftime("%b") %></div>
                    <div class="text-2xl font-bold text-gray-900"><%= affected_show.date_and_time.strftime("%-d") %></div>
                    <div class="text-xs text-gray-500"><%= affected_show.date_and_time.strftime("%a") %></div>
                  </div>
                  <div class="min-w-0">
                    <div class="font-medium text-gray-900">
                      <%= affected_show.secondary_name.presence || affected_show.event_type.titleize %>
                    </div>
                    <div class="text-sm text-gray-600">
                      <%= affected_show.date_and_time.strftime("%l:%M %p").strip %>
                      <% if affected_show.is_online %>
                        · Online
                      <% elsif affected_show.location.present? %>
                        · <%= affected_show.location.name %>
                      <% end %>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
            <%# Single show %>
            <div class="flex items-center gap-4">
              <div class="flex-shrink-0 w-14 text-center">
                <div class="text-xs font-semibold text-pink-600 uppercase"><%= show.date_and_time.strftime("%b") %></div>
                <div class="text-2xl font-bold text-gray-900"><%= show.date_and_time.strftime("%-d") %></div>
                <div class="text-xs text-gray-500"><%= show.date_and_time.strftime("%a") %></div>
              </div>
              <div class="min-w-0">
                <div class="font-medium text-gray-900">
                  <%= show.secondary_name.presence || show.event_type.titleize %>
                </div>
                <div class="text-sm text-gray-600">
                  <%= show.date_and_time.strftime("%l:%M %p").strip %>
                  <% if show.is_online %>
                    · Online
                  <% elsif show.location %>
                    · <%= show.location.name %>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        </div>

        <%# Right half: Vacated by entity with role %>
        <div class="w-full md:w-1/2 md:border-l border-t md:border-t-0 border-gray-200 px-3 py-2 flex items-center gap-3">
          <% if vacated_by %>
            <% headshot_variant = vacated_by.safe_headshot_variant(:thumb) %>
            <% if headshot_variant %>
              <%= image_tag headshot_variant, class: "w-10 h-10 rounded-lg object-cover flex-shrink-0" %>
            <% else %>
              <div class="w-10 h-10 rounded-lg bg-gray-200 flex items-center justify-center text-gray-700 font-bold text-sm flex-shrink-0">
                <%= vacated_by.initials %>
              </div>
            <% end %>
          <% end %>
          <div class="flex-1 min-w-0">
            <div class="text-[10px] text-gray-400 uppercase tracking-wide">Can't make it</div>
            <div class="text-sm flex items-center gap-1">
              <span class="font-medium text-gray-900"><%= vacated_by&.name %></span>
              <span class="text-gray-400">as</span>
              <strong class="text-pink-500"><%= @vacancy.role.name %></strong>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Other Cast Members -->
  <% if @other_cast_assignments.any? %>
    <div class="border border-gray-200 rounded-lg overflow-hidden mb-6 bg-white">
      <%= render "shared/card_header", title: "Other Cast Members" do %>
        <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
        </svg>
      <% end %>
      <div class="p-4">
        <div class="flex flex-wrap gap-3">
          <% @other_cast_assignments.each do |assignment| %>
            <% assignable = assignment.assignable %>
            <div class="flex items-center gap-2 px-3 py-2 bg-gray-50 rounded-lg">
              <% headshot_variant = assignable.safe_headshot_variant(:thumb) %>
              <% if headshot_variant %>
                <%= image_tag headshot_variant, class: "w-8 h-8 rounded-lg object-cover flex-shrink-0" %>
              <% else %>
                <div class="w-8 h-8 rounded-lg <%= assignable.is_a?(Person) ? 'bg-gray-200 text-gray-700' : 'bg-blue-100 text-blue-600' %> flex items-center justify-center font-bold text-xs flex-shrink-0">
                  <% if assignable.is_a?(Person) %>
                    <%= assignable.initials %>
                  <% else %>
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-7 8c0-2.66 5.33-4 8-4s8 1.34 8 4v2H5v-2z"/>
                    </svg>
                  <% end %>
                </div>
              <% end %>
              <div class="text-sm">
                <span class="font-medium text-gray-900"><%= assignable.name %></span>
                <span class="text-gray-400 mx-1">as</span>
                <span class="text-pink-500 font-medium"><%= assignment.role.name %></span>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <% if @vacancy.active? || @vacancy.not_filling? %>
    <% is_linked = show.linked? %>
    <% has_invitations = @invitations.any? %>

    <% if is_linked %>
      <!-- Linked Events Decision Wrapper -->
      <div data-controller="linked-vacancy-decision">
        <!-- Linked Events Decision Box -->
        <div class="bg-white border border-pink-200 rounded-lg shadow-sm overflow-hidden mb-6">
          <div class="bg-pink-50 px-4 py-3 border-b border-pink-200">
            <h3 class="text-md font-semibold text-gray-900 coustard-regular flex items-center gap-2">
              <svg class="w-5 h-5 text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
              </svg>
              Linked Events
            </h3>
          </div>
          <div class="p-4">
            <div class="flex flex-col md:flex-row md:items-stretch gap-4">
              <%# Left half: All linked events %>
              <div class="w-full md:w-1/2 md:pr-4 md:border-r border-gray-200">
                <h4 class="text-sm font-semibold text-gray-900 mb-3">All Events in This Linkage</h4>
                <div class="space-y-2">
                  <% all_linked_shows = show.event_linkage.shows.order(:date_and_time) %>
                  <% affected_show_ids = @vacancy.affected_shows.pluck(:id) %>
                  <% all_linked_shows.each do |linked_show| %>
                    <% is_past = linked_show.date_and_time < Time.current %>
                    <% is_affected = affected_show_ids.include?(linked_show.id) %>
                    <div class="flex items-center gap-4 <%= is_past ? 'opacity-50' : '' %>">
                      <div class="flex-shrink-0 w-14 text-center">
                        <div class="text-xs font-semibold text-pink-600 uppercase"><%= linked_show.date_and_time.strftime("%b") %></div>
                        <div class="text-2xl font-bold text-gray-900"><%= linked_show.date_and_time.strftime("%-d") %></div>
                        <div class="text-xs text-gray-500"><%= linked_show.date_and_time.strftime("%a") %></div>
                      </div>
                      <div class="min-w-0">
                        <div class="font-medium text-gray-900">
                          <%= linked_show.secondary_name.presence || linked_show.event_type.titleize %>
                        </div>
                        <div class="text-sm text-gray-600">
                          <%= linked_show.date_and_time.strftime("%l:%M %p").strip %>
                          <% if is_past %>
                            · Past event
                          <% elsif is_affected %>
                            · <span class="text-pink-600 font-medium">Can't make it</span>
                          <% end %>
                        </div>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>

              <%# Right half: Decision options %>
              <div class="w-full md:w-1/2 md:pl-4 border-t md:border-t-0 pt-4 md:pt-0">
                <h4 class="text-sm font-semibold text-gray-900 mb-2">Choose an Action</h4>
                <p class="text-sm text-gray-600 mb-4">
                  This vacancy affects <%= @vacancy.affected_shows.count %> linked events. Since these events share the same cast, you have two options:
                </p>

                <%
                  # Determine which option should be selected
                  # not_filling = "Don't find a replacement" is selected
                  # Otherwise, if there are invitations, "Find a replacement" is selected
                  show_recast = !@vacancy.not_filling? && has_invitations
                  show_no_action = @vacancy.not_filling?
                %>

                <div class="space-y-4">
                  <!-- Option 1: Find replacement -->
                  <label class="block cursor-pointer group">
                    <div class="flex items-start gap-3 p-4 border <%= show_recast ? 'border-pink-300 bg-pink-50' : 'border-gray-200' %> rounded-lg group-hover:border-pink-300 transition-colors" data-action="click->linked-vacancy-decision#selectRecast">
                      <input type="radio"
                             name="linked_decision"
                             value="recast"
                             <%= 'checked' if show_recast %>
                             data-linked-vacancy-decision-target="recastRadio"
                             class="mt-1 accent-pink-500 cursor-pointer">
                      <div>
                        <div class="font-semibold text-gray-900">Find a replacement for all events</div>
                        <p class="text-sm text-gray-500 mt-1">
                          Send invitations to find someone to cover the <strong><%= @vacancy.role.name %></strong> role for all <%= @vacancy.affected_shows.count %> affected events. The new cast member will be assigned to each event once they accept.
                        </p>
                      </div>
                    </div>
                  </label>

                  <!-- Option 2: No replacement -->
                  <label class="block cursor-pointer group">
                    <div class="flex items-start gap-3 p-4 border <%= show_no_action ? 'border-gray-300 bg-gray-50' : 'border-gray-200' %> rounded-lg group-hover:border-gray-300 transition-colors" data-action="click->linked-vacancy-decision#selectNoAction">
                      <input type="radio"
                             name="linked_decision"
                             value="no_action"
                             <%= 'checked' if show_no_action %>
                             data-linked-vacancy-decision-target="noActionRadio"
                             class="mt-1 accent-pink-500 cursor-pointer">
                      <div>
                        <div class="font-semibold text-gray-900">Don't find a replacement</div>
                        <p class="text-sm text-gray-500 mt-1">
                          The original cast member is still assigned to these events. They've let you know they can't make it, but you can work with them directly to resolve this outside of CocoScout. Close this vacancy when resolved.
                        </p>
                      </div>
                    </div>
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- The invitation section is shown/hidden based on decision (shown if recast is selected) -->
        <div data-linked-vacancy-decision-target="inviteSection" class="<%= show_recast ? '' : 'hidden' %>">
    <% end %>

    <!-- Invitations Sent -->
    <% if @invitations.any? %>
      <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden mb-6">
        <%= render "shared/card_header", title: "Invitations Sent" %>
        <div class="p-4">
          <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">
            <% @invitations.each do |invitation| %>
              <div class="flex flex-col items-center text-center p-3 border border-gray-200 rounded-lg bg-white group">
                <% headshot = invitation.person.safe_headshot_variant(:thumb) %>
                <% if headshot %>
                  <%= image_tag headshot, alt: invitation.person.name, class: "w-12 h-12 rounded-lg object-cover mb-2" %>
                <% else %>
                  <div class="w-12 h-12 rounded-lg bg-gray-200 flex items-center justify-center text-gray-700 font-bold text-xs mb-2">
                    <%= invitation.person.initials %>
                  </div>
                <% end %>
                <div class="font-medium text-gray-900 text-sm truncate w-full"><%= invitation.person.name %></div>
                <div class="mt-1">
                  <% if invitation.claimed? %>
                    <span class="inline-flex items-center rounded-md bg-green-50 px-2 py-0.5 text-xs font-medium text-green-700 ring-1 ring-inset ring-green-600/20">
                      Claimed
                    </span>
                  <% elsif invitation.expired? %>
                    <span class="inline-flex items-center rounded-md bg-gray-50 px-2 py-0.5 text-xs font-medium text-gray-600 ring-1 ring-inset ring-gray-500/10">
                      Expired
                    </span>
                  <% elsif invitation.declined? %>
                    <span class="inline-flex items-center rounded-md bg-gray-50 px-2 py-0.5 text-xs font-medium text-gray-600 ring-1 ring-inset ring-gray-500/10">
                      Declined
                    </span>
                  <% else %>
                    <span class="inline-flex items-center rounded-md bg-gray-50 px-2 py-0.5 text-xs font-medium text-gray-600 ring-1 ring-inset ring-gray-500/10">
                      Unanswered
                    </span>
                  <% end %>
                </div>
                <% if invitation.pending? && !invitation.expired? %>
                  <%= button_to resend_manage_production_vacancy_invitation_path(@production, @vacancy, invitation),
                      method: :post,
                      class: "mt-2 text-xs text-pink-500 hover:text-pink-600 cursor-pointer opacity-0 group-hover:opacity-100 transition-opacity",
                      form: { class: "inline" } do %>
                    Resend
                  <% end %>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>

    <!-- Invite Cast Members Box -->
    <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden mb-6">
      <%= render "shared/card_header", title: @invitations.any? ? "Invite More Cast Members" : "Invite Cast Members" %>
      <div class="p-6">
        <% if @vacancy.restricted? %>
          <div class="mb-4 p-3 bg-amber-50 border border-amber-200 rounded-lg">
            <div class="flex items-start gap-2">
              <svg class="w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
              </svg>
              <div>
                <p class="text-sm font-medium text-amber-800">Restricted Role</p>
                <p class="text-xs text-amber-700 mt-0.5">
                  Only cast members marked as eligible for "<%= @vacancy.role.name %>" can be invited.
                  <% eligible_count = @vacancy.eligible_members.count %>
                  <span class="font-semibold"><%= pluralize(eligible_count, "cast member") %></span> eligible total.
                </p>
              </div>
            </div>
          </div>
        <% else %>
          <!-- Unrestricted role: show radio options -->
        <% end %>

        <% if @eligible_people.any? || @all_potential_people.any? %>
          <%= form_with url: send_invitations_manage_production_vacancy_path(@production, @vacancy), method: :post, class: "space-y-6", data: { controller: "invite-mode" } do %>
            <% unless @vacancy.restricted? %>
              <!-- Selection Mode (unrestricted roles only) -->
              <div class="mb-4">
                <label class="block font-semibold mb-2 text-sm">
                  <%= @invitations.any? ? "Select More Recipients:" : "Select Recipients:" %>
                </label>
                <div class="space-y-2">
                  <div>
                    <label class="flex items-center cursor-pointer">
                      <input type="radio"
                             name="invite_mode"
                             value="all"
                             checked
                             data-invite-mode-target="modeRadio"
                             data-action="change->invite-mode#updateMode"
                             class="mr-2 accent-pink-500 cursor-pointer"
                             <%= 'disabled' if @eligible_members.empty? %>>
                      <span class="text-sm <%= 'text-gray-400' if @eligible_members.empty? %>">All other talent pool members not currently cast in this show (<%= @eligible_members.count %>)</span>
                      <button type="button" data-action="click->invite-mode#togglePeopleList" class="ml-2 text-xs text-pink-500 hover:text-pink-600 underline cursor-pointer">
                        Show
                      </button>
                    </label>
                  </div>

                  <div class="hidden ml-6 p-3 bg-gray-50 border border-gray-200 rounded-lg text-xs" data-invite-mode-target="peopleList">
                    <div class="space-y-1">
                      <% @all_potential_members.each do |member| %>
                        <% is_person = member.is_a?(Person) %>
                        <% is_vacated = member.class.name == @vacated_by_type && member.id == @vacated_by_id %>
                        <% is_already_cast = is_person ? @already_cast_person_ids.include?(member.id) : @already_cast_group_ids.include?(member.id) %>
                        <% is_already_invited = is_person && @already_invited_person_ids.include?(member.id) %>
                        <% is_unavailable = is_vacated || is_already_cast || is_already_invited %>
                        <div class="<%= is_unavailable ? 'text-gray-400' : 'text-gray-600' %>">
                          <%= member.name %><%= ' (Can\'t make it)' if is_vacated %><%= ' (Already cast in this show)' if is_already_cast && !is_vacated %><%= ' (Already invited)' if is_already_invited && !is_already_cast && !is_vacated %>
                        </div>
                      <% end %>
                    </div>
                  </div>

                  <label class="flex items-center cursor-pointer">
                    <input type="radio"
                           name="invite_mode"
                           value="specific"
                           data-invite-mode-target="modeRadio"
                           data-action="change->invite-mode#updateMode"
                           class="mr-2 accent-pink-500 cursor-pointer">
                    <span class="text-sm">Specific cast members</span>
                  </label>
                </div>

                <div class="hidden ml-6 mt-3" data-invite-mode-target="specificPeopleSection">
                  <label class="block font-semibold mb-2 text-sm">Select Recipients</label>
                  <div class="space-y-2 max-h-64 overflow-y-auto border border-gray-300 rounded-lg p-3 bg-gray-50">
                    <% @all_potential_members.each do |member| %>
                      <% is_person = member.is_a?(Person) %>
                      <% is_vacated = member.class.name == @vacated_by_type && member.id == @vacated_by_id %>
                      <% is_already_cast = is_person ? @already_cast_person_ids.include?(member.id) : @already_cast_group_ids.include?(member.id) %>
                      <% is_already_invited = is_person && @already_invited_person_ids.include?(member.id) %>
                      <% is_unavailable = is_vacated || is_already_cast || is_already_invited %>
                      <label class="flex items-center <%= is_unavailable ? 'cursor-not-allowed' : 'cursor-pointer' %>">
                        <input type="checkbox"
                               name="member_ids[]"
                               value="<%= member.class.name %>_<%= member.id %>"
                               class="mr-2 accent-pink-500 <%= is_unavailable ? 'cursor-not-allowed' : 'cursor-pointer' %>"
                               <%= 'disabled' if is_unavailable %>>
                        <span class="text-sm <%= 'text-gray-400' if is_unavailable %>">
                          <%= member.name %>
                          <% if is_vacated %>
                            <span class="text-gray-400">(Can't make it)</span>
                          <% elsif is_already_cast %>
                            <span class="text-gray-400">(Already cast in this show)</span>
                          <% elsif is_already_invited %>
                            <span class="text-gray-400">(Already invited)</span>
                          <% end %>
                        </span>
                      </label>
                    <% end %>
                  </div>
                </div>
              </div>
            <% else %>
              <!-- Restricted role: show cast member checkboxes directly -->
              <div class="mb-4" data-controller="select-all">
                <div class="flex items-center justify-between mb-2">
                  <label class="block font-semibold text-sm">Select Recipients:</label>
                  <button type="button"
                          data-action="click->select-all#toggleAll"
                          data-select-all-target="toggleButton"
                          class="text-xs text-pink-500 hover:text-pink-600 cursor-pointer">
                    Select all
                  </button>
                </div>
                <div class="space-y-2 max-h-64 overflow-y-auto border border-gray-300 rounded-lg p-3 bg-gray-50">
                  <% @all_potential_members.each do |member| %>
                    <% is_person = member.is_a?(Person) %>
                    <% is_vacated = member.class.name == @vacated_by_type && member.id == @vacated_by_id %>
                    <% is_already_cast = is_person ? @already_cast_person_ids.include?(member.id) : @already_cast_group_ids.include?(member.id) %>
                    <% is_already_invited = is_person && @already_invited_person_ids.include?(member.id) %>
                    <% is_unavailable = is_vacated || is_already_cast || is_already_invited %>
                    <label class="flex items-center <%= is_unavailable ? 'cursor-not-allowed' : 'cursor-pointer' %>">
                      <input type="checkbox"
                             name="member_ids[]"
                             value="<%= member.class.name %>_<%= member.id %>"
                             class="mr-2 accent-pink-500 <%= is_unavailable ? 'cursor-not-allowed' : 'cursor-pointer' %>"
                             data-select-all-target="checkbox"
                             <%= 'disabled' if is_unavailable %>>
                      <span class="text-sm <%= 'text-gray-400' if is_unavailable %>">
                        <%= member.name %><%= ' (Can\'t make it)' if is_vacated %><%= ' (Already cast in this show)' if is_already_cast && !is_vacated %><%= ' (Already invited)' if is_already_invited && !is_already_cast && !is_vacated %>
                      </span>
                    </label>
                  <% end %>
                </div>
              </div>
            <% end %>

            <!-- Notification Email -->
            <div class="mb-2">
              <label class="block text-sm font-semibold text-gray-900 mb-2">Notification Email</label>
              <%= fields_for :email_draft, @vacancy_email_draft do |email_form| %>
                <div class="space-y-3">
                  <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Subject</label>
                    <%= render "shared/subject_field_with_prefix", form: email_form, field_name: :title, production: @production, placeholder: "Email subject..." %>
                  </div>
                  <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Message</label>
                    <%= email_form.rich_text_area :body, class: "w-full rounded-lg border border-gray-300 focus:ring-2 focus:ring-pink-500 focus:border-transparent" %>
                  </div>
                </div>
              <% end %>
            </div>

            <%= render "shared/button",
                text: "Send Invitations",
                variant: "primary",
                type: :submit,
                icon: "paper-airplane" %>
          <% end %>
        <% else %>
          <div class="text-center py-4 text-gray-500">
            <p>No one left to invite.</p>
            <p class="text-sm mt-1">Everyone eligible has already been invited.</p>
          </div>
        <% end %>
      </div>
    </div>

    <% if is_linked %>
      </div><!-- Close inviteSection wrapper for linked events -->

      <!-- Close Vacancy Box (for linked events, shown only when "no action" is selected) -->
      <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden mb-6 <%= has_invitations ? 'hidden' : '' %>" data-linked-vacancy-decision-target="closeSection">
        <%= render "shared/card_header", title: "Close Vacancy" %>
        <div class="p-6">
          <p class="text-sm text-gray-600 mb-4">
            If you no longer need to fill this role, you can close the vacancy without finding a replacement.
          </p>
          <%= button_to cancel_manage_production_vacancy_path(@production, @vacancy),
              method: :post,
              form: { data: { turbo_confirm: "Are you sure you want to close this vacancy without filling it? This cannot be undone." } },
              class: "inline-flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 cursor-pointer" do %>
            Close Vacancy Without Filling
          <% end %>
        </div>
      </div>

    </div><!-- Close linked-vacancy-decision controller wrapper -->
    <% else %>
      <!-- Changed Your Mind Box (non-linked only) -->
      <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden mb-6">
        <%= render "shared/card_header", title: "Changed Your Mind?" %>
        <div class="p-6">
          <p class="text-sm text-gray-600 mb-4">
            If you no longer need to fill this role, you can close the vacancy without finding a replacement.
            The show will proceed without someone in this role.
          </p>
          <%= button_to cancel_manage_production_vacancy_path(@production, @vacancy),
              method: :post,
              form: { data: { turbo_confirm: "Are you sure you want to close this vacancy without filling it? This cannot be undone." } },
              class: "inline-flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 cursor-pointer" do %>
            Close Vacancy Without Filling
          <% end %>
        </div>
      </div>
    <% end %>

  <% elsif @vacancy.filled? %>
    <!-- Filled By Box -->
    <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden mb-6">
      <div class="bg-green-50 px-4 py-3 border-b border-green-200">
        <h3 class="text-md font-semibold text-green-900 coustard-regular flex items-center gap-2">
          <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          Role Filled
        </h3>
      </div>
      <div class="p-6">
        <% if @vacancy.filled_by %>
          <div class="flex items-center gap-3">
            <% headshot = @vacancy.filled_by.safe_headshot_variant(:thumb) %>
            <% if headshot %>
              <%= image_tag headshot, alt: @vacancy.filled_by.name, class: "w-12 h-12 rounded-lg object-cover" %>
            <% else %>
              <div class="w-12 h-12 rounded-lg bg-gray-200 flex items-center justify-center text-gray-700 font-bold text-sm">
                <%= @vacancy.filled_by.initials %>
              </div>
            <% end %>
            <div>
              <div class="font-medium text-gray-900"><%= @vacancy.filled_by.name %></div>
              <div class="text-sm text-gray-500">Claimed on <%= @vacancy.filled_at.strftime("%B %d, %Y at %l:%M %p") %></div>
            </div>
          </div>
        <% end %>
      </div>
    </div>


  <% elsif @vacancy.cancelled? %>
    <!-- Cancelled Box -->
    <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden mb-6">
      <div class="bg-purple-50 px-4 py-3 border-b border-purple-200">
        <h3 class="text-md font-semibold text-purple-900 coustard-regular flex items-center gap-2">
          <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          Vacancy Resolved
        </h3>
      </div>
      <div class="p-6">
        <div class="flex items-center gap-3">
          <% if @vacancy.vacated_by %>
            <% headshot = @vacancy.vacated_by.safe_headshot_variant(:thumb) %>
            <% if headshot %>
              <%= image_tag headshot, alt: @vacancy.vacated_by.name, class: "w-12 h-12 rounded-lg object-cover" %>
            <% else %>
              <div class="w-12 h-12 rounded-lg bg-gray-200 flex items-center justify-center text-gray-700 font-bold text-sm">
                <%= @vacancy.vacated_by.initials %>
              </div>
            <% end %>
          <% end %>
          <div>
            <div class="font-medium text-gray-900"><%= @vacancy.vacated_by&.name %> can make it after all!</div>
            <div class="text-sm text-gray-500">
              <% if @vacancy.closed_at %>
                Reclaimed on <%= @vacancy.closed_at.strftime("%B %d, %Y at %l:%M %p") %>
              <% else %>
                The original cast member is back on the call sheet.
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>
