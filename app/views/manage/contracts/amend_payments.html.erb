<% content_for :title, "Amend Contract - Payments" %>

<div class="w-full mb-10">
  <%= render partial: "shared/notice", locals: { notice: notice, alert: alert } %>

  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [
      ["Money", manage_money_index_path],
      ["Contracts", manage_contracts_path],
      [@contract.contractor_name, manage_contract_path(@contract)]
    ],
    text: "Amend Contract",
    links: []
  } %>

  <div class="max-w-4xl mx-auto mt-6">
    <%# Progress Steps - 4 steps %>
    <div class="flex items-center gap-4 mb-8">
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 rounded-full bg-green-500 text-white flex items-center justify-center text-sm font-semibold">
          <%= icon("check", class: "w-4 h-4") %>
        </div>
        <span class="text-sm font-medium text-gray-500">Events</span>
      </div>
      <div class="flex-1 h-0.5 bg-green-500"></div>
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 rounded-full bg-green-500 text-white flex items-center justify-center text-sm font-semibold">
          <%= icon("check", class: "w-4 h-4") %>
        </div>
        <span class="text-sm font-medium text-gray-500">Review Events</span>
      </div>
      <div class="flex-1 h-0.5 bg-pink-500"></div>
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 rounded-full bg-pink-500 text-white flex items-center justify-center text-sm font-semibold">3</div>
        <span class="text-sm font-medium text-gray-900">Payments</span>
      </div>
      <div class="flex-1 h-0.5 bg-gray-200"></div>
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center text-sm font-semibold">4</div>
        <span class="text-sm font-medium text-gray-500">Confirm</span>
      </div>
    </div>

    <%# Existing Payments - Read Only %>
    <% if @existing_payments.any? %>
      <div class="bg-white border border-gray-200 rounded-lg overflow-hidden mb-6">
        <div class="px-4 py-3 bg-gray-50 border-b border-gray-200">
          <h3 class="text-sm font-semibold text-gray-700">Existing Payments</h3>
          <p class="text-xs text-gray-500 mt-0.5">These payments are already set up and won't be changed</p>
        </div>
        <div class="p-4 space-y-2">
          <% @existing_payments.each do |payment| %>
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
              <div class="flex items-center gap-3 flex-1">
                <div class="flex-shrink-0">
                  <% if payment.direction == "incoming" %>
                    <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center">
                      <%= icon("arrow-down-left", class: "w-5 h-5 text-green-600") %>
                    </div>
                  <% else %>
                    <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center">
                      <%= icon("arrow-up-right", class: "w-5 h-5 text-red-600") %>
                    </div>
                  <% end %>
                </div>
                <div class="flex-1 min-w-0">
                  <div class="font-medium text-gray-900"><%= payment.description %></div>
                  <div class="text-sm text-gray-500">Due: <%= payment.due_date.strftime("%b %-d, %Y") %></div>
                </div>
                <div class="text-right">
                  <div class="font-semibold <%= payment.direction == 'incoming' ? 'text-green-600' : 'text-red-600' %>">
                    <%= payment.direction == 'incoming' ? '+' : '-' %><% if payment.amount_tbd? %>TBD<% else %><%= number_to_currency(payment.amount) %><% end %>
                  </div>
                  <div class="text-xs">
                    <% case payment.status %>
                    <% when "paid" %>
                      <span class="inline-flex items-center gap-1 text-green-600">
                        <%= icon("check-circle", class: "w-3 h-3") %>
                        Paid
                      </span>
                    <% when "pending" %>
                      <span class="text-yellow-600">Pending</span>
                    <% when "cancelled" %>
                      <span class="text-gray-400">Cancelled</span>
                    <% end %>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <%# New Payments for New Events - Only show if there are new bookings %>
    <% if @new_bookings.any? %>
      <%
        # Only pass NEW booking dates to the payments controller
        new_booking_dates = @new_bookings.map { |b| b["starts_at"] }.compact.sort
        new_bookings_count = @new_bookings.count

        # Get saved payment config from amend_data
        existing_payment_structure = @amend_data["payment_structure"] || "per_event"
        existing_payment_config = @amend_data["payment_config"] || {}
        existing_new_payments = @amend_data["new_payments"] || []
      %>

      <div id="payments-app" data-controller="contract-payments"
           data-contract-payments-existing-value="<%= existing_new_payments.to_json %>"
           data-contract-payments-existing-structure-value="<%= existing_payment_structure %>"
           data-contract-payments-existing-config-value="<%= existing_payment_config.to_json %>"
           data-contract-payments-bookings-value="<%= new_booking_dates.to_json %>"
           data-contract-payments-bookings-count-value="<%= new_bookings_count %>">

        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden mb-6">
          <div class="px-4 py-3 bg-pink-50 border-b border-pink-200">
            <h3 class="text-sm font-semibold text-pink-800">Payments for New Events</h3>
            <p class="text-xs text-pink-600 mt-0.5">Set up payments for the <%= new_bookings_count %> new event<%= new_bookings_count == 1 ? '' : 's' %> being added</p>
          </div>
          <div class="p-4">
            <%# Payment Structure Selection %>
            <div class="mb-6">
              <h4 class="text-sm font-semibold text-gray-900 mb-3">Payment Structure</h4>
              <div class="grid grid-cols-2 gap-3">
                <button type="button" data-action="click->contract-payments#selectStructureBtn" data-structure="flat_fee"
                        data-contract-payments-target="flatFeeBtn"
                        class="bg-white text-gray-700 border-gray-300 hover:border-pink-400 border-2 rounded-xl p-4 text-center transition-all">
                  <div class="flex items-center justify-center gap-2 font-semibold">
                    <%= icon("banknotes", class: "w-5 h-5") %>
                    Flat Fee
                  </div>
                  <div class="text-sm opacity-75 mt-1">Fixed amount for all new events</div>
                </button>

                <button type="button" data-action="click->contract-payments#selectStructureBtn" data-structure="per_event"
                        data-contract-payments-target="perEventBtn"
                        class="bg-pink-500 text-white border-pink-500 border-2 rounded-xl p-4 text-center transition-all">
                  <div class="flex items-center justify-center gap-2 font-semibold">
                    <%= icon("calendar", class: "w-5 h-5") %>
                    Per Event
                  </div>
                  <div class="text-sm opacity-75 mt-1">Charge for each new event</div>
                </button>

                <button type="button" data-action="click->contract-payments#selectStructureBtn" data-structure="revenue_share"
                        data-contract-payments-target="revenueShareBtn"
                        class="bg-white text-gray-700 border-gray-300 hover:border-pink-400 border-2 rounded-xl p-4 text-center transition-all">
                  <div class="flex items-center justify-center gap-2 font-semibold">
                    <%= icon("chart-pie", class: "w-5 h-5") %>
                    Revenue Share
                  </div>
                  <div class="text-sm opacity-75 mt-1">Split revenue by percentage</div>
                </button>

                <button type="button" data-action="click->contract-payments#selectStructureBtn" data-structure="custom"
                        data-contract-payments-target="customBtn"
                        class="bg-white text-gray-700 border-gray-300 hover:border-pink-400 border-2 rounded-xl p-4 text-center transition-all">
                  <div class="flex items-center justify-center gap-2 font-semibold">
                    <%= icon("adjustments-horizontal", class: "w-5 h-5") %>
                    Custom
                  </div>
                  <div class="text-sm opacity-75 mt-1">Manual payment schedule</div>
                </button>
              </div>
            </div>

            <%# Flat Fee Configuration %>
            <div data-contract-payments-target="flatFeeConfig" class="hidden bg-gray-50 rounded-xl p-5 mb-6 border border-gray-200">
              <h4 class="text-sm font-semibold text-gray-900 mb-4 flex items-center gap-2">
                <%= icon("banknotes", class: "w-4 h-4 text-pink-600") %>
                Flat Fee for New Events
              </h4>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1.5">Total Amount for New Events</label>
                  <div class="relative">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 font-medium">$</span>
                    <input type="number" step="0.01" min="0" data-contract-payments-target="flatFeeAmount" placeholder="0.00"
                           data-action="input->contract-payments#updateSummaryFromConfig"
                           class="w-full pl-8 pr-4 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
                  </div>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1.5">Direction</label>
                  <select data-contract-payments-target="flatFeeDirection" data-action="change->contract-payments#updateSummaryFromConfig"
                          class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
                    <option value="incoming">They pay us (venue rental, etc.)</option>
                    <option value="outgoing">We pay them (performer fee, etc.)</option>
                  </select>
                </div>

                <div class="flex items-center">
                  <input type="checkbox" data-contract-payments-target="flatFeeDeposit" data-action="change->contract-payments#toggleDeposit"
                         class="h-4 w-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500 accent-pink-600">
                  <label class="ml-2 text-sm text-gray-700">Require deposit upfront</label>
                </div>

                <div data-contract-payments-target="flatFeeDepositConfig" class="hidden pl-6 border-l-2 border-pink-200 space-y-3">
                  <div class="flex gap-3 items-end">
                    <div class="flex-1">
                      <label class="block text-sm font-medium text-gray-700 mb-1.5">Deposit Amount</label>
                      <div class="flex gap-2">
                        <div class="relative flex-1">
                          <input type="number" step="0.01" min="0" data-contract-payments-target="flatFeeDepositAmount" placeholder="0.00"
                                 data-action="input->contract-payments#updateSummaryFromConfig"
                                 class="w-full pl-8 pr-4 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
                          <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 font-medium">$</span>
                        </div>
                        <span class="text-gray-400 self-center">or</span>
                        <div class="relative w-24">
                          <input type="number" step="1" min="0" max="100" data-contract-payments-target="flatFeeDepositPercent" placeholder="50"
                                 data-action="input->contract-payments#updateSummaryFromConfig"
                                 class="w-full pl-3 pr-8 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
                          <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 font-medium">%</span>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1.5">Deposit Due Date</label>
                    <input type="date" data-contract-payments-target="flatFeeDepositDue"
                           class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
                  </div>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1.5">Final Payment Due Date</label>
                  <input type="date" data-contract-payments-target="flatFeeFinalDue"
                         class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
                </div>
              </div>
            </div>

            <%# Per Event Configuration %>
            <div data-contract-payments-target="perEventConfig" class="bg-gray-50 rounded-xl p-5 mb-6 border border-gray-200">
              <h4 class="text-sm font-semibold text-gray-900 mb-4 flex items-center gap-2">
                <%= icon("calendar", class: "w-4 h-4 text-pink-600") %>
                Per Event Fee
              </h4>
              <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1.5">Fee Per Event</label>
                    <div class="relative">
                      <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 font-medium">$</span>
                      <input type="number" step="0.01" min="0" data-contract-payments-target="perEventAmount" placeholder="0.00"
                             data-action="input->contract-payments#updateSummaryFromConfig"
                             class="w-full pl-8 pr-4 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
                    </div>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1.5">New Events</label>
                    <div class="flex items-center gap-2 px-3 py-2.5 bg-pink-100 border border-pink-200 rounded-lg text-sm">
                      <span class="font-semibold text-pink-800" data-contract-payments-target="perEventCount"><%= new_bookings_count %></span>
                      <span class="text-pink-700">new events being added</span>
                    </div>
                  </div>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1.5">Direction</label>
                  <select data-contract-payments-target="perEventDirection" data-action="change->contract-payments#updateSummaryFromConfig"
                          class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
                    <option value="incoming">They pay us per event</option>
                    <option value="outgoing">We pay them per event</option>
                  </select>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1.5">Payment Timing</label>
                  <select data-contract-payments-target="perEventTiming" data-action="change->contract-payments#toggleUpfrontPayment"
                          class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
                    <option value="per_event">Pay for each event individually</option>
                    <option value="upfront">Pay entire amount upfront</option>
                  </select>
                </div>

                <div data-contract-payments-target="perEventUpfrontConfig" class="hidden pl-6 border-l-2 border-pink-200 space-y-3">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1.5">Due Date for Full Payment</label>
                    <input type="date" data-contract-payments-target="perEventUpfrontDue"
                           class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
                  </div>
                  <p class="text-xs text-gray-500">
                    Total: <span data-contract-payments-target="perEventTotal" class="font-semibold text-pink-600">$0.00</span>
                    (<span data-contract-payments-target="perEventCountDisplay">0</span> events Ã— $<span data-contract-payments-target="perEventAmountDisplay">0.00</span>)
                  </p>
                </div>

                <div data-contract-payments-target="perEventTermsConfig">
                  <label class="block text-sm font-medium text-gray-700 mb-1.5">Payment Terms</label>
                  <select data-contract-payments-target="perEventTerms" data-action="change->contract-payments#togglePaymentTermsDays"
                          class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
                    <option value="same_day">Due on the day of the event</option>
                    <option value="before">Due before each event</option>
                    <option value="after">Due after each event</option>
                    <option value="monthly">Monthly invoice</option>
                  </select>
                </div>

                <div data-contract-payments-target="perEventTermsDaysConfig" class="hidden pl-6 border-l-2 border-pink-200">
                  <label class="block text-sm font-medium text-gray-700 mb-1.5">
                    <span data-contract-payments-target="perEventTermsDaysLabel">Days before event</span>
                  </label>
                  <div class="flex items-center gap-2">
                    <input type="number" min="1" max="90" value="7" data-contract-payments-target="perEventTermsDays"
                           class="w-20 px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
                    <span class="text-sm text-gray-500">days</span>
                  </div>
                </div>

                <div class="flex items-center">
                  <input type="checkbox" data-contract-payments-target="perEventDiscount" data-action="change->contract-payments#toggleVolumeDiscount"
                         class="h-4 w-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500 accent-pink-600">
                  <label class="ml-2 text-sm text-gray-700">Apply volume discount</label>
                </div>

                <div data-contract-payments-target="perEventDiscountConfig" class="hidden pl-6 border-l-2 border-pink-200 space-y-3">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1.5">Discount Percentage</label>
                    <div class="relative">
                      <input type="number" step="1" min="0" max="100" data-contract-payments-target="perEventDiscountPercent" placeholder="10"
                             data-action="input->contract-payments#updateSummaryFromConfig"
                             class="w-full pl-3 pr-8 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
                      <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 font-medium">%</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Applied to total per-event fees</p>
                  </div>
                </div>
              </div>
            </div>

            <%# Revenue Share Configuration %>
            <div data-contract-payments-target="revenueShareConfig" class="hidden bg-gray-50 rounded-xl p-5 mb-6 border border-gray-200">
              <h4 class="text-sm font-semibold text-gray-900 mb-4 flex items-center gap-2">
                <%= icon("chart-pie", class: "w-4 h-4 text-pink-600") %>
                Revenue Share for New Events
              </h4>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1.5">Revenue Source</label>
                  <select data-contract-payments-target="revenueSource" class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
                    <option value="ticket_sales">Ticket Sales</option>
                    <option value="door_sales">Door Sales</option>
                    <option value="bar_sales">Bar/Concession Sales</option>
                    <option value="merchandise">Merchandise</option>
                    <option value="total_revenue">Total Revenue</option>
                  </select>
                </div>

                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1.5">Our Share</label>
                    <div class="relative">
                      <input type="number" step="1" min="0" max="100" data-contract-payments-target="revenueOurShare" placeholder="30"
                             data-action="input->contract-payments#syncRevenueShare"
                             class="w-full pl-3 pr-8 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
                      <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 font-medium">%</span>
                    </div>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1.5">Their Share</label>
                    <div class="relative">
                      <input type="number" step="1" min="0" max="100" data-contract-payments-target="revenueTheirShare" placeholder="70"
                             data-action="input->contract-payments#syncRevenueShare"
                             class="w-full pl-3 pr-8 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
                      <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 font-medium">%</span>
                    </div>
                  </div>
                </div>

                <div class="flex items-center">
                  <input type="checkbox" data-contract-payments-target="revenueGuarantee" data-action="change->contract-payments#toggleGuarantee"
                         class="h-4 w-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500 accent-pink-600">
                  <label class="ml-2 text-sm text-gray-700">Minimum guarantee</label>
                </div>

                <div data-contract-payments-target="revenueGuaranteeConfig" class="hidden pl-6 border-l-2 border-pink-200">
                  <label class="block text-sm font-medium text-gray-700 mb-1.5">Guaranteed Minimum</label>
                  <div class="relative">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 font-medium">$</span>
                    <input type="number" step="0.01" min="0" data-contract-payments-target="revenueGuaranteeAmount" placeholder="500.00"
                           class="w-full pl-8 pr-4 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
                  </div>
                  <p class="text-xs text-gray-500 mt-1">They receive at least this amount, even if their share is less.</p>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1.5">Settlement Terms</label>
                  <select data-contract-payments-target="revenueSettlement" class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
                    <option value="same_day">Same day settlement</option>
                    <option value="next_day">Next business day</option>
                    <option value="weekly">Weekly</option>
                    <option value="monthly">Monthly</option>
                  </select>
                </div>
              </div>
            </div>

            <%# Custom Payment Schedule %>
            <div data-contract-payments-target="customConfig" class="hidden mb-6">
              <div class="bg-gray-50 rounded-xl p-5 border border-gray-200 mb-4">
                <h4 class="text-sm font-semibold text-gray-900 mb-4 flex items-center gap-2">
                  <%= icon("plus-circle", class: "w-4 h-4 text-pink-600") %>
                  Add Payment
                </h4>
                <div class="space-y-4">
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1.5">Description</label>
                      <input type="text" data-contract-payments-target="description" placeholder="e.g., Amendment fee, Additional booking"
                             class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1.5">Amount</label>
                      <div class="relative">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 font-medium">$</span>
                        <input type="number" step="0.01" min="0" data-contract-payments-target="amount" placeholder="0.00"
                               class="w-full pl-8 pr-4 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
                      </div>
                    </div>
                  </div>

                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1.5">Direction</label>
                      <select data-contract-payments-target="direction" class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
                        <option value="incoming">They pay us (incoming)</option>
                        <option value="outgoing">We pay them (outgoing)</option>
                      </select>
                    </div>
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1.5">Due Date</label>
                      <input type="date" data-contract-payments-target="dueDate"
                             class="w-full px-3 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
                    </div>
                  </div>

                  <%= render "shared/button", text: "Add Payment", variant: "primary", size: "medium", icon: "plus", type: :button, full_width: true, data: { action: "click->contract-payments#addPayment" } %>
                </div>
              </div>

              <%# Payment list %>
              <div data-contract-payments-target="list" class="space-y-2">
                <% if existing_new_payments.empty? %>
                  <div class="text-center py-8 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200">
                    <%= icon("banknotes", class: "w-8 h-8 text-gray-300 mx-auto mb-2") %>
                    <p class="text-gray-500 text-sm">No custom payments added yet.</p>
                    <p class="text-gray-400 text-xs mt-1">Add payments above to create a custom schedule.</p>
                  </div>
                <% end %>
              </div>
            </div>

            <%# Summary %>
            <div data-contract-payments-target="summary" class="bg-pink-50 rounded-xl p-5 border border-pink-200">
              <h4 class="text-sm font-semibold text-gray-900 mb-3">New Payment Summary</h4>
              <div class="space-y-2">
                <div data-contract-payments-target="summaryDetails" class="space-y-1 text-sm text-gray-600"></div>
                <div class="flex justify-between text-sm pt-2 border-t border-pink-200">
                  <span class="text-gray-600">Total Incoming:</span>
                  <span class="font-semibold text-green-600" data-contract-payments-target="totalIncoming">$0.00</span>
                </div>
                <div class="flex justify-between text-sm">
                  <span class="text-gray-600">Total Outgoing:</span>
                  <span class="font-semibold text-red-600" data-contract-payments-target="totalOutgoing">$0.00</span>
                </div>
                <div class="flex justify-between text-sm font-medium pt-2 border-t border-pink-200">
                  <span class="text-gray-900">Net Amount:</span>
                  <span class="font-bold text-pink-600" data-contract-payments-target="netAmount">$0.00</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <%# Navigation %>
        <%= form_with url: save_amend_payments_manage_contract_path(@contract), method: :post, local: true, data: { action: "submit->contract-payments#preparePaymentsForSubmit" } do |form| %>
          <input type="hidden" name="payment_structure" data-contract-payments-target="structureJson" value="<%= existing_payment_structure %>">
          <input type="hidden" name="payment_config" data-contract-payments-target="configJson" value="<%= existing_payment_config.to_json %>">
          <input type="hidden" name="new_payments" data-contract-payments-target="paymentsJson" value="<%= existing_new_payments.to_json %>">

          <div class="flex justify-between pt-4 border-t border-gray-200">
            <%= render "shared/button", text: "Back: Review Events", variant: "secondary", size: "medium", icon: "arrow-left", path: amend_events_manage_contract_path(@contract) %>
            <%= render "shared/button", text: "Next: Confirm", variant: "primary", size: "medium", type: :submit %>
          </div>
        <% end %>
      </div>

    <% else %>
      <%# No new events - just show navigation %>
      <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 text-center mb-6">
        <%= icon("check-circle", class: "w-12 h-12 text-green-500 mx-auto mb-3") %>
        <h3 class="text-lg font-semibold text-gray-800 mb-2">No New Events Added</h3>
        <p class="text-gray-600 mb-4">You're not adding any new events, so no additional payments are needed.</p>
        <% if @removed_rental_ids.any? %>
          <p class="text-sm text-yellow-700 bg-yellow-50 rounded-lg p-3">
            <strong>Note:</strong> You're removing <%= @removed_rental_ids.count %> event<%= @removed_rental_ids.count == 1 ? '' : 's' %>.
            Existing payments will remain unchanged.
          </p>
        <% end %>
      </div>

      <div class="flex justify-between pt-4 border-t border-gray-200">
        <%= render "shared/button", text: "Back: Review Events", variant: "secondary", size: "medium", icon: "arrow-left", path: amend_events_manage_contract_path(@contract) %>
        <%= link_to amend_review_manage_contract_path(@contract) do %>
          <%= render "shared/button", text: "Next: Confirm", variant: "primary", size: "medium" %>
        <% end %>
      </div>
    <% end %>
  </div>
</div>
