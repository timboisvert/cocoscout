<% content_for :title, "My Profiles" %>

<div class="w-full" data-controller="account-profiles">
  <div id="notice-container">
    <%= render partial: "shared/notice", locals: { notice: notice, alert: alert } %>
  </div>

  <!-- Profiles Section -->
  <div class="bg-white border border-gray-200 rounded-lg overflow-hidden mb-6">
    <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
      <h3 class="text-md font-semibold text-gray-900 coustard-regular">My Profiles</h3>
    </div>
    <div class="p-6">
      <div class="space-y-4">
        <% @profiles.each do |profile| %>
          <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg <%= profile.default_profile? ? 'bg-pink-50/30 border-pink-200' : '' %>">
            <div class="flex items-center gap-4">
              <% headshot = profile.profile_headshots.order(created_at: :desc).first %>
              <% if headshot&.image&.attached? %>
                <%= image_tag headshot.image.variant(resize_to_fill: [64, 64]), class: "w-16 h-16 rounded-lg object-cover" %>
              <% else %>
                <div class="w-16 h-16 rounded-lg bg-gradient-to-br from-pink-400 to-purple-500 flex items-center justify-center text-white font-bold text-lg">
                  <%= profile.initials %>
                </div>
              <% end %>
              <div>
                <div class="font-medium text-gray-900">
                  <%= profile.name %>
                  <% if profile.default_profile? %>
                    <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-pink-100 text-pink-800">Default</span>
                  <% end %>
                </div>
                <div class="text-sm text-gray-500">@<%= profile.public_key %></div>
                <% if profile.pronouns.present? %>
                  <div class="text-xs text-gray-400"><%= profile.pronouns %></div>
                <% end %>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <% unless profile.default_profile? %>
                <%= render "shared/button", text: "Set Default", path: set_default_profile_account_path(profile), method: :post, variant: "outline", size: "small" %>
              <% end %>
              <% if @profiles.count > 1 %>
                <%= render "shared/button", text: "Archive", variant: "danger", size: "small", data: { action: "click->account-profiles#openArchive", "profile-id": profile.id, "profile-name": profile.name } %>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>

      <!-- New Profile Section -->
      <div class="mt-6 pt-6 border-t border-gray-200">
        <div class="flex items-start gap-4">
          <div class="flex-1">
            <h4 class="text-sm font-semibold text-gray-900 mb-2">Need another profile?</h4>
            <p class="text-sm text-gray-600">
              Create separate profiles for different stage names, personas, or performance identities.
              Each profile gets its own public page, headshots, and creditsâ€”perfect for performers
              who work under multiple names or in different genres.
            </p>
          </div>
          <div class="flex-shrink-0">
            <%= render "shared/button", text: "New Profile", variant: "primary", icon: "plus", path: new_my_profile_path %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Groups Section -->
  <div class="bg-white border border-gray-200 rounded-lg overflow-hidden mb-6">
    <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
      <h3 class="text-md font-semibold text-gray-900 coustard-regular">My Groups</h3>
    </div>
    <div class="p-6">
      <% if @groups.any? %>
        <div class="space-y-4">
          <% @groups.each do |group| %>
            <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
              <div class="flex items-center gap-4">
                <% if group.headshot&.attached? %>
                  <%= image_tag group.headshot.variant(resize_to_fill: [64, 64]), class: "w-16 h-16 rounded-lg object-cover" %>
                <% else %>
                  <div class="w-16 h-16 rounded-lg bg-gradient-to-br from-pink-400 to-purple-500 flex items-center justify-center text-white font-bold text-lg">
                    <%= group.initials %>
                  </div>
                <% end %>
                <div>
                  <div class="font-medium text-gray-900"><%= group.name %></div>
                  <div class="text-sm text-gray-500">@<%= group.public_key %></div>
                  <% membership = group.group_memberships.find_by(person: @profiles) %>
                  <% if membership %>
                    <div class="text-xs text-gray-400"><%= membership.permission_level.humanize %></div>
                  <% end %>
                </div>
              </div>
              <div class="flex items-center gap-2">
                <%= render "shared/button", text: "Manage", path: edit_group_path(group), variant: "outline", size: "small" %>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <p class="text-sm text-gray-500">You aren't part of any groups yet.</p>
      <% end %>

      <!-- Create Group Section -->
      <div class="mt-6 pt-6 border-t border-gray-200">
        <div class="flex items-start gap-4">
          <div class="flex-1">
            <h4 class="text-sm font-semibold text-gray-900 mb-2">Start a group</h4>
            <p class="text-sm text-gray-600">
              Create a group profile for your band, troupe, ensemble, or any performing group.
              Groups have their own public pages and can invite members to collaborate.
            </p>
          </div>
          <div class="flex-shrink-0">
            <%= render "shared/button", text: "New Group", variant: "primary", icon: "plus", path: new_group_path %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Archive Profile Modal -->
  <div data-account-profiles-target="archiveModal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
      <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" data-action="click->account-profiles#closeArchive"></div>
      <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
      <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
          <h3 class="text-lg font-semibold text-gray-900 coustard-regular mb-4">Archive Profile</h3>
          <p class="text-sm text-gray-600 mb-4">
            Are you sure you want to archive <strong data-account-profiles-target="archiveName"></strong>?
            This profile will be hidden but can be restored by contacting support.
          </p>
          <%= form_with(url: "#", method: :post, data: { turbo: true, "account-profiles-target": "archiveForm" }) do %>
            <div class="flex justify-end gap-3">
              <%= render "shared/button", text: "Cancel", variant: "outline", type: :button, data: { action: "click->account-profiles#closeArchive" } %>
              <%= render "shared/button", text: "Archive Profile", variant: "danger", type: :submit %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>
