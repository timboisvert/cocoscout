<% content_for :title, "Open Requests" %>

<div class="w-full" data-controller="open-requests">

  <%= render partial: "shared/notice", locals: { notice: notice, alert: alert } %>

  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [],
    text: "My Open Requests",
    links: [
      {
        text: "Calendar",
        path: my_availability_calendar_path,
        icon: "calendar"
      }
    ]
  } %>

  <% if @has_any_productions %>

  <%
    has_multiple_entities = @people.size > 1 || @groups.any?
    view_filters = [
      { text: "Awaiting My Response", path: my_requests_path(filter: 'awaiting', entity: @entity_filter.join(',')), active: @filter == 'awaiting' },
      { text: "All", path: my_requests_path(filter: 'all', entity: @entity_filter.join(',')), active: @filter == 'all' }
    ]
  %>

  <%# ========================================= %>
  <%# Section 1: Sign-up Opportunities %>
  <%# ========================================= %>
  <div class="bg-white border border-gray-200 rounded-lg overflow-hidden mb-6">
    <%= render "shared/card_header", title: "Sign-ups" %>
    <div class="p-4">
      <p class="text-sm text-gray-600 mb-4">Register for these events to reserve your spot.</p>

      <%# Filter bar inside card %>
      <div class="mb-4">
        <%= render "shared/filters/filter_bar",
            toggle_label: "Filters",
            filter_groups: [
              {
                label: "Show",
                filters: view_filters
              }
            ]
        %>
      </div>

      <% if @signup_items.any? %>
        <div class="space-y-1">
          <% @signup_items.each do |item| %>
            <div id="request-item-<%= item[:show].id %>-<%= item[:entity_key] %>">
              <%= render partial: "my/open_requests/request_item", locals: { item: item } %>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="border-2 border-dashed border-gray-200 rounded-lg">
          <div class="text-center py-12">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
            </svg>
            <h3 class="mt-2 text-sm font-medium text-gray-900">No sign-ups</h3>
            <p class="mt-1 text-sm text-gray-500">No sign-up opportunities are awaiting your response.</p>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <%# ========================================= %>
  <%# Section 2: Availability Requests %>
  <%# ========================================= %>
  <% if @availability_items.any? %>
    <div class="bg-white border border-gray-200 rounded-lg overflow-hidden mb-6">
      <%= render "shared/card_header", title: "Availability" %>
      <div class="p-4">
        <p class="text-sm text-gray-600 mb-4">Let your production managers know if you can make these shows.</p>

        <%# Filter bar inside card %>
        <div class="mb-4">
          <%= render "shared/filters/filter_bar",
              toggle_label: "Filters",
              filter_groups: [
                {
                  label: "Show",
                  filters: view_filters
                },
                has_multiple_entities ? { separator: true } : nil,
                has_multiple_entities ? {
                  partial: "shared/filters/entity_filter",
                  locals: {
                    path_helper: method(:my_requests_path),
                    people: @people,
                    groups: @groups,
                    entity_filter: @entity_filter,
                    label: "Include",
                    filter: @filter
                  }
                } : nil
              ].compact
          %>
        </div>

        <div class="space-y-1" data-controller="linked-highlight">
          <% @availability_items.each do |item| %>
            <div id="request-item-<%= item[:show].id %>-<%= item[:entity_key] %>">
              <%= render partial: "my/open_requests/request_item", locals: { item: item } %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <%# ========================================= %>
  <%# Section 3: Questionnaires %>
  <%# ========================================= %>
  <div class="bg-white border border-gray-200 rounded-lg overflow-hidden mb-6">
    <%= render "shared/card_header", title: "Questionnaires" %>
    <div class="p-4">
      <p class="text-sm text-gray-600 mb-4">Complete these questionnaires from your production managers.</p>

      <%# Filter bar inside card %>
      <div class="mb-4">
        <%= render "shared/filters/filter_bar",
            toggle_label: "Filters",
            filter_groups: [
              {
                label: "Show",
                filters: view_filters
              }
            ]
        %>
      </div>

      <% if @questionnaire_items.any? %>
        <div class="space-y-2">
          <% @questionnaire_items.each do |item| %>
            <%= render partial: "my/open_requests/questionnaire_item", locals: { item: item } %>
          <% end %>
        </div>
      <% else %>
        <div class="border-2 border-dashed border-gray-200 rounded-lg">
          <div class="text-center py-12">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <h3 class="mt-2 text-sm font-medium text-gray-900">No questionnaires</h3>
            <p class="mt-1 text-sm text-gray-500">No questionnaires are awaiting your response.</p>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <%# Empty state %>
  <% if @availability_items.empty? && @signup_items.empty? && @questionnaire_items.empty? %>
    <div class="text-center py-12">
      <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <h3 class="mt-2 text-sm font-medium text-gray-900">You're all caught up!</h3>
      <p class="mt-1 text-sm text-gray-500">
        <% if @filter == 'awaiting' %>
          No pending requests. Switch to "All" to see past responses.
        <% else %>
          No open requests at this time.
        <% end %>
      </p>
    </div>
  <% end %>

  <% else %>
    <%# No productions %>
    <div class="text-center py-12">
      <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
      </svg>
      <h3 class="mt-2 text-sm font-medium text-gray-900">No productions</h3>
      <p class="mt-1 text-sm text-gray-500">You haven't been added to any productions yet.</p>
    </div>
  <% end %>

</div>
