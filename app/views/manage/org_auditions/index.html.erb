<% content_for :title, "Auditions" %>

<div class="w-full mb-10">
  <%= render partial: "shared/notice", locals: { notice: notice } %>

  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [
      ["Sign-ups", manage_signups_path]
    ],
    text: "Auditions",
    links: [
      { text: "Create Audition Cycle", path: manage_signups_auditions_new_wizard_path }
    ]
  } %>

  <%= render "shared/filters/filter_bar", filter_groups: [
    {
      label: "Type",
      filters: [
        { text: "All", path: manage_signups_all_auditions_path, active: @filter.blank? },
        { text: "In-person", path: manage_signups_all_auditions_path(filter: "in_person"), active: @filter == "in_person" },
        { text: "Video Only", path: manage_signups_all_auditions_path(filter: "video"), active: @filter == "video" }
      ]
    },
    { separator: true }
  ] %>

  <div class="pt-4">
    <% if @cycles.any? %>
      <div class="space-y-1">
        <% @cycles.each do |cycle| %>
          <%
            if cycle.opens_at > Time.current
              status_text = "Opens Soon"
              status_class = "bg-amber-100 text-amber-700"
            elsif cycle.closes_at.present? && cycle.closes_at <= Time.current
              status_text = "Closed"
              status_class = "bg-gray-100 text-gray-600"
            else
              status_text = "Open"
              status_class = "bg-green-100 text-green-700"
            end

            pending_count = cycle.audition_requests.where(status: "pending").count
          %>
          <%= link_to manage_signups_auditions_path(cycle.production), class: "block px-4 py-3 border border-gray-200 rounded-lg hover:border-gray-400 bg-white transition-all no-underline" do %>
            <div class="flex flex-col md:flex-row md:items-center gap-2 md:gap-0 w-full">
              <%# Left third: Production and cycle info %>
              <div class="w-full md:w-1/3 flex items-center">
                <div class="flex items-center gap-4 flex-1 min-w-0">
                  <% logo_variant = cycle.production.safe_logo_variant(:small) %>
                  <% if logo_variant %>
                    <div class="flex-shrink-0 w-14 h-8 rounded flex items-center justify-center overflow-hidden">
                      <%= image_tag logo_variant, alt: cycle.production.name, class: "w-full h-full object-cover rounded" %>
                    </div>
                  <% else %>
                    <div class="flex-shrink-0 w-14 h-14 rounded-lg bg-pink-100 flex items-center justify-center">
                      <span class="text-xl font-bold text-pink-600"><%= cycle.production.initials %></span>
                    </div>
                  <% end %>
                  <div class="flex-1 min-w-0">
                    <h3 class="text-base font-medium text-gray-900 truncate"><%= cycle.production.name %></h3>
                    <div class="text-sm text-gray-500">
                      <% if cycle.video_only? %>
                        Video Only
                      <% elsif cycle.hybrid_auditions? %>
                        Video + In-Person
                      <% else %>
                        In-Person
                      <% end %>
                      <% if cycle.accepts_in_person_auditions? && cycle.audition_sessions.count > 0 %>
                        · <%= cycle.audition_sessions.count %> <%= "session".pluralize(cycle.audition_sessions.count) %>
                      <% end %>
                    </div>
                  </div>
                </div>
              </div>

              <%# Middle third: Status %>
              <div class="w-full md:w-1/3 md:border-l border-gray-200 md:pl-4 flex flex-col justify-center md:self-stretch border-t md:border-t-0 mt-2 md:mt-0 pt-2 md:pt-0">
                <div class="flex items-center">
                  <span class="inline-flex items-center rounded-full px-2.5 py-1 text-sm font-medium <%= status_class %>">
                    <%= status_text %>
                  </span>
                </div>
                <% if pending_count > 0 %>
                  <div class="text-xs text-pink-600 mt-1"><%= pending_count %> pending</div>
                <% end %>
              </div>

              <%# Right third: Requests count %>
              <div class="w-full md:w-1/3 md:border-l border-gray-200 md:pl-4 flex items-center md:self-stretch justify-between border-t md:border-t-0 mt-2 md:mt-0 pt-2 md:pt-0">
                <div class="flex-1">
                  <div class="text-xs text-gray-400 uppercase tracking-wide">Requests</div>
                  <div class="text-base">
                    <span class="text-gray-900 font-medium tabular-nums"><%= cycle.audition_requests.count %></span>
                  </div>
                </div>
                <svg class="w-5 h-5 text-gray-400 hidden sm:block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
              </div>
            </div>
          <% end %>
        <% end %>
      </div>
    <% else %>
      <div class="bg-gray-50 rounded-lg border border-dashed border-gray-300 p-8 text-center">
        <p class="text-gray-600">
          <% if @filter == "in_person" %>
            No in-person audition cycles found. Create one from a production's auditions page.
          <% elsif @filter == "video" %>
            No video audition cycles found. Create one from a production's auditions page.
          <% else %>
            No audition cycles found. Create one from a production's auditions page.
          <% end %>
        </p>
      </div>
    <% end %>

    <% if @archived_cycles.any? %>
      <div class="mt-8">
        <h3 class="text-sm font-semibold text-gray-700 mb-3">Archived Cycles (<%= @archived_cycles.count %>)</h3>
        <div class="bg-gray-50 rounded-lg border border-gray-200 p-4">
          <div class="flex flex-wrap gap-2">
            <% @archived_cycles.each do |cycle| %>
              <% cycle_label = cycle.opens_at&.strftime("%b %Y") || "Cycle" %>
              <%= link_to manage_signups_auditions_cycle_path(cycle.production, cycle), class: "inline-flex items-center gap-1 px-2 py-1 text-xs text-gray-600 bg-white border border-gray-200 rounded hover:border-gray-300" do %>
                <span class="font-medium"><%= cycle.production.name %></span>
                <span class="text-gray-400">·</span>
                <span><%= cycle_label %></span>
              <% end %>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>
