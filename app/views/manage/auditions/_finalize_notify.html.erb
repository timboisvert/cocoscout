<% pending_stages_local = @cast_assignment_stages.where(status: :pending) %>
<% staged_casts = @talent_pools.select { |talent_pool| pending_stages_local.any? { |stage| stage.talent_pool_id == talent_pool.id } } %>
<% # Get assignable [type, id] tuples to exclude: pending, finalized stages, and people already notified for rejections %>
<% assigned_assignable_ids = pending_stages_local.map { |s| [s.assignable_type, s.assignable_id] }.uniq %>
<% notified_assignable_ids = notified_stages.map { |s| [s.assignable_type, s.assignable_id] }.uniq %>
<% # Also exclude people who were notified of rejection for this cycle (only applies to Person, not Group) %>
<% rejection_notified_person_ids = @auditioned_people.select { |p| p.is_a?(Person) && p.casting_notification_sent_at.present? && p.notified_for_audition_cycle_id == @audition_cycle.id }.map { |p| ['Person', p.id] } %>
<% excluded_assignable_ids = (assigned_assignable_ids + notified_assignable_ids + rejection_notified_person_ids).uniq %>
<% unassigned_people = @auditioned_people.reject { |auditionee| excluded_assignable_ids.include?([auditionee.class.name, auditionee.id]) } %>

<%# Show the box if: notifications not sent yet OR there are new pending stages to notify %>
<% show_notify_box = !has_sent_notifications || pending_stages_local.any? %>

<% if show_notify_box %>
  <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden my-6">
    <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
      <h3 class="text-md font-semibold text-gray-900 coustard-regular">Finalize Casting and Notify</h3>
    </div>
    <div class="p-6">
      <% if pending_stages_local.any? %>
        <%# There are pending stages to notify %>
        <% if has_sent_notifications %>
          <%# After notifications sent but there are new changes - show warning and form %>
          <div class="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
            <div class="flex items-start gap-3">
              <div class="flex-shrink-0">
                <svg class="w-5 h-5 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 9a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/>
                </svg>
              </div>
              <div class="flex-1">
                <h4 class="text-sm font-semibold text-yellow-900 mb-1">New Casting Changes Need Notification</h4>
                <% notified_count = notified_stages.map { |s| [s.assignable_type, s.assignable_id] }.uniq.count %>
                <% pending_count = pending_stages_local.map { |s| [s.assignable_type, s.assignable_id] }.uniq.count %>
                <p class="text-sm text-yellow-800 mb-0">
                  <%= notified_count %> <%= 'auditionee'.pluralize(notified_count) %> <%= notified_count == 1 ? 'has' : 'have' %> already been notified.
                  <%= pending_count %> <%= 'auditionee'.pluralize(pending_count) %> still need<%= pending_count == 1 ? 's' : '' %> to be notified.
                </p>
              </div>
            </div>
          </div>
        <% end %>
        <%= render "finalize_notify_form", audition_cycle: audition_cycle, pending_stages: pending_stages_local, staged_casts: staged_casts, unassigned_people: unassigned_people %>
      <% elsif has_sent_notifications %>
        <%# After notifications sent and no new changes - show finalized message with toggle %>
        <div data-controller="show-toggle">
          <div data-show-toggle-target="finalizedBox" class="mb-4 p-4 bg-green-50 border border-green-200 rounded-lg">
            <div class="flex items-start gap-3">
              <div class="flex-shrink-0">
                <svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
              </div>
              <div class="flex-1">
                <h4 class="text-sm font-semibold text-green-900 mb-1">Casting Notifications Finalized</h4>
                <% notified_count = notified_stages.map { |s| [s.assignable_type, s.assignable_id] }.uniq.count %>
                <p class="text-sm text-green-800 mb-3">
                  Notification emails have been sent to <%= notified_count %> <%= 'auditionee'.pluralize(notified_count) %>. To make changes and send additional notifications, click the button below.
                </p>
                <%= render "shared/button",
                  text: "Edit Invitations & Send More Notifications",
                  variant: "primary",
                  size: "medium",
                  type: :button,
                  data: { action: "click->show-toggle#toggle" },
                  style: "background-color: rgb(22 163 74); --tw-bg-opacity: 1;" %>
              </div>
            </div>
          </div>

          <div data-show-toggle-target="content" class="hidden">
            <%= render "finalize_notify_form", audition_cycle: audition_cycle, pending_stages: pending_stages_local, staged_casts: staged_casts, unassigned_people: unassigned_people %>
          </div>
        </div>
      <% else %>
        <%# Before notifications sent and no pending stages - show helpful message %>
        <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
          <div class="flex items-start gap-3">
            <div class="flex-shrink-0">
              <svg class="w-5 h-5 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
              </svg>
            </div>
            <div class="flex-1">
              <h4 class="text-sm font-semibold text-blue-900 mb-1">Ready to Select Cast Members</h4>
              <p class="text-sm text-blue-800">
                Click "Select New Cast Members" above to choose people from your auditions to add to your cast(s). Once you've made your selections, you'll be able to send notification emails from this section.
              </p>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>
<% end %>
