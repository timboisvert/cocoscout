<% content_for :title, @message.subject || "Message" %>

<%
  # Style options (use the same style system as index)
  comment_style = (params[:comment_style] || 'inline').to_sym
  comment_style = :inline unless [:inline, :collapsed, :modal].include?(comment_style)

  thread_style = (params[:thread_style] || 'nested').to_sym
  thread_style = :nested unless [:flat, :nested, :sidebar].include?(thread_style)

  image_style = (params[:image_style] || 'lightbox').to_sym
  image_style = :lightbox unless [:grid, :carousel, :lightbox, :masonry].include?(image_style)

  # Get message data
  sender_person = @message.sender.is_a?(Person) ? @message.sender : @message.sender&.person
  production_context = @message.production
  recipient_count = @message.recipient_count

  # Get all replies in the thread
  all_replies = @message.child_messages.includes(:sender, :child_messages).order(created_at: :asc)

  # Check if we came from a production-scoped page (via nested route or query param)
  from_production_id = params[:production_id] || params[:from_production]
  from_production = from_production_id ? Production.find_by(id: from_production_id) : nil
  show_production_header = from_production.present?
  hide_via_links = from_production.present?

  # Auto-focus comment form
  focus_comment = params[:focus] == 'comment'
%>

<div class="w-full" data-controller="message-thread" data-message-thread-message-id-value="<%= @message.id %>" data-message-thread-current-user-id-value="<%= Current.user.id %>" data-message-thread-focus-comment-value="<%= focus_comment %>">
  <%= render partial: "shared/notice", locals: { notice: notice } %>

  <% if show_production_header && from_production %>
    <%# Production Header when coming from production messages page %>
    <div class="bg-white border-b border-gray-200 -mx-4 sm:-mx-6 lg:-mx-8 px-4 sm:px-6 lg:px-8 py-6 mb-6">
      <div class="flex items-center gap-4">
        <%# Back link to production messages %>
        <%= link_to production_manage_messages_path(from_production), class: "text-gray-400 hover:text-gray-600 transition-colors" do %>
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
          </svg>
        <% end %>

        <%# Production Logo %>
        <% logo_variant = from_production.safe_logo_variant(:small) %>
        <% if logo_variant %>
          <%= image_tag logo_variant, alt: from_production.name, class: "w-14 h-14 rounded-lg object-cover shadow-sm border border-gray-200" %>
        <% else %>
          <div class="w-14 h-14 rounded-lg bg-gradient-to-br from-pink-100 to-pink-50 flex items-center justify-center border border-pink-200">
            <span class="text-xl font-bold text-pink-600"><%= from_production.initials %></span>
          </div>
        <% end %>

        <%# Production Name & Context %>
        <div class="flex-1 min-w-0">
          <h1 class="text-xl font-bold text-gray-900 truncate coustard-regular"><%= from_production.name %></h1>
          <p class="text-sm text-gray-500"><%= @message.subject.truncate(50) %></p>
        </div>
      </div>
    </div>
  <% else %>
    <%= render partial: "shared/top_menu", locals: {
      breadcrumbs: [
        ["Messages", manage_messages_path]
      ],
      text: @message.subject || "Message Thread",
      links: []
    } %>
  <% end %>

  <div class="mt-4">
    <%# Main Message Card %>
    <%= render "shared/messages/message_card",
        message: @message,
        context: :show,
        production_context: production_context,
        hide_production_via: hide_via_links %>

    <%# Replies Section - Nested Tree View %>
    <div class="mt-6">
      <% if all_replies.any? %>
        <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wide mb-4">
          Replies
        </h3>
      <% end %>

      <div class="space-y-4" data-message-thread-target="replies">
        <%= render partial: "shared/messages/nested_reply", collection: all_replies, as: :reply, locals: { depth: 0 } %>
      </div>
    </div>

    <%# Comment Form (hidden by default, shown when "Add Comment" is clicked) %>
    <%
      # Determine if sender identity selector should be shown
      # In /manage/messages, always show the selector since we're in a production context
      # This allows managers to choose whether to reply personally or as the production team
      root_sent_as_team = @message.sent_as_production_team?
      show_sender_selector = @message.production.present?
      default_sender_identity = root_sent_as_team ? "production_team" : "personal"
    %>
    <div data-message-thread-target="commentForm" class="hidden mt-6 bg-white rounded-xl border border-gray-200 shadow-sm p-4" data-controller="reply-sender">
      <% if show_sender_selector %>
        <%# Sender Identity Selector - shown only for production team messages %>
        <div class="pb-4 mb-4 border-b border-gray-100">
          <div class="flex items-center gap-3">
            <span class="text-sm font-medium text-gray-500">From:</span>
            <div class="relative flex-1" data-controller="dropdown">
              <button type="button"
                      data-action="click->dropdown#toggle"
                      data-reply-sender-target="button"
                      class="flex items-center justify-between gap-2 w-full text-left px-3 py-2 rounded-lg border border-gray-200 hover:border-gray-300 hover:bg-gray-50 transition-colors cursor-pointer">
                <div class="flex items-center gap-2">
                  <div data-reply-sender-target="icon" class="flex-shrink-0">
                    <% if @message.production %>
                      <% prod_logo_btn = @message.production.safe_logo_variant(:small) %>
                      <% if prod_logo_btn %>
                        <%= image_tag prod_logo_btn, alt: @message.production.name, class: "w-6 h-6 rounded-lg object-cover" %>
                      <% else %>
                        <div class="w-6 h-6 rounded-lg bg-gradient-to-br from-pink-100 to-pink-50 flex items-center justify-center border border-pink-200">
                          <span class="text-xs font-bold text-pink-600"><%= @message.production.initials %></span>
                        </div>
                      <% end %>
                    <% else %>
                      <div class="w-6 h-6 rounded-lg bg-pink-500 flex items-center justify-center">
                        <svg class="w-3.5 h-3.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                      </div>
                    <% end %>
                  </div>
                  <span data-reply-sender-target="label" class="text-sm font-medium text-gray-900"><%= @message.production&.name || "Production Team" %></span>
                </div>
                <svg class="w-4 h-4 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </button>
              <div data-dropdown-target="menu" class="hidden absolute left-0 right-0 mt-1 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-50">
                <button type="button"
                        data-action="click->reply-sender#select click->dropdown#close"
                        data-value="production_team"
                        data-label="<%= @message.production&.name || 'Production Team' %>"
                        class="w-full flex items-center gap-3 px-3 py-2.5 hover:bg-pink-50 transition-colors cursor-pointer text-left">
                  <% if @message.production %>
                    <% prod_logo = @message.production.safe_logo_variant(:small) %>
                    <% if prod_logo %>
                      <%= image_tag prod_logo, alt: @message.production.name, class: "w-6 h-6 rounded-lg object-cover flex-shrink-0" %>
                    <% else %>
                      <div class="w-6 h-6 rounded-lg bg-gradient-to-br from-pink-100 to-pink-50 flex items-center justify-center flex-shrink-0 border border-pink-200">
                        <span class="text-xs font-bold text-pink-600"><%= @message.production.initials %></span>
                      </div>
                    <% end %>
                  <% else %>
                    <div class="w-6 h-6 rounded-lg bg-pink-500 flex items-center justify-center flex-shrink-0">
                      <svg class="w-3.5 h-3.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
                      </svg>
                    </div>
                  <% end %>
                  <div>
                    <div class="text-sm font-medium text-gray-900"><%= @message.production&.name || "Production Team" %></div>
                    <div class="text-xs text-gray-500">Visible to all team members</div>
                  </div>
                </button>
                <button type="button"
                        data-action="click->reply-sender#select click->dropdown#close"
                        data-value="personal"
                        data-label="<%= Current.user&.person&.name || 'Just Me' %>"
                        class="w-full flex items-center gap-3 px-3 py-2.5 hover:bg-pink-50 transition-colors cursor-pointer text-left border-t border-gray-100">
                  <% current_person_for_sender = Current.user&.person %>
                  <% if current_person_for_sender %>
                    <% sender_headshot = current_person_for_sender.safe_headshot_variant(:thumb) %>
                    <% if sender_headshot %>
                      <%= image_tag sender_headshot, alt: current_person_for_sender.name, class: "w-6 h-6 rounded-lg object-cover flex-shrink-0" %>
                    <% else %>
                      <div class="w-6 h-6 rounded-lg bg-gray-200 flex items-center justify-center flex-shrink-0">
                        <span class="text-xs font-bold text-gray-600"><%= current_person_for_sender.initials %></span>
                      </div>
                    <% end %>
                  <% else %>
                    <div class="w-6 h-6 rounded-lg bg-gray-400 flex items-center justify-center flex-shrink-0">
                      <svg class="w-3.5 h-3.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                      </svg>
                    </div>
                  <% end %>
                  <div>
                    <div class="text-sm font-medium text-gray-900"><%= Current.user&.person&.name || "Just Me" %></div>
                    <div class="text-xs text-gray-500">Only visible to the recipient</div>
                  </div>
                </button>
              </div>
            </div>
          </div>
        </div>
      <% end %>

      <div>
        <div>
          <%= form_with url: reply_manage_message_path(@root_message), method: :post, multipart: true, data: { turbo: false }, id: "reply-form-#{@message.id}" do |f| %>
            <% if show_sender_selector %>
              <%# Hidden field for sender_identity - synced with the selector above via Stimulus %>
              <input type="hidden" name="sender_identity" value="<%= default_sender_identity %>" data-reply-sender-target="input">
            <% end %>
            <%= f.rich_text_area :body, class: "w-full min-h-[80px]", placeholder: "Write a comment...", data: { action: "trix-change->message-thread#userTyping", "message-thread-target": "commentBody" } %>

            <div data-controller="image-dropzone">
              <input type="file" name="images[]" multiple accept="image/*" data-image-dropzone-target="input" data-action="change->image-dropzone#filesSelected" class="hidden">
              <div class="flex items-center justify-between mt-2">
                <div data-image-dropzone-target="toggleButton">
                  <%= render "shared/button", text: "Add image(s)", variant: "ghost", size: "small", icon: "photo", type: :button, data: { action: "click->image-dropzone#toggle" } %>
                </div>
                <div class="flex items-center gap-2">
                  <button type="button" class="px-3 py-1.5 text-sm text-gray-600 hover:text-gray-800 cursor-pointer" data-action="click->message-thread#hideCommentForm">Cancel</button>
                  <%= render "shared/button", text: "Post Comment", variant: "primary", size: "small", type: :submit %>
                </div>
              </div>
              <div data-image-dropzone-target="dropzone" class="hidden mt-2 relative">
                <button type="button" class="absolute top-2 right-2 z-10 p-1 rounded-full text-gray-400 hover:text-red-500 hover:bg-white/80 transition-colors cursor-pointer" data-action="click->image-dropzone#close" title="Remove images"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
                <div data-action="dragover->image-dropzone#dragOver dragleave->image-dropzone#dragLeave drop->image-dropzone#drop click->image-dropzone#openFilePicker" class="border-2 border-dashed border-gray-200 rounded-xl p-4 cursor-pointer hover:border-pink-400 hover:bg-pink-50/30 transition-all">
                  <div data-image-dropzone-target="placeholder" class="flex flex-col items-center justify-center gap-2 text-gray-400">
                    <div class="w-8 h-8 rounded-full bg-pink-50 flex items-center justify-center"><svg class="w-5 h-5 text-pink-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg></div>
                    <div class="text-center"><p class="text-sm font-medium text-gray-600">Drop images here</p><p class="text-xs text-gray-400">or click to select files</p></div>
                  </div>
                  <div data-image-dropzone-target="previews" class="hidden flex flex-wrap gap-2"></div>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>
