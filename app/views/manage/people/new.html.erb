<% content_for :title, "Invite People" %>

<div class="w-full">

  <%= render partial: "shared/notice", locals: { notice: notice } %>

  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [
      ["Directory", manage_directory_path]
    ],
    text: "Invite People",
    links: []
  } %>

  <div class="w-full" data-controller="tabs invite-email-checker" data-tabs-initial-tab-value="<%= @batch_results || @errors&.any? ? 1 : 0 %>">

    <%= render "shared/help_section",
      title: "Inviting People to CocoScout",
      initial_state: "open",
      storage_key: "invite_people_help_collapsed",
      steps: [
        { text: "Use this page to invite people (talent, performers, cast members) to join " + Current.organization.name + " on CocoScout." },
        { text: "They will receive an email with a link to create a password and set up their profile." },
        { text: "If someone already has a CocoScout account, they'll just need to sign in and will be automatically added to your organization." },
        { text: "Once they accept the invitation, you can add them to your production casts in the Directory." }
      ] %>

    <nav class="flex space-x-2 border-b border-gray-200 mb-4">
      <button type="button" data-tabs-target="tab" data-index="0" data-action="tabs#select" class="px-4 py-2 text-sm font-medium border-b-2 cursor-pointer">Invite One Person</button>
      <button type="button" data-tabs-target="tab" data-index="1" data-action="tabs#select" class="px-4 py-2 text-sm font-medium border-b-2 cursor-pointer">Batch Invite</button>
    </nav>

    <!-- Single person form -->
    <div data-tabs-target="panel">
      <%= form_with(model: [:manage, @person], class: "contents", data: { invite_email_checker_target: "form" }) do |person_form| %>

        <div class="flex flex-col sm:flex-row sm:gap-4">
          <div class="w-full sm:w-1/3">
            <% if @person.errors[:name].none? %>
                <%= person_form.label :name, "Name" %>
            <% else %>
                <%= person_form.label :name, "Name is required", class: "text-pink-600"  %>
            <% end %>
            <%= person_form.text_field :name, class: ["block shadow-sm rounded-lg border px-3 py-2 mt-2 w-full", {"border-gray-400": @person.errors[:name].none?, "border-pink-500": @person.errors[:name].any?}] %>
          </div>

          <div class="w-full sm:w-1/3">
            <% if @user_exists_error %>
                <%= person_form.label :email, "A user with this email already exists", class: "text-pink-600" %>
            <% elsif @person.errors[:email].none? %>
                <%= person_form.label :email, "Email Address" %>
            <% else %>
                <%= person_form.label :email, "Email Address is required", class: "text-pink-600"  %>
            <% end %>
            <%= person_form.email_field :email,
                autocapitalize: "none",
                data: { invite_email_checker_target: "emailInput", action: "blur->invite-email-checker#checkEmail" },
                class: ["block shadow-sm rounded-lg border px-3 py-2 mt-2 w-full", {"border-gray-400": @person.errors[:email].none? && !@user_exists_error, "border-pink-500": @person.errors[:email].any? || @user_exists_error}] %>
          </div>

        </div>

        <!-- Profile selection area (shown when multiple profiles found) -->
        <div data-invite-email-checker-target="profilesSection" class="<%= @multiple_profiles.present? ? '' : 'hidden' %> mt-4">
          <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
            <div class="flex items-start">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-yellow-600 flex-shrink-0 mt-0.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
              </svg>
              <div class="ml-3 flex-1">
                <h3 class="text-sm font-medium text-yellow-800">Multiple profiles found with this email</h3>
                <p class="mt-1 text-sm text-yellow-700">Select which profile(s) you want to invite:</p>
                <div data-invite-email-checker-target="profilesList" class="mt-3 space-y-2">
                  <% if @multiple_profiles.present? %>
                    <% @multiple_profiles.each do |profile| %>
                      <label class="flex items-center gap-3 p-2 rounded-lg hover:bg-yellow-100 cursor-pointer <%= profile.organizations.include?(Current.organization) ? 'opacity-50' : '' %>">
                        <input type="checkbox"
                               name="selected_profile_ids[]"
                               value="<%= profile.id %>"
                               <%= profile.organizations.include?(Current.organization) ? 'disabled' : '' %>
                               class="rounded border-gray-300 text-pink-500 focus:ring-pink-500">
                        <div>
                          <span class="text-sm font-medium text-gray-900"><%= profile.name %></span>
                          <% if profile.organizations.include?(Current.organization) %>
                            <span class="text-xs text-gray-500 ml-2">(Already in organization)</span>
                          <% end %>
                        </div>
                      </label>
                    <% end %>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="border border-gray-200 rounded-lg overflow-hidden mt-5">
          <%= render "shared/card_header", title: "Invitation Email" %>
          <div class="p-4">
            <div class="mb-4">
              <%= person_form.label :invitation_subject, "Email Subject:", class: "block font-semibold mb-2 text-sm" %>
              <% default_subject = "You've been invited to join #{Current.organization.name} on CocoScout" %>
              <%= person_form.text_field :invitation_subject, value: default_subject, class: "block shadow-sm rounded-lg border border-gray-400 px-3 py-2 w-full focus:border-pink-500 focus:ring-pink-500 text-sm" %>
            </div>

            <div class="">
              <%= person_form.label :invitation_message, "Email Message:", class: "block font-semibold mb-2 text-sm" %>
              <% default_message = "Welcome to CocoScout!\n\n#{Current.organization.name} is using CocoScout to manage its productions, auditions, and casting.\n\nTo get started, please click the link below to set a password and create your account." %>
              <%= person_form.text_area :invitation_message, value: default_message, rows: 6, class: "block shadow-sm rounded-lg border border-gray-400 px-3 py-2 w-full focus:border-pink-500 focus:ring-pink-500 text-sm" %>
              <p class="mt-2 text-xs text-gray-500">
                The invitation link will be automatically included in the email.
              </p>
            </div>
          </div>
        </div>

        <div class="border-t border-gray-200 pt-5 mt-5">
          <%= render "shared/button", text: "Invite Person", variant: "primary", size: "medium", type: :submit %>
          <%= render "shared/button", text: "Back", variant: "ghost-cancel", size: "medium", path: "javascript:history.back()", type: :button %>
        </div>

      <% end %>
    </div>

    <!-- Batch form -->
    <div data-tabs-target="panel">
      <% if @batch_results %>
        <!-- Batch Results (shown when we have successful invites) -->
        <div class="space-y-4 mb-6">
          <% if @invited.any? %>
            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
              <h3 class="text-sm font-semibold text-green-800 mb-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 inline-block mr-1">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Successfully Invited (<%= @invited.count %>)
              </h3>
              <ul class="text-sm text-green-700 space-y-1">
                <% @invited.each do |item| %>
                  <li><%= item[:name] %> (<%= item[:email] %>)</li>
                <% end %>
              </ul>
            </div>
          <% end %>

          <% if @skipped.any? %>
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
              <h3 class="text-sm font-semibold text-gray-800 mb-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 inline-block mr-1">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
                </svg>
                Skipped (<%= @skipped.count %>)
              </h3>
              <ul class="text-sm text-gray-600 space-y-1">
                <% @skipped.each do |item| %>
                  <li><%= item[:name] %> (<%= item[:email] %>) - <%= item[:reason] %></li>
                <% end %>
              </ul>
            </div>
          <% end %>

          <% if @skipped_multiple_profiles.any? %>
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
              <h3 class="text-sm font-semibold text-yellow-800 mb-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 inline-block mr-1">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                </svg>
                Skipped - Multiple Profiles (<%= @skipped_multiple_profiles.count %>)
              </h3>
              <p class="text-sm text-yellow-700 mb-2">These emails have multiple profiles. Use "Invite One Person" to select which profile to invite:</p>
              <ul class="text-sm text-yellow-700 space-y-1">
                <% @skipped_multiple_profiles.each do |item| %>
                  <li><%= item[:email] %> (<%= item[:count] %> profiles)</li>
                <% end %>
              </ul>
            </div>
          <% end %>

          <% if @errors.any? %>
            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
              <h3 class="text-sm font-semibold text-red-800 mb-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 inline-block mr-1">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
                </svg>
                Errors (<%= @errors.count %>)
              </h3>
              <ul class="text-sm text-red-700 space-y-1">
                <% @errors.each do |item| %>
                  <li><%= item[:email] %> - <%= item[:reason] %></li>
                <% end %>
              </ul>
            </div>
          <% end %>

          <div class="flex gap-3">
            <%= link_to "Go to Directory", manage_people_path, class: "inline-flex items-center px-4 py-2 bg-pink-500 hover:bg-pink-600 text-white rounded-lg text-sm font-medium transition-colors" %>
            <%= link_to "Invite More People", new_manage_person_path, class: "inline-flex items-center px-4 py-2 border border-gray-300 hover:bg-gray-50 text-gray-700 rounded-lg text-sm font-medium transition-colors" %>
          </div>
        </div>
      <% else %>
        <%= form_with url: batch_invite_manage_people_path, method: :post, class: "contents" do |form| %>

          <div class="mb-4">
            <%= form.label :emails, "Email Addresses", class: "block text-sm font-medium text-gray-700" %>
            <div class="mt-1 text-sm text-gray-500 mb-2">
              Enter one email address per line. Names will be automatically generated from the email addresses.
            </div>

            <% if @errors&.any? %>
              <div class="bg-red-50 border border-red-200 rounded-lg p-3 mb-3">
                <p class="text-sm text-red-700">
                  <% if @invited&.any? %>
                    <strong class="text-green-700"><%= @invited.count %> invitation<%= @invited.count == 1 ? '' : 's' %> sent.</strong>
                    The following <%= @errors.count == 1 ? 'email is' : 'emails are' %> invalid:<br>
                  <% end %>
                  <% @errors.each do |item| %>
                    <%= item[:email] %> - <%= item[:reason] %><br>
                  <% end %>
                </p>
              </div>
            <% end %>

            <%= form.text_area :emails,
                value: @batch_emails,
                rows: 10,
                placeholder: "john.smith@example.com\njane.doe@example.com\nalice@example.com",
                class: "block shadow-sm rounded-lg border border-gray-400 px-3 py-2 mt-2 w-full font-mono text-sm" %>
          </div>

          <div class="border border-gray-200 rounded-lg overflow-hidden mt-5">
            <%= render "shared/card_header", title: "Invitation Email" %>
            <div class="p-4">
              <div class="mb-4">
                <%= form.label :invitation_subject, "Email Subject:", class: "block font-semibold mb-2 text-sm" %>
                <% default_subject = "You've been invited to join #{Current.organization.name} on CocoScout" %>
                <%= form.text_field :invitation_subject, value: default_subject, class: "block shadow-sm rounded-lg border border-gray-400 px-3 py-2 w-full focus:border-pink-500 focus:ring-pink-500 text-sm" %>
              </div>

              <div class="">
                <%= form.label :invitation_message, "Email Message:", class: "block font-semibold mb-2 text-sm" %>
                <% default_message = "Welcome to CocoScout!\n\n#{Current.organization.name} is using CocoScout to manage its productions, auditions, and casting.\n\nTo get started, please click the link below to set a password and create your account." %>
                <%= form.text_area :invitation_message, value: default_message, rows: 6, class: "block shadow-sm rounded-lg border border-gray-400 px-3 py-2 w-full focus:border-pink-500 focus:ring-pink-500 text-sm" %>
                <p class="mt-2 text-xs text-gray-500">
                  The invitation link will be automatically included in the email.
                </p>
              </div>
            </div>
          </div>

          <div class="border-t border-gray-200 pt-5 mt-5">
            <%= render "shared/button", text: "Invite Everyone", variant: "primary", size: "medium", type: :submit %>
            <%= render "shared/button", text: "Back", variant: "ghost-cancel", size: "medium", path: "javascript:history.back()", type: :button %>
          </div>

        <% end %>
      <% end %>
    </div>

  </div>

</div>
