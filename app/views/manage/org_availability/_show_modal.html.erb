<div data-controller="availability-popup">
  <%# Header %>
  <div class="flex items-center justify-between px-6 py-3 bg-pink-50 border-b border-pink-100">
    <h2 class="text-base font-semibold text-gray-900">Availability</h2>
    <button type="button" class="text-gray-400 hover:text-gray-600 p-1 cursor-pointer"
            data-action="click->org-availability#closeShowModal">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </button>
  </div>

  <div class="p-6 relative">
    <%# Show card %>
    <div class="flex items-center gap-4 mb-4 pb-4 border-b border-gray-200">
      <div class="flex-shrink-0 w-14 text-center">
        <div class="text-xs font-semibold text-pink-600 uppercase"><%= @show.date_and_time.strftime("%b") %></div>
        <div class="text-2xl font-bold text-gray-900"><%= @show.date_and_time.strftime("%-d") %></div>
        <div class="text-xs text-gray-500"><%= @show.date_and_time.strftime("%a") %></div>
      </div>
      <div class="flex-1">
        <div class="text-xs text-gray-400 mb-0"><%= @production.name %></div>
        <div class="font-semibold text-lg text-gray-900">
          <%= @show.display_name %>
        </div>
        <div class="text-sm text-gray-500">
          <%= @show.date_and_time.strftime("%l:%M %p").strip %>
        </div>
        <% if @show.location %>
          <div class="text-xs text-gray-400 mt-1"><%= @show.location.name %></div>
        <% end %>
      </div>
    </div>

    <%
      # Group members by availability status
      available_members = @members_data.select { |m| m[:availability] == 'available' }
      unset_members = @members_data.select { |m| m[:availability].nil? || m[:availability] == 'unset' }
      unavailable_members = @members_data.select { |m| m[:availability] == 'unavailable' }

      available_count = available_members.size
      unset_count = unset_members.size
      unavailable_count = unavailable_members.size
    %>

    <%# Tabs - use selectKey to prevent URL hash from affecting modal tabs %>
    <div data-controller="tabs" data-tabs-initial-tab-value="0" data-tabs-select-key-value="modal">
      <div class="flex border-b border-gray-200 mb-4">
        <button type="button" data-tabs-target="tab" data-action="click->tabs#select" data-index="0"
                class="px-4 py-2 text-sm font-medium border-b-2 -mb-px cursor-pointer border-pink-500 text-pink-600">
          <%= available_count %> Available
        </button>
        <button type="button" data-tabs-target="tab" data-action="click->tabs#select" data-index="1"
                class="px-4 py-2 text-sm font-medium border-b-2 -mb-px cursor-pointer border-transparent text-gray-500">
          <%= unset_count %> No Response
        </button>
        <button type="button" data-tabs-target="tab" data-action="click->tabs#select" data-index="2"
                class="px-4 py-2 text-sm font-medium border-b-2 -mb-px cursor-pointer border-transparent text-gray-500">
          <%= unavailable_count %> Unavailable
        </button>
      </div>

      <%# Available members panel %>
      <div data-tabs-target="panel">
        <div class="space-y-2 max-h-[350px] overflow-y-auto">
          <% if available_members.empty? %>
            <div class="text-sm text-gray-400 text-center py-4">No available members</div>
          <% else %>
            <% available_members.each do |member_data| %>
              <%= render partial: 'manage/org_availability/member_row_content', locals: { member_data: member_data, show: @show } %>
            <% end %>
          <% end %>
        </div>

        <%# Register/Pre-register All button - show if form exists, show is in future, and there are unregistered available people %>
        <%
          unregistered_available = available_members.select { |m| !m[:is_signed_up] && m[:member].is_a?(Person) }
          show_register_all = @sign_up_form.present? &&
                              @show.date_and_time > Time.current &&
                              unregistered_available.any?
          register_all_label = @sign_up_form_open ? "Register All" : "Pre-register All"
          register_all_description = @sign_up_form_open ?
            "Registering adds them to the sign-up list." :
            "Pre-registering reserves their spot before sign-up opens."
        %>
        <% if show_register_all %>
          <div class="mt-4 pt-4 border-t border-gray-200">
            <div class="flex items-center justify-between">
              <div class="text-sm text-gray-600">
                <span class="font-medium"><%= unregistered_available.count %></span> available
                <%= unregistered_available.count == 1 ? 'person is' : 'people are' %> not yet registered.
                <span class="text-gray-400 text-xs block mt-0.5"><%= register_all_description %></span>
              </div>
              <button type="button"
                      class="px-4 py-2 text-sm font-medium rounded bg-pink-500 text-white hover:bg-pink-600 transition-colors cursor-pointer"
                      data-action="click->org-availability#preRegisterAll"
                      data-show-id="<%= @show.id %>"
                      data-person-ids="<%= unregistered_available.map { |m| m[:member].id }.to_json %>">
                <%= register_all_label %>
              </button>
            </div>
          </div>
        <% end %>
      </div>

      <%# No Response members panel %>
      <div data-tabs-target="panel" class="hidden space-y-2 max-h-[400px] overflow-y-auto">
        <% if unset_members.empty? %>
          <div class="text-sm text-gray-400 text-center py-4">Everyone has responded</div>
        <% else %>
          <% unset_members.each do |member_data| %>
            <%= render partial: 'manage/org_availability/member_row_content', locals: { member_data: member_data, show: @show } %>
          <% end %>
        <% end %>
      </div>

      <%# Unavailable members panel %>
      <div data-tabs-target="panel" class="hidden space-y-2 max-h-[400px] overflow-y-auto">
        <% if unavailable_members.empty? %>
          <div class="text-sm text-gray-400 text-center py-4">No unavailable members</div>
        <% else %>
          <% unavailable_members.each do |member_data| %>
            <%= render partial: 'manage/org_availability/member_row_content', locals: { member_data: member_data, show: @show } %>
          <% end %>
        <% end %>
      </div>
    </div>

    <%# Action Popup (hidden by default) %>
    <div class="hidden fixed z-[60] bg-white rounded-lg shadow-xl border border-gray-200 p-3 min-w-[220px] max-w-[300px]"
         data-availability-popup-target="popup">
      <div class="text-xs font-medium text-gray-500 uppercase mb-2" data-availability-popup-target="popupTitle">Actions</div>
      <div class="space-y-1" data-availability-popup-target="popupContent">
        <!-- Populated dynamically -->
      </div>
      <div class="mt-2 pt-2 border-t border-gray-200">
        <button type="button" class="w-full text-center text-xs text-gray-500 hover:text-gray-700 py-1 cursor-pointer" data-action="click->availability-popup#closePopup">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <%# JSON data for roles and sign-up form %>
  <%
    sign_up_form_data = nil
    if @sign_up_form
      instance = @sign_up_form.sign_up_form_instances.find_by(show: @show)
      slots_data = []
      if instance
        instance.sign_up_slots.order(:position).each do |slot|
          confirmed_count = slot.sign_up_registrations.where(status: ['confirmed', 'waitlisted']).count
          slots_data << {
            id: slot.id,
            name: slot.name,
            position: slot.position,
            capacity: slot.capacity || 1,
            current_count: confirmed_count,
            available: confirmed_count < (slot.capacity || 1)
          }
        end
      end
      sign_up_form_data = {
        id: @sign_up_form.id,
        name: @sign_up_form.name,
        is_open: @sign_up_form_open,
        slot_mode: @sign_up_form.slot_generation_mode,
        show_in_past: @show.date_and_time < Time.current,
        slots: slots_data
      }
    end
  %>
  <script type="application/json" data-availability-popup-target="rolesData">
  <%= raw({
    show_id: @show.id,
    roles: @all_roles.map { |r| {
      id: r.id,
      name: r.name,
      quantity: r.quantity || 1,
      current_count: @role_counts[r.id] || 0,
      restricted: r.restricted?,
      eligible_members: r.restricted? ? r.eligible_members.map { |m| { type: m.class.name, id: m.id } } : nil
    }},
    sign_up_form: sign_up_form_data
  }.to_json) %>
  </script>
</div>
