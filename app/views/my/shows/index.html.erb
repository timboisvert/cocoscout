<% content_for :title, "Shows & Events" %>

<div class="w-full">

  <%= render partial: "shared/notice", locals: { notice: notice } %>

  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [],
    text: "My Shows & Events",
    links: [
      {
        text: "Calendar",
        path: my_shows_calendar_path,
        icon: "calendar"
      }
    ]
  } %>

  <% if @has_any_shows %>

  <%= render "shared/filters/filter_bar",
      toggle_label: "Filters & View Options",
      filter_groups: [
        {
          label: "View",
          filters: [
            { text: "My Assignments", path: my_shows_path(filter: 'my_assignments', event_type: @event_type_filter.join(','), entity: @entity_filter.join(',')), active: @filter == 'my_assignments' },
            { text: "All Shows", path: my_shows_path(filter: 'all', event_type: @event_type_filter.join(','), entity: @entity_filter.join(',')), active: @filter == 'all' },
            { text: "By Production", path: my_shows_path(filter: 'by_production', event_type: @event_type_filter.join(','), entity: @entity_filter.join(',')), active: @filter == 'by_production' }
          ]
        },
        { separator: true },
        {
          partial: "shared/filters/entity_filter",
          locals: {
            path_helper: method(:my_shows_path),
            person: @person,
            groups: @groups,
            entity_filter: @entity_filter,
            label: "Include",
            filter: @filter,
            event_type: @event_type_filter.join(",")
          }
        }
      ]
  %>

  <% if @filter == 'by_production' %>
    <!-- By Production View -->
    <% @productions.each do |production| %>
      <% production_shows = @shows.select { |show| show.production_id == production.id } %>
      <% if production_shows.any? %>
        <div class="mb-6">
          <h2 class="text-lg font-bold mb-2"><%= production.name %></h2>
          <div class="space-y-1">
            <% production_shows.each do |show| %>
              <%= link_to my_show_path(show), class: "block" do %>
                <div class="flex bg-white items-center justify-between gap-3 p-3 border border-gray-200 rounded-lg hover:border-gray-400 transition-all">
                  <div class="flex-1 min-w-0">
                    <div class="text-sm font-semibold <%= 'line-through text-red-400' if show.canceled %>">
                      <%= show.date_and_time.strftime("%a, %b %-d, %Y") %> <span class="font-normal">at</span>
                      <%= show.date_and_time.strftime("%l:%M %p") %>
                    </div>
                    <div class="flex items-center gap-2 mt-1 flex-wrap">
                      <% if show.canceled %>
                        <span class="inline-flex items-center rounded-md bg-red-50 px-2 py-1 text-xs font-medium text-red-700 ring-1 ring-inset ring-red-600/10">Canceled</span>
                      <% end %>
                      <span class="inline-flex items-center rounded-md px-1.5 py-0.5 text-xs font-medium ring-1 ring-inset <%= event_type_badge_classes(show.event_type) %>">
                        <%= show.event_type.titleize %>
                      </span>
                      <% if show.secondary_name.present? %>
                        <span class="text-xs sm:text-sm text-gray-900 font-medium"><%= show.secondary_name %></span>
                      <% end %>
                      <% if show.location.present? %>
                        <span class="inline-flex items-center gap-1 rounded-md px-1.5 py-0.5 text-xs font-medium ring-1 ring-inset bg-gray-50 text-gray-700 ring-gray-600/10">
                          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" /></svg>
                          <%= show.location.name %>
                        </span>
                      <% end %>
                      <% if @entity_type == "group" %>
                        <span class="inline-flex items-center rounded-md bg-purple-50 px-1.5 py-0.5 text-xs font-medium text-purple-700 ring-1 ring-inset ring-purple-600/10">Group: <%= @selected_group.name %></span>
                      <% end %>
                      <% if @show_assignments[show.id].present? %>
                        <% filtered_assignments = @show_assignments[show.id].select do |entity_info|
                          (entity_info[:type] == "person" && @entity_filter.include?("person")) ||
                          (entity_info[:type] == "group" && @entity_filter.include?("group_#{entity_info[:entity].id}"))
                        end %>
                        <% filtered_assignments.each do |entity_info| %>
                          <% # Find the actual assignment record for this entity
                             assignment = ShowPersonRoleAssignment.find_by(
                               show_id: show.id,
                               assignable_type: entity_info[:type] == "person" ? "Person" : "Group",
                               assignable_id: entity_info[:entity].id
                             ) %>
                          <% if assignment %>
                            <span class="text-xs text-gray-600">Role: <strong class="text-pink-500"><%= assignment.role.name %></strong></span>
                          <% end %>
                        <% end %>
                      <% end %>
                    </div>
                  </div>
                  <% if @groups.any? && @show_assignments[show.id].present? %>
                    <% filtered_assignments = @show_assignments[show.id].select do |entity_info|
                      (entity_info[:type] == "person" && @entity_filter.include?("person")) ||
                      (entity_info[:type] == "group" && @entity_filter.include?("group_#{entity_info[:entity].id}"))
                    end %>
                    <% if filtered_assignments.any? %>
                      <div class="flex-shrink-0 flex gap-1">
                        <% filtered_assignments.each do |entity_info| %>
                          <%= image_tag entity_info[:entity].safe_headshot_variant(:thumb), class: "w-10 h-10 rounded-lg object-cover" %>
                        <% end %>
                      </div>
                    <% end %>
                  <% end %>
                </div>
              <% end %>
            <% end %>
          </div>
        </div>
      <% end %>
    <% end %>
  <% else %>
    <!-- All Shows View -->
    <% if @shows.any? %>
      <div class="space-y-1">
        <% @shows.each do |show| %>
          <%= link_to my_show_path(show), class: "block" do %>
            <div class="flex bg-white items-center justify-between gap-3 p-3 border border-gray-200 rounded-lg hover:border-gray-400 transition-all">
              <div class="flex-1 min-w-0">
                <div class="text-sm font-semibold <%= 'line-through text-red-400' if show.canceled %>">
                  <%= show.date_and_time.strftime("%a, %b %-d, %Y") %> <span class="font-normal">at</span>
                  <%= show.date_and_time.strftime("%l:%M %p") %>
                </div>
                <div class="flex items-center gap-2 mt-1 flex-wrap">
                  <% if show.canceled %>
                    <span class="inline-flex items-center rounded-md bg-red-50 px-2 py-1 text-xs font-medium text-red-700 ring-1 ring-inset ring-red-600/10">Canceled</span>
                  <% end %>
                  <span class="text-xs sm:text-sm text-gray-600"><%= show.production.name %></span>
                  <span class="inline-flex items-center rounded-md px-1.5 py-0.5 text-xs font-medium ring-1 ring-inset <%= event_type_badge_classes(show.event_type) %>">
                    <%= show.event_type.titleize %>
                  </span>
                  <% if show.secondary_name.present? %>
                    <span class="text-xs sm:text-sm text-gray-900 font-medium"><%= show.secondary_name %></span>
                  <% end %>
                  <% if show.location.present? %>
                    <span class="inline-flex items-center gap-1 rounded-md px-1.5 py-0.5 text-xs font-medium ring-1 ring-inset bg-gray-50 text-gray-700 ring-gray-600/10">
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" /></svg>
                      <%= show.location.name %>
                    </span>
                  <% end %>
                  <% if @entity_type == "group" %>
                    <span class="inline-flex items-center rounded-md bg-purple-50 px-1.5 py-0.5 text-xs font-medium text-purple-700 ring-1 ring-inset ring-purple-600/10">Group: <%= @selected_group.name %></span>
                  <% end %>
                  <% if @show_assignments[show.id].present? %>
                    <% filtered_assignments = @show_assignments[show.id].select do |entity_info|
                      (entity_info[:type] == "person" && @entity_filter.include?("person")) ||
                      (entity_info[:type] == "group" && @entity_filter.include?("group_#{entity_info[:entity].id}"))
                    end %>
                    <% filtered_assignments.each do |entity_info| %>
                      <% # Find the actual assignment record for this entity
                         assignment = ShowPersonRoleAssignment.find_by(
                           show_id: show.id,
                           assignable_type: entity_info[:type] == "person" ? "Person" : "Group",
                           assignable_id: entity_info[:entity].id
                         ) %>
                      <% if assignment %>
                        <span class="text-xs text-gray-600">Role: <strong class="text-pink-500"><%= assignment.role.name %></strong></span>
                      <% end %>
                    <% end %>
                  <% end %>
                </div>
              </div>
              <% if @groups.any? && @show_assignments[show.id].present? %>
                <% filtered_assignments = @show_assignments[show.id].select do |entity_info|
                  (entity_info[:type] == "person" && @entity_filter.include?("person")) ||
                  (entity_info[:type] == "group" && @entity_filter.include?("group_#{entity_info[:entity].id}"))
                end %>
                <% if filtered_assignments.any? %>
                  <div class="flex-shrink-0 flex gap-1">
                    <% filtered_assignments.each do |entity_info| %>
                      <%= image_tag entity_info[:entity].safe_headshot_variant(:thumb), class: "w-10 h-10 rounded-lg object-cover" %>
                    <% end %>
                  </div>
                <% end %>
              <% end %>
            </div>
          <% end %>
        <% end %>
      </div>
    <% else %>
      <div class="text-sm text-gray-500">
        No upcoming shows or events found.
      </div>
    <% end %>
  <% end %>

  <% else %>
    <p class="text-gray-500 text-sm">You aren't a cast member of any shows.</p>
  <% end %>

</div>