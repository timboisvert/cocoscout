<% content_for :title, "#{@sign_up_form.name}" %>

<%
  # Calculate status early so we can use it for auto-refresh decision
  form_status = @sign_up_form.current_status
  needs_refresh = form_status[:state] == :initializing || form_status[:state] == :updating

  # Get accessible productions for move functionality
  accessible_productions = Current.user.accessible_productions
                                      .where.not(id: @production.id)
                                      .order(:name)
                                      .map { |prod| { id: prod.id, name: prod.name, show_count: prod.shows.count, logo_url: prod.logo.attached? ? url_for(prod.logo.variant(:small)) : nil } }

  # Build warning for move
  move_warning = nil
  if @sign_up_form.single_event? && @sign_up_form.show_id.present?
    move_warning = "This form is linked to a specific show. It will be unlinked when moved."
  elsif @sign_up_form.sign_up_form_shows.any?
    move_warning = "Event assignments will be cleared. You'll need to reconfigure which events use this form."
  end
%>

<div class="w-full mb-10"
     data-controller="move-registration-modal add-sign-up-person sign-up-form-actions<%= ' welcome-modal' if params[:just_created] %><%= ' auto-refresh' if needs_refresh %>"
     data-sign-up-form-actions-productions-value="<%= accessible_productions.to_json %>"
     data-sign-up-form-actions-warning-value="<%= move_warning %>"
     data-add-sign-up-person-search-url-value="<%= manage_production_casting_search_people_path(@production) %>"
     data-add-sign-up-person-register-url-value="<%= register_manage_production_sign_up_form_path(@production, @sign_up_form) %>"
     data-add-sign-up-person-register-queue-url-value="<%= register_to_queue_manage_production_sign_up_form_path(@production, @sign_up_form) %>"
     <% if params[:just_created] %>
       data-welcome-modal-auto-show-value="true"
     <% end %>
     <% if needs_refresh %>
       data-auto-refresh-interval-value="15000"
     <% end %>>
  <%= render partial: "shared/notice", locals: { notice: notice } %>
  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [
      ["Sign-ups", manage_production_sign_up_forms_path(@production)]
    ],
    text: @sign_up_form.name,
    links: []
  } %>

  <%# Status bar %>
  <% status_explanation = @sign_up_form.status_service.status_explanation %>
  <div class="bg-white border border-gray-200 rounded-lg mb-6" data-controller="disclosure">
    <div class="px-5 py-4">
      <%# Top row: status badge and buttons (buttons hidden on mobile) %>
      <div class="flex items-center justify-between">
        <button type="button" class="flex items-center gap-4 cursor-pointer hover:opacity-80 transition-opacity" data-action="click->disclosure#toggle">
          <span class="inline-flex items-center gap-2 rounded-full px-3 py-1 text-sm font-medium bg-<%= form_status[:color] %>-100 text-<%= form_status[:color] %>-800">
            <% if form_status[:state] == :accepting %>
              <span class="relative flex h-2.5 w-2.5">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-<%= form_status[:color] %>-400 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-<%= form_status[:color] %>-500"></span>
              </span>
            <% elsif form_status[:state] == :initializing %>
              <svg class="w-3 h-3 text-<%= form_status[:color] %>-500 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            <% else %>
              <span class="w-2 h-2 rounded-full bg-<%= form_status[:color] %>-500"></span>
            <% end %>
            <%= form_status[:label] %>
          </span>
          <% if @sign_up_form.repeated? && form_status[:open_count].to_i > 0 %>
            <span class="text-sm text-gray-500 hidden sm:inline">
              <%= pluralize(form_status[:open_count], 'event') %> accepting sign-ups
            </span>
          <% elsif @sign_up_form.repeated? && form_status[:next_event] %>
            <span class="text-sm text-gray-500 hidden sm:inline">
              Next event in <%= pluralize(form_status[:next_event][:days_until_show].floor, 'day') %>
            </span>
          <% end %>
          <svg class="w-4 h-4 text-gray-400 transition-transform duration-200" data-disclosure-target="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
          </svg>
        </button>
        <%# Desktop buttons %>
        <div class="hidden sm:flex items-center gap-2">
          <%= render "shared/button", text: "Print List", path: print_list_manage_production_sign_up_form_path(@production, @sign_up_form), variant: "secondary", size: "small", icon: "print", target: "_blank" %>
          <%= render "shared/button", text: "Settings", path: settings_manage_production_sign_up_form_path(@production, @sign_up_form), variant: "secondary", size: "small", icon: "cog" %>
          <%= render "shared/button", text: @sign_up_form.active? ? 'Turn Off' : 'Turn On', path: toggle_active_manage_production_sign_up_form_path(@production, @sign_up_form), variant: @sign_up_form.active? ? 'secondary' : 'primary', size: "small", data: { turbo_method: :patch } %>
        </div>
      </div>
      <%# Mobile buttons - shown below status %>
      <div class="flex sm:hidden items-center gap-2 mt-3 pt-3 border-t border-gray-100">
        <%= render "shared/button", text: "Print", path: print_list_manage_production_sign_up_form_path(@production, @sign_up_form), variant: "secondary", size: "small", icon: "print", target: "_blank" %>
        <%= render "shared/button", text: "Settings", path: settings_manage_production_sign_up_form_path(@production, @sign_up_form), variant: "secondary", size: "small", icon: "cog" %>
        <%= render "shared/button", text: @sign_up_form.active? ? 'Turn Off' : 'Turn On', path: toggle_active_manage_production_sign_up_form_path(@production, @sign_up_form), variant: @sign_up_form.active? ? 'secondary' : 'primary', size: "small", data: { turbo_method: :patch } %>
      </div>
    </div>

    <%# Expandable status explanation %>
    <div class="hidden border-t border-gray-100 px-5 py-4 bg-gray-50" data-disclosure-target="content">
      <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-3">Status Explanation</h4>
      <ul class="space-y-2">
        <% status_explanation.each do |item| %>
          <li class="flex items-start gap-2 text-sm">
            <% if item[:check] %>
              <svg class="w-4 h-4 text-green-500 mt-0.5 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" />
              </svg>
            <% else %>
              <svg class="w-4 h-4 text-gray-400 mt-0.5 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
              </svg>
            <% end %>
            <span class="<%= item[:check] ? 'text-gray-700' : 'text-gray-500' %>"><%= item[:text] %></span>
          </li>
        <% end %>
      </ul>
    </div>

    <%# Single event info using show_row style %>
    <% if @sign_up_form.single_event? && @sign_up_form.show %>
      <div class="px-5 pb-4">
        <%= render "shared/show_row", show: @sign_up_form.show, show_location: true %>
      </div>
    <% end %>
  </div>

  <%# Queue Banner for admin_assigns mode %>
  <% if @sign_up_form.admin_assigns? && @current_instance %>
    <% queue_count = @current_instance.queued_registrations.count %>
    <div class="bg-white border border-gray-200 rounded-lg mb-6">
      <div class="px-5 py-4 flex items-center justify-between">
        <div class="flex items-center gap-4">
          <div class="flex items-center gap-3">
            <div class="inline-flex items-center justify-center w-10 h-10 bg-pink-100 rounded-full">
              <svg class="w-5 h-5 text-pink-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 0 0 2.625.372 9.337 9.337 0 0 0 4.121-.952 4.125 4.125 0 0 0-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 0 1 8.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0 1 11.964-3.07M12 6.375a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0Zm8.25 2.25a2.625 2.625 0 1 1-5.25 0 2.625 2.625 0 0 1 5.25 0Z" />
              </svg>
            </div>
            <div>
              <p class="font-semibold text-gray-900"><%= queue_count %> <%= queue_count == 1 ? 'person' : 'people' %> in queue</p>
              <% if queue_count > 0 %>
                <p class="text-sm text-gray-500">Waiting to be assigned to slots</p>
              <% else %>
                <p class="text-sm text-gray-500">Add people to assign them to slots</p>
              <% end %>
            </div>
          </div>
        </div>
        <%= render "shared/button", text: "Queue", path: assign_manage_production_sign_up_form_path(@production, @sign_up_form, instance_id: @current_instance.id), variant: "primary", size: "small", icon: "queue-list" %>
      </div>
    </div>
  <% end %>

  <% if @sign_up_form.repeated? %>
    <%# 50/50 Grid Layout for Repeated Event Mode %>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <%# Left Column - Registrations (50%) %>
      <div>
        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
          <% if @current_instance %>
            <%
              instance_slots = @current_instance.sign_up_slots
              instance_registrations = instance_slots.joins(:sign_up_registrations).where(sign_up_registrations: { status: [:confirmed, :pending] }).count
              instance_capacity = instance_slots.sum(:capacity)
              is_instance_open = @current_instance.open?
              is_instance_closed = @current_instance.closed? || @current_instance.show.date_and_time <= Time.current
            %>
            <%# Event Navigator Header with Open/Closed status %>
            <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
              <div class="flex items-center gap-3">
                <h3 class="font-semibold text-gray-900"><%= @sign_up_form.admin_assigns? ? 'Slot Assignments' : 'Registrations' %></h3>
                <% if is_instance_open %>
                  <span class="inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                    <span class="relative flex h-2 w-2">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                    </span>
                    Open
                  </span>
                <% else %>
                  <span class="inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600">
                    <span class="w-2 h-2 rounded-full bg-gray-400"></span>
                    Closed
                  </span>
                <% end %>
              </div>
              <div class="flex items-center gap-3">
                <% if instance_capacity < 1000 %>
                  <span class="text-sm text-gray-500"><%= instance_registrations %> of <%= instance_capacity %> <%= @sign_up_form.admin_assigns? ? 'slots filled' : 'spots filled' %></span>
                <% else %>
                  <span class="text-sm text-gray-500"><%= instance_registrations %> <%= @sign_up_form.admin_assigns? ? 'assigned' : 'registered' %></span>
                <% end %>
                <% is_waitlist_mode = %w[simple_capacity open_list].include?(@sign_up_form.slot_generation_mode) %>
                <% if is_waitlist_mode %>
                  <% first_available_slot = @current_instance.sign_up_slots.detect { |s| !s.is_held && s.spots_remaining > 0 } %>
                  <% if first_available_slot %>
                    <button type="button"
                            class="inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded hover:bg-gray-50 transition-colors cursor-pointer"
                            data-action="click->add-sign-up-person#open"
                            data-slot-id="<%= first_available_slot.id %>"
                            data-slot-name="List">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                      </svg>
                      Add
                    </button>
                  <% end %>
                <% end %>
              </div>
            </div>

            <%# Urgent countdown bar - only show if under 24 hours %>
            <%
              instance_closes_at = @current_instance.closes_at
              seconds_until_instance_close = instance_closes_at.present? ? (instance_closes_at - Time.current).to_i : 0
            %>
            <% if is_instance_open && instance_closes_at.present? && seconds_until_instance_close > 0 && seconds_until_instance_close < 86400 %>
              <div class="px-5 py-2 bg-pink-500 flex items-center"
                   data-controller="countdown"
                   data-countdown-until-value="<%= instance_closes_at.iso8601 %>">
                <span class="text-white font-medium text-sm">Closes in </span>
                <span class="text-white font-semibold text-sm tabular-nums ml-1" data-countdown-target="clock">--</span>
              </div>
            <% end %>

            <%# Current Event using show_row style with arrows %>
            <div class="px-3 py-3 bg-gray-50 border-b border-gray-100">
              <div class="flex items-center gap-2">
                <% if @instances.size > 1 %>
                  <% current_idx = @instances.find_index(@current_instance).to_i %>
                  <% prev_instance = current_idx > 0 ? @instances.to_a[current_idx - 1] : nil %>
                  <% if prev_instance %>
                    <%= link_to manage_production_sign_up_form_path(@production, @sign_up_form, instance_id: prev_instance.id),
                        class: "p-1.5 rounded hover:bg-gray-200 text-gray-400 hover:text-gray-600 shrink-0",
                        data: { turbo_action: "replace" } do %>
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                    <% end %>
                  <% else %>
                    <div class="w-8"></div>
                  <% end %>
                <% end %>

                <div class="flex-1">
                  <%= render partial: "shared/show_row", locals: {
                    show: @current_instance.show,
                    show_location: true
                  } %>
                </div>

                <% if @instances.size > 1 %>
                  <% next_instance_nav = @instances.to_a[current_idx + 1] %>
                  <% if next_instance_nav %>
                    <%= link_to manage_production_sign_up_form_path(@production, @sign_up_form, instance_id: next_instance_nav.id),
                        class: "p-1.5 rounded hover:bg-gray-200 text-gray-400 hover:text-gray-600 shrink-0",
                        data: { turbo_action: "replace" } do %>
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                    <% end %>
                  <% else %>
                    <div class="w-8"></div>
                  <% end %>
                <% end %>
              </div>
            </div>

            <%# All Slots with Registrations %>
            <% slots = @current_instance.sign_up_slots.order(:position) %>
            <%= render "manage/sign_up_forms/registration_list",
                slots: slots,
                sign_up_form: @sign_up_form,
                production: @production,
                instance: @current_instance %>
          <% else %>
            <%# No Events Yet %>
            <div class="p-8 text-center">
              <svg class="w-12 h-12 mx-auto text-gray-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
              <p class="text-gray-500">No upcoming events.</p>
              <p class="text-sm text-gray-400 mt-1">Instances will be created automatically for matching events.</p>
            </div>
          <% end %>
        </div>
      </div>

      <%# Right Column - Events List + Share (50%) %>
      <div class="space-y-6">
        <%# Queue card for admin_assigns mode %>
        <% if @sign_up_form.admin_assigns? && @current_instance %>
          <% instance_queue_count = @current_instance.queued_registrations.count %>
          <div class="bg-white border border-gray-200 rounded-lg">
            <div class="px-5 py-4 flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="inline-flex items-center justify-center w-10 h-10 bg-pink-100 rounded-full">
                  <svg class="w-5 h-5 text-pink-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 0 0 2.625.372 9.337 9.337 0 0 0 4.121-.952 4.125 4.125 0 0 0-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 0 1 8.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0 1 11.964-3.07M12 6.375a3.375 3.375 0 1 1-6.75 0 3.375 3.375 0 0 1 6.75 0Zm8.25 2.25a2.625 2.625 0 1 1-5.25 0 2.625 2.625 0 0 1 5.25 0Z" />
                  </svg>
                </div>
                <div>
                  <p class="font-semibold text-gray-900"><%= instance_queue_count %> <%= instance_queue_count == 1 ? 'person' : 'people' %> in queue</p>
                  <% if instance_queue_count > 0 %>
                    <p class="text-sm text-gray-500">Waiting to be assigned</p>
                  <% end %>
                </div>
              </div>
              <%= render "shared/button", text: "Queue", path: assign_manage_production_sign_up_form_path(@production, @sign_up_form, instance_id: @current_instance.id), variant: "primary", size: "small", icon: "queue-list" %>
            </div>
          </div>
        <% end %>

        <%# Upcoming Events List (clickable, scrollable) %>
        <%
          is_auto_sync = @sign_up_form.event_matching == 'all'
          event_types_label = if @sign_up_form.event_matching == 'event_types' && @sign_up_form.event_type_filter.present?
            @sign_up_form.event_type_filter.map(&:titleize).to_sentence
          end
        %>
        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
          <div class="px-5 py-3 border-b border-gray-100 flex items-center justify-between">
            <span class="text-sm font-medium text-gray-700">
              <% if is_auto_sync %>
                All upcoming events
              <% elsif event_types_label %>
                Upcoming <%= event_types_label %> events
              <% else %>
                Upcoming events
              <% end %>
            </span>
            <% if is_auto_sync %>
              <span class="inline-flex items-center gap-1 text-xs font-medium text-pink-600">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                Auto-sync
              </span>
            <% end %>
          </div>

          <% if @upcoming_instances.present? %>
            <%# Scrollable event list - max height of ~4 items %>
            <div class="max-h-[280px] overflow-y-auto">
              <div class="p-2 space-y-1">
                <% @upcoming_instances.each do |instance| %>
                  <%
                    is_current = instance == @current_instance
                    is_cancelled = instance.cancelled? || instance.show.canceled?
                    is_open = instance.open?
                  %>
                  <%= link_to manage_production_sign_up_form_path(@production, @sign_up_form, instance_id: instance.id),
                      class: "block rounded-lg transition-colors #{is_current ? 'ring-2 ring-pink-500 ring-inset bg-pink-50' : 'hover:bg-gray-50'} #{is_cancelled ? 'opacity-50' : ''} #{!is_open && !is_cancelled ? 'opacity-60' : ''}",
                      data: { turbo_action: "replace" } do %>
                    <div class="flex items-center gap-2 p-1">
                      <div class="flex-1">
                        <%= render partial: "shared/show_row", locals: {
                          show: instance.show,
                          show_location: false,
                          show_canceled: is_cancelled
                        } %>
                      </div>
                      <% if is_open %>
                        <span class="shrink-0 w-2 h-2 rounded-full bg-green-500 mr-2" title="Open"></span>
                      <% elsif !is_cancelled %>
                        <span class="shrink-0 w-2 h-2 rounded-full bg-gray-300 mr-2" title="Not yet open"></span>
                      <% end %>
                    </div>
                  <% end %>
                <% end %>
              </div>
            </div>
            <% if is_auto_sync %>
              <div class="px-5 py-2 bg-pink-50 border-t border-pink-100 flex items-center gap-2">
                <span class="relative flex h-2 w-2">
                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-pink-400 opacity-75"></span>
                  <span class="relative inline-flex rounded-full h-2 w-2 bg-pink-500"></span>
                </span>
                <span class="text-xs text-pink-700">New events are automatically added</span>
              </div>
            <% end %>
          <% else %>
            <div class="px-5 py-6 text-center text-gray-500 text-sm">
              <% if is_auto_sync %>
                <p>No upcoming events yet. New events will be automatically added when they're created.</p>
              <% else %>
                <p>No upcoming events configured.</p>
              <% end %>
            </div>
          <% end %>
        </div>

        <%# Share Card %>
        <div class="bg-white border border-gray-200 rounded-lg">
          <%= render "shared/card_header", title: "Sign-up Form" %>
          <div class="p-5 space-y-4">
            <%# Public Sign-up Link (short link) %>
            <% if @sign_up_form.short_code.present? %>
              <% public_signup_url = "#{request.base_url}#{@sign_up_form.short_url_path}" %>
              <%= render "shared/copy_url", url: public_signup_url, label: "Public Sign-up Link" %>
            <% end %>

            <%# Edit and Preview buttons %>
            <div class="flex flex-wrap items-center gap-3 pt-4 border-t border-gray-100">
              <%= render "shared/button", text: "Edit Form", path: edit_manage_production_sign_up_form_path(@production, @sign_up_form), variant: "secondary", size: "small", icon: "pencil" %>
              <%= render "shared/button", text: "Preview Form", path: preview_manage_production_sign_up_form_path(@production, @sign_up_form), variant: "secondary", size: "small", icon: "eye", target: "_blank" %>
            </div>
          </div>
        </div>

        <%# Actions Accordion %>
        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden" data-controller="disclosure">
          <button type="button"
                  class="w-full px-5 py-3 flex items-center justify-between text-left hover:bg-gray-50 cursor-pointer"
                  data-action="click->disclosure#toggle">
            <span class="text-sm font-medium text-gray-700">Actions</span>
            <svg class="w-4 h-4 text-gray-400 transition-transform duration-200" data-disclosure-target="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m19.5 8.25-7.5 7.5-7.5-7.5"/>
            </svg>
          </button>
          <div class="hidden border-t border-gray-100" data-disclosure-target="content">
            <div class="p-4 space-y-3">
              <%# Move to another production %>
              <div class="flex items-center justify-between py-2">
                <div>
                  <p class="text-sm font-medium text-gray-900">Move to another production</p>
                  <p class="text-xs text-gray-500">Transfer this sign-up form and all its data to a different production</p>
                </div>
                <%= render "shared/button",
                    text: "Move",
                    variant: "secondary",
                    size: "small",
                    data: { action: "click->sign-up-form-actions#openMoveModal" } %>
              </div>

              <%# Archive %>
              <div class="flex items-center justify-between py-2 border-t border-gray-100">
                <div>
                  <p class="text-sm font-medium text-gray-900">Archive this form</p>
                  <p class="text-xs text-gray-500">Hide from your list. Can be restored later.</p>
                </div>
                <%= link_to archive_manage_production_sign_up_form_path(@production, @sign_up_form),
                    data: { turbo_method: :patch, turbo_confirm: "Archive this sign-up form? It will be hidden from your list but can be restored later." },
                    class: "inline-flex items-center px-3 py-1.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50" do %>
                  Archive
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% else %>
    <%# Non-repeated modes (single event, shared pool) %>

    <%# Countdown Box for Single Events - only show if under 24 hours %>
    <% if @sign_up_form.single_event? && form_status[:accepting_registrations] %>
      <%
        single_event_closes_at = @current_instance&.closes_at
        seconds_until_close = single_event_closes_at.present? ? (single_event_closes_at - Time.current).to_i : 0
      %>
      <% if single_event_closes_at.present? && seconds_until_close > 0 && seconds_until_close < 86400 %>
        <div class="mb-6 bg-pink-500 rounded-lg px-5 py-3"
             data-controller="countdown"
             data-countdown-until-value="<%= single_event_closes_at.iso8601 %>"
             data-countdown-expired-action-value="refresh">
          <span class="text-white font-medium">Closes in </span>
          <span class="text-white font-semibold tabular-nums" data-countdown-target="clock">--</span>
        </div>
      <% end %>
    <% end %>

    <%# 50/50 grid layout %>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <%# Left Column - Registrations/Assignments (50%) %>
      <div>
        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
          <% total_capacity = @current_instance&.sign_up_slots&.sum(:capacity) || 0 %>
          <% assigned_count = @current_instance&.sign_up_slots&.joins(:sign_up_registrations)&.where(sign_up_registrations: { status: [:confirmed, :pending] })&.count || 0 %>
          <% first_available_slot = @current_instance&.sign_up_slots&.detect { |s| !s.is_held && s.spots_remaining > 0 } %>
          <% is_waitlist_mode = %w[simple_capacity open_list].include?(@sign_up_form.slot_generation_mode) %>
          <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
            <h3 class="font-semibold text-gray-900"><%= @sign_up_form.admin_assigns? ? 'Slot Assignments' : 'Registrations' %></h3>
            <div class="flex items-center gap-3">
              <span class="text-sm text-gray-500">
                <% if @sign_up_form.admin_assigns? %>
                  <% if total_capacity < 1000 %>
                    <%= assigned_count %> of <%= total_capacity %> slots filled
                  <% else %>
                    <%= assigned_count %> assigned
                  <% end %>
                <% else %>
                  <% if total_capacity < 1000 %>
                    <%= @registrations.count %> of <%= total_capacity %> spots filled
                  <% else %>
                    <%= @registrations.count %> registered
                  <% end %>
                <% end %>
              </span>
              <% if is_waitlist_mode && first_available_slot %>
                <button type="button"
                        class="inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded hover:bg-gray-50 transition-colors cursor-pointer"
                        data-action="click->add-sign-up-person#open"
                        data-slot-id="<%= first_available_slot.id %>"
                        data-slot-name="List">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                  </svg>
                  Add
                </button>
              <% end %>
            </div>
          </div>

          <% if @current_instance&.sign_up_slots&.any? %>
            <%= render "manage/sign_up_forms/registration_list",
                slots: @current_instance.sign_up_slots.order(:position),
                sign_up_form: @sign_up_form,
                production: @production,
                instance: @current_instance %>
          <% elsif form_status[:state] == :initializing %>
              <%# Form is being set up - show loading state %>
              <div class="px-5 py-12 text-center" data-controller="auto-refresh" data-auto-refresh-interval-value="30000">
                <div class="inline-flex items-center justify-center w-12 h-12 mx-auto mb-3 rounded-full bg-blue-100">
                  <svg class="w-6 h-6 text-blue-500 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                </div>
                <p class="text-gray-700 font-medium">Setting up your sign-up form...</p>
                <p class="text-sm text-gray-500 mt-1">This will only take a moment.</p>
              </div>
          <% else %>
              <div class="px-5 py-12 text-center">
                <svg class="w-12 h-12 mx-auto text-gray-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                <p class="text-gray-500">No slots configured yet.</p>
                <p class="text-sm text-gray-400 mt-1">Go to Settings to configure slots.</p>
              </div>
          <% end %>
        </div>
      </div>

      <%# Right Column - Share (50%) %>
      <div class="space-y-4">
        <%# Share Card %>
        <div class="bg-white border border-gray-200 rounded-lg">
          <%= render "shared/card_header", title: "Share" %>
          <div class="p-5 space-y-4">
            <%# Public Sign-up Link (short link) %>
            <% if @sign_up_form.short_code.present? %>
              <% public_signup_url = "#{request.base_url}#{@sign_up_form.short_url_path}" %>
              <%= render "shared/copy_url", url: public_signup_url, label: "Public Sign-up Link" %>
            <% end %>

            <%# Edit and Preview buttons %>
            <div class="flex flex-wrap items-center gap-3 pt-4 border-t border-gray-100">
              <%= render "shared/button", text: "Edit Form", path: edit_manage_production_sign_up_form_path(@production, @sign_up_form), variant: "secondary", size: "small", icon: "pencil" %>
              <%= render "shared/button", text: "Preview Form", path: preview_manage_production_sign_up_form_path(@production, @sign_up_form), variant: "secondary", size: "small", icon: "eye", target: "_blank" %>
            </div>
          </div>
        </div>

        <%# Actions Accordion %>
        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden" data-controller="disclosure">
          <button type="button"
                  class="w-full px-5 py-3 flex items-center justify-between text-left hover:bg-gray-50 cursor-pointer"
                  data-action="click->disclosure#toggle">
            <span class="text-sm font-medium text-gray-700">Actions</span>
            <svg class="w-4 h-4 text-gray-400 transition-transform duration-200" data-disclosure-target="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m19.5 8.25-7.5 7.5-7.5-7.5"/>
            </svg>
          </button>
          <div class="hidden border-t border-gray-100" data-disclosure-target="content">
            <div class="p-4 space-y-3">
              <%# Move to another production %>
              <div class="flex items-center justify-between py-2">
                <div>
                  <p class="text-sm font-medium text-gray-900">Move to another production</p>
                  <p class="text-xs text-gray-500">Transfer this sign-up form and all its data to a different production</p>
                </div>
                <%= render "shared/button",
                    text: "Move",
                    variant: "secondary",
                    size: "small",
                    data: { action: "click->sign-up-form-actions#openMoveModal" } %>
              </div>

              <%# Archive %>
              <div class="flex items-center justify-between py-2 border-t border-gray-100">
                <div>
                  <p class="text-sm font-medium text-gray-900">Archive this form</p>
                  <p class="text-xs text-gray-500">Hide from your list. Can be restored later.</p>
                </div>
                <%= link_to archive_manage_production_sign_up_form_path(@production, @sign_up_form),
                    data: { turbo_method: :patch, turbo_confirm: "Archive this sign-up form? It will be hidden from your list but can be restored later." },
                    class: "inline-flex items-center px-3 py-1.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50" do %>
                  Archive
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <%# Welcome Modal - shown after form is first created %>
  <% if params[:just_created] %>
    <div class="hidden fixed inset-0 z-50" data-welcome-modal-target="modal">
      <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" data-action="click->welcome-modal#close"></div>
      <div class="absolute inset-4 md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-full md:max-w-md bg-white rounded-2xl shadow-2xl overflow-hidden">
        <%# Celebration header - solid pink %>
        <div class="bg-pink-500 px-6 py-8 text-center">
          <div class="inline-flex items-center justify-center w-16 h-16 bg-white/20 rounded-full mb-4">
            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
          </div>
          <h2 class="text-2xl font-bold text-white mb-1">Sign-up Form Created!</h2>
          <p class="text-pink-100">You're almost ready to accept sign-ups</p>
        </div>

        <%# Content %>
        <div class="px-6 py-5">
          <p class="text-gray-600 mb-5">
            Your sign-up form is set up with the basics. Here's what you might want to do next:
          </p>

          <div class="space-y-3">
            <div class="flex items-start gap-3">
              <div class="flex-shrink-0 w-6 h-6 rounded-full bg-pink-100 text-pink-600 flex items-center justify-center text-sm font-medium">1</div>
              <div>
                <p class="font-medium text-gray-900">Customize your form</p>
                <p class="text-sm text-gray-500">Add a description, header image, and custom questions</p>
              </div>
            </div>
            <div class="flex items-start gap-3">
              <div class="flex-shrink-0 w-6 h-6 rounded-full bg-pink-100 text-pink-600 flex items-center justify-center text-sm font-medium">2</div>
              <div>
                <p class="font-medium text-gray-900">Preview the form</p>
                <p class="text-sm text-gray-500">See what registrants will see before going live</p>
              </div>
            </div>
            <div class="flex items-start gap-3">
              <div class="flex-shrink-0 w-6 h-6 rounded-full bg-pink-100 text-pink-600 flex items-center justify-center text-sm font-medium">3</div>
              <div>
                <p class="font-medium text-gray-900">Share the link</p>
                <p class="text-sm text-gray-500">Copy the form URL or QR code to share with your audience</p>
              </div>
            </div>
          </div>
        </div>

        <%# Footer %>
        <div class="px-6 py-4 bg-gray-50 border-t border-gray-100">
          <div class="flex justify-end">
            <%= render "shared/button", text: "Got it!", variant: "primary", size: "medium", data: { action: "welcome-modal#close" } %>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <%# Move Registration Modal - for all slot-based modes %>
  <% if @sign_up_form.repeated? && @current_instance %>
    <%= render "manage/sign_up_forms/move_registration_modal",
        sign_up_form: @sign_up_form,
        production: @production,
        slots: @current_instance.sign_up_slots.order(:position) %>
  <% elsif !@sign_up_form.repeated? %>
    <%= render "manage/sign_up_forms/move_registration_modal",
        sign_up_form: @sign_up_form,
        production: @production,
        slots: @sign_up_form.sign_up_slots.order(:position) %>
  <% end %>

  <%# Add Person Modal %>
  <div data-add-sign-up-person-target="modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4" data-action="click->add-sign-up-person#close">
    <div class="bg-white w-full max-w-md rounded-lg shadow-xl" data-action="click->add-sign-up-person#stopPropagation">
      <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
        <h2 data-add-sign-up-person-target="modalTitle" class="text-lg font-semibold text-gray-900">Add Person</h2>
        <button type="button" data-action="click->add-sign-up-person#close" class="text-gray-400 hover:text-gray-600 p-1 cursor-pointer">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <div class="p-6">
        <div class="relative">
          <input type="text"
                 data-add-sign-up-person-target="searchInput"
                 data-action="input->add-sign-up-person#search"
                 placeholder="Search by name or email..."
                 class="w-full px-4 py-2 pl-10 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-pink-500 focus:border-pink-500">
          <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
          </svg>
          <div data-add-sign-up-person-target="searchSpinner" class="hidden absolute right-3 top-1/2 -translate-y-1/2">
            <svg class="animate-spin h-4 w-4 text-pink-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </div>
        </div>

        <p class="text-xs text-gray-500 mt-2">Search for someone in your organization</p>

        <%# Search results %>
        <div data-add-sign-up-person-target="searchResults" class="mt-4 space-y-1 max-h-64 overflow-y-auto">
          <p class="text-sm text-gray-400 text-center py-4">Type to search...</p>
        </div>
      </div>

      <input type="hidden" data-add-sign-up-person-target="slotId">
      <input type="hidden" data-add-sign-up-person-target="instanceId">
      <%# Hidden element for slotName (used by JS) %>
      <span data-add-sign-up-person-target="slotName" class="hidden"></span>
    </div>
  </div>

  <%# Move Sign-up Form Modal %>
  <div data-sign-up-form-actions-target="moveModal"
       class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4"
       data-action="click->sign-up-form-actions#closeMoveModal">
    <div class="bg-white w-full max-w-md rounded-lg shadow-xl" data-action="click->sign-up-form-actions#stopPropagation">
      <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
        <h2 class="text-lg font-semibold text-gray-900">Move Sign-up Form</h2>
        <button type="button" data-action="click->sign-up-form-actions#closeMoveModal" class="text-gray-400 hover:text-gray-600 p-1 cursor-pointer">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <div class="p-6">
        <p class="text-sm text-gray-600 mb-4">
          Move "<strong><%= @sign_up_form.name %></strong>" to another production. All registrations and settings will be preserved.
        </p>

        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Select destination production</label>
          <div data-sign-up-form-actions-target="productionsList" class="space-y-2 max-h-64 overflow-y-auto">
            <p class="text-sm text-gray-400 text-center py-4">Loading productions...</p>
          </div>
        </div>

        <div data-sign-up-form-actions-target="warningBox" class="hidden mb-4 p-3 bg-amber-50 border border-amber-200 rounded-lg">
          <div class="flex items-start gap-2">
            <svg class="w-5 h-5 text-amber-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            <div class="text-sm text-amber-800">
              <p class="font-medium">Note:</p>
              <p data-sign-up-form-actions-target="warningText"></p>
            </div>
          </div>
        </div>
      </div>

      <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-end gap-3">
        <button type="button"
                data-action="click->sign-up-form-actions#closeMoveModal"
                class="px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-900">
          Cancel
        </button>
        <%= form_with url: transfer_manage_production_sign_up_form_path(@production, @sign_up_form), method: :patch, local: true, data: { sign_up_form_actions_target: "moveForm" } do %>
          <input type="hidden" name="target_production_id" data-sign-up-form-actions-target="targetProductionId">
          <%= render "shared/button", text: "Move Sign-up Form", variant: "primary", size: "medium", type: :submit, disabled: true, data: { sign_up_form_actions_target: "moveButton" } %>
        <% end %>
      </div>
    </div>
  </div>
</div>
