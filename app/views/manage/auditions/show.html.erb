<% content_for :title, "Audition" %>
<% audition_session = @audition.audition_session %>
<% auditionable = @audition.auditionable %>

<div class="w-full pb-48 lg:pb-40 relative">
  <%= render partial: "shared/notice", locals: { notice: notice } %>

  <%# Archived stamp - inky rubber stamp effect %>
  <% unless @audition_cycle.active %>
    <div class="absolute top-20 right-24 z-30 pointer-events-none">
      <div class="transform rotate-12 px-6 py-3 relative" style="filter: url(#inkFilter);">
        <%# SVG filter for inky/distressed effect %>
        <svg class="absolute" width="0" height="0">
          <defs>
            <filter id="inkFilter" x="-20%" y="-20%" width="140%" height="140%">
              <feTurbulence type="fractalNoise" baseFrequency="0.04" numOctaves="5" result="noise"/>
              <feDisplacementMap in="SourceGraphic" in2="noise" scale="3" xChannelSelector="R" yChannelSelector="G"/>
            </filter>
          </defs>
        </svg>
        <div class="border-4 border-red-400/60 rounded px-5 py-2 bg-transparent text-center" style="border-style: double; border-width: 4px;">
          <span class="text-red-400/70 font-black text-3xl tracking-widest uppercase block" style="font-family: 'Courier New', monospace; text-shadow: 1px 1px 0 rgba(239,68,68,0.2), -1px -1px 0 rgba(239,68,68,0.1);">ARCHIVED</span>
          <span class="text-red-400/50 text-xs tracking-wide block mt-1" style="font-family: 'Courier New', monospace;"><%= @audition_cycle.updated_at.strftime("%b %-d, %Y") %></span>
        </div>
        <%# Ink splotches for authenticity %>
        <div class="absolute -top-1 -left-1 w-2 h-2 bg-red-400/30 rounded-full blur-[1px]"></div>
        <div class="absolute -bottom-1 -right-2 w-3 h-1 bg-red-400/20 rounded-full blur-[1px]"></div>
        <div class="absolute top-1/2 -left-2 w-1 h-3 bg-red-400/25 rounded-full blur-[1px]"></div>
      </div>
    </div>
  <% end %>

  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [
      ["Sign-ups", manage_signups_path],
      [@production.name, manage_signups_production_path(@production)],
      ["Auditions", manage_signups_auditions_path(@production)],
      ["Run Auditions", manage_run_signups_auditions_cycle_path(@production, @audition_cycle)],
      [audition_session.start_at.strftime("%b %-d, %Y at %-l:%M %p"), manage_signups_auditions_cycle_session_path(@production, @audition_cycle, audition_session)]
    ],
    text: auditionable&.name&.truncate(40, omission: "...") || "Audition",
    links: []
  } %>

  <%# Hero Section with Headshot, Name, Email, Profile Link %>
  <% if auditionable.present? %>
    <div class="flex items-center gap-4 mb-6">
      <% if auditionable.respond_to?(:safe_headshot_variant) %>
        <% headshot_variant = auditionable.safe_headshot_variant(:thumb) %>
        <% if headshot_variant %>
          <%= image_tag headshot_variant, class: "w-12 h-12 rounded-lg object-cover flex-shrink-0" %>
        <% else %>
          <div class="w-12 h-12 rounded-lg bg-gray-100 flex items-center justify-center text-black font-bold flex-shrink-0">
            <%= auditionable.respond_to?(:initials) ? auditionable.initials : auditionable.name[0..1].upcase %>
          </div>
        <% end %>
      <% end %>
      <div class="flex-1 min-w-0">
        <div class="flex items-baseline gap-2 min-w-0">
          <div class="font-bold text-xl text-gray-900 truncate flex-shrink"><%= auditionable.name %></div>
          <% if auditionable.respond_to?(:pronouns) && auditionable.pronouns.present? %>
            <div class="text-sm text-gray-500 flex-shrink-0">(<%= auditionable.pronouns %>)</div>
          <% end %>
        </div>
        <div class="flex flex-wrap items-center gap-x-3 gap-y-1 text-sm text-gray-500">
          <% if auditionable.respond_to?(:email) && auditionable.email.present? %>
            <%= link_to auditionable.email, "mailto:#{auditionable.email}", class: "text-pink-500 hover:underline" %>
          <% end %>
        </div>
      </div>
      <% if auditionable.respond_to?(:public_key) && auditionable.public_key.present? %>
        <div class="flex-shrink-0 flex items-center gap-2">
          <% if auditionable.is_a?(Person) %>
            <%= render partial: "shared/button", locals: { text: "Contact", path: contact_manage_person_path(auditionable), variant: "outline", data: { turbo_frame: "contact_modal" } } %>
          <% end %>
          <%= render partial: "shared/button", locals: { text: "Public Profile", path: public_profile_path(auditionable.public_key), variant: "outline", target: "_blank" } %>
        </div>
      <% end %>
    </div>
  <% end %>

  <div class="w-full" data-controller="tabs">
    <nav class="flex flex-wrap gap-2 border-b border-gray-200 mb-4">
      <% idx = 0 %>
      <button type="button" data-tabs-target="tab" data-index="<%= idx %>" data-action="tabs#select" class="px-3 lg:px-4 py-2 text-xs lg:text-sm font-medium bg-white border-b-2 text-pink-600 cursor-pointer whitespace-nowrap">Profile</button>
      <% idx += 1 %>
      <button type="button" data-tabs-target="tab" data-index="<%= idx %>" data-action="tabs#select" class="px-3 lg:px-4 py-2 text-xs lg:text-sm font-medium bg-gray-50 border-b-2 text-gray-500 cursor-pointer whitespace-nowrap">Headshots</button>
      <% idx += 1 %>
      <button type="button" data-tabs-target="tab" data-index="<%= idx %>" data-action="tabs#select" class="px-3 lg:px-4 py-2 text-xs lg:text-sm font-medium bg-gray-50 border-b-2 text-gray-500 cursor-pointer whitespace-nowrap">Resume</button>
      <% idx += 1 %>
      <% if @audition.audition_request&.audition_cycle&.accepts_video_submissions? %>
        <button type="button" data-tabs-target="tab" data-index="<%= idx %>" data-action="tabs#select" class="px-3 lg:px-4 py-2 text-xs lg:text-sm font-medium bg-gray-50 border-b-2 text-gray-500 cursor-pointer whitespace-nowrap">Video</button>
        <% idx += 1 %>
      <% end %>
      <button type="button" data-tabs-target="tab" data-index="<%= idx %>" data-action="tabs#select" class="px-3 lg:px-4 py-2 text-xs lg:text-sm font-medium bg-gray-50 border-b-2 text-gray-500 cursor-pointer whitespace-nowrap">Availability</button>
      <% idx += 1 %>
      <button type="button" data-tabs-target="tab" data-index="<%= idx %>" data-action="tabs#select" class="px-3 lg:px-4 py-2 text-xs lg:text-sm font-medium bg-gray-50 border-b-2 text-gray-500 cursor-pointer whitespace-nowrap">Audition Questions</button>
      <% idx += 1 %>
      <% if current_user_can_review?(@production) %>
        <button type="button" data-tabs-target="tab" data-index="<%= idx %>" data-action="tabs#select" class="px-3 lg:px-4 py-2 text-xs lg:text-sm font-medium bg-gray-50 border-b-2 text-gray-500 cursor-pointer whitespace-nowrap">Votes</button>
        <% idx += 1 %>
      <% end %>
    </nav>

    <%# Profile Tab %>
    <div data-tabs-target="panel">
      <% if auditionable.is_a?(Person) %>
        <%= render "manage/audition_requests/profile_tab", person: auditionable %>
      <% elsif auditionable.present? %>
        <%= render "shared/group_card", group: auditionable, show_delete_signup: false, show_public_profile_link: false %>
      <% else %>
        <p class="text-gray-500">This person/group is no longer available.</p>
      <% end %>
    </div>

    <%# Headshots Tab %>
    <div data-tabs-target="panel" class="hidden">
      <% if auditionable.nil? %>
        <p class="text-left text-gray-500 text-sm">This person/group is no longer available</p>
      <% elsif auditionable.respond_to?(:profile_headshots) && auditionable.profile_headshots.any? %>
        <%= render "shared/image_gallery", items: auditionable.profile_headshots, type: "headshot", empty_message: "No headshots uploaded" %>
      <% else %>
        <p class="text-left text-gray-500 text-sm">No headshots uploaded</p>
      <% end %>
    </div>

    <%# Resume Tab %>
    <div data-tabs-target="panel" class="hidden">
      <% if auditionable.nil? %>
        <p class="text-left text-gray-500 text-sm">This person/group is no longer available</p>
      <% else %>
        <%= render "shared/image_gallery", items: auditionable.profile_resumes, type: "resume", empty_message: "No resume found" %>
      <% end %>
    </div>

    <%# Video Tab %>
    <% if @audition.audition_request&.audition_cycle&.accepts_video_submissions? %>
      <div data-tabs-target="panel" class="hidden">
        <% if @audition.audition_request&.video_url.present? %>
          <div class="mt-2">
            <%= render "manage/audition_requests/video", audition_request: @audition.audition_request %>
          </div>
        <% else %>
          <p class="text-sm text-gray-500">No video uploaded</p>
        <% end %>
      </div>
    <% end %>

    <%# Availability Tab %>
    <div data-tabs-target="panel" class="hidden">
      <% if auditionable.nil? %>
        <p class="text-left text-gray-500 text-sm">This person/group is no longer available</p>
      <% elsif @audition.audition_request.present? %>
        <% audition_request = @audition.audition_request %>
        <% audition_cycle = audition_request.audition_cycle %>
        <% shows = audition_cycle.production.shows.where("date_and_time >= ?", Time.current).order(:date_and_time) %>
        <% show_availabilities = auditionable.is_a?(Person) ? auditionable.show_availabilities.where(show_id: shows.pluck(:id)).index_by(&:show_id) : {} %>
        <% audition_sessions = audition_cycle.audition_sessions.where("start_at >= ?", Time.current).order(:start_at) %>
        <%
          audition_availability = {}
          AuditionSessionAvailability.where(available_entity: auditionable, audition_session_id: audition_sessions.pluck(:id)).each do |session_availability|
            audition_availability[session_availability.audition_session_id.to_s] = session_availability.status.to_s
          end
        %>

        <%# Reviewer view: read-only availability display %>
        <% if audition_cycle.include_availability_section && shows.present? %>
          <div class="border border-gray-200 rounded-lg overflow-hidden mb-4">
            <%= render "shared/card_header", title: "Show & Event Availability" %>
            <div class="p-2">
              <div class="space-y-1">
                <% shows.each do |show| %>
                  <% availability = show_availabilities[show.id] %>
                  <div class="flex items-stretch px-3 py-2 border rounded-lg bg-white border-gray-200">
                    <div class="w-1/2 flex items-center gap-4">
                      <div class="flex-shrink-0 w-14 text-center">
                        <div class="text-xs font-semibold text-pink-600 uppercase"><%= show.date_and_time.strftime("%b") %></div>
                        <div class="text-2xl font-bold text-gray-900"><%= show.date_and_time.strftime("%-d") %></div>
                        <div class="text-xs text-gray-500"><%= show.date_and_time.strftime("%a") %></div>
                      </div>
                      <div class="flex-1 min-w-0">
                        <div class="font-medium text-gray-900"><%= show.display_name %></div>
                        <div class="text-sm text-gray-600"><%= show.date_and_time.strftime("%l:%M %p") %></div>
                      </div>
                    </div>
                    <div class="w-1/2 border-l border-gray-200 pl-4 flex items-center">
                      <% if availability %>
                        <span class="px-2 py-1 text-xs rounded <%= availability.status == 'available' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700' %>">
                          <%= availability.status.humanize %>
                        </span>
                      <% else %>
                        <span class="text-xs text-gray-400">Not set</span>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>

        <% if audition_cycle.include_audition_availability_section && audition_sessions.present? %>
          <div class="border border-gray-200 rounded-lg overflow-hidden mb-4">
            <%= render "shared/card_header", title: "Audition Session Availability" %>
            <div class="p-2">
              <div class="space-y-1">
                <% audition_sessions.each do |session| %>
                  <% current_status = audition_availability&.dig("#{session.id}") %>
                  <div class="flex items-stretch px-3 py-2 border rounded-lg bg-white border-gray-200">
                    <div class="w-1/2 flex items-center gap-4">
                      <div class="flex-shrink-0 w-14 text-center">
                        <div class="text-xs font-semibold text-pink-600 uppercase"><%= session.start_at.strftime("%b") %></div>
                        <div class="text-2xl font-bold text-gray-900"><%= session.start_at.strftime("%-d") %></div>
                        <div class="text-xs text-gray-500"><%= session.start_at.strftime("%a") %></div>
                      </div>
                      <div class="flex-1 min-w-0">
                        <div class="font-medium text-gray-900">Audition Session</div>
                        <div class="text-sm text-gray-600"><%= session.start_at.strftime("%l:%M %p") %></div>
                      </div>
                    </div>
                    <div class="w-1/2 border-l border-gray-200 pl-4 flex items-center">
                      <% if current_status.present? %>
                        <span class="px-2 py-1 text-xs rounded <%= current_status == 'available' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700' %>">
                          <%= current_status.humanize %>
                        </span>
                      <% else %>
                        <span class="text-xs text-gray-400">Not set</span>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>

        <% if !audition_cycle.include_availability_section && !audition_cycle.include_audition_availability_section %>
          <p class="text-center mt-10 text-gray-500">No availability entered</p>
        <% end %>
      <% else %>
        <p class="text-center mt-10 text-gray-500">No availability entered</p>
      <% end %>
    </div>

    <%# Audition Questions Tab %>
    <div data-tabs-target="panel" class="hidden">
      <% if @audition.audition_request&.answers&.any? %>
        <div class="mt-2">
          <%= render "manage/audition_requests/answers", answers: @audition.audition_request.answers.includes(:question) %>
        </div>
      <% else %>
        <p class="text-center mt-10">No audition questions answered</p>
      <% end %>
    </div>

    <%# Votes Tab (for reviewers only) %>
    <% if current_user_can_review?(@production) %>
      <div data-tabs-target="panel" class="hidden">
        <% votes = @audition.audition_votes.includes(user: :default_person).order(created_at: :desc) %>
        <% vote_counts = @audition.vote_counts %>

        <%# Vote count boxes spanning full width %>
        <div class="grid grid-cols-3 gap-2 mb-4">
          <div class="p-3 bg-white border border-gray-200 rounded-lg text-center">
            <div class="text-2xl font-bold text-pink-600"><%= vote_counts[:yes] %></div>
            <div class="text-xs text-gray-500">Yes</div>
          </div>
          <div class="p-3 bg-white border border-gray-200 rounded-lg text-center">
            <div class="text-2xl font-bold text-pink-600"><%= vote_counts[:no] %></div>
            <div class="text-xs text-gray-500">No</div>
          </div>
          <div class="p-3 bg-white border border-gray-200 rounded-lg text-center">
            <div class="text-2xl font-bold text-pink-600"><%= vote_counts[:maybe] %></div>
            <div class="text-xs text-gray-500">Not Sure</div>
          </div>
        </div>

        <%# Two column layout: Reviewers on left, Comments on right %>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <%# Left side: Reviewers list %>
          <div>
            <div class="border border-gray-200 rounded-lg overflow-hidden">
              <%= render "shared/card_header", title: "Reviewers" %>
              <div class="divide-y divide-gray-200">
                <% if votes.any? %>
                  <% votes.each do |vote| %>
                    <div class="flex items-center px-4 py-3">
                      <div class="w-1/2 flex items-center gap-2">
                        <% if vote.user&.person %>
                          <% headshot = vote.user.person.safe_headshot_variant(:thumb) %>
                          <% if headshot %>
                            <%= image_tag headshot, class: "w-8 h-8 rounded-lg object-cover flex-shrink-0" %>
                          <% else %>
                            <div class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center text-gray-700 font-bold text-xs flex-shrink-0">
                              <%= vote.user.person.initials %>
                            </div>
                          <% end %>
                          <span class="text-sm text-gray-900 truncate"><%= vote.user.person.name %></span>
                        <% else %>
                          <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-700 font-bold text-xs flex-shrink-0">?</div>
                          <span class="text-sm text-gray-500">Unknown</span>
                        <% end %>
                      </div>
                      <div class="w-1/2 text-right">
                        <% vote_label = case vote.vote
                           when "yes" then "Yes"
                           when "no" then "No"
                           when "maybe" then "Not Sure"
                           else "‚Äî"
                           end %>
                        <% vote_class = case vote.vote
                           when "yes" then "bg-green-100 text-green-700"
                           when "no" then "bg-red-100 text-red-700"
                           when "maybe" then "bg-yellow-100 text-yellow-700"
                           else "bg-gray-100 text-gray-500"
                           end %>
                        <span class="px-2 py-1 text-xs rounded font-medium <%= vote_class %>"><%= vote_label %></span>
                      </div>
                    </div>
                  <% end %>
                <% else %>
                  <p class="px-4 py-3 text-sm text-gray-500">No votes yet</p>
                <% end %>
              </div>
            </div>
          </div>

          <%# Right side: Comments %>
          <div>
            <div class="border border-gray-200 rounded-lg overflow-hidden">
              <%= render "shared/card_header", title: "Comments" %>
              <div class="divide-y divide-gray-200">
                <% votes_with_comments = votes.select { |v| v.comment.present? } %>
                <% if votes_with_comments.any? %>
                  <% votes_with_comments.each do |vote| %>
                    <div class="px-4 py-3">
                      <p class="text-sm text-gray-900 mb-2"><%= vote.comment %></p>
                      <div class="flex items-center gap-2">
                        <% if vote.user&.person %>
                          <% headshot = vote.user.person.safe_headshot_variant(:thumb) %>
                          <% if headshot %>
                            <%= image_tag headshot, class: "w-5 h-5 rounded-lg object-cover flex-shrink-0" %>
                          <% else %>
                            <div class="w-5 h-5 rounded-lg bg-gray-100 flex items-center justify-center text-gray-700 font-bold text-[8px] flex-shrink-0">
                              <%= vote.user.person.initials %>
                            </div>
                          <% end %>
                          <span class="text-xs text-gray-500"><%= vote.user.person.name %></span>
                        <% end %>
                      </div>
                    </div>
                  <% end %>
                <% else %>
                  <p class="px-4 py-3 text-sm text-gray-500">No comments yet</p>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>
    <% end %>

  </div>
</div>


<%# Fade overlay for bottom of content %>
<div class="fixed bottom-0 left-0 right-0 lg:left-56 h-40 sm:h-56 bg-gradient-to-t from-gray-100 via-gray-100 via-50% to-transparent pointer-events-none z-10"></div>

<% if current_user_can_review?(@production) && @audition_cycle.audition_voting_enabled && @audition_cycle.active %>
  <% current_vote = @audition.vote_for(Current.user) %>
  <% vote_counts = @audition.vote_counts %>
  <% auditions_in_session = audition_session.auditions.order(:id) %>
  <% current_index = auditions_in_session.find_index(@audition) %>
  <% prev_audition = current_index && current_index > 0 ? auditions_in_session[current_index - 1] : nil %>
  <% next_audition = current_index && current_index < auditions_in_session.size - 1 ? auditions_in_session[current_index + 1] : nil %>

  <div class="fixed bottom-4 left-4 right-4 lg:left-60 lg:right-4 bg-white rounded-lg shadow-lg border border-gray-200 z-20 overflow-hidden"
       data-controller="vote-form"
       data-vote-form-save-url-value="<%= manage_cast_vote_signups_auditions_cycle_session_audition_path(@production, @audition_cycle, audition_session, @audition) %>">
    <div class="bg-gray-50 px-3 py-2 border-b border-gray-200">
      <h3 class="text-sm font-semibold text-gray-900 coustard-regular">Should this <%= auditionable.is_a?(Person) ? 'person' : 'group' %> be added to <%= @production.name %>'s talent pool?</h3>
    </div>
    <div class="p-3 flex flex-col sm:flex-row sm:items-center gap-3">
      <!-- Navigation row on mobile, left side on desktop -->
      <div class="flex items-center gap-2 sm:gap-3">
        <!-- Previous button -->
        <div class="flex-shrink-0">
          <% if prev_audition %>
            <%= link_to manage_signups_auditions_cycle_session_audition_path(@production, @audition_cycle, audition_session, prev_audition),
                class: "flex items-center justify-center w-10 h-10 rounded text-pink-500 hover:bg-pink-50 transition-all nav-preserve-tab",
                data: { action: "click->vote-form#navigateWithSave" } do %>
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" />
              </svg>
            <% end %>
          <% else %>
            <div class="flex items-center justify-center w-10 h-10 text-gray-300">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" />
              </svg>
            </div>
          <% end %>
        </div>

        <!-- Vote buttons inline on mobile nav row -->
        <div class="flex items-center gap-1 sm:hidden flex-1 justify-center">
          <%# Yes button - mobile %>
          <% is_yes = current_vote&.vote == "yes" %>
          <button type="button"
                  data-action="click->vote-form#submitVote"
                  data-vote-form-vote-param="yes"
                  data-vote-form-url-param="<%= manage_cast_vote_signups_auditions_cycle_session_audition_path(@production, @audition_cycle, audition_session, @audition) %>"
                  class="inline-flex items-center justify-center gap-1 px-2.5 py-1.5 text-xs font-medium rounded transition-colors cursor-pointer <%= is_yes ? 'bg-pink-500 hover:bg-pink-600 text-white' : 'bg-white border border-gray-300 hover:bg-gray-50 text-gray-700' %>">
            <span>üëç</span>
            <span class="opacity-75"><%= vote_counts[:yes] %></span>
          </button>

          <%# No button - mobile %>
          <% is_no = current_vote&.vote == "no" %>
          <button type="button"
                  data-action="click->vote-form#submitVote"
                  data-vote-form-vote-param="no"
                  data-vote-form-url-param="<%= manage_cast_vote_signups_auditions_cycle_session_audition_path(@production, @audition_cycle, audition_session, @audition) %>"
                  class="inline-flex items-center justify-center gap-1 px-2.5 py-1.5 text-xs font-medium rounded transition-colors cursor-pointer <%= is_no ? 'bg-pink-500 hover:bg-pink-600 text-white' : 'bg-white border border-gray-300 hover:bg-gray-50 text-gray-700' %>">
            <span>üëé</span>
            <span class="opacity-75"><%= vote_counts[:no] %></span>
          </button>

          <%# Not Sure button - mobile %>
          <% is_maybe = current_vote&.vote == "maybe" %>
          <button type="button"
                  data-action="click->vote-form#submitVote"
                  data-vote-form-vote-param="maybe"
                  data-vote-form-url-param="<%= manage_cast_vote_signups_auditions_cycle_session_audition_path(@production, @audition_cycle, audition_session, @audition) %>"
                  class="inline-flex items-center justify-center gap-1 px-2.5 py-1.5 text-xs font-medium rounded transition-colors cursor-pointer <%= is_maybe ? 'bg-pink-500 hover:bg-pink-600 text-white' : 'bg-white border border-gray-300 hover:bg-gray-50 text-gray-700' %>">
            <span>ü§î</span>
            <span class="opacity-75"><%= vote_counts[:maybe] %></span>
          </button>
        </div>

        <!-- Next button on mobile -->
        <div class="flex-shrink-0 sm:hidden">
          <% if next_audition %>
            <%= link_to manage_signups_auditions_cycle_session_audition_path(@production, @audition_cycle, audition_session, next_audition),
                class: "flex items-center justify-center w-10 h-10 rounded text-pink-500 hover:bg-pink-50 transition-all nav-preserve-tab",
                data: { action: "click->vote-form#navigateWithSave" } do %>
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" />
              </svg>
            <% end %>
          <% else %>
            <div class="flex items-center justify-center w-10 h-10 text-gray-300">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" />
              </svg>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Mobile comment row -->
      <div class="sm:hidden flex items-center gap-2 border-t border-gray-200 pt-2">
        <input type="text"
               data-vote-form-target="comment"
               placeholder="Add a comment..."
               value="<%= current_vote&.comment %>"
               class="flex-1 px-3 py-1.5 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-pink-500 focus:border-pink-500 min-w-0" />
        <button type="button"
                data-action="click->vote-form#submitComment"
                data-vote-form-url-param="<%= manage_cast_vote_signups_auditions_cycle_session_audition_path(@production, @audition_cycle, audition_session, @audition) %>"
                class="inline-flex items-center justify-center px-3 py-1.5 text-sm font-medium rounded bg-pink-500 hover:bg-pink-600 text-white transition-colors cursor-pointer whitespace-nowrap">
          Save
        </button>
      </div>

      <!-- Separator - desktop only -->
      <div class="hidden sm:block w-px h-12 bg-gray-200"></div>

      <!-- Content rows - desktop only -->
      <div class="hidden sm:block flex-1 space-y-2">
        <!-- Row 1: Cast your vote -->
        <div class="flex items-center gap-2">
          <span class="text-sm text-gray-500 whitespace-nowrap hidden sm:inline w-28">Cast your vote</span>
          <%# Yes button %>
          <% is_yes = current_vote&.vote == "yes" %>
          <button type="button"
                  data-action="click->vote-form#submitVote"
                  data-vote-form-vote-param="yes"
                  data-vote-form-url-param="<%= manage_cast_vote_signups_auditions_cycle_session_audition_path(@production, @audition_cycle, audition_session, @audition) %>"
                  class="inline-flex items-center justify-center gap-1 px-4 py-2 text-sm font-medium rounded transition-colors cursor-pointer whitespace-nowrap w-32 <%= is_yes ? 'bg-pink-500 hover:bg-pink-600 text-white' : 'bg-white border border-gray-300 hover:bg-gray-50 text-gray-700' %>">
            <span>Yes</span>
            <span class="opacity-75">(<%= vote_counts[:yes] %>)</span>
          </button>

          <%# No button %>
          <% is_no = current_vote&.vote == "no" %>
          <button type="button"
                  data-action="click->vote-form#submitVote"
                  data-vote-form-vote-param="no"
                  data-vote-form-url-param="<%= manage_cast_vote_signups_auditions_cycle_session_audition_path(@production, @audition_cycle, audition_session, @audition) %>"
                  class="inline-flex items-center justify-center gap-1 px-4 py-2 text-sm font-medium rounded transition-colors cursor-pointer whitespace-nowrap w-32 <%= is_no ? 'bg-pink-500 hover:bg-pink-600 text-white' : 'bg-white border border-gray-300 hover:bg-gray-50 text-gray-700' %>">
            <span>No</span>
            <span class="opacity-75">(<%= vote_counts[:no] %>)</span>
          </button>

          <%# Not Sure button %>
          <% is_maybe = current_vote&.vote == "maybe" %>
          <button type="button"
                  data-action="click->vote-form#submitVote"
                  data-vote-form-vote-param="maybe"
                  data-vote-form-url-param="<%= manage_cast_vote_signups_auditions_cycle_session_audition_path(@production, @audition_cycle, audition_session, @audition) %>"
                  class="inline-flex items-center justify-center gap-1 px-4 py-2 text-sm font-medium rounded transition-colors cursor-pointer whitespace-nowrap w-32 <%= is_maybe ? 'bg-pink-500 hover:bg-pink-600 text-white' : 'bg-white border border-gray-300 hover:bg-gray-50 text-gray-700' %>">
            <span>Not Sure</span>
            <span class="opacity-75">(<%= vote_counts[:maybe] %>)</span>
          </button>
        </div>

        <!-- Row 2: Add a comment -->
        <div class="flex items-center gap-2 border-t border-gray-200 pt-2">
          <span class="text-sm text-gray-500 whitespace-nowrap w-28">Add a comment</span>
          <input type="text"
                 id="vote-comment"
                 data-vote-form-target="comment"
                 placeholder="Optional comment..."
                 value="<%= current_vote&.comment %>"
                 class="flex-1 px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-pink-500 focus:border-pink-500 min-w-0" />
          <button type="button"
                  data-action="click->vote-form#submitComment"
                  data-vote-form-url-param="<%= manage_cast_vote_signups_auditions_cycle_session_audition_path(@production, @audition_cycle, audition_session, @audition) %>"
                  class="inline-flex items-center justify-center px-4 py-2 text-sm font-medium rounded bg-pink-500 hover:bg-pink-600 text-white transition-colors cursor-pointer whitespace-nowrap">
            Save
          </button>
        </div>
      </div>

      <!-- Separator - desktop only -->
      <div class="hidden sm:block w-px h-12 bg-gray-200"></div>

      <!-- Next button - desktop only -->
      <div class="hidden sm:block flex-shrink-0">
        <% if next_audition %>
          <%= link_to manage_signups_auditions_cycle_session_audition_path(@production, @audition_cycle, audition_session, next_audition),
              class: "flex items-center justify-center w-10 h-10 rounded text-pink-500 hover:bg-pink-50 transition-all nav-preserve-tab",
              data: { action: "click->vote-form#navigateWithSave" } do %>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" />
            </svg>
          <% end %>
        <% else %>
          <div class="flex items-center justify-center w-10 h-10 text-gray-300">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" />
            </svg>
          </div>
        <% end %>
      </div>
    </div>
  </div>
<% end %>

<script>
  // Update navigation links to preserve current tab
  document.addEventListener('DOMContentLoaded', function() {
    function updateNavLinks() {
      const hash = window.location.hash;
      let tabIndex = 0;
      if (hash && hash.startsWith('#tab-')) {
        tabIndex = parseInt(hash.replace('#tab-', ''), 10);
      }

      document.querySelectorAll('.nav-preserve-tab').forEach(function(link) {
        const url = new URL(link.href, window.location.origin);
        url.searchParams.set('tab', tabIndex);
        link.href = url.toString();
      });
    }

    updateNavLinks();
    window.addEventListener('hashchange', updateNavLinks);
  });
</script>
