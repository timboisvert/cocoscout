<div id="show-cast-members" data-controller="drag-cast-member" class="space-y-1">
    <%
      # Use preloaded data if available, otherwise fall back to queries
      pool_members = local_assigns[:pool_members] || @pool_members || show.production.effective_talent_pool.members.to_a
      assigned_member_keys = local_assigns[:assigned_member_keys] || @assigned_member_keys || Set.new
      availability ||= {}
      linked_availability = local_assigns[:linked_availability] || {}
      linked_shows = local_assigns[:linked_shows] || []
      has_visible_people = false
      talent_pool = show.production.effective_talent_pool
      is_linked = linked_shows.any?
      total_linked_shows = linked_shows.count
    %>

    <% if pool_members.any? %>
      <div class="space-y-1">
        <% pool_members.each do |member| %>
          <% is_person = member.is_a?(Person) %>
          <%
            # Use preloaded set for assignment check instead of DB query
            member_key = "#{member.class.name}_#{member.id}"
            has_show_person_role_assignment = assigned_member_keys.include?(member_key)
          %>
          <% availability_key = "#{member.class.name}_#{member.id}" %>
          <% member_availability = availability[availability_key] || availability[member.id] %>
          <% is_available = member_availability&.available? %>

          <%# Linked availability data %>
          <%
            linked_data = linked_availability[member_key] || { total: total_linked_shows, available: 0, shows: [] }
            linked_available_count = linked_data[:available]
            # Fully available = available for this show + all linked shows
            is_fully_available = is_available && linked_available_count == total_linked_shows
            # Partially available = available for this show OR some linked shows
            is_partially_available = is_available || linked_available_count > 0
          %>

          <%
            # Calculate total events (current show + linked shows)
            total_events = total_linked_shows + 1
            # Count how many events they're available for (current + linked)
            events_available_for = (is_available ? 1 : 0) + linked_available_count
          %>
          <%
            headshot_variant = member.safe_headshot_variant(:thumb)
            headshot_url = headshot_variant ? url_for(headshot_variant) : nil
          %>
          <div class="flex items-center gap-2 p-2 border border-gray-200 rounded-lg hover:border-gray-400 transition-all cursor-grab bg-white <%= 'opacity-50' if has_show_person_role_assignment %>"
              data-drag-cast-member-target="<%= is_person ? 'person' : 'group' %>"
              data-<%= is_person ? 'person' : 'group' %>-id="<%= member.id %>"
              data-person-name="<%= member.name %>"
              data-person-initials="<%= member.initials %>"
              data-person-headshot-url="<%= headshot_url %>"
              data-talent-pool-id="<%= talent_pool.id %>"
              data-availability-status="<%= member_availability&.status || 'unset' %>"
              data-is-available="<%= is_available ? 'true' : 'false' %>"
              data-is-fully-available="<%= is_fully_available ? 'true' : 'false' %>"
              data-is-partially-available="<%= is_partially_available ? 'true' : 'false' %>"
              data-linked-available-count="<%= linked_available_count %>"
              data-linked-total="<%= total_linked_shows %>"
              data-events-available-for="<%= events_available_for %>"
              data-total-events="<%= total_events %>"
              draggable="true">

              <% if headshot_variant %>
                  <%= image_tag headshot_variant, alt: member.name, class: "w-8 h-8 rounded-lg object-cover flex-shrink-0", draggable: false %>
              <% else %>
                  <div class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center text-black font-bold text-xs flex-shrink-0">
                      <%= member.initials %>
                  </div>
              <% end %>

              <div class="flex-1 min-w-0">
                <span class="font-medium text-sm block truncate"><%= member.name %></span>
                <% if is_linked %>
                  <span class="text-xs text-gray-400 block hidden" data-availability-text>
                    <% if is_fully_available %>
                      Available for all <%= total_events %> events
                    <% elsif is_partially_available %>
                      <%
                        # Get the dates they're available for (current show + linked shows)
                        available_dates = []
                        available_dates << show.date_and_time if is_available
                        linked_data[:shows].each do |show_data|
                          available_dates << show_data[:date_and_time] if show_data[:available] && show_data[:date_and_time]
                        end
                        available_dates = available_dates.compact.sort
                      %>
                      Available for <%= available_dates.map { |d| d.strftime("%-m/%-d") }.join(", ") %>
                    <% end %>
                  </span>
                <% end %>
              </div>
          </div>
          <% has_visible_people = true %>
        <% end %>
      </div>
    <% end %>

    <!-- Empty state message (shown by JavaScript when filtered list is empty) -->
    <div id="cast-members-empty-state" class="p-0 text-left text-gray-500 text-sm hidden">
        <p id="empty-state-message"></p>
    </div>
</div>