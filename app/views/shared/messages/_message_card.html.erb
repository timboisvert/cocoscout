<%#
  Unified Message Card Component

  Used for both feed lists and show pages with IDENTICAL styling.

  Required:
    message: The message to display

  Optional:
    context: :feed (default) or :show
      - :feed - Clickable card for lists, shows "X comments" link
      - :show - Non-clickable, shows Comment button + typing indicator
    hide_production_via: Hide the "via Production" link (default: false)
    production_context: Override the production to show (default: message.production)
%>

<%
  # Context determines feed list vs show page behavior
  context = local_assigns[:context] || :feed
  is_feed = context == :feed
  is_show = context == :show

  # Message metadata
  reply_count = message.descendant_ids.count
  sender_person = message.sender.is_a?(Person) ? message.sender : message.sender&.person
  recipient_count = message.recipient_count

  # Production context for "via" link
  show_production_via = !local_assigns[:hide_production_via]
  production_context = local_assigns[:production_context] || (show_production_via ? message.production : nil)

  # Unread status (feed only)
  subscription = is_feed && defined?(Current) && Current.user ? Current.user.message_subscriptions.find_by(message: message) : nil
  is_unread = subscription&.unread?

  # Determine correct paths based on controller context
  is_manage_context = controller.class.name.start_with?("Manage::")

  if is_manage_context
    message_path = manage_message_path(message)
    production_link = production_context ? production_manage_messages_path(production_context) : nil
  else
    message_path = my_message_path(message)
    production_link = production_context ? production_my_messages_path(production_context) : nil
  end

  # For feed cards on production pages, pass production ID to maintain context
  if is_feed && local_assigns[:hide_production_via] && message.production
    message_path = is_manage_context ?
      manage_message_path(message, from_production: message.production_id) :
      my_message_path(message, from_production: message.production_id)
  end

  # Show regardable (only Shows are shown as cards)
  show_regardable = message.show
%>

<div class="relative bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden <%= is_feed ? 'hover:bg-gray-50 transition-colors' : '' %> <%= is_unread ? 'ring-2 ring-pink-200' : '' %>" data-message-id="<%= message.id %>">
  <% if is_feed %>
    <%# Stretched link - covers entire card (feed only) %>
    <%= link_to message_path, class: "absolute inset-0 z-0", "aria-label": message.subject || "View message" do %><% end %>
  <% end %>

  <%# Header %>
  <div class="p-4 pb-3 bg-gray-50/80">
    <div class="flex items-start gap-3">
      <%# Avatar %>
      <% if sender_person %>
        <% headshot_variant = sender_person.safe_headshot_variant(:thumb) %>
        <% if headshot_variant %>
          <%= image_tag rails_storage_proxy_url(headshot_variant), alt: sender_person.name, class: "w-11 h-11 rounded-lg object-cover flex-shrink-0" %>
        <% else %>
          <div class="w-11 h-11 rounded-lg bg-gray-200 flex items-center justify-center text-gray-600 font-bold text-sm flex-shrink-0">
            <%= sender_person.initials %>
          </div>
        <% end %>
      <% else %>
        <div class="w-11 h-11 rounded-lg bg-pink-100 flex items-center justify-center flex-shrink-0">
          <svg class="w-6 h-6 text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
          </svg>
        </div>
      <% end %>

      <div class="flex-1 min-w-0">
        <div class="flex items-start justify-between gap-2">
          <div class="flex items-center gap-2 flex-wrap">
            <span class="font-semibold text-gray-900"><%= message.sender_name %></span>
            <% if production_context %>
              <span class="text-gray-500">via</span>
              <% if production_link %>
                <%= link_to production_context.name, production_link, class: "relative z-10 font-medium text-pink-600 hover:text-pink-700 hover:underline" %>
              <% else %>
                <span class="font-medium text-pink-600"><%= production_context.name %></span>
              <% end %>
            <% end %>
          </div>

          <%# Actions menu - show if user can delete or view read receipts %>
          <% can_delete = !message.deleted? && message.can_be_deleted_by?(Current.user) %>
          <% can_view_receipts = message.can_view_read_receipts_by?(Current.user) %>
          <% if can_delete || can_view_receipts %>
            <div class="relative z-10 flex-shrink-0" data-controller="dropdown modal">
              <button
                type="button"
                class="p-1 text-gray-400 hover:text-gray-600 rounded hover:bg-gray-100 transition-colors cursor-pointer"
                data-action="click->dropdown#toggle"
                title="More options">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"/>
                </svg>
              </button>
              <div
                data-dropdown-target="menu"
                class="hidden absolute right-0 top-full mt-1 w-40 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-50">
                <% if can_view_receipts %>
                  <button
                    type="button"
                    data-action="click->modal#open click->dropdown#close"
                    data-modal-id="read-receipts-modal-<%= message.id %>"
                    class="w-full flex items-center gap-2 px-3 py-2 text-sm text-gray-700 hover:bg-gray-50 transition-colors cursor-pointer">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                    </svg>
                    Read Receipts
                  </button>
                <% end %>
                <% if can_delete %>
                  <%= link_to message_path,
                      method: :delete,
                      data: { turbo_method: :delete, turbo_confirm: "Are you sure you want to delete this message?" },
                      class: "flex items-center gap-2 px-3 py-2 text-sm text-red-600 hover:bg-red-50 transition-colors cursor-pointer" do %>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                    Delete
                  <% end %>
                <% end %>
              </div>
            </div>
          <% end %>

          <%# Read Receipts Modal - rendered outside dropdown for proper z-index %>
          <% if can_view_receipts %>
            <%= render "shared/messages/read_receipts_modal", message: message %>
          <% end %>
        </div>
        <div class="flex items-center gap-2 text-sm text-gray-500 mt-1">
          <span><%= message.created_at.strftime("%B %-d, %Y at %-I:%M %p") %></span>
          <% if message.message_type == "production_contact" && message.production.present? %>
            <%# Show "Sent to Production Team" for production contact messages %>
            <span>·</span>
            <span>Sent to <span class="font-medium text-pink-600"><%= message.production.name %></span> production team</span>
          <% elsif recipient_count == 1 %>
            <%# Single recipient - show their name and headshot %>
            <% recipient = message.recipient_people.first %>
            <% if recipient %>
              <span>·</span>
              <span>To</span>
              <% headshot_variant = recipient.safe_headshot_variant(:thumb) %>
              <span data-controller="tooltip" data-tooltip-text-value="<%= recipient.name %>" class="relative">
                <% if headshot_variant %>
                  <%= image_tag rails_storage_proxy_url(headshot_variant),
                      alt: recipient.name,
                      class: "w-6 h-6 rounded-lg object-cover ring-2 ring-white" %>
                <% else %>
                  <div class="w-6 h-6 rounded-lg bg-gray-200 flex items-center justify-center text-gray-600 font-bold text-[10px] ring-2 ring-white">
                    <%= recipient.initials %>
                  </div>
                <% end %>
              </span>
              <span class="font-medium text-gray-700"><%= recipient.name %></span>
            <% end %>
          <% elsif recipient_count > 1 %>
            <span>·</span>
            <span>Sent to <%= recipient_count %> people</span>
            <%# Stacked recipient headshots %>
            <div class="flex items-center -space-x-1.5 ml-1">
              <% message.recipient_people.limit(6).each do |person| %>
                <% headshot_variant = person.safe_headshot_variant(:thumb) %>
                <span data-controller="tooltip" data-tooltip-text-value="<%= person.name %>" class="relative">
                  <% if headshot_variant %>
                    <%= image_tag rails_storage_proxy_url(headshot_variant),
                        alt: person.name,
                        class: "w-6 h-6 rounded-lg object-cover ring-2 ring-white relative z-10 hover:z-20 hover:scale-110 transition-transform cursor-default" %>
                  <% else %>
                    <div class="w-6 h-6 rounded-lg bg-gray-200 flex items-center justify-center text-gray-600 font-bold text-[10px] ring-2 ring-white relative z-10 hover:z-20 hover:scale-110 transition-transform cursor-default">
                      <%= person.initials %>
                    </div>
                  <% end %>
                </span>
              <% end %>
              <% if recipient_count > 6 %>
                <span data-controller="tooltip" data-tooltip-text-value="<%= recipient_count - 6 %> more" class="relative">
                  <div class="w-6 h-6 rounded-lg bg-pink-100 flex items-center justify-center text-pink-600 font-bold text-[10px] ring-2 ring-white relative z-10">
                    +<%= recipient_count - 6 %>
                  </div>
                </span>
              <% end %>
            </div>
          <% end %>
          <% if is_unread %>
            <span class="w-2 h-2 bg-pink-500 rounded-full"></span>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <%# Subject %>
  <% if message.subject.present? %>
    <div class="px-4 pt-4 pb-2">
      <h2 class="text-lg font-bold text-gray-900"><%= message.subject %></h2>
    </div>
  <% end %>

  <%# Body %>
  <div class="px-4 pb-3">
    <div class="prose prose-sm max-w-none text-gray-800">
      <%= message.body %>
    </div>
  </div>

  <%# Images %>
  <% if message.images.attached? %>
    <%= render "shared/messages/image_gallery", message: message, style: :lightbox %>
  <% end %>

  <%# Regarding Card (Show only) %>
  <% if show_regardable.present? %>
    <div class="px-4 pb-3">
      <%= render "shared/messages/regarding_card", regardable: show_regardable %>
    </div>
  <% end %>

  <%# Action Bar %>
  <div class="px-4 py-2.5 border-t border-gray-100 bg-gray-50/80">
    <div class="flex items-center justify-between relative z-10">
      <%# Left: Reactions %>
      <%= render "shared/messages/reactions", message: message %>

      <%# Right: Comments/Reply info %>
      <div class="flex items-center gap-3">
        <% if is_show %>
          <%# Show context: typing indicator + Comment button %>
          <% if reply_count > 0 %>
            <span class="text-sm text-pink-600 font-medium"><%= reply_count %> <%= reply_count == 1 ? 'reply' : 'replies' %></span>
          <% end %>
          <span data-message-thread-target="typingIndicator" class="text-sm text-gray-500 italic hidden"></span>
          <button
            type="button"
            class="text-sm font-medium text-gray-500 hover:text-pink-600 transition-colors cursor-pointer"
            data-action="click->message-thread#showCommentForm">
            Comment
          </button>
        <% else %>
          <%# Feed context: Reply count as link %>
          <% if reply_count > 0 %>
            <%= link_to message_path, class: "text-sm text-pink-600 hover:text-pink-700 font-medium cursor-pointer" do %>
              <%= reply_count %> <%= reply_count == 1 ? 'comment' : 'comments' %>
            <% end %>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
</div>
