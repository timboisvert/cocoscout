<% content_for :title, "Home" %>

<div class="w-full mb-10">
  <%= render partial: "shared/notice", locals: { notice: notice } %>

  <% if @pending_ticketing_events&.any? %>
    <%= link_to manage_ticketing_pending_events_path, class: "block mb-6 no-underline" do %>
      <div class="bg-pink-50 border border-pink-200 rounded-lg px-4 py-3 flex items-center justify-between hover:bg-pink-100 transition-colors">
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 rounded-full bg-pink-100 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 text-pink-600">
              <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 6v.75m0 3v.75m0 3v.75m0 3V18m-9-5.25h5.25M7.5 15h3M3.375 5.25c-.621 0-1.125.504-1.125 1.125v3.026a2.999 2.999 0 0 1 0 5.198v3.026c0 .621.504 1.125 1.125 1.125h17.25c.621 0 1.125-.504 1.125-1.125v-3.026a2.999 2.999 0 0 1 0-5.198V6.375c0-.621-.504-1.125-1.125-1.125H3.375Z" />
            </svg>
          </div>
          <span class="text-sm font-medium text-pink-900">
            <%= pluralize(@pending_ticketing_events.size, "ticketing event") %> needs to be linked to a production
          </span>
        </div>
        <svg class="w-5 h-5 text-pink-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </div>
    <% end %>
  <% end %>

  <% if @production_dashboards.any? %>
    <%
      # Aggregate data from all productions
      all_open_calls = []
      all_sign_up_forms = []
      all_open_vacancies = []
      all_upcoming_shows = []

      @productions.each do |production|
        dashboard = @production_dashboards[production.id]
        next unless dashboard

        dashboard[:open_calls][:with_auditionees].each do |call_data|
          all_open_calls << call_data.merge(production: production)
        end

        dashboard[:sign_up_forms].each do |form_data|
          all_sign_up_forms << form_data.merge(production: production)
        end

        dashboard[:open_vacancies].each do |vacancy_data|
          all_open_vacancies << vacancy_data.merge(production: production)
        end

        dashboard[:upcoming_shows].each do |show_data|
          all_upcoming_shows << show_data.merge(production: production)
        end
      end

      # Sort upcoming shows by date
      all_upcoming_shows.sort_by! { |s| s[:show].date_and_time }
    %>

    <!-- Audition Cycles -->
    <div class="border border-gray-200 rounded-lg overflow-hidden mb-8">
      <%= render "shared/card_header", title: "Audition Cycles", links: [
        { text: "All Auditions", path: manage_signups_all_auditions_path }
      ] %>
      <div class="p-4">
        <% if all_open_calls.any? %>
        <div class="space-y-1">
            <% all_open_calls.each do |call_data| %>
              <% cycle = call_data[:call] %>
              <% production = call_data[:production] %>
              <%
                if cycle.opens_at > Time.current
                  status_text = "Opening Soon"
                  status_color = "text-yellow-600"
                elsif cycle.closes_at.present? && cycle.closes_at <= Time.current
                  status_text = "Closed"
                  status_color = "text-gray-500"
                else
                  status_text = "Open"
                  status_color = "text-green-600"
                end
              %>
              <%= link_to manage_signups_auditions_path(production), class: "block no-underline" do %>
                <div class="px-3 py-2 border border-gray-200 rounded-lg hover:border-gray-400 transition-all bg-white">
                  <div class="flex flex-col sm:flex-row sm:items-stretch gap-2 sm:gap-0">
                    <%# Left Third: Production + Audition Type %>
                    <div class="sm:w-1/3 flex items-center gap-3">
                      <% logo_variant = production.safe_logo_variant(:small) %>
                      <% if logo_variant %>
                        <div class="flex-shrink-0 w-10 h-6 rounded flex items-center justify-center overflow-hidden">
                          <%= image_tag logo_variant, alt: production.name, class: "w-full h-full object-cover rounded" %>
                        </div>
                      <% else %>
                        <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-pink-100 flex items-center justify-center">
                          <span class="text-sm font-bold text-pink-600"><%= production.initials %></span>
                        </div>
                      <% end %>
                      <div class="flex-1 min-w-0">
                        <div class="font-medium text-gray-900 truncate"><%= production.name %></div>
                        <div class="text-sm text-gray-500">
                          <% formats = [] %>
                          <% formats << "Video" if cycle.accepts_video_submissions? %>
                          <% formats << "In-Person" if cycle.accepts_in_person_auditions? %>
                          <%= formats.join(" + ") %> Auditions
                        </div>
                      </div>
                    </div>

                    <%# Middle Third: Dates & Status %>
                    <div class="sm:w-1/3 border-t sm:border-t-0 sm:border-l border-gray-200 pt-2 sm:pt-0 sm:pl-4 flex flex-col justify-center">
                      <div class="text-sm text-gray-600">
                        <%= cycle.opens_at.strftime("%b %-d") %><% if cycle.closes_at.present? %> - <%= cycle.closes_at.strftime("%b %-d, %Y") %><% else %> (open-ended)<% end %>
                      </div>
                      <div class="text-sm <%= status_color %>"><%= status_text %></div>
                    </div>

                    <%# Right Third: Open Sign-ups count %>
                    <div class="sm:w-1/3 border-t sm:border-t-0 sm:border-l border-gray-200 pt-2 sm:pt-0 sm:pl-4 flex items-center sm:self-stretch justify-between">
                      <div class="flex-1">
                        <div class="text-xs text-gray-400 uppercase tracking-wide">Open Sign-ups</div>
                        <div class="text-base">
                          <span class="text-gray-900 font-medium tabular-nums"><%= call_data[:auditionee_count] %></span>
                        </div>
                      </div>
                      <svg class="w-5 h-5 text-gray-400 hidden sm:block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                      </svg>
                    </div>
                  </div>
                </div>
              <% end %>
            <% end %>
        </div>
        <% else %>
        <p class="text-sm text-gray-500">No open audition cycles.</p>
        <% end %>
      </div>
    </div>

    <!-- Sign-Up Forms -->
    <div class="border border-gray-200 rounded-lg overflow-hidden mb-8">
      <%= render "shared/card_header", title: "Sign-Up Forms", links: [
        { text: "All Sign-Ups", path: manage_signups_path }
      ] %>
      <div class="p-4">
        <% if all_sign_up_forms.any? %>
          <div class="space-y-1">
            <% all_sign_up_forms.each do |form_data| %>
              <% form = form_data[:form] %>
              <% instance = form_data[:instance] %>
              <% form_status = form_data[:form_status] %>
              <% production = form_data[:production] %>
              <%= link_to manage_signups_form_path(production, form), class: "block px-4 py-3 border border-gray-200 rounded-lg hover:border-gray-400 bg-white transition-all no-underline" do %>
                <div class="flex flex-col md:flex-row md:items-center gap-2 md:gap-0 w-full">
                  <%# Left third: Production + Form Name %>
                  <div class="w-full md:w-1/3 flex items-center gap-3">
                    <% logo_variant = production.safe_logo_variant(:small) %>
                    <% if logo_variant %>
                      <div class="flex-shrink-0 w-10 h-6 rounded flex items-center justify-center overflow-hidden">
                        <%= image_tag logo_variant, alt: production.name, class: "w-full h-full object-cover rounded" %>
                      </div>
                    <% else %>
                      <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-pink-100 flex items-center justify-center">
                        <span class="text-sm font-bold text-pink-600"><%= production.initials %></span>
                      </div>
                    <% end %>
                    <div class="flex-1 min-w-0">
                      <h3 class="text-base font-medium text-gray-900 truncate"><%= form.name %></h3>
                      <div class="text-sm text-gray-500 truncate"><%= production.name %></div>
                    </div>
                  </div>

                  <%# Middle third: Status %>
                  <div class="w-full md:w-1/3 md:border-l border-gray-200 md:pl-4 flex flex-col justify-center md:self-stretch border-t md:border-t-0 mt-2 md:mt-0 pt-2 md:pt-0">
                    <div class="flex items-center">
                      <% if form_status[:accepting_registrations] %>
                        <span class="inline-flex items-center gap-2 rounded-full px-2.5 py-1 text-sm font-medium bg-green-100 text-green-700">
                          <span class="relative flex h-2.5 w-2.5">
                            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-green-500"></span>
                          </span>
                          <%= form_status[:label] %>
                        </span>
                      <% elsif !form.active? %>
                        <span class="inline-flex items-center rounded-full px-2.5 py-1 text-sm font-medium bg-gray-100 text-gray-600">
                          Off
                        </span>
                      <% elsif form_status[:state] == :scheduled %>
                        <span class="inline-flex items-center rounded-full px-2.5 py-1 text-sm font-medium bg-amber-100 text-amber-700">
                          <%= form_status[:label] %>
                        </span>
                      <% else %>
                        <span class="inline-flex items-center rounded-full px-2.5 py-1 text-sm font-medium bg-gray-100 text-gray-600">
                          <%= form_status[:label] %>
                        </span>
                      <% end %>
                    </div>
                  </div>

                  <%# Right third: Registrations %>
                  <div class="w-full md:w-1/3 md:border-l border-gray-200 md:pl-4 flex items-center md:self-stretch justify-between border-t md:border-t-0 mt-2 md:mt-0 pt-2 md:pt-0">
                    <div class="flex-1">
                      <% if form_status[:accepting_registrations] || form_status[:state] == :full %>
                        <div class="text-xs text-gray-400 uppercase tracking-wide">Registrations</div>
                        <div class="text-base">
                          <span class="text-gray-900 font-medium tabular-nums"><%= form_status[:total_registrations] || 0 %></span>
                          <% if (form_status[:total_capacity] || 0) < 1000 %>
                            <span class="text-gray-400">/</span>
                            <span class="text-gray-500 tabular-nums"><%= form_status[:total_capacity] || 0 %> slots</span>
                          <% end %>
                        </div>
                      <% else %>
                        <div class="text-sm text-gray-500">&nbsp;</div>
                      <% end %>
                    </div>
                    <svg class="w-5 h-5 text-gray-400 hidden sm:block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                  </div>
                </div>
              <% end %>
            <% end %>
          </div>
        <% else %>
          <p class="text-sm text-gray-500">No active sign-up forms.</p>
        <% end %>
      </div>
    </div>

    <!-- Open Vacancies -->
    <% if all_open_vacancies.any? %>
      <div class="border border-pink-200 rounded-lg overflow-hidden mb-8 bg-pink-50">
        <%= render "shared/card_header",
          title: "Open Vacancies",
          bg_class: "bg-pink-100",
          border_class: "border-pink-200",
          title_class: "text-pink-900",
          icon: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" /></svg>' %>
        <div class="p-4 space-y-1">
          <% all_open_vacancies.each do |vacancy_data| %>
            <% vacancy = vacancy_data[:vacancy] %>
            <% show = vacancy_data[:show] %>
            <% production = vacancy_data[:production] %>
            <% vacated_by = vacancy.vacated_by %>
            <% is_linked = vacancy_data[:is_linked] %>
            <% affected_shows = is_linked ? vacancy_data[:affected_shows] : [show] %>
            <div class="group flex flex-col sm:flex-row sm:items-stretch bg-white border border-pink-200 rounded-lg hover:border-pink-400 transition-colors overflow-hidden">
              <%# Left third: Production + Show dates %>
              <div class="sm:w-1/3 px-3 py-2">
                <div class="flex items-center gap-3 mb-2">
                  <% logo_variant = production.safe_logo_variant(:small) %>
                  <% if logo_variant %>
                    <div class="flex-shrink-0 w-8 h-5 rounded flex items-center justify-center overflow-hidden">
                      <%= image_tag logo_variant, alt: production.name, class: "w-full h-full object-cover rounded" %>
                    </div>
                  <% else %>
                    <div class="flex-shrink-0 w-8 h-8 rounded bg-pink-100 flex items-center justify-center">
                      <span class="text-xs font-bold text-pink-600"><%= production.initials %></span>
                    </div>
                  <% end %>
                  <span class="font-medium text-gray-900 text-sm truncate"><%= production.name %></span>
                </div>
                <div class="text-sm text-gray-600">
                  <%= show.date_and_time.strftime("%b %-d, %l:%M %p").strip %>
                  <% if affected_shows.size > 1 %>
                    <span class="text-gray-400">+ <%= affected_shows.size - 1 %> more</span>
                  <% end %>
                </div>
              </div>

              <%# Middle third: Show details %>
              <div class="sm:w-1/3 border-t sm:border-t-0 sm:border-l border-pink-200 px-3 py-2 flex flex-col justify-center">
                <div class="font-medium text-gray-900">
                  <%= show.display_name %>
                </div>
                <% if show.is_online %>
                  <div class="text-sm text-gray-600">Online</div>
                <% elsif show.location.present? %>
                  <div class="text-sm text-gray-600"><%= show.location.name %></div>
                <% end %>
              </div>

              <%# Right third: Vacated by entity with role %>
              <div class="sm:w-1/3 border-t sm:border-t-0 sm:border-l border-pink-200 px-3 py-2 flex items-center gap-3">
                <% if vacated_by %>
                  <% headshot_variant = vacated_by.safe_headshot_variant(:thumb) %>
                  <% if headshot_variant %>
                    <%= image_tag headshot_variant, class: "w-10 h-10 rounded-lg object-cover flex-shrink-0" %>
                  <% else %>
                    <div class="w-10 h-10 rounded-lg bg-gray-200 flex items-center justify-center text-gray-700 font-bold text-sm flex-shrink-0">
                      <%= vacated_by.initials %>
                    </div>
                  <% end %>
                <% end %>
                <div class="flex-1 min-w-0">
                  <div class="text-[10px] text-gray-400 uppercase tracking-wide">Can't make it</div>
                  <div class="text-sm flex items-center gap-1">
                    <span class="font-medium text-gray-900"><%= vacated_by&.name %></span>
                    <span class="text-gray-400">as</span>
                    <strong class="text-pink-500"><%= vacancy_data[:role].name %></strong>
                  </div>
                </div>
                <div class="flex-shrink-0 hidden group-hover:block">
                  <%= render "shared/button", text: "Review", path: manage_casting_vacancy_path(production, vacancy), variant: "primary", size: "small" %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- Upcoming Shows & Events -->
    <div class="border border-gray-200 rounded-lg overflow-hidden mb-8">
      <%= render "shared/card_header", title: "Upcoming Shows & Events (Next 45 Days)", links: [
        { text: "All Shows", path: manage_shows_path }
      ] %>
      <div class="p-4">
        <% if all_upcoming_shows.any? %>
        <div class="space-y-1">
          <% all_upcoming_shows.first(10).each do |show_data| %>
            <% show = show_data[:show] %>
            <% production = show_data[:production] %>
              <%= link_to manage_show_path(production, show), class: "block no-underline" do %>
                <div class="px-3 py-2 border border-gray-200 rounded-lg hover:border-gray-400 transition-all bg-white">
                  <div class="flex flex-col sm:flex-row sm:items-stretch gap-3 sm:gap-4">
                    <%# Left Third: Date & Show Details (matching shared/show_row) %>
                    <div class="flex-1 flex items-center gap-4">
                      <%# Date Box %>
                      <div class="flex-shrink-0 w-14 text-center">
                        <div class="text-xs font-semibold text-pink-600 uppercase"><%= show.date_and_time.strftime("%b") %></div>
                        <div class="text-2xl font-bold text-gray-900"><%= show.date_and_time.strftime("%-d") %></div>
                        <div class="text-xs text-gray-500"><%= show.date_and_time.strftime("%a") %></div>
                      </div>

                      <%# Show Details %>
                      <div class="flex-1 min-w-0">
                        <% if production.type_third_party? && production.contract&.contractor_name.present? %>
                          <div class="text-xs text-gray-400 mb-0"><%= production.contract.contractor_name %></div>
                        <% else %>
                          <div class="text-xs text-gray-400 mb-0"><%= production.name %></div>
                        <% end %>
                        <div class="flex items-center gap-2 flex-wrap">
                          <span class="font-medium text-gray-900"><%= show.display_name %></span>
                          <% if show.recurring? %>
                            <span data-controller="tooltip" data-tooltip-text="This is a recurring event">
                              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="text-pink-500 size-4">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
                              </svg>
                            </span>
                          <% end %>
                          <% if show.linked? %>
                            <%
                              other_shows = show.event_linkage.shows.where.not(id: show.id).order(:date_and_time)
                              linked_tooltip = "Linked with: " + other_shows.map { |s| "#{s.date_and_time.strftime('%b %-d')} #{s.display_name}" }.join(", ")
                            %>
                            <span data-controller="tooltip" data-tooltip-text="<%= linked_tooltip %>">
                              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="text-pink-500 size-4">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.757-1.757m13.35-.622 1.757-1.757a4.5 4.5 0 0 0-6.364-6.364l-4.5 4.5a4.5 4.5 0 0 0 1.242 7.244" />
                              </svg>
                            </span>
                          <% end %>
                        </div>
                        <div class="text-sm text-gray-600">
                          <%= show.date_and_time.strftime("%l:%M %p").strip %>
                          <% if show.is_online %>
                            · Online
                          <% elsif show.location.present? %>
                            · <%= show.location.name %>
                          <% end %>
                        </div>
                      </div>
                    </div>

                    <% if production.type_third_party? %>
                      <%# For third-party productions, show rental info instead of availability/casting %>
                      <div class="flex-1 border-t sm:border-t-0 sm:border-l border-gray-200 pt-3 sm:pt-0 sm:pl-4 flex flex-col justify-center">
                        <div class="text-xs font-semibold text-gray-700 mb-1">Type</div>
                        <div class="text-xs text-gray-600">Third-party rental</div>
                      </div>
                      <div class="flex-1 border-t sm:border-t-0 sm:border-l border-gray-200 pt-3 sm:pt-0 sm:pl-4 flex flex-col justify-center">
                        <% if production.contract.present? %>
                          <div class="text-xs font-semibold text-gray-700 mb-1">Contract</div>
                          <div class="text-xs text-gray-600"><%= production.contract.status.titleize %></div>
                        <% end %>
                      </div>
                    <% else %>
                      <%# Middle Third: Availability %>
                      <div class="flex-1 border-t sm:border-t-0 sm:border-l border-gray-200 pt-3 sm:pt-0 sm:pl-4 flex flex-col justify-center">
                        <% if show_data[:roles_count] > 0 %>
                          <div class="text-xs font-semibold text-gray-700 mb-1">Availability</div>
                          <% if show_data[:total_cast_count] > 0 %>
                            <% all_submitted = show_data[:availability_count] == show_data[:total_cast_count] %>
                            <div class="h-1.5 bg-gray-200 rounded-full overflow-hidden mb-1">
                              <div class="h-full rounded-full <%= all_submitted ? 'bg-green-500' : 'bg-pink-500' %>" style="width: <%= show_data[:availability_percentage] %>%"></div>
                            </div>
                            <div class="text-xs <%= all_submitted ? 'text-green-600' : 'text-gray-500' %>">
                              <%= show_data[:availability_count] %>/<%= show_data[:total_cast_count] %>
                            </div>
                          <% else %>
                            <div class="text-xs text-gray-500">No cast yet</div>
                          <% end %>
                        <% else %>
                          <div class="text-xs font-semibold text-gray-700 mb-1">Availability</div>
                          <div class="text-xs text-gray-500">No roles defined</div>
                        <% end %>
                      </div>

                      <%# Right Third: Casting %>
                      <div class="flex-1 border-t sm:border-t-0 sm:border-l border-gray-200 pt-3 sm:pt-0 sm:pl-4 flex flex-col justify-center">
                        <div class="text-xs font-semibold text-gray-700 mb-1">Casting</div>
                        <% if show_data[:roles_count] > 0 %>
                          <% fully_cast = show_data[:cast_percentage] == 100 %>
                          <div class="h-1.5 bg-gray-200 rounded-full overflow-hidden mb-1">
                            <div class="h-full rounded-full <%= fully_cast ? 'bg-green-500' : 'bg-pink-500' %>" style="width: <%= show_data[:cast_percentage] %>%"></div>
                          </div>
                          <div class="text-xs <%= fully_cast ? 'text-green-600' : 'text-gray-500' %>">
                            <% if fully_cast %>
                              Fully cast
                            <% else %>
                              <%= show_data[:cast_count] %>/<%= show_data[:roles_count] %> roles
                            <% end %>
                          </div>
                        <% else %>
                          <%= link_to "No roles defined", manage_casting_roles_path, class: "text-xs text-pink-500 hover:text-pink-600" %>
                        <% end %>
                      </div>
                    <% end %>
                  </div>
                </div>
              <% end %>
            <% end %>
            <% if all_upcoming_shows.size > 10 %>
              <div class="text-center pt-2">
                <%= link_to "View all #{all_upcoming_shows.size} upcoming events →", manage_shows_path, class: "text-sm text-pink-600 hover:text-pink-700" %>
              </div>
            <% end %>
          </div>
        <% else %>
        <p class="text-sm text-gray-500">No upcoming shows or events in the next 45 days.</p>
        <% end %>
      </div>
    </div>

  <% else %>
    <div class="bg-gray-50 rounded-lg border border-dashed border-gray-300 p-8 text-center mt-6">
      <p class="text-gray-600">No productions to display.</p>
    </div>
  <% end %>
</div>
