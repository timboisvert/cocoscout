<% content_for :title, "Ticketing Providers" %>

<%= render partial: "shared/top_menu", locals: {
  breadcrumbs: [
    ["Ticketing", manage_ticketing_index_path]
  ],
  text: "Providers",
  links: [
    { text: "Add Provider", path: manage_new_ticketing_provider_path }
  ]
} %>

<div class="w-full">
  <%= render partial: "shared/notice", locals: { notice: notice, alert: alert } %>

  <% if @providers.any? %>
    <div class="space-y-2">
      <% @providers.each do |provider| %>
        <%
          # Status based on connection health, not sync recency
          is_connected = provider.credentials_healthy? && !provider.rate_limited?
          has_error = !provider.credentials_valid? && provider.credentials_error.present?
          needs_setup = !provider.configured?
        %>
        <div class="bg-white rounded-lg border border-gray-200 hover:border-gray-300 transition-all">
          <%= link_to manage_ticketing_provider_path(provider), class: "block" do %>
            <div class="flex flex-col lg:flex-row lg:items-stretch">
              <%# Panel 1: Provider Info %>
              <div class="flex-1 flex items-center gap-4 px-4 py-3 rounded-t-lg lg:rounded-l-lg lg:rounded-tr-none">
                <div class="flex-1 min-w-0">
                  <div class="font-medium text-gray-900"><%= provider.name %></div>
                  <div class="text-sm text-gray-500"><%= provider.provider_type.titleize.gsub("_", " ") %></div>
                </div>
              </div>

              <%# Panel 2: Connection Status %>
              <div class="w-full lg:w-1/4 px-4 py-3 border-t lg:border-t-0 lg:border-l border-gray-200 flex flex-col justify-center">
                <div class="text-[10px] text-gray-400 uppercase tracking-wide mb-1">Connection</div>
                <% if is_connected %>
                  <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-green-500"></span>
                    <span class="text-sm font-medium text-green-600">Connected</span>
                  </div>
                <% elsif has_error %>
                  <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-red-500"></span>
                    <span class="text-sm font-medium text-red-600">Error</span>
                  </div>
                <% elsif provider.rate_limited? %>
                  <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-amber-500"></span>
                    <span class="text-sm font-medium text-amber-600">Rate Limited</span>
                  </div>
                <% elsif needs_setup %>
                  <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-amber-500"></span>
                    <span class="text-sm font-medium text-amber-600">Setup Required</span>
                  </div>
                <% else %>
                  <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-gray-400"></span>
                    <span class="text-sm font-medium text-gray-500">Not Verified</span>
                  </div>
                <% end %>
              </div>

              <%# Panel 3: Last Verified %>
              <div class="w-full lg:w-1/4 px-4 py-3 border-t lg:border-t-0 lg:border-l border-gray-200 flex flex-col justify-center">
                <div class="text-[10px] text-gray-400 uppercase tracking-wide mb-1">Verified</div>
                <% if provider.credentials_checked_at %>
                  <div class="text-sm font-medium text-gray-900"><%= time_ago_in_words(provider.credentials_checked_at) %> ago</div>
                <% else %>
                  <div class="text-sm text-gray-400">Never</div>
                <% end %>
              </div>

              <%# Panel 4: Arrow indicator %>
              <div class="hidden lg:flex w-12 items-center justify-center border-l border-gray-200">
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  <% else %>
    <div class="bg-gray-50 rounded-lg border border-dashed border-gray-300 p-8 text-center">
      <p class="text-gray-600 mb-4">No ticketing providers configured yet.</p>
      <%= link_to manage_new_ticketing_provider_path do %>
        <%= render "shared/button", text: "Add Provider", variant: "primary", size: "medium" %>
      <% end %>
    </div>
  <% end %>
</div>
