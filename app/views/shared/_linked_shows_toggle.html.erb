<%#
  Linked Shows Display - Toggle with Expansion
  
  Single row for a group of linked events with cast assignment right panel.
  Expandable to see all events.
  
  Required params:
    - event_linkage: EventLinkage object
    - entity_assignments: Array of {entity:, role_assignments:} for the primary show
  
  Optional params:
    - show_production: Show production name (default: false)
    - show_location: Show location (default: true)
    - link_path: Path for clicking on the row (default: nil)
    - has_groups: Whether user has groups (default: false)
    - show_cant_make_it: Show "Can't make it" link (default: false)
    - cant_make_it_person: Person for vacancy token (default: nil)
%>

<%
  show_production = local_assigns.fetch(:show_production, false)
  show_location = local_assigns.fetch(:show_location, true)
  has_groups = local_assigns.fetch(:has_groups, false)
  show_cant_make_it = local_assigns.fetch(:show_cant_make_it, false)
  cant_make_it_person = local_assigns.fetch(:cant_make_it_person, nil)
  
  # Get all shows sorted by date
  all_shows = event_linkage.shows.respond_to?(:order) ? event_linkage.shows.order(:date_and_time).to_a : event_linkage.shows.sort_by(&:date_and_time)
  
  # Use resolved_primary_show (explicitly set primary, or first by date as fallback)
  primary_show = event_linkage.resolved_primary_show
  last_show = all_shows.last
  
  # Determine if we span multiple months
  spans_months = primary_show && last_show && primary_show.date_and_time.month != last_show.date_and_time.month
  
  # Primary show name (secondary_name or event type as fallback)
  primary_name = primary_show&.secondary_name.presence || primary_show&.event_type&.titleize
  
  # Location from primary show
  location_name = primary_show&.location&.name
  
  # Determine link path
  row_link_path = local_assigns[:link_path]
  
  has_right_panel = entity_assignments.present? && entity_assignments.any?
%>

<div class="border border-gray-200 rounded-lg overflow-hidden hover:border-gray-400 transition-all bg-white group">
  
  <% row_content = capture do %>
    <%# Left Section: Date Box(es) + Event Info %>
    <div class="<%= has_right_panel ? 'w-1/2' : 'flex-1' %> flex items-center gap-4">
      <%# Date Box(es) - show_row style %>
      <% if spans_months %>
        <%# Two date boxes for different months %>
        <div class="flex items-center gap-1">
          <div class="flex-shrink-0 w-12 text-center">
            <div class="text-xs font-semibold text-pink-600 uppercase"><%= primary_show.date_and_time.strftime("%b") %></div>
            <div class="text-xl font-bold text-gray-900"><%= primary_show.date_and_time.strftime("%-d") %></div>
          </div>
          <span class="text-gray-400 text-sm">–</span>
          <div class="flex-shrink-0 w-12 text-center">
            <div class="text-xs font-semibold text-pink-600 uppercase"><%= last_show.date_and_time.strftime("%b") %></div>
            <div class="text-xl font-bold text-gray-900"><%= last_show.date_and_time.strftime("%-d") %></div>
          </div>
        </div>
      <% elsif primary_show.date_and_time.to_date == last_show.date_and_time.to_date %>
        <%# Single day - one date box %>
        <div class="flex-shrink-0 w-14 text-center">
          <div class="text-xs font-semibold text-pink-600 uppercase"><%= primary_show.date_and_time.strftime("%b") %></div>
          <div class="text-2xl font-bold text-gray-900"><%= primary_show.date_and_time.strftime("%-d") %></div>
          <div class="text-xs text-gray-500"><%= primary_show.date_and_time.strftime("%a") %></div>
        </div>
      <% else %>
        <%# Same month, different days - combined date box %>
        <div class="flex-shrink-0 w-14 text-center">
          <div class="text-xs font-semibold text-pink-600 uppercase"><%= primary_show.date_and_time.strftime("%b") %></div>
          <div class="text-xl font-bold text-gray-900"><%= primary_show.date_and_time.strftime("%-d") %>-<%= last_show.date_and_time.strftime("%-d") %></div>
        </div>
      <% end %>
      
      <%# Event Info - styled like show_row %>
      <div class="flex-1 min-w-0">
        <div class="flex items-center gap-2 flex-wrap">
          <svg class="w-4 h-4 text-pink-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
          </svg>
          <span class="font-medium text-gray-900"><%= primary_name %></span>
          <% if show_production && primary_show&.respond_to?(:production) && primary_show&.production %>
            <span class="text-sm text-gray-600"><%= primary_show.production.name %></span>
          <% end %>
        </div>
        <div class="text-sm text-gray-600">
          <%= all_shows.count %> linked events
          <% if show_location && location_name.present? %>
            · <%= location_name %>
          <% end %>
        </div>
      </div>
    </div>

    <% if has_right_panel %>
      <%# Right Section: Cast Assignments - stacked panels for multiple entities %>
      <div class="w-1/2 flex flex-col">
        <% entity_assignments.each do |ea| %>
          <% entity = ea[:entity] %>
          <% role_assigns = ea[:role_assignments] %>
          <div class="flex-1 border-l border-gray-200 pl-4 py-2 flex items-center gap-3">
            <% headshot_variant = entity.safe_headshot_variant(:thumb) %>
            <% if headshot_variant %>
              <%= image_tag headshot_variant, class: "w-10 h-10 rounded-lg object-cover flex-shrink-0" %>
            <% else %>
              <div class="w-10 h-10 rounded-lg bg-gray-200 flex items-center justify-center text-gray-700 font-bold text-sm flex-shrink-0">
                <%= entity.respond_to?(:initials) ? entity.initials : entity.name[0..1].upcase %>
              </div>
            <% end %>
            <div class="flex-1 min-w-0">
              <div class="text-[10px] text-gray-400 uppercase tracking-wide">Cast assignment</div>
              <% role_assigns.each do |ra| %>
                <div class="text-sm flex items-center gap-1">
                  <span class="text-gray-700"><%= ra[:entity_name] %></span>
                  <span class="text-gray-400">as</span>
                  <strong class="text-pink-500"><%= ra[:role_name] %></strong>
                  <% if show_cant_make_it && cant_make_it_person.present? && primary_show.date_and_time > Time.current %>
                    <span class="text-xs text-pink-500 underline cursor-pointer whitespace-nowrap hidden group-hover:inline"
                          onclick="event.stopPropagation(); event.preventDefault(); window.location.href='<%= vacancy_link_for(cant_make_it_person, primary_show) %>';">
                      Can't make it?
                    </span>
                  <% end %>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>
  <% end %>

  <% if row_link_path %>
    <%= link_to row_link_path, class: "flex items-stretch px-3 py-2" do %>
      <%= row_content %>
    <% end %>
  <% else %>
    <div class="flex items-stretch px-3 py-2">
      <%= row_content %>
    </div>
  <% end %>
  
  <%# Expandable Details - all events in date order %>
  <div data-controller="accordion" data-accordion-expanded-value="false">
    <button type="button" 
            data-action="accordion#toggle"
            class="w-full flex items-center justify-center gap-1 py-1.5 bg-gray-50 border-t border-gray-100 text-xs text-gray-500 hover:bg-gray-100 transition cursor-pointer">
      <span>View all <%= all_shows.count %> events</span>
      <svg data-accordion-target="icon" class="w-3 h-3 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
      </svg>
    </button>
    
    <div data-accordion-target="content" class="hidden border-t border-gray-200">
      <% all_shows.each do |show| %>
        <% event_name = show.secondary_name.presence || show.event_type.titleize %>
        <div class="flex items-center px-3 py-2 border-b border-gray-100 last:border-b-0">
          <%# Date Box %>
          <div class="flex-shrink-0 w-14 text-center">
            <div class="text-xs font-semibold text-pink-600 uppercase"><%= show.date_and_time.strftime("%b") %></div>
            <div class="text-2xl font-bold text-gray-900"><%= show.date_and_time.strftime("%-d") %></div>
            <div class="text-xs text-gray-500"><%= show.date_and_time.strftime("%a") %></div>
          </div>
          
          <%# Show Details %>
          <div class="flex-1 ml-4">
            <div class="font-medium text-gray-900"><%= event_name %></div>
            <div class="text-sm text-gray-600">
              <%= show.date_and_time.strftime("%-I:%M %p") %>
              <% if show.secondary_name.present? %>
                <span class="mx-1">·</span>
                <span class="text-gray-400"><%= show.event_type.titleize %></span>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>
