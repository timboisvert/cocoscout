<% content_for :title, @organization.name %>

<div class="w-full" data-controller="tabs org-team-modals org-locations-settings org-messages">
  <%= render partial: "shared/notice", locals: { notice: notice } %>

  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [
      ["Organizations", manage_organizations_path]
    ],
    text: @organization.name,
    links: []
  } %>

  <!-- Tabs Navigation -->
  <nav class="flex space-x-2 border-b border-gray-200 mb-4 overflow-x-auto mt-4">
    <button type="button" data-tabs-target="tab" data-index="0" data-action="tabs#select" class="px-4 py-2 text-sm font-medium bg-white border-b-2 text-pink-600 cursor-pointer whitespace-nowrap">Basic Information</button>
    <button type="button" data-tabs-target="tab" data-index="1" data-action="tabs#select" class="px-4 py-2 text-sm font-medium bg-gray-50 border-b-2 text-gray-500 cursor-pointer whitespace-nowrap">Organization Team Members</button>
    <button type="button" data-tabs-target="tab" data-index="2" data-action="tabs#select" class="px-4 py-2 text-sm font-medium bg-gray-50 border-b-2 text-gray-500 cursor-pointer whitespace-nowrap">Locations</button>
    <button type="button" data-tabs-target="tab" data-index="3" data-action="tabs#select" class="px-4 py-2 text-sm font-medium bg-gray-50 border-b-2 text-gray-500 cursor-pointer whitespace-nowrap">Messages</button>
    <button type="button" data-tabs-target="tab" data-index="4" data-action="tabs#select" class="px-4 py-2 text-sm font-medium bg-gray-50 border-b-2 text-gray-500 cursor-pointer whitespace-nowrap">Ticketing</button>
    <% if @is_owner %>
      <button type="button" data-tabs-target="tab" data-index="5" data-action="tabs#select" class="px-4 py-2 text-sm font-medium bg-gray-50 border-b-2 text-red-500 cursor-pointer whitespace-nowrap">Danger Zone</button>
    <% end %>
  </nav>

  <!-- Tab 1: Basic Information -->
  <div data-tabs-target="panel">
    <div class="border border-gray-200 rounded-lg overflow-hidden">
      <%= render "shared/card_header", title: "Organization Details" %>
      <div class="p-6 bg-white">
        <%= form_with model: [:manage, @organization], method: :patch, multipart: true, class: "space-y-6", data: { controller: "file-preview" } do |f| %>
          <% if @organization.errors.any? %>
            <div class="bg-red-50 text-red-500 px-3 py-2 font-medium rounded-lg">
              <ul class="list-disc ml-6">
                <% @organization.errors.each do |error| %>
                  <li><%= error.full_message %></li>
                <% end %>
              </ul>
            </div>
          <% end %>

          <div class="sm:flex sm:space-x-5">
            <div class="w-full sm:w-1/2">
              <%= f.label :name, "Organization Name", class: "block text-sm font-medium text-gray-700" %>
              <%= f.text_field :name, class: "block shadow-sm rounded-lg border border-gray-400 px-3 py-2 mt-2 w-full focus:border-pink-500 focus:ring-pink-500" %>
            </div>
          </div>

          <!-- Logo Section -->
          <div class="border-t border-gray-200 pt-6">
            <h3 class="text-sm font-medium text-gray-700 mb-4">Organization Logo</h3>
            <div class="flex items-start gap-6">
              <div class="flex-shrink-0">
                <div data-file-preview-target="preview">
                  <% if @organization.logo.attached? %>
                    <%= image_tag @organization.logo, alt: "#{@organization.name} Logo", class: "rounded shadow-sm object-contain max-h-[100px] max-w-[120px] border border-gray-200" %>
                  <% else %>
                    <div class="w-[100px] h-[100px] rounded bg-gray-200 flex items-center justify-center border border-gray-300">
                      <span class="text-2xl font-bold text-gray-400"><%= @organization.name.split.map { |w| w[0] }.join.upcase.first(2) %></span>
                    </div>
                  <% end %>
                </div>
              </div>
              <div class="flex-1">
                <label class="block text-sm font-medium text-gray-600 mb-2 cursor-pointer">
                  <span class="text-pink-500 underline" data-file-preview-target="label">Choose a new logo...</span>
                  <%= f.file_field :logo, accept: "image/*", class: "hidden", data: { action: "change->file-preview#preview", file_preview_target: "input" } %>
                </label>
                <p class="text-xs text-gray-500">PNG, JPG, or GIF. Recommended size: 200x200 pixels or larger.</p>
                <% if @organization.logo.attached? %>
                  <div class="mt-2">
                    <%= link_to "Remove logo", remove_logo_manage_organization_path(@organization), data: { turbo_method: :delete, turbo_confirm: "Are you sure you want to remove the logo?" }, class: "text-xs text-pink-500 underline cursor-pointer" %>
                  </div>
                <% end %>
              </div>
            </div>
          </div>

          <div class="border-t border-gray-200 pt-6 flex justify-end">
            <%= render "shared/button", text: "Save Changes", variant: "primary", size: "medium", type: :submit %>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Tab 2: Organization Team Members -->
  <div data-tabs-target="panel" class="hidden">
    <div class="mt-4 space-y-1">
      <% @team_members.each do |member| %>
        <% organization_role = member.organization_roles.find { |r| r.organization_id == @organization.id } %>
        <% next unless organization_role&.company_role.in?(%w[manager viewer]) %>
        <% all_profiles = member.people.where(archived_at: nil).order(:created_at) %>
        <% primary_profile = organization_role.display_person %>
        <div class="group flex items-stretch px-3 py-2 bg-white border border-gray-200 rounded-lg hover:border-gray-400 transition-all">
          <%# Left Section: Person Info %>
          <div class="w-1/2 flex items-center gap-3">
            <% if all_profiles.size > 1 %>
              <%# Multiple profiles - show stacked headshots %>
              <div class="flex -space-x-2 flex-shrink-0">
                <% all_profiles.limit(3).each_with_index do |profile, idx| %>
                  <% if profile.headshot&.attached? %>
                    <%= image_tag profile.safe_headshot_variant(:thumb),
                        class: "w-10 h-10 rounded-lg object-cover border-2 border-white",
                        style: "z-index: #{3 - idx}",
                        title: profile.name %>
                  <% else %>
                    <div class="w-10 h-10 rounded-lg bg-gray-200 flex items-center justify-center border-2 border-white"
                         style="z-index: <%= 3 - idx %>"
                         title="<%= profile.name %>">
                      <span class="text-sm font-semibold text-gray-600"><%= profile.name&.first&.upcase || "?" %></span>
                    </div>
                  <% end %>
                <% end %>
                <% if all_profiles.size > 3 %>
                  <div class="w-10 h-10 rounded-lg bg-gray-300 flex items-center justify-center border-2 border-white">
                    <span class="text-xs font-semibold text-gray-600">+<%= all_profiles.size - 3 %></span>
                  </div>
                <% end %>
              </div>
            <% elsif primary_profile&.headshot&.attached? %>
              <%= image_tag primary_profile.safe_headshot_variant(:thumb), class: "w-10 h-10 rounded-lg object-cover flex-shrink-0" %>
            <% else %>
              <div class="w-10 h-10 rounded-lg bg-gray-200 flex items-center justify-center flex-shrink-0">
                <span class="text-sm font-semibold text-gray-600">
                  <%= (primary_profile&.name || member.email_address).first.upcase %>
                </span>
              </div>
            <% end %>
            <div class="min-w-0">
              <% if all_profiles.size > 1 %>
                <div class="font-medium text-sm text-gray-900 truncate">
                  <%= all_profiles.map(&:name).compact.join(", ") %>
                  <% if member == Current.user %>
                    <span class="text-gray-500">(Me)</span>
                  <% end %>
                </div>
                <div class="text-xs text-gray-500 truncate"><%= all_profiles.size %> profiles · <%= member.email_address %></div>
              <% else %>
                <div class="font-medium text-sm text-gray-900 truncate">
                  <%= primary_profile&.name || member.email_address %>
                  <% if member == Current.user %>
                    <span class="text-gray-500">(Me)</span>
                  <% end %>
                </div>
                <div class="text-xs text-gray-500 truncate"><%= member.email_address %></div>
              <% end %>
            </div>
          </div>
          <%# Right Section: Role %>
          <div class="w-1/2 border-l border-gray-200 pl-4 flex items-center justify-between">
            <div>
              <div class="text-[10px] text-gray-400 uppercase tracking-wide">Global Role</div>
              <div class="text-sm font-medium text-pink-500">
                <% if member.id == @organization.owner_id %>Owner, <% end %><%= organization_role&.company_role&.capitalize %>
              </div>
            </div>
            <% if (@is_owner || @role == "manager") && member != Current.user && member.id != @organization.owner_id %>
              <div class="opacity-0 group-hover:opacity-100 transition-opacity">
                <%= render "shared/button",
                    text: "Manage",
                    variant: "primary",
                    size: "small",
                    type: :button,
                    data: {
                      action: "click->org-team-modals#openPermissionsModal",
                      "member-id": member.id,
                      "member-name": primary_profile&.name || member.email_address,
                      "permissions-url": permissions_manage_team_path(id: member.id)
                    } %>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <% if @is_owner || @role == "manager" %>
        <% @team_invitations.each do |invite| %>
          <div class="group flex items-stretch px-3 py-2 border border-gray-200 rounded-lg hover:border-gray-400 transition-all">
            <%# Left Section: Person Info %>
            <div class="w-1/2 flex items-center gap-3">
              <div class="w-10 h-10 rounded-lg bg-yellow-100 flex items-center justify-center flex-shrink-0">
                <span class="text-sm font-semibold text-yellow-600">
                  <%= invite.email.first.upcase %>
                </span>
              </div>
              <div class="min-w-0">
                <div class="font-medium text-sm text-gray-900 truncate"><%= invite.email %></div>
                <div class="text-xs text-gray-500">Invited <%= time_ago_in_words(invite.created_at) %> ago</div>
              </div>
            </div>
            <%# Right Section: Status %>
            <div class="w-1/2 border-l border-gray-200 pl-4 flex items-center justify-between">
              <div>
                <div class="text-[10px] text-gray-400 uppercase tracking-wide">Status</div>
                <div class="text-sm font-medium text-yellow-600">Pending</div>
                <div class="text-xs text-gray-500">Awaiting response</div>
              </div>
              <div class="opacity-0 group-hover:opacity-100 transition-opacity">
                <%= form_with url: revoke_invite_manage_team_index_path(id: invite.id), method: :delete, data: { turbo: false, turbo_confirm: "Are you sure you want to revoke this invitation?" } do %>
                  <%= render "shared/button", text: "Revoke", variant: "primary", size: "small", type: :submit %>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      <% end %>
    </div>

    <% if @is_owner || @role == "manager" %>
      <div class="border-t border-gray-200 pt-5 mt-8">
        <%= render "shared/button", text: "Invite Organization Team Member", variant: "secondary", size: "medium", type: :button, data: { action: "click->org-team-modals#openInviteModal" } %>
      </div>

      <!-- Invite Organization Team Member Modal -->
      <div data-org-team-modals-target="inviteModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full" data-action="click->org-team-modals#stopPropagation">
          <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-xl font-semibold text-gray-900 coustard-regular">Invite an Organization Team Member</h2>
          </div>
          <div class="p-6" data-controller="team-invite-profiles" data-team-invite-profiles-check-url-value="<%= check_profiles_manage_team_index_path %>">
            <%= form_with(model: @team_invitation, url: invite_manage_team_index_path, method: :post, data: { turbo: false }) do |f| %>
              <div class="space-y-4">
                <div>
                  <%= f.label :email, "Email Address", class: "block text-sm font-medium text-gray-700 mb-2" %>
                  <%= f.email_field :email, placeholder: "email@example.com", autocapitalize: "none", class: "block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-pink-500 focus:ring-pink-500", data: { team_invite_profiles_target: "email", action: "blur->team-invite-profiles#checkProfiles" } %>
                </div>

                <!-- Profile Selection (shown when multiple profiles exist) -->
                <div data-team-invite-profiles-target="profilesSection" class="hidden">
                  <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <p class="text-sm font-medium text-yellow-800 mb-3">This email has multiple profiles. Which profile should be invited?</p>
                    <div data-team-invite-profiles-target="profilesList" class="space-y-2">
                      <!-- Profiles will be inserted here -->
                    </div>
                  </div>
                </div>

                <div>
                  <%= f.label :invitation_subject, "Email Subject", class: "block text-sm font-medium text-gray-700 mb-2" %>
                  <%= f.text_field :invitation_subject, value: "You've been invited to join #{@organization.name}'s team on CocoScout", class: "block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-pink-500 focus:ring-pink-500" %>
                </div>

                <div>
                  <%= f.label :invitation_message, "Email Message", class: "block text-sm font-medium text-gray-700 mb-2" %>
                  <%= f.text_area :invitation_message, rows: 5, value: "Welcome to CocoScout!\n\n#{@organization.name} is using CocoScout to manage its productions. You've been invited to join the team.\n\nClick the link below to accept the invitation and sign in or create an account.", class: "block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-pink-500 focus:ring-pink-500" %>
                </div>
              </div>

              <div class="mt-6 flex justify-end gap-3">
                <%= render "shared/button", text: "Cancel", variant: "secondary", size: "medium", type: :button, data: { action: "click->org-team-modals#closeInviteModal" } %>
                <%= render "shared/button", text: "Send Invitation", variant: "primary", size: "medium", type: :submit %>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Manage Permissions Modal -->
      <div data-org-team-modals-target="permissionsModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4" data-action="click->org-team-modals#closePermissionsModal">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] flex flex-col" data-action="click->org-team-modals#stopPropagation">
          <div class="px-6 py-4 border-b border-gray-200 flex-shrink-0">
            <h2 data-org-team-modals-target="permissionsTitle" class="text-xl font-semibold text-gray-900 coustard-regular">Manage Permissions</h2>
          </div>
          <div data-org-team-modals-target="permissionsContent" class="p-6 overflow-y-auto">
            <p class="text-gray-500 text-center py-8">Loading...</p>
          </div>
          <div class="px-6 py-4 border-t border-gray-200 flex-shrink-0 flex justify-end">
            <%= render "shared/button", text: "Close", variant: "secondary", size: "medium", type: :button, data: { action: "click->org-team-modals#closePermissionsModal" } %>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Tab 3: Locations -->
  <div data-tabs-target="panel" class="hidden">
    <% if @locations.any? %>
      <div class="grid grid-cols-1 gap-3 mt-4">
        <% @locations.each do |location| %>
          <%= link_to manage_location_path(location), class: "block p-4 bg-white border border-gray-200 rounded-lg hover:border-pink-300 hover:shadow-sm transition-all" do %>
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <div class="flex items-center gap-2">
                  <span class="font-bold text-md text-gray-900"><%= location.name %></span>
                  <% if location.default? %>
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-pink-100 text-pink-700">Default</span>
                  <% end %>
                </div>
                <div class="text-sm text-gray-500 mt-1">
                  <%= location.address1 %><%= ", #{location.address2}" if location.address2.present? %><br>
                  <%= location.city %>, <%= location.state %> <%= location.postal_code %>
                </div>

                <%# Show spaces if any %>
                <% spaces = location.location_spaces.by_name %>
                <% if spaces.any? %>
                  <div class="mt-3 pt-3 border-t border-gray-100">
                    <div class="text-xs font-medium text-gray-500 mb-1.5">Spaces:</div>
                    <div class="flex flex-wrap gap-1.5">
                      <% spaces.each do |space| %>
                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs <%= space.default? ? 'bg-pink-50 text-pink-700 border border-pink-200' : 'bg-gray-100 text-gray-600' %>">
                          <%= space.name %>
                          <% if space.capacity.present? && space.capacity > 0 %>
                            <span class="text-gray-400 ml-1">(<%= space.capacity %>)</span>
                          <% end %>
                        </span>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              </div>

              <div class="text-gray-400 ml-4">
                <%= icon("arrow-right", class: "w-5 h-5") %>
              </div>
            </div>
          <% end %>
        <% end %>
      </div>
    <% else %>
      <p class="text-gray-500 text-sm">No locations have been added yet.</p>
    <% end %>

    <% if @is_owner || @role == "manager" %>
      <div class="border-t border-gray-200 pt-5 mt-8">
        <%= render "shared/button", text: "Add Location", variant: "secondary", size: "medium", type: :button, data: { action: "click->org-locations-settings#openAddModal" } %>
      </div>

      <!-- Add Location Modal -->
      <div data-org-locations-settings-target="addModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" data-action="click->org-locations-settings#stopPropagation">
          <div class="sticky top-0 bg-white px-6 py-4 border-b border-gray-200">
            <h2 class="text-xl font-semibold text-gray-900 coustard-regular">Add a Location</h2>
          </div>
          <div class="p-6">
            <form data-org-locations-settings-target="addForm" action="<%= manage_locations_path %>" method="post" data-action="submit->org-locations-settings#submitAddForm">
              <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
              <div data-org-locations-settings-target="addErrorContainer" class="hidden bg-pink-50 px-3 py-2 font-medium rounded-md mb-4">
                <ul data-org-locations-settings-target="addErrorList" class="list-disc ml-6"></ul>
              </div>
              <%= render "manage/organizations/location_form_fields" %>
              <div class="flex justify-end gap-3 pt-4">
                <%= render "shared/button", text: "Cancel", variant: "secondary", size: "medium", type: :button, data: { action: "click->org-locations-settings#closeAddModal" } %>
                <%= render "shared/button", text: "Add Location", variant: "primary", size: "medium", type: :submit %>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Edit Location Modal -->
      <div data-org-locations-settings-target="editModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" data-action="click->org-locations-settings#stopPropagation">
          <div class="sticky top-0 bg-white px-6 py-4 border-b border-gray-200">
            <h2 class="text-xl font-semibold text-gray-900 coustard-regular">Edit Location</h2>
          </div>
          <div class="p-6">
            <form data-org-locations-settings-target="editForm" action="" method="post" data-action="submit->org-locations-settings#submitEditForm">
              <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
              <input type="hidden" name="_method" value="patch">
              <input type="hidden" data-org-locations-settings-target="editLocationId" name="location[id]" value="">
              <div data-org-locations-settings-target="editErrorContainer" class="hidden bg-pink-50 px-3 py-2 font-medium rounded-md mb-4">
                <ul data-org-locations-settings-target="editErrorList" class="list-disc ml-6"></ul>
              </div>
              <%= render "manage/organizations/location_form_fields", prefix: "edit" %>
              <div class="flex justify-end gap-3 pt-4">
                <%= render "shared/button", text: "Cancel", variant: "secondary", size: "medium", type: :button, data: { action: "click->org-locations-settings#closeEditModal" } %>
                <%= render "shared/button", text: "Update Location", variant: "primary", size: "medium", type: :submit %>
              </div>
            </form>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Tab 4: Messages -->
  <div data-tabs-target="panel" class="hidden">
    <div class="border border-gray-200 rounded-lg overflow-hidden">
      <%= render "shared/card_header", title: "Message Board Settings" %>
      <div class="p-6 bg-white space-y-6">
        <p class="text-sm text-gray-600">
          Configure how message boards work for your organization's productions.
        </p>

        <%= form_with model: [:manage, @organization], method: :patch, data: { turbo: false } do |f| %>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Forum Mode</label>
              <div class="space-y-2">
                <label class="flex items-start gap-3 cursor-pointer">
                  <%= f.radio_button :forum_mode, "per_production", class: "mt-1 h-4 w-4 text-pink-600 border-gray-300 focus:ring-pink-500 accent-pink-600", data: { action: "change->org-messages#toggleForumName" } %>
                  <div>
                    <span class="text-sm font-medium text-gray-900">One forum per production</span>
                    <p class="text-xs text-gray-500">Each production has its own separate message board.</p>
                  </div>
                </label>
                <label class="flex items-start gap-3 cursor-pointer">
                  <%= f.radio_button :forum_mode, "shared", class: "mt-1 h-4 w-4 text-pink-600 border-gray-300 focus:ring-pink-500 accent-pink-600", data: { action: "change->org-messages#toggleForumName" } %>
                  <div>
                    <span class="text-sm font-medium text-gray-900">Shared forum</span>
                    <p class="text-xs text-gray-500">All productions share one organization-wide message board.</p>
                  </div>
                </label>
              </div>
            </div>

            <!-- Shared Forum Name Field -->
            <div id="shared-forum-name-field" class="<%= @organization.forum_shared? ? '' : 'hidden' %>">
              <label class="block text-sm font-medium text-gray-700 mb-2">Forum Name</label>
              <%= f.text_field :shared_forum_name,
                  placeholder: @organization.name,
                  class: "w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-pink-500 focus:ring-pink-500" %>
              <p class="text-xs text-gray-500 mt-1">Leave blank to use your organization name.</p>
            </div>

            <div class="pt-4">
              <%= render "shared/button", text: "Save Changes", variant: "primary", size: "medium", type: :submit %>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <% if @organization.forum_per_production? && @productions.any? %>
      <div class="border border-gray-200 rounded-lg overflow-hidden mt-6">
        <%= render "shared/card_header", title: "Production Forum Settings" %>
        <div class="p-6 bg-white">
          <p class="text-sm text-gray-600 mb-4">
            Enable or disable the message board for individual productions.
          </p>

          <div class="space-y-2">
            <% @productions.each do |production| %>
              <div class="flex items-center justify-between py-2 px-3 border border-gray-200 rounded-lg">
                <div class="flex items-center gap-3">
                  <% if production.logo.attached? %>
                    <%= image_tag production.safe_logo_variant(:small), alt: production.name, class: "w-8 h-8 object-contain rounded" %>
                  <% else %>
                    <div class="w-8 h-8 rounded bg-pink-100 flex items-center justify-center">
                      <span class="text-xs font-bold text-pink-600"><%= production.initials %></span>
                    </div>
                  <% end %>
                  <span class="text-sm font-medium text-gray-900"><%= production.name %></span>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox"
                         class="sr-only peer"
                         <%= "checked" if production.forum_enabled? %>
                         data-action="change->org-messages#toggleProduction"
                         data-production-id="<%= production.id %>"
                         data-url="<%= toggle_production_forum_manage_organization_path(@organization, production_id: production.id) %>">
                  <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-100 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
                </label>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Tab 5: Ticketing Integrations -->
  <div data-tabs-target="panel" class="hidden">
    <% ticketing_providers = Current.organization.ticketing_providers.order(:name) %>
    <% pending_events = TicketingPendingEvent.joins(:ticketing_provider).where(ticketing_providers: { organization_id: Current.organization.id }).pending %>
    <% pending_count = pending_events.count %>

    <!-- Pending Events Alert -->
    <% if pending_count > 0 %>
      <div class="border border-amber-200 bg-amber-50 rounded-lg p-4 mb-6">
        <div class="flex items-start justify-between">
          <div class="flex items-start gap-3">
            <svg class="w-5 h-5 text-amber-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <div>
              <h4 class="font-medium text-amber-800"><%= pluralize(pending_count, "ticketing event") %> need attention</h4>
              <p class="text-sm text-amber-700 mt-1">Events from your ticketing platforms couldn't be automatically matched to productions.</p>
            </div>
          </div>
          <%= link_to manage_ticketing_pending_events_path do %>
            <%= render "shared/button", text: "Review Events", variant: "secondary", size: "small" %>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- Connected Platforms -->
    <div class="border border-gray-200 rounded-lg overflow-hidden mb-6">
      <%= render "shared/card_header", title: "Connected Platforms" %>
      <div class="p-6 bg-white">
        <% if ticketing_providers.any? %>
          <div class="space-y-3 mb-6">
            <% ticketing_providers.each do |provider| %>
              <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                <div class="flex items-start justify-between">
                  <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-pink-100 flex items-center justify-center flex-shrink-0">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-pink-600">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 6v.75m0 3v.75m0 3v.75m0 3V18m-9-5.25h5.25M7.5 15h3M3.375 5.25c-.621 0-1.125.504-1.125 1.125v3.026a2.999 2.999 0 0 1 0 5.198v3.026c0 .621.504 1.125 1.125 1.125h17.25c.621 0 1.125-.504 1.125-1.125v-3.026a2.999 2.999 0 0 1 0-5.198V6.375c0-.621-.504-1.125-1.125-1.125H3.375Z" />
                      </svg>
                    </div>
                    <div>
                      <div class="font-medium text-gray-900"><%= provider.name %></div>
                      <div class="text-sm text-gray-500"><%= provider.provider_display_name %></div>
                      <div class="text-xs text-gray-400 mt-1">
                        <% if provider.last_synced_at %>
                          Last synced <%= time_ago_in_words(provider.last_synced_at) %> ago
                        <% else %>
                          Never synced
                        <% end %>
                        <% if provider.auto_sync_enabled? %>
                          · Auto-sync every <%= provider.sync_interval_minutes %> min
                        <% end %>
                      </div>
                    </div>
                  </div>
                  <div class="flex items-center gap-2">
                    <% if provider.healthy? %>
                      <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">Connected</span>
                    <% else %>
                      <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">Error</span>
                    <% end %>
                  </div>
                </div>

                <div class="mt-3 pt-3 border-t border-gray-200 flex items-center justify-between">
                  <div class="text-sm text-gray-500">
                    <%= provider.ticketing_production_links.count %> productions linked
                    <% provider_pending = provider.ticketing_pending_events.pending.count %>
                    <% if provider_pending > 0 %>
                      · <span class="text-amber-600"><%= provider_pending %> pending</span>
                    <% end %>
                  </div>
                  <div class="flex items-center gap-2">
                    <%= button_to manage_ticketing_sync_now_path(provider_id: provider.id),
                                 method: :post,
                                 class: "text-sm text-pink-600 hover:text-pink-700 font-medium" do %>
                      Sync Now
                    <% end %>
                    <%= link_to "Manage", manage_ticketing_provider_path(@organization, provider), class: "text-sm text-gray-500 hover:text-gray-700" %>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="bg-gray-50 rounded-lg border border-dashed border-gray-300 p-6 text-center mb-6">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-gray-400 mx-auto mb-2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 6v.75m0 3v.75m0 3v.75m0 3V18m-9-5.25h5.25M7.5 15h3M3.375 5.25c-.621 0-1.125.504-1.125 1.125v3.026a2.999 2.999 0 0 1 0 5.198v3.026c0 .621.504 1.125 1.125 1.125h17.25c.621 0 1.125-.504 1.125-1.125v-3.026a2.999 2.999 0 0 1 0-5.198V6.375c0-.621-.504-1.125-1.125-1.125H3.375Z" />
            </svg>
            <p class="text-sm text-gray-600">No ticketing platforms connected yet.</p>
          </div>
        <% end %>

        <%= link_to manage_ticketing_wizard_path(@organization) do %>
          <%= render "shared/button", text: "Connect Ticketing Platform", variant: "primary", size: "medium" %>
        <% end %>
      </div>
    </div>

    <!-- How It Works -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
      <h4 class="font-medium text-blue-900 mb-2">How Automatic Linking Works</h4>
      <ul class="text-sm text-blue-700 space-y-1">
        <li>• When you connect a ticketing platform, we automatically fetch your events</li>
        <li>• Events are matched to your productions by name and date range</li>
        <li>• High-confidence matches are linked automatically</li>
        <li>• Events that can't be matched appear in "Pending Events" for you to review</li>
        <li>• Once linked, ticket sales data syncs automatically based on your schedule</li>
      </ul>
    </div>
  </div>

  <!-- Tab 6: Danger Zone (Owner only) -->
  <% if @is_owner %>
    <div data-tabs-target="panel" class="hidden">
      <!-- Transfer Ownership Section -->
      <% if @team_members.count > 1 %>
        <div class="border border-gray-200 rounded-lg overflow-hidden mb-6">
          <div class="bg-yellow-50 px-4 py-3 border-b border-yellow-200">
            <h2 class="text-lg font-semibold text-yellow-800 coustard-regular">Transfer Ownership</h2>
          </div>
          <div class="p-6 bg-white">
            <p class="text-sm text-gray-600 mb-4">
              Transfer ownership of this organization to another manager. You will remain a manager but will lose owner privileges.
            </p>

            <%= form_with url: transfer_ownership_manage_organization_path(@organization), method: :post, class: "space-y-4" do |f| %>
              <div class="sm:w-1/2">
                <%= f.label :new_owner_id, "New Owner", class: "block text-sm font-medium text-gray-700 mb-2" %>
                <%= f.select :new_owner_id,
                    options_from_collection_for_select(
                      @team_members.select { |u| u.organization_roles.exists?(organization: @organization, company_role: 'manager') && u.id != Current.user.id },
                      :id,
                      ->(u) { u.person&.name || u.email_address }
                    ),
                    { prompt: "Select new owner..." },
                    { class: "block w-full rounded-lg border border-gray-400 px-3 py-2 shadow-sm focus:border-pink-500 focus:ring-pink-500" } %>
              </div>

              <div class="pt-2">
                <%= render "shared/button",
                           text: "Transfer Ownership",
                           variant: "secondary",
                           size: "medium",
                           type: :submit,
                           data: { turbo_confirm: "Are you sure you want to transfer ownership? This action cannot be undone." } %>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- Delete Organization Section -->
      <div class="bg-red-50 border border-red-200 rounded-lg p-6">
        <div class="flex items-start gap-4">
          <div class="flex-shrink-0">
            <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
            </svg>
          </div>
          <div class="flex-1">
            <h3 class="text-lg font-semibold text-red-800 mb-2">Delete this Organization</h3>
            <p class="text-sm text-red-700 mb-4">
              Deleting this organization is <strong>permanent and cannot be undone</strong>. This action will remove the organization and all associated productions, shows, talent pool, and data from the system.
            </p>
            <p class="text-sm text-red-700 mb-4">
              Before deleting, please review what will be removed. You'll be asked to confirm on the next page.
            </p>
            <div class="mt-6">
              <%= render "shared/button",
                  text: "Delete this organization",
                  variant: "danger",
                  size: "medium",
                  path: confirm_delete_manage_organization_path(@organization),
                  icon: "trash" %>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>
