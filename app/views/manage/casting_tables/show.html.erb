<% content_for :title, @casting_table.name %>

<div class="w-full mb-10" data-controller="casting-table" data-casting-table-table-id-value="<%= @casting_table.id %>">
  <%= render partial: "shared/notice", locals: { notice: notice } %>

  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [
      ["Casting", manage_casting_path],
      ["Casting Tables", manage_casting_tables_path]
    ],
    text: @casting_table.name,
    links: @casting_table.draft? ? [{ text: "Edit Name", path: manage_edit_casting_table_path(@casting_table) }] : []
  } %>

  <% unless @casting_table.draft? %>
    <div class="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg">
      <div class="flex items-center gap-2">
        <svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
        </svg>
        <span class="text-sm font-medium text-green-800">Finalized</span>
        <span class="text-sm text-green-700">— This casting table was finalized <%= time_ago_in_words(@casting_table.finalized_at) %> ago.</span>
      </div>
    </div>
  <% end %>

  <!-- Casting Grid -->
  <div class="bg-white border border-gray-200 rounded-lg shadow-sm">
    <div class="overflow-auto <%= @casting_table.draft? ? 'max-h-[calc(100vh-280px)]' : 'max-h-[calc(100vh-200px)]' %> rounded-lg">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="sticky left-0 z-10 bg-gray-50 px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[280px] after:absolute after:right-0 after:top-0 after:bottom-0 after:w-px after:bg-gray-300 relative">
              Event
            </th>
            <% @members.each do |member| %>
              <th class="px-1 py-2 text-center min-w-[50px] max-w-[50px]">
                <div class="flex flex-col items-center gap-1">
                  <div class="h-20 flex items-end justify-center pb-1">
                    <span class="text-xs text-gray-600 whitespace-nowrap [writing-mode:vertical-rl] rotate-180" title="<%= member.name %>"><%= member.name.split.first %></span>
                  </div>
                  <% if member.respond_to?(:safe_headshot_variant) %>
                    <% headshot = member.safe_headshot_variant(:thumb) %>
                    <% if headshot %>
                      <%= image_tag headshot, alt: member.name, class: "w-8 h-8 rounded-lg object-cover" %>
                    <% else %>
                      <div class="w-8 h-8 rounded-lg bg-gray-200 flex items-center justify-center">
                        <span class="text-xs font-medium text-gray-500"><%= member.initials[0..1] %></span>
                      </div>
                    <% end %>
                  <% end %>
                </div>
              </th>
            <% end %>
            <th class="sticky right-0 z-10 bg-gray-50 px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider min-w-[45px] before:absolute before:left-0 before:top-0 before:bottom-0 before:w-px before:bg-gray-300 relative">
              Cast
            </th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <% @shows.each do |show| %>
            <%
              show_count = @show_assignment_counts[show.id] || 0
              total_slots = @show_total_slots[show.id] || 0
              is_fully_cast = total_slots > 0 && show_count >= total_slots
            %>
            <tr class="hover:bg-gray-50 group">
              <td class="sticky left-0 z-10 bg-white group-hover:bg-gray-50 px-3 py-2 after:absolute after:right-0 after:top-0 after:bottom-0 after:w-px after:bg-gray-300 relative">
                <div class="flex items-center gap-3">
                  <%# Date Box - show_row style %>
                  <div class="flex-shrink-0 w-12 text-center">
                    <div class="text-xs font-semibold text-pink-600 uppercase"><%= show.date_and_time.strftime("%b") %></div>
                    <div class="text-xl font-bold text-gray-900"><%= show.date_and_time.strftime("%-d") %></div>
                    <div class="text-xs text-gray-500"><%= show.date_and_time.strftime("%a") %></div>
                  </div>
                  <%# Show Details %>
                  <div class="flex-1 min-w-0">
                    <div class="font-medium text-gray-900 text-sm">
                      <%= show.secondary_name.presence || show.event_type.titleize %>
                    </div>
                    <div class="text-xs text-gray-600">
                      <%= show.date_and_time.strftime("%l:%M %p").strip %> · <%= show.production.name %>
                    </div>
                  </div>
                </div>
              </td>
              <% @members.each do |member| %>
                <%
                  member_type = member.class.name
                  member_id = member.id
                  key = [show.id, member_type, member_id]
                  availability_key = [show.id, member_type, member_id]
                  availability = @availability[availability_key]
                  
                  draft_assignment = @draft_assignments[key]&.first
                  existing_assignment = @existing_assignments[key]&.first
                  
                  has_draft = draft_assignment.present?
                  has_existing = existing_assignment.present?
                  
                  # Availability display - status is enum: "available", "unavailable", "unset"
                  if availability == "available"
                    avail_display = "A"
                    avail_class = "text-pink-500"
                  elsif availability == "unavailable"
                    avail_display = "U"
                    avail_class = "text-gray-400"
                  else
                    avail_display = "-"
                    avail_class = "text-gray-300"
                  end
                %>
                <td class="px-1 py-2 text-center relative"
                    data-casting-table-target="cell"
                    data-show-id="<%= show.id %>"
                    data-production-id="<%= show.production_id %>"
                    data-member-type="<%= member_type %>"
                    data-member-id="<%= member_id %>"
                    data-availability="<%= availability || 'unset' %>">
                  <% if has_draft %>
                    <div class="w-full h-full min-h-[40px] bg-pink-500 text-white rounded flex items-center justify-center cursor-pointer text-xs font-medium px-1"
                         <% if @casting_table.draft? %>
                         data-action="click->casting-table#openRoleSelector"
                         <% end %>
                         title="<%= draft_assignment.role.name %>">
                      <%= draft_assignment.role.name.truncate(10) %>
                    </div>
                  <% elsif has_existing %>
                    <div class="w-full h-full min-h-[40px] bg-gray-400 text-white rounded flex items-center justify-center text-xs font-medium px-1"
                         title="<%= existing_assignment.role.name %> (already cast)">
                      <%= existing_assignment.role.name.truncate(10) %>
                    </div>
                  <% else %>
                    <div class="w-full h-full min-h-[40px] rounded flex items-center justify-center <%= @casting_table.draft? ? 'cursor-pointer hover:bg-gray-100' : '' %>"
                         <% if @casting_table.draft? %>
                         data-action="click->casting-table#openRoleSelector"
                         <% end %>>
                      <span class="text-sm font-medium <%= avail_class %>"><%= avail_display %></span>
                    </div>
                  <% end %>
                </td>
              <% end %>
              <td class="sticky right-0 z-10 bg-white group-hover:bg-gray-50 px-2 py-2 text-center before:absolute before:left-0 before:top-0 before:bottom-0 before:w-px before:bg-gray-300 relative"
                  data-casting-table-target="showCount"
                  data-show-id="<%= show.id %>"
                  data-current-count="<%= show_count %>"
                  data-total-slots="<%= total_slots %>">
                <div class="flex items-center justify-center gap-1">
                  <% if is_fully_cast %>
                    <svg class="w-3.5 h-3.5 text-pink-500 fully-cast-icon" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                  <% end %>
                  <span class="text-xs font-medium text-gray-500 show-count-text"><%= show_count %>/<%= total_slots %></span>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
        <tfoot class="sticky bottom-0 z-20 bg-gray-50 border-t-2 border-gray-300 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
          <tr>
            <td class="sticky left-0 z-30 bg-gray-50 px-4 py-3 text-sm font-medium text-gray-700 after:absolute after:right-0 after:top-0 after:bottom-0 after:w-px after:bg-gray-300 relative">
              Total Assignments
            </td>
            <% @members.each do |member| %>
              <%
                key = [member.class.name, member.id]
                count = @assignment_counts[key] || 0
              %>
              <td class="px-1 py-2 text-center"
                  data-casting-table-target="memberCount"
                  data-member-type="<%= member.class.name %>"
                  data-member-id="<%= member.id %>"
                  data-current-count="<%= count %>">
                <span class="inline-flex items-center justify-center w-6 h-6 rounded-full <%= count > 0 ? 'bg-pink-100 text-pink-700' : 'bg-gray-100 text-gray-500' %> text-xs font-medium member-count-text">
                  <%= count %>
                </span>
              </td>
            <% end %>
            <td class="sticky right-0 z-30 bg-gray-50 px-2 py-2 text-center before:absolute before:left-0 before:top-0 before:bottom-0 before:w-px before:bg-gray-300 relative"
                data-casting-table-target="totalCount"
                data-current-count="<%= @assignment_counts.values.sum %>"
                data-total-slots="<%= @show_total_slots.values.sum %>">
              <% total_count = @assignment_counts.values.sum %>
              <% total_slots = @show_total_slots.values.sum %>
              <span class="text-xs font-semibold <%= total_count >= total_slots ? 'text-pink-600' : 'text-gray-700' %> total-count-text">
                <%= total_count %>/<%= total_slots %>
              </span>
            </td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <!-- Role Selector Popup (hidden by default) -->
  <div id="role-selector" class="hidden fixed z-50 bg-white rounded-lg shadow-xl border border-gray-200 p-3 min-w-[200px] max-w-[280px]" data-casting-table-target="roleSelector">
    <div class="text-xs font-medium text-gray-500 uppercase mb-2">Select Role</div>
    <div id="role-options" class="space-y-1" data-casting-table-target="roleOptions">
      <!-- Populated dynamically -->
    </div>
    <div class="mt-2 pt-2 border-t border-gray-200">
      <button type="button" class="w-full text-center text-xs text-gray-500 hover:text-gray-700 py-1 cursor-pointer" data-action="click->casting-table#closeRoleSelector">
        Cancel
      </button>
    </div>
  </div>

  <% if @casting_table.draft? %>
    <!-- Floating Action Bar - styled like auditions voting bar -->
    <div class="fixed bottom-4 left-4 right-4 lg:left-60 lg:right-4 bg-white rounded-lg shadow-lg border border-gray-200 z-40 overflow-hidden">
      <div class="bg-gray-50 px-3 py-2 border-b border-gray-200">
        <h3 class="text-sm font-semibold text-gray-900 coustard-regular">Draft Mode</h3>
      </div>
      <div class="p-3 flex flex-col sm:flex-row sm:items-center gap-3">
        <div class="flex-1 text-sm text-gray-600">
          <span class="font-medium" data-casting-table-target="draftAssignmentCount"><%= @casting_table.casting_table_draft_assignments.count %></span> draft assignments
        </div>
        <div class="flex items-center gap-3">
          <%= render "shared/button", text: "Review & Finalize", variant: "primary", size: "medium", path: manage_casting_table_summary_path(@casting_table) %>
        </div>
      </div>
    </div>
  <% end %>
</div>

<!-- Roles Data for JavaScript (keyed by show_id now) -->
<script type="application/json" id="roles-data">
<%= raw @roles_by_show.transform_values { |roles| 
  roles.map { |r| 
    role_data = { 
      id: r.id, 
      name: r.name, 
      restricted: r.restricted, 
      quantity: r.quantity 
    }
    if r.restricted?
      role_data[:eligible_members] = r.eligible_members.map { |m| { type: m.class.name, id: m.id, name: m.name } }
    end
    role_data
  } 
}.to_json %>
</script>

<!-- Role Counts per Show for JavaScript -->
<script type="application/json" id="role-counts-data">
<%= raw @role_counts_by_show.transform_keys { |k| "#{k[0]}_#{k[1]}" }.to_json %>
</script>
