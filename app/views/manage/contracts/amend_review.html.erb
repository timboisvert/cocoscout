<% content_for :title, "Amend Contract - Review" %>

<div class="w-full mb-10">
  <%= render partial: "shared/notice", locals: { notice: notice, alert: alert } %>

  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [
      ["Money", manage_money_index_path],
      ["Contracts", manage_contracts_path],
      [@contract.contractor_name, manage_contract_path(@contract)]
    ],
    text: "Review Amendments",
    links: []
  } %>

  <div class="max-w-4xl mx-auto mt-6">
    <p class="text-gray-600 mb-6">Review and confirm your changes before applying.</p>

    <%# Progress Steps - 4 steps %>
    <div class="flex items-center gap-4 mb-8">
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 rounded-full bg-green-500 text-white flex items-center justify-center text-sm font-semibold">
          <%= icon("check", class: "w-4 h-4") %>
        </div>
        <span class="text-sm font-medium text-gray-500">Events</span>
      </div>
      <div class="flex-1 h-0.5 bg-green-500"></div>
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 rounded-full bg-green-500 text-white flex items-center justify-center text-sm font-semibold">
          <%= icon("check", class: "w-4 h-4") %>
        </div>
        <span class="text-sm font-medium text-gray-500">Review Events</span>
      </div>
      <div class="flex-1 h-0.5 bg-green-500"></div>
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 rounded-full bg-green-500 text-white flex items-center justify-center text-sm font-semibold">
          <%= icon("check", class: "w-4 h-4") %>
        </div>
        <span class="text-sm font-medium text-gray-500">Payments</span>
      </div>
      <div class="flex-1 h-0.5 bg-pink-500"></div>
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 rounded-full bg-pink-500 text-white flex items-center justify-center text-sm font-semibold">4</div>
        <span class="text-sm font-medium text-gray-900">Confirm</span>
      </div>
    </div>

  <% if @has_changes %>
    <%# Events Changes %>
    <div class="bg-white border border-gray-200 rounded-lg overflow-hidden mb-6">
      <div class="px-4 py-3 bg-gray-50 border-b border-gray-200">
        <h3 class="text-sm font-semibold text-gray-700">Event Changes</h3>
      </div>
      <div class="p-4 space-y-4">
        <% if @rentals_to_remove.any? %>
          <div>
            <h4 class="text-sm font-medium text-red-600 mb-2 flex items-center gap-2">
              <%= icon("minus-circle", class: "w-4 h-4") %>
              Events to Remove (<%= @rentals_to_remove.count %>)
            </h4>
            <div class="space-y-2">
              <% @rentals_to_remove.each do |rental| %>
                <div class="flex items-center gap-3 p-3 bg-red-50 border border-red-200 rounded-lg">
                  <div class="flex-shrink-0 w-12 text-center">
                    <div class="text-xs font-semibold text-red-600 uppercase"><%= rental.starts_at.strftime("%b") %></div>
                    <div class="text-lg font-bold text-gray-900"><%= rental.starts_at.strftime("%-d") %></div>
                  </div>
                  <div>
                    <div class="font-medium text-gray-900">
                      <%= rental.location_space&.name || rental.location&.name || "Location" %>
                    </div>
                    <div class="text-sm text-gray-500">
                      <%= rental.starts_at.strftime("%l:%M %p").strip %> - <%= rental.ends_at.strftime("%l:%M %p").strip %>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>

        <% if @new_bookings.any? %>
          <div>
            <h4 class="text-sm font-medium text-green-600 mb-2 flex items-center gap-2">
              <%= icon("plus-circle", class: "w-4 h-4") %>
              Events to Add (<%= @new_bookings.count %>)
            </h4>
            <div class="space-y-2">
              <% @new_bookings.each do |booking| %>
                <% starts_at = Time.zone.parse(booking["starts_at"]) %>
                <% location = @locations_map[booking["location_id"].to_i] %>
                <% space = @spaces_map[booking["space_id"].to_i] %>
                <div class="flex items-center gap-3 p-3 bg-green-50 border border-green-200 rounded-lg">
                  <div class="flex-shrink-0 w-12 text-center">
                    <div class="text-xs font-semibold text-green-600 uppercase"><%= starts_at.strftime("%b") %></div>
                    <div class="text-lg font-bold text-gray-900"><%= starts_at.strftime("%-d") %></div>
                  </div>
                  <div>
                    <div class="font-medium text-gray-900">
                      <%= space&.name || location&.name || "Location" %>
                    </div>
                    <div class="text-sm text-gray-500">
                      <%= starts_at.strftime("%l:%M %p").strip %> Â· <%= booking["duration"] || 2 %> hours
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>

        <% if @removed_rental_ids.empty? && @new_bookings.empty? %>
          <p class="text-sm text-gray-500">No changes to events.</p>
        <% end %>
      </div>
    </div>

    <%# Payment Changes %>
    <div class="bg-white border border-gray-200 rounded-lg overflow-hidden mb-6">
      <div class="px-4 py-3 bg-gray-50 border-b border-gray-200">
        <h3 class="text-sm font-semibold text-gray-700">Payment Changes</h3>
      </div>
      <div class="p-4 space-y-4">
        <% if @payments_to_remove.any? %>
          <div>
            <h4 class="text-sm font-medium text-red-600 mb-2 flex items-center gap-2">
              <%= icon("minus-circle", class: "w-4 h-4") %>
              Payments to Remove (<%= @payments_to_remove.count %>)
            </h4>
            <div class="space-y-2">
              <% @payments_to_remove.each do |payment| %>
                <div class="flex items-center justify-between p-3 bg-red-50 border border-red-200 rounded-lg">
                  <div class="flex items-center gap-3">
                    <div class="flex-shrink-0">
                      <% if payment.direction == "incoming" %>
                        <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center">
                          <%= icon("arrow-down-left", class: "w-4 h-4 text-green-600") %>
                        </div>
                      <% else %>
                        <div class="w-8 h-8 rounded-full bg-red-100 flex items-center justify-center">
                          <%= icon("arrow-up-right", class: "w-4 h-4 text-red-600") %>
                        </div>
                      <% end %>
                    </div>
                    <div>
                      <div class="font-medium text-gray-900"><%= payment.description %></div>
                      <div class="text-sm text-gray-500">Due: <%= payment.due_date.strftime("%b %-d, %Y") %></div>
                    </div>
                  </div>
                  <div class="font-semibold <%= payment.direction == 'incoming' ? 'text-green-600' : 'text-red-600' %>">
                    <%= payment.direction == 'incoming' ? '+' : '-' %><%= number_to_currency(payment.amount) %>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>

        <% if @new_payments.any? %>
          <div>
            <h4 class="text-sm font-medium text-green-600 mb-2 flex items-center gap-2">
              <%= icon("plus-circle", class: "w-4 h-4") %>
              Payments to Add (<%= @new_payments.count %>)
            </h4>
            <div class="space-y-2">
              <% @new_payments.each do |payment| %>
                <div class="flex items-center justify-between p-3 bg-green-50 border border-green-200 rounded-lg">
                  <div class="flex items-center gap-3">
                    <div class="flex-shrink-0">
                      <% if payment["direction"] == "incoming" %>
                        <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center">
                          <%= icon("arrow-down-left", class: "w-4 h-4 text-green-600") %>
                        </div>
                      <% else %>
                        <div class="w-8 h-8 rounded-full bg-red-100 flex items-center justify-center">
                          <%= icon("arrow-up-right", class: "w-4 h-4 text-red-600") %>
                        </div>
                      <% end %>
                    </div>
                    <div>
                      <div class="font-medium text-gray-900"><%= payment["description"] %></div>
                      <div class="text-sm text-gray-500">Due: <%= Date.parse(payment["due_date"]).strftime("%b %-d, %Y") rescue "TBD" %></div>
                    </div>
                  </div>
                  <div class="font-semibold <%= payment["direction"] == 'incoming' ? 'text-green-600' : 'text-red-600' %>">
                    <%= payment["direction"] == 'incoming' ? '+' : '-' %><%= number_to_currency(payment["amount"].to_f) %>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>

        <% if @removed_payment_ids.empty? && @new_payments.empty? %>
          <p class="text-sm text-gray-500">No changes to payments.</p>
        <% end %>
      </div>
    </div>

    <%# Summary %>
    <div class="bg-pink-50 border border-pink-200 rounded-lg p-4 mb-6">
      <h3 class="text-sm font-semibold text-pink-800 mb-2">Amendment Summary</h3>
      <div class="grid grid-cols-2 gap-4 text-sm">
        <div>
          <span class="text-pink-700">Events:</span>
          <span class="font-medium text-pink-900">
            <% if @removed_rental_ids.any? %>-<%= @removed_rental_ids.count %><% end %>
            <% if @new_bookings.any? %><%= @removed_rental_ids.any? ? ', ' : '' %>+<%= @new_bookings.count %><% end %>
            <% if @removed_rental_ids.empty? && @new_bookings.empty? %>No changes<% end %>
          </span>
        </div>
        <div>
          <span class="text-pink-700">Payments:</span>
          <span class="font-medium text-pink-900">
            <% if @removed_payment_ids.any? %>-<%= @removed_payment_ids.count %><% end %>
            <% if @new_payments.any? %><%= @removed_payment_ids.any? ? ', ' : '' %>+<%= @new_payments.count %><% end %>
            <% if @removed_payment_ids.empty? && @new_payments.empty? %>No changes<% end %>
          </span>
        </div>
      </div>
    </div>

    <%# Navigation %>
    <div class="flex justify-between pt-4 border-t border-gray-200">
      <%= render "shared/button", text: "Back: Payments", variant: "secondary", size: "medium", icon: "arrow-left", path: amend_payments_manage_contract_path(@contract) %>
      <%= form_with url: apply_amendments_manage_contract_path(@contract), method: :post, local: true, class: "inline" do %>
        <%= render "shared/button", text: "Apply Amendments", variant: "primary", size: "medium", icon: "check", type: :submit %>
      <% end %>
    </div>
  <% else %>
    <%# No Changes %>
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center mb-6">
      <%= icon("alert-triangle", class: "w-12 h-12 text-yellow-500 mx-auto mb-3") %>
      <h3 class="text-lg font-semibold text-yellow-800 mb-2">No Changes to Apply</h3>
      <p class="text-yellow-700 mb-4">You haven't made any changes to this contract.</p>
      <%= render "shared/button", text: "Go Back to Events", variant: "secondary", size: "medium", path: amend_bookings_manage_contract_path(@contract) %>
    </div>

    <div class="flex justify-center">
      <%= render "shared/button", text: "Cancel", variant: "secondary", size: "medium", path: manage_contract_path(@contract) %>
    </div>
  <% end %>

  </div>
</div>