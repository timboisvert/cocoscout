<% content_for :title, "Sign-ups" %>
<div class="w-full">
  <%= render partial: "shared/notice", locals: { notice: notice } %>
  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [
      ["Auditions", manage_production_auditions_path(@production)],
      ["Review", review_manage_production_audition_cycle_path(@production, @audition_cycle)]
    ],
    text: (@audition_cycle.audition_type == "video_upload") ? "Video Auditions" : "Sign-ups",
    links: []
  } %>

  <%= render partial: "manage/auditions/lifecycle_panel", locals: { current_step: :review } %>

  <%= render "shared/filters/filter_bar", filter_groups: [
    {
      label: "View",
      filters: [
        { text: "All", path: manage_production_audition_cycle_audition_requests_path(@production, @audition_cycle, filter: "all"), active: @filter == "all" },
        { text: "Unreviewed", path: manage_production_audition_cycle_audition_requests_path(@production, @audition_cycle, filter: "unreviewed"), active: @filter == "unreviewed" },
        { text: "Revisit", path: manage_production_audition_cycle_audition_requests_path(@production, @audition_cycle, filter: "undecided"), active: @filter == "undecided" },
        { text: "Yes", path: manage_production_audition_cycle_audition_requests_path(@production, @audition_cycle, filter: "accepted"), active: @filter == "accepted" },
        { text: "No", path: manage_production_audition_cycle_audition_requests_path(@production, @audition_cycle, filter: "passed"), active: @filter == "passed" }
      ]
    },
    { separator: true }
  ] %>

  <div class="grid grid-cols-1 gap-2 mb-4">
    <% if @audition_requests.any? %>
      <% @audition_requests.each do |audition_request| %>
        <div class="flex flex-col lg:flex-row bg-white w-full p-4 border border-gray-200 rounded-lg hover:border-gray-400 transition-all lg:items-center gap-4">
          <% requestable = audition_request.requestable %>
          <% if requestable.present? %>
            <%= link_to manage_production_audition_cycle_audition_request_path(@production, @audition_cycle, audition_request), class: "flex items-center gap-4", data: { turbo_prefetch: false } do %>
              <div class="flex items-center gap-4">
                <div class="flex-shrink-0">
                  <% headshot_url = safe_headshot_url(requestable) %>
                  <% if headshot_url %>
                    <%= image_tag headshot_url, class: "relative inline-block h-12 w-12 !rounded-lg object-cover object-center" %>
                  <% else %>
                    <% if requestable.is_a?(Person) %>
                      <div class="w-12 h-12 rounded-lg bg-gray-100 flex items-center justify-center text-black font-bold">
                        <%= requestable.initials %>
                      </div>
                    <% else %>
                      <%# Group without headshot %>
                      <div class="w-12 h-12 rounded-lg bg-purple-100 flex items-center justify-center text-purple-600 font-bold">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                      </div>
                    <% end %>
                  <% end %>
                </div>
                <div class="font-medium text-xl">
                  <%= truncate(requestable.name, length: 50, omission: "...") %>
                </div>
              </div>
            <% end %>
          <% else %>
            <div class="flex items-center gap-4">
              <div class="flex-shrink-0">
                <div class="w-12 h-12 rounded-lg bg-gray-300 flex items-center justify-center text-gray-600 font-bold">
                  ?
                </div>
              </div>
              <div class="font-medium text-xl text-gray-500">
                [Deleted]
              </div>
            </div>
          <% end %>

          <% if current_user_can_manage?(@production) %>
            <div class="grid grid-cols-4 gap-0 items-center lg:ml-auto w-full lg:w-auto">
              <%
                [:unreviewed, :undecided, :accepted, :passed].each do |status|
                  classes = "text-xs lg:text-sm px-2 py-1.5 lg:px-3 lg:py-2 text-center border border-gray-200 text-nowrap"

                  # Set the borders based on position in the list of statuses
                  if status == :unreviewed
                    classes += " rounded-l-lg"
                  elsif status == :undecided
                    classes += " border-l-0"
                  elsif status == :accepted
                    classes += " border-l-0"
                  elsif status == :passed
                    classes += " rounded-r-lg"
                  end

                  # Set the background color based on status
                  if audition_request.status == status.to_s
                    classes += " bg-pink-500 hover:bg-pink-600 text-white"
                  end
              %>
                <%= link_to manage_signup_status_name(status), set_status_manage_production_audition_cycle_audition_request_path(@production, @audition_cycle, audition_request, status: status), class: classes, data: { turbo_method: :post } %>
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>
    <% else %>

    <p class="text-gray-500 text-sm pt-2">
      <% if @filter.blank? || @filter == "all" %>
        No one has signed up for an audition yet.
      <% elsif @filter == "unreviewed" %>
        You have no unreviewed sign-ups
      <% elsif @filter == "undecided" %>
        You have no undecided sign-ups
      <% elsif @filter == "accepted" %>
        You haven't marked any sign-ups as a "yes"
      <% elsif @filter == "passed" %>
        You haven't marked any sign-ups as a "no"
      <% end %>
    </p>
  <% end %>
</div>
