<%# Audition Finalize Notification Form - Simplified (Built-in Groups Only) %>
<% if staged_casts.any? || unassigned_people.any? %>
  <% # Build cast_people arrays for each talent pool, only include pools with people %>
  <% cast_people_by_pool = {} %>
  <% staged_casts.each do |talent_pool| %>
    <% people = pending_stages.select { |s| s.talent_pool_id == talent_pool.id }.map(&:assignable) %>
    <% cast_people_by_pool[talent_pool.id] = people if people.any? %>
  <% end %>
  <% # Filter staged_casts to only those with people %>
  <% staged_casts_with_people = staged_casts.select { |tp| cast_people_by_pool[tp.id].present? } %>

  <%= form_with url: manage_finalize_and_notify_signups_auditions_cycle_path(@production, audition_cycle), method: :post, local: true do |f| %>
    <div class="mt-6" data-controller="tabs">
      <h4 class="text-lg font-semibold text-gray-900 mb-4">Email Notifications</h4>

    <%# Tabs - always show for visual consistency %>
    <nav class="flex flex-wrap gap-2 border-b border-gray-200 mb-4">
      <% staged_casts_with_people.each_with_index do |talent_pool, idx| %>
        <% cast_people = cast_people_by_pool[talent_pool.id] %>
        <button
          type="button"
          data-tabs-target="tab"
          data-index="<%= idx %>"
          data-action="click->tabs#select"
          class="px-4 py-2 text-sm font-medium border-b-2 <%= idx == 0 ? 'text-pink-600 border-pink-600' : 'text-gray-500 border-transparent' %> hover:text-pink-600"
        >
          Adding to <%= talent_pool.name %> (<%= cast_people.size %>)
        </button>
      <% end %>

      <% if unassigned_people.any? %>
        <button
          type="button"
          data-tabs-target="tab"
          data-index="<%= staged_casts_with_people.size %>"
          data-action="click->tabs#select"
          class="px-4 py-2 text-sm font-medium border-b-2 <%= staged_casts_with_people.empty? ? 'text-pink-600 border-pink-600' : 'text-gray-500 border-transparent' %> hover:text-pink-600"
        >
          Not Being Added (<%= unassigned_people.size %>)
        </button>
      <% end %>
    </nav>

    <%# Panel for each talent pool with people %>
    <% staged_casts_with_people.each_with_index do |talent_pool, idx| %>
      <% cast_people = cast_people_by_pool[talent_pool.id] %>
      <div data-tabs-target="panel" class="<%= 'hidden' if idx > 0 %>">
        <div class="mb-4">
          <h5 class="text-sm font-semibold text-gray-900 mb-3">Auditionees being added to <%= talent_pool.name %>:</h5>
          <div class="flex flex-wrap gap-2">
            <% cast_people.each do |auditionee| %>
              <% headshot_variant = auditionee.safe_headshot_variant(:thumb) %>
              <div class="inline-flex items-center gap-2 px-2 py-1 rounded text-xs font-medium border border-gray-200">
                <% if headshot_variant %>
                  <%= image_tag headshot_variant, alt: auditionee.name, class: "w-5 h-5 rounded object-cover flex-shrink-0", draggable: false %>
                <% else %>
                  <div class="w-5 h-5 rounded bg-gray-200 flex items-center justify-center text-black font-bold text-xs flex-shrink-0">
                    <%= auditionee.is_a?(Person) ? auditionee.initials : raw('<i class="fa-solid fa-users text-xs"></i>') %>
                  </div>
                <% end %>
                <span><%= auditionee.name %></span>
              </div>
            <% end %>
          </div>
        </div>

        <%= fields_for :cast_email_draft, EmailDraft.new(title: ContentTemplate.find_by(key: "audition_added_to_cast")&.subject || "Audition Results", body: ContentTemplateService.render_body("audition_added_to_cast", { recipient_name: "[Name]", production_name: @production.name, confirm_by_date: "[date]" })) do |email_form| %>
          <div class="space-y-3">
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">Subject</label>
              <%= email_form.text_field :title, class: "block w-full rounded-lg border border-gray-300 px-3 py-2 text-gray-900 placeholder:text-gray-400 focus:border-pink-500 focus:ring-pink-500 text-sm", placeholder: "Email subject..." %>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">Body</label>
              <%= email_form.rich_text_area :body, class: "w-full rounded-lg border border-gray-300 focus:ring-2 focus:ring-pink-500 focus:border-transparent" %>
            </div>
          </div>
        <% end %>

        <div class="mt-4 pt-4 border-t border-gray-200">
          <label class="flex items-center gap-3 cursor-pointer">
            <input
              type="checkbox"
              data-tabs-target="reviewCheckbox"
              data-pool-id="<%= talent_pool.id %>"
              data-action="change->tabs#checkAllReviewed"
              class="rounded accent-pink-500 border-gray-300 text-pink-600 focus:ring-pink-500"
            >
            <span class="text-sm text-gray-700">I have reviewed the recipient list and email text for this group</span>
          </label>
        </div>
      </div>
    <% end %>

    <%# Panel for unassigned people %>
    <% if unassigned_people.any? %>
      <div data-tabs-target="panel" class="<%= 'hidden' if staged_casts_with_people.any? %>">
        <div class="mb-4">
          <h5 class="text-sm font-semibold text-gray-900 mb-3">Auditionees not being added to the cast:</h5>
          <div class="flex flex-wrap gap-2">
            <% unassigned_people.each do |auditionee| %>
              <% headshot_variant = auditionee.safe_headshot_variant(:thumb) %>
              <div class="inline-flex items-center gap-2 px-2 py-1 rounded text-xs font-medium border border-gray-200">
                <% if headshot_variant %>
                  <%= image_tag headshot_variant, alt: auditionee.name, class: "w-5 h-5 rounded object-cover flex-shrink-0", draggable: false %>
                <% else %>
                  <div class="w-5 h-5 rounded bg-gray-200 flex items-center justify-center text-black font-bold text-xs flex-shrink-0">
                    <%= auditionee.is_a?(Person) ? auditionee.initials : raw('<i class="fa-solid fa-users text-xs"></i>') %>
                  </div>
                <% end %>
                <span><%= auditionee.name %></span>
              </div>
            <% end %>
          </div>
        </div>

        <%= fields_for :not_cast_email_draft, EmailDraft.new(title: ContentTemplate.find_by(key: "audition_not_cast")&.subject || "Audition Results", body: ContentTemplateService.render_body("audition_not_cast", { recipient_name: "[Name]", production_name: @production.name })) do |email_form| %>
          <div class="space-y-3">
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">Subject</label>
              <%= email_form.text_field :title, class: "block w-full rounded-lg border border-gray-300 px-3 py-2 text-gray-900 placeholder:text-gray-400 focus:border-pink-500 focus:ring-pink-500 text-sm", placeholder: "Email subject..." %>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">Body</label>
              <%= email_form.rich_text_area :body, class: "w-full rounded-lg border border-gray-300 focus:ring-2 focus:ring-pink-500 focus:border-transparent" %>
            </div>
          </div>
        <% end %>

        <div class="mt-4 pt-4 border-t border-gray-200">
          <label class="flex items-center gap-3 cursor-pointer">
            <input
              type="checkbox"
              data-tabs-target="reviewCheckbox"
              data-action="change->tabs#checkAllReviewed"
              data-pool-id="unassigned"
              class="rounded accent-pink-500 border-gray-300 text-pink-600 focus:ring-pink-500"
            >
            <span class="text-sm text-gray-700">I have reviewed the recipient list and email text for this group</span>
          </label>
        </div>
      </div>
    <% end %>

    <%# Send notifications section (shown when all groups are reviewed) %>
    <div class="hidden mt-6 p-4 bg-pink-50 border border-pink-200 rounded-lg" data-tabs-target="sendSection">
      <h4 class="text-sm font-semibold text-gray-900 mb-2">Ready to Send Notifications and Reveal Decisions</h4>
      <p class="text-sm text-gray-700 mb-4">
        All email groups have been reviewed. Click the button below to finalize cast changes and send notification emails to all auditionees.
      </p>
      <%= render "shared/button",
        text: "Finalize Cast Changes & Send Notifications",
        variant: "primary",
        size: "medium",
        type: :submit %>
    </div>
    </div>
  <% end %>
<% end %>

