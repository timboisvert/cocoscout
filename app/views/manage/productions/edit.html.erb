<% content_for :title, "Edit #{@production.name}" %>

<div class="w-full">

  <%= render partial: "shared/notice", locals: { notice: notice } %>

  <!-- Production Info Card -->
  <%= render "manage/productions/production_info_card", production: @production %>

  <!-- Tabs Section -->
  <div class="w-full" data-controller="tabs">
    <nav class="flex space-x-2 border-b border-gray-200 mb-4 overflow-x-auto">
      <button type="button" data-tabs-target="tab" data-index="0" data-action="tabs#select" class="px-4 py-2 text-sm font-medium bg-white border-b-2 text-pink-600 cursor-pointer whitespace-nowrap">Basic Information</button>
      <button type="button" data-tabs-target="tab" data-index="1" data-action="tabs#select" class="px-4 py-2 text-sm font-medium bg-gray-50 border-b-2 text-gray-500 cursor-pointer whitespace-nowrap">Visual Assets</button>
      <button type="button" data-tabs-target="tab" data-index="2" data-action="tabs#select" class="px-4 py-2 text-sm font-medium bg-gray-50 border-b-2 text-gray-500 cursor-pointer whitespace-nowrap">Notes</button>
      <% unless @production.type_third_party? %>
        <button type="button" data-tabs-target="tab" data-index="3" data-action="tabs#select" class="px-4 py-2 text-sm font-medium bg-gray-50 border-b-2 text-gray-500 cursor-pointer whitespace-nowrap">Production Team</button>
        <button type="button" data-tabs-target="tab" data-index="4" data-action="tabs#select" class="px-4 py-2 text-sm font-medium bg-gray-50 border-b-2 text-gray-500 cursor-pointer whitespace-nowrap">Agreement</button>
        <button type="button" data-tabs-target="tab" data-index="5" data-action="tabs#select" class="px-4 py-2 text-sm font-medium bg-gray-50 border-b-2 text-gray-500 cursor-pointer whitespace-nowrap">Public Listing</button>
        <button type="button" data-tabs-target="tab" data-index="6" data-action="tabs#select" class="px-4 py-2 text-sm font-medium bg-gray-50 border-b-2 text-red-500 cursor-pointer whitespace-nowrap">Danger Zone</button>
      <% else %>
        <button type="button" data-tabs-target="tab" data-index="3" data-action="tabs#select" class="px-4 py-2 text-sm font-medium bg-gray-50 border-b-2 text-red-500 cursor-pointer whitespace-nowrap">Danger Zone</button>
      <% end %>
    </nav>

    <!-- Tab 1: Basic Information -->
    <div data-tabs-target="panel">
      <%= form_with(model: [:manage, @production], class: "contents") do |form| %>
        <!-- Production Details Card -->
        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden mb-6">
          <%= render "shared/card_header", title: "Production Details" %>
          <div class="p-6 space-y-6">
            <div>
              <%= form.label :name, "Production Name", class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= form.text_field :name, class: ["block w-full rounded-lg border px-3 py-2 shadow-sm focus:border-pink-500 focus:ring-pink-500", {"border-gray-300": @production.errors[:name].none?, "border-pink-500": @production.errors[:name].any?}], placeholder: "Enter production name" %>
              <% if @production.errors[:name].any? %>
                <p class="mt-1 text-sm text-pink-600"><%= @production.errors[:name].first %></p>
              <% end %>
            </div>

            <% unless @production.type_third_party? %>
              <div>
                <%= form.label :description, "Description", class: "block text-sm font-medium text-gray-700 mb-1" %>
                <p class="text-xs text-gray-500 mb-2">A brief description of your production shown on public listings</p>
                <%= form.textarea :description, rows: 4, class: ["block w-full rounded-lg border px-3 py-2 shadow-sm focus:border-pink-500 focus:ring-pink-500", {"border-gray-300": @production.errors[:description].none?, "border-pink-500": @production.errors[:description].any?}], placeholder: "Describe your production..." %>
              </div>
            <% end %>
          </div>
        </div>

        <% if @production.type_third_party? %>
          <%# Third-Party Contract Info %>
          <div class="bg-white border border-gray-200 rounded-lg overflow-hidden mb-6">
            <%= render "shared/card_header", title: "Contract Information" %>
            <div class="p-6">
              <% if @production.contract.present? %>
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm font-medium text-gray-900"><%= @production.contract.contractor_name %></p>
                    <p class="text-sm text-gray-500">
                      <% if @production.contract.contract_start_date && @production.contract.contract_end_date %>
                        <%= @production.contract.contract_start_date.strftime("%b %-d, %Y") %> - <%= @production.contract.contract_end_date.strftime("%b %-d, %Y") %>
                      <% else %>
                        Contract dates not set
                      <% end %>
                    </p>
                  </div>
                  <%= render "shared/button", text: "View Contract", variant: "secondary", size: "small", path: manage_contract_path(@production.contract) %>
                </div>
              <% else %>
                <p class="text-sm text-gray-500">This production was created from a third-party contract.</p>
              <% end %>
            </div>
          </div>
        <% else %>
          <!-- Contact Settings Card -->
          <div class="bg-white border border-gray-200 rounded-lg overflow-hidden mb-6">
            <%= render "shared/card_header", title: "Contact Settings" %>
            <div class="p-6">
              <div>
                <%= form.label :contact_email, "Contact Email", class: "block text-sm font-medium text-gray-700 mb-1" %>
                <p class="text-xs text-gray-500 mb-2">Used for automated emails and public inquiries</p>
                <%= form.email_field :contact_email, autocapitalize: "none", class: ["block w-full rounded-lg border px-3 py-2 shadow-sm focus:border-pink-500 focus:ring-pink-500", {"border-gray-300": @production.errors[:contact_email].none?, "border-pink-500": @production.errors[:contact_email].any?}], placeholder: "contact@example.com" %>
                <% if @production.errors[:contact_email].any? %>
                  <p class="mt-1 text-sm text-pink-600"><%= @production.errors[:contact_email].first %></p>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>

        <!-- Save Button -->
        <div class="flex justify-end">
          <%= render "shared/button", text: "Save Changes", variant: "primary", size: "medium", type: :submit %>
        </div>
      <% end %>
    </div>

    <!-- Tab 2: Visual Assets -->
    <div data-tabs-target="panel" class="hidden" data-controller="visual-assets-modal" data-visual-assets-modal-create-poster-path-value="<%= manage_create_poster_production_visual_asset_path(@production) %>">
      <!-- Logo Card -->
      <div class="bg-white border border-gray-200 rounded-lg overflow-hidden mb-6">
        <%= render "shared/card_header", title: "Logo" %>
        <div class="p-6">
          <% logo_variant = @production.safe_logo_variant(:small) %>
          <% if logo_variant %>
            <%= image_tag logo_variant, class: "h-auto max-h-32" %>
            <% if current_user_can_manage?(@production) %>
              <div class="mt-4">
                <%= render "shared/button", text: "Replace Logo", variant: "secondary", size: "medium", type: :button, data: { action: "click->visual-assets-modal#openLogoModal" } %>
              </div>
            <% end %>
          <% else %>
            <p class="text-sm text-gray-500 mb-4">No logo added.</p>
            <% if current_user_can_manage?(@production) %>
              <%= render "shared/button", text: "Upload Logo", variant: "secondary", size: "medium", type: :button, data: { action: "click->visual-assets-modal#openLogoModal" } %>
            <% end %>
          <% end %>
        </div>
      </div>

      <!-- Posters Card -->
      <div class="bg-white border border-gray-200 rounded-lg overflow-hidden mb-6">
        <%= render "shared/card_header", title: "Posters" %>
        <div class="p-6">
          <% if @production.posters.any? %>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 w-full">
              <% @production.posters.each do |poster| %>
                <div class="bg-gray-50 rounded-lg shadow p-4 flex flex-col <%= 'ring-2 ring-pink-500' if poster.is_primary %>">
                  <% image_variant = poster.safe_image_variant(:small) %>
                  <% if image_variant %>
                    <%= image_tag image_variant, class: "w-full h-auto object-cover mb-2 rounded" %>
                  <% end %>

                  <div class="flex items-center gap-2 mb-2">
                    <span class="font-semibold flex-1"><%= poster.name.presence || "Untitled Poster" %></span>
                    <% if poster.is_primary %>
                      <span class="inline-flex items-center rounded-md bg-pink-50 px-2 py-1 text-xs font-medium text-pink-700 ring-1 ring-inset ring-pink-600/10">Primary</span>
                    <% end %>
                  </div>

                  <% if current_user_can_manage?(@production) %>
                    <div class="flex flex-wrap gap-2 mt-2">
                      <% unless poster.is_primary %>
                        <%= link_to "Set as Primary", manage_set_primary_poster_production_visual_asset_path(@production, poster), data: { turbo_method: :patch }, class: "text-sm underline text-pink-500 hover:text-pink-600" %>
                      <% end %>
                      <button type="button" data-action="click->visual-assets-modal#openEditPosterModal" data-poster-id="<%= poster.id %>" data-poster-name="<%= poster.name %>" data-poster-image-url="<%= image_variant ? url_for(image_variant) : '' %>" data-edit-poster-path="<%= manage_update_poster_production_visual_asset_path(@production, poster) %>" class="text-sm underline text-pink-500 hover:text-pink-600 cursor-pointer">Edit</button>
                      <%= link_to "Delete", manage_destroy_poster_production_visual_asset_path(@production, poster), data: { turbo_method: :delete, turbo_confirm: "Are you sure you want to delete this poster?" }, class: "text-sm underline text-pink-500 hover:text-pink-600" %>
                    </div>
                  <% end %>
                </div>
              <% end %>
            </div>
            <% if current_user_can_manage?(@production) %>
              <div class="mt-4">
                <%= render "shared/button", text: "Add Poster", variant: "secondary", size: "medium", type: :button, data: { action: "click->visual-assets-modal#openNewPosterModal" } %>
              </div>
            <% end %>
          <% else %>
            <p class="text-sm text-gray-500 mb-4">No posters added.</p>
            <% if current_user_can_manage?(@production) %>
              <%= render "shared/button", text: "Add Poster", variant: "secondary", size: "medium", type: :button, data: { action: "click->visual-assets-modal#openNewPosterModal" } %>
            <% end %>
          <% end %>
        </div>
      </div>

      <!-- Logo Modal -->
      <div data-visual-assets-modal-target="logoModal" data-action="click->visual-assets-modal#closeLogoModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-lg w-full" data-action="click->visual-assets-modal#stopPropagation">
          <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-xl font-semibold text-gray-900 coustard-regular"><%= @production.logo.attached? ? "Replace Logo" : "Upload Logo" %></h2>
          </div>
          <div class="p-6">
            <% if @production.logo.attached? %>
              <div class="mb-4">
                <p class="text-sm font-medium text-gray-700 mb-2">Current Logo</p>
                <%= image_tag @production.logo, class: "h-20 object-contain bg-gray-50 rounded p-2" %>
              </div>
            <% end %>
            <%= form_with model: [:manage, @production], url: (@production.logo.attached? ? manage_update_logo_production_visual_asset_path(@production, :logo) : manage_create_logo_production_visual_asset_path(@production)), method: (@production.logo.attached? ? :patch : :post), local: true do |f| %>
              <div class="mb-4">
                <%= f.label :logo, "Logo Image", class: "block text-sm font-medium text-gray-700 mb-2" %>
                <span class="text-sm text-gray-500">(PNG, JPG, or GIF)</span>
                <div class="block shadow-sm rounded-lg border px-3 py-2 mt-2 border-gray-300">
                  <%= f.file_field :logo, class: "w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:text-white file:bg-pink-500 hover:file:bg-pink-600", accept: "image/*" %>
                </div>
              </div>
              <div class="flex justify-end gap-3">
                <%= render "shared/button", text: "Cancel", variant: "secondary", size: "medium", type: :button, data: { action: "click->visual-assets-modal#closeLogoModal" } %>
                <%= render "shared/button", text: (@production.logo.attached? ? "Update Logo" : "Upload Logo"), variant: "primary", size: "medium", type: :submit %>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Poster Modal -->
      <div data-visual-assets-modal-target="posterModal" data-action="click->visual-assets-modal#closePosterModal keydown.esc@window->visual-assets-modal#closePosterModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-lg w-full" data-action="click->visual-assets-modal#stopPropagation">
          <div class="px-6 py-4 border-b border-gray-200">
            <h2 data-visual-assets-modal-target="posterModalTitle" class="text-xl font-semibold text-gray-900 coustard-regular">Add a Poster</h2>
          </div>
          <div class="p-6">
            <form data-visual-assets-modal-target="posterForm" action="<%= manage_create_poster_production_visual_asset_path(@production) %>" method="post" enctype="multipart/form-data">
              <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
              <input type="hidden" data-visual-assets-modal-target="posterIdField" name="poster[id]" value="">
              <!-- Current Poster Preview (shown only when editing) -->
              <div data-visual-assets-modal-target="currentPosterPreview" class="hidden mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Current Poster</label>
                <div class="bg-gray-50 rounded p-2 inline-block">
                  <img src="" alt="Current poster" class="max-h-32 object-contain">
                </div>
              </div>
              <div class="mb-4">
                <label for="poster_image" class="block text-sm font-medium text-gray-700 mb-2">Poster Image</label>
                <span class="text-sm text-gray-500">(PDF, JPG, or PNG)</span>
                <div class="block shadow-sm rounded-lg border px-3 py-2 mt-2 border-gray-300">
                  <input type="file" id="poster_image" name="poster[image]" data-visual-assets-modal-target="posterImage" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:text-white file:bg-pink-500 hover:file:bg-pink-600" accept="image/*,.pdf">
                </div>
              </div>
              <div class="mb-4">
                <label for="poster_name" class="block text-sm font-medium text-gray-700 mb-2">Poster Name/Description <span class="text-gray-500 font-normal">(optional)</span></label>
                <input type="text" id="poster_name" name="poster[name]" data-visual-assets-modal-target="posterName" class="block w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm">
              </div>
              <div class="flex justify-end gap-3">
                <%= render "shared/button", text: "Cancel", variant: "secondary", size: "medium", type: :button, data: { action: "click->visual-assets-modal#closePosterModal" } %>
                <%= render "shared/button", text: "Add Poster", variant: "primary", size: "medium", type: :submit, data: { "visual-assets-modal-target": "posterSubmitButton" } %>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab 3: Notes -->
    <div data-tabs-target="panel" class="hidden">
      <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
        <%= render "shared/card_header", title: "Production Notes" %>
        <div class="p-6">
          <p class="text-sm text-gray-500 mb-4">
            Use this space for production-wide notes, schedules, or any information you want to share with your team and cast.
          </p>
          <%= form_with(model: [:manage, @production], url: manage_production_path(@production), method: :patch, data: { turbo: true }) do |form| %>
            <div class="mb-4">
              <%= form.rich_text_area :notes, class: "min-h-[300px]" %>
            </div>
            <%= render "shared/button", text: "Save Notes", variant: "primary", size: "medium", type: :submit %>
          <% end %>
        </div>
      </div>
    </div>

    <% unless @production.type_third_party? %>
      <!-- Tab 4: Team -->
      <div data-tabs-target="panel" class="hidden">
        <%= render "team_permissions" %>
      </div>

      <!-- Tab 5: Agreement -->
      <div data-tabs-target="panel" class="hidden">
        <% templates = @production.organization.agreement_templates.active.order(:name) %>

        <!-- Agreement Settings Card -->
        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden mb-6">
          <%= render "shared/card_header", title: "Agreement Settings" %>
          <div class="p-6">
            <%= form_with(model: [:manage, @production], url: manage_production_path(@production), method: :patch) do |f| %>
              <% if templates.any? %>
                <div class="space-y-5">
                  <!-- Template Selection -->
                  <div class="max-w-md">
                    <label for="production_agreement_template_id" class="block text-sm font-medium text-gray-700 mb-1">
                      Agreement Template
                    </label>
                    <%= f.select :agreement_template_id,
                        options_for_select(
                          [["None - no agreement required", nil]] + templates.map { |t| [t.name, t.id] },
                          @production.agreement_template_id
                        ),
                        {},
                        class: "w-full rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-pink-500 focus:ring-pink-500" %>
                  </div>

                  <% if @production.agreement_template.present? %>
                    <!-- Enforcement Option -->
                    <div class="flex items-start gap-3 p-4 bg-gray-50 rounded-lg">
                      <%= f.check_box :agreement_required,
                          class: "mt-0.5 h-4 w-4 rounded border-gray-300 accent-pink-500" %>
                      <div>
                        <%= f.label :agreement_required, class: "text-sm font-medium text-gray-900" do %>
                          Require signature before casting
                        <% end %>
                        <p class="text-xs text-gray-500 mt-0.5">
                          Performers must sign this agreement before they can be assigned to shows.
                        </p>
                      </div>
                    </div>

                    <!-- Actions Row -->
                    <div class="flex items-center justify-between pt-2">
                      <%= link_to preview_manage_agreement_template_path(@production.agreement_template),
                          class: "inline-flex items-center gap-1.5 text-sm text-gray-600 hover:text-pink-600",
                          target: "_blank" do %>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                        </svg>
                        Preview
                      <% end %>
                      <%= render "shared/button", text: "Save", variant: "primary", size: "small", type: :submit %>
                    </div>
                  <% else %>
                    <div class="flex justify-end pt-2">
                      <%= render "shared/button", text: "Save", variant: "primary", size: "small", type: :submit %>
                    </div>
                  <% end %>
                </div>
              <% else %>
                <!-- No Templates Yet -->
                <div class="text-center py-8">
                  <svg class="mx-auto h-12 w-12 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                  <h3 class="mt-3 text-sm font-medium text-gray-900">No agreement templates</h3>
                  <p class="mt-1 text-sm text-gray-500">Create a template to require performers to sign before casting.</p>
                  <div class="mt-4">
                    <%= render "shared/button", text: "Create Template", variant: "primary", size: "small", path: new_manage_agreement_template_path %>
                  </div>
                </div>
              <% end %>
            <% end %>
          </div>
        </div>

        <% if templates.any? && !@production.agreement_template.present? %>
          <p class="text-sm text-gray-500 text-center">
            Or <%= link_to "manage your templates", manage_agreement_templates_path, class: "text-pink-600 hover:text-pink-700" %>
          </p>
        <% end %>

        <% if @production.agreement_required? %>
          <% stats = @production.agreement_signature_stats %>
          <% signed_people = @production.people_with_agreement_signature.includes(profile_headshots: { image_attachment: :blob }) %>
          <% unsigned_people = @production.people_without_agreement_signature.includes(profile_headshots: { image_attachment: :blob }) %>

          <!-- Signature Status Card -->
          <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
            <%= render "shared/card_header", title: "Signature Status" %>
            <div class="p-6">
              <% if stats[:total] == 0 %>
                <div class="text-center py-4">
                  <p class="text-sm text-gray-500">No performers in the talent pool yet.</p>
                </div>
              <% else %>
                <!-- Progress Section -->
                <div class="flex items-center gap-4 mb-2">
                  <div class="text-2xl font-bold text-gray-900"><%= stats[:signed] %><span class="text-gray-400 font-normal"> / <%= stats[:total] %></span></div>
                  <div class="text-sm text-gray-500">have signed</div>
                </div>
                <div class="w-full bg-gray-100 rounded-full h-1.5 mb-6">
                  <div class="bg-pink-500 h-1.5 rounded-full transition-all" style="width: <%= stats[:percent] %>%"></div>
                </div>

                <!-- Signed Section -->
                <% if signed_people.any? %>
                  <div class="mb-6">
                    <div class="flex items-center gap-2 mb-3">
                      <span class="text-xs font-medium text-gray-500 uppercase tracking-wide">Signed</span>
                      <span class="text-xs text-gray-400">(<%= signed_people.count %>)</span>
                    </div>
                    <div class="flex items-center -space-x-2">
                      <% signed_people.limit(15).each do |person| %>
                        <% headshot_variant = person.safe_headshot_variant(:thumb) %>
                        <span data-controller="tooltip" data-tooltip-text-value="<%= person.name %>" class="relative">
                          <% if headshot_variant %>
                            <%= image_tag rails_storage_proxy_url(headshot_variant),
                                alt: person.name,
                                class: "w-9 h-9 rounded-lg object-cover ring-2 ring-white hover:z-20 hover:scale-110 transition-transform cursor-default" %>
                          <% else %>
                            <div class="w-9 h-9 rounded-lg bg-pink-100 flex items-center justify-center text-pink-600 font-semibold text-xs ring-2 ring-white hover:z-20 hover:scale-110 transition-transform cursor-default">
                              <%= person.initials %>
                            </div>
                          <% end %>
                        </span>
                      <% end %>
                      <% if signed_people.count > 15 %>
                        <span data-controller="tooltip" data-tooltip-text-value="<%= signed_people.count - 15 %> more" class="relative">
                          <div class="w-9 h-9 rounded-lg bg-gray-100 flex items-center justify-center text-gray-500 font-semibold text-xs ring-2 ring-white">
                            +<%= signed_people.count - 15 %>
                          </div>
                        </span>
                      <% end %>
                    </div>
                  </div>
                <% end %>

                <!-- Awaiting Signature Section -->
                <% if unsigned_people.any? %>
                  <div>
                    <div class="flex items-center gap-2 mb-3">
                      <span class="text-xs font-medium text-gray-500 uppercase tracking-wide">Awaiting</span>
                      <span class="text-xs text-gray-400">(<%= unsigned_people.count %>)</span>
                    </div>
                    <div class="flex items-center -space-x-2 mb-4">
                      <% unsigned_people.limit(15).each do |person| %>
                        <% headshot_variant = person.safe_headshot_variant(:thumb) %>
                        <button type="button"
                                data-controller="compose-message"
                                data-action="click->compose-message#open"
                                data-compose-message-recipient-type-value="person"
                                data-compose-message-recipient-id-value="<%= person.id %>"
                                data-compose-message-recipient-name-value="<%= person.name %>"
                                data-compose-message-recipient-headshot-value="<%= headshot_variant ? rails_storage_proxy_url(headshot_variant) : '' %>"
                                data-compose-message-recipient-initials-value="<%= person.initials %>"
                                class="relative cursor-pointer group">
                          <span data-controller="tooltip" data-tooltip-text-value="<%= person.name %> â€” click to message">
                            <% if headshot_variant %>
                              <%= image_tag rails_storage_proxy_url(headshot_variant),
                                  alt: person.name,
                                  class: "w-9 h-9 rounded-lg object-cover ring-2 ring-white group-hover:ring-pink-400 hover:z-20 hover:scale-110 transition-all" %>
                            <% else %>
                              <div class="w-9 h-9 rounded-lg bg-gray-200 flex items-center justify-center text-gray-600 font-semibold text-xs ring-2 ring-white group-hover:ring-pink-400 hover:z-20 hover:scale-110 transition-all">
                                <%= person.initials %>
                              </div>
                            <% end %>
                          </span>
                        </button>
                      <% end %>
                      <% if unsigned_people.count > 15 %>
                        <span data-controller="tooltip" data-tooltip-text-value="<%= unsigned_people.count - 15 %> more" class="relative">
                          <div class="w-9 h-9 rounded-lg bg-gray-100 flex items-center justify-center text-gray-500 font-semibold text-xs ring-2 ring-white">
                            +<%= unsigned_people.count - 15 %>
                          </div>
                        </span>
                      <% end %>
                    </div>

                    <%# Prepare batch data for Send Reminder button %>
                    <%
                      unsigned_cast_members = unsigned_people.map do |person|
                        headshot_variant = person.safe_headshot_variant(:thumb)
                        {
                          id: person.id,
                          name: person.name,
                          headshot: headshot_variant ? rails_storage_proxy_url(headshot_variant) : nil
                        }
                      end

                      # Get agreement reminder template content
                      agreement_template = ContentTemplate.find_by(key: "request_agreement_signature")
                      template_subject = agreement_template&.subject&.gsub("{{production_name}}", @production.name) || "Please Sign the Agreement"
                      template_body = ContentTemplateService.render_body("request_agreement_signature", {
                        recipient_name: "[Name]",
                        production_name: @production.name,
                        agreement_url: my_production_agreement_url(@production)
                      }) || ""

                      # Put ALL data in the script tag
                      reminder_data = {
                        recipientType: "batch",
                        recipientName: "#{unsigned_people.count} performers",
                        castMembers: unsigned_cast_members,
                        batchPersonIds: unsigned_people.pluck(:id),
                        templateSubject: template_subject,
                        templateBody: template_body
                      }
                    %>
                    <script type="application/json" id="agreement-reminder-data-<%= @production.id %>"><%= reminder_data.to_json.html_safe %></script>
                    <button type="button"
                            data-controller="compose-message"
                            data-action="click->compose-message#openFromScript"
                            data-compose-message-script-id-value="agreement-reminder-data-<%= @production.id %>"
                            class="inline-flex items-center justify-center gap-2 font-medium rounded transition-colors cursor-pointer text-pink-600 border border-pink-300 hover:bg-pink-50 text-sm px-3 py-1.5">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5" />
                      </svg>
                      Send Reminder to All
                    </button>
                  </div>
                <% else %>
                  <div class="flex items-center gap-2 text-sm text-pink-600 font-medium">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Everyone has signed!
                  </div>
                <% end %>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>

      <!-- Tab 6: Public Profile -->
      <div data-tabs-target="panel" class="hidden" data-controller="production-profile-modals profile-visibility">
      <!-- Public Profile Card -->
      <div class="bg-white border border-gray-200 rounded-lg overflow-hidden mb-6">
        <%= render "shared/card_header", title: "Public Listing" %>
        <div class="p-6">
          <div class="space-y-4">
            <!-- Enable/Disable Toggle -->
            <%= form_with(model: [:manage, @production], url: manage_production_path(@production), method: :patch, data: { turbo: true, profile_visibility_target: "form" }) do |f| %>
              <div class="flex items-center justify-between">
                <div class="flex-1">
                  <p class="text-sm font-medium text-gray-700">Enable Public Listing</p>
                  <p class="text-xs text-gray-500 mt-1">
                    When enabled, this production will be visible to anyone with the listing URL
                  </p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer ml-4">
                  <%= f.check_box :public_profile_enabled,
                    { class: "sr-only peer",
                      data: {
                        action: "change->profile-visibility#toggle",
                        profile_visibility_target: "checkbox"
                      }
                    } %>
                  <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
                </label>
              </div>
            <% end %>

            <!-- Profile Content (shown when enabled) -->
            <div data-profile-visibility-target="content" class="pt-4 border-t border-gray-200 <%= 'hidden' unless @production.public_profile_enabled %>">
              <!-- URL Box -->
              <% if @production.public_key.present? %>
                <%= render "shared/copy_url", url: public_profile_url(@production.public_key), label: "#{@production.name}'s Public Listing URL" %>
                <p class="mt-1 mb-4 text-xs text-gray-500">
                  <a href="javascript:void(0)" data-action="click->production-profile-modals#openChangeUrl" class="text-pink-500 hover:text-pink-600 underline">Change URL</a>
                </p>

                <!-- Action Buttons -->
                <div class="flex flex-wrap gap-3">
                  <%= render "shared/button",
                      text: "View Public Listing",
                      variant: "primary",
                      icon: "eye",
                      path: public_profile_url(@production.public_key),
                      target: "_blank",
                      rel: "noopener" %>
                  <%= render "shared/button",
                      text: "Share Listing",
                      variant: "outline",
                      icon: "share",
                      data: { action: "click->production-profile-modals#openShare" },
                      type: :button %>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </div>

      <!-- Profile Sections (shown when enabled) -->
      <div data-profile-visibility-target="sections" class="<%= 'hidden' unless @production.public_profile_enabled %>">
        <!-- Features Card -->
        <%= turbo_frame_tag "features_frame" do %>
          <%= render "manage/productions/features_card", production: @production %>
        <% end %>
      </div>

      <% if @production.public_key.present? %>
      <!-- Share Modal -->
      <div data-production-profile-modals-target="shareModal" data-action="click->production-profile-modals#closeModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full" data-action="click->production-profile-modals#stopPropagation">
          <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
            <h2 class="text-xl font-semibold text-gray-900 coustard-regular">Share Production Listing</h2>
            <button type="button" data-action="click->production-profile-modals#closeModal" class="text-gray-400 hover:text-gray-500 cursor-pointer">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
          <div class="p-6 space-y-6">
            <% profile_url = public_profile_url(@production.public_key) if @production.public_key.present? %>
            <div data-controller="copy-url">
              <label class="block text-sm font-medium text-gray-700 mb-2">Production Listing URL</label>
              <div class="flex items-center gap-2">
                <input type="text" readonly value="<%= profile_url %>" class="flex-1 px-3 py-2 text-sm bg-gray-50 border border-gray-300 rounded-lg focus:outline-none">
                <button type="button" data-action="click->copy-url#copy" data-url="<%= profile_url %>" class="px-4 py-2 text-sm font-medium text-pink-500 hover:text-pink-600 hover:bg-pink-50 rounded-lg transition-colors cursor-pointer">
                  <span data-copy-url-target="buttonText">Copy</span>
                </button>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-3">Share on social media</label>
              <div class="flex items-center justify-center gap-4">
                <a href="https://www.facebook.com/sharer/sharer.php?u=<%= CGI.escape(profile_url.to_s) %>" target="_blank" rel="noopener" class="flex items-center justify-center w-12 h-12 text-white bg-[#1877F2] hover:bg-[#0d65d9] rounded-full transition-colors">
                  <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                  </svg>
                </a>
                <a href="https://twitter.com/intent/tweet?url=<%= CGI.escape(profile_url.to_s) %>&text=Check%20out%20this%20production%20on%20CocoScout" target="_blank" rel="noopener" class="flex items-center justify-center w-12 h-12 text-white bg-black hover:bg-gray-800 rounded-full transition-colors">
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                  </svg>
                </a>
                <a href="https://www.linkedin.com/sharing/share-offsite/?url=<%= CGI.escape(profile_url.to_s) %>" target="_blank" rel="noopener" class="flex items-center justify-center w-12 h-12 text-white bg-[#0A66C2] hover:bg-[#004182] rounded-full transition-colors">
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                  </svg>
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Change URL Modal -->
      <div data-production-profile-modals-target="changeUrlModal" data-action="click->production-profile-modals#closeModal keydown.esc@window->production-profile-modals#closeModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full" data-action="click->production-profile-modals#stopPropagation" data-controller="url-checker" data-url-checker-check-url-value="<%= check_url_availability_manage_production_path(@production) %>">
          <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-xl font-semibold text-gray-900 coustard-regular">Change Public Profile URL</h2>
          </div>
          <div class="p-6">
            <%= form_with(model: [:manage, @production], url: update_public_key_manage_production_path(@production), method: :patch, data: { url_checker_target: "form" }) do |f| %>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Current URL</label>
                  <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                    <div class="text-sm font-mono text-gray-600"><%= public_profile_url(@production.public_key) %></div>
                  </div>
                </div>
                <div>
                  <%= f.label :public_key, "New URL", class: "block text-sm font-medium text-gray-700 mb-2" %>
                  <div class="flex items-center gap-2">
                    <span class="text-sm text-gray-500"><%= request.base_url %>/</span>
                    <%= f.text_field :public_key, value: "", placeholder: "your-new-url", pattern: "[a-z0-9][a-z0-9\\-]{2,29}", class: "flex-1 rounded-lg border border-gray-300 px-3 py-2 shadow-sm focus:border-pink-500 focus:ring-pink-500", data: { url_checker_target: "input", action: "input->url-checker#inputChanged" } %>
                  </div>
                  <p class="mt-2 text-xs text-gray-500">3-30 characters: lowercase letters, numbers, hyphens only</p>
                </div>

                <!-- Status Message -->
                <div data-url-checker-target="message" class="rounded-lg border p-3 text-sm hidden"></div>
              </div>
              <div class="flex items-center justify-end gap-3 mt-6 pt-4 border-t border-gray-200">
                <%= render "shared/button",
                    text: "Cancel",
                    variant: "ghost-cancel",
                    data: { action: "click->production-profile-modals#closeModal" },
                    type: :button %>
                <%= render "shared/button",
                    text: "Check Availability",
                    variant: "primary",
                    size: "medium",
                    data: { action: "click->url-checker#checkAvailability", url_checker_target: "checkButton" },
                    type: :button %>
                <%= render "shared/button",
                    text: "Update URL",
                    variant: "primary",
                    size: "medium",
                    data: { action: "click->url-checker#submitForm", url_checker_target: "updateButton" },
                    style: "display: none;",
                    type: :button %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
      <% end %>
    </div>
    <% end %><%# end unless type_third_party %>

    <!-- Danger Zone Tab -->
    <div data-tabs-target="panel" class="hidden">
      <div class="bg-red-50 border border-red-200 rounded-lg p-6">
        <div class="flex items-start gap-4">
          <div class="flex-shrink-0">
            <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
            </svg>
          </div>
          <div class="flex-1">
            <h3 class="text-lg font-semibold text-red-800 mb-2">Delete this Production</h3>
            <p class="text-sm text-red-700 mb-4">
              Deleting this production is <strong>permanent and cannot be undone</strong>. This action will remove the production and all associated data from the system.
            </p>
            <p class="text-sm text-red-700 mb-4">
              Before deleting, please review what will be removed. You'll be asked to confirm on the next page.
            </p>
            <div class="mt-6">
              <%= render "shared/button",
                  text: "Delete this production",
                  variant: "danger",
                  size: "medium",
                  path: confirm_delete_manage_production_path(@production),
                  icon: "trash" %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<%# Compose Message Modal - required for agreement reminder buttons %>
<%= render "shared/compose_message_modal" %>