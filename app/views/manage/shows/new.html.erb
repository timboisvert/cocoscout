<% content_for :title, "Add a Show" %>

<div class="w-full">

  <%= render partial: "shared/notice", locals: { notice: notice } %>

  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [
      ["Shows & Events", manage_production_shows_path(@production)]
    ],
    text: "Schedule Shows & Events",
    links: []
  } %>

  <%= form_with(model: [:manage, @production, @show], class: "contents", data: { controller: "recurring-event" }) do |form| %>
    <% if @show.errors.any? %>
      <div id="error_explanation" class="bg-red-50 text-red-500 px-3 py-2 font-medium rounded-lg mt-3">
        <h2><%= pluralize(show.errors.count, "error") %> prohibited this show from being saved:</h2>

        <ul class="list-disc ml-6">
          <% @show.errors.each do |error| %>
            <li><%= error.full_message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="w-full">
      <%= form.label :event_type, "Event Type" %>
      <%= form.select :event_type,
          Show.event_types.keys.map { |type| [type.titleize, type] },
          { include_blank: false },
          {
            class: ["block shadow-sm rounded-lg border px-3 py-2 mt-2 w-full sm:w-64", {"border-gray-400": @show.errors[:event_type].none?, "border-pink-500": @show.errors[:event_type].any?}],
            data: {
              recurring_event_target: "eventTypeSelect",
              action: "change->recurring-event#updateButtonText"
            }
          }
      %>
    </div>

    <div class="w-full mt-5">
      <%= form.label :location_id, "Location" %>
      <%= form.collection_select :location_id, Current.production_company.locations.all, :id, :name, { prompt: "Select a location" }, { class: ["block shadow-sm rounded-lg border px-3 py-2 mt-2 w-full sm:w-96", ( @show.errors[:location_id].any? ? "border-pink-500" : "border-gray-400" )], required: true } %>
      <div class="mt-1 ml-1">
        <%= link_to "Manage Locations", manage_locations_path, class: "text-pink-500 underline text-sm" %>
      </div>
    </div>

    <div class="w-full mt-5">
      <%= render partial: "shared/top_menu", locals: {
        breadcrumbs: [],
        text: "Schedule",
        links: []
      } %>
    </div>

    <div class="w-full">
      <div class="mb-4">
        <%= form.label :event_frequency, "Event Frequency" %>
        <%= form.select :event_frequency,
            [
              ["Single Event", "single"],
              ["Recurring Event", "recurring"]
            ],
            { selected: "single" },
            {
              class: "block shadow-sm rounded-lg border border-gray-400 px-3 py-2 mt-2 w-full sm:w-64",
              data: { action: "change->recurring-event#toggle" }
            }
        %>
      </div>

      <!-- Single Event Fields -->
      <div data-recurring-event-target="singleFields">
        <%= form.label :date_and_time, "Date and Time" %>
        <%= form.datetime_field :date_and_time, class: ["block shadow-sm rounded-lg border px-3 py-2 mt-2 w-full sm:w-64", {"border-gray-400": @show.errors[:date_and_time].none?, "border-pink-500": @show.errors[:date_and_time].any?}] %>
      </div>

      <!-- Recurring Event Fields -->
      <div data-recurring-event-target="recurringFields" class="hidden space-y-4">
        <div>
          <%= form.label :recurrence_start_datetime, "Start Date and Time" %>
          <%= form.datetime_field :recurrence_start_datetime,
              class: "block shadow-sm rounded-lg border border-gray-400 px-3 py-2 mt-2 w-full sm:w-64",
              data: { action: "change->recurring-event#updatePatternOptions" } %>
        </div>

        <div>
          <%= form.label :recurrence_pattern, "Repeat Pattern" %>
          <%= form.select :recurrence_pattern,
              [
                ["Weekly (same day each week)", "weekly"],
                ["Every other week", "biweekly"],
                ["Monthly (same date each month)", "monthly_date"],
                ["Monthly (same week and day)", "monthly_week"]
              ],
              { include_blank: "Select pattern" },
              {
                class: "block shadow-sm rounded-lg border border-gray-400 px-3 py-2 mt-2 w-full sm:w-96",
                data: { recurring_event_target: "patternSelect" }
              }
          %>
        </div>
        <div>
          <%= form.label :recurrence_end_type, "Duration" %>
          <%= form.select :recurrence_end_type,
              [
                ["3 Months", "3_months"],
                ["6 Months", "6_months"],
                ["12 Months", "12_months"],
                ["Until End of #{Date.current.year}", "end_of_year"],
                ["Until Specific Date", "custom"]
              ],
              { include_blank: "Select duration" },
              {
                class: "block shadow-sm rounded-lg border border-gray-400 px-3 py-2 mt-2 w-full sm:w-96",
                data: { action: "change->recurring-event#toggleCustomEndDate" }
              }
          %>
        </div>

        <div data-recurring-event-target="customEndDateField" class="hidden">
          <%= form.label :recurrence_custom_end_date, "End Date" %>
          <%= form.date_field :recurrence_custom_end_date, class: "block shadow-sm rounded-lg border border-gray-400 px-3 py-2 mt-2 w-full sm:w-64" %>
        </div>
      </div>
    </div>

    <div class="w-full border-t border-gray-200 pt-5 my-5">
      <%= form.submit "Schedule Show",
          data: { recurring_event_target: "submitButton" },
          class: "sm:w-auto rounded-lg px-3.5 py-2.5 text-white bg-pink-500 hover:bg-pink-600 focus:ring-4 focus:outline-none focus:ring-pink-300 dark:focus:ring-pink-800 inline-block font-medium cursor-pointer" %>
      <%= link_to "Back", 'javascript:history.back()', class: "sm:w-auto rounded-lg px-3.5 py-2.5 text-pink-500 bg-gray-200 hover:bg-pink-600 hover:text-white focus:ring-4 focus:outline-none focus:ring-pink-300 dark:focus:ring-pink-800 inline-block font-medium cursor-pointer" %>
    </div>

  <% end %>


</div>
