<% pending_stages_local = @cast_assignment_stages.where(status: :pending) %>
<% staged_casts = @casts.select { |cast| pending_stages_local.any? { |stage| stage.cast_id == cast.id } } %>
<% # Get person IDs to exclude: pending, finalized stages, and people already notified for rejections %>
<% assigned_person_ids = pending_stages_local.pluck(:person_id).uniq %>
<% notified_person_ids = notified_stages.map(&:person_id).uniq %>
<% # Also exclude people who were notified of rejection for this cycle %>
<% rejection_notified_person_ids = @auditioned_people.select { |p| p.casting_notification_sent_at.present? && p.notified_for_audition_cycle_id == @audition_cycle.id }.map(&:id) %>
<% excluded_person_ids = (assigned_person_ids + notified_person_ids + rejection_notified_person_ids).uniq %>
<% unassigned_people = @auditioned_people.reject { |person| excluded_person_ids.include?(person.id) } %>

<%# Show the box if: notifications not sent yet OR there are new pending stages to notify %>
<% show_notify_box = !has_sent_notifications || pending_stages_local.any? %>

<% if show_notify_box %>
  <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden my-6">
    <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
      <h3 class="text-md font-semibold text-gray-900 coustard-regular">Finalize Casting and Notify</h3>
    </div>
    <div class="p-6">
      <% if has_sent_notifications && pending_stages_local.empty? %>
        <%# After notifications sent and no new changes - show finalized message with toggle %>
        <div data-controller="show-toggle">
          <div data-show-toggle-target="finalizedBox" class="mb-4 p-4 bg-green-50 border border-green-200 rounded-lg">
            <div class="flex items-start gap-3">
              <div class="flex-shrink-0">
                <svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
              </div>
              <div class="flex-1">
                <h4 class="text-sm font-semibold text-green-900 mb-1">Casting Notifications Finalized</h4>
                <% notified_people_count = notified_stages.map(&:person_id).uniq.count %>
                <p class="text-sm text-green-800 mb-3">
                  Notification emails have been sent to <%= notified_people_count %> <%= 'person'.pluralize(notified_people_count) %>. To make changes and send additional notifications, click the button below.
                </p>
                <button
                  type="button"
                  data-action="click->show-toggle#toggle"
                  class="font-medium rounded-lg text-sm px-4 py-2 text-center text-white bg-green-600 hover:bg-green-700 transition cursor-pointer"
                >
                  Edit Invitations & Send More Notifications
                </button>
              </div>
            </div>
          </div>

          <div data-show-toggle-target="content" class="hidden">
            <%= render "finalize_notify_form", audition_cycle: audition_cycle, pending_stages: pending_stages_local, staged_casts: staged_casts, unassigned_people: unassigned_people %>
          </div>
        </div>
      <% elsif has_sent_notifications && pending_stages_local.any? %>
        <%# After notifications sent but there are new changes - show warning and form %>
        <div class="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
          <div class="flex items-start gap-3">
            <div class="flex-shrink-0">
              <svg class="w-5 h-5 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 9a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/>
              </svg>
            </div>
            <div class="flex-1">
              <h4 class="text-sm font-semibold text-yellow-900 mb-1">New Casting Changes Need Notification</h4>
              <% notified_people_count = notified_stages.map(&:person_id).uniq.count %>
              <% pending_people_count = pending_stages_local.map(&:person_id).uniq.count %>
              <p class="text-sm text-yellow-800 mb-0">
                <%= notified_people_count %> <%= 'person'.pluralize(notified_people_count) %> <%= notified_people_count == 1 ? 'has' : 'have' %> already been notified.
                <%= pending_people_count %> <%= 'person'.pluralize(pending_people_count) %> still need<%= pending_people_count == 1 ? 's' : '' %> to be notified.
              </p>
            </div>
          </div>
        </div>
        <%= render "finalize_notify_form", audition_cycle: audition_cycle, pending_stages: pending_stages_local, staged_casts: staged_casts, unassigned_people: unassigned_people %>
      <% else %>
        <%# Before notifications sent - show form directly %>
        <%= render "finalize_notify_form", audition_cycle: audition_cycle, pending_stages: pending_stages_local, staged_casts: staged_casts, unassigned_people: unassigned_people %>
      <% end %>
    </div>
  </div>
<% end %>
