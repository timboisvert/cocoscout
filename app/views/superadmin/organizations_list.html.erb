<% content_for :title, "Organizations - Superadmin" %>

<div class="w-full px-5 pt-5">
  <%= render partial: "shared/notice", locals: { notice: notice } %>

  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [
        ["Superadmin", superadmin_path]
    ],
    text: "Organizations",
    links: []
  } %>

  <!-- Search Bar -->
  <div class="mb-4 mt-4">
    <%= form_with url: organizations_list_path, method: :get, class: "flex gap-2" do |f| %>
      <div class="relative flex-1">
        <%= f.text_field :search,
            value: @search,
            placeholder: "Search by organization name or owner...",
            class: "w-full h-12 px-4 pl-10 pr-10 rounded border border-gray-300 focus:ring-2 focus:ring-pink-500 focus:border-transparent",
            autocomplete: "off" %>
        <svg class="absolute left-3 top-3.5 w-5 h-5 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
      </div>

      <%= render "shared/button",
          text: "Search",
          variant: "primary",
          size: "large",
          icon: "search",
          type: :submit %>
    <% end %>
  </div>

  <!-- Organizations table -->
  <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
    <%= render "shared/card_header", title: "Organizations" do %>
      <% if @search.present? %>
        <span class="text-sm font-normal text-gray-600">(filtered)</span>
      <% end %>
    <% end %>

    <% if @organizations.empty? %>
      <div class="text-center py-12 text-gray-500">
        No organizations found.
      </div>
    <% else %>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Organization</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Owner</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Productions</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Future Shows</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Team</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <% @organizations.each do |org| %>
              <tr class="hover:bg-gray-50 cursor-pointer" onclick="window.location='<%= organization_detail_path(org) %>'">
                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
                  <%= org.name %>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">
                  <div class="font-medium"><%= org.owner.person&.name || org.owner.email_address %></div>
                  <div class="text-xs text-gray-500"><%= org.owner.email_address %></div>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">
                  <%= org.created_at&.strftime("%b %d, %Y") %>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600 text-center">
                  <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-gray-100 text-gray-700 font-medium text-xs">
                    <%= org.productions.count %>
                  </span>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600 text-center">
                  <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-blue-100 text-blue-700 font-medium text-xs">
                    <%= org.productions.joins(:shows).where("shows.date_and_time >= ? AND shows.canceled = ?", Time.current, false).distinct.count %>
                  </span>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600 text-center">
                  <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-gray-100 text-gray-700 font-medium text-xs">
                    <%= org.users.count %>
                  </span>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <% if @pagy.pages > 1 %>
        <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
          <div class="flex-1 flex justify-between sm:hidden">
            <% if @pagy.previous %>
              <%= link_to "Previous", organizations_list_path(page: @pagy.previous, search: @search), class: "relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50" %>
            <% else %>
              <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-500 bg-white cursor-not-allowed">Previous</span>
            <% end %>
            <% if @pagy.next %>
              <%= link_to "Next", organizations_list_path(page: @pagy.next, search: @search), class: "ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50" %>
            <% else %>
              <span class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-500 bg-white cursor-not-allowed">Next</span>
            <% end %>
          </div>
          <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
            <div>
              <p class="text-sm text-gray-700">
                Showing page
                <span class="font-medium"><%= @pagy.page %></span>
                of
                <span class="font-medium"><%= @pagy.pages %></span>
                (<span class="font-medium"><%= @pagy.count %></span> total)
              </p>
            </div>
            <div class="flex gap-2">
              <% if @pagy.previous %>
                <%= link_to "Previous", organizations_list_path(page: @pagy.previous, search: @search), class: "relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50" %>
              <% else %>
                <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-300 bg-white cursor-not-allowed">Previous</span>
              <% end %>
              <% if @pagy.next %>
                <%= link_to "Next", organizations_list_path(page: @pagy.next, search: @search), class: "relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50" %>
              <% else %>
                <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-300 bg-white cursor-not-allowed">Next</span>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    <% end %>
  </div>

</div>
