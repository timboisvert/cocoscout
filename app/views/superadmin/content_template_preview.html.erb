<% content_for :title, "Preview: #{@template.name} - Superadmin" %>

<div class="w-full px-5 pt-5">
  <%= render partial: "shared/notice", locals: { notice: notice } %>

  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [
        ["Superadmin", superadmin_path],
        ["Content Templates", content_templates_path]
    ],
    text: "Preview: #{@template.name}",
    links: [
      { text: "Edit Template", path: content_template_edit_path(@template), color: "pink" }
    ]
  } %>

  <div class="mt-4" data-controller="content-template-preview tabs"
       data-content-template-preview-subject-template-value="<%= ERB::Util.html_escape(@template.subject) %>"
       data-content-template-preview-body-template-value="<%= ERB::Util.html_escape(@template.body) %>">

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
      <!-- Left Panel: Variables & Info -->
      <div class="lg:col-span-1 space-y-4">
        <!-- Template Info Card -->
        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
          <%= render "shared/card_header", title: "Template Info" %>
          <div class="p-4 space-y-3">
            <div>
              <label class="block text-xs font-medium text-gray-500 uppercase tracking-wider">Key</label>
              <code class="text-sm font-mono bg-gray-100 px-2 py-1 rounded block mt-1 break-all"><%= @template.key %></code>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-500 uppercase tracking-wider">Category</label>
              <span class="text-sm text-gray-900"><%= @template.category&.titleize || "Uncategorized" %></span>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-500 uppercase tracking-wider">Status</label>
              <% if @template.active? %>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                  Active
                </span>
              <% else %>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600">
                  Inactive
                </span>
              <% end %>
            </div>

            <!-- Channel -->
            <div>
              <label class="block text-xs font-medium text-gray-500 uppercase tracking-wider">Channel</label>
              <% case @template.channel %>
              <% when "email" %>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                  <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                  </svg>
                  Email
                </span>
              <% when "message" %>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                  <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                  </svg>
                  In-App Message
                </span>
              <% when "both" %>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800">
                  <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                  </svg>
                  Both
                </span>
              <% end %>
            </div>

            <!-- Template Type -->
            <div>
              <label class="block text-xs font-medium text-gray-500 uppercase tracking-wider">Template Type</label>
              <% if @template.passthrough? %>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-800">
                  <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                  </svg>
                  Pass-through
                </span>
                <p class="text-xs text-gray-500 mt-1">Content is passed directly from user input</p>
              <% elsif @template.hybrid? %>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                  <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 00-1-1H4a2 2 0 110-4h1a1 1 0 001-1V7a1 1 0 011-1h3a1 1 0 001-1V4z" />
                  </svg>
                  Hybrid
                </span>
                <p class="text-xs text-gray-500 mt-1">User can customize the pre-filled template</p>
              <% else %>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                  <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6z" />
                  </svg>
                  Structured
                </span>
                <p class="text-xs text-gray-500 mt-1">Fixed layout with variable placeholders</p>
              <% end %>
            </div>

            <% if @template.description.present? %>
              <div>
                <label class="block text-xs font-medium text-gray-500 uppercase tracking-wider">Description</label>
                <p class="text-sm text-gray-600 mt-1"><%= @template.description %></p>
              </div>
            <% end %>
          </div>
        </div>

        <!-- Variable Editor -->
        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
          <div class="px-4 py-3 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-sm font-medium text-gray-900">Preview Variables</h3>
            <button type="button" class="text-xs text-pink-600 hover:text-pink-800 font-medium"
                    data-action="content-template-preview#resetVariables">Reset</button>
          </div>
          <div class="p-4 space-y-4 max-h-96 overflow-y-auto">
            <% if @template.hybrid? %>
              <div class="bg-blue-50 border border-blue-200 rounded p-3 mb-3">
                <p class="text-xs text-blue-800">
                  <strong>Hybrid Template:</strong> The <code class="bg-blue-100 px-1 rounded">body_content</code> or similar variable
                  below shows what the user can customize. Edit it to preview different content.
                </p>
              </div>
            <% elsif @template.passthrough? %>
              <div class="bg-amber-50 border border-amber-200 rounded p-3 mb-3">
                <p class="text-xs text-amber-800">
                  <strong>Pass-through Template:</strong> The main content is provided entirely by the user at send time.
                  The sample below shows a placeholder.
                </p>
              </div>
            <% end %>
            <% if @sample_variables.present? %>
              <% @sample_variables.each do |var| %>
                <div>
                  <label class="block text-xs font-medium text-gray-700 mb-1">
                    <code class="text-purple-700 bg-purple-50 px-1 py-0.5 rounded">{{<%= var[:name] %>}}</code>
                  </label>
                  <% if var[:name].to_s.match?(/content|message|body/i) %>
                    <textarea class="w-full text-sm border border-gray-200 rounded px-2 py-1.5 focus:ring-pink-500 focus:border-pink-500 font-mono"
                              rows="8"
                              data-content-template-preview-target="variableInput"
                              data-variable-name="<%= var[:name] %>"
                              data-default-value="<%= var[:value] %>"
                              data-action="input->content-template-preview#updatePreview"><%= var[:value] %></textarea>
                  <% else %>
                    <input type="text"
                           class="w-full text-sm border border-gray-200 rounded px-2 py-1.5 focus:ring-pink-500 focus:border-pink-500"
                           value="<%= var[:value] %>"
                           data-content-template-preview-target="variableInput"
                           data-variable-name="<%= var[:name] %>"
                           data-default-value="<%= var[:value] %>"
                           data-action="input->content-template-preview#updatePreview">
                  <% end %>
                  <% if var[:description].present? %>
                    <p class="text-xs text-gray-400 mt-1"><%= var[:description] %></p>
                  <% end %>
                </div>
              <% end %>
            <% else %>
              <p class="text-sm text-gray-500">No variables in this template.</p>
            <% end %>
          </div>
        </div>

        <!-- Usage Locations -->
        <% if @template.usage_locations.present? || @template.mailer_class.present? %>
          <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
            <%= render "shared/card_header", title: "Used In" %>
            <div class="p-4 space-y-2">
              <% if @template.mailer_class.present? %>
                <div class="flex items-start gap-2">
                  <svg class="w-4 h-4 text-gray-400 mt-0.5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                  </svg>
                  <div>
                    <code class="text-xs font-mono text-gray-800"><%= @template.mailer_class %></code>
                    <% if @template.mailer_action.present? %>
                      <code class="text-xs font-mono text-gray-600">#<%= @template.mailer_action %></code>
                    <% end %>
                  </div>
                </div>
              <% end %>
              <% if @template.usage_locations.present? %>
                <% @template.usage_locations.each do |location| %>
                  <div class="flex items-start gap-2 text-sm">
                    <svg class="w-4 h-4 text-gray-400 mt-0.5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <span class="text-gray-600 text-xs break-all"><%= location %></span>
                  </div>
                <% end %>
              <% end %>
            </div>
          </div>
        <% end %>

        <!-- Developer Info -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <div class="text-sm text-blue-800">
            <strong class="block mb-2">Usage in code:</strong>
            <pre class="bg-blue-100 p-2 rounded text-xs overflow-x-auto font-mono whitespace-pre-wrap">ContentTemplateService.render(
  "<%= @template.key %>",
  {
<% @preview[:variables_used].each do |var| %>
    <%= var %>: value,
<% end %>
  }
)</pre>
          </div>
        </div>

        <% if @template.notes.present? %>
          <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
            <div class="text-sm text-amber-800">
              <strong class="block mb-1">Notes:</strong>
              <p><%= @template.notes %></p>
            </div>
          </div>
        <% end %>
      </div>

      <!-- Right Panel: Preview Tabs -->
      <div class="lg:col-span-3">
        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
          <!-- Tabs Navigation -->
          <nav class="flex border-b border-gray-200 bg-gray-50">
            <button type="button" class="px-6 py-3 text-sm font-medium border-b-2 border-pink-500 text-pink-600 bg-white"
                    data-tabs-target="tab"
                    data-index="0"
                    data-action="click->tabs#select">
              <svg class="w-4 h-4 inline mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
              </svg>
              Styled Preview
            </button>
            <button type="button" class="px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 bg-gray-50 hover:text-gray-700"
                    data-tabs-target="tab"
                    data-index="1"
                    data-action="click->tabs#select">
              <svg class="w-4 h-4 inline mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
              </svg>
              Raw Template
            </button>
          </nav>

          <!-- Tab Panels -->
          <!-- Styled Preview Panel -->
          <div data-tabs-target="panel" class="p-6">
            <!-- Subject -->
            <div class="mb-4">
              <label class="block text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">Subject</label>
              <div class="text-lg font-medium text-gray-900 bg-gray-50 p-3 rounded border border-gray-200"
                   data-content-template-preview-target="subjectPreview">
                <%= @preview[:subject] %>
              </div>
            </div>

            <% if @template.message? %>
              <%# Message Preview - styled like in-app message card %>
              <div>
                <label class="block text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">Message Preview</label>
                <div class="bg-gray-100 p-6 rounded-lg">
                  <div class="max-w-2xl mx-auto">
                    <%# Message Card %>
                    <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                      <%# Header %>
                      <div class="p-4 pb-3 bg-gray-50/80">
                        <div class="flex items-start gap-3">
                          <%# System Avatar %>
                          <div class="w-11 h-11 rounded-lg bg-pink-100 flex items-center justify-center flex-shrink-0">
                            <svg class="w-6 h-6 text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                            </svg>
                          </div>
                          <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2">
                              <span class="font-semibold text-gray-900">Production Team</span>
                              <span class="text-gray-500">via</span>
                              <span class="font-medium text-pink-600">Sample Production</span>
                            </div>
                            <div class="text-sm text-gray-500 mt-0.5">Just now</div>
                          </div>
                        </div>
                      </div>

                      <%# Body %>
                      <div class="px-4 py-3 border-t border-gray-100">
                        <div class="prose prose-sm max-w-none text-gray-700"
                             data-content-template-preview-target="bodyPreview">
                          <%= sanitize(@preview[:body], tags: %w[div p br strong b em i a ul ol li], attributes: %w[href]) %>
                        </div>
                      </div>

                      <%# Footer %>
                      <div class="px-4 py-3 bg-gray-50/50 border-t border-gray-100">
                        <div class="flex items-center gap-4 text-sm text-gray-500">
                          <span class="inline-flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                            </svg>
                            Reply
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            <% elsif @template.both? %>
              <%# Both Channel - show Email and Message previews %>
              <div class="space-y-6">
                <%# Email Preview %>
                <div>
                  <label class="block text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">
                    <span class="inline-flex items-center gap-1">
                      <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                      </svg>
                      Email Preview
                    </span>
                  </label>
                  <div class="border border-gray-200 rounded-lg overflow-hidden bg-gray-100" style="min-height: 400px;">
                    <iframe id="email-preview-frame" class="w-full" style="min-height: 400px; background: #f5f5f5;"
                            srcdoc="<%= ERB::Util.html_escape(@styled_body) %>">
                    </iframe>
                  </div>
                </div>

                <%# Message Preview %>
                <div>
                  <label class="block text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">
                    <span class="inline-flex items-center gap-1">
                      <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                      </svg>
                      In-App Message Preview
                    </span>
                  </label>
                  <div class="bg-gray-100 p-6 rounded-lg">
                    <div class="max-w-2xl mx-auto">
                      <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                        <div class="p-4 pb-3 bg-gray-50/80">
                          <div class="flex items-start gap-3">
                            <div class="w-11 h-11 rounded-lg bg-pink-100 flex items-center justify-center flex-shrink-0">
                              <svg class="w-6 h-6 text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                              </svg>
                            </div>
                            <div class="flex-1 min-w-0">
                              <div class="flex items-center gap-2">
                                <span class="font-semibold text-gray-900">Production Team</span>
                                <span class="text-gray-500">via</span>
                                <span class="font-medium text-pink-600">Sample Production</span>
                              </div>
                              <div class="text-sm text-gray-500 mt-0.5">Just now</div>
                            </div>
                          </div>
                        </div>
                        <div class="px-4 py-3 border-t border-gray-100">
                          <div class="prose prose-sm max-w-none text-gray-700"
                               data-content-template-preview-target="messageBodyPreview">
                            <% message_content = @template.message_body.present? ? @template.render_message_body(@sample_variables.to_h { |v| [v[:name].to_sym, v[:value]] }) : @preview[:body] %>
                            <%= sanitize(message_content, tags: %w[div p br strong b em i a ul ol li], attributes: %w[href]) %>
                          </div>
                        </div>
                        <div class="px-4 py-3 bg-gray-50/50 border-t border-gray-100">
                          <div class="flex items-center gap-4 text-sm text-gray-500">
                            <span class="inline-flex items-center gap-1">
                              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                              </svg>
                              Reply
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <% if @template.message_body.blank? %>
                    <p class="text-xs text-amber-600 mt-2">
                      <svg class="w-3.5 h-3.5 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                      </svg>
                      No separate message body defined. Currently using email body for in-app messages. <a href="<%= content_template_edit_path(@template) %>" class="underline font-medium">Edit template</a> to add a message-specific body.
                    </p>
                  <% end %>
                </div>
              </div>

              <script>
                // Auto-resize iframe to fit content
                const iframe = document.getElementById('email-preview-frame');
                if (iframe) {
                  iframe.onload = function() {
                    try {
                      const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                      const height = iframeDoc.body.scrollHeight;
                      iframe.style.height = Math.max(height, 400) + 'px';
                    } catch (e) {
                      console.log('Could not resize iframe:', e);
                    }
                  };
                }
              </script>
            <% else %>
              <%# Email Preview - styled like email with branded layout %>
              <div>
                <label class="block text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">Email Preview</label>
                <div class="border border-gray-200 rounded-lg overflow-hidden bg-gray-100" style="min-height: 500px;">
                  <iframe id="email-preview-frame" class="w-full" style="min-height: 500px; background: #f5f5f5;"
                          srcdoc="<%= ERB::Util.html_escape(@styled_body) %>">
                  </iframe>
                </div>
              </div>

              <script>
                // Auto-resize iframe to fit content
                const iframe = document.getElementById('email-preview-frame');
                if (iframe) {
                  iframe.onload = function() {
                    try {
                      const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                      const height = iframeDoc.body.scrollHeight;
                      iframe.style.height = Math.max(height, 500) + 'px';
                    } catch (e) {
                      console.log('Could not resize iframe:', e);
                    }
                  };
                }
              </script>
            <% end %>
          </div>

          <!-- Raw Template Panel -->
          <div data-tabs-target="panel" class="hidden p-6 space-y-4">
            <div>
              <label class="block text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">Subject Template</label>
              <code class="block bg-gray-100 p-3 rounded text-sm font-mono text-gray-800"
                    data-content-template-preview-target="subjectRaw"><%= @template.subject %></code>
            </div>
            <div>
              <% if @template.message? %>
                <label class="block text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">Body Template (Rich Text)</label>
                <div class="bg-white border border-gray-200 p-4 rounded prose prose-sm max-w-none"
                     data-content-template-preview-target="bodyRaw">
                  <%= sanitize(@template.body, tags: %w[div p br strong b em i a ul ol li], attributes: %w[href]) %>
                </div>
                <p class="text-xs text-gray-500 mt-2">
                  <span class="font-medium">Note:</span> Message templates use rich text. Variables like <code class="bg-purple-100 px-1 rounded">{{variable_name}}</code> will be replaced when sent.
                </p>
              <% elsif @template.both? %>
                <%# Both channel - show email body and message body %>
                <label class="block text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">
                  <span class="inline-flex items-center gap-1">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                    </svg>
                    Email Body Template (HTML)
                  </span>
                </label>
                <pre class="bg-gray-100 p-3 rounded text-sm font-mono text-gray-800 whitespace-pre-wrap overflow-x-auto"
                     data-content-template-preview-target="bodyRaw"><%= @template.body %></pre>

                <div class="mt-4">
                  <label class="block text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">
                    <span class="inline-flex items-center gap-1">
                      <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                      </svg>
                      Message Body Template (Rich Text)
                    </span>
                  </label>
                  <% if @template.message_body.present? %>
                    <div class="bg-white border border-gray-200 p-4 rounded prose prose-sm max-w-none">
                      <%= sanitize(@template.message_body, tags: %w[div p br strong b em i a ul ol li], attributes: %w[href]) %>
                    </div>
                  <% else %>
                    <div class="bg-amber-50 border border-amber-200 p-4 rounded text-sm text-amber-800">
                      <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                      </svg>
                      No message body defined. The email body will be used for in-app messages.
                    </div>
                  <% end %>
                </div>
              <% else %>
                <label class="block text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">Body Template (HTML)</label>
                <pre class="bg-gray-100 p-3 rounded text-sm font-mono text-gray-800 whitespace-pre-wrap overflow-x-auto"
                     data-content-template-preview-target="bodyRaw"><%= @template.body %></pre>
              <% end %>
            </div>

            <!-- Variable Highlighting Legend -->
            <div class="mt-4 p-4 bg-purple-50 rounded-lg border border-purple-200">
              <h4 class="text-sm font-medium text-purple-900 mb-2">Variables Used</h4>
              <div class="flex flex-wrap gap-2">
                <% @preview[:variables_used].each do |var| %>
                  <code class="text-xs font-mono text-purple-700 bg-purple-100 px-2 py-1 rounded">{{<%= var %>}}</code>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
