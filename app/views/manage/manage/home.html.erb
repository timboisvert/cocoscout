<% content_for :title, "Home" %>

<div class="w-full mb-10">
  <%= render partial: "shared/notice", locals: { notice: notice } %>

  <%= render "shared/module_header",
    title: "Home",
    description: "Your organization dashboard — see what needs attention across all productions."
  %>

  <div class="border-t border-gray-200 pt-6 mt-2">
    <% if @production_dashboards.any? %>
      <div class="space-y-6">
        <% @productions.each do |production| %>
          <% dashboard = @production_dashboards[production.id] %>
          <% next unless dashboard %>
          
          <div class="border border-gray-200 rounded-lg overflow-hidden bg-white">
            <%# Production Header %>
            <div class="px-4 py-3 bg-gray-50 border-b border-gray-200 flex items-center justify-between">
              <div class="flex items-center gap-3">
                <% logo_variant = production.safe_logo_variant(:small) %>
                <% if logo_variant %>
                  <%= image_tag logo_variant, alt: "#{production.name} logo", class: "w-8 h-8 rounded object-cover flex-shrink-0" %>
                <% else %>
                  <div class="w-8 h-8 rounded bg-pink-100 flex items-center justify-center text-pink-600 font-medium text-sm flex-shrink-0">
                    <%= production.initials %>
                  </div>
                <% end %>
                <h2 class="text-lg font-semibold text-gray-900"><%= production.name %></h2>
              </div>
              <%= link_to "View Production →", manage_production_path(production), class: "text-sm text-pink-600 hover:text-pink-700 font-medium" %>
            </div>

            <div class="p-4">
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                
                <%# Open Auditions Card %>
                <% if dashboard[:open_calls][:total_open] > 0 %>
                  <%= link_to manage_signups_auditions_path(production), class: "block p-4 border border-gray-200 rounded-lg hover:border-pink-300 transition-all" do %>
                    <div class="flex items-center justify-between mb-2">
                      <span class="text-sm font-medium text-gray-700">Open Auditions</span>
                      <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Active</span>
                    </div>
                    <div class="text-2xl font-bold text-gray-900">
                      <%= dashboard[:open_calls][:with_auditionees].sum { |c| c[:auditionee_count] } %>
                    </div>
                    <div class="text-sm text-gray-500">pending requests</div>
                  <% end %>
                <% end %>

                <%# Open Vacancies Card %>
                <% if dashboard[:open_vacancies].any? %>
                  <%= link_to manage_casting_production_path(production), class: "block p-4 border border-gray-200 rounded-lg hover:border-yellow-300 transition-all" do %>
                    <div class="flex items-center justify-between mb-2">
                      <span class="text-sm font-medium text-gray-700">Open Vacancies</span>
                      <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Needs Attention</span>
                    </div>
                    <div class="text-2xl font-bold text-gray-900">
                      <%= dashboard[:open_vacancies].size %>
                    </div>
                    <div class="text-sm text-gray-500">roles need filling</div>
                  <% end %>
                <% end %>

                <%# Upcoming Shows Card %>
                <% upcoming = dashboard[:upcoming_shows] %>
                <% if upcoming.any? %>
                  <%= link_to manage_shows_path, class: "block p-4 border border-gray-200 rounded-lg hover:border-gray-300 transition-all" do %>
                    <div class="text-sm font-medium text-gray-700 mb-2">Upcoming Events</div>
                    <div class="text-2xl font-bold text-gray-900"><%= upcoming.size %></div>
                    <div class="text-sm text-gray-500">in next 6 weeks</div>
                    <% first_show = upcoming.first %>
                    <% if first_show %>
                      <div class="mt-2 pt-2 border-t border-gray-100">
                        <div class="text-sm text-gray-600">
                          Next: <span class="font-medium"><%= first_show[:show].date_and_time.strftime("%b %-d") %></span>
                          <% if first_show[:cast_percentage] < 100 %>
                            <span class="text-yellow-600">(<%= first_show[:cast_percentage] %>% cast)</span>
                          <% end %>
                        </div>
                      </div>
                    <% end %>
                  <% end %>
                <% end %>

                <%# Sign-up Forms Card %>
                <% if dashboard[:sign_up_forms].any? %>
                  <%= link_to manage_signups_forms_path(production), class: "block p-4 border border-gray-200 rounded-lg hover:border-gray-300 transition-all" do %>
                    <div class="flex items-center justify-between mb-2">
                      <span class="text-sm font-medium text-gray-700">Active Sign-up Forms</span>
                      <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">Live</span>
                    </div>
                    <div class="text-2xl font-bold text-gray-900">
                      <%= dashboard[:sign_up_forms].size %>
                    </div>
                    <div class="text-sm text-gray-500">forms accepting registrations</div>
                  <% end %>
                <% end %>

              </div>

              <%# Show message if nothing needs attention %>
              <% has_content = dashboard[:open_calls][:total_open] > 0 || 
                               dashboard[:open_vacancies].any? || 
                               dashboard[:upcoming_shows].any? || 
                               dashboard[:sign_up_forms].any? %>
              <% unless has_content %>
                <div class="text-center py-4 text-gray-500">
                  No items need attention right now.
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <div class="bg-gray-50 rounded-lg border border-dashed border-gray-300 p-8 text-center">
        <p class="text-gray-600">No productions to display.</p>
      </div>
    <% end %>
  </div>
</div>
