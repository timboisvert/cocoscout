<% content_for :title, "Auditions" %>

<div class="w-full">

  <%= render partial: "shared/notice", locals: { notice: notice } %>

  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [],
    text: "My Auditions",
    links: []
  } %>

   <div class="flex items-center justify-between mb-4 gap-4">
        <!-- Left: Time Filter -->
        <div class="flex flex-wrap gap-1">
            <%
              upcoming_entity_params = @entity_filter.join(",")
              past_entity_params = @entity_filter.join(",")
            %>
            <%= link_to "Upcoming",
                    my_auditions_path(auditions_filter: "upcoming", entity: upcoming_entity_params),
                    data: { turbo_prefetch: false },
                    class: "px-3 py-1 rounded-lg border text-sm font-normal transition-all #{(@auditions_filter == "upcoming") ? 'bg-pink-500 text-white border-pink-500' : 'bg-white text-gray-700 border-gray-200 hover:bg-gray-50'}"
            %>
            <%= link_to "Past",
                    my_auditions_path(auditions_filter: "past", entity: past_entity_params),
                    data: { turbo_prefetch: false },
                    class: "px-3 py-1 rounded-lg border text-sm font-normal transition-all #{(@auditions_filter == "past") ? 'bg-pink-500 text-white border-pink-500' : 'bg-white text-gray-700 border-gray-200 hover:bg-gray-50'}"
            %>
        </div>

        <% if @groups.any? %>
        <!-- Right: Entity Filter -->
        <div class="flex flex-wrap gap-1 justify-end">
          <%
            # Build the toggle URL for person
            current_entities = @entity_filter.dup
            person_url_entities = if current_entities.include?('person')
              current_entities - ['person']
            else
              current_entities + ['person']
            end
            person_url_entities = ['person'] if person_url_entities.empty? # Keep at least one
          %>
          <%= link_to my_auditions_path(auditions_filter: @auditions_filter, entity: person_url_entities.join(",")),
                  data: { turbo_prefetch: false },
                  class: "inline-flex items-center gap-1.5 px-3 py-1 rounded-lg border text-sm font-normal transition-all #{@entity_filter.include?("person") ? "bg-pink-500 text-white border-pink-500" : "bg-white text-gray-700 border-gray-300 hover:border-pink-300 hover:bg-pink-50"}" do %>
            <svg class="w-3.5 h-3.5 <%= @entity_filter.include?("person") ? "" : "opacity-20" %>" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
            <%= @person.name %>
          <% end %>

          <% @groups.each do |group| %>
            <%
              # Build the toggle URL for this group
              group_key = "group_#{group.id}"
              current_entities = @entity_filter.dup
              group_url_entities = if current_entities.include?(group_key)
                current_entities - [group_key]
              else
                current_entities + [group_key]
              end
              group_url_entities = ['person'] if group_url_entities.empty? # Keep at least one
            %>
            <%= link_to my_auditions_path(auditions_filter: @auditions_filter, entity: group_url_entities.join(",")),
                    data: { turbo_prefetch: false },
                    class: "inline-flex items-center gap-1.5 px-3 py-1 rounded-lg border text-sm font-normal transition-all #{@entity_filter.include?(group_key) ? "bg-pink-500 text-white border-pink-500" : "bg-white text-gray-700 border-gray-300 hover:border-pink-300 hover:bg-pink-50"}" do %>
              <svg class="w-3.5 h-3.5 <%= @entity_filter.include?(group_key) ? "" : "opacity-20" %>" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
              <%= group.name %>
            <% end %>
          <% end %>
        </div>
        <% end %>
    </div>

    <% if @auditions.any? %>

        <div class="grid grid-cols-1 gap-2 mt-2">
            <% @auditions.each do |audition| %>
                <% if audition.audition_session.start_at < Time.current %>
                    <%= render partial: "audition_past", locals: { audition: audition } %>
                <% else %>
                    <%= render partial: "audition_upcoming", locals: { audition: audition } %>
                <% end %>
            <% end %>
        </div>
    <% else %>
        <p class="text-gray-500 text-sm">

            <% if @auditions_filter == "all" %>
                You don't have any auditions
            <% elsif @auditions_filter == "upcoming" %>
                You don't have any upcoming auditions.
            <% elsif @auditions_filter == "past" %>
                You haven't had any auditions.
            <% end %>
        </p>
    <% end %>
</div>