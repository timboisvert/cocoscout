<% content_for :title, "Sign-ups" %>

<div class="w-full">

  <%= render partial: "shared/notice", locals: { notice: notice } %>

  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [],
    text: "My Sign-ups",
    links: []
  } %>

    <div class="flex items-center justify-between mb-4 gap-4">
        <!-- Left: Filter -->
        <div class="flex flex-wrap gap-1">
            <%= link_to "Open Sign-up Windows",
                    my_audition_requests_path(requests_filter: "open", entity: @entity_filter.join(",")),
                    data: { turbo_prefetch: false },
                    class: "px-3 py-1 rounded-lg border text-sm font-normal transition-all #{(@requests_filter == "open") ? 'bg-pink-500 text-white border-pink-500' : 'bg-white text-gray-700 border-gray-200 hover:bg-gray-50'}"
            %>
            <%= link_to "All Sign-ups",
                    my_audition_requests_path(requests_filter: "all", entity: @entity_filter.join(",")),
                    data: { turbo_prefetch: false },
                    class: "px-3 py-1 rounded-lg border text-sm font-normal transition-all #{(@requests_filter == "all") ? 'bg-pink-500 text-white border-pink-500' : 'bg-white text-gray-700 border-gray-200 hover:bg-gray-50'}"
            %>
        </div>

        <% if @groups.any? %>
        <!-- Right: Entity Filter -->
        <div class="flex flex-wrap gap-1 justify-end">
          <%
            # Build the toggle URL for person
            current_entities = @entity_filter.dup
            person_url_entities = if current_entities.include?('person')
              current_entities - ['person']
            else
              current_entities + ['person']
            end
            person_url_entities = ['person'] if person_url_entities.empty? # Keep at least one
          %>
          <%= link_to my_audition_requests_path(requests_filter: @requests_filter, entity: person_url_entities.join(",")),
                  data: { turbo_prefetch: false },
                  class: "inline-flex items-center gap-1.5 px-3 py-1 rounded-lg border text-sm font-normal transition-all #{@entity_filter.include?("person") ? "bg-pink-500 text-white border-pink-500" : "bg-white text-gray-700 border-gray-300 hover:border-pink-300 hover:bg-pink-50"}" do %>
            <svg class="w-3.5 h-3.5 <%= @entity_filter.include?("person") ? "" : "opacity-20" %>" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
            <%= @person.name %>
          <% end %>

          <% @groups.each do |group| %>
            <%
              # Build the toggle URL for this group
              group_key = "group_#{group.id}"
              current_entities = @entity_filter.dup
              group_url_entities = if current_entities.include?(group_key)
                current_entities - [group_key]
              else
                current_entities + [group_key]
              end
              group_url_entities = ['person'] if group_url_entities.empty? # Keep at least one
            %>
            <%= link_to my_audition_requests_path(requests_filter: @requests_filter, entity: group_url_entities.join(",")),
                    data: { turbo_prefetch: false },
                    class: "inline-flex items-center gap-1.5 px-3 py-1 rounded-lg border text-sm font-normal transition-all #{@entity_filter.include?(group_key) ? "bg-pink-500 text-white border-pink-500" : "bg-white text-gray-700 border-gray-300 hover:border-pink-300 hover:bg-pink-50"}" do %>
              <svg class="w-3.5 h-3.5 <%= @entity_filter.include?(group_key) ? "" : "opacity-20" %>" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
              <%= group.name %>
            <% end %>
          <% end %>
        </div>
        <% end %>
    </div>


    <% if @audition_requests.any? %>

        <div class="grid grid-cols-1 gap-1 mt-2">
            <% @audition_requests.each do |audition_request| %>
                <div class="p-4 bg-white border border-gray-200 rounded-lg hover:border-gray-400 transition-all flex items-start">

                    <% production = audition_request.audition_cycle.production %>

                    <div class="grid grid-cols-1 sm:grid-cols-5 gap-2 w-full">
                        <div class="col-span-1 sm:col-span-3 items-center">

                            <div class="flex flex-col sm:flex-row sm:items-center gap-4">
                                <% logo_variant = production.safe_logo_variant(:small) %>
                                <% if logo_variant %>
                                    <div class="w-full sm:w-auto sm:flex-shrink-0">
                                        <%= image_tag logo_variant, alt: "#{production.name} logo", class: "w-full sm:w-[100px] object-contain rounded" %>
                                    </div>
                                <% end %>
                                <div class="w-full sm:w-auto text-left">
                                    <div class="font-bold text-lg sm:text-xl"><%= production.name %></div>

                                    <% cycle = audition_request.audition_cycle %>

                                    <% if cycle.editable_by_talent? %>

                                        <% if cycle.closes_at.present? && cycle.closes_at > 1.day.from_now %>
                                            <div class="text-xs text-gray-500 mt-1">

                                                <% if cycle.audition_type == "in_person" %>
                                                    Sign-ups
                                                <% elsif cycle.audition_type == "video_upload" %>
                                                    Video auditions
                                                <% end %>
                                                close on <%= cycle.closes_at.strftime('%b %d, %Y') %> at <%= cycle.closes_at.strftime('%l:%M %p') %>
                                            </div>
                                        <% elsif cycle.closes_at.present? %>
                                            <div class="text-xs <%= cycle.closes_at < 4.hours.from_now ? 'text-red-500' : 'text-gray-500' %> mt-1" data-controller="countdown" data-countdown-until-value="<%= cycle.closes_at.utc.iso8601 %>">
                                                <% if cycle.audition_type == "in_person" %>
                                                    Sign-ups
                                                <% elsif cycle.audition_type == "video_upload" %>
                                                    Video auditions
                                                <% end %>
                                                close in <span data-countdown-target="clock" class="text-pink-500"></span>
                                            </div>
                                        <% else %>
                                            <div class="text-xs text-gray-500 mt-1">(open-ended)</div>
                                        <% end %>

                                        <%
                                          # Build URL with entity params if user has groups
                                          edit_url = if @groups.any?
                                            my_submit_audition_request_form_path(
                                              cycle.token,
                                              requestable_type: audition_request.requestable_type,
                                              requestable_id: audition_request.requestable_id
                                            )
                                          else
                                            my_submit_audition_request_form_path(cycle.token)
                                          end
                                        %>
                                        <%= link_to "Edit my Sign-up", edit_url, class: "text-xs text-pink-500 underline", target: "_blank" %>

                                    <% elsif cycle.timeline_status == :closed || !cycle.active %>
                                        <div class="text-xs text-gray-500 mt-1">Sign-up window closed<% if cycle.closes_at.present? %> on <%= cycle.closes_at.strftime('%b %d, %Y') %><% end %></div>
                                    <% elsif cycle.timeline_status == :upcoming %>
                                        <div class="text-xs text-gray-500 mt-1">Sign-ups open on <%= cycle.opens_at.strftime('%b %d, %Y') %></div>
                                    <% end %>
                                </div>
                            </div>
                        </div>

                        <div class="col-span-1 sm:col-span-2 mt-2 sm:mt-0 flex flex-col justify-center items-start">
                            <div class="text-lg">
                                <% if audition_request.audition_cycle.audition_type == "in_person" %>
                                    <%= in_person_signup_status_name(audition_request) %>
                                 <% elsif audition_request.audition_cycle.audition_type == "video_upload" %>
                                    <%= video_audition_status_name(audition_request) %>
                                <% end %>
                            </div>
                            <div class="text-sm text-gray-500 mt-1">
                                <% if audition_request.audition_cycle.audition_type == "in_person" %>
                                    <%= in_person_signup_status_text(audition_request) %>
                                 <% elsif audition_request.audition_cycle.audition_type == "video_upload" %>
                                    <%= video_audition_status_text(audition_request) %>
                                <% end %>

                            </div>
                        </div>
                    </div>

                    <% if @groups.any? && @audition_request_entities[audition_request.id].present? %>
                      <div class="flex flex-col gap-2 ml-2">
                        <% @audition_request_entities[audition_request.id].each do |entity_info| %>
                          <% headshot = entity_info[:entity].safe_headshot_variant(:thumb) %>
                          <% if headshot %>
                            <%= image_tag headshot, class: "w-10 h-10 rounded-lg object-cover", alt: entity_info[:entity].try(:preferred_name) || entity_info[:entity].name %>
                          <% end %>
                        <% end %>
                      </div>
                    <% end %>
                </div>
            <% end %>
        </div>
    <% else %>
         <p class="text-gray-500 text-sm pt-2">
            <% if @requests_filter == "all" %>
                You haven't signed up for any auditions.
            <% elsif @requests_filter == "open" %>
                None of the shows you've applied for are currently auditioning.
            <% end %>
        </p>
    <% end %>

</div>