<% content_for :title, "Sign-up Forms" %>

<div class="w-full mb-10">
  <%= render partial: "shared/notice", locals: { notice: notice } %>

  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [
      ["Sign-ups", manage_signups_path]
    ],
    text: "Sign-up Forms",
    links: [
      { text: "Create Sign-Up Form", path: manage_signups_forms_new_wizard_path }
    ]
  } %>

  <%= render "shared/filters/filter_bar", filter_groups: [
    {
      label: "Type",
      filters: [
        { text: "All", path: manage_signups_all_forms_path, active: @filter.blank? },
        { text: "Event Registrations", path: manage_signups_all_forms_path(filter: "registrations"), active: @filter == "registrations" },
        { text: "Waitlists", path: manage_signups_all_forms_path(filter: "waitlists"), active: @filter == "waitlists" }
      ]
    },
    { separator: true }
  ] %>

  <% if @sign_up_forms.any? %>
    <div class="space-y-1">
      <% @sign_up_forms.each do |form| %>
        <% form_status = form.current_status %>
        <%
          # Get current instance to check closes_at
          current_instance = if form.repeated?
            form.sign_up_form_instances.joins(:show).where("shows.date_and_time > ?", Time.current).order("shows.date_and_time ASC, sign_up_form_instances.id ASC").first
          else
            form.sign_up_form_instances.first
          end
          closes_at = current_instance&.closes_at
        %>
        <%= link_to manage_signups_form_path(form.production, form), class: "block px-4 py-3 border border-gray-200 rounded-lg hover:border-gray-400 bg-white transition-all no-underline" do %>
          <div class="flex flex-col md:flex-row md:items-center gap-2 md:gap-0 w-full">
            <%# Left third: Production + Name %>
            <div class="w-full md:w-1/3 flex items-center gap-3">
              <%# Production Logo %>
              <% logo_variant = form.production.safe_logo_variant(:small) %>
              <% if logo_variant %>
                <div class="flex-shrink-0 w-14 h-8 rounded flex items-center justify-center overflow-hidden">
                  <%= image_tag logo_variant, alt: form.production.name, class: "w-full h-full object-cover rounded" %>
                </div>
              <% else %>
                <div class="flex-shrink-0 w-14 h-8 rounded-lg bg-pink-100 flex items-center justify-center">
                  <span class="text-sm font-bold text-pink-600"><%= form.production.initials %></span>
                </div>
              <% end %>
              <div class="flex-1 min-w-0">
                <div class="text-xs text-gray-400 mb-0"><%= form.production.name %></div>
                <h3 class="text-base font-medium text-gray-900 truncate"><%= form.name %></h3>
                <div class="text-sm text-gray-500">
                  <% if form.repeated? %>
                    <%= form.sign_up_form_instances.count %> event<%= form.sign_up_form_instances.count == 1 ? '' : 's' %>
                  <% elsif form.shared_pool? %>
                    Waitlist · <%= form.sign_up_slots.count %> slot<%= form.sign_up_slots.count == 1 ? '' : 's' %>
                  <% elsif form.single_event? && form.show.present? %>
                    <%= form.show.date_and_time.strftime("%a %b %-d") %>
                    <% if form.show.secondary_name.present? %>
                      · <%= form.show.secondary_name %>
                    <% end %>
                  <% end %>
                </div>
              </div>
            </div>

            <%# Middle third: Status %>
            <div class="w-full md:w-1/3 md:border-l border-gray-200 md:pl-4 flex flex-col justify-center md:self-stretch border-t md:border-t-0 mt-2 md:mt-0 pt-2 md:pt-0">
              <div class="flex items-center">
                <% if form_status[:accepting_registrations] %>
                  <span class="inline-flex items-center gap-2 rounded-full px-2.5 py-1 text-sm font-medium bg-green-100 text-green-700">
                    <span class="relative flex h-2.5 w-2.5">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-green-500"></span>
                    </span>
                    <%= form_status[:label] %>
                  </span>
                <% elsif form_status[:state] == :paused %>
                  <span class="inline-flex items-center rounded-full px-2.5 py-1 text-sm font-medium bg-gray-100 text-gray-600">
                    <%= form_status[:label] %>
                  </span>
                <% elsif form_status[:state] == :scheduled %>
                  <span class="inline-flex items-center rounded-full px-2.5 py-1 text-sm font-medium bg-amber-100 text-amber-700">
                    <%= form_status[:label] %>
                  </span>
                <% elsif form_status[:state] == :initializing %>
                  <span class="inline-flex items-center gap-1.5 rounded-full px-2.5 py-1 text-sm font-medium bg-blue-100 text-blue-700">
                    <svg class="w-3 h-3 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Initializing...
                  </span>
                <% elsif form_status[:state] == :updating %>
                  <span class="inline-flex items-center gap-1.5 rounded-full px-2.5 py-1 text-sm font-medium bg-blue-100 text-blue-700">
                    <svg class="w-3 h-3 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Updating...
                  </span>
                <% else %>
                  <span class="inline-flex items-center rounded-full px-2.5 py-1 text-sm font-medium bg-gray-100 text-gray-600">
                    <%= form_status[:label] %>
                  </span>
                <% end %>
              </div>
              <% if form_status[:accepting_registrations] && closes_at.present? && closes_at > Time.current %>
                <div class="text-xs text-gray-500 mt-1" data-controller="countdown" data-countdown-until-value="<%= closes_at.iso8601 %>">
                  Closes <span data-countdown-target="clock" class="tabular-nums">--</span>
                </div>
              <% end %>
            </div>

            <%# Right third: Registrations %>
            <div class="w-full md:w-1/3 md:border-l border-gray-200 md:pl-4 flex items-center md:self-stretch justify-between border-t md:border-t-0 mt-2 md:mt-0 pt-2 md:pt-0">
              <div class="flex-1">
                <% if form_status[:accepting_registrations] || form_status[:state] == :full %>
                  <div class="text-xs text-gray-400 uppercase tracking-wide">Registrations</div>
                  <div class="text-base">
                    <span class="text-gray-900 font-medium tabular-nums"><%= form_status[:total_registrations] || 0 %></span>
                    <% if (form_status[:total_capacity] || 0) < 1000 %>
                      <span class="text-gray-400">/</span>
                      <span class="text-gray-500 tabular-nums"><%= form_status[:total_capacity] || 0 %> slots</span>
                    <% end %>
                  </div>
                <% elsif form_status[:state] == :scheduled && form_status[:next_event] %>
                  <div class="text-xs text-gray-400 uppercase tracking-wide">Next event</div>
                  <div class="text-base text-gray-600">
                    <% days = form_status[:next_event][:days_until_show].floor %>
                    <% if days == 0 %>
                      today
                    <% elsif days == 1 %>
                      tomorrow
                    <% else %>
                      in <%= pluralize(days, 'day') %>
                    <% end %>
                  </div>
                <% else %>
                  <div class="text-sm text-gray-500">&nbsp;</div>
                <% end %>
              </div>
              <svg class="w-5 h-5 text-gray-400 hidden sm:block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
              </svg>
            </div>
          </div>
        <% end %>
      <% end %>
    </div>
  <% else %>
    <div class="bg-gray-50 rounded-lg border border-dashed border-gray-300 p-8 text-center">
      <p class="text-gray-600">
        <% if @filter == "registrations" %>
          No event registration forms found. Create one from a production's sign-ups page.
        <% elsif @filter == "waitlists" %>
          No waitlist forms found. Create one from a production's sign-ups page.
        <% else %>
          No sign-up forms found. Create one from a production's sign-ups page.
        <% end %>
      </p>
    </div>
  <% end %>
</div>