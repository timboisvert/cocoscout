<% content_for :title, "Customize Payout - #{show_display_name(@show)}" %>

<%
  rules = @current_rules || {}
  distribution = rules["distribution"] || {}
  dist_method = distribution["method"] || "per_ticket_guaranteed"
  performer_overrides = rules["performer_overrides"] || {}

  per_ticket_rate = distribution["per_ticket_rate"] || 1.0
  minimum = distribution["minimum"] || 25.0
  flat_amount = distribution["flat_amount"] || 50.0
  default_shares = distribution["default_shares"] || 1.0

  # Get performers assigned to this show
  assignments = @show.show_person_role_assignments.includes(:assignable)
  show_performers = assignments.map(&:assignable).compact.uniq.select { |p| p.is_a?(Person) }
%>

<div class="w-full mb-10">
  <%= render partial: "shared/notice", locals: { notice: notice, alert: alert } %>
  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [
      ["Money", manage_production_money_index_path(@production)],
      [show_display_name(@show), manage_production_money_show_payout_path(@production, @show)]
    ],
    text: "Customize Payout Rules",
    links: []
  } %>

  <div class="max-w-2xl">
    <div class="bg-white rounded-lg border border-gray-200 p-6 mb-6">
      <h2 class="font-semibold text-gray-900 mb-1"><%= show_display_name(@show, include_date: false) %></h2>
      <p class="text-sm text-gray-500 mb-4"><%= @show.date_and_time.strftime("%A, %B %-d, %Y at %-I:%M %p") %></p>

      <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6">
        <div class="flex gap-3">
          <svg class="w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 9a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/>
          </svg>
          <div>
            <p class="text-sm text-amber-800 font-medium">Custom rules for this show only</p>
            <p class="text-sm text-amber-700 mt-1">These rules will override the default scheme for this specific show. Other shows will continue using the default.</p>
          </div>
        </div>
      </div>

      <%= form_with url: manage_production_save_override_money_show_payout_path(@production, @show), method: :post, local: true do |f| %>

        <!-- Distribution Method -->
        <div class="space-y-4 mb-6">
          <label class="block text-sm font-medium text-gray-700">How should performers be paid?</label>
          <div class="space-y-2">
            <label class="flex items-start gap-3 p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 has-[:checked]:border-pink-500 has-[:checked]:bg-pink-50">
              <input type="radio" name="override_rules[distribution][method]" value="per_ticket_guaranteed" <%= "checked" if dist_method == "per_ticket_guaranteed" %> class="mt-0.5 accent-pink-600">
              <div>
                <div class="font-medium text-gray-900">Per-Ticket with Minimum</div>
                <div class="text-sm text-gray-500">Per-ticket rate with a guaranteed minimum payout</div>
              </div>
            </label>

            <label class="flex items-start gap-3 p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 has-[:checked]:border-pink-500 has-[:checked]:bg-pink-50">
              <input type="radio" name="override_rules[distribution][method]" value="flat_fee" <%= "checked" if dist_method == "flat_fee" %> class="mt-0.5 accent-pink-600">
              <div>
                <div class="font-medium text-gray-900">Flat Fee</div>
                <div class="text-sm text-gray-500">Fixed amount per performer</div>
              </div>
            </label>

            <label class="flex items-start gap-3 p-3 rounded-lg border border-gray-200 cursor-pointer hover:bg-gray-50 has-[:checked]:border-pink-500 has-[:checked]:bg-pink-50">
              <input type="radio" name="override_rules[distribution][method]" value="custom" <%= "checked" if dist_method == "custom" %> class="mt-0.5 accent-pink-600">
              <div>
                <div class="font-medium text-gray-900">Custom Per-Person</div>
                <div class="text-sm text-gray-500">Enter specific amounts for each performer</div>
              </div>
            </label>
          </div>
        </div>

        <!-- Per-ticket options -->
        <div class="p-4 bg-gray-50 rounded-lg mb-6" data-show-for="per_ticket_guaranteed">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Per-ticket rate</label>
              <div class="flex items-center gap-2">
                <span class="text-gray-500">$</span>
                <input type="number" name="override_rules[distribution][per_ticket_rate]" value="<%= per_ticket_rate %>" min="0.01" step="0.01" class="w-24 rounded-lg border border-gray-300 px-3 py-2">
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Minimum payout</label>
              <div class="flex items-center gap-2">
                <span class="text-gray-500">$</span>
                <input type="number" name="override_rules[distribution][minimum]" value="<%= minimum %>" min="0" step="1" class="w-24 rounded-lg border border-gray-300 px-3 py-2">
              </div>
            </div>
          </div>
        </div>

        <!-- Flat fee options -->
        <div class="p-4 bg-gray-50 rounded-lg mb-6 hidden" data-show-for="flat_fee">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Amount per performer</label>
            <div class="flex items-center gap-2">
              <span class="text-gray-500">$</span>
              <input type="number" name="override_rules[distribution][flat_amount]" value="<%= flat_amount %>" min="0" step="1" class="w-24 rounded-lg border border-gray-300 px-3 py-2">
            </div>
          </div>
        </div>

        <!-- Custom per-person amounts -->
        <% if show_performers.any? %>
          <div class="p-4 bg-gray-50 rounded-lg mb-6 hidden" data-show-for="custom">
            <label class="block text-sm font-medium text-gray-700 mb-3">Amount for each performer</label>
            <div class="space-y-3">
              <% show_performers.each do |person| %>
                <div class="flex items-center gap-3">
                  <div class="flex-1">
                    <div class="font-medium text-gray-900"><%= person.name %></div>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="text-gray-500">$</span>
                    <input type="number" name="override_rules[performer_overrides][<%= person.id %>][flat_amount]" value="<%= performer_overrides.dig(person.id.to_s, 'flat_amount') %>" min="0" step="0.01" class="w-24 rounded border border-gray-300 px-2 py-1 text-sm" placeholder="0.00">
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>

        <!-- Per-person exceptions (for per_ticket_guaranteed) -->
        <% if show_performers.any? %>
          <div class="border-t border-gray-200 pt-4 mb-6" data-show-for="per_ticket_guaranteed">
            <div class="flex items-center justify-between mb-3">
              <label class="block text-sm font-medium text-gray-700">Per-person exceptions (optional)</label>
            </div>
            <p class="text-sm text-gray-500 mb-3">Override rates for specific performers if needed.</p>
            <div class="space-y-2">
              <% show_performers.each do |person| %>
                <% override = performer_overrides[person.id.to_s] || {} %>
                <details class="group">
                  <summary class="flex items-center justify-between p-2 rounded-lg hover:bg-gray-50 cursor-pointer">
                    <span class="font-medium text-gray-900"><%= person.name %></span>
                    <% if override.any? %>
                      <span class="text-xs text-pink-600">Custom rate set</span>
                    <% else %>
                      <span class="text-xs text-gray-400">Using default</span>
                    <% end %>
                  </summary>
                  <div class="mt-2 ml-4 p-3 bg-gray-50 rounded-lg">
                    <div class="grid grid-cols-2 gap-3">
                      <div>
                        <label class="block text-xs text-gray-500 mb-1">Per-ticket rate</label>
                        <div class="flex items-center gap-1">
                          <span class="text-gray-500 text-sm">$</span>
                          <input type="number" name="override_rules[performer_overrides][<%= person.id %>][per_ticket_rate]" value="<%= override['per_ticket_rate'] %>" step="0.01" class="w-20 rounded border border-gray-300 px-2 py-1 text-sm" placeholder="default">
                        </div>
                      </div>
                      <div>
                        <label class="block text-xs text-gray-500 mb-1">Minimum</label>
                        <div class="flex items-center gap-1">
                          <span class="text-gray-500 text-sm">$</span>
                          <input type="number" name="override_rules[performer_overrides][<%= person.id %>][minimum]" value="<%= override['minimum'] %>" min="0" step="1" class="w-20 rounded border border-gray-300 px-2 py-1 text-sm" placeholder="default">
                        </div>
                      </div>
                    </div>
                  </div>
                </details>
              <% end %>
            </div>
          </div>
        <% end %>

        <div class="flex items-center justify-between pt-4 border-t border-gray-200">
          <%= link_to manage_production_money_show_payout_path(@production, @show), class: "text-gray-600 hover:text-gray-900" do %>
            Cancel
          <% end %>
          <%= render "shared/button", text: "Save Custom Rules", variant: "primary", size: "medium", type: :submit %>
        </div>

      <% end %>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const radios = document.querySelectorAll('input[name="override_rules[distribution][method]"]');
    const sections = document.querySelectorAll('[data-show-for]');

    function updateVisibility() {
      const selected = document.querySelector('input[name="override_rules[distribution][method]"]:checked');
      if (!selected) return;

      sections.forEach(section => {
        const showFor = section.dataset.showFor;
        if (showFor === selected.value) {
          section.classList.remove('hidden');
        } else {
          section.classList.add('hidden');
        }
      });
    }

    radios.forEach(radio => {
      radio.addEventListener('change', updateVisibility);
    });

    updateVisibility();
  });
</script>
