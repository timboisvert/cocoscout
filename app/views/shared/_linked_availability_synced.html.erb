<%#
  Linked Availability Display - Option B: Group Header with Synced Children
  
  Group header row with availability buttons that control all events.
  Individual show rows visible below (indented) showing synced status.
  Clicking any individual row's buttons also updates all (keeps them in sync).
  
  Required params:
    - event_linkage: EventLinkage object
    - entity: Person or Group to show availability for
    - entity_key: String key for entity (e.g., "person" or "group_123")
    - availabilities: Hash of { show_id => ShowAvailability }
  
  Optional params:
    - show_production: Show production name (default: false)
%>

<%
  show_production = local_assigns.fetch(:show_production, false)
  siblings = event_linkage.sibling_shows.order(:date_and_time)
  children = event_linkage.child_shows.order(:date_and_time)
  all_shows = siblings + children
  primary = siblings.first
  
  # Determine overall status
  statuses = all_shows.map { |s| availabilities[s.id]&.status || 'unset' }
  all_same = statuses.uniq.size == 1
  overall_status = all_same ? statuses.first : 'mixed'
%>

<div data-controller="linked-availability" 
     data-linked-availability-entity-key-value="<%= entity_key %>"
     data-linked-availability-show-ids-value="<%= all_shows.map(&:id).to_json %>"
     data-linked-availability-status-value="<%= overall_status %>"
     class="border border-gray-200 rounded-lg overflow-hidden">
  
  <%# Group Header with Master Controls %>
  <div class="flex items-stretch bg-gradient-to-r from-pink-50 to-white border-b border-gray-200">
    <div class="flex-1 flex items-center gap-3 px-4 py-3">
      <div class="w-8 h-8 rounded-full bg-pink-100 flex items-center justify-center">
        <svg class="w-4 h-4 text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
        </svg>
      </div>
      <div>
        <div class="text-sm font-semibold text-gray-900"><%= event_linkage.display_name %></div>
        <div class="text-xs text-gray-500">
          Set availability for all <%= all_shows.count %> events at once
        </div>
      </div>
    </div>
    
    <%# Master Availability Buttons %>
    <div class="flex items-center gap-2 px-4 border-l border-pink-100">
      <a href="#" 
         data-action="click->linked-availability#setStatus"
         data-status="available"
         class="px-3 py-1.5 text-sm font-medium rounded-md border transition
                <%= overall_status == 'available' ? 'bg-green-500 text-white border-green-500' : 'bg-white text-gray-700 border-gray-300 hover:bg-green-50' %>">
        All Available
      </a>
      <a href="#" 
         data-action="click->linked-availability#setStatus"
         data-status="unavailable"
         class="px-3 py-1.5 text-sm font-medium rounded-md border transition
                <%= overall_status == 'unavailable' ? 'bg-red-500 text-white border-red-500' : 'bg-white text-gray-700 border-gray-300 hover:bg-red-50' %>">
        All Unavailable
      </a>
    </div>
  </div>
  
  <%# Individual Show Rows %>
  <div class="divide-y divide-gray-100 bg-white">
    <% siblings.each do |show| %>
      <% status = availabilities[show.id]&.status || 'unset' %>
      <div class="flex items-center px-4 py-2 hover:bg-gray-50 transition"
           data-linked-availability-target="showRow"
           data-show-id="<%= show.id %>">
        <div class="flex items-center gap-3 flex-1">
          <%# Date %>
          <div class="flex-shrink-0 w-12 text-center">
            <div class="text-xs font-semibold text-pink-600"><%= show.date_and_time.strftime("%b") %></div>
            <div class="text-lg font-bold text-gray-900"><%= show.date_and_time.strftime("%-d") %></div>
          </div>
          
          <%# Details %>
          <div class="flex-1">
            <div class="text-sm font-medium text-gray-900"><%= show.event_type.titleize %></div>
            <div class="text-xs text-gray-500"><%= show.date_and_time.strftime("%a @ %-I:%M %p") %></div>
          </div>
          
          <%# Status Badge %>
          <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium
                       <%= status == 'available' ? 'bg-green-100 text-green-800' : status == 'unavailable' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-600' %>"
                data-linked-availability-target="statusBadge">
            <%= status.capitalize %>
          </span>
        </div>
      </div>
    <% end %>
    
    <%# Child shows with indent %>
    <% if children.any? %>
      <div class="bg-gray-50 border-t border-gray-200">
        <% children.each do |show| %>
          <% status = availabilities[show.id]&.status || 'unset' %>
          <div class="flex items-center px-4 py-2 pl-10 border-b border-gray-100 last:border-b-0 hover:bg-gray-100 transition"
               data-linked-availability-target="showRow"
               data-show-id="<%= show.id %>">
            <div class="flex items-center gap-3 flex-1">
              <%# Date %>
              <div class="flex-shrink-0 w-10 text-center">
                <div class="text-xs text-gray-500"><%= show.date_and_time.strftime("%b %-d") %></div>
              </div>
              
              <%# Details %>
              <div class="flex-1">
                <div class="text-sm text-gray-700"><%= show.event_type.titleize %></div>
                <div class="text-xs text-gray-500"><%= show.date_and_time.strftime("%a @ %-I:%M %p") %></div>
              </div>
              
              <%# Status Badge %>
              <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium
                           <%= status == 'available' ? 'bg-green-100 text-green-800' : status == 'unavailable' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-600' %>"
                    data-linked-availability-target="statusBadge">
                <%= status.capitalize %>
              </span>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>
</div>
