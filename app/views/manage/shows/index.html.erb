<% content_for :title, "Shows" %>

<div class="w-full">
  <%= render partial: "shared/notice", locals: { notice: notice } %>
  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [],
    text: "Shows & Events",
    links: [
      { text: "Schedule Shows & Events", path: new_manage_production_show_path(@production)}
    ]
  } %>

  <div class="flex w-full space-x-2 mb-4">
    <div class="flex flex-1 space-x-1">
      <%= link_to "Upcoming",
              manage_production_shows_path(@production, filter: "upcoming"),
              data: { turbo_prefetch: false },
              class: "px-3 py-1 rounded-md border text-sm #{(@filter == "upcoming") ? 'bg-pink-500 text-white border-pink-500' : 'bg-white text-gray-700 border-gray-200'}"
      %>
      <%= link_to "Past",
              manage_production_shows_path(@production, filter: "past"),
              data: { turbo_prefetch: false },
              class: "px-3 py-1 rounded-md border text-sm #{(@filter == "past") ? 'bg-pink-500 text-white border-pink-500' : 'bg-white text-gray-700 border-gray-200'}"
      %>
      </div>
      <div>
        <%= link_to calendar_manage_production_shows_path(@production), class: "px-3 py-1 rounded-md border text-sm bg-pink-500 text-white border-pink-500 flex items-center space-x-2" do %>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5A2.25 2.25 0 0 1 21 11.25v7.5m-9-6h.008v.008H12v-.008ZM12 15h.008v.008H12V15Zm0 2.25h.008v.008H12v-.008ZM9.75 15h.008v.008H9.75V15Zm0 2.25h.008v.008H9.75v-.008ZM7.5 15h.008v.008H7.5V15Zm0 2.25h.008v.008H7.5v-.008Zm6.75-4.5h.008v.008h-.008v-.008Zm0 2.25h.008v.008h-.008V15Zm0 2.25h.008v.008h-.008v-.008Zm2.25-4.5h.008v.008H16.5v-.008Zm0 2.25h.008v.008H16.5V15Z" />
          </svg>
          <span>Calendar</span>
        <% end %>
      </div>
    </div>
  </div>

  <% if @shows.any? %>
    <div class="grid grid-cols-1 gap-2">
      <% @shows.each_with_index do |show, idx| %>
        <div class="p-4 border border-gray-200 rounded-lg hover:border-gray-400 transition-all relative" data-controller="show-toggle" <%= 'data-show-toggle-initial-open-value="true"' if idx == 0 && @filter == "upcoming" %>>

          <div class="cursor-pointer select-none" data-action="click->show-toggle#toggle">
            <div class="flex items-center">
              <span data-show-toggle-target="icon" class="mr-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="size-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
              </span>

              <div class="flex flex-col sm:flex-row sm:items-center flex-1">
                <p class="font-bold text-sm sm:text-lg <%= 'line-through text-red-400' if show.canceled %>">
                  <%= show.date_and_time.strftime("%A, %B %-d, %Y") %> at <%= show.date_and_time.strftime("%l:%M %p") %>
                </p>


                <% if show.canceled %>
                  <span class="mt-1 sm:mt-0 sm:ml-3 inline-flex items-center rounded-md bg-red-50 px-2 py-1 text-xs font-medium text-red-700 ring-1 ring-inset ring-red-600/10 w-fit">Canceled</span>
                <% elsif show.recurring? %>
                  <span class="ml-3" data-controller="tooltip" data-tooltip-text="This is a recurring event">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="text-pink-500 size-4">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
                    </svg>
                  </span>
                <% end %>
              </div>
            </div>
          </div>

          <div data-show-toggle-target="content" class="ml-6 <%= 'hidden' unless idx == 0 %>">

            <div class="items-start gap-6 sm:flex">

              <div class="w-full sm:flex">

                <% unless show.canceled %>
                  <div class="flex-shrink">
                    <% poster_url = safe_poster_url(show) %>
                    <% if poster_url %>
                      <div class="mb-2 pr-4">
                        <%= image_tag poster_url, alt: "Show Poster", class: "rounded shadow max-w-36 border border-gray-200" %>
                      </div>
                    <% end %>
                  </div>
                <% end %>

                <div class="flex items-center gap-1 flex-wrap">

                  <% event_type_badge_classes = case show.event_type
                    when "rehearsal" then "bg-blue-50 text-blue-700 ring-blue-600/10"
                    when "meeting" then "bg-green-50 text-green-700 ring-green-600/10"
                    else "bg-pink-50 text-pink-700 ring-pink-600/10"
                  end %>
                  <span class="mr-2 inline-flex items-center justify-center rounded-md px-2 py-1 text-xs font-medium ring-1 ring-inset <%= event_type_badge_classes %>">
                    <%= show.event_type.titleize %>
                  </span>

                  <% if show.secondary_name.present? %>
                      <span class="text-xs sm:text-sm text-gray-600 font-medium"><%= show.secondary_name %></span>
                  <% end %>

                  <% if show.location.present? && !show.canceled %>
                    <span class="inline-flex items-center gap-1 rounded-md px-1.5 py-0.5 text-[10px] sm:text-xs font-medium ring-1 ring-inset bg-gray-50 text-gray-700 ring-gray-600/10">
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10.5a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1 1 15 0Z" /></svg>
                      <%= show.location.name %>
                    </span>
                  <% end %>

                  <% if current_user_can_manage?(show.production) %>
                    <%
                      event_label = show.event_type.titleize
                      edit_label = "Edit #{event_label}"
                      cancel_label = "Cancel #{event_label}"
                      delete_label = "Delete #{event_label}"
                      uncancel_label = "Uncancel #{event_label}"
                    %>
                    <div class="mt-0 space-x-1">
                      <% if @filter == "past" %>
                        <%= link_to "Duplicate", new_manage_production_show_path(@production, duplicate: show.id), class: "text-xs text-pink-500 underline" %>
                        <%= link_to cancel_label, cancel_manage_production_show_path(@production, show), class: "text-xs text-pink-500 underline" %>
                      <% elsif show.canceled %>
                        <%= link_to uncancel_label, uncancel_manage_production_show_path(@production, show), data: {turbo_method: :patch, turbo_confirm: "Are you sure you want to uncancel this #{event_label.downcase}?"}, class: "text-xs text-pink-500 underline" %>
                        <%= link_to delete_label, cancel_manage_production_show_path(@production, show), class: "text-xs text-pink-500 underline" %>
                      <% else %>
                        <%= link_to edit_label, edit_manage_production_show_path(@production, show), class: "text-xs text-pink-500 underline" %>
                        <%= link_to cancel_label, cancel_manage_production_show_path(@production, show), class: "text-xs text-pink-500 underline" %>
                      <% end %>
                    </div>
                  <% end %>

                   <% if show.event_type == "show" && !show.canceled %>
                    <div class="w-full mt-5">
                      <div class="grid grid-cols-4 sm:grid-cols-8 gap-2">
                        <% if show.show_person_role_assignments.any? %>
                          <% show.show_person_role_assignments.each do |assignment| %>
                            <%= link_to [:manage, assignment.person] do %>
                              <div class="flex flex-col items-center transition-all relative"
                                data-controller="tooltip"
                                data-tooltip-text="<%= assignment.person.name.truncate(40, omission: '...') %> - <%= assignment.role.name %>">
                                <% headshot_variant = assignment.person.safe_headshot_variant(:thumb) %>
                                <% if headshot_variant %>
                                  <%= image_tag headshot_variant, alt: assignment.person.name, class: "w-15 h-15 rounded-lg object-cover", draggable: false %>
                                <% else %>
                                  <div class="w-15 h-15 rounded-lg bg-gray-100 flex items-center justify-center text-black font-bold">
                                    <%= assignment.person.initials %>
                                  </div>
                                <% end %>
                              </div>
                            <% end %>
                          <% end %>
                        <% else %>
                          <div class="col-span-4 sm:col-span-8 text-sm text-gray-500 items-center">
                            You haven't added any cast members to this show
                          </div>
                        <% end %>
                      </div>
                      <% if current_user_can_manage?(show.production) %>
                        <div class="mt-0">
                          <%= link_to "Edit Cast", cast_manage_production_show_path(@production, show), class: "text-xs text-pink-500 underline" %>
                        </div>
                      <% end %>
                    </div>
                  <% end %>

                </div>

              </div>



            </div>

          </div>
        </div>
      <% end %>

    </div>
  <% else %>
    <div class="text-sm text-gray-500">
      You haven't scheduled any shows or events.
    </div>
  <% end %>

</div>
