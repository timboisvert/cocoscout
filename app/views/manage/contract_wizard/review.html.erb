<%= render layout: "manage/contract_wizard/wizard_layout", locals: { step_name: "Review" } do %>
  <h2 class="text-xl font-bold text-gray-900 mb-2 coustard-regular">Review & Activate</h2>
  <p class="text-gray-600 mb-6">Review all details before activating the contract.</p>

  <% unless @valid_for_activation %>
    <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
      <div class="flex items-start">
        <%= icon("alert-circle", class: "w-5 h-5 text-red-600 mt-0.5 mr-3") %>
        <div>
          <h3 class="font-medium text-red-800">Cannot activate yet</h3>
          <ul class="mt-2 text-sm text-red-700 list-disc list-inside">
            <% @validation_errors&.each do |error| %>
              <li><%= error %></li>
            <% end %>
          </ul>
        </div>
      </div>
    </div>
  <% end %>

  <div class="space-y-6">
    <%# Contractor Info %>
    <div class="border border-gray-200 rounded-lg p-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-medium text-gray-900">Contractor</h3>
        <%= link_to manage_contractor_contract_wizard_path(@contract), class: "text-sm text-pink-600 hover:text-pink-700" do %>
          Edit
        <% end %>
      </div>
      <dl class="grid grid-cols-2 gap-2 text-sm">
        <div>
          <dt class="text-gray-500">Name</dt>
          <dd class="text-gray-900"><%= @contract.contractor_name %></dd>
        </div>
        <% if @contract.contractor_email.present? %>
          <div>
            <dt class="text-gray-500">Email</dt>
            <dd class="text-gray-900"><%= @contract.contractor_email %></dd>
          </div>
        <% end %>
        <% if @contract.contractor_phone.present? %>
          <div>
            <dt class="text-gray-500">Phone</dt>
            <dd class="text-gray-900"><%= @contract.contractor_phone %></dd>
          </div>
        <% end %>
      </dl>
    </div>

    <%# Bookings %>
    <%
      # Build lookup maps for location/space names
      locations = Current.organization.locations.includes(:location_spaces)
      locations_map = locations.index_by(&:id)
      spaces_map = locations.flat_map(&:location_spaces).index_by(&:id)
    %>
    <div class="border border-gray-200 rounded-lg p-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-medium text-gray-900">Bookings (<%= @contract.draft_bookings.count %>)</h3>
        <%= link_to manage_bookings_contract_wizard_path(@contract), class: "text-sm text-pink-600 hover:text-pink-700" do %>
          Edit
        <% end %>
      </div>
      <% if @contract.draft_bookings.any? %>
        <ul class="space-y-2 text-sm max-h-48 overflow-y-auto">
          <% @contract.draft_bookings.sort_by { |b| b["starts_at"].to_s }.each do |booking| %>
            <%
              starts_at = DateTime.parse(booking["starts_at"]) rescue nil
              duration = booking["duration"].to_f
              location = locations_map[booking["location_id"].to_i]
              space = spaces_map[booking["space_id"].to_i] if booking["space_id"].present?
              venue_name = location&.name || "Unknown location"
              venue_name += " (#{space.name})" if space
            %>
            <li class="flex items-center gap-2 text-gray-700">
              <%= icon("calendar", class: "w-4 h-4 text-gray-400 flex-shrink-0") %>
              <span>
                <% if starts_at %>
                  <%= starts_at.strftime("%b %d, %Y") %> at <%= starts_at.strftime("%l:%M %p").strip %>
                  <span class="text-gray-400">·</span>
                  <%= duration %> hrs
                <% else %>
                  Date TBD
                <% end %>
                <span class="text-gray-400">·</span>
                <%= venue_name %>
              </span>
            </li>
          <% end %>
        </ul>
      <% else %>
        <p class="text-sm text-red-600">No bookings added</p>
      <% end %>
    </div>

    <%# Services %>
    <% if @contract.draft_services.any? %>
      <div class="border border-gray-200 rounded-lg p-4">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-medium text-gray-900">Services (<%= @contract.draft_services.count %>)</h3>
          <%= link_to manage_services_contract_wizard_path(@contract), class: "text-sm text-pink-600 hover:text-pink-700" do %>
            Edit
          <% end %>
        </div>
        <ul class="space-y-1 text-sm text-gray-700">
          <% @contract.draft_services.each do |service| %>
            <li class="flex items-center gap-2">
              <%= icon("check", class: "w-4 h-4 text-green-500") %>
              <%= service["name"] %>
            </li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <%# Payments %>
    <div class="border border-gray-200 rounded-lg p-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-medium text-gray-900">Payments (<%= @contract.draft_payments.count %>)</h3>
        <%= link_to manage_payments_contract_wizard_path(@contract), class: "text-sm text-pink-600 hover:text-pink-700" do %>
          Edit
        <% end %>
      </div>
      <% if @contract.draft_payments.any? %>
        <ul class="space-y-2 text-sm">
          <% @contract.draft_payments.each do |payment| %>
            <li class="flex items-center justify-between">
              <span class="text-gray-700">
                <%= payment["description"].presence || "Payment" %>
                <span class="text-xs text-gray-500">
                  (due <%= Date.parse(payment["due_date"]).strftime("%b %d, %Y") rescue payment["due_date"] %>)
                </span>
              </span>
              <span class="font-medium <%= payment["direction"] == "incoming" ? 'text-green-600' : 'text-red-600' %>">
                <%= payment["direction"] == "incoming" ? '+' : '-' %>$<%= '%.2f' % payment["amount"].to_f %>
              </span>
            </li>
          <% end %>
        </ul>
      <% else %>
        <p class="text-sm text-gray-500">No payments scheduled</p>
      <% end %>
    </div>

    <%# Contract Period %>
    <div class="border border-gray-200 rounded-lg p-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-medium text-gray-900">Contract Period</h3>
        <%= link_to manage_terms_contract_wizard_path(@contract), class: "text-sm text-pink-600 hover:text-pink-700" do %>
          Edit
        <% end %>
      </div>
      <% if @contract.contract_start_date.present? && @contract.contract_end_date.present? %>
        <p class="text-sm text-gray-700"><%= @contract.date_range %></p>
      <% else %>
        <p class="text-sm text-red-600">Contract dates not set</p>
      <% end %>
    </div>
  </div>

  <div class="mt-8 flex justify-between items-center">
    <%= render "shared/button", text: "Back", variant: "secondary", size: "medium", icon: "arrow-left", path: manage_terms_contract_wizard_path(@contract) %>

    <div class="flex items-center gap-4">
      <% if @valid_for_activation %>
        <%= form_with url: manage_activate_contract_wizard_path(@contract), method: :post, local: true, class: "inline" do %>
          <%= render "shared/button", text: "Activate Contract", variant: "primary", size: "large", icon: "check-circle", type: :submit %>
        <% end %>
      <% else %>
        <%= render "shared/button", text: "Activate Contract", variant: "primary", size: "large", icon: "check-circle", type: :button, disabled: true %>
      <% end %>
    </div>
  </div>

  <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
    <div class="flex items-start">
      <%= icon("info", class: "w-5 h-5 text-blue-600 mt-0.5 mr-3") %>
      <div class="text-sm text-blue-800">
        <p class="font-medium">What happens when you activate?</p>
        <ul class="mt-2 list-disc list-inside space-y-1">
          <li>Space rentals will be created and appear on your calendar</li>
          <li>Payment schedule will be set up with reminders</li>
          <li>A third-party production will be created (if configured)</li>
          <li>You can still edit details after activation</li>
        </ul>
      </div>
    </div>
  </div>
<% end %>
