<% content_for :title, "Calendar" %>

<div class="w-full mb-10">
  <%= render partial: "shared/notice", locals: { notice: notice } %>
  <%= render partial: "shared/top_menu", locals: {
    breadcrumbs: [
        ["Shows & Events", manage_production_shows_path(@production)]
    ],
    text: "Calendar",
    links: [
      { text: "Schedule Shows & Events", path: new_manage_production_show_path(@production)}
    ]
  } %>

  <div class="flex w-full space-x-2 mb-4">
    <div class="flex flex-1 space-x-1">
      <%= link_to "Upcoming",
              calendar_manage_production_shows_path(@production, filter: "upcoming"),
              data: { turbo_prefetch: false },
              class: "px-3 py-1 rounded-md border text-sm #{(@filter == "upcoming") ? 'bg-pink-500 text-white border-pink-500' : 'bg-white text-gray-700 border-gray-200'}"
      %>
      <%= link_to "Past",
              calendar_manage_production_shows_path(@production, filter: "past"),
              data: { turbo_prefetch: false },
              class: "px-3 py-1 rounded-md border text-sm #{(@filter == "past") ? 'bg-pink-500 text-white border-pink-500' : 'bg-white text-gray-700 border-gray-200'}"
      %>
    </div>
    <div>
      <%= link_to manage_production_shows_path(@production, filter: @filter), class: "px-3 py-1 rounded-md border text-sm bg-pink-500 text-white border-pink-500 flex items-center space-x-2" do %>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4">
          <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 6.75h12M8.25 12h12m-12 5.25h12M3.75 6.75h.007v.008H3.75V6.75Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0ZM3.75 12h.007v.008H3.75V12Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm-.375 5.25h.007v.008H3.75v-.008Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
        </svg>
        <span>List</span>
      <% end %>
    </div>
  </div>

  <% if @shows.any? %>
    <div class="space-y-8">
      <% months = @filter == "past" ? @shows_by_month.sort.reverse : @shows_by_month.sort %>
      <% months.each do |month_start, shows| %>
        <div class="border border-gray-200 rounded-lg p-4">
          <h2 class="text-xl font-bold mb-4"><%= month_start.strftime("%B %Y") %></h2>

          <div class="grid grid-cols-7 gap-1">
            <!-- Day headers -->
            <% %w[Sun Mon Tue Wed Thu Fri Sat].each do |day| %>
              <div class="text-center text-xs font-semibold text-gray-600 p-2">
                <%= day %>
              </div>
            <% end %>

            <!-- Empty cells for days before month starts -->
            <% (month_start.wday).times do %>
              <div class="border border-gray-100 bg-gray-50 min-h-[80px] p-1"></div>
            <% end %>

            <!-- Calendar days -->
            <% current_date = month_start %>
            <% while current_date.month == month_start.month %>
              <% day_shows = shows.select { |s| s.date_and_time.to_date == current_date.to_date } %>
              <div class="border border-gray-200 min-h-[80px] p-1 <%= 'bg-blue-50' if current_date.to_date == Date.current %>">
                <div class="text-xs font-semibold text-gray-700 mb-1">
                  <%= current_date.day %>
                </div>

                <% day_shows.each do |show| %>
                  <%= link_to edit_manage_production_show_path(@production, show),
                      class: "block mb-1" do %>
                    <% is_past = show.date_and_time < Time.current %>
                    <% event_type_badge_classes = if is_past
                      "bg-gray-100 text-gray-600 border-gray-300"
                    else
                      case show.event_type
                        when "rehearsal" then "bg-blue-100 text-blue-800 border-blue-300"
                        when "meeting" then "bg-green-100 text-green-800 border-green-300"
                        else "bg-pink-100 text-pink-800 border-pink-300"
                      end
                    end %>
                    <div class="text-xs p-1 rounded border <%= event_type_badge_classes %> <%= 'opacity-50 line-through' if show.canceled %>">
                      <div class="font-semibold"><%= show.date_and_time.strftime("%l:%M %p").strip %></div>
                      <% if show.secondary_name.present? %>
                        <div class="truncate"><%= show.secondary_name %></div>
                      <% end %>
                      <% if show.canceled %>
                        <div class="text-red-600 font-semibold">Canceled</div>
                      <% end %>
                    </div>
                  <% end %>
                <% end %>
              </div>
              <% current_date = current_date + 1.day %>
            <% end %>

            <!-- Empty cells to complete the week -->
            <% remaining_cells = (7 - current_date.wday) % 7 %>
            <% remaining_cells.times do %>
              <div class="border border-gray-100 bg-gray-50 min-h-[80px] p-1"></div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  <% else %>
    <p class="text-gray-500 text-sm">No events scheduled.</p>
  <% end %>
</div>
