<%# Render the entries for this page OUTSIDE the turbo-frame so they append %>
<% if @show == "tiles" %>
  <% @entries.each do |entry| %>
    <% cache ["directory_tile_v2", entry, entry.updated_at, Current.production&.id] do %>
      <%= render "directory_tile", entry: entry %>
    <% end %>
  <% end %>
<% else %>
  <% @entries.each do |entry| %>
    <% cache ["directory_list_v2", entry, entry.updated_at, Current.production&.id] do %>
      <%= render "directory_list_item", entry: entry %>
    <% end %>
  <% end %>
<% end %>

<%# Pagination frame for next page - always render to satisfy Turbo %>
<%= turbo_frame_tag "pagination" do %>
  <% if @pagy.page < @pagy.pages %>
    <div data-controller="infinite-scroll"
         data-infinite-scroll-url-value="<%= manage_directory_path(page: @pagy.page + 1, q: @search, sort: @sort, show: @show, filter: @filter, type: @type) %>"
         data-infinite-scroll-page-value="<%= @pagy.page %>"
         data-infinite-scroll-pages-value="<%= @pagy.pages %>">
      <%= link_to "Load More",
              manage_directory_path(page: @pagy.page + 1, q: @search, sort: @sort, show: @show, filter: @filter, type: @type),
              data: {
                infinite_scroll_target: "nextLink",
                turbo_frame: "pagination"
              },
              class: "hidden" %>

      <div data-infinite-scroll-target="sentinel" class="h-20 flex items-center justify-center">
        <div class="text-sm text-gray-400">Loading more...</div>
      </div>
    </div>
  <% end %>
<% end %>
